rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ========= HELPERS ========= */
    function signedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function isAdmin() {
      return signedIn()
        && request.auth.token.email in ["sohibjonmath@gmail.com"];
    }

    function isInt(x) { return x is int; }
    function isNum(x) { return x is int || x is float; }

    // user hujjati (balans tekshirish uchun)
    function myUser() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    /* ========= PRODUCTS ========= */
    match /products/{productId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();

      match /reviews/{reviewId} {
        allow read: if true;

        allow create: if signedIn()
          && request.resource.data.uid == request.auth.uid
          && request.resource.data.stars is int
          && request.resource.data.stars >= 1
          && request.resource.data.stars <= 5;

        // user faqat o'z review'sini tahrirlaydi (uid o'zgarmasin)
        allow update: if signedIn()
          && resource.data.uid == request.auth.uid
          && request.resource.data.uid == resource.data.uid;

        allow delete: if isAdmin()
          || (signedIn() && resource.data.uid == request.auth.uid);
      }
    }

    /* aggregate / collectionGroup reviews */
    match /{path=**}/reviews/{reviewId} {
      allow read: if true;
    }

    /* ========= USERS ========= */
    match /users/{uid} {
      // admin ko‘rsa ham bo‘ladi (xohlasangiz olib tashlaymiz)
      allow read: if isOwner(uid) || isAdmin();

      // user hujjatini faqat o‘zi yaratadi (balanceUZS yozolmaydi)
      allow create: if isOwner(uid)
        && !('balanceUZS' in request.resource.data)
        && !('isAdmin' in request.resource.data)
        && !('role' in request.resource.data);

      // user update: balansga tegmaydi, numericId/OMID'ga tegmaydi
      allow update: if isOwner(uid)
        // balanceUZS ni user o'zgartira olmaydi
        && !(request.resource.data.diff(resource.data).changedKeys().hasAny(['balanceUZS']))
        // admin flag/role ham user yozolmaydi
        && !(request.resource.data.diff(resource.data).changedKeys().hasAny(['isAdmin','role']))
        // OM id / numericId o'zgarmasin (agar ishlatsangiz)
        && !(request.resource.data.diff(resource.data).changedKeys().hasAny(['numericId','omId']));

      allow delete: if isAdmin();

      match /favorites/{favId} {
        allow read, create, update, delete: if isOwner(uid);
      }

      // agar siz /users/{uid}/orders saqlayotgan bo‘lsangiz
      match /orders/{orderId} {
        allow read, create: if isOwner(uid);
        // user faqat “cancel” kabi yengil update qilsin (xohlasangiz)
        allow update: if isOwner(uid) || isAdmin();
        allow delete: if isAdmin();
      }
    }

    /* ========= GLOBAL ORDERS ========= */
    match /orders/{orderId} {

      // CREATE: checkout yoki topup
      allow create: if signedIn()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.orderType in ['checkout','topup']
        && request.resource.data.createdAt is timestamp;

      // READ: admin yoki egasi
      allow read: if isAdmin()
        || (signedIn() && resource.data.uid == request.auth.uid);

      // UPDATE/DELETE: faqat admin
      allow update, delete: if isAdmin();
    }

    /* ========= EVENTS / ANALYTICS ========= */
    match /events/{eventId} {
      allow create: if signedIn()
        && request.resource.data.uid == request.auth.uid;
      allow read: if isAdmin();
      allow update, delete: if false;
    }

    /* ========= CONFIGS ========= */
    match /configs/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
