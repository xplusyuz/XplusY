<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MathCenter — Lite Admin</title>
  <meta name="color-scheme" content="light"/>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{ --green:#2E8B57; --green-700:#1F6B45; --bg:#f7faf8; --text:#1a1f1c; --muted:#6b7280; --card:#fff; --shadow:0 8px 24px rgba(0,0,0,.08); --radius:18px; }
    *{box-sizing:border-box} html,body{margin:0;height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #eee;z-index:5}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .stack{display:flex;align-items:center;gap:12px}
    .spacer{flex:1}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--green)}
    .brand .pi{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--green),var(--green-700));display:grid;place-items:center;color:#fff;box-shadow:var(--shadow)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;background:var(--green);color:#fff;border:0;cursor:pointer;font-weight:600}
    .btn.ghost{background:#e9f5ef;color:var(--green)}
    .pill{padding:6px 10px;border-radius:999px;background:#eef6f0;color:var(--green);font-size:12px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:10px 12px;border-radius:10px;background:#fff;border:1px solid #e5e7eb;cursor:pointer}
    .tab.active{background:#e9f5ef;border-color:#b7e2c7;color:var(--green)}
    .card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;outline:0}
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{text-align:left;padding:10px 12px;vertical-align:middle}
    tr{background:#fff} tr td:first-child, tr th:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
    tr td:last-child, tr th:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-8{grid-column:span 8} .col-12{grid-column:span 12}
    .avatar-preview{width:54px;height:54px;border-radius:50%;object-fit:cover;background:#eef2f1}
    @media (max-width:900px){ .grid{grid-template-columns:repeat(6,1fr)} .col-6{grid-column:span 6} .col-8{grid-column:span 6} .col-4{grid-column:span 6} .col-3{grid-column:span 6} }
  </style>
</head>
<body>
<header>
  <div class="container stack">
    <div class="brand"><div class="pi">π</div><div>Lite Admin</div></div>
    <div class="pill">JSON orqali boshqaruv</div>
    <div class="spacer"></div>
    <button class="btn ghost" onclick="location.href='liteindex.html'">Foydalanuvchi tomon</button>
    <button class="btn" id="btnExport">JSON ni yuklab olish</button>
  </div>
</header>

<main class="container" style="display:grid;gap:16px;margin-top:16px">
  <div class="tabs">
    <button class="tab active" data-tab="users">Foydalanuvchilar</button>
    <button class="tab" data-tab="banners">Bannerlar</button>
    <button class="tab" data-tab="cards">Cardlar</button>
    <button class="tab" data-tab="import">Excel/CSV import</button>
    <span class="spacer"></span>
    <span id="status" class="pill">Yuklanmoqda…</span>
  </div>

  <!-- USERS -->
  <section id="users" class="card">
    <h3>Foydalanuvchilar</h3>
    <div class="grid">
      <div class="col-6"><label>Login</label><input id="u_login" placeholder="student1"></div>
      <div class="col-6"><label>Parol</label><input id="u_password" placeholder="1234"></div>
      <div class="col-4"><label>Ism</label><input id="u_name" placeholder="Ali"></div>
      <div class="col-4"><label>Familiya</label><input id="u_surname" placeholder="Valiyev"></div>
      <div class="col-4"><label>Sinf</label><input id="u_class" placeholder="10A"></div>
      <div class="col-6"><label>Ball</label><input id="u_points" type="number" value="0"></div>
      <div class="col-6">
        <label>Avatar rasm</label>
        <input id="u_avatar_file" type="file" accept="image/*"/>
        <div style="margin-top:8px;display:flex;align-items:center;gap:8px">
          <img id="u_avatar_preview" class="avatar-preview" alt=""/>
          <span class="pill">ixtiyoriy</span>
        </div>
      </div>
      <div class="col-6" style="display:flex;align-items:end;gap:8px">
        <button class="btn" id="addUser">Qo'shish</button>
        <button class="btn ghost" id="resetUserForm">Tozalash</button>
      </div>
    </div>
    <div style="margin-top:12px;overflow:auto">
      <table>
        <thead><tr><th>Avatar</th><th>Login</th><th>Ism</th><th>Familiya</th><th>Sinf</th><th>Ball</th><th>Amal</th></tr></thead>
        <tbody id="usersT"></tbody>
      </table>
    </div>
  </section>

  <!-- BANNERS -->
  <section id="banners" class="card" style="display:none">
    <h3>Bannerlar</h3>
    <div class="grid">
      <div class="col-6"><label>Sarlavha</label><input id="b_title"></div>
      <div class="col-6"><label>Qisqa matn</label><input id="b_subtitle"></div>
      <div class="col-6"><label>Rasm URL</label><input id="b_image" placeholder="https://..."></div>
      <div class="col-6"><label>Link</label><input id="b_link" placeholder="#"></div>
      <div class="col-6"><label>Faolmi?</label>
        <select id="b_active"><option value="true">Ha</option><option value="false">Yo'q</option></select>
      </div>
      <div class="col-6" style="display:flex;align-items:end;gap:8px">
        <button class="btn" id="addBanner">Qo'shish</button>
        <button class="btn ghost" id="resetBanner">Tozalash</button>
      </div>
    </div>
    <div style="margin-top:12px;overflow:auto">
      <table>
        <thead><tr><th>Rasm</th><th>Sarlavha</th><th>Matn</th><th>Faol</th><th>Amal</th></tr></thead>
        <tbody id="bannersT"></tbody>
      </table>
    </div>
  </section>

  <!-- CARDS -->
  <section id="cards" class="card" style="display:none">
    <h3>Cardlar</h3>
    <div class="grid">
      <div class="col-4"><label>Turi</label>
        <select id="c_kind"><option value="test">test</option><option value="kurs">kurs</option><option value="sim">sim</option></select>
      </div>
      <div class="col-8"><label>Sarlavha</label><input id="c_title" placeholder="Algebra — Boshlang'ich"></div>
      <div class="col-4"><label>Asosiy teg</label><input id="c_main" placeholder="Masalan: Testlar"></div>
      <div class="col-8"><label>Teglar (vergul bilan)</label><input id="c_tags" placeholder="test,algebra,easy"></div>
      <div class="col-6"><label>Rasm URL</label><input id="c_image" placeholder="https://..."></div>
      <div class="col-6"><label>Link</label><input id="c_link" placeholder="#"></div>
      <div class="col-6"><label>Faolmi?</label><select id="c_active"><option value="true">Ha</option><option value="false">Yo'q</option></select></div>
      <div class="col-12" style="display:flex;align-items:end;gap:8px">
        <button class="btn" id="addCard">Qo'shish</button>
        <button class="btn ghost" id="resetCard">Tozalash</button>
      </div>
    </div>
    <div style="margin-top:12px;overflow:auto">
      <table>
        <thead><tr><th>Rasm</th><th>Sarlavha</th><th>Turi</th><th>Asosiy teg</th><th>Teglar</th><th>Faol</th><th>Amal</th></tr></thead>
        <tbody id="cardsT"></tbody>
      </table>
    </div>
  </section>

  <!-- IMPORT -->
  <section id="import" class="card" style="display:none">
    <h3>Excel/CSV import</h3>
    <p class="muted">Excel fayl (xlsx, xls) yoki CSV yuklab, foydalanuvchilar ro'yxatini qo'shing.
      Ustunlar: <b>login, password, name, surname, class, points, avatar</b> (avatar base64 ixtiyoriy).</p>
    <input id="fileInput" type="file" accept=".xlsx,.xls,.csv"/>
    <div id="importStatus" class="pill" style="margin-top:10px;display:inline-block">Fayl tanlanmagan</div>
  </section>
</main>

<script>
  const $ = s => document.querySelector(s);
  const state = { db:null, avatarData:null };

  function ensureAdminSession(){
    const me = JSON.parse(localStorage.getItem('lite.me')||'null');
    if(!(me && me.role==='admin')){
      alert('Admin sifatida kiring (Math@1999 / Math@28021999).');
      location.href='liteindex.html';
    }
  }

  async function loadDB(){
    const res = await fetch('liteadmin.json?_=' + Date.now());
    if(!res.ok) throw new Error('liteadmin.json yuklanmadi');
    state.db = await res.json();
    document.getElementById('status').textContent = 'Yuklandi';
    renderTables();
  }

  function uid(prefix){ return prefix + Math.random().toString(36).slice(2,8); }

  function renderTables(){
    // users
    const ut = $('#usersT'); ut.innerHTML='';
    (state.db.users||[]).forEach((u,idx)=>{
      const tr = document.createElement('tr');
      const av = u.avatar ? `<img src="${u.avatar}" style="width:40px;height:40px;border-radius:50%;object-fit:cover">` : '';
      tr.innerHTML = `<td>${av}</td><td>${u.login}</td><td>${u.name}</td><td>${u.surname}</td><td>${u.class}</td><td>${u.points||0}</td>
        <td style="display:flex;gap:8px">
          <button class="btn ghost" onclick="editUser(${idx})">Edit</button>
          <button class="btn" onclick="delUser(${idx})">Del</button>
        </td>`;
      ut.appendChild(tr);
    });
    // banners
    const bt = $('#bannersT'); bt.innerHTML='';
    (state.db.banners||[]).forEach((b,idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><img src="${b.image}" style="width:120px;height:54px;object-fit:cover;border-radius:8px"></td>
      <td>${b.title}</td><td>${b.subtitle||''}</td><td>${b.active?"Ha":"Yo'q"}</td>
      <td style="display:flex;gap:8px">
        <button class="btn ghost" onclick="editBanner(${idx})">Edit</button>
        <button class="btn" onclick="delBanner(${idx})">Del</button>
      </td>`;
      bt.appendChild(tr);
    });
    // cards
    const ct = $('#cardsT'); ct.innerHTML='';
    (state.db.cards||[]).forEach((c,idx)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td><img src="${c.image}" style="width:120px;height:80px;object-fit:cover;border-radius:8px"></td>
      <td>${c.title}</td><td>${c.kind}</td><td>${c.main||''}</td><td>${(c.tags||[]).join(', ')}</td><td>${c.active?"Ha":"Yo'q"}</td>
      <td style="display:flex;gap:8px">
        <button class="btn ghost" onclick="editCard(${idx})">Edit</button>
        <button class="btn" onclick="delCard(${idx})">Del</button>
      </td>`;
      ct.appendChild(tr);
    });
  }

  // Helpers
  function toDataURL(file){
    return new Promise((resolve,reject)=>{
      const r=new FileReader();
      r.onload=e=>resolve(e.target.result);
      r.onerror=reject;
      r.readAsDataURL(file);
    });
  }
  function downloadJSON(obj, name){
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click(); URL.revokeObjectURL(a.href);
  }

  // USERS handlers
  document.getElementById('u_avatar_file').addEventListener('change', async (e)=>{
    const f = e.target.files[0];
    state.avatarData = f ? await toDataURL(f) : null;
    if(state.avatarData){ document.getElementById('u_avatar_preview').src = state.avatarData; }
  });

  document.getElementById('addUser').onclick = ()=>{
    const u = {
      login: document.getElementById('u_login').value.trim(),
      password: document.getElementById('u_password').value.trim(),
      name: document.getElementById('u_name').value.trim(),
      surname: document.getElementById('u_surname').value.trim(),
      class: document.getElementById('u_class').value.trim(),
      points: Number(document.getElementById('u_points').value||0),
      avatar: state.avatarData || null
    };
    if(!u.login || !u.password || !u.name) return alert('Login, parol va ism majburiy.');
    (state.db.users ||= []).push(u);
    renderTables(); resetUserForm();
  };
  document.getElementById('resetUserForm').onclick = resetUserForm;
  function resetUserForm(){ ['u_login','u_password','u_name','u_surname','u_class','u_points'].forEach(id=>document.getElementById(id).value=''); document.getElementById('u_points').value=0; state.avatarData=null; document.getElementById('u_avatar_preview').removeAttribute('src'); }
  window.editUser = idx =>{
    const u = state.db.users[idx];
    document.getElementById('u_login').value=u.login;
    document.getElementById('u_password').value=u.password;
    document.getElementById('u_name').value=u.name;
    document.getElementById('u_surname').value=u.surname;
    document.getElementById('u_class').value=u.class;
    document.getElementById('u_points').value=u.points||0;
    if(u.avatar){ document.getElementById('u_avatar_preview').src=u.avatar; }
    document.getElementById('addUser').onclick = ()=>{
      const nu = {
        login: document.getElementById('u_login').value.trim(),
        password: document.getElementById('u_password').value.trim(),
        name: document.getElementById('u_name').value.trim(),
        surname: document.getElementById('u_surname').value.trim(),
        class: document.getElementById('u_class').value.trim(),
        points: Number(document.getElementById('u_points').value||0),
        avatar: state.avatarData || u.avatar || null
      };
      state.db.users[idx]=nu; renderTables(); resetUserForm();
      document.getElementById('addUser').onclick = ()=>{
        const u2 = {
          login: document.getElementById('u_login').value.trim(),
          password: document.getElementById('u_password').value.trim(),
          name: document.getElementById('u_name').value.trim(),
          surname: document.getElementById('u_surname').value.trim(),
          class: document.getElementById('u_class').value.trim(),
          points: Number(document.getElementById('u_points').value||0),
          avatar: state.avatarData || null
        };
        if(!u2.login || !u2.password || !u2.name) return alert('Login, parol va ism majburiy.');
        (state.db.users ||= []).push(u2); renderTables(); resetUserForm();
      };
    };
  };
  window.delUser = idx =>{ if(confirm('O‘chirish?')){ state.db.users.splice(idx,1); renderTables(); } };

  // BANNERS handlers
  document.getElementById('addBanner').onclick = ()=>{
    const b = {
      id: uid('b_'),
      title: document.getElementById('b_title').value.trim(),
      subtitle: document.getElementById('b_subtitle').value.trim(),
      image: document.getElementById('b_image').value.trim(),
      link: document.getElementById('b_link').value.trim()||'#',
      active: document.getElementById('b_active').value==='true'
    };
    if(!b.title || !b.image) return alert('Sarlavha va rasm majburiy.');
    (state.db.banners ||= []).push(b); renderTables(); resetBanner();
  };
  document.getElementById('resetBanner').onclick = resetBanner;
  function resetBanner(){ ['b_title','b_subtitle','b_image','b_link'].forEach(id=>document.getElementById(id).value=''); document.getElementById('b_active').value='true'; }
  window.editBanner = idx => {
    const b = state.db.banners[idx];
    document.getElementById('b_title').value=b.title;
    document.getElementById('b_subtitle').value=b.subtitle||'';
    document.getElementById('b_image').value=b.image;
    document.getElementById('b_link').value=b.link||'#';
    document.getElementById('b_active').value=b.active?'true':'false';
    document.getElementById('addBanner').onclick = ()=>{
      state.db.banners[idx] = {
        id: b.id,
        title: document.getElementById('b_title').value.trim(),
        subtitle: document.getElementById('b_subtitle').value.trim(),
        image: document.getElementById('b_image').value.trim(),
        link: document.getElementById('b_link').value.trim()||'#',
        active: document.getElementById('b_active').value==='true'
      };
      renderTables(); resetBanner();
      document.getElementById('addBanner').onclick = ()=>{
        const nb = {
          id: uid('b_'),
          title: document.getElementById('b_title').value.trim(),
          subtitle: document.getElementById('b_subtitle').value.trim(),
          image: document.getElementById('b_image').value.trim(),
          link: document.getElementById('b_link').value.trim()||'#',
          active: document.getElementById('b_active').value==='true'
        };
        if(!nb.title || !nb.image) return alert('Sarlavha va rasm majburiy.');
        (state.db.banners ||= []).push(nb); renderTables(); resetBanner();
      };
    };
  };
  window.delBanner = idx => { if(confirm('O‘chirish?')){ state.db.banners.splice(idx,1); renderTables(); } };

  // CARDS handlers
  document.getElementById('addCard').onclick = ()=>{
    const c = {
      id: uid('c_'),
      kind: document.getElementById('c_kind').value,
      title: document.getElementById('c_title').value.trim(),
      main: document.getElementById('c_main').value.trim(),
      image: document.getElementById('c_image').value.trim(),
      link: document.getElementById('c_link').value.trim()||'#',
      tags: document.getElementById('c_tags').value.split(',').map(s=>s.trim()).filter(Boolean),
      active: document.getElementById('c_active').value==='true'
    };
    if(!c.title || !c.image) return alert('Sarlavha va rasm majburiy.');
    (state.db.cards ||= []).push(c); renderTables(); resetCard();
  };
  document.getElementById('resetCard').onclick = resetCard;
  function resetCard(){ ['c_title','c_image','c_link','c_tags','c_main'].forEach(id=>document.getElementById(id).value=''); document.getElementById('c_active').value='true'; document.getElementById('c_kind').value='test'; }

  window.editCard = idx =>{
    const c = state.db.cards[idx];
    document.getElementById('c_kind').value=c.kind;
    document.getElementById('c_title').value=c.title;
    document.getElementById('c_main').value=c.main||'';
    document.getElementById('c_image').value=c.image;
    document.getElementById('c_link').value=c.link||'#';
    document.getElementById('c_tags').value=(c.tags||[]).join(', ');
    document.getElementById('c_active').value=c.active?'true':'false';
    document.getElementById('addCard').onclick = ()=>{
      state.db.cards[idx] = {
        id:c.id,
        kind: document.getElementById('c_kind').value,
        title: document.getElementById('c_title').value.trim(),
        main: document.getElementById('c_main').value.trim(),
        image: document.getElementById('c_image').value.trim(),
        link: document.getElementById('c_link').value.trim()||'#',
        tags: document.getElementById('c_tags').value.split(',').map(s=>s.trim()).filter(Boolean),
        active: document.getElementById('c_active').value==='true'
      };
      renderTables(); resetCard();
      document.getElementById('addCard').onclick = ()=>{
        const nc = {
          id: uid('c_'),
          kind: document.getElementById('c_kind').value,
          title: document.getElementById('c_title').value.trim(),
          main: document.getElementById('c_main').value.trim(),
          image: document.getElementById('c_image').value.trim(),
          link: document.getElementById('c_link').value.trim()||'#',
          tags: document.getElementById('c_tags').value.split(',').map(s=>s.trim()).filter(Boolean),
          active: document.getElementById('c_active').value==='true'
        };
        if(!nc.title || !nc.image) return alert('Sarlavha va rasm majburiy.');
        (state.db.cards ||= []).push(nc); renderTables(); resetCard();
      };
    };
  };
  window.delCard = idx => { if(confirm('O‘chirish?')){ state.db.cards.splice(idx,1); renderTables(); } };

  // Tabs
  document.querySelectorAll('.tab').forEach(t=>t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    ['users','banners','cards','import'].forEach(id=>document.getElementById(id).style.display='none');
    document.getElementById(t.dataset.tab).style.display='block';
  });

  // Export JSON
  document.getElementById('btnExport').onclick = ()=> downloadJSON(state.db, 'liteadmin.json');
  function downloadJSON(obj, name){
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click(); URL.revokeObjectURL(a.href);
  }

  // Import Excel/CSV
  document.getElementById('fileInput').addEventListener('change', async (e)=>{
    const f = e.target.files[0];
    if(!f){ document.getElementById('importStatus').textContent='Fayl tanlanmagan'; return; }
    const name = f.name.toLowerCase();
    try{
      if(name.endsWith('.csv')){
        const text = await f.text();
        const rows = text.split(/\r?\n/).map(r=>r.split(','));
        appendUsersRows(rows);
      }else{
        const data = await f.arrayBuffer();
        const wb = XLSX.read(data, {type:'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, {header:1});
        appendUsersRows(rows);
      }
      document.getElementById('importStatus').textContent = 'Import bajarildi';
      renderTables();
    }catch(err){
      document.getElementById('importStatus').textContent = 'Xatolik: '+err.message;
    }
  });
  function appendUsersRows(rows){
    let start = 0;
    const lower = s=>String(s||'').toLowerCase();
    if(rows.length && ['login','password','name','surname','class','points'].every(h => rows[0].map(lower).includes(h))){
      start = 1;
    }
    for(let i=start;i<rows.length;i++){
      const [login,password,name,surname,klass,points,avatar] = rows[i];
      if(!login || !password || !name) continue;
      (state.db.users ||= []).push({
        login:String(login).trim(),
        password:String(password).trim(),
        name:String(name).trim(),
        surname:String(surname||'').trim(),
        class:String(klass||'').trim(),
        points:Number(points||0),
        avatar:(avatar||'').startsWith('data:image') ? String(avatar) : null
      });
    }
  }

  ensureAdminSession();
  loadDB();
</script>
</body>
</html>
