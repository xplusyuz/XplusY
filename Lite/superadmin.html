<!doctype html>
<html lang="uz">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MathCenter — Super Admin Panel</title>
<meta name="color-scheme" content="dark">
<link rel="icon" type="image/svg+xml" href="assets/pi-logo.svg">
<link rel="stylesheet" href="assets/styles.css">
</head>
<body>
<header class="header-glass">
  <div class="container row">
    <div class="brand">
      <img src="assets/pi-logo.svg" alt="π" class="pi">
      <h2>MathCenter Super Admin</h2>
    </div>
    <div class="sp"></div>
    <label class="btn ghost">
      <input type="file" id="impLite" accept=".json" hidden> liteadmin.json Import
    </label>
    <label class="btn ghost">
      <input type="file" id="impTest" accept=".json" hidden> test.json Import
    </label>
    <button id="expLite" class="btn">liteadmin.json Export</button>
    <button id="expTest" class="btn">test.json Export</button>
  </div>
</header>

<main class="container" style="display:grid;gap:16px;margin-top:20px">
  <div class="card p">
    <div class="navtabs">
      <div class="tab active" data-tab="users">Foydalanuvchilar</div>
      <div class="tab" data-tab="tests">Testlar</div>
      <div class="tab" data-tab="cards">Kartalar & Bannerlar</div>
    </div>
  </div>

  <!-- USERS -->
  <section id="tab-users" class="card p tabpage">
    <div class="row">
      <h3>Foydalanuvchilar</h3>
      <div class="sp"></div>
      <button class="btn" id="addUserBtn">Foydalanuvchi qo'shish</button>
    </div>
    <p class="hint mt">Balllar avtomatik test yechilganda hisoblanadi (qo'lda emas).</p>
    <table class="table mt">
      <thead><tr><th>Avatar</th><th>Login</th><th>Ism</th><th>Familiya</th><th>Sinf</th><th>Amal</th></tr></thead>
      <tbody id="userRows"></tbody>
    </table>
  </section>

  <!-- TESTS -->
  <section id="tab-tests" class="card p tabpage" style="display:none">
    <div class="row">
      <h3>Testlar</h3>
      <div class="sp"></div>
      <button class="btn" id="addTestBtn">Yangi test</button>
    </div>
    <div id="testsList" class="mt"></div>
  </section>

  <!-- CARDS -->
  <section id="tab-cards" class="card p tabpage" style="display:none">
    <div class="row">
      <h3>Kartalar & Bannerlar</h3>
      <div class="sp"></div>
      <button class="btn" id="addCardBtn">Karta qo'shish</button>
      <button class="btn" id="addBannerBtn">Banner qo'shish</button>
    </div>
    <div class="mt"><h4>Kartalar</h4><div id="cardsList"></div></div>
    <div class="mt"><h4>Bannerlar</h4><div id="bannersList"></div></div>
  </section>
</main>

<script>
// === GLOBAL STATE ===
const state = {
  lite:{auth:{admin:{login:"admin",password:"admin"}},users:[],cards:[],banners:[]},
  tests:{meta:{version:"2.0.0"},tests:[]}
};
const $=s=>document.querySelector(s);

// === TABS ===
document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    document.querySelectorAll('.tabpage').forEach(x=>x.style.display='none');
    $('#tab-'+t.dataset.tab).style.display='block';
  };
});
function uid(p){return p+Math.random().toString(36).slice(2,8);}
function downloadJSON(name,obj){const blob=new Blob([JSON.stringify(obj,null,2)],{type:"application/json"});const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=name;a.click();URL.revokeObjectURL(a.href);}

// === USERS ===
function renderUsers(){
  const tb=$('#userRows');tb.innerHTML='';
  (state.lite.users||[]).forEach((u,i)=>{
    tb.innerHTML+=`
      <tr>
        <td>${u.avatar?`<img src="${u.avatar}" class="avatar-img">`:`<div class="avatar">${(u.name||'?')[0]}</div>`}</td>
        <td>${u.login}</td><td>${u.name||''}</td><td>${u.surname||''}</td><td>${u.class||''}</td>
        <td class="row">
          <button class="btn ghost small" onclick="editUser(${i})">Edit</button>
          <button class="btn danger small" onclick="delUser(${i})">Del</button>
          <label class="btn ghost small"><input hidden type="file" accept="image/*" onchange="setAvatar(event,${i})">Avatar</label>
        </td>
      </tr>`;
  });
}
function addUser(){
  const login=prompt("Login:");if(!login)return;
  const password=prompt("Parol:","1234")||"";
  const name=prompt("Ism:","")||"";
  const surname=prompt("Familiya:","")||"";
  const klass=prompt("Sinf:","")||"";
  state.lite.users.push({login,password,name,surname,class:klass,avatar:""});
  renderUsers();
}
function editUser(i){
  const u=state.lite.users[i];
  const name=prompt("Ism:",u.name||"");if(name===null)return;
  const surname=prompt("Familiya:",u.surname||"");if(surname===null)return;
  const klass=prompt("Sinf:",u.class||"");if(klass===null)return;
  Object.assign(u,{name,surname,class:klass});renderUsers();
}
function delUser(i){if(confirm("O'chirasizmi?")){state.lite.users.splice(i,1);renderUsers();}}
function setAvatar(e,i){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{state.lite.users[i].avatar=r.result;renderUsers();};r.readAsDataURL(f);}
$('#addUserBtn').onclick=addUser;

// === TESTS ===
function renderTests(){
  const box=$('#testsList');box.innerHTML='';
  (state.tests.tests||[]).forEach((t,ti)=>{
    const q=t.questions||[];
    box.innerHTML+=`
      <div class="qcard mt">
        <div class="row">
          <b>${t.title}</b>
          <div class="sp"></div>
          <button class="btn small" onclick="addQ('${t.id}')">Savol</button>
          <button class="btn ghost small" onclick="editT('${t.id}')">Edit</button>
          <button class="btn danger small" onclick="delT('${t.id}')">Del</button>
        </div>
        <div class="hint">${t.description||''}<br>${t.start} → ${t.end}, ${t.durationSec}s</div>
        <div>${q.map((x,i)=>`
          <div class='qcard mt'>
            <b>Q${i+1}.</b> ${x.text}<br>
            <small>${x.options.join(' | ')} — To‘g‘ri: #${x.answerIndex+1}, Ball: ${x.points}</small><br>
            <button class='btn ghost small' onclick="editQ('${t.id}',${i})">Edit</button>
            <button class='btn danger small' onclick="delQ('${t.id}',${i})">Del</button>
          </div>`).join('')}</div>
      </div>`;
  });
}
function addTest(){
  const title=prompt("Sarlavha:");if(!title)return;
  const start=prompt("Boshlanish:","2025-10-20T09:00:00+05:00")||"";
  const end=prompt("Tugash:","2025-10-31T23:59:00+05:00")||"";
  const durationSec=+prompt("Davomiylik (sek):","900")||900;
  const perQuestionDefault=+prompt("Har savol uchun ball:","5")||5;
  state.tests.tests.push({id:uid("t"),title,start,end,durationSec,perQuestionDefault,questions:[]});
  renderTests();
}
function editT(id){const t=state.tests.tests.find(x=>x.id==id);if(!t)return;
  const title=prompt("Sarlavha:",t.title)||t.title;Object.assign(t,{title});renderTests();}
function delT(id){if(confirm("Testni o'chirasizmi?")){state.tests.tests=state.tests.tests.filter(x=>x.id!=id);renderTests();}}
function addQ(tid){
  const t=state.tests.tests.find(x=>x.id==tid);if(!t)return;
  const text=prompt("Savol (LaTeX $...$):");if(!text)return;
  const options=prompt("Variantlar (vergul bilan):","A,B,C,D").split(",").map(x=>x.trim());
  const ans=+prompt("To‘g‘ri javob (1..n):","1")-1;
  const pts=+prompt("Ball:","5")||t.perQuestionDefault;
  t.questions.push({id:uid("q"),text,options,answerIndex:ans,points:pts});
  renderTests();
}
function editQ(tid,qi){
  const t=state.tests.tests.find(x=>x.id==tid);const q=t.questions[qi];
  const text=prompt("Savol:",q.text)||q.text;
  const options=prompt("Variantlar:",q.options.join(","))||q.options.join(",");
  const ans=+prompt("To‘g‘ri javob (1..n):",q.answerIndex+1)-1;
  const pts=+prompt("Ball:",q.points)||q.points;
  Object.assign(q,{text,options:options.split(",").map(s=>s.trim()),answerIndex:ans,points:pts});renderTests();
}
function delQ(tid,qi){const t=state.tests.tests.find(x=>x.id==tid);t.questions.splice(qi,1);renderTests();}
$('#addTestBtn').onclick=addTest;

// === CARDS ===
function renderCards(){$('#cardsList').innerHTML=state.lite.cards.map((c,i)=>`
  <div class="qcard mt"><b>${c.title}</b><br>${c.link||'#'}<br>
  <button class='btn ghost small' onclick='editCard(${i})'>Edit</button>
  <button class='btn danger small' onclick='delCard(${i})'>Del</button></div>`).join('');}
function addCard(){const title=prompt("Sarlavha:","Test");if(!title)return;
  const link=prompt("Link:","test-firebase.html?id=t1");state.lite.cards.push({id:uid("c"),title,link,active:true});renderCards();}
function editCard(i){const c=state.lite.cards[i];const t=prompt("Sarlavha:",c.title)||c.title;const l=prompt("Link:",c.link)||c.link;Object.assign(c,{title:t,link:l});renderCards();}
function delCard(i){state.lite.cards.splice(i,1);renderCards();}
$('#addCardBtn').onclick=addCard;

// === BANNERS ===
function renderBanners(){const box=$('#bannersList');box.innerHTML=(state.lite.banners||[]).map((b,i)=>`
  <div class='qcard mt'><b>${b.title}</b><br>${b.subtitle||''}
  <button class='btn ghost small' onclick='editBanner(${i})'>Edit</button>
  <button class='btn danger small' onclick='delBanner(${i})'>Del</button></div>`).join('');}
function addBanner(){const title=prompt("Banner nomi:","Yangi testlar");const subtitle=prompt("Kichik matn:","Matematika marafoni");state.lite.banners.push({id:uid("b"),title,subtitle,active:true});renderBanners();}
function editBanner(i){const b=state.lite.banners[i];const t=prompt("Sarlavha:",b.title)||b.title;const s=prompt("Kichik matn:",b.subtitle)||b.subtitle;Object.assign(b,{title:t,subtitle:s});renderBanners();}
function delBanner(i){state.lite.banners.splice(i,1);renderBanners();}
$('#addBannerBtn').onclick=addBanner;

// === EXPORT / IMPORT ===
$('#expLite').onclick=()=>downloadJSON("liteadmin.json",state.lite);
$('#expTest').onclick=()=>downloadJSON("test.json",state.tests);
$('#impLite').onchange=async e=>{const f=e.target.files[0];if(!f)return;state.lite=JSON.parse(await f.text());renderUsers();renderCards();renderBanners();}
$('#impTest').onchange=async e=>{const f=e.target.files[0];if(!f)return;state.tests=JSON.parse(await f.text());renderTests();}

// INIT
renderUsers();renderTests();renderCards();renderBanners();
</script>
</body>
</html>
