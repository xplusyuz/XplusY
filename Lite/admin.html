<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LeaderMath ‚Äî Admin (index.json)</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root{ --brand:#2E8B57; --brand2:#1F6B45; --bg:#f6faf8; --card:#fff; --text:#0f172a; --muted:#6b7c75; --frame:#e3efe8; --chip:#e9f5ef; --chip-b:#cfe9dc; }
    :root.dark{ --bg:#0b0f0e; --card:#0f1714; --text:#EAF7F0; --muted:#A8BBB3; --frame:#244b39; --chip:#0f221b; --chip-b:#2a5a45; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:10px 12px;display:flex;align-items:center;gap:8px}
    .spacer{flex:1}
    .btn{border:none;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer}
    .ghost{background:#ffffff22;color:#fff;border:1px solid #ffffff44}
    .ok{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;border:none}
    .danger{background:#9b1c1c;color:#fff;border:none}
    .wrap{max-width:1080px;margin:0 auto;padding:14px}
    h2{margin:22px 0 10px}
    .panel{background:var(--card);border:1px dashed var(--frame);border-radius:14px;padding:12px;margin-bottom:12px}
    label{font-size:12px;color:var(--muted)}
    input,textarea,select{width:100%;padding:10px;border:1px solid var(--frame);border-radius:10px;background:transparent;color:inherit}
    textarea{min-height:100px}
    .grid{display:grid;gap:10px}
    .g2{grid-template-columns:1fr 1fr}
    .g3{grid-template-columns:1fr 1fr 1fr}
    @media (max-width:720px){ .g2,.g3{grid-template-columns:1fr} }
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px dashed var(--frame);padding:8px;vertical-align:top}
    .muted{color:var(--muted)}
    .tag{display:inline-block;background:var(--chip);border:1px solid var(--chip-b);padding:2px 8px;border-radius:999px;font-size:12px;margin:2px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    pre{background:#00000008;border:1px dashed var(--frame);padding:12px;border-radius:12px;white-space:pre-wrap}
    .pill{display:inline-block;padding:4px 8px;border:1px solid var(--frame);border-radius:999px;font-size:12px}
    .mini{font-size:12px}
    .help{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <strong>LeaderMath ‚Äî Admin (index.json)</strong>
    <div class="spacer"></div>
    <button id="theme" class="btn ghost">üåô Tun</button>
    <input id="fileImport" type="file" accept="application/json" style="display:none">
    <button id="btnImport" class="btn ghost">üìÇ Import (index.json)</button>
    <button id="btnExport" class="btn ghost">üíæ Export (index.json)</button>
    <button id="signin" class="btn ghost">Google bilan kirish</button>
    <button id="signout" class="btn ghost" style="display:none">Chiqish</button>
  </header>

  <div class="wrap">
    <div id="guard" class="panel">
      <div><b>Hali kirilmagansiz.</b> Faqat <code>sohibjonmath@gmail.com</code> yoki <code>users/{uid}.role = "admin"</code> kiradi.</div>
    </div>

    <!-- DEFAULT TAGS -->
    <section id="metaSec" class="panel" style="display:none">
      <h2>Umumiy sozlamalar</h2>
      <div class="grid g2">
        <div>
          <label>Default teglar (vergul bilan)</label>
          <input id="defaultTags" placeholder="BSB, CHSB, 1-chorak, ...">
          <div class="help">Bu teglar index sahifadagi ‚Äúchips‚Äùlar uchun boshlang‚Äòich ro‚Äòyxat.</div>
        </div>
        <div>
          <label>Avto-saqlash (localStorage)</label>
          <div class="row">
            <span id="autoStatus" class="pill">Holat: ‚Äî</span>
            <button id="btnSaveLS" class="btn">üí† Local saqlash</button>
            <button id="btnLoadLS" class="btn">üì• Local yuklash</button>
            <button id="btnClearLS" class="btn danger">üßπ Local tozalash</button>
          </div>
        </div>
      </div>
    </section>

    <!-- BANNERS (HTML) -->
    <section id="bannersSec" class="panel" style="display:none">
      <h2>Bannerlar (HTML)</h2>
      <div class="grid">
        <div class="g3 grid">
          <div><label>Tartib (order)</label><input id="banOrder" type="number" value="1"></div>
          <div><label>Aktiv?</label><select id="banActive"><option value="true">Ha</option><option value="false">Yo‚Äòq</option></select></div>
          <div><label>Banner ID (tahrirlashda)</label><input id="banId" placeholder="‚Äî" disabled></div>
        </div>
        <div>
          <label>Banner HTML (16:9 blok ichida ko‚Äòrinadi)</label>
          <textarea id="banHtml" placeholder="&lt;div&gt;Banner ichidagi HTML...&lt;/div&gt;"></textarea>
          <div class="help">Rasm, gradient, matn ‚Äî hammasini shu HTML ichida berasiz. Inline CSS ishlaydi.</div>
        </div>
        <div class="row">
          <button id="banSave" class="btn ok">‚ûï Saqlash</button>
          <button id="banReset" class="btn">‚Üª Tozalash</button>
        </div>
      </div>
      <div style="height:8px"></div>
      <table>
        <thead><tr><th>#</th><th>Order</th><th>Aktiv</th><th>Banner (HTML qisqa)</th><th>Amal</th></tr></thead>
        <tbody id="banList"></tbody>
      </table>
    </section>

    <!-- SECTIONS -->
    <section id="sectionsSec" class="panel" style="display:none">
      <h2>Bo‚Äòlimlar (Sections)</h2>
      <div class="grid g3">
        <div><label>Nomi</label><input id="secTitle" placeholder="Masalan: BSB ‚Äî Algebra bo‚Äòlimi"></div>
        <div><label>Tartib (order)</label><input id="secOrder" type="number" value="1"></div>
        <div><label>Aktiv?</label><select id="secActive"><option value="true">Ha</option><option value="false">Yo‚Äòq</option></select></div>
        <div><label>Section ID (tahrirlashda)</label><input id="secId" placeholder="‚Äî" disabled></div>
        <div style="grid-column:1/-1" class="row">
          <button id="secSave" class="btn ok">‚ûï Saqlash</button>
          <button id="secReset" class="btn">‚Üª Tozalash</button>
        </div>
      </div>

      <table>
        <thead><tr><th>#</th><th>Order</th><th>Bo‚Äòlim</th><th>Aktiv</th><th>Kartalar</th><th>Amal</th></tr></thead>
        <tbody id="secList"></tbody>
      </table>
    </section>

    <!-- ITEMS (cards) -->
    <section id="itemsSec" class="panel" style="display:none">
      <h3 id="itemsTitle">Kartalar</h3>
      <div class="grid g3">
        <div><label>Nomi</label><input id="itName" placeholder="Masalan: Algebra 1-chorak"></div>
        <div><label>Tartib (order)</label><input id="itOrder" type="number" value="1"></div>
        <div><label>Aktiv?</label><select id="itActive"><option value="true">Ha</option><option value="false">Yo‚Äòq</option></select></div>

        <div><label>Tur (type)</label>
          <select id="itType">
            <option value="open">open (doim ochiq)</option>
            <option value="start">start (startAt dan keyin)</option>
            <option value="window">window (start‚Äìend oralig‚Äòida)</option>
          </select>
        </div>
        <div><label>Start (ISO)</label><input id="itStart" placeholder="2025-10-24T09:00:00+05:00"></div>
        <div><label>End (ISO)</label><input id="itEnd" placeholder="2025-10-24T10:00:00+05:00"></div>

        <div><label>Link (Boshlash)</label><input id="itLink" placeholder="./tests/linear.html"></div>
        <div><label>Rasm URL (ixtiyoriy)</label><input id="itImage" placeholder="https://.../800x450.png"></div>
        <div><label>Best?</label><select id="itBest"><option value="false">Yo‚Äòq</option><option value="true">Ha</option></select></div>

        <div style="grid-column:1/-1"><label>Teglar (vergul bilan)</label><input id="itTags" placeholder="BSB, algebra, 1-chorak"></div>
        <div style="grid-column:1/-1"><label>Tavsif</label><textarea id="itDesc" rows="2" placeholder="Qisqacha tavsif..."></textarea></div>
        <div style="grid-column:1/-1"><label>Batafsil HTML (modal uchun)</label><textarea id="itDetails" placeholder="&lt;h2&gt;Sarlavha&lt;/h2&gt;..."></textarea></div>

        <div><label>Item ID (tahrirlashda)</label><input id="itId" placeholder="‚Äî" disabled></div>
        <div style="grid-column:1/-1" class="row">
          <button id="itSave" class="btn ok">‚ûï Saqlash</button>
          <button id="itReset" class="btn">‚Üª Tozalash</button>
        </div>
      </div>

      <table>
        <thead><tr><th>#</th><th>Order</th><th>Nom</th><th>Tur</th><th>Best</th><th>Aktiv</th><th>Amal</th></tr></thead>
        <tbody id="itList"></tbody>
      </table>
    </section>

    <!-- JSON PREVIEW -->
    <section id="jsonSec" class="panel" style="display:none">
      <h2>JSON ko‚Äòrish</h2>
      <pre id="jsonPreview" class="mini">{}</pre>
    </section>
  </div>

<script type="module">
  /* ====== Tema ====== */
  const root=document.documentElement, themeBtn=document.getElementById('theme');
  const setTheme = (m)=>{ root.classList.toggle('dark', m==='dark'); localStorage.setItem('lm-admin-theme', m) };
  setTheme(localStorage.getItem('lm-admin-theme') || (matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
  themeBtn.onclick=()=> setTheme(root.classList.contains('dark') ? 'light':'dark');

  /* ====== Firebase (faqat guard uchun) ====== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const cfg = {
    apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
    authDomain: "xplusy-760fa.firebaseapp.com",
    projectId: "xplusy-760fa",
    storageBucket: "xplusy-760fa.firebasestorage.app",
    messagingSenderId: "992512966017",
    appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
    measurementId: "G-459PLJ7P7L"
  };
  const app = initializeApp(cfg);
  const auth = getAuth(app);
  const db = getFirestore(app);
  await setPersistence(auth, browserLocalPersistence);
  const provider = new GoogleAuthProvider();

  const signinBtn = document.getElementById('signin');
  const signoutBtn = document.getElementById('signout');
  const guard = document.getElementById('guard');

  signinBtn.onclick = async()=>{ try{ await signInWithPopup(auth, provider) }catch(e){ alert(e.message) } };
  signoutBtn.onclick = async()=>{ await signOut(auth) };

  const metaSec = document.getElementById('metaSec');
  const bannersSec = document.getElementById('bannersSec');
  const sectionsSec = document.getElementById('sectionsSec');
  const itemsSec = document.getElementById('itemsSec');
  const jsonSec = document.getElementById('jsonSec');

  function showPanels(v){
    const disp = v ? '' : 'none';
    metaSec.style.display = disp;
    bannersSec.style.display = disp;
    sectionsSec.style.display = disp;
    jsonSec.style.display = disp;
  }

  function allowAdmin(userDoc, user){
    const owner = user?.email === 'sohibjonmath@gmail.com';
    const isAdmin = userDoc?.role === 'admin';
    return owner || isAdmin;
  }

  onAuthStateChanged(auth, async(user)=>{
    if(!user){
      guard.style.display='';
      showPanels(false);
      itemsSec.style.display='none';
      signinBtn.style.display='inline-block';
      signoutBtn.style.display='none';
      return;
    }
    signinBtn.style.display='none';
    signoutBtn.style.display='inline-block';

    const uref = doc(db, 'users', user.uid);
    let udoc = (await getDoc(uref)).data();
    if(!udoc){
      await setDoc(uref, { name:user.displayName||'Foydalanuvchi', email:user.email||null, role:'user', createdAt:serverTimestamp() }, { merge:true });
      udoc=(await getDoc(uref)).data();
    }
    if(!allowAdmin(udoc, user)){
      guard.innerHTML="<b>Ruxsat yo‚Äòq.</b> Bu sahifa faqat adminlar uchun.";
      return;
    }
    guard.style.display='none';
    showPanels(true);
    refreshAll();
  });

  /* ====== JSON Model (RAM) ====== */
  let model = {
    defaultTags: ["BSB", "CHSB", "1-chorak", "2-chorak", "3-chorak", "4-chorak"],
    banners: [],
    sections: []
  };

  // helpers
  const $ = (id)=>document.getElementById(id);
  const jsonPreview = $('jsonPreview');
  const setPreview = ()=> jsonPreview.textContent = JSON.stringify(model, null, 2);

  // LocalStorage helpers
  const LS_KEY = 'lm-index-json-model';
  const autoStatus = $('autoStatus');
  function saveToLS(){ localStorage.setItem(LS_KEY, JSON.stringify(model)); autoStatus.textContent='Holat: Saqlandi'; }
  function loadFromLS(){
    const raw = localStorage.getItem(LS_KEY);
    if(!raw){ alert('LocalStorage bo‚Äòsh'); return; }
    try{ model = JSON.parse(raw); refreshAll(); autoStatus.textContent='Holat: Yuklandi'; }
    catch(e){ alert('Localdan o‚Äòqishda xato: '+e.message); }
  }
  function clearLS(){ localStorage.removeItem(LS_KEY); autoStatus.textContent='Holat: Tozalandi'; }

  $('btnSaveLS').onclick = saveToLS;
  $('btnLoadLS').onclick = loadFromLS;
  $('btnClearLS').onclick = clearLS;

  // Import/Export
  const fileImport = $('fileImport');
  $('btnImport').onclick = ()=> fileImport.click();
  fileImport.onchange = async(e)=>{
    const f = e.target.files?.[0]; if(!f) return;
    try{
      const txt = await f.text();
      const obj = JSON.parse(txt);
      if(!obj || typeof obj!=='object') throw new Error('JSON noto‚Äòg‚Äòri');
      model = normalizeModel(obj);
      refreshAll();
      autoStatus.textContent='Holat: Fayldan yuklandi';
      alert('Import OK');
    }catch(err){ alert('Import xato: '+err.message); }
    finally{ fileImport.value=''; }
  };

  $('btnExport').onclick = ()=>{
    try{
      const blob = new Blob([JSON.stringify(model, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'index.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }catch(e){ alert('Export xato: '+e.message); }
  };

  /* ====== Normalizator ====== */
  function asBool(v){ return String(v)==='true' || v===true; }
  function normalizeModel(m){
    const out = { defaultTags: Array.isArray(m.defaultTags)? m.defaultTags:[], banners:[], sections:[] };
    (m.banners||[]).forEach(b=>{
      out.banners.push({
        html: String(b.html||''),
        order: Number(b.order||0),
        active: asBool(b.active)
      });
    });
    (m.sections||[]).forEach(s=>{
      const sec = { title: String(s.title||''), order:Number(s.order||0), active:asBool(s.active), items:[] };
      (s.items||[]).forEach(it=>{
        sec.items.push({
          type: it.type||'open',
          name: String(it.name||''),
          description: it.description? String(it.description): null,
          tags: Array.isArray(it.tags)? it.tags.filter(Boolean): [],
          best: asBool(it.best),
          order: Number(it.order||0),
          active: asBool(it.active),
          link: it.link? String(it.link): null,
          image: it.image? String(it.image): null,
          startAt: it.startAt? String(it.startAt): null,
          endAt: it.endAt? String(it.endAt): null,
          detailsHtml: it.detailsHtml? String(it.detailsHtml): null
        });
      });
      out.sections.push(sec);
    });
    // sort
    out.banners.sort((a,b)=>(a.order??0)-(b.order??0));
    out.sections.sort((a,b)=>(a.order??0)-(b.order??0));
    out.sections.forEach(s=>{
      s.items.sort((a,b)=>(a.order??0)-(b.order??0));
      s.items.sort((a,b)=> (b.best?1:0)-(a.best?1:0)); // BEST oldinda
    });
    return out;
  }

  /* ====== DEFAULT TAGS UI ====== */
  const defaultTags = $('defaultTags');
  defaultTags.oninput = ()=>{
    model.defaultTags = defaultTags.value.split(',').map(s=>s.trim()).filter(Boolean);
    setPreview(); saveToLS();
  };

  /* ====== BANNERS UI ====== */
  const banId = $('banId'), banOrder=$('banOrder'), banActive=$('banActive'), banHtml=$('banHtml'), banList=$('banList');
  let editingBannerIndex = null;

  function resetBannerForm(){
    editingBannerIndex = null;
    banId.value=''; banOrder.value='1'; banActive.value='true'; banHtml.value='';
  }
  $('banReset').onclick = resetBannerForm;

  $('banSave').onclick = ()=>{
    const item = {
      html: banHtml.value.trim(),
      order: Number(banOrder.value||0),
      active: asBool(banActive.value)
    };
    if(!item.html){ alert('Banner HTML bo‚Äòsh bo‚Äòlishi mumkin emas.'); return; }
    if(editingBannerIndex!=null){
      model.banners[editingBannerIndex] = item;
    } else {
      model.banners.push(item);
    }
    model.banners.sort((a,b)=>(a.order??0)-(b.order??0));
    renderBanners();
    setPreview(); saveToLS();
    resetBannerForm();
  };

  function renderBanners(){
    banList.innerHTML='';
    model.banners.forEach((b,idx)=>{
      const tr=document.createElement('tr');
      const short = (b.html||'').replace(/\s+/g,' ').slice(0,80);
      tr.innerHTML = `<td>${idx+1}</td>
        <td>${b.order??''}</td>
        <td>${b.active?'‚úÖ':'‚Äî'}</td>
        <td class="muted">${short}${b.html.length>80?'‚Ä¶':''}</td>
        <td>
          <button class="btn" data-edit="${idx}">‚úé</button>
          <button class="btn danger" data-del="${idx}">üóë</button>
          <button class="btn" data-up="${idx}">‚ñ≤</button>
          <button class="btn" data-down="${idx}">‚ñº</button>
        </td>`;
      banList.appendChild(tr);
    });
    banList.querySelectorAll('[data-edit]').forEach(b=> b.onclick=()=>{
      const i=Number(b.getAttribute('data-edit')); const v=model.banners[i];
      editingBannerIndex=i;
      banId.value = 'banner_'+(i+1);
      banOrder.value = v.order??1;
      banActive.value = String(!!v.active);
      banHtml.value = v.html||'';
      window.scrollTo({top:0,behavior:'smooth'});
    });
    banList.querySelectorAll('[data-del]').forEach(b=> b.onclick=()=>{
      const i=Number(b.getAttribute('data-del'));
      if(confirm('Banner o‚Äòchirsinmi?')){ model.banners.splice(i,1); renderBanners(); setPreview(); saveToLS(); }
    });
    banList.querySelectorAll('[data-up]').forEach(b=> b.onclick=()=>{
      const i=Number(b.getAttribute('data-up')); if(i<=0) return;
      [model.banners[i-1], model.banners[i]] = [model.banners[i], model.banners[i-1]];
      renderBanners(); setPreview(); saveToLS();
    });
    banList.querySelectorAll('[data-down]').forEach(b=> b.onclick=()=>{
      const i=Number(b.getAttribute('data-down')); if(i>=model.banners.length-1) return;
      [model.banners[i+1], model.banners[i]] = [model.banners[i], model.banners[i+1]];
      renderBanners(); setPreview(); saveToLS();
    });
  }

  /* ====== SECTIONS UI ====== */
  const secId=$('secId'), secTitle=$('secTitle'), secOrder=$('secOrder'), secActive=$('secActive'), secList=$('secList');
  let editingSectionIndex = null;

  function resetSectionForm(){
    editingSectionIndex=null; secId.value=''; secTitle.value=''; secOrder.value='1'; secActive.value='true';
    itemsSec.style.display='none';
  }
  $('secReset').onclick = resetSectionForm;

  $('secSave').onclick = ()=>{
    const sec = { title: secTitle.value.trim(), order:Number(secOrder.value||0), active:asBool(secActive.value), items: model.sections[editingSectionIndex]?.items||[] };
    if(!sec.title){ alert('Bo‚Äòlim nomi bo‚Äòsh.'); return; }
    if(editingSectionIndex!=null){ model.sections[editingSectionIndex] = sec; }
    else { model.sections.push(sec); }
    model.sections.sort((a,b)=>(a.order??0)-(b.order??0));
    renderSections();
    setPreview(); saveToLS();
    resetSectionForm();
  };

  function renderSections(){
    secList.innerHTML='';
    model.sections.forEach((s,idx)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${idx+1}</td>
        <td>${s.order??''}</td>
        <td><b>${s.title||'-'}</b></td>
        <td>${s.active?'‚úÖ':'‚Äî'}</td>
        <td><button class="btn" data-items="${idx}">üì¶ Kartalar (${s.items?.length||0})</button></td>
        <td>
          <button class="btn" data-edit="${idx}">‚úé</button>
          <button class="btn danger" data-del="${idx}">üóë</button>
          <button class="btn" data-up="${idx}">‚ñ≤</button>
          <button class="btn" data-down="${idx}">‚ñº</button>
        </td>`;
      secList.appendChild(tr);
    });
    secList.querySelectorAll('[data-edit]').forEach(b=> b.onclick=()=>{
      const i=Number(b.getAttribute('data-edit')); const v=model.sections[i];
      editingSectionIndex=i; secId.value='section_'+(i+1); secTitle.value=v.title||''; secOrder.value=v.order??1; secActive.value=String(!!v.active);
      window.scrollTo({top:0,behavior:'smooth'});
    });
    secList.querySelectorAll('[data-del]').forEach(b=> b.onclick=()=>{
      const i=Number(b.getAttribute('data-del'));
      if(confirm('Bo‚Äòlim o‚Äòchirsinmi?')){ model.sections.splice(i,1); renderSections(); setPreview(); saveToLS(); itemsSec.style.display='none'; }
    });
    secList.querySelectorAll('[data-up]').forEach(b=> b.onclick=()=>{
      const i=Number(b.getAttribute('data-up')); if(i<=0) return;
      [model.sections[i-1], model.sections[i]] = [model.sections[i], model.sections[i-1]];
      renderSections(); setPreview(); saveToLS();
    });
    secList.querySelectorAll('[data-down]').forEach(b=> b.onclick=()=>{
      const i=Number(b.getAttribute('data-down')); if(i>=model.sections.length-1) return;
      [model.sections[i+1], model.sections[i]] = [model.sections[i], model.sections[i+1]];
      renderSections(); setPreview(); saveToLS();
    });
    // items button
    secList.querySelectorAll('[data-items]').forEach(b=> b.onclick=()=>{
      const i=Number(b.getAttribute('data-items'));
      openItems(i);
    });
  }

  /* ====== ITEMS UI ====== */
  const itemsTitle=$('itemsTitle'), itList=$('itList');
  const itName=$('itName'), itOrder=$('itOrder'), itActive=$('itActive'), itType=$('itType');
  const itStart=$('itStart'), itEnd=$('itEnd'), itLink=$('itLink'), itImage=$('itImage'), itBest=$('itBest');
  const itTags=$('itTags'), itDesc=$('itDesc'), itDetails=$('itDetails'), itId=$('itId');

  let activeSectionIndex=null, editingItemIndex=null;

  function openItems(sectionIndex){
    activeSectionIndex = sectionIndex;
    itemsTitle.textContent = 'Kartalar ‚Äî ' + (model.sections[sectionIndex]?.title || '');
    itemsSec.style.display='';
    renderItems();
    resetItemForm();
    window.scrollTo({top:itemsSec.offsetTop-10, behavior:'smooth'});
  }

  function resetItemForm(){
    editingItemIndex=null; itId.value='';
    itName.value=''; itOrder.value='1'; itActive.value='true'; itType.value='open';
    itStart.value=''; itEnd.value=''; itLink.value=''; itImage.value=''; itBest.value='false';
    itTags.value=''; itDesc.value=''; itDetails.value='';
  }
  $('itReset').onclick = resetItemForm;

  $('itSave').onclick = ()=>{
    if(activeSectionIndex==null){ alert('Avval bo‚Äòlimni tanlang.'); return; }
    const sec = model.sections[activeSectionIndex];
    if(!sec){ alert('Bo‚Äòlim topilmadi.'); return; }
    const item = {
      type: itType.value,
      name: itName.value.trim(),
      description: itDesc.value.trim() || null,
      tags: itTags.value.split(',').map(s=>s.trim()).filter(Boolean),
      best: asBool(itBest.value),
      order: Number(itOrder.value||0),
      active: asBool(itActive.value),
      link: itLink.value.trim() || null,
      image: itImage.value.trim() || null,
      startAt: itStart.value.trim() || null,
      endAt: itEnd.value.trim() || null,
      detailsHtml: itDetails.value.trim() || null
    };
    if(!item.name){ alert('Karta nomi bo‚Äòsh.'); return; }
    // time validation light
    if(item.type!=='open' && item.startAt && isNaN(new Date(item.startAt).getTime())){ alert('startAt ISO vaqt noto‚Äòg‚Äòri.'); return; }
    if(item.type==='window' && item.endAt && isNaN(new Date(item.endAt).getTime())){ alert('endAt ISO vaqt noto‚Äòg‚Äòri.'); return; }

    if(editingItemIndex!=null){ sec.items[editingItemIndex]=item; }
    else { sec.items = sec.items || []; sec.items.push(item); }

    // BEST birinchi: keyin order
    sec.items.sort((a,b)=> (b.best?1:0)-(a.best?1:0) || (a.order??0)-(b.order??0));

    renderItems(); setPreview(); saveToLS(); resetItemForm();
  };

  function renderItems(){
    if(activeSectionIndex==null){ itList.innerHTML=''; return; }
    const sec = model.sections[activeSectionIndex]; itList.innerHTML='';

    (sec.items||[]).forEach((v,idx)=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${idx+1}</td>
        <td>${v.order??''}</td>
        <td><b>${v.name||'-'}</b><div class="muted mini">${v.description||''}</div></td>
        <td>${v.type||'open'}</td>
        <td>${v.best?'‚≠ê':''}</td>
        <td>${v.active?'‚úÖ':'‚Äî'}</td>
        <td>
          <button class="btn" data-edit="${idx}">‚úé</button>
          <button class="btn danger" data-del="${idx}">üóë</button>
          <button class="btn" data-up="${idx}">‚ñ≤</button>
          <button class="btn" data-down="${idx}">‚ñº</button>
        </td>`;
      itList.appendChild(tr);
    });

    itList.querySelectorAll('[data-edit]').forEach(b=> b.onclick=()=>{
      const i=Number(b.getAttribute('data-edit'));
      const v=model.sections[activeSectionIndex].items[i];
      editingItemIndex=i; itId.value='item_'+(i+1);
      itName.value=v.name||''; itOrder.value=v.order??1; itActive.value=String(!!v.active);
      itType.value=v.type||'open'; itStart.value=v.startAt||''; itEnd.value=v.endAt||'';
      itLink.value=v.link||''; itImage.value=v.image||''; itBest.value=String(!!v.best);
      itTags.value=(v.tags||[]).join(', ');
      itDesc.value=v.description||''; itDetails.value=v.detailsHtml||'';
      window.scrollTo({top:itemsSec.offsetTop-10, behavior:'smooth'});
    });
    itList.querySelectorAll('[data-del]').forEach(b=> b.onclick=()=>{
      const i=Number(b.getAttribute('data-del'));
      if(confirm('Kartani o‚Äòchirsinmi?')){ model.sections[activeSectionIndex].items.splice(i,1); renderItems(); setPreview(); saveToLS(); }
    });
    itList.querySelectorAll('[data-up]').forEach(b=> b.onclick=()=>{
      const i=Number(b.getAttribute('data-up')); if(i<=0) return;
      const arr=model.sections[activeSectionIndex].items;
      [arr[i-1], arr[i]] = [arr[i], arr[i-1]];
      renderItems(); setPreview(); saveToLS();
    });
    itList.querySelectorAll('[data-down]').forEach(b=> b.onclick=()=>{
      const i=Number(b.getAttribute('data-down')); const arr=model.sections[activeSectionIndex].items;
      if(i>=arr.length-1) return;
      [arr[i+1], arr[i]] = [arr[i], arr[i+1]];
      renderItems(); setPreview(); saveToLS();
    });
  }

  /* ====== REFRESH ====== */
  function refreshAll(){
    defaultTags.value = (model.defaultTags||[]).join(', ');
    renderBanners();
    renderSections();
    itemsSec.style.display='none';
    setPreview();
    autoStatus.textContent='Holat: Faol';
  }

  // Boshlang‚Äòich preview
  setPreview();
</script>
</body>
</html>
