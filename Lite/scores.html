<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MathCenter — Natijalar</title>
  <link rel="stylesheet" href="css/style.css"/>
</head>
<body>
  <div id="header"></div>
  <main class="container">
    <div class="hero"><h2>Natijalar tarixi</h2><p class="muted">Sizning barcha urinishlaringiz bo'yicha qaydlar.</p></div>
    <div class="card"><div class="content">
      <table class="table" id="tbl"><thead><tr><th>Sana</th><th>Test</th><th>Ball</th></tr></thead><tbody></tbody></table>
    </div></div>
  </main>
  <footer class="footer">© 2025 MathCenter</footer>

  <script type="module">
    import { db } from './js/firebase-init.js';
    import { collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    function userRole(){const u=JSON.parse(localStorage.getItem('mc_user')||'null');return u?(u.role||'user'):null;}
    function renderHeader(active=''){ 
      const u = JSON.parse(localStorage.getItem('mc_user')||'null'); 
      const role = userRole();
      const adminLink = (role==='admin'||role==='superadmin')?`<a class="" href="admin.html">Admin</a>`:'';
      const auth = u?`<span class="badge">ID: ${u.numericId??u.id}</span><span class="badge">Ism: ${u.name}</span><span id="pointsBadge" class="badge" style="display:none"></span><a class="btn" href="#" id="logoutBtn">Chiqish</a>`:`<a class="btn" href="login.html">Kirish</a>`;
      return `<header class="header"><div class="header-inner container"><div class="brand"><div class="pi">π</div><div>MathCenter</div></div><nav class="nav"><a href="index.html">Bosh sahifa</a><a href="scores.html" class="active">Natijalar</a><a href="rating.html">Reyting</a>${adminLink}</nav><div class="auth">${auth}</div></div></header>`;
    }
    function bindLogout(){const b=document.querySelector('#logoutBtn'); if(b){b.onclick=(e)=>{e.preventDefault();localStorage.removeItem('mc_user');location.href='index.html';};}}
    async function fillPoints(db){
      const user = JSON.parse(localStorage.getItem("mc_user") || "null"); if(!user) return;
      const id = String(user.numericId ?? user.id ?? user.login);
      const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
      const snap = await getDoc(doc(db,'user_points',id));
      const badge = document.getElementById('pointsBadge');
      if (snap.exists()) { const pts = snap.data().totalPoints||0; badge.textContent='Ball: '+pts; badge.style.display='inline-block'; }
    }
    document.getElementById('header').innerHTML = renderHeader();
    bindLogout();
    fillPoints(db);

    const u = JSON.parse(localStorage.getItem('mc_user')||'null');
    if(!u){ alert('Kirish talab etiladi'); location.href='login.html'; }
    (async () => {
      const uid = String(u.numericId ?? u.id ?? u.login);
      const qref = query(collection(db, 'scores'), where('userId','==', uid), orderBy('createdAt','desc'));
      const snap = await getDocs(qref);
      const rows = [];
      snap.forEach(d => {
        const x = d.data();
        const when = (x.createdAt && x.createdAt.toDate)? x.createdAt.toDate().toLocaleString() : '';
        rows.push(`<tr><td>${when}</td><td>${x.testTitle||x.testId}</td><td>${x.score}/${x.total}</td></tr>`);
      });
      document.querySelector('#tbl tbody').innerHTML = rows.join('') || '<tr><td colspan="3" class="muted">Hali natijalar yo\'q</td></tr>';
    })();
  </script>
</body>
</html>
