<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LeaderMath — Admin (Firebase)</title>
  <style>
    :root{--brand:#2E8B57;--brand2:#1F6B45;--bg:#f7f9f8;--card:#fff;--muted:#64748b}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#0f172a}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:12px 14px;font-weight:800;box-shadow:0 8px 20px #0002}
    main{display:grid;grid-template-columns:1fr;gap:14px;padding:14px}
    @media(min-width:1100px){main{grid-template-columns:380px 1fr}}
    .card{background:var(--card);border:1px solid #e6efe9;border-radius:14px;padding:12px;box-shadow:0 10px 22px #0000000d}
    h2{font-size:16px;margin:0 0 10px} label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px;border:1px solid #dbe7e1;border-radius:10px;margin:6px 0 10px;background:#fbfefd}
    button{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;border:none;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .ghost{background:#f0f7f3;color:#0b3d2a}.row{display:flex;gap:8px;align-items:center}.row>*{flex:1}
    .mini{font-size:12px;color:#64748b}.list{display:grid;gap:10px}.pill{display:inline-flex;gap:6px;align-items:center;background:#e9f5ef;border:1px solid #cfe9dc;padding:5px 8px;border-radius:999px;font-size:12px;margin:2px 6px 0 0}
    pre{background:#0b3d2a;color:#eafff2;padding:10px;border-radius:10px;overflow:auto;max-height:40vh}
    .warn{padding:10px;border:1px solid #fca5a5;background:#fee2e2;color:#7f1d1d;border-radius:10px}
  </style>
</head>
<body>
  <header>LeaderMath — Admin (Firebase)</header>
  <main>
    <section class="card" id="authCard">
      <h2>Kirish</h2>
      <div class="mini">Admin paneldan foydalanish uchun <b>Google bilan kirish</b> va <b>admin</b> roliga ega bo‘lishingiz kerak.</div>
      <div class="row">
        <button id="signin">Google bilan kirish</button>
        <button class="ghost" id="signout" style="display:none">Chiqish</button>
      </div>
      <div id="who" class="mini"></div>
      <div id="guard" class="warn" style="display:none">Admin emas: bu sahifada saqlash huquqi cheklangan. Iltimos, Firestore’da <code>users/{uid}.role = "admin"</code> qilib belgilang.</div>
    </section>

    <section class="card">
      <h2>JSON yuklash/saqlash</h2>
      <div class="row">
        <input type="file" id="file" accept="application/json">
        <button class="ghost" id="new">Yangi JSON</button>
        <button id="download">index.json yuklab olish</button>
        <button id="save">Firestore'ga saqlash</button>
      </div>
      <div class="mini">Maslahat: avval mavjud Firestore kontentini yuklab oling (o‘ngdagi “Yuklash” tugmasi) va tahrir qiling.</div>
    </section>

    <section class="card">
      <h2>Banner qo‘shish</h2>
      <input id="bnTitle" placeholder="Sarlavha">
      <input id="bnImg" placeholder="Rasm URL (./img/banner-1.jpg)">
      <input id="bnLink" placeholder="Link (https://...)">
      <div class="row"><button id="addBanner">Qo‘shish</button><button class="ghost" id="clearBanner">Tozalash</button></div>
    </section>

    <section class="card">
      <h2>Bo‘lim (chorak) qo‘shish</h2>
      <input id="sectName" placeholder="1-chorak BSBlar">
      <div class="row"><button id="addSection">Qo‘shish</button><button class="ghost" id="clearSection">Tozalash</button></div>
    </section>

    <section class="card">
      <h2>Karta qo‘shish</h2>
      <label>Bo‘lim</label><select id="selSection"></select>
      <input id="itName" placeholder="BSB 1.1 — Natural sonlar">
      <textarea id="itDesc" rows="2" placeholder="Tavsif"></textarea>
      <input id="itImg" placeholder="Rasm (URL)">
      <input id="itLink" placeholder="Boshlash linki">
      <input id="itMore" placeholder="Batafsil (ixtiyoriy)">
      <input id="itTags" placeholder="Teglar: BSB, 1-chorak">
      <div class="row"><select id="itBest"><option value="false">Oddiy</option><option value="true">BEST</option></select><button id="addItem">Qo‘shish</button><button class="ghost" id="clearItem">Tozalash</button></div>
    </section>

    <section class="card">
      <h2>Joriy JSON</h2>
      <pre id="out"></pre>
      <div id="summary" class="mini"></div>
    </section>

    <section class="card">
      <h2>Firestore' dan yuklash (real-time)</h2>
      <div class="row"><button id="pull">Yuklash</button><button class="ghost" id="stop">To‘xtatish</button></div>
      <div class="mini">Real-time listener yoqilganda o‘zgarishlar avtomatik kelyapti.</div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, runTransaction } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const cfg = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.firebasestorage.app",
      messagingSenderId: "992512966017",
      appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId: "G-459PLJ7P7L"
    };
    const app = initializeApp(cfg);
    const auth = getAuth(app);
    const db = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence);

    const el={
      signin:document.getElementById('signin'), signout:document.getElementById('signout'), who:document.getElementById('who'), guard:document.getElementById('guard'),
      file:document.getElementById('file'), newBtn:document.getElementById('new'), download:document.getElementById('download'), save:document.getElementById('save'),
      out:document.getElementById('out'), summary:document.getElementById('summary'),
      bnTitle:bnTitle, bnImg:bnImg, bnLink:bnLink, addBanner:addBanner, clearBanner:clearBanner,
      sectName:sectName, addSection:addSection, clearSection:clearSection,
      selSection:selSection, itName:itName, itDesc:itDesc, itImg:itImg, itLink:itLink, itMore:itMore, itTags:itTags, itBest:itBest, addItem:addItem, clearItem:clearItem,
      pull:document.getElementById('pull'), stop:document.getElementById('stop')
    };

    let data={banners:[],sections:[]};
    let unsub=null;
    let isAdmin=false;

    async function ensureUser(u){
      const ref=doc(db,'users',u.uid);
      await runTransaction(db, async(tx)=>{
        const snap=await tx.get(ref);
        if(!snap.exists()) tx.set(ref,{name:u.displayName||'Foydalanuvchi', email:u.email||null, photoURL:u.photoURL||null, role:'user', numericId:Math.floor(1000+Math.random()*9000), points:0, createdAt:Date.now()});
      });
      const docSnap=await getDoc(ref); return docSnap.data();
    }

    function refreshUI(){
      el.out.textContent = JSON.stringify(data,null,2);
      el.summary.textContent = `Bannerlar: ${data.banners.length} ta • Bo‘limlar: ${data.sections.length} ta`;
      el.selSection.innerHTML = (data.sections||[]).map((s,i)=>`<option value="${i}">${s.title}</option>`).join('');
    }

    el.signin.onclick = async()=>{ try{ await signInWithPopup(auth, new GoogleAuthProvider()); }catch(e){ alert(e.message); } };
    el.signout.onclick = async()=>{ await signOut(auth); };

    onAuthStateChanged(auth, async(user)=>{
      if(!user){ el.who.textContent='Mehmon'; el.signout.style.display='none'; el.guard.style.display='block'; return; }
      el.signout.style.display='inline-block';
      const u = await ensureUser(user);
      el.who.textContent = `Kirdingiz: ${u.name||user.displayName} (${user.email||''})  • role=${u.role}`;
      isAdmin = (u.role==='admin');
      el.guard.style.display = isAdmin ? 'none' : 'block';
    });

    // File upload
    el.file.onchange = async e=>{
      const f=e.target.files?.[0]; if(!f) return;
      try{ data = JSON.parse(await f.text()); if(!data.banners)data.banners=[]; if(!data.sections)data.sections=[]; refreshUI(); }
      catch(err){ alert('JSON xato: '+err.message); }
    };
    el.newBtn.onclick = ()=>{ data={banners:[],sections:[]}; refreshUI(); };

    // Add banner/section/item
    el.addBanner.onclick = ()=>{ data.banners.push({title:el.bnTitle.value.trim(), image:el.bnImg.value.trim(), link:el.bnLink.value.trim()}); el.bnTitle.value=el.bnImg.value=el.bnLink.value=''; refreshUI(); };
    el.clearBanner.onclick = ()=>{ el.bnTitle.value=el.bnImg.value=el.bnLink.value=''; };
    el.addSection.onclick = ()=>{ const t=el.sectName.value.trim(); if(!t)return alert('Bo‘lim nomi kerak'); data.sections.push({title:t,items:[]}); el.sectName.value=''; refreshUI(); };
    el.clearSection.onclick = ()=>{ el.sectName.value=''; };
    el.addItem.onclick = ()=>{
      const si=+el.selSection.value; if(Number.isNaN(si)) return alert('Avval bo‘lim qo‘shing');
      const item={ name:el.itName.value.trim(), description:el.itDesc.value.trim(), image:el.itImg.value.trim(), link:el.itLink.value.trim(), more:el.itMore.value.trim()||undefined, tags:el.itTags.value.split(',').map(s=>s.trim()).filter(Boolean), best:el.itBest.value==='true' };
      if(!item.name||!item.link) return alert('Nomi va link shart'); data.sections[si].items.push(item);
      ['itName','itDesc','itImg','itLink','itMore','itTags'].forEach(id=>el[id].value=''); el.itBest.value='false'; refreshUI();
    };
    el.clearItem.onclick = ()=>{ ['itName','itDesc','itImg','itLink','itMore','itTags'].forEach(id=>el[id].value=''); el.itBest.value='false'; };

    // Export/download
    el.download.onclick = ()=>{ const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='index.json'; a.click(); URL.revokeObjectURL(a.href); };

    // Save to Firestore (role-guard)
    el.save.onclick = async()=>{
      if(!auth.currentUser) return alert('Avval kirish qiling');
      if(!isAdmin) return alert('Admin ruxsati kerak');
      await setDoc(doc(db,'content','index'), data, {merge:false});
      alert('Firestorega saqlandi ✅');
    };

    // Realtime pull
    el.pull.onclick = async()=>{
      if(unsub) unsub();
      unsub = onSnapshot(doc(db,'content','index'), (snap)=>{
        if(snap.exists()){
          data = snap.data();
          refreshUI();
        }
      }, (err)=> alert('Listener xato: '+err.message));
    };
    el.stop.onclick = ()=>{ if(unsub){ unsub(); unsub=null; alert('Listener to‘xtatildi'); } };

    // Init
    refreshUI();
  </script>
</body>
</html>
