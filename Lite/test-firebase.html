<!doctype html>
<html lang="uz"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MathCenter — Test (Firebase autosave)</title><meta name="color-scheme" content="dark"/>
<link rel="stylesheet" href="assets/styles.css"/>

  <script>
    window.MathJax = { tex: {inlineMath: [['$','$'], ['\\(','\\)']]}, svg: {fontCache: 'global'} };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { firebaseConfig } from "./config.js";
    const app = initializeApp(firebaseConfig);
    window._db = getFirestore(app);
  </script>

</head><body>
<header class="nav">
  <div class="container stack">
    <div class="brand"><div class="pi">π</div><div>Test</div></div>
    <div class="spacer"></div>
    <div class="hint timer" id="timer">00:00</div>
    <button class="btn ghost" onclick="location.href='liteindex.html'">Bosh sahifa</button>
  </div>
</header>

<main class="container" style="display:grid;gap:16px;margin-top:16px">
  <div class="layout">
    <aside class="side">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <b>Savollar</b><div class="spacer"></div><span class="hint" id="progress">0/0</span>
      </div>
      <div id="numgrid" class="numgrid"></div>
    </aside>
    <section>
      <div id="info" class="card" style="padding:16px"></div>
      <form id="paper"></form>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn ghost" type="button" id="prevBtn">Oldingi</button>
        <button class="btn" type="button" id="nextBtn">Keyingi</button>
        <div class="spacer"></div>
        <button class="btn" id="btnSubmit" type="button">Topshirish</button>
        
      </div>
      <div id="resultBox" class="hint" style="margin-top:8px"></div>
    </section>
  </div>
</main>

<script type="module">
const params = new URLSearchParams(location.search);
const testId = params.get('id');
const $ = s=>document.querySelector(s);
const state = {{ me:null, test:null, seconds:0, current:0, answers:{} }};

function getSession(){{ try{{return JSON.parse(localStorage.getItem('lite.me'));}}catch{{return null;}} }}
async function loadJSON(p){{ const r=await fetch(p+'?_='+Date.now()); if(!r.ok) throw new Error(p+' yuklanmadi'); return r.json(); }}

function formatTime(s){{ const m=Math.floor(s/60).toString().padStart(2,'0'); const ss=(s%60).toString().padStart(2,'0'); return m+':'+ss; }}
function startTimer(sec){{ state.seconds=sec; document.getElementById('timer').textContent = formatTime(state.seconds); const iv=setInterval(()=>{{ state.seconds--; document.getElementById('timer').textContent = formatTime(Math.max(0,state.seconds)); if(state.seconds<=0){{ clearInterval(iv); grade(); }} }},1000); }}

function renderNavigator(){{ const ng = document.getElementById('numgrid'); ng.innerHTML=''; state.test.questions.forEach((q,i)=>{{ const b=document.createElement('button'); b.type='button'; b.className='num'+(i===state.current?' active':'') + (state.answers[i]!=null?' answered':''); b.textContent=(i+1); b.onclick=()=>{{ state.current=i; renderQuestion(); renderNavigator(); }}; ng.appendChild(b); }}); const answered = Object.keys(state.answers).length; document.getElementById('progress').textContent = answered + '/' + state.test.questions.length; }}

function renderQuestion(){{ const t=state.test, i=state.current, q=t.questions[i]; const form=document.getElementById('paper'); form.innerHTML=''; const div=document.createElement('div'); div.className='q'; const opts = q.options.map((op,oi)=>{{ const checked = state.answers[i]===oi ? 'checked' : ''; return `<label style="display:block;margin-top:6px"><input type="radio" name="q" value="${{oi}}" ${{checked}}> ${{String.fromCharCode(65+oi)}}) ${{op}}</label>`; }}).join(''); div.innerHTML = `<div style="margin-bottom:8px"><b>${{i+1}}.</b> <span class="mj">${{q.text}}</span></div><div>${{opts}}</div>`; form.appendChild(div); if(window.MathJax && window.MathJax.typesetPromise){{ MathJax.typesetPromise([div]); }} form.onchange = ()=>{{ const v = Number((form.querySelector('input[name="q"]:checked')||{{}}).value); if(!Number.isNaN(v)){{ state.answers[i]=v; renderNavigator(); }} }}; }}

function next(){{ if(state.current < state.test.questions.length-1){{ state.current++; renderQuestion(); renderNavigator(); }} }}
function prev(){{ if(state.current > 0){{ state.current--; renderQuestion(); renderNavigator(); }} }}

async function grade(){{ const t=state.test; let score=0; let max=0; t.questions.forEach((q,qi)=>{{ max += Number(q.points)||t.perQuestionDefault||1; if(state.answers[qi]===q.answerIndex) score += Number(q.points)||t.perQuestionDefault||1; }}); document.getElementById('resultBox').innerHTML = `<b>Natija:</b> ${score} / ${max}`;
  try { const me = state.me || {}; await addDoc(collection(window._db,'results'), { login: me.login||'unknown', name:(me.name||'')+' '+(me.surname||''), class: me.class||'', testId: t.id, score, maxScore: max, when: serverTimestamp() }); document.getElementById('resultBox').innerHTML += ' — <b>Saqlash: OK</b>'; } catch(e){ document.getElementById('resultBox').innerHTML += ' — Saqlash xatosi'; console.error(e);} }}

document.getElementById('nextBtn').onclick = next;
document.getElementById('prevBtn').onclick = prev;
document.getElementById('btnSubmit').onclick = grade;

(async function init(){{ state.me = getSession(); if(!state.me){{ alert('Avval kirish qiling.'); location.href='liteindex.html'; return; }} const all = await loadJSON('test.json'); const t=(all.tests||[]).find(x=>x.id===testId); if(!t){{ alert('Test topilmadi.'); location.href='liteindex.html'; return; }} state.test=t; document.getElementById('info').innerHTML = `<h3 style="margin:0">${{t.title}}</h3><div class="hint">${{t.description||''}}</div>`; renderNavigator(); renderQuestion(); startTimer(t.durationSec||600); } )();
</script>
</body></html>
