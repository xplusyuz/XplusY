<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MathCenter — Test (Firebase autosave)</title>
  <meta name="color-scheme" content="light"/>
  <style>
:root{--green:#2E8B57;--green-700:#1F6B45;--bg:#f7faf8;--text:#1a1f1c;--muted:#6b7280;--card:#fff;--shadow:0 8px 24px rgba(0,0,0,.08);--radius:18px}
*{box-sizing:border-box} html,body{margin:0;height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
.container{max-width:1100px;margin:0 auto;padding:16px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow)}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;background:var(--green);color:#fff;border:0;cursor:pointer;font-weight:600}
.btn.ghost{background:#e9f5ef;color:var(--green)}
header.nav{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #eee}
.brand{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--green)}
.brand .pi{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--green),var(--green-700));display:grid;place-items:center;color:#fff;box-shadow:var(--shadow)}
.stack{display:flex;align-items:center;gap:10px}.spacer{flex:1}
label{font-size:13px;color:var(--muted)}
input,select,textarea{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;outline:0}
.hint{font-size:12px;color:var(--muted)}
.table{width:100%;border-collapse:separate;border-spacing:0 10px}
.table th,.table td{text-align:left;padding:10px 12px;vertical-align:middle;background:#fff}
.table tr td:first-child,.table tr th:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
.table tr td:last-child,.table tr th:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}

  .layout{display:grid;grid-template-columns:220px 1fr;gap:16px}
  @media (max-width:900px){ .layout{grid-template-columns:1fr} }
  .side{background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:12px;position:sticky;top:72px;height:max-content}
  .numgrid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
  .num{display:grid;place-items:center;height:40px;border-radius:12px;border:1px solid #e5e7eb;background:#f9fafb;cursor:pointer;font-weight:600}
  .num.active{background:#e9f5ef;border-color:#b7e2c7;color:var(--green)}
  .num.answered{outline:2px solid var(--green)}
  .q{background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:16px}
  </style>
  <script>
    window.MathJax = { tex: {inlineMath: [['$','$'], ['\\(','\\)']]}, svg: {fontCache: 'global'} };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    const firebaseConfig = {
      apiKey:"AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain:"xplusy-760fa.firebaseapp.com",
      projectId:"xplusy-760fa",
    };
    window._app = initializeApp(firebaseConfig);
    window._db = getFirestore(_app);
  </script>
</head>

<body>
<header class="nav">
  <div class="container stack">
    <div class="brand"><div class="pi">π</div><div>Test</div></div>
    <div class="spacer"></div>
    <div class="hint" id="timer">00:00</div>
    <button class="btn ghost" onclick="location.href='liteindex.html'">Bosh sahifa</button>
  </div>
</header>

<main class="container" style="display:grid;gap:16px;margin-top:16px">
  <div class="layout">
    <aside class="side">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <b>Savollar</b><div class="spacer"></div><span class="hint" id="progress">0/0</span>
      </div>
      <div id="numgrid" class="numgrid"></div>
    </aside>
    <section>
      <div id="info" class="card" style="padding:16px"></div>
      <form id="paper"></form>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn ghost" type="button" id="prevBtn">Oldingi</button>
        <button class="btn" type="button" id="nextBtn">Keyingi</button>
        <div class="spacer"></div>
        <button class="btn" id="btnSubmit" type="button">Topshirish</button>
        
      </div>
      <div id="resultBox" class="hint" style="margin-top:8px"></div>
    </section>
  </div>
</main>

<script>
const params = new URLSearchParams(location.search);
const testId = params.get('id');
const $ = s=>document.querySelector(s);
const state = { me:null, test:null, seconds:0, current:0, answers:{} };

function getSession(){ try{return JSON.parse(localStorage.getItem('lite.me'));}catch{return null;} }
async function loadJSON(p){ const r=await fetch(p+'?_='+Date.now()); if(!r.ok) throw new Error(p+' yuklanmadi'); return r.json(); }

function formatTime(s){ const m=Math.floor(s/60).toString().padStart(2,'0'); const ss=(s%60).toString().padStart(2,'0'); return m+':'+ss; }
function startTimer(sec){ state.seconds=sec; $('#timer').textContent = formatTime(state.seconds); const iv=setInterval(()=>{ state.seconds--; $('#timer').textContent = formatTime(Math.max(0,state.seconds)); if(state.seconds<=0){ clearInterval(iv); grade(); } },1000); }

function renderNavigator(){
  const ng = $('#numgrid'); ng.innerHTML='';
  state.test.questions.forEach((q,i)=>{
    const b = document.createElement('button');
    b.type='button'; b.className='num'+(i===state.current?' active':'') + (state.answers[i]!=null?' answered':'');
    b.textContent = (i+1);
    b.onclick = ()=>{ state.current=i; renderQuestion(); renderNavigator(); };
    ng.appendChild(b);
  });
  const answered = Object.keys(state.answers).length;
  $('#progress').textContent = answered + '/' + state.test.questions.length;
}

function renderQuestion(){
  const t = state.test, i = state.current, q = t.questions[i];
  const form = $('#paper'); form.innerHTML='';
  const div = document.createElement('div'); div.className='q';
  const opts = q.options.map((op,oi)=>{
    const checked = state.answers[i]===oi ? 'checked' : '';
    return `<label style="display:block;margin-top:6px"><input type="radio" name="q" value="${oi}" ${checked}> ${String.fromCharCode(65+oi)}) ${op}</label>`;
  }).join('');
  div.innerHTML = `<div style="margin-bottom:8px"><b>${i+1}.</b> <span class="mj">${q.text}</span></div><div>${opts}</div>`;
  form.appendChild(div);
  if(window.MathJax && window.MathJax.typesetPromise){ MathJax.typesetPromise([div]); }
  form.onchange = (e)=>{
    const v = Number((form.querySelector('input[name="q"]:checked')||{}).value);
    if(!Number.isNaN(v)){ state.answers[i]=v; renderNavigator(); }
  };
}

function next(){ if(state.current < state.test.questions.length-1){ state.current++; renderQuestion(); renderNavigator(); } }
function prev(){ if(state.current > 0){ state.current--; renderQuestion(); renderNavigator(); } }

async function grade(){
  const t=state.test; let score=0; let max=0;
  t.questions.forEach((q,qi)=>{ max += Number(q.points)||t.perQuestionDefault||1; if(state.answers[qi]===q.answerIndex) score += Number(q.points)||t.perQuestionDefault||1; });
  $('#resultBox').innerHTML = `<b>Natija:</b> ${score} / ${max}`;
  try{
    const me = state.me || {};
    const t = state.test;
    await addDoc(collection(window._db,"results"), {
      login: me.login||"unknown",
      name: (me.name||"")+" "+(me.surname||""),
      class: me.class||"",
      testId: t.id,
      score: score,
      maxScore: max,
      when: serverTimestamp()
    });
    $('#resultBox').innerHTML += " — <b>Saqlash: OK</b>";
  }catch(e){
    $('#resultBox').innerHTML += " — Saqlash xatosi";
    console.error(e);
  }
  const now = new Date().toISOString();
  state.lastResult = {login: state.me?.login||'unknown', testId: t.id, score, maxScore: max, when: now};
}

document.getElementById('nextBtn').onclick = next;
document.getElementById('prevBtn').onclick = prev;
document.getElementById('btnSubmit').onclick = grade;

document.getElementById('btnExport').onclick = async ()=>{
  try{
    const current = await loadJSON('ball.json');
    (current.results ||= []).push(state.lastResult);
    const blob = new Blob([JSON.stringify(current,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ball.json'; a.click(); URL.revokeObjectURL(a.href);
  }catch(e){
    const data = {results:[state.lastResult]};
    const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='ball.json'; a.click(); URL.revokeObjectURL(a.href);
  }
};

(async function init(){
  state.me = getSession();
  if(!state.me){ alert('Avval kirish qiling.'); location.href='liteindex.html'; return; }
  const all = await loadJSON('test.json');
  const t = (all.tests||[]).find(x=>x.id===testId);
  if(!t){ alert('Test topilmadi.'); location.href='liteindex.html'; return; }
  state.test = t;
  $('#info').innerHTML = `<h3 style="margin:0">${t.title}</h3><div class="hint">${t.description||''}</div>`;
  renderNavigator(); renderQuestion(); startTimer(t.durationSec||600);
})();
</script>
</body>
</html>
