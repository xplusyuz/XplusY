<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MathCenter — Test</title>
  <link rel="stylesheet" href="css/style.css"/>
  <script>
  window.MathJax = { tex: { inlineMath: [['\\(','\\)'], ['$', '$']] }, svg: { fontCache: 'global' } };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>

  <script>
    // Renderer switch via query param: ?renderer=katex
    (function(){
      const q = new URLSearchParams(location.search);
      const r = (q.get('renderer')||'mathjax').toLowerCase();
      if(r==='katex'){
        window.USE_KATEX = true;
        var l1 = document.createElement('link'); l1.rel='stylesheet'; l1.href='https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css'; document.head.appendChild(l1);
        var s1 = document.createElement('script'); s1.defer=true; s1.src='https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js'; document.head.appendChild(s1);
        var s2 = document.createElement('script'); s2.defer=true; s2.src='https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js'; s2.onload=function(){ renderMathInElement(document.body,{delimiters:[{left:"$", right:"$", display:false},{left:"$$", right:"$$", display:true},{left:"\\(",right:"\\)",display:false}]}); }; document.head.appendChild(s2);
      } else {
        window.MathJax = { tex: { inlineMath: [['\\(','\\)'], ['$', '$']] }, svg: { fontCache: 'global' } };
        var s = document.createElement('script'); s.defer=true; s.src='https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'; document.head.appendChild(s);
      }
    })();
  </script>
</head>
<body>
  <div id="header"></div>
  <main class="container">
    <div id="testWrap"></div>
  </main>
  <footer class="footer">© 2025 MathCenter</footer>

  <script type="module">
    import { db, ready } from './js/firebase-init.js';
    import { doc, getDoc, setDoc, runTransaction, serverTimestamp, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    {header_component}
    document.getElementById('header').innerHTML = renderHeader();
    bindLogout();
    fillPoints(db);

    const u = JSON.parse(localStorage.getItem('mc_user')||'null');
    if (!u) { alert('Test yechish uchun tizimga kiring'); location.href='login.html'; }

    async function loadJSON(path) {
      const res = await fetch(path);
      if (!res.ok) throw new Error('JSON yuklab bo\'lmadi: '+path);
      return res.json();
    }

    const params = new URLSearchParams(location.search);
    const id = params.get('id');

    (async () => {
      const tests = await loadJSON('assets/tests.json');
      const test = tests.find(t => t.id === id) || tests[0];
      if (!test) return document.getElementById('testWrap').innerHTML = '<p>Test topilmadi</p>';

      const total = (test.questions||[]).reduce((a,q)=>a+(q.points||1),0);
      const form = document.createElement('form');
      form.innerHTML = `
        <div class="card"><div class="content">
          <h2>${test.title}</h2>
          <p class="muted">${test.description||''}</p>
          <p class="muted">Jami ball: ${total}</p>
        </div></div>
        ${(test.questions||[]).map((q,qi)=>`
          <div class="card"><div class="content">
            <div class="muted">Ball: ${q.points||1}</div>
            <h3>${qi+1}. ${q.text}</h3>
            <div style="display:grid; gap:8px;">
              ${(q.options||[]).map((o,oi)=>`
                <label style="display:flex; gap:8px; align-items:center;">
                  <input type="${q.type==='multi'?'checkbox':'radio'}" name="q${qi}" value="${oi}"/>
                  <span>${o.text}</span>
                </label>
              `).join('')}
            </div>
          </div></div>
        `).join('')}
        <button class="btn btn-primary" type="submit">Yakunlash</button>
      `;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        let score = 0;
        (test.questions||[]).forEach((q,qi) => {
          const inputs = Array.from(form.querySelectorAll(`[name="q${qi}"]`));
          const chosen = inputs.filter(x => x.checked).map(x => +x.value);
          const correctIdx = (q.options||[]).map((o,i)=>o.correct?i:null).filter(i=>i!==null);
          const isCorrect = chosen.length === correctIdx.length && chosen.every(x => correctIdx.includes(x));
          if (isCorrect) score += (q.points || 1);
        });

        const scoreDoc = {
          userId: u.numericId ?? u.id ?? u.login,
          name: u.name, class: u.class || '',
          testId: test.id, testTitle: test.title, score, total,
          createdAt: serverTimestamp()
        };
        await addDoc(collection(db, 'scores'), scoreDoc);

        await runTransaction(db, async (tx) => {
          const ref = doc(db, 'user_points', String(scoreDoc.userId));
          const snap = await tx.get(ref);
          const prev = snap.exists() ? snap.data() : { totalPoints: 0, name: u.name, class: u.class || '' };
          tx.set(ref, { ...prev, totalPoints: (prev.totalPoints||0) + score, updatedAt: serverTimestamp(), numericId: scoreDoc.userId }, { merge: true });
        });

        alert(`Tabriklaymiz! Sizning balingiz: ${score} / ${total}`);
        location.href = 'rating.html';
      });

      
      // After render, typeset renderer
      if (window.USE_KATEX && window.renderMathInElement) {
        window.renderMathInElement(document.body,{delimiters:[{left:'$',right:'$',display:false},{left:'$$',right:'$$',display:true},{left:'\\(',right:'\\)',display:false}]});
      } else if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise();
      }
      if (window.MathJax && window.MathJax.typesetPromise) {
        window.MathJax.typesetPromise();
      }

      document.getElementById('testWrap').appendChild(form);

      // Timer (durationSeconds) with persistence
      let remaining = Number(test.durationSeconds||0);
      let timerEl = null;
      // Persisted start
      const key = 'testStart:'+test.id+':'+(u.numericId ?? u.id ?? u.login);
      if (remaining > 0) {
        const now = Date.now();
        let startedAt = Number(sessionStorage.getItem(key) || 0);
        if (!startedAt) { startedAt = now; sessionStorage.setItem(key, String(startedAt)); }
        const elapsed = Math.floor((now - startedAt)/1000);
        remaining = Math.max(0, remaining - elapsed);

        const headerCard = document.createElement('div');
        headerCard.className = 'card';
        headerCard.innerHTML = `<div class="content"><strong>Timer:</strong> <span id="timerBox"></span></div>`;
        document.getElementById('testWrap').appendChild(headerCard);
        timerEl = headerCard.querySelector('#timerBox');

        const tick = () => {
          const now2 = Date.now();
          const elapsed2 = Math.floor((now2 - startedAt)/1000);
          remaining = Math.max(0, Number(test.durationSeconds||0) - elapsed2);
          const m = Math.floor(remaining/60);
          const s = remaining%60;
          if (timerEl) timerEl.textContent = `${m}:${String(s).padStart(2,'0')}`;
          if (remaining <= 0) { sessionStorage.removeItem(key); form.requestSubmit(); return; }
          setTimeout(tick, 1000);
        };
        document.addEventListener('visibilitychange', () => { /* no pause */ }, {passive:true});
        tick();
      }
      let remaining = Number(test.durationSeconds||0);
      let timerEl = null;
      if (remaining > 0) {
        const headerCard = document.createElement('div');
        headerCard.className = 'card';
        headerCard.innerHTML = `<div class="content"><strong>Timer:</strong> <span id="timerBox"></span></div>`;
        document.getElementById('testWrap').appendChild(headerCard);
        timerEl = headerCard.querySelector('#timerBox');
        const tick = () => {
          const m = Math.floor(remaining/60);
          const s = remaining%60;
          if (timerEl) timerEl.textContent = `${m}:${String(s).padStart(2,'0')}`;
          if (remaining <= 0) { form.requestSubmit(); return; }
          remaining -= 1;
          setTimeout(tick, 1000);
        };
        tick();
      }

    })();
  </script>
</body>
</html>
