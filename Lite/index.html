<!doctype html>
<html lang="uz" class="no-js">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>LeaderMath ‚Äî Mobil (PWA)</title>
  <meta name="theme-color" content="#2E8B57"/>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./icons/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="./icons/icon-512.png">
  <style>
    :root{
      --brand:#2E8B57;--brand2:#1F6B45;--bg:#f7f9f8;--text:#0f172a;--muted:#64748b;--card:#ffffff;--chip:#e9f5ef;--chip-b:#cfe9dc;--radius:18px;
    }
    .dark:root{ --bg:#0b1210; --text:#e9f6ef; --muted:#9fb7ab; --card:#0f1815; --chip:#0f2a20; --chip-b:#214a39; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .appbar{position:sticky;top:0;z-index:60;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:10px 12px;display:flex;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
    .logo{width:40px;height:40px;border-radius:14px;background:#fff2;display:grid;place-items:center;font-weight:800}
    .title{font-weight:800;font-size:18px;letter-spacing:.3px}
    .sub{font-size:11px;opacity:.9}
    .spacer{flex:1}
    .iconbtn{background:#ffffff22;border:none;color:#fff;border-radius:12px;padding:8px 10px;font-weight:700}

    /* Header (Firebase) */
    .userbar{background:var(--card);border:1px solid #e5eee9;border-radius:14px;margin:10px 12px;padding:10px;display:flex;align-items:center;gap:10px;box-shadow:0 8px 20px #0001}
    .dark .userbar{border-color:#15352a}
    .ava{width:40px;height:40px;border-radius:50%;background:#d7efe3;display:grid;place-items:center;color:#0b3d2a;font-weight:800}
    .uinfo{line-height:1.2}
    .uinfo b{display:block}
    .uvals{margin-left:auto;text-align:right;font-size:12px}
    .link{color:#0b3d2a}

    .container{padding:6px 12px 88px}

    /* Filter chips */
    .chips{position:sticky;top:62px;z-index:50;background:var(--bg);padding:8px 0 6px;display:flex;gap:8px;overflow:auto}
    .chip{white-space:nowrap; font-size:12px;color:#0b3d2a;background:var(--chip);border:1px solid var(--chip-b);padding:7px 10px;border-radius:999px}
    .chip.active{outline:2px solid var(--brand);}
    .dark .chip{color:#cfe9dc}

    /* Carousel */
    .carousel{position:relative;overflow:hidden;border-radius:var(--radius);}
    .track{display:flex;transition:transform .45s cubic-bezier(.2,.8,.2,1)}
    .slide{min-width:100%;aspect-ratio:16/9;position:relative}
    .slide img{width:100%;height:100%;object-fit:cover;display:block}
    .dots{position:absolute;inset:auto 0 8px;display:flex;justify-content:center;gap:6px}
    .dot{width:8px;height:8px;border-radius:10px;background:#fff8;backdrop-filter:blur(2px)}
    .dot.active{width:18px;background:#fff}
    .cbtn{position:absolute;top:50%;transform:translateY(-50%);background:#0007;color:#fff;border:none;width:38px;height:38px;border-radius:12px;display:grid;place-items:center}
    .cbtn.left{left:8px} .cbtn.right{right:8px}

    /* Sections + cards */
    .sect{margin-top:16px}
    .sect h2{margin:10px 2px 10px;font-size:17px;font-weight:800;color:var(--brand2)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:480px){.grid{grid-template-columns:1fr 1fr}}
    @media (min-width:768px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card);border-radius:16px;overflow:hidden;box-shadow:0 10px 24px rgba(0,0,0,.06);border:1px solid #e5eee9}
    .dark .card{border-color:#15352a}
    .thumb{aspect-ratio:16/9;background:#e6efe9;position:relative}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .badge{position:absolute;top:8px;left:8px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .body{padding:12px}
    .name{font-size:15px;font-weight:800;margin:0 0 6px}
    .desc{font-size:13px;color:var(--muted);line-height:1.4;margin:0 0 10px}
    .tags{display:flex;flex-wrap:wrap;gap:6px;margin:0 0 10px}
    .tag{font-size:11px;color:#0b3d2a;background:#e9f5ef;border:1px solid #cfe9dc;padding:5px 8px;border-radius:999px}
    .actions{display:flex;gap:8px}
    .btn{flex:1;display:inline-flex;align-items:center;justify-content:center;gap:8px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;border:none;border-radius:12px;padding:12px 14px;font-weight:800;font-size:14px}
    .btn.ghost{background:#f0f7f3;color:#0b3d2a}
    .ptr{font-size:12px;color:#8aa79b;text-align:center;margin:8px 0}
  </style>
</head>
<body>
  <!-- Top appbar -->
  <header class="appbar">
    <div class="logo">L</div>
    <div>
      <div class="title">LeaderMath</div>
      <div class="sub">BSB / CHSB dars resurslari</div>
    </div>
    <div class="spacer"></div>
    <button id="themeBtn" class="iconbtn" title="Dark/Light">üåô</button>
    <button id="installBtn" class="iconbtn" title="Ilova sifatida o‚Äòrnatish">‚¨áÔ∏è</button>
  </header>

  <!-- Firebase user header -->
  <section class="userbar" id="userbar">
    <div class="ava" id="ava">LM</div>
    <div class="uinfo">
      <b id="uname">Mehmon</b>
      <span class="sub" id="uid">ID: ‚Äî</span>
    </div>
    <div class="uvals">
      <div><b id="points">Ball: ‚Äî</b></div>
      <div><a href="#" id="signin" class="link">Kirish</a> ¬∑ <a href="#" id="signout" class="link" style="display:none">Chiqish</a></div>
    </div>
  </section>

  <div class="container">
    <!-- Filter chips -->
    <div class="chips" id="chips"></div>

    <!-- Banner Carousel -->
    <section class="carousel" id="carousel">
      <button class="cbtn left" aria-label="Oldingi" id="prev">‚Äπ</button>
      <div class="track" id="track"></div>
      <button class="cbtn right" aria-label="Keyingi" id="next">‚Ä∫</button>
      <div class="dots" id="dots"></div>
    </section>

    <div class="ptr">Pastga aylantiring ‚Äî bo‚Äòlimlar</div>

    <!-- Bo‚Äòlimlar (choraklar va tur) -->
    <div id="sections"></div>

    <div style="height:24px"></div>
  </div>

  <script type="module">
    // ===== DARK MODE =====
    const root = document.documentElement;
    const themeBtn = document.getElementById('themeBtn');
    const THEME_KEY = 'lm-theme';
    const setTheme = (m)=>{ root.classList.toggle('dark', m==='dark'); localStorage.setItem(THEME_KEY,m); themeBtn.textContent = m==='dark'?'‚òÄÔ∏è':'üåô'; };
    setTheme(localStorage.getItem(THEME_KEY) || (matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
    themeBtn.onclick = ()=> setTheme(root.classList.contains('dark')?'light':'dark');

    // ===== PWA install =====
    let deferredPrompt; const installBtn = document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; installBtn.style.display='inline-block'; });
    installBtn.onclick = async()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.style.display='none'; };
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('./service-worker.js'); }

    // ===== DATA LOAD =====
    async function loadData(){
      const res = await fetch('index.json', {cache:'no-store'});
      if(!res.ok) throw new Error('index.json topilmadi yoki xato');
      return res.json();
    }

    // ===== CAROUSEL =====
    function initCarousel(banners){
      const track = document.getElementById('track');
      const dots = document.getElementById('dots');
      const prev = document.getElementById('prev');
      const next = document.getElementById('next');
      if(!banners?.length){ document.getElementById('carousel').style.display='none'; return; }
      track.innerHTML = banners.map(b=>`<a class="slide" href="${b.link||'#'}" target="_blank" rel="noopener"><img src="${b.image}" alt="${b.title||'Banner'}"/></a>`).join('');
      dots.innerHTML = banners.map((_,i)=>`<div class="dot${i===0?' active':''}"></div>`).join('');
      let i=0, n=banners.length, x=0, sx=0, dragging=false, auto;
      const set = (idx)=>{ i=(idx+n)%n; track.style.transform = `translateX(-${i*100}%)`; [...dots.children].forEach((d,k)=>d.classList.toggle('active',k===i)); }
      const play = ()=>{ clearInterval(auto); auto=setInterval(()=>set(i+1), 3500); }
      const stop = ()=> clearInterval(auto);
      next.onclick=()=>{ set(i+1); play(); };
      prev.onclick=()=>{ set(i-1); play(); };
      const onDown = (e)=>{ dragging=true; sx = e.touches? e.touches[0].clientX : e.clientX; stop(); };
      const onMove = (e)=>{ if(!dragging) return; x=(e.touches? e.touches[0].clientX : e.clientX)-sx; track.style.transform=`translateX(calc(${-i*100}% + ${x}px))`; };
      const onUp = ()=>{ if(!dragging) return; dragging=false; if(Math.abs(x)>50){ set(i + (x<0?1:-1)); } else { set(i); } x=0; play(); };
      track.addEventListener('touchstart',onDown,{passive:true});
      track.addEventListener('touchmove',onMove,{passive:true});
      track.addEventListener('touchend',onUp);
      track.addEventListener('mousedown',onDown); window.addEventListener('mousemove',onMove); window.addEventListener('mouseup',onUp);
      set(0); play();
    }

    // ===== FILTER CHIPS =====
    const chipsEl = document.getElementById('chips');
    let activeFilters = new Set();
    function buildChips(data){
      const base = [
        {k:'BSB', t:'BSB'}, {k:'CHSB', t:'CHSB'},
        {k:'1-chorak', t:'1-chorak'}, {k:'2-chorak', t:'2-chorak'}, {k:'3-chorak', t:'3-chorak'}, {k:'4-chorak', t:'4-chorak'},
        {k:'*', t:'Hammasi'}
      ];
      chipsEl.innerHTML = base.map(c=>`<button class="chip" data-k="${c.k}">${c.t}</button>`).join('');
      chipsEl.querySelectorAll('.chip').forEach(btn=>{
        btn.onclick = ()=>{
          const k = btn.dataset.k;
          if(k==='*'){ activeFilters.clear(); chipsEl.querySelectorAll('.chip').forEach(b=>b.classList.remove('active')); }
          else { btn.classList.toggle('active'); if(btn.classList.contains('active')) activeFilters.add(k); else activeFilters.delete(k); }
          renderSections(data, true);
        }
      })
    }

    // ===== SECTIONS =====
    function renderSections(root, filtered=false){
      const wrap = document.getElementById('sections'); wrap.innerHTML='';
      root.sections.forEach(sec=>{
        if(filtered && activeFilters.size){
          const sTitle = sec.title.toLowerCase();
          const need = [...activeFilters].every(f=> sTitle.includes(f.toLowerCase()) || (f==='BSB' && sTitle.includes('bsb')) || (f==='CHSB' && sTitle.includes('chsb')));
          if(!need) return;
        }
        const s = document.createElement('section'); s.className='sect';
        s.innerHTML = `<h2>${sec.title}</h2><div class="grid"></div>`;
        const grid = s.querySelector('.grid');
        let items = sec.items;
        if(filtered && activeFilters.size){
          items = items.filter(it=> (it.tags||[]).some(tag => [...activeFilters].some(f => tag.toLowerCase().includes(f.toLowerCase()))));
        }
        items.forEach(it=>{
          const el = document.createElement('article'); el.className='card';
          el.innerHTML = `
            <div class="thumb">
              <img src="${it.image||'https://placehold.co/800x450?text=LeaderMath'}" alt="${it.name}">
              ${it.best?'<div class="badge">BEST</div>':''}
            </div>
            <div class="body">
              <h3 class="name">${it.name}</h3>
              ${it.description?`<p class="desc">${it.description}</p>`:''}
              <div class="tags">${(it.tags||[]).map(t=>`<span class="tag">${t}</span>`).join('')}</div>
              <div class="actions">
                <a class="btn" href="${it.link}" target="_blank" rel="noopener">Boshlash</a>
                ${it.more?`<a class="btn ghost" href="${it.more}" target="_blank" rel="noopener">Batafsil</a>`:''}
              </div>
            </div>`;
          grid.appendChild(el);
        });
        if(items.length) wrap.appendChild(s);
      });
    }

    // ===== FIREBASE HEADER (Auth + Points/ID) =====
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, runTransaction } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.firebasestorage.app",
      messagingSenderId: "992512966017",
      appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId: "G-459PLJ7P7L"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const signin = document.getElementById('signin');
    const signoutBtn = document.getElementById('signout');
    const uname = document.getElementById('uname');
    const uidEl = document.getElementById('uid');
    const pointsEl = document.getElementById('points');
    const ava = document.getElementById('ava');

    await setPersistence(auth, browserLocalPersistence);

    signin.onclick = async(e)=>{ e.preventDefault(); try{ await signInWithPopup(auth, new GoogleAuthProvider()); }catch(err){ alert(err.message); } };
    signoutBtn.onclick = async(e)=>{ e.preventDefault(); await signOut(auth); };

    function initials(n){ if(!n) return 'LM'; const p=n.trim().split(/\s+/); return (p[0][0]||'L')+(p[1]?.[0]||'M'); }

    async function ensureUser(uid, profile){
      const ref = doc(db, 'users', uid);
      await runTransaction(db, async(tx)=>{
        const snap = await tx.get(ref);
        if(!snap.exists()){
          const numericId = Math.floor(1000 + Math.random()*9000);
          tx.set(ref, {
            name: profile.displayName || 'Foydalanuvchi',
            email: profile.email || null,
            photoURL: profile.photoURL || null,
            numericId, points: 0, balance: 0, createdAt: Date.now()
          });
        }
      });
      const docSnap = await getDoc(ref); return docSnap.data();
    }

    onAuthStateChanged(auth, async(user)=>{
      if(!user){
        uname.textContent='Mehmon'; uidEl.textContent='ID: ‚Äî'; pointsEl.textContent='Ball: ‚Äî'; ava.textContent='LM';
        signin.style.display='inline'; signoutBtn.style.display='none';
        return;
      }
      signin.style.display='none'; signoutBtn.style.display='inline';
      const u = await ensureUser(user.uid, user);
      uname.textContent = u.name||user.displayName||'Foydalanuvchi';
      uidEl.textContent = `ID: ${u.numericId||'‚Äî'}`;
      pointsEl.textContent = `Ball: ${u.points ?? 0}`;
      if(user.photoURL){ ava.style.backgroundImage=`url(${user.photoURL})`; ava.style.backgroundSize='cover'; ava.textContent=''; }
      else { ava.textContent = initials(u.name||user.displayName); }
    });

    // ===== BOOT =====
    (async()=>{
      try{
        const data = await loadData();
        buildChips(data);
        initCarousel(data.banners||[]);
        renderSections(data);
      }catch(e){
        console.error(e);
        document.getElementById('carousel').style.display='none';
        document.getElementById('sections').innerHTML = `<div style="padding:12px;color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;border-radius:12px">index.json topilmadi yoki xato: ${e.message}</div>`;
      }
    })();
  </script>
</body>
</html>
