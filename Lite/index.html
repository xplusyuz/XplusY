<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MathCenter — Bosh sahifa</title>
  <link rel="stylesheet" href="css/style.css"/>
</head>
<body>
  <div class="container" style="padding-top:16px;">
    <header class="header">
      <div class="header-inner">
        <div class="brand"><div class="pi">π</div><div>MathCenter</div></div>
        <nav class="nav">
          <a class="active" href="index.html">Bosh sahifa</a>
          <a href="rating.html">Reyting</a>
          <a id="adminLink" href="admin.html" style="display:none">Admin</a>
        </nav>
        <div class="badges" id="authBox"><a class="btn" href="login.html">Kirish</a></div>
      </div>
    </header>

    <section class="hero">
      <h1>Yangi avlod matematika platformasi</h1>
      <p>Bannerlar, zamonaviy testlar va real vaqt reytingi. O‘quvchilar uchun qulay, administratorlar uchun kuchli boshqaruv.</p>
      <div class="kpis" style="margin-top:12px">
        <a class="btn btn-primary" href="#tests">Testlarni ko‘rish</a>
        <a class="btn" href="#banners">Bannerlarni ko‘rish</a>
      </div>
    </section>

    <div class="section-title" id="banners"><h2>Bannerlar</h2></div>
    <div id="banner-list" class="grid"></div>

    <div class="section-title" id="tests"><h2>Testlar</h2></div>
    <div id="test-grid" class="grid"></div>

    <footer class="footer">© 2025 MathCenter — “π” brendi</footer>
  </div>

  <div class="modal-backdrop" id="bestBackdrop">
    <div class="modal" id="bestModal" role="dialog" aria-modal="true">
      <div class="head"><strong id="bmTitle">Batafsil</strong><button class="close-x" id="bmClose">×</button></div>
      <div class="body">
        <img id="bmImage" src="" alt="" style="width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:14px;">
        <div id="bmDesc" class="chip"></div>
        <div id="bmTimes" class="chip"></div>
        <div id="bmCountdown" class="badge"></div>
      </div>
      <div class="foot"><a class="btn btn-primary" id="bmStartBtn" href="#">Boshlash</a></div>
    </div>
  </div>

  <script type="module">
    import { db } from './js/firebase-init.js';

    (async () => {
      const u = JSON.parse(localStorage.getItem('mc_user') || 'null');
      const authBox = document.getElementById('authBox');
      const adminLink = document.getElementById('adminLink');
      if (u) {
        const span1 = document.createElement('span'); span1.className='badge'; span1.textContent = 'ID: ' + (u.numericId || u.id || u.login);
        const span2 = document.createElement('span'); span2.className='badge'; span2.textContent = 'Ism: ' + (u.name || '');
        const span3 = document.createElement('span'); span3.id='pointsBadge'; span3.className='badge'; span3.textContent = 'Ball: 0';
        const a = document.createElement('a'); a.className='btn'; a.id='logoutBtn'; a.href='#'; a.textContent='Chiqish';
        authBox.innerHTML=''; authBox.append(span1, span2, span3, a);
        if (u.role==='admin' || u.role==='superadmin') adminLink.style.display='inline-flex';
        a.addEventListener('click', (e)=>{ e.preventDefault(); localStorage.removeItem('mc_user'); location.href='index.html'; });
        try {
          const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
          const id = String(u.numericId || u.id || u.login);
          const snap = await getDoc(doc(db, 'user_points', id));
          if (snap.exists()) span3.textContent = 'Ball: ' + (snap.data().totalPoints || 0);
        } catch(_){}
      }

      const backdrop = document.getElementById('bestBackdrop');
      const bmTitle = document.getElementById('bmTitle');
      const bmImage = document.getElementById('bmImage');
      const bmDesc = document.getElementById('bmDesc');
      const bmTimes = document.getElementById('bmTimes');
      const bmCountdown = document.getElementById('bmCountdown');
      const bmStartBtn = document.getElementById('bmStartBtn');
      document.getElementById('bmClose').onclick = () => { backdrop.style.display='none'; };

      function openDetails(t) {
        bmTitle.textContent = t.title || '';
        bmImage.src = t.image || ('https://picsum.photos/seed/'+encodeURIComponent(t.id)+'/800/450');
        bmDesc.textContent = t.description || '';
        const s = t.startAt ? new Date(t.startAt) : null;
        const e = t.endAt ? new Date(t.endAt) : null;
        bmTimes.textContent = (s?('Boshlanish: '+s.toLocaleString()+'  '):'') + (e?('• Tugash: '+e.toLocaleString()):'');
        bmStartBtn.href = 'test.html?id=' + encodeURIComponent(t.id);
        backdrop.style.display='flex';
        function tick() {
          const now = new Date();
          const notStarted = s && now < s;
          const finished = e && now > e;
          if (notStarted) {
            const ms = s - now;
            const hh = Math.floor(ms/3600000);
            const mm = Math.floor((ms%3600000)/60000);
            const ss = Math.floor((ms%60000)/1000);
            bmCountdown.textContent = 'Boshlanishiga: ' + hh + ':' + String(mm).padStart(2,'0') + ':' + String(ss).padStart(2,'0');
            bmStartBtn.setAttribute('disabled','');
          } else if (finished) {
            bmCountdown.textContent = 'Muddati tugagan';
            bmStartBtn.setAttribute('disabled','');
          } else {
            bmCountdown.textContent = 'Ochiq';
            bmStartBtn.removeAttribute('disabled');
          }
          if (backdrop.style.display==='flex') setTimeout(tick, 1000);
        }
        tick();
      }

      async function loadJSON(path) { const res = await fetch(path); if(!res.ok) throw new Error('JSON '+path+' yuklanmadi'); return res.json(); }

      function renderBanners(list) {
        const wrap = document.getElementById('banner-list'); wrap.innerHTML='';
        if (!list.length) { wrap.innerHTML = '<div class="badge">Banner yo\'q</div>'; return; }
        list.forEach((b)=>{
          const card = document.createElement('article'); card.className='card';
          const img = document.createElement('img'); img.src = b.image; img.alt = b.title||'';
          const bx = document.createElement('div'); bx.className='content';
          const h3 = document.createElement('h3'); h3.textContent = b.title||'';
          const p = document.createElement('p'); p.className='chip'; p.textContent = b.subtitle||'';
          const actions = document.createElement('div'); actions.className='kpis';
          const a = document.createElement('a'); a.className='btn btn-primary'; a.href=b.link||'#'; a.target='_blank'; a.textContent='Batafsil';
          actions.appendChild(a); bx.append(h3,p,actions); card.append(img,bx); wrap.appendChild(card);
        });
      }

      function renderTests(list) {
        const wrap = document.getElementById('test-grid'); wrap.innerHTML='';
        if (!list.length) { wrap.innerHTML = '<div class="badge">Testlar yo\'q</div>'; return; }
        list.forEach((t)=>{
          const total = (t.questions||[]).reduce((a,q)=>a+(q.points||1),0);
          const card = document.createElement('article'); card.className='card';
          const img = document.createElement('img'); img.src = t.image || ('https://picsum.photos/seed/'+encodeURIComponent(t.id)+'/800/450'); img.alt = t.title||'';
          const bx = document.createElement('div'); bx.className='content';
          const row = document.createElement('div'); row.className='kpis';
          const title = document.createElement('h3'); title.textContent = t.title||''; title.style.margin='0';
          const chip1 = document.createElement('span'); chip1.className='chip'; chip1.textContent='Savollar: ' + (t.questions?t.questions.length:0);
          const chip2 = document.createElement('span'); chip2.className='chip'; chip2.textContent='Maks: ' + total;
          row.append(chip1, chip2);
          const tags = document.createElement('div'); tags.className='tags';
          (t.tags||[]).forEach(x=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=x; tags.appendChild(s); });
          if (t.best) { const s=document.createElement('span'); s.className='tag best'; s.textContent='BEST'; tags.appendChild(s); }
          const actions = document.createElement('div'); actions.className='kpis';
          const btn1 = document.createElement('a'); btn1.className='btn btn-primary'; btn1.textContent='Boshlash'; btn1.href='test.html?id='+encodeURIComponent(t.id);
          const now = new Date(); const sAt = t.startAt?new Date(t.startAt):null; const eAt = t.endAt?new Date(t.endAt):null;
          const notStarted = sAt && now < sAt; const finished = eAt && now > eAt;
          if (notStarted) { btn1.textContent='Tez orada'; btn1.className='btn btn-primary'; btn1.setAttribute('disabled',''); }
          else if (finished) { btn1.textContent='Muddati tugagan'; btn1.className='btn'; btn1.setAttribute('disabled',''); }
          const btn2 = document.createElement('button'); btn2.className='btn'; btn2.textContent='Batafsil'; btn2.addEventListener('click', (e)=>{ e.preventDefault(); openDetails(t); });
          actions.append(btn1, btn2);
          bx.append(title,row,tags,actions); card.append(img,bx); wrap.appendChild(card);
        });
      }

      const banners = await loadJSON('assets/banners.json').catch(()=>[]);
      const tests = await loadJSON('assets/tests.json').catch(()=>[]);
      renderBanners(banners);
      renderTests(tests);
    })();
  </script>
</body>
</html>