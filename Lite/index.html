
<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MathCenter — Bosh sahifa</title>
  <link rel="stylesheet" href="css/style.css"/>
</head>
<body>
  <div id="header"></div>
  <main class="container">
    <section class="hero">
      <h1>Bannerlar</h1>
      <div id="banner-list" class="grid"></div>
    </section>

    <section style="margin-top: 20px;">
      <h2>Testlar</h2>
      <div id="test-grid" class="grid"></div>
    </section>
  </main>
  <footer class="footer">© {{YEAR}} MathCenter — “π” brendi</footer>

  <script type="module">
    import { db } from './js/firebase-init.js';
    
function userRole() {
  const u = JSON.parse(localStorage.getItem('mc_user') || 'null');
  return u ? (u.role || 'user') : null;
}
function renderHeader(active='') {
  const u = JSON.parse(localStorage.getItem('mc_user') || 'null');
  const role = userRole();
  const auth = u
    ? `<span class="badge">ID: ${u.numericId ?? u.id ?? u.login}</span>
       <span class="badge">Ism: ${u.name}</span>
       <span id="pointsBadge" class="badge" style="display:none"></span>
       <a class="btn" href="#" id="logoutBtn">Chiqish</a>`
    : `<a class="btn" href="login.html">Kirish</a>`;
  const adminLink = (role==='admin' || role==='superadmin') ? `<a class="${active==='admin'?'active':''}" href="admin.html">Admin</a>` : '';
  return `<header class="header"><div class="header-inner container">
    <div class="brand"><div class="pi">π</div><div>MathCenter</div></div>
    <nav class="nav">
      <a class="${active==='home'?'active':''}" href="index.html">Bosh sahifa</a>
      <a class="${active==='rating'?'active':''}" href="rating.html">Reyting</a>
      ${adminLink}
    </nav>
    <div class="auth">${auth}</div>
  </div></header>`;
}
async function fillPoints(db) {
  const u = JSON.parse(localStorage.getItem('mc_user') || 'null');
  if (!u) return;
  const id = String(u.numericId ?? u.id ?? u.login);
  const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
  const ref = doc(db, 'user_points', id);
  const snap = await getDoc(ref);
  const badge = document.getElementById('pointsBadge');
  if (badge) {
    const pts = snap.exists() ? (snap.data().totalPoints||0) : 0;
    badge.textContent = 'Ball: ' + pts;
    badge.style.display = 'inline-block';
  }
}
function bindLogout() {
  const btn = document.querySelector('#logoutBtn');
  if (btn) btn.addEventListener('click', (e) => { e.preventDefault(); localStorage.removeItem('mc_user'); location.href='index.html'; });
}

    document.getElementById('header').innerHTML = renderHeader('home');
    bindLogout(); fillPoints(db);

    // Modal for details
    const backdrop = Object.assign(document.createElement('div'), {className:'modal-backdrop', id:'bestBackdrop'});
    backdrop.innerHTML = `<div class="modal" role="dialog" aria-modal="true" id="bestModal">
      <div class="head"><strong id="bmTitle">Batafsil</strong><button class="close-x" id="bmClose">×</button></div>
      <div class="body">
        <img id="bmImage" src="" alt="" style="width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:12px;"/>
        <div id="bmDesc" class="muted"></div>
        <div id="bmTimes" class="muted"></div>
        <div id="bmCountdown" class="badge"></div>
      </div>
      <div class="foot"><a class="btn btn-primary" id="bmStartBtn" href="#">Boshlash</a></div>
    </div>`;
    document.body.appendChild(backdrop);
    document.getElementById('bmClose').onclick = ()=> backdrop.style.display='none';
    function openDetails(t){
      document.getElementById('bmTitle').textContent = t.title;
      document.getElementById('bmImage').src = t.image || ('https://picsum.photos/seed/'+encodeURIComponent(t.id)+'/800/450');
      document.getElementById('bmDesc').textContent = t.description || '';
      const s = t.startAt ? new Date(t.startAt) : null;
      const e = t.endAt ? new Date(t.endAt) : null;
      document.getElementById('bmTimes').textContent = (s?('Boshlanish: '+s.toLocaleString()+'  '):'') + (e?('• Tugash: '+e.toLocaleString()):'');
      document.getElementById('bmStartBtn').href = 'test.html?id='+encodeURIComponent(t.id);
      backdrop.style.display='flex';
      function upd(){
        const now = new Date();
        const notStarted = s && now < s;
        const finished = e && now > e;
        const box = document.getElementById('bmCountdown');
        if (notStarted){
          const ms = s - now;
          const hh = Math.floor(ms/3600000);
          const mm = Math.floor((ms%3600000)/60000);
          const ss = Math.floor((ms%60000)/1000);
          box.textContent = `Boshlanishiga: ${hh}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
          document.getElementById('bmStartBtn').setAttribute('disabled','');
        } else if (finished){
          box.textContent = 'Muddati tugagan'; document.getElementById('bmStartBtn').setAttribute('disabled','');
        } else { box.textContent = 'Ochiq'; document.getElementById('bmStartBtn').removeAttribute('disabled'); }
        if (backdrop.style.display==='flex') setTimeout(upd, 1000);
      } upd();
    }

    async function loadJSON(path) {
      const res = await fetch(path);
      if (!res.ok) throw new Error('JSON yuklab bo\'lmadi: ' + path + ' ' + res.status);
      return res.json();
    }

    function bannerCard(b) {
      return `<article class="banner">
        <img src="${b.image}" alt="${b.title}">
        <div class="copy">
          <h2>${b.title}</h2>
          <p>${b.subtitle || ''}</p>
          <a class="btn btn-primary" href="${b.link}" target="_blank">Batafsil</a>
        </div>
      </article>`;
    }

    function testCard(t) {
      const tags = (t.tags||[]).map(x=>`<span class='badge'>${x}</span>`).join('') + (t.best?` <span class='badge'>BEST</span>`:'');
      const total = (t.questions||[]).reduce((a,q)=>a+(q.points||1),0);
      const now = new Date(), s = t.startAt?new Date(t.startAt):null, e = t.endAt?new Date(t.endAt):null;
      const notStarted = s && now < s, finished = e && now > e;
      let primaryBtn = `<a class="btn btn-primary" href="test.html?id=${encodeURIComponent(t.id)}">Boshlash</a>`;
      if (notStarted) primaryBtn = `<button class="btn btn-primary" disabled>Tez orada</button>`;
      else if (finished) primaryBtn = `<button class="btn" disabled>Muddati tugagan</button>`;
      return `<article class="card">
        <img src="${t.image || ('https://picsum.photos/seed/'+encodeURIComponent(t.id)+'/800/450')}" alt="${t.title}">
        <div class="content">
          <h3>${t.title}</h3>
          <div class="muted">Savollar: ${(t.questions||[]).length} • Maks ball: ${total}</div>
          <div class="tags">${tags}</div>
          <div style="display:flex; gap:8px; margin-top:8px;">
            ${primaryBtn}
            <a class="btn" href="#" onclick='openDetails(t);return false;'>Batafsil</a>
          </div>
        </div>
      </article>`;
    }

    (async () => {
      let banners = []; let tests = [];
      try { banners = await loadJSON('assets/banners.json'); } catch(e){ console.warn(e); banners = []; }
      try { tests = await loadJSON('assets/tests.json'); } catch(e){ console.warn(e); tests = []; }
      document.getElementById('banner-list').innerHTML = banners.map(bannerCard).join('') || '<div class="muted">Banner yo\'q</div>';
      // expose tests to window for details() on cards
      window.tests = tests;
      document.getElementById('test-grid').innerHTML = tests.map((t)=>{ window.t=t; return testCard(t); }).join('') || '<div class="muted">Testlar yo\'q</div>';
    })();
  </script>
</body>
</html>
