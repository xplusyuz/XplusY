<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>LeaderMath ‚Äî Mobil (PWA)</title>
  <meta name="theme-color" content="#2E8B57" id="meta-theme-color"/>
  <meta name="color-scheme" content="dark light"/>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./favicon.ico">
  <style>
    :root{
      --brand:#2E8B57;--brand2:#1F6B45;
      --bg:#f6faf8;--text:#0f172a;--muted:#6b7c75;--card:#ffffff;
      --frame:#e3efe8;--frame-dark:#163d2d;--chip:#e9f5ef;--chip-b:#cfe9dc;
      --radius:18px
    }
    :root.dark{
      --bg:#0b0f0e; --text:#EAF7F0; --muted:#A8BBB3; --card:#0f1714;
      --frame:#244b39; --frame-dark:#112a1f; --chip:#0f221b; --chip-b:#2a5a45;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    .appbar{position:sticky;top:0;z-index:90;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:10px 12px;display:flex;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
    .logo{width:40px;height:40px;border-radius:14px;background:#fff2;display:grid;place-items:center;font-weight:800}
    .title{font-weight:800;font-size:18px}
    .sub{font-size:11px;color:var(--muted)}
    .spacer{flex:1}
    .iconbtn{background:#ffffff22;border:1px solid #ffffff33;color:#fff;border-radius:12px;padding:8px 10px;font-weight:700;cursor:pointer}
    .userbar{background:var(--card);border:1px dashed var(--frame);border-radius:14px;margin:10px 12px;padding:10px;display:flex;align-items:center;gap:10px;box-shadow:0 8px 20px #0001}
    .ava{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand2));display:grid;place-items:center;color:#fff;font-weight:800}
    .uinfo{line-height:1.2}.uinfo b{display:block}.uvals{margin-left:auto;text-align:right;font-size:12px}
    .board{background:var(--card);border:1px dashed var(--frame);border-radius:16px;margin:10px 12px;padding:12px}
    .board h3{margin:0 0 8px;font-size:16px}
    .rank{display:grid;grid-template-columns:32px 1fr auto;gap:8px;align-items:center;padding:8px;border-radius:10px;border:1px dashed var(--frame);margin-bottom:6px;background:linear-gradient(180deg,#ffffff,#ffffff00)}
    .rank.top{background:linear-gradient(0deg,#f6fffb,#ffffff)}
    .chips{position:sticky;top:62px;z-index:80;background:var(--bg);padding:8px 12px;display:flex;gap:8px;overflow:auto}
    .chip{white-space:nowrap;font-size:12px;color:#0b3d2a;background:var(--chip);border:1px solid var(--chip-b);padding:7px 10px;border-radius:999px}
    .chip.active{outline:2px solid var(--brand)}
    .carousel{position:relative;overflow:hidden;border-radius:var(--radius); margin:0 12px;}
    .track{display:flex;transition:transform .45s cubic-bezier(.2,.8,.2,1)}
    .slide{min-width:100%;aspect-ratio:16/9;position:relative}
    .slide img{width:100%;height:100%;object-fit:cover;display:block}
    .slide .html-content{width:100%;height:100%;padding:20px;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;border-radius:var(--radius);overflow:hidden;}
    .dots{position:absolute;inset:auto 0 8px;display:flex;justify-content:center;gap:6px}
    .dot{width:8px;height:8px;border-radius:10px;background:#1113}
    .dot.active{width:18px;background:#111}
    .cbtn{position:absolute;top:50%;transform:translateY(-50%);background:#0007;color:#fff;border:none;width:38px;height:38px;border-radius:12px;display:grid;place-items:center}
    .cbtn.left{left:8px}.cbtn.right{right:8px}
    .sect{margin-top:16px}
    .frame{border:1px dashed var(--frame); border-radius:18px; padding:12px; background:linear-gradient(180deg,#ffffffcc,#ffffff00);}
    .framehead{display:flex;align-items:center;gap:8px;margin:0 2px 10px;border-bottom:1px dashed var(--frame);padding-bottom:8px}
    .framehead .dotcap{width:10px;height:10px;border-radius:50%;background:var(--brand)}
    .framehead h2{margin:0;font-size:18px;font-weight:900;color:var(--brand2);letter-spacing:.2px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:480px){.grid{grid-template-columns:1fr 1fr}}
    @media (min-width:768px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card);border-radius:14px;overflow:hidden;box-shadow:0 10px 24px rgba(0,0,0,.06);border:1px dashed var(--frame)}
    .thumb{aspect-ratio:16/9;background:#e6efe9;position:relative}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .badge{position:absolute;top:8px;left:8px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .body{padding:12px}
    .name{font-size:15px;font-weight:800;margin:0 0 6px}
    .desc{font-size:13px;color:var(--muted);line-height:1.4;margin:0 0 10px}
    .tags{display:flex;flex-wrap:wrap;gap:6px;margin:0 0 10px}
    .tag{font-size:11px;color:#0b3d2a;background:#e9f5ef;border:1px solid #cfe9dc;padding:5px 8px;border-radius:999px}
    .actions{display:flex;gap:8px}
    .btn{flex:1;display:inline-flex;align-items:center;justify-content:center;gap:8px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;border:none;border-radius:12px;padding:12px 14px;font-weight:800;font-size:14px;cursor:pointer}
    .btn.ghost{background:#f0f7f3;color:#0b3d2a;border:1px solid var(--frame)}
    .btn:disabled{opacity:0.6;cursor:not-allowed}
    .pager{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
    .pager button{background:#e9f5ef;border:1px solid #cfe9dc;color:#0b3d2a;border-radius:10px;padding:8px 10px;font-weight:700}
    .dark .iconbtn{ background:#ffffff22; color:#fff; border:1px solid #ffffff33 }
    .dark .userbar,.dark .board{ border-color:var(--frame); background:var(--card) }
    .dark .rank{ border-color:var(--frame); background:linear-gradient(180deg,#0f1714,#0f171400) }
    .dark .rank.top{ background:linear-gradient(0deg,#13251c,#0f1714) }
    .dark .chip,.dark .tag{ color:var(--text); background:var(--chip); border-color:var(--chip-b) }
    .dark .btn.ghost{ background:#ffffff0a; color:#text; border:1px solid var(--frame) }
    .dark .dot{ background:#ffffff55 } .dark .dot.active{ background:#fff }
    .dark .thumb{ background:#12211a }
    .dark .frame{ border-color:var(--frame); background:linear-gradient(180deg,#0f1714cc,#0f171400) }
    .dark .framehead h2{ color:#d6f2e6 }
    .thumb{ position:relative; overflow:hidden; border-radius:16px; }
    .thumb.noimg{ background:linear-gradient(135deg,#e9f2ee 0%,#f6fbf8 100%); }
    .dark .thumb.noimg{ background:linear-gradient(135deg,#0f1d17,#0b1310); }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .thumb .ov{ position:absolute; inset:0; display:grid; place-items:center; padding:12px; background:linear-gradient(180deg,transparent 45%, rgba(0,0,0,.45) 100%); }
    .thumb .label{
      display:inline-block; padding:.7em 1.25em; border-radius:18px; font-weight:900;
      font-size:clamp(18px,4.6vw,26px); letter-spacing:.3px; color:#fff;
      background:linear-gradient(180deg, rgba(255,255,255,.24), rgba(255,255,255,.10));
      border:1px solid rgba(255,255,255,.38);
      box-shadow:0 10px 28px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.45);
      backdrop-filter: blur(8px) saturate(130%); text-shadow:0 2px 12px rgba(0,0,0,.35);
      transform: translateY(0); transition: transform .25s ease, box-shadow .25s ease;
    }
    .card:hover .label{ transform: translateY(-2px); box-shadow:0 14px 34px rgba(0,0,0,.32), inset 0 1px 0 rgba(255,255,255,.55); }

    /* Profile modal styles */
    .modal-mask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);z-index:9999}
    .modal{width:min(680px,94%);background:#fff;border-radius:14px;border:1px solid var(--frame);box-shadow:0 20px 60px rgba(0,0,0,.25);padding:14px}
    .modal h3{margin:0 0 8px;color:#1F6B45}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid1{display:grid;grid-template-columns:1fr;gap:10px}
    .ctl label{font-size:12px;color:#6b7c75;display:block;margin-bottom:4px}
    .ctl input,.ctl textarea{
      width:100%;padding:10px;border:1px solid var(--frame);border-radius:10px;font:inherit;background:#fff
    }
    .row{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .btns{display:flex;gap:8px}
    .danger{color:#c62828;font-size:12px}
    .req{color:#c62828}
    .dark .modal{background:#0f1714;border-color:var(--frame)}
    .dark .ctl input,.dark .ctl textarea{background:#0f1714;color:var(--text);border-color:var(--frame)}

    /* Content modal styles */
    .content-modal .modal{width:min(90%, 800px); max-height:85vh; overflow-y:auto}
    .content-modal .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px dashed var(--frame)}
    .content-modal .modal-title{margin:0;font-size:20px;font-weight:800;color:var(--brand2)}
    .dark .content-modal .modal-title{color:#d6f2e6}
    .content-modal .modal-body{padding:10px 0}
    .timer{display:inline-block;background:var(--chip);border:1px solid var(--chip-b);padding:5px 10px;border-radius:10px;font-size:12px;font-weight:700;margin-left:10px}
  </style>
</head>
<body>
  <!-- Appbar -->
  <header class="appbar">
    <div class="logo">L</div>
    <div><div class="title">LeaderMath</div><div class="sub">BSB / CHSB dars resurslari</div></div>
    <div class="spacer"></div>
    <button id="themeBtn" class="iconbtn" title="Dark/Light">üåô</button>
    <button id="installBtn" class="iconbtn" title="Ilova sifatida o'rnatish">‚¨áÔ∏è</button>
  </header>

  <!-- User bar -->
  <section class="userbar" id="userbar">
    <div class="ava" id="ava">LM</div>
    <div class="uinfo">
      <b id="uname">Mehmon</b>
      <span class="sub" id="uid">ID: ‚Äî</span>
      <div class="sub" id="uschool" style="margin-top:2px">‚Äî</div>
      <div class="sub" id="uclass">‚Äî</div>
    </div>
    <div class="uvals">
      <div><b id="points">Ball: ‚Äî</b></div>
      <div style="margin-top:4px">
        <a href="#" id="editProfile" class="sub" style="display:none">Profil</a> ¬∑
        <a href="#" id="signin" class="sub">Kirish</a> ¬∑
        <a href="#" id="signout" class="sub" style="display:none">Chiqish</a> ¬∑
        <a class="sub" href="./admin.html" id="adminLink">Admin</a>
      </div>
    </div>
  </section>

  <!-- Leaderboard -->
  <section class="board" id="board">
    <h3>Top 50 ‚Äî Ball bo'ycha</h3>
    <div id="boardList"></div>
    <div id="boardPager" class="pager" style="display:none">
      <button id="boardPrev">Oldingi</button>
      <div class="info" id="boardInfo"></div>
      <button id="boardNext">Keyingi</button>
    </div>
  </section>

  <!-- Chips -->
  <div class="chips" id="chips"></div>

  <!-- Carousel -->
  <section class="carousel" id="carousel" style="margin-top:6px">
    <button class="cbtn left" aria-label="Oldingi" id="prev">‚Äπ</button>
    <div class="track" id="track"></div>
    <button class="cbtn right" aria-label="Keyingi" id="next">‚Ä∫</button>
    <div class="dots" id="dots"></div>
  </section>

  <!-- Sections -->
  <div class="container" style="padding:6px 12px 88px">
    <div id="sections"></div>
    <div style="height:24px"></div>
  </div>

  <!-- Profile (mandatory) modal -->
  <div id="profileModal" class="modal-mask" aria-modal="true" role="dialog">
    <div class="modal">
      <h3>Profil ma'lumotlari <span class="sub">‚Äî majburiy <span class="req">*</span></span></h3>
      <div class="grid2">
        <div class="ctl"><label>Ism <span class="req">*</span></label><input id="pFirst" placeholder="Ism"></div>
        <div class="ctl"><label>Familiya <span class="req">*</span></label><input id="pLast" placeholder="Familiya"></div>
      </div>
      <div class="grid2">
        <div class="ctl"><label>Maktab nomi <span class="req">*</span></label><input id="pSchool" placeholder="Masalan: 123-maktab yoki BSB"></div>
        <div class="ctl"><label>Sinf <span class="req">*</span></label><input id="pClass" placeholder="Masalan: 9-A"></div>
      </div>
      <div class="grid2">
        <div class="ctl"><label>Telefon <span class="req">*</span></label><input id="pPhone" placeholder="+998 XX XXX XX XX"></div>
        <div class="ctl"><label>Email <span class="req">*</span></label><input id="pEmail" placeholder="email@example.com"></div>
      </div>
      <div class="grid1">
        <div class="ctl"><label>Uy manzili <span class="req">*</span></label><textarea id="pAddress" rows="2" placeholder="Shahar/tuman, ko'cha, uy ..."></textarea></div>
      </div>
      <div class="row">
        <div class="danger" id="pError"></div>
        <div class="btns">
          <button id="pSave" class="iconbtn" style="background:linear-gradient(135deg,var(--brand),var(--brand2));border:none">Saqlash</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Content modal -->
  <div id="contentModal" class="modal-mask content-modal" aria-modal="true" role="dialog" style="display:none">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="contentModalTitle">Test</h3>
        <span id="contentTimer" class="timer" style="display:none">00:00:00</span>
        <button id="closeContentModal" class="iconbtn danger">‚úï</button>
      </div>
      <div class="modal-body" id="contentModalBody"></div>
      <div class="row" id="contentModalActions" style="display:none">
        <div class="btns">
          <button id="startTestBtn" class="btn">Testni boshlash</button>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  // ===== Theme + PWA =====
  const root=document.documentElement, themeBtn=document.getElementById('themeBtn'), THEME_KEY='lm-theme';
  const metaTheme=document.getElementById('meta-theme-color');
  const setTheme=m=>{
    root.classList.toggle('dark',m==='dark');
    localStorage.setItem(THEME_KEY,m);
    themeBtn.textContent=m==='dark'?'‚òÄÔ∏è':'üåô';
    metaTheme.setAttribute('content', m==='dark' ? '#0b0f0e' : '#2E8B57');
  };
  setTheme(localStorage.getItem(THEME_KEY)||(matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
  themeBtn.onclick=()=>setTheme(root.classList.contains('dark')?'light':'dark');
  let deferredPrompt; const installBtn=document.getElementById('installBtn');
  window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;installBtn.style.display='inline-block';});
  installBtn.onclick=async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;installBtn.style.display='none';};
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./service-worker.js'); }

  // ===== Firebase =====
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
  import { getFirestore, doc, getDoc, setDoc, onSnapshot, runTransaction, collection, query, orderBy, limit, getDocs, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

  const cfg = {
    apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
    authDomain: "xplusy-760fa.firebaseapp.com",
    projectId: "xplusy-760fa",
    storageBucket: "xplusy-760fa.firebasestorage.app",
    messagingSenderId: "992512966017",
    appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
    measurementId: "G-459PLJ7P7L"
  };
  const app = initializeApp(cfg);
  const auth = getAuth(app);
  const db = getFirestore(app);
  await setPersistence(auth, browserLocalPersistence);

  // ===== User bar & profile =====
  const el = {
    uname: document.getElementById('uname'), uid: document.getElementById('uid'), points: document.getElementById('points'),
    ava: document.getElementById('ava'), signin: document.getElementById('signin'), signout: document.getElementById('signout'),
    adminLink: document.getElementById('adminLink'), editProfile: document.getElementById('editProfile'),
    uschool: document.getElementById('uschool'), uclass: document.getElementById('uclass')
  };
  function initials(n){ if(!n) return 'LM'; const p=n.trim().split(/\s+/); return (p[0][0]||'L')+(p[1]?.[0]||'M') }

  const PM = {
    mask: document.getElementById('profileModal'),
    first: document.getElementById('pFirst'),
    last: document.getElementById('pLast'),
    school: document.getElementById('pSchool'),
    klass: document.getElementById('pClass'),
    phone: document.getElementById('pPhone'),
    email: document.getElementById('pEmail'),
    address: document.getElementById('pAddress'),
    err: document.getElementById('pError'),
    save: document.getElementById('pSave'),
  };

  function openProfileModal(prefill={}){
    PM.first.value = prefill.first||'';
    PM.last.value  = prefill.last||'';
    PM.school.value= prefill.school||'';
    PM.klass.value = prefill.class||'';
    PM.phone.value = prefill.phone||'';
    PM.email.value = prefill.email||'';
    PM.address.value=prefill.address||'';
    PM.err.textContent='';
    PM.mask.style.display='flex';
  }
  function closeProfileModal(){ PM.mask.style.display='none'; }

  function profileIsComplete(u){
    return !!(u &&
      u.name && /\s/.test(u.name) &&
      u.school && u.class && u.phone && u.email && u.address);
  }

  async function ensureUser(u){
    const ref=doc(db,'users',u.uid);
    await runTransaction(db, async(tx)=>{
      const snap = await tx.get(ref);
      if(!snap.exists()){
        tx.set(ref,{
          name: u.displayName||'Foydalanuvchi',
          email: u.email||null,
          photoURL: u.photoURL||null,
          role:'user',
          numericId:Math.floor(1000+Math.random()*9000),
          points:0,
          // yangi maydonlar
          school:null, class:null, phone:null, address:null,
          createdAt:Date.now(), updatedAt: serverTimestamp()
        });
      }
    });
    return (await getDoc(ref)).data();
  }

  function setAdminVisibility(uDoc, user){
    const isOwner = (user?.email === 'sohibjonmath@gmail.com');
    const isAdmin = (uDoc?.role === 'admin');
    if(el.adminLink){ el.adminLink.style.display = (isOwner || isAdmin) ? 'inline' : 'none'; }
  }

  async function saveProfile(){
    const user = auth.currentUser; if(!user) return;
    const first = PM.first.value.trim();
    const last  = PM.last.value.trim();
    const school= PM.school.value.trim();
    const klass = PM.klass.value.trim();
    const phone = PM.phone.value.trim();
    const email = PM.email.value.trim();
    const address=PM.address.value.trim();

    // minimal tekshiruv
    if(!first || !last || !school || !klass || !phone || !email || !address){
      PM.err.textContent = 'Barcha maydonlar majburiy.';
      return;
    }
    // telefon va email juda sodda tekshiruv
    if(!/^\+?\d[\d\s\-()]{7,}$/.test(phone)){ PM.err.textContent='Telefon raqamini to'g'ri kiriting.'; return; }
    if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ PM.err.textContent='Email noto'g'ri.'; return; }

    try{
      const ref = doc(db,'users',user.uid);
      await setDoc(ref, {
        name: `${first} ${last}`.trim(),
        school, class: klass, phone, email, address,
        updatedAt: serverTimestamp()
      }, { merge:true });

      // UI yangilash
      el.uname.textContent = `${first} ${last}`.trim();
      el.uschool.textContent = `Maktab: ${school}`;
      el.uclass.textContent = `Sinf: ${klass}`;
      closeProfileModal();
    }catch(e){
      PM.err.textContent = 'Saqlashda xatolik: ' + (e?.message||e);
    }
  }

  PM.save.onclick = saveProfile;

  el.signin.onclick = async(e)=>{ e.preventDefault(); try{ await signInWithPopup(auth, new GoogleAuthProvider()); }catch(err){ alert(err.message) } };
  el.signout.onclick = async(e)=>{ e.preventDefault(); await signOut(auth) };
  el.editProfile.onclick = (e)=>{ e.preventDefault();
    const u = auth.currentUser; if(!u) return;
    // mavjud profile ni prefill
    openProfileModal({
      first: (el.uname.textContent||'').split(' ')[0]||'',
      last:  (el.uname.textContent||'').split(' ').slice(1).join(' '),
      school: el.uschool.textContent.replace(/^Maktab:\s*/,'')||'',
      class: el.uclass.textContent.replace(/^Sinf:\s*/,'')||'',
      phone: '', email: u.email||'', address: ''
    });
  };

  onAuthStateChanged(auth, async(user)=>{
    if(!user){
      el.uname.textContent='Mehmon'; el.uid.textContent='ID: ‚Äî'; el.points.textContent='Ball: ‚Äî';
      el.uschool.textContent='‚Äî'; el.uclass.textContent='‚Äî';
      el.ava.textContent='LM'; el.ava.style.backgroundImage=''; el.ava.style.backgroundSize='';
      el.signin.style.display='inline'; el.signout.style.display='none'; if(el.adminLink) el.adminLink.style.display='none';
      el.editProfile.style.display='none';
      return;
    }
    el.signin.style.display='none'; el.signout.style.display='inline';

    const u = await ensureUser(user);
    setAdminVisibility(u, user);

    const [first,last=''] = (u.name||user.displayName||'Foydalanuvchi').split(/\s+/,2);
    el.uname.textContent = `${first||''} ${last||''}`.trim();
    el.uid.textContent = `ID: ${u.numericId||'‚Äî'}`;
    el.points.textContent = `Ball: ${u.points ?? 0}`;
    el.uschool.textContent = u.school ? `Maktab: ${u.school}` : 'Maktab: ‚Äî';
    el.uclass.textContent  = u.class  ? `Sinf: ${u.class}`   : 'Sinf: ‚Äî';
    if(user.photoURL){ el.ava.style.backgroundImage=`url(${user.photoURL})`; el.ava.style.backgroundSize='cover'; el.ava.textContent=''; } else { el.ava.textContent = initials(u.name||user.displayName); }
    el.editProfile.style.display='inline';

    // majburiy to'ldirish
    if(!profileIsComplete(u)){
      openProfileModal({
        first, last,
        school: u.school||'',
        class:  u.class||'',
        phone:  u.phone||'',
        email:  u.email||user.email||'',
        address:u.address||''
      });
    }
  });

  // ===== Leaderboard =====
  const BOARD_PAGE_SIZE = 10; let boardPage=0; let boardUsers=[];
  function drawBoard(){
    const root=document.getElementById('boardList'); const pager=document.getElementById('boardPager');
    if(!boardUsers.length){ root.innerHTML=`<div class="sub">Hali yetarli ma'lumot yo'q</div>`; pager.style.display='none'; return; }
    const totalPages=Math.ceil(boardUsers.length/BOARD_PAGE_SIZE);
    boardPage=Math.max(0,Math.min(boardPage,totalPages-1));
    const start=boardPage*BOARD_PAGE_SIZE; const pageUsers=boardUsers.slice(start,start+BOARD_PAGE_SIZE);
    root.innerHTML=pageUsers.map((u,i)=>`
      <div class="rank ${start+i<3?'top':''}">
        <div>${start+i+1}</div>
        <div>
          <b>${u.name||'Foydalanuvchi'}</b>
          <div class="sub">ID: ${u.numericId||'‚Äî'}</div>
          <div class="sub">${u.school?`Maktab: ${u.school}`:'Maktab: ‚Äî'} ¬∑ ${u.class?`Sinf: ${u.class}`:'Sinf: ‚Äî'}</div>
        </div>
        <div><b>${u.points||0}</b></div>
      </div>`).join('');
    if(totalPages>1){
      pager.style.display='flex';
      document.getElementById('boardInfo').textContent=`${boardPage+1} / ${totalPages}`;
      document.getElementById('boardPrev').disabled=(boardPage===0);
      document.getElementById('boardNext').disabled=(boardPage>=totalPages-1);
      document.getElementById('boardPrev').onclick=()=>{ boardPage--; drawBoard(); };
      document.getElementById('boardNext').onclick=()=>{ boardPage++; drawBoard(); };
    } else pager.style.display='none';
  }
  function renderBoard(users){ boardUsers=users||[]; drawBoard(); }
  const qTop = query(collection(db,'users'), orderBy('points','desc'), limit(50));
  onSnapshot(qTop, (snap)=>{
    const arr = snap.docs.map(d=>d.data()).map(u=>({
      name: (u.name || u.displayName || (u.email ? u.email.split('@')[0] : 'Foydalanuvchi')),
      numericId: u.numericId,
      points: Number(u.points)||0,
      school: u.school || null,
      class:  u.class  || null
    })).sort((a,b)=> b.points - a.points || (a.numericId??0) - (b.numericId??0));
    renderBoard(arr);
  }, (err)=>{
    console.warn('Leaderboard read blocked:', err?.message||err);
    document.getElementById('boardList').innerHTML = '<div class="sub">Leaderboard hozircha yopiq</div>';
    const pager = document.getElementById('boardPager'); if(pager) pager.style.display='none';
  });

  // ===== Chips / Carousel / Sections =====
  const chipsEl=document.getElementById('chips'); let active=new Set();
  function dynamicChipsFrom(data){
    const set=new Set(['BSB','CHSB','1-chorak','2-chorak','3-chorak','4-chorak']);
    (data.sections||[]).forEach(sec=> (sec.items||[]).forEach(it=> (it.tags||[]).forEach(t=> set.add(t))));
    const arr=[...set]; arr.push('*'); return arr;
  }
  function buildChipsFromData(data){
    const arr=dynamicChipsFrom(data);
    chipsEl.innerHTML=arr.map(k=>`<button class="chip" data-k="${k}">${k==='*'?'Hammasi':k}</button>`).join('');
    chipsEl.querySelectorAll('.chip').forEach(btn=>btn.onclick=()=>{
      const k=btn.dataset.k; if(k==='*'){active.clear(); chipsEl.querySelectorAll('.chip').forEach(b=>b.classList.remove('active'));}
      else{ btn.classList.toggle('active'); if(btn.classList.contains('active')) active.add(k); else active.delete(k); }
      renderSections(window.__data__, true);
    });
  }
  
  function initCarousel(banners){
    const track=document.getElementById('track'), dots=document.getElementById('dots'), prev=document.getElementById('prev'), next=document.getElementById('next');
    if(!banners?.length){ document.getElementById('carousel').style.display='none'; return; }
    
    track.innerHTML=banners.map(b=>{
      if(b.type === 'html') {
        return `<div class="slide"><div class="html-content" style="background:${b.bgColor || 'linear-gradient(135deg, var(--brand), var(--brand2))'}; color:${b.textColor || 'white'}">${b.content}</div></div>`;
      } else {
        return `<a class="slide" href="${b.link||'#'}" target="_blank" rel="noopener"><img src="${b.image}" alt="${b.title||'Banner'}"/></a>`;
      }
    }).join('');
    
    dots.innerHTML=banners.map((_,i)=>`<div class="dot${i===0?' active':''}"></div>`).join('');
    let i=0,n=banners.length,x=0,sx=0,drag=false,auto;
    const set=idx=>{i=(idx+n)%n; track.style.transform=`translateX(-${i*100}%)`; [...dots.children].forEach((d,k)=>d.classList.toggle('active',k===i));};
    const play=()=>{clearInterval(auto);auto=setInterval(()=>set(i+1),3500)}; const stop=()=>clearInterval(auto);
    next.onclick=()=>{set(i+1);play()}; prev.onclick=()=>{set(i-1);play()};
    const onDown=e=>{drag=true;sx=e.touches?e.touches[0].clientX:e.clientX;stop()};
    const onMove=e=>{if(!drag)return; x=(e.touches?e.touches[0].clientX:e.clientX)-sx;track.style.transform=`translateX(calc(${-i*100}% + ${x}px))`};
    const onUp=()=>{if(!drag)return;drag=false; if(Math.abs(x)>50){set(i+(x<0?1:-1))}else set(i); x=0; play();};
    track.addEventListener('touchstart',onDown,{passive:true}); track.addEventListener('touchmove',onMove,{passive:true}); track.addEventListener('touchend',onUp);
    track.addEventListener('mousedown',onDown); window.addEventListener('mousemove',onMove); window.addEventListener('mouseup',onUp);
    set(0); play();
  }
  
  const PAGESIZE = 8; const pageState = new Map();
  
  // Content Modal Functions
  const contentModal = document.getElementById('contentModal');
  const contentModalTitle = document.getElementById('contentModalTitle');
  const contentModalBody = document.getElementById('contentModalBody');
  const contentModalActions = document.getElementById('contentModalActions');
  const closeContentModal = document.getElementById('closeContentModal');
  const startTestBtn = document.getElementById('startTestBtn');
  const contentTimer = document.getElementById('contentTimer');
  
  let testTimer = null;
  let testStartTime = null;
  let testDuration = 0;
  
  closeContentModal.onclick = () => {
    contentModal.style.display = 'none';
    if (testTimer) {
      clearInterval(testTimer);
      testTimer = null;
    }
  };
  
  function formatTime(seconds) {
    const hrs = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }
  
  function startTestTimer(duration) {
    testStartTime = Date.now();
    testDuration = duration;
    
    contentTimer.style.display = 'inline-block';
    contentTimer.textContent = formatTime(duration);
    
    testTimer = setInterval(() => {
      const elapsed = Math.floor((Date.now() - testStartTime) / 1000);
      const remaining = Math.max(0, duration - elapsed);
      contentTimer.textContent = formatTime(remaining);
      
      if (remaining <= 0) {
        clearInterval(testTimer);
        contentTimer.textContent = "Vaqt tugadi!";
        contentTimer.style.background = '#c62828';
      }
    }, 1000);
  }
  
  function openContentModal(item) {
    contentModalTitle.textContent = item.name;
    contentModalBody.innerHTML = item.modalContent || item.description || 'Ma\'lumot mavjud emas.';
    contentModalActions.style.display = 'none';
    contentTimer.style.display = 'none';
    contentTimer.style.background = '';
    
    // Agar test bo'lsa
    if (item.type === 'timed' && item.duration) {
      contentModalActions.style.display = 'flex';
      startTestBtn.onclick = () => {
        startTestTimer(item.duration);
        contentModalActions.style.display = 'none';
        // Testni boshlash logikasi
      };
    }
    
    contentModal.style.display = 'flex';
  }
  
  function createActionButton(item) {
    const now = new Date();
    let startTime = null;
    let endTime = null;
    
    if (item.startTime) startTime = new Date(item.startTime);
    if (item.endTime) endTime = new Date(item.endTime);
    
    // Vaqt chegaralangan test
    if (item.type === 'timed' && startTime && endTime) {
      if (now < startTime) {
        const startStr = startTime.toLocaleDateString('uz-UZ');
        return `<button class="btn" disabled>Boshlanishi: ${startStr}</button>`;
      } else if (now > endTime) {
        return `<button class="btn" disabled>Yakunlangan</button>`;
      } else {
        return `<button class="btn modal-trigger" data-id="${item.id}">Boshlash</button>`;
      }
    }
    
    // Modal kontent
    if (item.type === 'modal' && item.modalContent) {
      return `<button class="btn modal-trigger" data-id="${item.id}">Batafsil</button>`;
    }
    
    // Oddiy havola
    return `<a class="btn" href="${item.link || '#'}" target="_blank" rel="noopener">Boshlash</a>`;
  }
  
  function renderSections(root, filtered=false){
    const wrap=document.getElementById('sections'); wrap.innerHTML='';
    (root.sections||[]).forEach((sec,si)=>{
      if(filtered && active.size){
        const sTitle=sec.title.toLowerCase(); const ok=[...active].every(f=> sTitle.includes(f.toLowerCase()) || (f==='BSB'&&sTitle.includes('bsb')) || (f==='CHSB'&&sTitle.includes('chsb')));
        if(!ok) return;
      }
      let items=sec.items||[];
      if(filtered && active.size){
        items = items.filter(it=>(it.tags||[]).some(tag=>[...active].some(f=>tag.toLowerCase().includes(f.toLowerCase()))));
      }
      if(!items.length) return;

      const section = document.createElement('section'); section.className='sect';
      section.innerHTML = `
        <div class="frame">
          <div class="framehead"><div class="dotcap"></div><h2>${sec.title}</h2></div>
          <div class="grid" id="grid-${si}"></div>
          <div class="pager" id="pager-${si}" style="display:none">
            <button data-prev="${si}">Oldingi</button>
            <div class="info" id="info-${si}"></div>
            <button data-next="${si}">Keyingi</button>
          </div>
        </div>`;
      wrap.appendChild(section);

      const curPage = pageState.get(si) ?? 0;
      const totalPages = Math.ceil(items.length / PAGESIZE);
      const start = curPage * PAGESIZE;
      const visible = items.slice(start, start + PAGESIZE);

      const grid = section.querySelector('#grid-'+si);
      visible.forEach(it=>{
        const el=document.createElement('article'); el.className='card';
        
        const actionButton = createActionButton(it);
        
        el.innerHTML=`
          <div class="thumb ${!it.image ? 'noimg' : ''}">
            ${it.image ? `<img src="${it.image}" alt="" loading="lazy" decoding="async"
               onerror="this.onerror=null; this.parentElement.classList.add('noimg'); this.remove();">` : ``}
            <div class="ov" aria-label="${it.name}"><span class="label">${it.name}</span></div>
            ${it.best ? '<div class="badge">BEST</div>' : ''}
          </div>
          <div class="body">
            <h3 class="name">${it.name}</h3>
            ${it.description?`<p class="desc">${it.description}</p>`:''}
            <div class="tags">${(it.tags || []).map(t=>`<span class="tag">${t}</span>`).join('')}</div>
            <div class="actions">
              ${actionButton}
              ${it.more?`<a class="btn ghost" href="${it.more}" target="_blank" rel="noopener">Qo'shimcha</a>`:''}
            </div>
          </div>`;
        grid.appendChild(el);
      });

      // Modal trigger event listeners
      grid.querySelectorAll('.modal-trigger').forEach(btn => {
        btn.onclick = () => {
          const itemId = btn.dataset.id;
          const item = items.find(i => i.id == itemId);
          if (item) {
            openContentModal(item);
          }
        };
      });

      const pager = section.querySelector('#pager-'+si);
      if (totalPages > 1) {
        pager.style.display = 'flex';
        section.querySelector('#info-'+si).textContent = `Sahifa ${curPage+1} / ${totalPages}`;
        pager.querySelector(`[data-prev="${si}"]`).onclick = ()=>{ pageState.set(si, Math.max(0, curPage-1)); renderSections(root, filtered); };
        pager.querySelector(`[data-next="${si}"]`).onclick = ()=>{ pageState.set(si, Math.min(totalPages-1, curPage+1)); renderSections(root, filtered); };
      } else { pager.style.display='none'; }
    });
  }

  // ===== JSON Content Management =====
  async function fetchContentFromJSON(){
    try {
      const response = await fetch('./data/index.json');
      if (!response.ok) throw new Error('JSON fayl topilmadi');
      return await response.json();
    } catch (error) {
      console.warn('JSON yuklanmadi, standart ma\'lumotlar ishlatiladi:', error);
        ]
      };
    }
  }

  async function init(){
    const data = await fetchContentFromJSON();
    window.__data__ = data;
    buildChipsFromData(data);
    initCarousel(data.banners||[]);
    renderSections(data);
  }
  
  init();
</script>
</body>
</html>