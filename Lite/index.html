<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MathCenter — Bosh sahifa</title>
  <link rel="stylesheet" href="css/style.css"/>
</head>
<body>
  <div id="header"></div>
  <main class="container">
    <section class="hero">
      <h1>Bannerlar</h1>
      <div id="banner-list" class="grid"></div>
    </section>

    <section style="margin-top: 20px;">
      <h2>Testlar</h2>
      <div id="test-grid" class="grid"></div>
    </section>
  </main>
  <footer class="footer">© 2025 MathCenter — “π” brendi</footer>

  <script type="module">
    import { db } from './js/firebase-init.js';
    

function userRole() {
  const u = JSON.parse(localStorage.getItem("mc_user") || "null");
  return u ? (u.role || "user") : null;
}
function renderHeader(active = "home") {
  const user = JSON.parse(localStorage.getItem("mc_user") || "null");
  const role = userRole();
  const authBlock = user
    ? `<span class="badge">ID: ${user.numericId ?? user.id}</span>
       <span class="badge">Ism: ${user.name}</span>
       <span id="pointsBadge" class="badge" style="display:none"></span>
       <a class="btn" href="#" id="logoutBtn">Chiqish</a>`
    : `<a class="btn" href="login.html">Kirish</a>`;

  const adminLink = (role === 'admin' || role === 'superadmin')
    ? `<a class="${active==='admin'?'active':''}" href="admin.html">Admin</a>`
    : ``;

  return `
  <header class="header">
    <div class="header-inner container">
      <div class="brand">
        <div class="pi">π</div>
        <div>MathCenter</div>
      </div>
      <nav class="nav">
        <a class="${active==='home'?'active':''}" href="index.html">Bosh sahifa</a>
        <a class="${active==='rating'?'active':''}" href="rating.html">Reyting</a>
        ${adminLink}
      </nav>
      <div class="auth">${authBlock}</div>
    </div>
  </header>`;
}

async function fillPoints(db) {
  const user = JSON.parse(localStorage.getItem("mc_user") || "null");
  if (!user) return;
  const id = String(user.numericId ?? user.id ?? user.login);
  try {
    const {{ doc, getDoc }} = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
    const ref = doc(db, 'user_points', id);
    const snap = await getDoc(ref);
    const badge = document.getElementById('pointsBadge');
    if (snap.exists()) {
      const pts = snap.data().totalPoints || 0;
      if (badge) {{ badge.textContent = `Ball: ${pts}`; badge.style.display = 'inline-block'; }}
    } else if (badge) {{ badge.textContent = `Ball: 0`; badge.style.display = 'inline-block'; }}
  } catch (e) {
    console.warn('fillPoints error', e);
  }
}

function bindLogout() {
  const btn = document.querySelector("#logoutBtn");
  if (btn) {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      localStorage.removeItem("mc_user");
      location.href = "index.html";
    });
  }
}

document.getElementById('header').innerHTML = renderHeader('home');
// add 'Natijalar' nav link for logged-in users
try{
  const u = JSON.parse(localStorage.getItem('mc_user')||'null');
  if(u){
    const nav = document.querySelector('.nav');
    const a = document.createElement('a');
    a.href = 'scores.html';
    a.textContent = 'Natijalar';
    nav.insertBefore(a, nav.children[1]);
  }
}catch(_){}

    bindLogout();
    fillPoints(db);

    async function loadJSON(path) {
      const res = await fetch(path);
      if (!res.ok) throw new Error('JSON yuklab bo\'lmadi: ' + path);
      return res.json();
    }

    function bannerCard(b) {
      return `
      <article class="banner">
        <img src="${b.image}" alt="${b.title}">
        <div class="copy">
          <h2>${b.title}</h2>
          <p>${b.subtitle || ''}</p>
          <a class="btn btn-primary" href="${b.link}" target="_blank">Batafsil</a>
        </div>
      </article>`;
    }

    function testCard(t) {
      const tags = (t.tags||[]).map(x=>`<span class='badge'>${x}</span>`).join('') + (t.best?` <span class='badge'>BEST</span>`:'');
            
      const now = new Date();
      const start = t.startAt ? new Date(t.startAt) : null;
      const end = t.endAt ? new Date(t.endAt) : null;
      const notStarted = start && now < start;
      const finished = end && now > end;

      let primaryBtn = `<a class="btn btn-primary" href="test.html?id=${encodeURIComponent(t.id)}">Boshlash</a>`;
      if (notStarted) {
        primaryBtn = `<button class="btn btn-primary" disabled>Tez orada (kuting)</button>`;
      } else if (finished) {
        primaryBtn = `<button class="btn" disabled>Muddati tugagan</button>`;
      }

      return `
      <article class="card">
        <img src="${t.image || 'https://picsum.photos/seed/'+encodeURIComponent(t.id)+'/800/450'}" alt="${t.title}">
        <div class="content">
          <h3>${t.title}</h3>
          <div class="muted">Savollar: ${t.questions?.length || 0} • Maks ball: ${(t.questions||[]).reduce((a,q)=>a+(q.points||1),0)}</div>
          <div class="tags">${tags}</div>
          <div style="display:flex; gap:8px; margin-top:8px;">
            ${primaryBtn}
            <a class="btn" href="#" onclick='openDetails(t);return false;'>Batafsil</a>
          </div>
        </div>
      </article>`;
    }

    
    // Modal helpers
    const backdrop = document.getElementById('bestBackdrop');
    const bm = document.getElementById('bestModal');
    const bmTitle = document.getElementById('bmTitle');
    const bmImage = document.getElementById('bmImage');
    const bmDesc = document.getElementById('bmDesc');
    const bmTimes = document.getElementById('bmTimes');
    const bmCountdown = document.getElementById('bmCountdown');
    const bmStartBtn = document.getElementById('bmStartBtn');
    document.getElementById('bmClose').onclick = () => backdrop.style.display='none';

    function openDetails(t){
      bmTitle.textContent = t.title;
      bmImage.src = t.image || 'https://picsum.photos/seed/'+encodeURIComponent(t.id)+'/800/450';
      bmDesc.textContent = t.description || '';
      const s = t.startAt ? new Date(t.startAt) : null;
      const e = t.endAt ? new Date(t.endAt) : null;
      bmTimes.textContent = (s?('Boshlanish: '+s.toLocaleString()+'  '):'') + (e?('• Tugash: '+e.toLocaleString()):'');
      bmStartBtn.href = 'test.html?id='+encodeURIComponent(t.id);
      backdrop.style.display='flex';

      // live countdown
      let tid;
      function upd(){
        const now = new Date();
        const notStarted = s && now < s;
        const finished = e && now > e;
        if (notStarted){
          const ms = s - now;
          const hh = Math.floor(ms/3600000);
          const mm = Math.floor((ms%3600000)/60000);
          const ss = Math.floor((ms%60000)/1000);
          bmCountdown.textContent = `Boshlanishiga: ${hh}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
          bmStartBtn.classList.add('btn'); bmStartBtn.classList.remove('btn-primary'); bmStartBtn.setAttribute('disabled','');
        } else if (finished){
          bmCountdown.textContent = 'Muddati tugagan';
          bmStartBtn.setAttribute('disabled','');
        } else {
          bmCountdown.textContent = 'Ochiq';
          bmStartBtn.removeAttribute('disabled');
          bmStartBtn.classList.add('btn-primary');
        }
        tid = setTimeout(upd, 1000);
      }
      upd();
    }

    (async () => {
      const banners = await loadJSON('assets/banners.json').catch(()=>[]);
      const tests = await loadJSON('assets/tests.json').catch(()=>[]);

      document.getElementById('banner-list').innerHTML = banners.map(bannerCard).join('');
      document.getElementById('test-grid').innerHTML = tests.map(testCard).join('');
    })();
  </script>

  <div class="modal-backdrop" id="bestBackdrop">
    <div class="modal" role="dialog" aria-modal="true" id="bestModal">
      <div class="head">
        <strong id="bmTitle">Batafsil</strong>
        <button class="close-x" id="bmClose">×</button>
      </div>
      <div class="body">
        <img id="bmImage" src="" alt="" style="width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:12px;"/>
        <div id="bmDesc" class="muted"></div>
        <div id="bmTimes" class="muted"></div>
        <div id="bmCountdown" class="badge"></div>
      </div>
      <div class="foot">
        <a class="btn btn-primary" id="bmStartBtn" href="#">Boshlash</a>
      </div>
    </div>
  </div>
</body>
</html>

</html>
