
<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MathCenter — Bosh sahifa</title>
  <link rel="stylesheet" href="css/style.css"/>
</head>
<body>
  <div class="container" style="padding-top:16px;">
    <!-- Header -->
    <header class="header">
      <div class="header-inner">
        <div class="brand">
          <div class="pi">π</div>
          <div>MathCenter</div>
        </div>
        <nav class="nav">
          <a class="active" href="index.html">Bosh sahifa</a>
          <a href="rating.html">Reyting</a>
          <a id="adminLink" href="admin.html" style="display:none">Admin</a>
        </nav>
        <div class="badges" id="authBox">
          <a class="btn btn-ghost" href="login.html">Kirish</a>
        </div>
      </div>
    </header>

    <!-- Hero -->
    <section class="hero">
      <h1>Yangi avlod matematika platformasi</h1>
      <p>Bannerlar, zamonaviy testlar va real vaqt reytingi. O‘quvchilar uchun qulay, administratorlar uchun kuchli boshqaruv.</p>
      <div class="hero-cta">
        <a class="btn btn-primary" href="#tests">Testlarni ko‘rish</a>
        <a class="btn" href="#banners">Bannerlarni ko‘rish</a>
      </div>
    </section>

    <!-- Banners -->
    <div class="section-title" id="banners">
      <h2>Bannerlar</h2>
    </div>
    <div id="banner-list" class="grid"></div>

    <!-- Tests -->
    <div class="section-title" id="tests">
      <h2>Testlar</h2>
      <div class="kpis" id="filters"></div>
    </div>
    <div id="test-grid" class="grid"></div>

    <footer class="footer">© 2025 MathCenter — “π” brendi</footer>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="bestBackdrop">
    <div class="modal" role="dialog" aria-modal="true" id="bestModal">
      <div class="head">
        <strong id="bmTitle">Batafsil</strong>
        <button class="close-x" id="bmClose">×</button>
      </div>
      <div class="body">
        <img id="bmImage" src="" alt="" style="width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:14px;"/>
        <div id="bmDesc" class="muted"></div>
        <div id="bmTimes" class="muted"></div>
        <div id="bmCountdown" class="badge"></div>
      </div>
      <div class="foot">
        <a class="btn btn-primary" id="bmStartBtn" href="#">Boshlash</a>
      </div>
    </div>
  </div>

  <script type="module">
    import { db } from './js/firebase-init.js';

    // --- Header auth / role & points ---
    const u = JSON.parse(localStorage.getItem('mc_user') || 'null');
    const authBox = document.getElementById('authBox');
    const adminLink = document.getElementById('adminLink');
    if (u) {
      authBox.innerHTML = `
        <span class="badge">ID: ${u.numericId ?? u.id ?? u.login}</span>
        <span class="badge">Ism: ${u.name}</span>
        <span id="pointsBadge" class="badge">Ball: 0</span>
        <a class="btn" id="logoutBtn" href="#">Chiqish</a>`;
      if (u.role==='admin' || u.role==='superadmin') adminLink.style.display='inline-flex';
      document.getElementById('logoutBtn').onclick = (e) => { e.preventDefault(); localStorage.removeItem('mc_user'); location.href='index.html'; };
      try {
        const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js");
        const id = String(u.numericId ?? u.id ?? u.login);
        const snap = await getDoc(doc(db, 'user_points', id));
        if (snap.exists()) document.getElementById('pointsBadge').textContent = 'Ball: ' + (snap.data().totalPoints||0);
      } catch(_){}
    }

    // --- Modal logic ---
    const backdrop = document.getElementById('bestBackdrop');
    const bmTitle = document.getElementById('bmTitle');
    const bmImage = document.getElementById('bmImage');
    const bmDesc = document.getElementById('bmDesc');
    const bmTimes = document.getElementById('bmTimes');
    const bmCountdown = document.getElementById('bmCountdown');
    const bmStartBtn = document.getElementById('bmStartBtn');
    document.getElementById('bmClose').onclick = () => backdrop.style.display='none';
    function openDetails(t){
      bmTitle.textContent = t.title;
      bmImage.src = t.image || ('https://picsum.photos/seed/'+encodeURIComponent(t.id)+'/800/450');
      bmDesc.textContent = t.description || '';
      const s = t.startAt ? new Date(t.startAt) : null;
      const e = t.endAt ? new Date(t.endAt) : null;
      bmTimes.textContent = (s?('Boshlanish: '+s.toLocaleString()+'  '):'') + (e?('• Tugash: '+e.toLocaleString()):'');
      bmStartBtn.href = 'test.html?id='+encodeURIComponent(t.id);
      backdrop.style.display='flex';
      function upd(){
        const now = new Date();
        const notStarted = s && now < s;
        const finished = e && now > e;
        if (notStarted){
          const ms = s - now;
          const hh = Math.floor(ms/3600000);
          const mm = Math.floor((ms%3600000)/60000);
          const ss = Math.floor((ms%60000)/1000);
          bmCountdown.textContent = `Boshlanishiga: ${hh}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
          bmStartBtn.setAttribute('disabled','');
        } else if (finished){
          bmCountdown.textContent = 'Muddati tugagan';
          bmStartBtn.setAttribute('disabled','');
        } else {
          bmCountdown.textContent = 'Ochiq';
          bmStartBtn.removeAttribute('disabled');
        }
        if (backdrop.style.display==='flex') setTimeout(upd, 1000);
      }
      upd();
    }
    window.openDetails = openDetails;

    // --- Data loaders ---
    async function loadJSON(path) {
      const res = await fetch(path);
      if (!res.ok) throw new Error('JSON yuklab bo\\'lmadi: ' + path + ' ' + res.status);
      return res.json();
    }

    function bannerCard(b) {
      return `<article class="banner-card">
        <img src="${b.image}" alt="${b.title}">
        <div class="copy">
          <h3>${b.title}</h3>
          <p>${b.subtitle || ''}</p>
          <div class="actions"><a class="btn btn-primary" href="${b.link}" target="_blank">Batafsil</a></div>
        </div>
      </article>`;
    }

    function testCard(t) {
      const total = (t.questions||[]).reduce((a,q)=>a+(q.points||1),0);
      const tags = (t.tags||[]).map(x=>`<span class='tag'>${x}</span>`).join('') + (t.best?` <span class='tag best'>BEST</span>`:'');
      const now = new Date(), s = t.startAt?new Date(t.startAt):null, e = t.endAt?new Date(t.endAt):null;
      const notStarted = s && now < s, finished = e && now > e;
      let primaryBtn = `<a class="btn btn-primary" href="test.html?id=${encodeURIComponent(t.id)}">Boshlash</a>`;
      if (notStarted) primaryBtn = `<button class="btn btn-primary" disabled>Tez orada</button>`;
      else if (finished) primaryBtn = `<button class="btn" disabled>Muddati tugagan</button>`;
      return `<article class="test-card">
        <img src="${t.image || ('https://picsum.photos/seed/'+encodeURIComponent(t.id)+'/800/450')}" alt="${t.title}">
        <div class="content">
          <div class="title"><h3>${t.title}</h3><div class="kpis"><span class="chip">Savollar: ${(t.questions||[]).length}</span><span class="chip">Maks: ${total}</span></div></div>
          <div class="tags">${tags}</div>
          <div class="actions">
            ${primaryBtn}
            <a class="btn btn-ghost" href="#" onclick='openDetails(t);return false;'>Batafsil</a>
          </div>
        </div>
      </article>`;
    }

    (async () => {
      const banners = await loadJSON('assets/banners.json').catch(()=>[]);
      const tests = await loadJSON('assets/tests.json').catch(()=>[]);
      document.getElementById('banner-list').innerHTML = banners.map(bannerCard).join('') || '<div class="badge">Banner yo\\'q</div>';
      document.getElementById('test-grid').innerHTML = tests.map(t=>{ window.t=t; return testCard(t); }).join('') || '<div class="badge">Testlar yo\\'q</div>';
    })();
  </script>
</body>
</html>
