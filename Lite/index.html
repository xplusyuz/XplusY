<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>LeaderMath ‚Äî Mobil (PWA) ‚Äî JSON content</title>
  <meta name="theme-color" content="#2E8B57" id="meta-theme-color"/>
  <meta name="color-scheme" content="dark light"/>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./favicon.ico">
  <style>/* (same styles as before) */ :root{--brand:#2E8B57;--brand2:#1F6B45;--bg:#f6faf8;--text:#0f172a;--muted:#6b7c75;--card:#ffffff;--frame:#e3efe8;--frame-dark:#163d2d;--chip:#e9f5ef;--chip-b:#cfe9dc;--radius:18px} :root.dark{--bg:#0b0f0e; --text:#EAF7F0; --muted:#A8BBB3; --card:#0f1714; --frame:#244b39; --frame-dark:#112a1f; --chip:#0f221b; --chip-b:#2a5a45;} *{box-sizing:border-box} html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif} .appbar{position:sticky;top:0;z-index:90;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:10px 12px;display:flex;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(0,0,0,.12)} .logo{width:40px;height:40px;border-radius:14px;background:#fff2;display:grid;place-items:center;font-weight:800} .title{font-weight:800;font-size:18px} .sub{font-size:11px;color:var(--muted)} .spacer{flex:1} .iconbtn{background:#ffffff22;border:1px solid #ffffff33;color:#fff;border-radius:12px;padding:8px 10px;font-weight:700;cursor:pointer} .userbar{background:var(--card);border:1px dashed var(--frame);border-radius:14px;margin:10px 12px;padding:10px;display:flex;align-items:center;gap:10px;box-shadow:0 8px 20px #0001} .ava{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand2));display:grid;place-items:center;color:#fff;font-weight:800} .uinfo{line-height:1.2}.uinfo b{display:block}.uvals{margin-left:auto;text-align:right;font-size:12px} .board{background:var(--card);border:1px dashed var(--frame);border-radius:16px;margin:10px 12px;padding:12px} .board h3{margin:0 0 8px;font-size:16px} .rank{display:grid;grid-template-columns:32px 1fr auto;gap:8px;align-items:center;padding:8px;border-radius:10px;border:1px dashed var(--frame);margin-bottom:6px;background:linear-gradient(180deg,#ffffff,#ffffff00)} .rank.top{background:linear-gradient(0deg,#f6fffb,#ffffff)} .chips{position:sticky;top:62px;z-index:80;background:var(--bg);padding:8px 12px;display:flex;gap:8px;overflow:auto} .chip{white-space:nowrap;font-size:12px;color:#0b3d2a;background:var(--chip);border:1px solid var(--chip-b);padding:7px 10px;border-radius:999px} .chip.active{outline:2px solid var(--brand)} .carousel{position:relative;overflow:hidden;border-radius:var(--radius); margin:0 12px;} .track{display:flex;transition:transform .45s cubic-bezier(.2,.8,.2,1)} .slide{min-width:100%;aspect-ratio:16/9;position:relative} .slide img{width:100%;height:100%;object-fit:cover;display:block} .dots{position:absolute;inset:auto 0 8px;display:flex;justify-content:center;gap:6px} .dot{width:8px;height:8px;border-radius:10px;background:#1113} .dot.active{width:18px;background:#111} .cbtn{position:absolute;top:50%;transform:translateY(-50%);background:#0007;color:#fff;border:none;width:38px;height:38px;border-radius:12px;display:grid;place-items:center} .cbtn.left{left:8px}.cbtn.right{right:8px} .sect{margin-top:16px} .frame{border:1px dashed var(--frame); border-radius:18px; padding:12px; background:linear-gradient(180deg,#ffffffcc,#ffffff00);} .framehead{display:flex;align-items:center;gap:8px;margin:0 2px 10px;border-bottom:1px dashed var(--frame);padding-bottom:8px} .framehead .dotcap{width:10px;height:10px;border-radius:50%;background:var(--brand)} .framehead h2{margin:0;font-size:18px;font-weight:900;color:var(--brand2);letter-spacing:.2px} .grid{display:grid;grid-template-columns:1fr;gap:12px} @media (min-width:480px){.grid{grid-template-columns:1fr 1fr}} @media (min-width:768px){.grid{grid-template-columns:repeat(3,1fr)}} .card{background:var(--card);border-radius:14px;overflow:hidden;box-shadow:0 10px 24px rgba(0,0,0,.06);border:1px dashed var(--frame)} .thumb{aspect-ratio:16/9;background:#e6efe9;position:relative} .thumb img{width:100%;height:100%;object-fit:cover;display:block} .badge{position:absolute;top:8px;left:8px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700} .body{padding:12px} .name{font-size:15px;font-weight:800;margin:0 0 6px} .desc{font-size:13px;color:var(--muted);line-height:1.4;margin:0 0 10px} .tags{display:flex;flex-wrap:wrap;gap:6px;margin:0 0 10px} .tag{font-size:11px;color:#0b3d2a;background:#e9f5ef;border:1px solid #cfe9dc;padding:5px 8px;border-radius:999px} .actions{display:flex;gap:8px} .btn{flex:1;display:inline-flex;align-items:center;justify-content:center;gap:8px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;border:none;border-radius:12px;padding:12px 14px;font-weight:800;font-size:14px;cursor:pointer} .btn.ghost{background:#f0f7f3;color:#0b3d2a;border:1px solid var(--frame)} .pager{display:flex;justify-content:space-between;align-items:center;margin-top:10px} .pager button{background:#e9f5ef;border:1px solid #cfe9dc;color:#0b3d2a;border-radius:10px;padding:8px 10px;font-weight:700} .dark .iconbtn{ background:#ffffff22; color:#fff; border:1px solid #ffffff33 } .dark .userbar,.dark .board{ border-color:var(--frame); background:var(--card) } .dark .rank{ border-color:var(--frame); background:linear-gradient(180deg,#0f1714,#0f171400) } .dark .rank.top{ background:linear-gradient(0deg,#13251c,#0f1714) } .dark .chip,.dark .tag{ color:var(--text); background:var(--chip); border-color:var(--chip-b) } .dark .btn.ghost{ background:#ffffff0a; color:#text; border:1px solid var(--frame) } .dark .dot{ background:#ffffff55 } .dark .dot.active{ background:#fff } .dark .thumb{ background:#12211a } .dark .frame{ border-color:var(--frame); background:linear-gradient(180deg,#0f1714cc,#0f171400) } .dark .framehead h2{ color:#d6f2e6 } .thumb{ position:relative; overflow:hidden; border-radius:16px; } .thumb.noimg{ background:linear-gradient(135deg,#e9f2ee 0%,#f6fbf8 100%); } .dark .thumb.noimg{ background:linear-gradient(135deg,#0f1d17,#0b1310); } .thumb img{ width:100%; height:100%; object-fit:cover; display:block; } .thumb .ov{ position:absolute; inset:0; display:grid; place-items:center; padding:12px; background:linear-gradient(180deg,transparent 45%, rgba(0,0,0,.45) 100%); } .thumb .label{ display:inline-block; padding:.7em 1.25em; border-radius:18px; font-weight:900; font-size:clamp(18px,4.6vw,26px); letter-spacing:.3px; color:#fff; background:linear-gradient(180deg, rgba(255,255,255,.24), rgba(255,255,255,.10)); border:1px solid rgba(255,255,255,.38); box-shadow:0 10px 28px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.45); backdrop-filter: blur(8px) saturate(130%); text-shadow:0 2px 12px rgba(0,0,0,.35); transform: translateY(0); transition: transform .25s ease, box-shadow .25s ease; } .card:hover .label{ transform: translateY(-2px); box-shadow:0 14px 34px rgba(0,0,0,.32), inset 0 1px 0 rgba(255,255,255,.55); } .modal-mask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);z-index:9999} .modal{width:min(680px,94%);background:#fff;border-radius:14px;border:1px solid var(--frame);box-shadow:0 20px 60px rgba(0,0,0,.25);padding:14px} .modal h3{margin:0 0 8px;color:#1F6B45} .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px} .grid1{display:grid;grid-template-columns:1fr;gap:10px} .ctl label{font-size:12px;color:#6b7c75;display:block;margin-bottom:4px} .ctl input,.ctl textarea{ width:100%;padding:10px;border:1px solid var(--frame);border-radius:10px;font:inherit;background:#fff } .row{display:flex;gap:8px;justify-content:flex-end;margin-top:12px} .btns{display:flex;gap:8px} .danger{color:#c62828;font-size:12px} .req{color:#c62828} .dark .modal{background:#0f1714;border-color:var(--frame)} .dark .ctl input,.dark .ctl textarea{background:#0f1714;color:var(--text);border-color:var(--frame)}</style>
</head>
<body>
  <!-- Appbar -->
  <header class="appbar">
    <div class="logo">L</div>
    <div><div class="title">LeaderMath</div><div class="sub">BSB / CHSB dars resurslari</div></div>
    <div class="spacer"></div>
    <button id="themeBtn" class="iconbtn" title="Dark/Light">üåô</button>
    <button id="installBtn" class="iconbtn" title="Ilova sifatida o‚Äòrnatish">‚¨áÔ∏è</button>
  </header>

  <!-- User bar (kept as-is for compatibility) -->
  <section class="userbar" id="userbar">
    <div class="ava" id="ava">LM</div>
    <div class="uinfo">
      <b id="uname">Mehmon</b>
      <span class="sub" id="uid">ID: ‚Äî</span>
      <div class="sub" id="uschool" style="margin-top:2px">‚Äî</div>
      <div class="sub" id="uclass">‚Äî</div>
    </div>
    <div class="uvals">
      <div><b id="points">Ball: ‚Äî</b></div>
      <div style="margin-top:4px">
        <a href="#" id="editProfile" class="sub" style="display:none">Profil</a> ¬∑
        <a href="#" id="signin" class="sub">Kirish</a> ¬∑
        <a href="#" id="signout" class="sub" style="display:none">Chiqish</a> ¬∑
        <a class="sub" href="./admin.html" id="adminLink">Admin</a>
      </div>
    </div>
  </section>

  <!-- Leaderboard -->
  <section class="board" id="board">
    <h3>Top 50 ‚Äî Ball bo‚Äòyicha</h3>
    <div id="boardList"></div>
    <div id="boardPager" class="pager" style="display:none">
      <button id="boardPrev">Oldingi</button>
      <div class="info" id="boardInfo"></div>
      <button id="boardNext">Keyingi</button>
    </div>
  </section>

  <!-- Chips -->
  <div class="chips" id="chips"></div>

  <!-- Carousel -->
  <section class="carousel" id="carousel" style="margin-top:6px">
    <button class="cbtn left" aria-label="Oldingi" id="prev">‚Äπ</button>
    <div class="track" id="track"></div>
    <button class="cbtn right" aria-label="Keyingi" id="next">‚Ä∫</button>
    <div class="dots" id="dots"></div>
  </section>

  <!-- Sections -->
  <div class="container" style="padding:6px 12px 88px">
    <div id="sections"></div>
    <div style="height:24px"></div>
  </div>

  <!-- Detail modal -->
  <div id="detailModal" class="modal-mask" aria-modal="true" role="dialog">
    <div class="modal" id="detailContent">
      <h3 id="detailTitle">Batafsil</h3>
      <div id="detailBody">
        <!-- image + text will be inserted here -->
      </div>
      <div class="row" style="margin-top:12px">
        <div class="btns"><button id="detailClose" class="iconbtn">Yopish</button></div>
      </div>
    </div>
  </div>

<script type="module">
  // ---------------- Theme + PWA (same as before) ----------------
  const root=document.documentElement, themeBtn=document.getElementById('themeBtn'), THEME_KEY='lm-theme';
  const metaTheme=document.getElementById('meta-theme-color');
  const setTheme=m=>{ root.classList.toggle('dark',m==='dark'); localStorage.setItem(THEME_KEY,m); themeBtn.textContent=m==='dark'?'‚òÄÔ∏è':'üåô'; metaTheme.setAttribute('content', m==='dark' ? '#0b0f0e' : '#2E8B57'); };
  setTheme(localStorage.getItem(THEME_KEY)||(matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
  themeBtn.onclick=()=>setTheme(root.classList.contains('dark')?'light':'dark');
  let deferredPrompt; const installBtn=document.getElementById('installBtn');
  window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredPrompt=e;installBtn.style.display='inline-block';});
  installBtn.onclick=async()=>{if(!deferredPrompt)return;deferredPrompt.prompt();await deferredPrompt.userChoice;deferredPrompt=null;installBtn.style.display='none';};
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./service-worker.js'); }

  // ---------------- Data source: index.json ----------------
  // Expected schema for index.json (example):
  // {
  //   "banners": [ { "image": "...", "title":"...", "link":"...", "order":0, "active":true } ],
  //   "sections": [
  //     {
  //       "title":"Matematika", "order":0, "active":true,
  //       "items": [
  //         {
  //           "id":"item1", "name":"Dars 1", "description":"...", "image":"...",
  //           "tags":["BSB"], "best":true,
  //           "start": { "type":"open" /* | "closed" | "scheduled" */, "url":"/lesson/1" , "label":"Kirish" , "opens":"2025-10-23T10:00:00+05:00", "closes":"2025-10-24T10:00:00+05:00" },
  //           "more": "./more/1.html",
  //           "detail": { "title":"Dars 1 ‚Äî Batafsil", "image":"...", "html":"<p>Matn...</p>" }
  //         }
  //       ]
  //     }
  //   ]
  // }

  async function fetchContentFromJson(){
    try{
      const res = await fetch('./index.json', {cache: 'no-store'});
      if(!res.ok) throw new Error('index.json topilmadi');
      const data = await res.json();
      // normalize structure
      data.banners = (data.banners||[]).filter(b=>b.active!==false).sort((a,b)=> (a.order||0)-(b.order||0));
      data.sections = (data.sections||[]).filter(s=>s.active!==false).map(s=>({ ...s, items: (s.items||[]).filter(i=> i.active!==false) }));
      data.sections.sort((a,b)=> (a.order||0)-(b.order||0));
      data.sections.forEach(s=>{
        s.items.sort((a,b)=> (b.best?1:0)-(a.best?1:0));
        s.items.sort((a,b)=> (a.order||0)-(b.order||0));
      });
      return data;
    }catch(e){ console.warn('index.json yuklashda xato', e); return { banners: [], sections: [] }; }
  }

  // ---------------- UI helpers ----------------
  const chipsEl=document.getElementById('chips'); let active=new Set();
  function dynamicChipsFrom(data){ const set=new Set(['BSB','CHSB','1-chorak','2-chorak','3-chorak','4-chorak']); (data.sections||[]).forEach(sec=> (sec.items||[]).forEach(it=> (it.tags||[]).forEach(t=> set.add(t)))); const arr=[...set]; arr.push('*'); return arr; }
  function buildChipsFromData(data){ const arr=dynamicChipsFrom(data); chipsEl.innerHTML=arr.map(k=>`<button class="chip" data-k="${k}">${k==='*'?'Hammasi':k}</button>`).join(''); chipsEl.querySelectorAll('.chip').forEach(btn=>btn.onclick=()=>{ const k=btn.dataset.k; if(k==='*'){ active.clear(); chipsEl.querySelectorAll('.chip').forEach(b=>b.classList.remove('active')); } else { btn.classList.toggle('active'); if(btn.classList.contains('active')) active.add(k); else active.delete(k); } renderSections(window.__data__, true); }); }

  // ---------------- Carousel (same as before) ----------------
  function initCarousel(banners){ const track=document.getElementById('track'), dots=document.getElementById('dots'), prev=document.getElementById('prev'), next=document.getElementById('next'); if(!banners?.length){ document.getElementById('carousel').style.display='none'; return; } track.innerHTML=banners.map(b=>`<a class="slide" href="${b.link||'#'}" target="_blank" rel="noopener"><img src="${b.image}" alt="${b.title||'Banner'}"/></a>`).join(''); dots.innerHTML=banners.map((_,i)=>`<div class="dot${i===0?' active':''}"></div>`).join(''); let i=0,n=banners.length,auto; const set=idx=>{ i=(idx+n)%n; track.style.transform=`translateX(-${i*100}%)`; [...dots.children].forEach((d,k)=>d.classList.toggle('active',k===i)); }; const play=()=>{ clearInterval(auto); auto=setInterval(()=>set(i+1),3500) }; const stop=()=>clearInterval(auto); next.onclick=()=>{ set(i+1); play() }; prev.onclick=()=>{ set(i-1); play() }; set(0); play(); }

  // ---------------- Detail modal ----------------
  const detailMask = document.getElementById('detailModal'); const detailBody = document.getElementById('detailBody'); const detailTitle = document.getElementById('detailTitle'); document.getElementById('detailClose').onclick = ()=>{ detailMask.style.display='none'; detailBody.innerHTML=''; };
  function openDetail(detail){ detailTitle.textContent = detail.title || 'Batafsil'; detailBody.innerHTML = `
    ${detail.image?`<div style="margin-bottom:10px"><img src="${detail.image}" alt="" style="width:100%;height:auto;border-radius:8px"></div>`:''}
    <div>${detail.html|| (detail.text?`<p>${detail.text}</p>`:'')}</div>
  `; detailMask.style.display='flex'; }

  // ---------------- Render sections & button logic ----------------
  const PAGESIZE = 8; const pageState = new Map();
  function renderSections(root, filtered=false){ const wrap=document.getElementById('sections'); wrap.innerHTML=''; (root.sections||[]).forEach((sec,si)=>{
    if(filtered && active.size){ const sTitle=sec.title.toLowerCase(); const ok=[...active].every(f=> sTitle.includes(f.toLowerCase()) || (f==='BSB'&&sTitle.includes('bsb')) || (f==='CHSB'&&sTitle.includes('chsb'))); if(!ok) return; }
    let items=sec.items||[];
    if(filtered && active.size){ items = items.filter(it=> (it.tags||[]).some(tag=> [...active].some(f=> tag.toLowerCase().includes(f.toLowerCase())))); }
    if(!items.length) return;

    const section = document.createElement('section'); section.className='sect';
    section.innerHTML = `
      <div class="frame">
        <div class="framehead"><div class="dotcap"></div><h2>${sec.title}</h2></div>
        <div class="grid" id="grid-${si}"></div>
        <div class="pager" id="pager-${si}" style="display:none">
          <button data-prev="${si}">Oldingi</button>
          <div class="info" id="info-${si}"></div>
          <button data-next="${si}">Keyingi</button>
        </div>
      </div>`;
    wrap.appendChild(section);

    const curPage = pageState.get(si) ?? 0; const totalPages = Math.ceil(items.length / PAGESIZE); const start = curPage * PAGESIZE; const visible = items.slice(start, start + PAGESIZE);
    const grid = section.querySelector('#grid-'+si);

    visible.forEach(it=>{
      const card = document.createElement('article'); card.className='card';
      const detailBtn = it.detail ? `<button class="btn ghost" data-detail="${it.id||''}">Batafsil</button>` : '';

      // create start button markup depending on start.type
      const startInfo = it.start || { type: 'open', url: it.link||'#', label: 'Boshlash' };
      const now = new Date();
      let startHtml = '';
      try{
        if(startInfo.type === 'open'){
          startHtml = `<a class="btn" href="${startInfo.url||it.link||'#'}" target="_blank" rel="noopener">${startInfo.label||'Boshlash'}</a>`;
        } else if(startInfo.type === 'closed'){
          startHtml = `<button class="btn" disabled>${startInfo.label?startInfo.label+' (Tez orada)': 'Yopiq (Tez orada)'} </button>`;
        } else if(startInfo.type === 'scheduled'){
          const opens = startInfo.opens ? new Date(startInfo.opens) : null; const closes = startInfo.closes ? new Date(startInfo.closes) : null;
          const isOpen = opens && closes ? (now >= opens && now <= closes) : (opens ? now >= opens : false);
          if(isOpen){ startHtml = `<a class="btn" href="${startInfo.url||it.link||'#'}" target="_blank" rel="noopener">${startInfo.label||'Boshlash'}</a>`; }
          else{
            const label = opens ? `Ochiladi: ${opens.toLocaleString()}` : (closes?`YopiÃÅladi: ${closes.toLocaleString()}`:'Tez orada');
            startHtml = `<button class="btn" disabled>${startInfo.label?startInfo.label+' ('+label+')': label}</button>`;
          }
        } else {
          startHtml = `<a class="btn" href="${startInfo.url||it.link||'#'}" target="_blank" rel="noopener">${startInfo.label||'Boshlash'}</a>`;
        }
      }catch(e){ startHtml = `<a class="btn" href="${startInfo.url||it.link||'#'}" target="_blank" rel="noopener">${startInfo.label||'Boshlash'}</a>`; }

      card.innerHTML = `
        <div class="thumb ${!it.image ? 'noimg' : ''}">
          ${it.image ? `<img src="${it.image}" alt="" loading="lazy" decoding="async" onerror="this.onerror=null; this.parentElement.classList.add('noimg'); this.remove();">` : ``}
          <div class="ov" aria-label="${it.name}"><span class="label">${it.name}</span></div>
          ${it.best ? '<div class="badge">BEST</div>' : ''}
        </div>
        <div class="body">
          <h3 class="name">${it.name}</h3>
          ${it.description?`<p class="desc">${it.description}</p>`:''}
          <div class="tags">${(it.tags || []).map(t=>`<span class="tag">${t}</span>`).join('')}</div>
          <div class="actions">
            ${startHtml}
            ${detailBtn}
          </div>
        </div>`;

      grid.appendChild(card);

      // attach detail handler if exists
      if(it.detail){ const btn = card.querySelector('[data-detail]'); if(btn){ btn.addEventListener('click', (e)=>{ e.preventDefault(); openDetail(it.detail); }); } }
    });

    const pager = section.querySelector('#pager-'+si);
    if(totalPages>1){ pager.style.display='flex'; section.querySelector('#info-'+si).textContent = `Sahifa ${curPage+1} / ${totalPages}`; pager.querySelector(`[data-prev="${si}"]`).onclick = ()=>{ pageState.set(si, Math.max(0, curPage-1)); renderSections(root, filtered); }; pager.querySelector(`[data-next="${si}"]`).onclick = ()=>{ pageState.set(si, Math.min(totalPages-1, curPage+1)); renderSections(root, filtered); }; } else { pager.style.display='none'; }
  }); }

  // ---------------- Init ----------------
  async function init(){
    const data = await fetchContentFromJson(); window.__data__ = data; buildChipsFromData(data); initCarousel(data.banners||[]); renderSections(data);

    // Re-load index.json every 30s to pick up admin changes (optional)
    setInterval(async()=>{ const d=await fetchContentFromJson(); window.__data__=d; buildChipsFromData(d); initCarousel(d.banners||[]); renderSections(d); }, 30000);
  }
  init();
</script>
</body>
</html>
