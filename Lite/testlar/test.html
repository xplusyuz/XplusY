<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MathCenter — Test</title>

  <!-- KaTeX (matematika) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-3UI2q6Ica4G1w8sYw9QF8aHbf5qjYINgUO8k6r8w4j8mI2nJvK4x1m0o0xqHLffa" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" integrity="sha384-nlXv0m8KZP8pQp9uYwT9Cq2y0xV+3ZbJrKpQhYwR5V1bQk3s8v9U4n5Q3q2q9H8Q" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" integrity="sha384-kWPLU2G9bqC5zTz8ZQv1g8f1pKxq9B8s4c4k9j5r3v2wq1lqX0Gg7r7E0I0s5R7v" crossorigin="anonymous"></script>

  <style>
    :root {
      --green: #2E8B57;
      --green-dark: #1F6B45;
      --bg: #f7faf8;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #475569;
      --ring: rgba(46,139,87,.25);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, #f1f8f4 0%, #f7faf8 100%);
    }
    .wrap {
      max-width: 980px;
      margin: 32px auto;
      padding: 0 16px;
    }
    .header {
      background: radial-gradient(1200px 600px at -10% -10%, #e8f5ee, transparent 60%),
                  radial-gradient(1200px 600px at 110% -10%, #e3f3ec, transparent 60%);
      border: 1px solid #e6efe8;
      border-radius: 20px;
      padding: 20px;
      display: grid;
      gap: 10px;
      box-shadow: 0 10px 30px rgba(31,107,69,.08);
    }
    .title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 22px;
    }
    .title .pi {
      width: 36px; height: 36px; border-radius: 12px;
      display: grid; place-items: center;
      background: linear-gradient(135deg, var(--green), var(--green-dark));
      color:#fff; font-weight: 800; box-shadow: 0 6px 18px rgba(46,139,87,.35);
    }
    .sub { color: var(--muted); font-size: 14px; }
    .meta {
      display: flex; flex-wrap: wrap; gap: 10px;
      color: #0b3a25; font-size: 13px;
    }
    .chip {
      border: 1px solid #d8e9df;
      background: #ffffffc9;
      padding: 8px 10px;
      border-radius: 999px;
    }

    .card {
      margin-top: 18px;
      background: var(--card);
      border: 1px solid #e6efe8;
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 8px 24px rgba(31,107,69,.06);
    }

    .q {
      padding: 14px 12px;
      border: 1px solid #eef4ef;
      border-radius: 14px;
      margin-bottom: 14px;
    }
    .qhead {
      display: flex; justify-content: space-between; align-items: baseline; gap: 12px;
      margin-bottom: 8px;
    }
    .qname { font-weight: 700; }
    .qpts { color: var(--muted); font-size: 13px; }
    .qtext { line-height: 1.6; margin: 8px 0 10px; }
    .opts { display: grid; gap: 10px; }
    .opt {
      display: grid; grid-template-columns: 24px 1fr; gap: 10px; align-items: start;
      padding: 10px 12px; border: 1px solid #edf3ee; border-radius: 12px; background: #fbfdfc;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .opt:hover { border-color: var(--green); box-shadow: 0 0 0 4px var(--ring); background: #fff; }
    .opt input { transform: translateY(2px); }
    .actions {
      display: flex; flex-wrap: wrap; gap: 10px; justify-content: space-between; align-items: center;
      margin-top: 18px;
    }
    .btn {
      appearance: none; border: none; cursor: pointer;
      padding: 12px 16px; border-radius: 12px; font-weight: 700;
      background: linear-gradient(135deg, var(--green), var(--green-dark)); color: white;
      box-shadow: 0 10px 24px rgba(46,139,87,.35);
    }
    .btn.secondary {
      background: #fff; color: var(--green-dark); border: 1px solid #cfe4d7; box-shadow: none;
    }
    .muted { color: var(--muted); font-size: 14px; }

    .hidden { display: none !important; }
    .center { text-align: center; }

    .score {
      display: grid; gap: 10px;
      padding: 16px; border: 1px dashed #cfe4d7; border-radius: 14px; background: #f8fbf9;
    }
    .score .big { font-weight: 800; font-size: 22px; color: var(--green-dark); }
    .divider { height: 1px; background: #edf3ee; margin: 8px 0; }

    /* Timer chip */
    .timer {
      padding: 8px 10px; border: 1px solid #d8e9df; border-radius: 999px; background:#fff;
      font-variant-numeric: tabular-nums; font-weight: 700; color: #0b3a25;
    }
    .timer.warn { color: #a15b00; border-color: #f5d7b4; background: #fff9f0; }
    .timer.crit { color: #a11212; border-color: #f2c6c6; background: #fff4f4; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <section class="header card">
      <div class="title">
        <div class="pi">π</div>
        <div id="testTitle">Test</div>
      </div>
      <div id="testDesc" class="sub">Matematika testiga xush kelibsiz.</div>
      <div class="meta">
        <div id="metaCount" class="chip">Savollar: —</div>
        <div id="metaPoints" class="chip">Umumiy ball: —</div>
        <div id="metaType" class="chip">—</div>
        <div id="metaTimer" class="chip timer hidden">00:00</div>
      </div>
    </section>

    <!-- Questions -->
    <section id="questionsCard" class="card">
      <div id="questionsContainer"></div>
      <div class="actions">
        <button id="submitBtn" class="btn">Testni yakunlash</button>
        <div class="muted">Javoblarni tekshirishdan oldin barchasini to‘ldiring.</div>
      </div>
    </section>

    <!-- Result -->
    <section id="resultCard" class="card hidden">
      <div class="score">
        <div class="big" id="scoreText">Natija: 0 / 0</div>
        <div id="detailText" class="muted">To‘g‘ri javoblar soni: 0 ta</div>
        <div class="divider"></div>
        <div class="actions">
          <button class="btn secondary" onclick="location.reload()">Qayta boshlash</button>
          <button class="btn" id="reviewBtn">To‘g‘ri javoblarni ko‘rish</button>
        </div>
      </div>
    </section>

    <!-- Empty -->
    <section id="emptyCard" class="card hidden center">
      <h3>Test topilmadi</h3>
      <p class="muted">
        `localStorage['testData']` bo‘sh. <br>
        <b>Variant 1:</b> <i>admintest.html</i> sahifasidan “Export to JSON” bosib, so‘ng “Preview Test” qiling. <br>
        <b>Variant 2:</b> Shu papkaga <code>test.json</code> qo‘ying — bu sahifa uni avtomatik o‘qiydi.
      </p>
    </section>
  </div>

  <script>
    // ====== Global holatlar ======
    let testData = null;
    let timerId = null;
    let timeLeftSec = 0;
    let submitted = false;

    // ====== Util ======
    function $(sel) { return document.querySelector(sel); }
    function el(tag, props = {}, ...children) {
      const n = document.createElement(tag);
      Object.entries(props).forEach(([k, v]) => {
        if (k === 'class') n.className = v;
        else if (k === 'html') n.innerHTML = v;
        else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
        else n.setAttribute(k, v);
      });
      for (const c of children) n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c);
      return n;
    }
    const sum = arr => arr.reduce((a,b)=>a+b,0);

    // ====== YUKLASH: localStorage -> test.json fallback ======
    async function loadTestData() {
      // 1) localStorage
      const stored = localStorage.getItem('testData');
      if (stored) {
        try {
          testData = JSON.parse(stored);
          displayTest();
          return;
        } catch (e) {
          console.error('localStorage testData parse xatosi:', e);
        }
      }
      // 2) test.json fallback
      try {
        const res = await fetch('test.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('test.json topilmadi yoki o‘qilmadi');
        testData = await res.json();
        displayTest();
      } catch (err) {
        console.warn('test.json fetch bo‘lmadi:', err);
        showNoTest();
      }
    }

    // ====== UI ko‘rsatish ======
    function showNoTest() {
      $('#questionsCard').classList.add('hidden');
      $('#resultCard').classList.add('hidden');
      $('#emptyCard').classList.remove('hidden');
    }

    function displayTest() {
      if (!testData || !Array.isArray(testData.questions) || testData.questions.length === 0) {
        showNoTest();
        return;
      }

      // Header metalar
      $('#testTitle').textContent = testData.title || 'Test';
      $('#testDesc').textContent = testData.description || 'Matematika testi';
      $('#metaCount').textContent = `Savollar: ${testData.questions.length}`;
      const totalPts = testData.questions.map(q => Number(q.points || 1)).reduce((a,b)=>a+b,0);
      $('#metaPoints').textContent = `Umumiy ball: ${totalPts}`;
      $('#metaType').textContent = (testData.type || 'aralash').toUpperCase();

      // Timer (ixtiyoriy)
      const minutes = Number(testData.durationMinutes || 0);
      if (minutes > 0) {
        timeLeftSec = Math.round(minutes * 60);
        $('#metaTimer').classList.remove('hidden');
        updateTimerBadge();
        timerId = setInterval(tick, 1000);
      } else {
        $('#metaTimer').classList.add('hidden');
      }

      // Savollar
      const box = $('#questionsContainer');
      box.innerHTML = '';
      testData.questions.forEach((q, i) => {
        const qi = renderQuestion(q, i);
        box.appendChild(qi);
      });

      // KaTeX: DOMga joylangandan keyin
      if (typeof renderMathInElement === 'function') {
        renderMathInElement(box, {
          delimiters: [
            { left: '$$', right: '$$', display: true },
            { left: '$',  right: '$',  display: false },
            { left: '\\(', right: '\\)', display: false },
            { left: '\\[', right: '\\]', display: true }
          ],
          throwOnError: false
        });
      }

      // Tugmalar
      $('#submitBtn').onclick = onSubmit;
      $('#reviewBtn').onclick = revealCorrect;
    }

    function renderQuestion(q, idx) {
      const qwrap = el('div', { class: 'q', id: `q-${idx}` });

      const head = el('div', { class: 'qhead' },
        el('div', { class: 'qname' }, `#${idx + 1}`),
        el('div', { class: 'qpts' }, `${q.points || 1} ball`)
      );

      const qtext = el('div', { class: 'qtext' });
      // Matn ichida LaTeX bo‘lishi mumkin; textContent saqlab, KaTeX auto-render qilsin
      qtext.textContent = q.questionText || `Savol ${idx+1}`;

      const opts = el('div', { class: 'opts' });

      // SINGLE/MULTI aniqlash
      const isMulti =
        (q.type && String(q.type).toLowerCase() === 'multi') ||
        Array.isArray(q.correctIndices);

      const name = `q_${idx}`;
      const options = Array.isArray(q.options) ? q.options : [];
      options.forEach((opt, j) => {
        const id = `${name}_${j}`;
        const input = el('input', { type: isMulti ? 'checkbox' : 'radio', name, id, value: j });
        const label = el('label', { for: id }, (typeof opt === 'string' ? opt : String(opt)));
        const row = el('div', { class: 'opt' }, input, label);
        opts.appendChild(row);
      });

      qwrap.appendChild(head);
      qwrap.appendChild(qtext);
      qwrap.appendChild(opts);
      return qwrap;
    }

    // ====== Timer ======
    function tick() {
      if (submitted) { clearInterval(timerId); return; }
      timeLeftSec--;
      updateTimerBadge();
      if (timeLeftSec <= 0) {
        clearInterval(timerId);
        onSubmit(); // vaqt tugasa avtomatik yakun
      }
    }
    function updateTimerBadge() {
      const b = $('#metaTimer');
      const m = Math.max(0, Math.floor(timeLeftSec / 60));
      const s = Math.max(0, timeLeftSec % 60);
      b.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      b.classList.toggle('warn', timeLeftSec <= 60 * 3 && timeLeftSec > 60);
      b.classList.toggle('crit', timeLeftSec <= 60);
    }

    // ====== Natija hisoblash ======
    function onSubmit() {
      if (submitted) return;
      submitted = true;

      // Javoblarni yig‘ish va ball hisoblash
      let gained = 0;
      let correctCount = 0;
      const perQ = [];

      testData.questions.forEach((q, i) => {
        const points = Number(q.points || 1);
        const name = `q_${i}`;
        const isMulti =
          (q.type && String(q.type).toLowerCase() === 'multi') ||
          Array.isArray(q.correctIndices);

        // user tanlovi
        let chosen = [];
        if (isMulti) {
          chosen = Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(x => Number(x.value));
        } else {
          const r = document.querySelector(`input[name="${name}"]:checked`);
          if (r) chosen = [Number(r.value)];
        }

        const correct = isMulti ? (q.correctIndices || []) : [Number(q.correctIndex ?? -1)];
        const ok = arraysEqualUnordered(chosen, correct);

        if (ok) {
          gained += points;
          correctCount++;
        }
        perQ.push({ i, ok, points, chosen, correct });
      });

      const totalPts = sum(testData.questions.map(q => Number(q.points || 1)));
      // UI
      $('#questionsCard').classList.add('hidden');
      $('#resultCard').classList.remove('hidden');
      $('#scoreText').textContent = `Natija: ${gained} / ${totalPts}`;
      $('#detailText').textContent = `To‘g‘ri javoblar: ${correctCount} ta / ${testData.questions.length} ta`;
      // (ixtiyoriy) bu yerda Firebase’ga yozish kiritilishi mumkin
    }

    function arraysEqualUnordered(a, b) {
      if (a.length !== b.length) return false;
      const as = [...a].sort((x,y)=>x-y);
      const bs = [...b].sort((x,y)=>x-y);
      return as.every((v,i)=>v===bs[i]);
    }

    function revealCorrect() {
      // To‘g‘ri javoblarni ko‘rsatish uchun savollar kartasini qayta ochamiz
      $('#resultCard').classList.add('hidden');
      $('#questionsCard').classList.remove('hidden');

      testData.questions.forEach((q, i) => {
        const wrap = document.getElementById(`q-${i}`);
        if (!wrap) return;

        const isMulti =
          (q.type && String(q.type).toLowerCase() === 'multi') ||
          Array.isArray(q.correctIndices);
        const correct = isMulti ? (q.correctIndices || []) : [Number(q.correctIndex ?? -1)];

        const inputs = wrap.querySelectorAll('input');
        inputs.forEach(inp => {
          const v = Number(inp.value);
          const row = inp.closest('.opt');
          row.style.borderColor = '#edf3ee';
          row.style.boxShadow = 'none';
          row.style.background = '#fbfdfc';

          if (correct.includes(v)) {
            row.style.borderColor = 'rgba(46,139,87,.55)';
            row.style.boxShadow = '0 0 0 4px ' + 'rgba(46,139,87,.18)';
            row.style.background = '#f3fbf6';
          }
        });
      });
    }

    // ====== Start ======
    document.addEventListener('DOMContentLoaded', loadTestData);
  </script>
</body>
</html>
