<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MathCenter — Test (1-by-1 + MathJax + Firebase)</title>

  <!-- MathJax v3 (TeX/LaTeX) -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']],
        processEscapes: true,
        packages: {'[+]': ['noerrors']}
      },
      options: { renderActions: { addMenu: [] } },
      loader: { load: ['[tex]/noerrors'] }
    };
  </script>
  <script id="MathJax-script" async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root {
      --green:#2E8B57; --green-dark:#1F6B45;
      --red:#c62828; --red-bg:#fff2f2; --red-ring:rgba(198,40,40,.18);
      --ok-bg:#f3fbf6; --ok-bd:#cfe4d7;
      --bg:#f7faf8; --card:#fff; --text:#0f172a; --muted:#475569;
      --outline:#e6efe8; --ring:rgba(46,139,87,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif;
      color:var(--text);
      background:linear-gradient(180deg,#f1f8f4 0%,#f7faf8 100%);
    }
    .wrap{max-width:980px;margin:26px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--outline);border-radius:18px;padding:18px;box-shadow:0 8px 24px rgba(31,107,69,.06)}
    .header{background:
      radial-gradient(1200px 600px at -10% -10%, #e8f5ee, transparent 60%),
      radial-gradient(1200px 600px at 110% -10%, #e3f3ec, transparent 60%);
      display:grid;gap:10px}
    .title{display:flex;align-items:center;gap:12px;font-weight:700;font-size:22px}
    .pi{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(135deg,var(--green),var(--green-dark));color:#fff;font-weight:800;box-shadow:0 6px 18px rgba(46,139,87,.35)}
    .sub{color:var(--muted);font-size:14px}
    .meta{display:flex;flex-wrap:wrap;gap:10px;color:#0b3a25;font-size:13px}
    .chip{border:1px solid #d8e9df;background:#ffffffc9;padding:8px 10px;border-radius:999px;font-variant-numeric:tabular-nums}
    .timer.warn{color:#a15b00;border-color:#f5d7b4;background:#fff9f0}
    .timer.crit{color:#a11212;border-color:#f2c6c6;background:#fff4f4}

    .qwrap{display:grid;gap:12px}
    .qhead{display:flex;justify-content:space-between;align-items:baseline;gap:12px}
    .qname{font-weight:700}
    .qpts{color:var(--muted);font-size:13px}
    .qtext{line-height:1.65}
    .opts{display:grid;gap:10px}
    .opt{display:grid;grid-template-columns:24px 1fr;gap:10px;align-items:start;padding:10px 12px;border:1px solid #edf3ee;border-radius:12px;background:#fbfdfc;transition:border-color .15s,box-shadow .15s,background .15s}
    .opt:hover{border-color:var(--green);box-shadow:0 0 0 4px var(--ring);background:#fff}
    .opt input{transform:translateY(2px)}

    .actions{display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;margin-top:16px}
    .btn{appearance:none;border:none;cursor:pointer;padding:12px 16px;border-radius:12px;font-weight:700;background:linear-gradient(135deg,var(--green),var(--green-dark));color:#fff;box-shadow:0 10px 24px rgba(46,139,87,.35)}
    .btn.secondary{background:#fff;color:var(--green-dark);border:1px solid #cfe4d7;box-shadow:none}
    .btn.warn{background:linear-gradient(135deg,#e65100,#bf360c)}
    .btn.ghost{background:#fff;color:#0b3a25;border:1px dashed #cfe4d7}

    .hidden{display:none !important}
    .muted{color:var(--muted);font-size:14px}
    .divider{height:1px;background:#edf3ee;margin:8px 0}

    /* Navigator — bottom */
    .navwrap{margin-top:16px}
    .navlegend{display:flex;gap:12px;align-items:center;color:var(--muted);font-size:13px;margin-bottom:8px}
    .dot{width:10px;height:10px;border-radius:50%}
    .navgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(40px,1fr));gap:10px}
    .navbtn{
      appearance:none; border:1px solid var(--outline); background:#fff; color:#0b3a25;
      border-radius:12px; padding:10px 0; cursor:pointer; font-weight:800;
      transition: box-shadow .15s, border-color .15s, background .15s, transform .04s;
    }
    .navbtn:active{transform:translateY(1px)}
    .navbtn.current{background:linear-gradient(135deg,var(--green),var(--green-dark));color:#fff;border-color:transparent}
    .navbtn.answered:not(.current){background:var(--ok-bg);border-color:var(--ok-bd);color:#0b3a25}
    .navbtn.unanswered:not(.current){background:var(--red-bg);border-color:#f1c9c9;color:var(--red);box-shadow:0 0 0 3px var(--red-ring)}

    /* Result */
    .score{display:grid;gap:10px;padding:16px;border:1px dashed #cfe4d7;border-radius:14px;background:#f8fbf9}
    .big{font-weight:800;font-size:22px;color:var(--green-dark)}
    .kpi{display:flex;flex-wrap:wrap;gap:10px}
    .kpi .chip{background:#fff}
    .danger{color:var(--red)}
    .ok{color:var(--green-dark)}
    .authbar{display:flex;gap:10px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <section class="header card">
      <div class="title">
        <div class="pi">π</div>
        <div id="testTitle">Test</div>
      </div>
      <div id="testDesc" class="sub">Matematika testiga xush kelibsiz.</div>
      <div class="meta">
        <div id="metaCount" class="chip">Savollar: —</div>
        <div id="metaPoints" class="chip">Umumiy ball: —</div>
        <div id="metaType" class="chip">—</div>
        <div id="metaTimer" class="chip timer hidden">00:00</div>
        <div id="authInfo" class="chip">Kirish: tekshirilmoqda…</div>
      </div>
    </section>

    <!-- One-by-one Question View -->
    <section id="questionsCard" class="card">
      <div id="questionView" class="qwrap"></div>

      <!-- Bottom Navigator -->
      <div class="navwrap">
        <div class="navlegend">
          <span class="dot" style="background:var(--red)"></span> qizil — yechilmagan
          <span class="dot" style="background:var(--green)"></span> yashil — yechilgan
          <span class="dot" style="background:linear-gradient(135deg,var(--green),var(--green-dark))"></span> current
        </div>
        <div id="navgrid" class="navgrid"></div>
      </div>

      <div class="actions">
        <div style="display:flex; gap:8px;">
          <button id="prevBtn" class="btn secondary">⬅️ Oldingi</button>
          <button id="nextBtn" class="btn secondary">Keyingi ➡️</button>
        </div>
        <button id="submitBtn" class="btn warn">Testni yakunlash</button>
      </div>
      <div class="muted" style="margin-top:6px;">Navigator raqamiga bosib savolga o‘ting. Belgilanganda raqam yashil bo‘ladi.</div>
    </section>

    <!-- Result -->
    <section id="resultCard" class="card hidden">
      <div class="score">
        <div class="big" id="scoreText">Natija: 0 / 0</div>
        <div class="kpi">
          <div id="kpiPercent" class="chip">Foiz: 0%</div>
          <div id="kpiCorrect" class="chip">To‘g‘ri: 0 ta</div>
          <div id="kpiTime" class="chip">Vaqt: —</div>
          <div id="kpiSaved" class="chip">Saqlash: —</div>
        </div>
        <div id="resultMsg" class="muted">Zo‘r ish!</div>
        <div class="divider"></div>
        <div class="actions">
          <div class="authbar">
            <button id="signinBtn" class="btn ghost hidden">Google bilan kirish</button>
            <span id="userName" class="muted"></span>
          </div>
          <div style="display:flex; gap:8px; margin-left:auto;">
            <button class="btn secondary" onclick="location.reload()">Qayta boshlash</button>
            <button class="btn" id="reviewBtn">To‘g‘ri javoblarni ko‘rish</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Empty -->
    <section id="emptyCard" class="card hidden" style="text-align:center">
      <h3>Test topilmadi</h3>
      <p class="muted">
        <code>localStorage['testData']</code> bo‘sh. <br>
        <b>1-variant:</b> <i>admintest.html</i> → “Export to JSON” → “Preview Test”. <br>
        <b>2-variant:</b> Shu papkaga <code>test.json</code> qo‘ying — sahifa uni avtomatik o‘qiydi.
      </p>
    </section>
  </div>

  <!-- Firebase (modular SDK) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, updateDoc, runTransaction, serverTimestamp, collection, addDoc, increment
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // === YOUR PROJECT (xplusy) ===
    const firebaseConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.firebasestorage.app",
      messagingSenderId: "992512966017",
      appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId: "G-459PLJ7P7L"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const provider = new GoogleAuthProvider();

    await setPersistence(auth, browserLocalPersistence);

    // ====== Test logic (non-module script depends on globals) ======
    window.__firebase = { app, auth, db, provider, signInWithPopup, signOut, onAuthStateChanged, serverTimestamp, addDoc, collection, increment, runTransaction, doc, setDoc, updateDoc };
  </script>

  <script>
    // ====== Global ======
    let testData = null;
    let currentIndex = 0;
    let answers = [];
    let timerId = null;
    let timeLeftSec = 0;
    let submitted = false;
    let startedAt = new Date();

    // Firebase handles
    let fb = null;
    let currentUser = null;

    // ====== Helpers ======
    const $ = sel => document.querySelector(sel);
    const sum = arr => arr.reduce((a,b)=>a+b,0);
    const isMulti = q =>
      (q.type && String(q.type).toLowerCase() === 'multi') ||
      Array.isArray(q.correctIndices);

    function arraysEqualUnordered(a, b) {
      if (a.length !== b.length) return false;
      const as = [...a].sort((x,y)=>x-y);
      const bs = [...b].sort((x,y)=>x-y);
      return as.every((v,i)=>v===bs[i]);
    }
    async function typeset(el) {
      if (window.MathJax && MathJax.typesetPromise) {
        try { await MathJax.typesetPromise([el]); } catch (e) {}
      }
    }
    const pad2 = n => String(Math.max(0,n)).padStart(2,'0');

    // ====== Load test data (localStorage -> test.json fallback) ======
    async function loadTestData() {
      const stored = localStorage.getItem('testData');
      if (stored) {
        try { testData = JSON.parse(stored); initTest(); return; }
        catch(e){ console.error('localStorage parse xato:', e); }
      }
      try {
        const r = await fetch('test.json', { cache: 'no-store' });
        if (!r.ok) throw new Error('test.json o‘qilmadi');
        testData = await r.json();
        initTest();
      } catch (e) {
        console.warn(e);
        showNoTest();
      }
    }

    function showNoTest() {
      $('#questionsCard').classList.add('hidden');
      $('#resultCard').classList.add('hidden');
      $('#emptyCard').classList.remove('hidden');
    }

    // ====== Init and Render ======
    function initTest() {
      if (!testData || !Array.isArray(testData.questions) || testData.questions.length === 0) {
        showNoTest(); return;
      }
      const qn = testData.questions.length;
      answers = Array.from({length: qn}, () => []);

      // Header meta
      $('#testTitle').textContent = testData.title || 'Test';
      $('#testDesc').textContent = testData.description || 'Matematika testi';
      $('#metaCount').textContent = `Savollar: ${qn}`;
      const totalPts = testData.questions.map(q => Number(q.points || 1)).reduce((a,b)=>a+b,0);
      $('#metaPoints').textContent = `Umumiy ball: ${totalPts}`;
      $('#metaType').textContent = (testData.type || 'aralash').toUpperCase();

      // Timer
      const minutes = Number(testData.durationMinutes || 0);
      const tEl = $('#metaTimer');
      if (minutes > 0) {
        timeLeftSec = Math.round(minutes * 60);
        tEl.classList.remove('hidden');
        updateTimerBadge();
        timerId = setInterval(tick, 1000);
      } else {
        tEl.classList.add('hidden');
      }

      // Navigator build
      buildNavigator();

      // Controls
      $('#prevBtn').onclick = () => gotoQuestion(currentIndex - 1);
      $('#nextBtn').onclick = () => gotoQuestion(currentIndex + 1);
      $('#submitBtn').onclick = onSubmit;
      $('#reviewBtn').onclick = revealCorrect;

      // First question
      gotoQuestion(0);
    }

    function buildNavigator() {
      const grid = $('#navgrid');
      grid.innerHTML = '';
      testData.questions.forEach((_, i) => {
        const b = document.createElement('button');
        b.className = 'navbtn';
        b.textContent = i + 1;
        b.addEventListener('click', () => gotoQuestion(i));
        b.id = `navbtn-${i}`;
        grid.appendChild(b);
      });
      refreshNavigator();
    }

    function refreshNavigator() {
      testData.questions.forEach((_, i) => {
        const b = document.getElementById(`navbtn-${i}`);
        if (!b) return;
        b.classList.toggle('current', i === currentIndex);
        const answered = (answers[i] && answers[i].length > 0);
        b.classList.toggle('answered', answered);
        b.classList.toggle('unanswered', !answered);
      });
    }

    async function gotoQuestion(i) {
      const n = testData.questions.length;
      if (i < 0) i = 0;
      if (i >= n) i = n - 1;
      currentIndex = i;
      await renderCurrentQuestion();
      refreshNavigator();
      updatePrevNextState();
    }

    function updatePrevNextState() {
      $('#prevBtn').disabled = (currentIndex === 0);
      $('#nextBtn').disabled = (currentIndex === testData.questions.length - 1);
    }

    async function renderCurrentQuestion() {
      const q = testData.questions[currentIndex];
      const wrap = $('#questionView');
      wrap.innerHTML = '';

      const head = document.createElement('div');
      head.className = 'qhead';
      head.appendChild(Object.assign(document.createElement('div'), {className:'qname', textContent:`#${currentIndex+1}`}));
      head.appendChild(Object.assign(document.createElement('div'), {className:'qpts',  textContent:`${q.points||1} ball`}));

      const qtext = document.createElement('div');
      qtext.className = 'qtext';
      qtext.textContent = q.questionText || `Savol ${currentIndex+1}`;

      const opts = document.createElement('div');
      opts.className = 'opts';

      const multi = isMulti(q);
      const nameAttr = `q_${currentIndex}`;
      const chosen = answers[currentIndex] || [];

      (Array.isArray(q.options) ? q.options : []).forEach((opt, j) => {
        const row = document.createElement('div'); row.className = 'opt';
        const inp = document.createElement('input');
        inp.type = multi ? 'checkbox' : 'radio';
        inp.name = nameAttr; inp.value = String(j); inp.id = `${nameAttr}_${j}`;
        if (multi) inp.checked = chosen.includes(j);
        else inp.checked = chosen.length ? (chosen[0]===j) : false;
        inp.addEventListener('change', () => {
          if (multi) {
            const prev = new Set(answers[currentIndex] || []);
            if (inp.checked) prev.add(j); else prev.delete(j);
            answers[currentIndex] = Array.from(prev).sort((a,b)=>a-b);
          } else {
            answers[currentIndex] = inp.checked ? [j] : [];
          }
          refreshNavigator();
        });

        const lbl = document.createElement('label');
        lbl.setAttribute('for', inp.id);
        lbl.textContent = (typeof opt === 'string' ? opt : String(opt));

        row.appendChild(inp); row.appendChild(lbl);
        opts.appendChild(row);
      });

      wrap.appendChild(head);
      wrap.appendChild(qtext);
      wrap.appendChild(opts);

      await typeset(wrap);
    }

    // ====== Timer ======
    function tick() {
      if (submitted) { clearInterval(timerId); return; }
      timeLeftSec--;
      updateTimerBadge();
      if (timeLeftSec <= 0) {
        clearInterval(timerId);
        onSubmit();
      }
    }
    function updateTimerBadge() {
      const b = $('#metaTimer');
      const m = Math.max(0, Math.floor(timeLeftSec / 60));
      const s = Math.max(0, timeLeftSec % 60);
      b.textContent = `${pad2(m)}:${pad2(s)}`;
      b.classList.toggle('warn', timeLeftSec <= 180 && timeLeftSec > 60);
      b.classList.toggle('crit', timeLeftSec <= 60);
    }

    // ====== Submit / Score ======
    async function onSubmit() {
      if (submitted) return;
      submitted = true;

      let gained = 0, correctCount = 0;
      testData.questions.forEach((q, i) => {
        const pts = Number(q.points || 1);
        const multi = isMulti(q);
        const chosen = answers[i] || [];
        const correct = multi ? (q.correctIndices || []) : [Number(q.correctIndex ?? -1)];
        const ok = arraysEqualUnordered(chosen, correct);
        if (ok) { gained += pts; correctCount++; }
      });

      const totalPts = sum(testData.questions.map(q => Number(q.points || 1)));
      const percent = totalPts ? Math.round((gained / totalPts) * 100) : 0;
      const finishedAt = new Date();
      const spentSec = Math.max(0, Math.round((finishedAt - startedAt) / 1000));
      const tMM = Math.floor(spentSec / 60), tSS = spentSec % 60;

      // UI
      $('#questionsCard').classList.add('hidden');
      $('#resultCard').classList.remove('hidden');
      $('#scoreText').textContent = `Natija: ${gained} / ${totalPts}`;
      $('#kpiPercent').textContent = `Foiz: ${percent}%`;
      $('#kpiCorrect').textContent = `To‘g‘ri: ${correctCount} ta / ${testData.questions.length} ta`;
      $('#kpiTime').textContent = `Vaqt: ${pad2(tMM)}:${pad2(tSS)}`;
      $('#resultMsg').textContent = percent >= 86 ? 'Ajoyib! 🔥'
                                : percent >= 70 ? 'Barakalla! 💪'
                                : percent >= 50 ? 'Yaxshi urinish. Davom eting. 🙂'
                                : 'Yaxshilash mumkin. Mashqni ko‘paytiring. 📚';

      // Firebase: save result if signed in; otherwise show sign-in button
      const infoEl = $('#kpiSaved');
      const nameEl = $('#userName');
      const signinBtn = $('#signinBtn');

      if (!fb) fb = window.__firebase;
      fb.onAuthStateChanged(fb.auth, async (user) => {
        currentUser = user;
        if (user) {
          $('#authInfo').textContent = `Kirish: ${user.displayName||user.email}`;
          nameEl.textContent = user.displayName ? `👤 ${user.displayName}` : `👤 ${user.email}`;
          signinBtn.classList.add('hidden');
          try {
            await saveResultToFirebase({
              uid: user.uid,
              testId: testData.id || (testData.title || 'unknown').toLowerCase().replace(/\s+/g,'-'),
              score: gained, total: totalPts, percent,
              startedAt: startedAt, finishedAt: finishedAt
            });
            infoEl.textContent = 'Saqlash: ✅ Firestorega yozildi';
          } catch (e) {
            console.error(e);
            infoEl.textContent = 'Saqlash: ❌ Xatolik';
          }
        } else {
          $('#authInfo').textContent = 'Kirish: mehmon';
          nameEl.textContent = 'Saqlash uchun Google bilan kiring';
          signinBtn.classList.remove('hidden');
          signinBtn.onclick = async () => {
            try {
              await fb.signInWithPopup(fb.auth, fb.provider);
            } catch (e) {
              console.error(e);
              infoEl.textContent = 'Saqlash: ❌ Login xatosi';
            }
          };
          infoEl.textContent = 'Saqlash: ⏳ Kirish kutilmoqda';
        }
      });
    }

    async function saveResultToFirebase({ uid, testId, score, total, percent, startedAt, finishedAt }) {
      const { db, serverTimestamp, addDoc, collection, increment, runTransaction, doc, setDoc, updateDoc } = fb;

      // 1) results kolleksiyasiga yozish
      await addDoc(collection(db, 'results'), {
        uid, testId, score, total, percent,
        startedAt: startedAt ? startedAt.toISOString() : null,
        finishedAt: finishedAt ? finishedAt.toISOString() : null,
        createdAt: serverTimestamp()
      });

      // 2) users/{uid} da points inkrement
      const uref = doc(db, 'users', uid);
      try {
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(uref);
          if (!snap.exists()) {
            tx.set(uref, { points: score, updatedAt: serverTimestamp() }, { merge: true });
          } else {
            tx.update(uref, { points: increment(score), updatedAt: serverTimestamp() });
          }
        });
      } catch (e) {
        // Agar transaction xato bersa, oddiy update bilan urinib ko‘ramiz
        await setDoc(uref, { points: score, updatedAt: serverTimestamp() }, { merge: true });
      }
    }

    function revealCorrect() {
      // Ko‘rish rejimi: hozirgi savolda to‘g‘ri variantlar yashil konturda ko‘rinadi.
      $('#resultCard').classList.add('hidden');
      $('#questionsCard').classList.remove('hidden');

      const highlight = () => {
        const q = testData.questions[currentIndex];
        const multi = isMulti(q);
        const correct = multi ? (q.correctIndices || []) : [Number(q.correctIndex ?? -1)];
        document.querySelectorAll('#questionView .opt').forEach(row => {
          row.style.borderColor = '#edf3ee';
          row.style.boxShadow = 'none';
          row.style.background = '#fbfdfc';
        });
        document.querySelectorAll('#questionView input').forEach(inp => {
          const v = Number(inp.value);
          const row = inp.closest('.opt');
          if (correct.includes(v)) {
            row.style.borderColor = 'rgba(46,139,87,.55)';
            row.style.boxShadow = '0 0 0 4px rgba(46,139,87,.18)';
            row.style.background = '#f3fbf6';
          }
        });
      };

      renderCurrentQuestion().then(highlight);
    }

    // ====== Auth banner on header ======
    document.addEventListener('DOMContentLoaded', () => {
      if (window.__firebase) {
        fb = window.__firebase;
        fb.onAuthStateChanged(fb.auth, (user) => {
          currentUser = user;
          $('#authInfo').textContent = user
            ? `Kirish: ${user.displayName||user.email}`
            : 'Kirish: mehmon';
        });
      }
      startedAt = new Date();
      loadTestData();
    });
  </script>
</body>
</html>
