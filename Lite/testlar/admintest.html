<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Test Creation Admin Panel + Math Keyboard</title>

  <!-- KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

  <style>
    :root{
      --primary:#4361ee;--secondary:#3f37c9;--success:#4cc9f0;--light:#f8f9fa;--dark:#212529;--danger:#e63946;--warning:#fca311;
      --kbd-bg:#ffffff;--kbd-border:#e6e8ef;--kbd-shadow:0 12px 30px rgba(0,0,0,.12);
      --kbd-tab:#eef1ff;--kbd-tab-active:#dfe4ff;--kbd-btn:#f6f7fb;--kbd-btn-hover:#eef0f7;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif}
    body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1200px;margin:0 auto}
    .card{background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.1);padding:25px;margin-bottom:25px}
    h1,h2,h3{color:var(--dark);margin-bottom:15px}
    h1{text-align:center;margin-bottom:30px;color:#fff;text-shadow:0 2px 5px rgba(0,0,0,.2)}
    .form-group{margin-bottom:20px}
    label{display:block;margin-bottom:8px;font-weight:600;color:var(--dark)}
    input,textarea,select{width:100%;padding:12px 15px;border:1px solid #ddd;border-radius:8px;font-size:16px;transition:.25s}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(67,97,238,.2)}
    .btn{padding:12px 16px;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;transition:.25s}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-primary:hover{background:var(--secondary);transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .btn-danger{background:var(--danger);color:#fff}.btn-danger:hover{background:#c1121f}
    .btn-success{background:var(--success);color:#fff}.btn-success:hover{background:#3a86ff}
    .question-block{border:1px solid #eee;border-radius:8px;padding:20px;margin-bottom:20px;background:#f9f9f9}
    .option-row{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .option-row input[type="text"]{flex:1}
    .latex-preview{background:#f5f5f5;border-radius:6px;padding:10px;margin-top:10px;min-height:40px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;margin-top:30px}
    .test-info{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    @media (max-width:768px){.test-info{grid-template-columns:1fr}.actions{flex-direction:column}.actions .btn{width:100%}}

    /* ===== Math Keyboard ===== */
    .math-kbd{
      position:absolute; /* desktop: near target; mobile: fixed bottom */
      z-index:9999; background:var(--kbd-bg); border:1px solid var(--kbd-border);
      border-radius:12px; box-shadow:var(--kbd-shadow); width:min(940px,96vw);
      user-select:none; display:none;
    }
    .math-kbd.header{
      display:flex
    }
    .math-kbd .mk-head{
      display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--kbd-border); background:#fafbff; border-radius:12px 12px 0 0;
      gap:8px
    }
    .mk-drag{cursor:move;color:#5f6dff;font-weight:700}
    .mk-tabs{display:flex;flex-wrap:wrap;gap:6px}
    .mk-tab{
      padding:6px 10px;border-radius:8px;background:var(--kbd-tab);border:1px solid var(--kbd-border);font-size:13px;cursor:pointer
    }
    .mk-tab.active{background:var(--kbd-tab-active);border-color:#c7cffb}
    .mk-actions{display:flex;gap:6px}
    .mk-btn{
      padding:8px 10px;border-radius:8px;border:1px solid var(--kbd-border);background:var(--kbd-btn);cursor:pointer;font-weight:600;font-size:13px
    }
    .mk-btn:hover{background:var(--kbd-btn-hover)}
    .mk-body{padding:10px 12px}
    .mk-group{display:none}
    .mk-group.active{display:block}
    .mk-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px}
    .mk-key{
      display:flex;align-items:center;justify-content:center;padding:10px;border:1px solid var(--kbd-border);border-radius:10px;background:#fff;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:14px;cursor:pointer
    }
    .mk-key small{opacity:.65;font-size:11px;margin-left:4px}
    .mk-key:hover{background:#f7f8ff}
    .mk-row{display:flex;gap:8px;flex-wrap:wrap}
    .mk-spacer{height:8px}
    .mk-footer{display:flex;gap:8px;justify-content:flex-end;padding:8px 12px;border-top:1px solid var(--kbd-border)}
    .mk-close{background:#fff0f0;border-color:#ffd3d3}
    .mk-close:hover{background:#ffe6e6}
    .mk-pin.active{background:#e8fff6;border-color:#b6f3db}
    .mk-help{font-size:13px;color:#667}
    @media (max-width:768px){
      .math-kbd{position:fixed;left:2vw;right:2vw;bottom:10px}
    }
    .input-has-kbd{outline:2px dashed rgba(67,97,238,.35) !important}
  </style>
</head>
<body>
  <div class="container">
    <h1>Test Creation Admin Panel</h1>

    <div class="card">
      <h2>Test Information</h2>
      <div class="test-info">
        <div class="form-group">
          <label for="testTitle">Test Title</label>
          <input type="text" id="testTitle" placeholder="Enter test title">
        </div>
        <div class="form-group">
          <label for="totalTime">Total Time (minutes)</label>
          <input type="number" id="totalTime" min="1" value="60">
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Questions</h2>
      <div id="questionsContainer"></div>
      <button id="addQuestion" class="btn btn-primary">Add Question</button>
    </div>

    <div class="actions">
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="previewTest" class="btn btn-success">Preview Test</button>
        <button id="exportTest" class="btn btn-primary">Export to JSON</button>
        <button id="clearAll" class="btn btn-danger">Clear All</button>
      </div>
      <div class="mk-help">LaTeX yozish uchun: $$ … $$ (display) yoki $ … $ (inline). Klaviatura fokusda avtomatik ochiladi.</div>
    </div>
  </div>

  <!-- ===== Math Keyboard (floating) ===== -->
  <div id="mathKeyboard" class="math-kbd" role="dialog" aria-label="Math Keyboard">
    <div class="mk-head">
      <div class="mk-drag" title="Drag">⠿ Math Keyboard</div>
      <div class="mk-tabs" id="mkTabs"></div>
      <div class="mk-actions">
        <button class="mk-btn mk-insert" data-insert="$ $">Inline $…$</button>
        <button class="mk-btn mk-insert" data-insert="$$ $$">Display $$…$$</button>
        <button id="mkPin" class="mk-btn mk-pin" title="Pin/Unpin">📌 Pin</button>
      </div>
    </div>
    <div class="mk-body" id="mkBody"></div>
    <div class="mk-footer">
      <button id="mkClose" class="mk-btn mk-close">Close ✕</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      /* ==================== EXISTING APP LOGIC ==================== */
      addQuestion();
      document.getElementById('addQuestion').addEventListener('click', addQuestion);
      document.getElementById('exportTest').addEventListener('click', exportToJSON);
      document.getElementById('clearAll').addEventListener('click', clearAll);
      document.getElementById('previewTest').addEventListener('click', previewTest);

      function addQuestion(){
        const questionsContainer=document.getElementById('questionsContainer');
        const questionIndex=questionsContainer.children.length+1;
        const block=document.createElement('div');
        block.className='question-block';
        block.innerHTML=`
          <h3>Question ${questionIndex}</h3>
          <div class="form-group">
            <label>Question Text (LaTeX supported)</label>
            <textarea class="question-text" placeholder="Enter your question text here..."></textarea>
            <div class="latex-preview"></div>
          </div>
          <div class="form-group">
            <label>Points</label>
            <input type="number" class="question-points" min="1" value="1">
          </div>
          <div class="form-group">
            <label>Options (LaTeX supported)</label>
            <div class="options-container">
              <div class="option-row">
                <input type="radio" name="correct-${questionIndex}" value="0" checked>
                <input type="text" class="option-text" placeholder="Option 1">
                <button class="btn btn-danger remove-option">Remove</button>
              </div>
              <div class="option-row">
                <input type="radio" name="correct-${questionIndex}" value="1">
                <input type="text" class="option-text" placeholder="Option 2">
                <button class="btn btn-danger remove-option">Remove</button>
              </div>
            </div>
            <button class="btn btn-primary add-option">Add Option</button>
          </div>
          <button class="btn btn-danger remove-question">Remove Question</button>
        `;
        questionsContainer.appendChild(block);

        const qTextarea=block.querySelector('.question-text');
        const previewDiv=block.querySelector('.latex-preview');
        qTextarea.addEventListener('input', () => renderLatex(qTextarea.value, previewDiv));
        renderLatex(qTextarea.value, previewDiv);

        block.querySelector('.add-option').addEventListener('click', function () {
          addOption(block.querySelector('.options-container'));
        });

        block.querySelector('.remove-question').addEventListener('click', function(){
          block.remove(); updateQuestionNumbers();
        });

        block.querySelectorAll('.remove-option').forEach(btn=>{
          btn.addEventListener('click', function(){
            const cont=this.closest('.options-container');
            if(cont.children.length>2) this.parentElement.remove();
            else alert('Each question must have at least two options.');
          });
        });

        // hook math keyboard
        hookMathKeyboard(block);
      }

      function addOption(container){
        const optionCount=container.children.length;
        const name=container.querySelector('input[type="radio"]').name;
        const row=document.createElement('div');
        row.className='option-row';
        row.innerHTML=`
          <input type="radio" name="${name}" value="${optionCount}">
          <input type="text" class="option-text" placeholder="Option ${optionCount+1}">
          <button class="btn btn-danger remove-option">Remove</button>
        `;
        container.appendChild(row);
        row.querySelector('.remove-option').addEventListener('click', function(){
          if(container.children.length>2) this.parentElement.remove();
          else alert('Each question must have at least two options.');
        });
        // hook keyboard for new input
        hookMathKeyboard(row);
      }

      function updateQuestionNumbers(){
        document.querySelectorAll('.question-block').forEach((q,i)=>{
          q.querySelector('h3').textContent=`Question ${i+1}`;
        });
      }

      function renderLatex(text, el){
        if(text.trim()===''){ el.innerHTML='<em>LaTeX preview will appear here</em>'; return; }
        try{
          el.textContent='';
          const tmp=document.createElement('div'); tmp.innerHTML=text;
          el.innerHTML=tmp.innerHTML;
          renderMathInElement(el,{
            delimiters:[
              {left:'$$',right:'$$',display:true},
              {left:'$',right:'$',display:false},
              {left:'\\(',right:'\\)',display:false},
              {left:'\\[',right:'\\]',display:true}
            ],
            throwOnError:false
          });
        }catch(e){ el.innerHTML='<span style="color:red;">Error rendering LaTeX</span>'; }
      }

      function exportToJSON(){
        const testTitle=document.getElementById('testTitle').value;
        const totalTime=document.getElementById('totalTime').value;
        if(!testTitle){ alert('Please enter a test title.'); return; }

        const questions=[];
        const blocks=document.querySelectorAll('.question-block');
        if(blocks.length===0){ alert('Please add at least one question.'); return; }

        for(const b of blocks){
          const qText=b.querySelector('.question-text').value;
          const points=parseInt(b.querySelector('.question-points').value);
          if(!qText){ alert('All questions must have text.'); return; }

          const options=[]; let correctIndex=-1;
          const optionInputs=b.querySelectorAll('.option-text');
          optionInputs.forEach((inp,idx)=>{
            if(!inp.value){ return; }
            options.push(inp.value);
            const r=inp.parentElement.querySelector('input[type="radio"]');
            if(r && r.checked) correctIndex=idx;
          });
          if(options.length<2){ alert('Each question must have at least two options.'); return; }
          if(correctIndex===-1){ alert('Each question must have a correct answer selected.'); return; }

          questions.push({questionText:qText, options, correctOption:correctIndex, points});
        }

        const data={title:testTitle,totalTime:parseInt(totalTime),questions};
        const str=JSON.stringify(data,null,2);
        const blob=new Blob([str],{type:'application/json'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='test.json'; a.click();
        localStorage.setItem('testData',str);
        alert('Test exported successfully!');
      }

      function clearAll(){
        if(confirm('Clear all questions?')) {
          document.getElementById('questionsContainer').innerHTML='';
          document.getElementById('testTitle').value='';
          document.getElementById('totalTime').value='60';
          addQuestion();
        }
      }

      function previewTest(){ exportToJSON(); window.open('test.html','_blank'); }

      /* ==================== MATH KEYBOARD ==================== */
      const KBD = (function(){
        const kbdEl = document.getElementById('mathKeyboard');
        const tabsEl = document.getElementById('mkTabs');
        const bodyEl = document.getElementById('mkBody');
        const btnClose = document.getElementById('mkClose');
        const btnPin = document.getElementById('mkPin');
        const quickTabs = [
          {id:'quick', label:'Tezkor'},
          {id:'frac', label:'Kasr/Ildiz'},
          {id:'brackets', label:'Klammer'},
          {id:'ops', label:'Operatorlar'},
          {id:'func', label:'Funksiya/Trig'},
          {id:'calc', label:'Hisob'},
          {id:'greek', label:'Yunon'},
          {id:'fmt', label:'Format/Matrix'},
        ];

        let currentTarget = null;
        let pinned = false;
        let drag = {active:false,x:0,y:0, left:0, top:0};

        function key(label, insert, hint=''){
          return `<button class="mk-key" data-insert="${insert.replace(/"/g,'&quot;')}">${label}${hint?` <small>${hint}</small>`:''}</button>`;
        }
        function wrapKey(label,left,right,hint=''){
          return `<button class="mk-key" data-wrap-left="${left.replace(/"/g,'&quot;')}" data-wrap-right="${right.replace(/"/g,'&quot;')}">${label}${hint?` <small>${hint}</small>`:''}</button>`;
        }

        const groups = {
  quick: `
    <div class="mk-row">
      ${wrapKey('x^2','^{','}','power')}
      ${wrapKey('x_i','_{','}','sub')}
      ${wrapKey('\\frac','\\frac{','}{}','a/b')}
      ${wrapKey('√','\\sqrt{','}','sqrt')}
      ${wrapKey('n√','\\sqrt[',']{}','index')}
      ${wrapKey('(| |)','\\left|','\\right|','abs')}
      ${wrapKey('〈 〉','\\langle ','\\rangle ','angle')}
      ${key('\\pi','\\\\pi')}
      ${key('\\infty','\\\\infty')}
      ${key('\\approx','\\\\approx')}
      ${key('\\neq','\\\\neq')}
      ${key('\\cdot','\\\\cdot')}
    </div>
    <div class="mk-spacer"></div>
    <div class="mk-row">
      ${wrapKey('()','(',')')}
      ${wrapKey('[]','[',']')}
      ${wrapKey('{}','\\{','\\}')}
      ${key('\\le','\\\\leq')}
      ${key('\\ge','\\\\geq')}
      ${key('±','\\pm')}
      ${key('×','\\times')}
      ${key('÷','\\div')}
      ${key('→','\\\\to')}
      ${wrapKey('“text”','\\text{','}','text')}
      ${wrapKey('Align','\\begin{aligned}','\\end{aligned}','env')}
    </div>
  `,
  frac: `
    <div class="mk-grid">
      ${wrapKey('\\frac{}{}','\\frac{','}{}','a/b')}
      ${wrapKey('\\tfrac{}{}','\\tfrac{','}{}','inline')}
      ${wrapKey('\\dfrac{}{}','\\dfrac{','}{}','display')}
      ${wrapKey('\\sqrt{}','\\sqrt{','}','')}
      ${wrapKey('\\sqrt[n]{}','\\sqrt[',']{}','with index')}
      ${wrapKey('\\overline{}','\\overline{','}','bar')}
      ${wrapKey('\\underline{}','\\underline{','}','')}
      ${wrapKey('\\boxed{}','\\boxed{','}','')}
    </div>
  `,
  brackets: `
    <div class="mk-grid">
      ${wrapKey('\\left( \\right)','\\left(','\\right)')}
      ${wrapKey('\\left[ \\right]','\\left[','\\right]')}
      ${wrapKey('\\left\\{ \\right\\}','\\left\\{','\\right\\}')}
      ${wrapKey('\\left| \\right|','\\left|','\\right|')}
      ${wrapKey('\\left\\langle \\right\\rangle','\\left\\langle ','\\right\\rangle')}
      ${wrapKey('\\Bigg( \\Bigg)','\\Bigg(','\\Bigg)')}
    </div>
  `,
  ops: `
    <div class="mk-grid">
      ${key('\\cdot','\\\\cdot')}
      ${key('\\times','\\\\times')}
      ${key('\\div','\\\\div')}
      ${key('\\pm','\\\\pm')}
      ${key('\\mp','\\\\mp')}
      ${key('\\star','\\\\star')}
      ${key('\\circ','\\\\circ')}
      ${key('\\oplus','\\\\oplus')}
      ${key('\\otimes','\\\\otimes')}
      ${key('\\cap','\\\\cap')}
      ${key('\\cup','\\\\cup')}
      ${key('\\subset','\\\\subset')}
      ${key('\\subseteq','\\\\subseteq')}
      ${key('\\supset','\\\\supset')}
      ${key('\\in','\\\\in')}
      ${key('\\notin','\\\\notin')}
      ${key('\\exists','\\\\exists')}
      ${key('\\forall','\\\\forall')}
      ${key('\\therefore','\\\\therefore')}
      ${key('\\because','\\\\because')}
      ${key('\\to','\\\\to')}
      ${key('\\Rightarrow','\\\\Rightarrow')}
      ${key('\\Leftrightarrow','\\\\Leftrightarrow')}
    </div>
  `,
  func: `
    <div class="mk-grid">
      ${key('\\sin','\\\\sin')}
      ${key('\\cos','\\\\cos')}
      ${key('\\tan','\\\\tan')}
      ${key('\\cot','\\\\cot')}
      ${key('\\sec','\\\\sec')}
      ${key('\\csc','\\\\csc')}
      ${key('\\log','\\\\log')}
      ${key('\\ln','\\\\ln')}
      ${key('\\max','\\\\max')}
      ${key('\\min','\\\\min')}
      ${key('\\arg','\\\\arg')}
      ${key('\\deg','\\\\deg')}
      ${wrapKey('f\\,(','f(',')','func')}
      ${wrapKey('g\\,(','g(',')','func')}
    </div>
  `,
  calc: `
    <div class="mk-grid">
      ${key('\\int_{ }^{ }','\\\\int_{ }^{ }')}
      ${key('\\iint_{ }^{ }','\\\\iint_{ }^{ }')}
      ${key('\\iiint_{ }^{ }','\\\\iiint_{ }^{ }')}
      ${key('\\sum_{ }^{ }','\\\\sum_{ }^{ }')}
      ${key('\\prod_{ }^{ }','\\\\prod_{ }^{ }')}
      ${wrapKey('\\lim','\\lim_{','}','')}
      ${key('\\partial','\\\\partial')}
      ${key('\\nabla','\\\\nabla')}
      ${key('\\frac{d}{dx}\\big(\\,\\big)','\\\\frac{\\\\mathrm{d}}{\\\\mathrm{d}x}()')}
      ${key('\\frac{\\partial}{\\partial x}\\big(\\,\\big)','\\\\frac{\\\\partial}{\\\\partial x}()')}
    </div>
  `,
  greek: `
    <div class="mk-grid">
      ${key('\\alpha','\\\\alpha')}${key('\\beta','\\\\beta')}${key('\\gamma','\\\\gamma')}
      ${key('\\delta','\\\\delta')}${key('\\epsilon','\\\\epsilon')}${key('\\varepsilon','\\\\varepsilon')}
      ${key('\\zeta','\\\\zeta')}${key('\\eta','\\\\eta')}${key('\\theta','\\\\theta')}
      ${key('\\vartheta','\\\\vartheta')}${key('\\iota','\\\\iota')}${key('\\kappa','\\\\kappa')}
      ${key('\\lambda','\\\\lambda')}${key('\\mu','\\\\mu')}${key('\\nu','\\\\nu')}
      ${key('\\xi','\\\\xi')}${key('\\pi','\\\\pi')}${key('\\rho','\\\\rho')}
      ${key('\\sigma','\\\\sigma')}${key('\\tau','\\\\tau')}${key('\\upsilon','\\\\upsilon')}
      ${key('\\phi','\\\\phi')}${key('\\varphi','\\\\varphi')}${key('\\chi','\\\\chi')}
      ${key('\\psi','\\\\psi')}${key('\\omega','\\\\omega')}
      ${key('\\Gamma','\\\\Gamma')}${key('\\Delta','\\\\Delta')}${key('\\Theta','\\\\Theta')}
      ${key('\\Lambda','\\\\Lambda')}${key('\\Xi','\\\\Xi')}${key('\\Pi','\\\\Pi')}
      ${key('\\Sigma','\\\\Sigma')}${key('\\Upsilon','\\\\Upsilon')}${key('\\Phi','\\\\Phi')}
      ${key('\\Psi','\\\\Psi')}${key('\\Omega','\\\\Omega')}
    </div>
  `,
  fmt: `
    <div class="mk-grid">
      ${wrapKey('^{ }','^{','}','super')}
      ${wrapKey('_{ }','_{','}','sub')}
      ${wrapKey('\\overline{ }','\\overline{','}','')}
      ${wrapKey('\\underline{ }','\\underline{','}','')}
      ${wrapKey('\\boxed{ }','\\boxed{','}','')}
      ${wrapKey('\\color{blue}{ }','\\color{blue}{','}','')}
      ${wrapKey('\\text{ }','\\text{','}','')}
      ${key('\\begin{bmatrix} a & b \\\\ c & d \\end{bmatrix}','\\\\begin{bmatrix} a & b \\\\ c & d \\\\ \\end{bmatrix}')}
      ${wrapKey('Cases','\\begin{cases} ',' \\end{cases}','')}
      ${wrapKey('Aligned','\\begin{aligned} ',' \\end{aligned}','')}
    </div>
  `
};


        function build(){
          // Tabs
          tabsEl.innerHTML = quickTabs.map((t,i)=>`<button class="mk-tab ${i===0?'active':''}" data-tab="${t.id}">${t.label}</button>`).join('');
          // Bodies
          bodyEl.innerHTML = quickTabs.map((t,i)=>`<div class="mk-group ${i===0?'active':''}" data-group="${t.id}">${groups[t.id]}</div>`).join('');

          // Tab switching
          tabsEl.addEventListener('click', e=>{
            const btn=e.target.closest('.mk-tab'); if(!btn) return;
            const id=btn.dataset.tab;
            tabsEl.querySelectorAll('.mk-tab').forEach(b=>b.classList.toggle('active', b===btn));
            bodyEl.querySelectorAll('.mk-group').forEach(g=>g.classList.toggle('active', g.dataset.group===id));
          });

          // Insert / wrap click
          bodyEl.addEventListener('click', e=>{
            const k=e.target.closest('.mk-key'); if(!k) return;
            if(!currentTarget) return;
            if(k.dataset.insert) insertSnippet(currentTarget, k.dataset.insert);
            else if(k.dataset.wrapLeft || k.dataset.wrapRight) wrapSelection(currentTarget, k.dataset.wrapLeft||'', k.dataset.wrapRight||'');
            // keep focus
            currentTarget.focus();
            triggerPreviewFrom(currentTarget);
          });

          // Quick insert buttons in header
          kbdEl.querySelectorAll('.mk-insert').forEach(b=>{
            b.addEventListener('click', ()=>{
              if(!currentTarget) return;
              const ins=b.dataset.insert;
              // put cursor inside the delimiters
              const midPos=Math.floor(ins.length/2);
              insertSnippet(currentTarget, ins, midPos);
              currentTarget.focus();
              triggerPreviewFrom(currentTarget);
            });
          });

          // Dragging (desktop)
          const head=kbdEl.querySelector('.mk-head');
          head.addEventListener('mousedown', (e)=>{
            if(!e.target.classList.contains('mk-drag')) return;
            drag.active=true; drag.x=e.clientX; drag.y=e.clientY;
            const rect=kbdEl.getBoundingClientRect(); drag.left=rect.left; drag.top=rect.top;
            document.addEventListener('mousemove', onDrag); document.addEventListener('mouseup', endDrag);
          });

          btnClose.addEventListener('click', hide);
          btnPin.addEventListener('click', ()=>{ pinned=!pinned; btnPin.classList.toggle('active', pinned); });
        }

        function onDrag(e){
          if(!drag.active) return;
          const dx=e.clientX-drag.x, dy=e.clientY-drag.y;
          kbdEl.style.left=(drag.left+dx)+'px';
          kbdEl.style.top=(drag.top+dy)+'px';
        }
        function endDrag(){
          drag.active=false;
          document.removeEventListener('mousemove', onDrag);
          document.removeEventListener('mouseup', endDrag);
        }

        function showFor(el){
          currentTarget = el;
          currentTarget.classList.add('input-has-kbd');
          kbdEl.style.display='block';
          positionNear(el);
        }
        function hide(){
          if(pinned) return;
          kbdEl.style.display='none';
          if(currentTarget) currentTarget.classList.remove('input-has-kbd');
          currentTarget=null;
        }
        function positionNear(el){
          if(window.matchMedia('(max-width: 768px)').matches){
            // mobile: dock to bottom
            kbdEl.style.left='2vw'; kbdEl.style.right='2vw'; kbdEl.style.bottom='10px';
            kbdEl.style.top=''; 
            return;
          }
          const rect=el.getBoundingClientRect();
          const kb= kbdEl.getBoundingClientRect();
          let top = window.scrollY + rect.bottom + 8;
          let left = window.scrollX + Math.max(8, rect.left - (kb.width-rect.width)/2);
          // clamp inside viewport
          const maxLeft = window.scrollX + document.documentElement.clientWidth - kb.width - 8;
          left = Math.min(Math.max(left, window.scrollX + 8), maxLeft);
          kbdEl.style.top= top+'px';
          kbdEl.style.left= left+'px';
        }

        function insertSnippet(el, snippet, moveCursorInsideBy=null){
          const [start, end] = [el.selectionStart ?? el.value.length, el.selectionEnd ?? el.value.length];
          const before = el.value.slice(0,start);
          const after = el.value.slice(end);
          el.value = before + snippet + after;
          const newPos = moveCursorInsideBy!=null ? start + moveCursorInsideBy : start + snippet.length;
          setSelection(el, newPos, newPos);
          el.dispatchEvent(new Event('input',{bubbles:true}));
        }
        function wrapSelection(el, left, right){
          const [start, end] = [el.selectionStart ?? 0, el.selectionEnd ?? 0];
          const before = el.value.slice(0,start);
          const sel = el.value.slice(start,end);
          const after = el.value.slice(end);
          el.value = before + left + sel + right + after;
          setSelection(el, start + left.length + sel.length, start + left.length + sel.length);
          el.dispatchEvent(new Event('input',{bubbles:true}));
        }
        function setSelection(el, s, e){ el.focus(); el.setSelectionRange(s,e); }

        function triggerPreviewFrom(target){
          // find nearest .question-block preview and re-render
          const block = target.closest('.question-block');
          if(!block) return;
          const qTextarea = block.querySelector('.question-text');
          const preview = block.querySelector('.latex-preview');
          if(qTextarea && preview) renderLatex(qTextarea.value, preview);
        }

        // public API
        build();
        return {showFor, hide, positionNear, isPinned:()=>pinned};
      })();

      function hookMathKeyboard(scope){
        const inputs = scope.querySelectorAll('.question-text, .option-text');
        inputs.forEach(inp=>{
          inp.addEventListener('focus', ()=>{
            KBD.showFor(inp);
            // reposition on window resize/scroll
            const posH = ()=>KBD.positionNear(inp);
            window.addEventListener('resize', posH, {passive:true});
            window.addEventListener('scroll', posH, {passive:true});
            // store removers on element
            inp._mkCleanup = ()=>{ window.removeEventListener('resize', posH); window.removeEventListener('scroll', posH); };
          });
          inp.addEventListener('blur', (e)=>{
            // if click to keyboard—do not hide (allows clicking keys)
            if(KBD.isPinned()) return;
            setTimeout(()=>{ // wait click bounce
              // hide only if new active element is not inside keyboard
              const kb=document.getElementById('mathKeyboard');
              const ae=document.activeElement;
              const clickedInsideKb = kb.contains(ae);
              if(!clickedInsideKb) {
                KBD.hide();
                if(inp._mkCleanup) inp._mkCleanup();
              }
            },100);
          });
        });
      }

      // Initial attach for pre-existing DOM (first added question)
      hookMathKeyboard(document);

    });
  </script>
</body>
</html>
