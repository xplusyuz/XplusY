<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Rasm-Only Test — Admin</title>
  <style>
    :root{--g:#2E8B57;--gd:#1F6B45;--bd:#e9f2ec}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#f6faf8;color:#0f172a}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{display:flex;align-items:center;gap:10px}
    .pi{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,var(--g),var(--gd));color:#fff;font-weight:800}
    .grid{display:grid;gap:12px}
    .card{background:#fff;border:1px solid var(--bd);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(31,107,69,.06)}
    .row{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    label{font-size:12px;color:#475569}
    input[type="text"],input[type="number"],textarea,select{
      width:100%;padding:10px 12px;border:1px solid #dfeae3;border-radius:10px;background:#fbfdfc
    }
    textarea{min-height:84px;resize:vertical}
    .qbox{border:1px dashed #cfe4d7;border-radius:14px;padding:12px;display:grid;gap:10px}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:700;color:#fff;background:linear-gradient(135deg,var(--g),var(--gd));cursor:pointer}
    .btn.ghost{background:#fff;color:#1F6B45;border:1px solid #cfe4d7}
    .btn.danger{background:linear-gradient(135deg,#d32f2f,#b71c1c)}
    .muted{color:#64748b;font-size:13px}
    .flex{display:flex;gap:10px;flex-wrap:wrap}
    .tag{padding:6px 10px;border-radius:999px;border:1px solid #dfeae3;background:#fff;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1><span class="pi">π</span> Rasm-Only Test — Admin</h1>

    <div class="card grid">
      <div class="row">
        <div>
          <label>Sarlavha</label>
          <input id="title" type="text" placeholder="Algebra — Rasm test">
        </div>
        <div>
          <label>Ta’rif</label>
          <input id="desc" type="text" placeholder="Savol matnisiz, rasm + variantlar">
        </div>
        <div>
          <label>Test turi</label>
          <input id="type" type="text" value="aralash">
        </div>
        <div>
          <label>Vaqt (daqiqada)</label>
          <input id="dur" type="number" min="0" value="30">
        </div>
        <div>
          <label>Nechta savol (rasmlar soni)</label>
          <input id="qcount" type="number" min="1" value="5">
        </div>
      </div>
      <div class="flex">
        <button class="btn" id="buildBtn">Savol shakllarini yarat</button>
        <span class="muted">Rasmlar nomi <b>1.jpg, 2.jpg, ...</b> bo‘ladi. JSON faqat variantlar va javoblarni saqlaydi.</span>
      </div>
    </div>

    <div id="questionsArea" class="grid"></div>

    <div class="card flex" style="justify-content:space-between;align-items:center">
      <div class="flex">
        <button class="btn" id="exportBtn">Export JSON</button>
        <button class="btn ghost" id="previewBtn">Preview (test.html)</button>
      </div>
      <div class="muted">“Preview” — localStorage’ga yozadi va <code>test.html</code>ni ochadi.</div>
    </div>

    <div class="card">
      <div class="muted">
        <b>Ko‘rsatmalar:</b> har savol uchun <span class="tag">ball</span>,
        <span class="tag">variantlar (har satr — bitta)</span>, va
        <span class="tag">javob turi</span> tanlang. Bir javobli bo‘lsa — radio; ko‘p javobli bo‘lsa — checkbox’lardan tanlang.
      </div>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);

    function qTemplate(i){
      return `
      <div class="card qbox" data-index="${i}">
        <div class="flex" style="justify-content:space-between;align-items:center">
          <div class="muted"><b>#${i}</b> — rasm fayli: <code>${i}.jpg</code> (yoki <code>${i}.png</code>)</div>
          <button class="btn danger" onclick="this.closest('.qbox').remove()">O‘chirish</button>
        </div>
        <div class="row">
          <div>
            <label>Ball (#${i})</label>
            <input type="number" min="1" value="1" class="points">
          </div>
          <div>
            <label>Javob turi</label>
            <select class="mode">
              <option value="single">Bir javobli</option>
              <option value="multi">Ko‘p javobli</option>
            </select>
          </div>
        </div>
        <div>
          <label>Variantlar (har satr — bitta)</label>
          <textarea class="options" placeholder="A varianti&#10;B varianti&#10;C varianti&#10;D varianti"></textarea>
        </div>
        <div class="answrap">
          <label>To‘g‘ri javob(lar)</label>
          <div class="answers"></div>
          <div class="muted">Variantlar maydonini to‘ldirgach — quyidagi ro‘yxat avtomatik yangilanadi.</div>
        </div>
      </div>`;
    }

    function rebuildAnswerPickers(container){
      const ta = container.querySelector('.options');
      const modeSel = container.querySelector('.mode');
      const ansBox = container.querySelector('.answers');
      const lines = (ta.value || '').split('\n').map(s=>s.trim()).filter(Boolean);
      ansBox.innerHTML = '';
      lines.forEach((txt, idx)=>{
        const id = `q${container.dataset.index}_opt${idx}`;
        const inp = document.createElement('input');
        inp.type = (modeSel.value==='multi') ? 'checkbox' : 'radio';
        inp.name = `ans_${container.dataset.index}`;
        inp.value = String(idx);
        inp.id = id;
        const lab = document.createElement('label');
        lab.setAttribute('for', id);
        lab.textContent = `${idx+1}) ${txt}`;
        const row = document.createElement('div');
        row.className = 'flex';
        row.appendChild(inp); row.appendChild(lab);
        ansBox.appendChild(row);
      });
    }

    function buildForms(){
      const n = Math.max(1, Number($('#qcount').value||1));
      const area = $('#questionsArea'); area.innerHTML = '';
      for(let i=1;i<=n;i++){
        const box = document.createElement('div');
        box.innerHTML = qTemplate(i);
        area.appendChild(box.firstElementChild);
      }
      // listeners
      area.querySelectorAll('.qbox').forEach(box=>{
        const ta = box.querySelector('.options');
        const mode = box.querySelector('.mode');
        ta.addEventListener('input', ()=>rebuildAnswerPickers(box));
        mode.addEventListener('change', ()=>rebuildAnswerPickers(box));
      });
    }

    function collectJson(){
      const title = $('#title').value || 'Rasm-Only Test';
      const description = $('#desc').value || 'Rasm + variant';
      const type = $('#type').value || 'aralash';
      const durationMinutes = Number($('#dur').value||0);

      const questions = [];
      document.querySelectorAll('.qbox').forEach(box=>{
        const points = Math.max(1, Number(box.querySelector('.points').value||1));
        const mode = box.querySelector('.mode').value;
        const opts = (box.querySelector('.options').value||'')
          .split('\n').map(s=>s.trim()).filter(Boolean);

        const selected = [...box.querySelectorAll('.answers input:checked')].map(i=>Number(i.value));
        const q = { points, options: opts };

        if(mode==='multi'){
          q.correctIndices = selected;
        } else {
          q.correctIndex = selected.length ? selected[0] : -1;
        }
        questions.push(q);
      });

      return { title, description, type, durationMinutes, questions };
    }

    function download(filename, blob){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    // events
    document.getElementById('buildBtn').addEventListener('click', buildForms);
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const data = collectJson();
      download('test.json', new Blob([JSON.stringify(data, null, 2)], {type:'application/json'}));
    });
    document.getElementById('previewBtn').addEventListener('click', ()=>{
      const data = collectJson();
      localStorage.setItem('testData', JSON.stringify(data));
      window.location.href = 'test.html';
    });

    // init
    buildForms();
  </script>
</body>
</html>
