<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>LeaderMath — Mobil (PWA)</title>
  <meta name="theme-color" content="#2E8B57" id="meta-theme-color"/>
  <meta name="color-scheme" content="dark light"/>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./favicon.ico">
  <style>
    :root{
      --brand:#2E8B57;--brand2:#1F6B45;
      --bg:#f6faf8;--text:#0f172a;--muted:#6b7c75;--card:#ffffff;
      --frame:#e3efe8;--frame-dark:#163d2d;--chip:#e9f5ef;--chip-b:#cfe9dc;
      --radius:18px
    }
    :root.dark{
      --bg:#0b0f0e; --text:#EAF7F0; --muted:#A8BBB3; --card:#0f1714;
      --frame:#244b39; --frame-dark:#112a1f; --chip:#0f221b; --chip-b:#2a5a45;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    .appbar{position:sticky;top:0;z-index:90;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:10px 12px;display:flex;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
    .logo{width:40px;height:40px;border-radius:14px;background:#fff2;display:grid;place-items:center;font-weight:800}
    .title{font-weight:800;font-size:18px}
    .sub{font-size:11px;color:var(--muted)}
    .spacer{flex:1}
    .iconbtn{background:#ffffff22;border:1px solid #ffffff33;color:#fff;border-radius:12px;padding:8px 10px;font-weight:700;cursor:pointer}
    .userbar{background:var(--card);border:1px dashed var(--frame);border-radius:14px;margin:10px 12px;padding:10px;display:flex;align-items:center;gap:10px;box-shadow:0 8px 20px #0001}
    .ava{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand2));display:grid;place-items:center;color:#fff;font-weight:800}
    .uinfo{line-height:1.2}.uinfo b{display:block}.uvals{margin-left:auto;text-align:right;font-size:12px}
    .board{background:var(--card);border:1px dashed var(--frame);border-radius:16px;margin:10px 12px;padding:12px}
    .board h3{margin:0 0 8px;font-size:16px}
    .rank{display:grid;grid-template-columns:32px 1fr auto;gap:8px;align-items:center;padding:8px;border-radius:10px;border:1px dashed var(--frame);margin-bottom:6px;background:linear-gradient(180deg,#ffffff,#ffffff00)}
    .rank.top{background:linear-gradient(0deg,#f6fffb,#ffffff)}
    .chips{position:sticky;top:62px;z-index:80;background:var(--bg);padding:8px 12px;display:flex;gap:8px;overflow:auto}
    .chip{white-space:nowrap;font-size:12px;color:#0b3d2a;background:var(--chip);border:1px solid var(--chip-b);padding:7px 10px;border-radius:999px}
    .chip.active{outline:2px solid var(--brand)}
    .carousel{position:relative;overflow:hidden;border-radius:var(--radius); margin:0 12px;}
    .track{display:flex;transition:transform .45s cubic-bezier(.2,.8,.2,1)}
    .slide{min-width:100%;aspect-ratio:16/9;position:relative;background:#e9f5ef}
    .dots{position:absolute;inset:auto 0 8px;display:flex;justify-content:center;gap:6px}
    .dot{width:8px;height:8px;border-radius:10px;background:#1113}
    .dot.active{width:18px;background:#111}
    .cbtn{position:absolute;top:50%;transform:translateY(-50%);background:#0007;color:#fff;border:none;width:38px;height:38px;border-radius:12px;display:grid;place-items:center}
    .cbtn.left{left:8px}.cbtn.right{right:8px}
    .sect{margin-top:16px}
    .frame{border:1px dashed var(--frame); border-radius:18px; padding:12px; background:linear-gradient(180deg,#ffffffcc,#ffffff00);}
    .framehead{display:flex;align-items:center;gap:8px;margin:0 2px 10px;border-bottom:1px dashed var(--frame);padding-bottom:8px}
    .framehead .dotcap{width:10px;height:10px;border-radius:50%;background:var(--brand)}
    .framehead h2{margin:0;font-size:18px;font-weight:900;color:var(--brand2);letter-spacing:.2px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:480px){.grid{grid-template-columns:1fr 1fr}}
    @media (min-width:768px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card);border-radius:14px;overflow:hidden;box-shadow:0 10px 24px rgba(0,0,0,.06);border:1px dashed var(--frame);position:relative}
    .thumb{aspect-ratio:16/9;background:#e6efe9;position:relative}
    .badge{position:absolute;top:8px;left:8px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .body{padding:12px}
    .name{font-size:15px;font-weight:800;margin:0 0 6px}
    .desc{font-size:13px;color:var(--muted);line-height:1.4;margin:0 0 10px}
    .tags{display:flex;flex-wrap:wrap;gap:6px;margin:0 0 10px}
    .tag{font-size:11px;color:#0b3d2a;background:#e9f5ef;border:1px solid #cfe9dc;padding:5px 8px;border-radius:999px}
    .actions{display:flex;gap:8px;align-items:stretch}
    .btn{flex:1;display:inline-flex;align-items:center;justify-content:center;gap:8px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;border:none;border-radius:12px;padding:12px 14px;font-weight:800;font-size:14px;cursor:pointer;text-decoration:none}
    .btn.ghost{background:#f0f7f3;color:#0b3d2a;border:1px solid var(--frame)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .meta{font-size:12px;color:var(--muted);margin-top:8px;display:flex;gap:10px;align-items:center}
    .countdown{font-weight:800}
    .pager{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
    .pager button{background:#e9f5ef;border:1px solid #cfe9dc;color:#0b3d2a;border-radius:10px;padding:8px 10px;font-weight:700}
    .dark .iconbtn{ background:#ffffff22; color:#fff; border:1px solid #ffffff33 }
    .dark .userbar,.dark .board{ border-color:var(--frame); background:var(--card) }
    .dark .rank{ border-color:var(--frame); background:linear-gradient(180deg,#0f1714,#0f171400) }
    .dark .rank.top{ background:linear-gradient(0deg,#13251c,#0f1714) }
    .dark .chip,.dark .tag{ color:var(--text); background:var(--chip); border-color:var(--chip-b) }
    .dark .btn.ghost{ background:#ffffff0a; color:#text; border:1px solid var(--frame) }
    .dark .dot{ background:#ffffff55 } .dark .dot.active{ background:#fff }
    .dark .thumb{ background:#12211a }
    .dark .frame{ border-color:var(--frame); background:linear-gradient(180deg,#0f1714cc,#0f171400) }
    .dark .framehead h2{ color:#d6f2e6 }
    .thumb{ position:relative; overflow:hidden; border-radius:16px; }
    .thumb.noimg{ background:linear-gradient(135deg,#e9f2ee 0%,#f6fbf8 100%); }
    .dark .thumb.noimg{ background:linear-gradient(135deg,#0f1d17,#0b1310); }
    .thumb .ov{ position:absolute; inset:0; display:grid; place-items:center; padding:12px; background:linear-gradient(180deg,transparent 45%, rgba(0,0,0,.45) 100%); }
    .thumb .label{
      display:inline-block; padding:.7em 1.25em; border-radius:18px; font-weight:900;
      font-size:clamp(18px,4.6vw,26px); letter-spacing:.3px; color:#fff;
      background:linear-gradient(180deg, rgba(255,255,255,.24), rgba(255,255,255,.10));
      border:1px solid rgba(255,255,255,.38);
      box-shadow:0 10px 28px rgba(0,0,0,.28), inset 0 1px 0 rgba(255,255,255,.45);
      backdrop-filter: blur(8px) saturate(130%); text-shadow:0 2px 12px rgba(0,0,0,.35);
      transform: translateY(0); transition: transform .25s ease, box-shadow .25s ease;
    }
    .card:hover .label{ transform: translateY(-2px); box-shadow:0 14px 34px rgba(0,0,0,.32), inset 0 1px 0 rgba(255,255,255,.55); }

    /* Modal (Batafsil & Profil) */
    .modal-mask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.4);z-index:9999}
    .modal{width:min(820px,94%);max-height:90vh;overflow:auto;background:#fff;border-radius:14px;border:1px solid var(--frame);box-shadow:0 20px 60px rgba(0,0,0,.25);padding:14px}
    .modal h3{margin:0 0 8px;color:#1F6B45}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid1{display:grid;grid-template-columns:1fr;gap:10px}
    .ctl label{font-size:12px;color:#6b7c75;display:block;margin-bottom:4px}
    .ctl input,.ctl textarea{width:100%;padding:10px;border:1px solid var(--frame);border-radius:10px;font:inherit;background:#fff}
    .row{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .btns{display:flex;gap:8px}
    .danger{color:#c62828;font-size:12px}
    .req{color:#c62828}
    .dark .modal{background:#0f1714;border-color:var(--frame);color:var(--text)}
    .dark .ctl input,.dark .ctl textarea{background:#0f1714;color:var(--text);border-color:var(--frame)}

    .modal-close{position:sticky;top:0;display:flex;justify-content:flex-end;margin:-10px -10px 10px}
    .modal-close button{background:#e9f5ef;border:1px solid #cfe9dc;border-radius:10px;padding:6px 10px;font-weight:800}
    .modal-content{padding:4px}
	#installBtn {
  background: linear-gradient(45deg, #2E8B57, #1F6B45);
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 10px;
  font-size: 16px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  cursor: pointer;
}
  </style>
</head>
<body>
  <!-- Appbar -->
  <header class="appbar">
    <div class="logo">L</div>
    <div><div class="title">LeaderMath</div><div class="sub">BSB / CHSB dars resurslari</div></div>
    <div class="spacer"></div>
    <button id="themeBtn" class="iconbtn" title="Dark/Light">🌙</button>
    <button id="installBtn" class="hide">📲 PWA ni o‘rnatish</button>
  </header>

  <!-- User bar -->
  <section class="userbar" id="userbar">
    <div class="ava" id="ava">LM</div>
    <div class="uinfo">
      <b id="uname">Mehmon</b>
      <span class="sub" id="uid">ID: —</span>
      <div class="sub" id="uschool" style="margin-top:2px">—</div>
      <div class="sub" id="uclass">—</div>
    </div>
    <div class="uvals">
      <div><b id="points">Ball: —</b></div>
      <div style="margin-top:4px">
        <a href="#" id="editProfile" class="sub" style="display:none">Profil</a> ·
        <a href="#" id="signin" class="sub">Kirish</a> ·
        <a href="#" id="signout" class="sub" style="display:none">Chiqish</a> ·
        <a class="sub" href="./admin.html" id="adminLink">Admin</a>
      </div>
    </div>
  </section>

  <!-- Leaderboard -->
  <section class="board" id="board">
    <h3>Top 50 — Ball bo‘yicha</h3>
    <div id="boardList"></div>
    <div id="boardPager" class="pager" style="display:none">
      <button id="boardPrev">Oldingi</button>
      <div class="info" id="boardInfo"></div>
      <button id="boardNext">Keyingi</button>
    </div>
  </section>

  <!-- Chips -->
  <div class="chips" id="chips"></div>

  <!-- Carousel (banners from index.json as HTML) -->
  <section class="carousel" id="carousel" style="margin-top:6px">
    <button class="cbtn left" aria-label="Oldingi" id="prev">‹</button>
    <div class="track" id="track"></div>
    <button class="cbtn right" aria-label="Keyingi" id="next">›</button>
    <div class="dots" id="dots"></div>
  </section>

  <!-- Sections -->
  <div class="container" style="padding:6px 12px 88px">
    <div id="sections"></div>
    <div style="height:24px"></div>
  </div>

  <!-- Profile modal (majburiy) -->
  <div id="profileModal" class="modal-mask" aria-modal="true" role="dialog">
    <div class="modal">
      <h3>Profil ma’lumotlari <span class="sub">— majburiy <span class="req">*</span></span></h3>
      <div class="grid2">
        <div class="ctl"><label>Ism <span class="req">*</span></label><input id="pFirst" placeholder="Ism"></div>
        <div class="ctl"><label>Familiya <span class="req">*</span></label><input id="pLast" placeholder="Familiya"></div>
      </div>
      <div class="grid2">
        <div class="ctl"><label>Maktab nomi <span class="req">*</span></label><input id="pSchool" placeholder="Masalan: 123-maktab"></div>
        <div class="ctl"><label>Sinf <span class="req">*</span></label><input id="pClass" placeholder="Masalan: 9-A"></div>
      </div>
      <div class="grid2">
        <div class="ctl"><label>Telefon <span class="req">*</span></label><input id="pPhone" placeholder="+998 XX XXX XX XX"></div>
        <div class="ctl"><label>Email <span class="req">*</span></label><input id="pEmail" placeholder="email@example.com"></div>
      </div>
      <div class="grid1">
        <div class="ctl"><label>Uy manzili <span class="req">*</span></label><textarea id="pAddress" rows="2" placeholder="Shahar/tuman, ko‘cha, uy ..."></textarea></div>
      </div>
      <div class="row">
        <div class="danger" id="pError"></div>
        <div class="btns">
          <button id="pSave" class="iconbtn" style="background:linear-gradient(135deg,var(--brand),var(--brand2));border:none">Saqlash</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Universal modal for 'Batafsil' (HTML from JSON) -->
  <div id="htmlModal" class="modal-mask" aria-modal="true" role="dialog">
    <div class="modal">
      <div class="modal-close"><button id="htmlClose">Yopish ✕</button></div>
      <div id="htmlContainer" class="modal-content"><!-- JSONdagi detailsHtml shu yerga tushadi --></div>
    </div>
  </div>
  <script type="module">
  import { auth } from "firebase.client.js";
  import { requireAuth } from "auth-guard.js";
</script>
<link rel="manifest" href="./manifest.webmanifest">
<link rel="icon" href="./favicon.ico">
<script type="module">
  import { auth, signOut } from "firebase.client.js";
  import { watchAuth } from "auth-guard.js";

  const el = {
    uname: document.getElementById('uname'),
    uid: document.getElementById('uid'),
    points: document.getElementById('points'),
    uschool: document.getElementById('uschool'),
    uclass: document.getElementById('uclass'),
    ava: document.getElementById('ava'),
    signin: document.getElementById('signin'),
    signout: document.getElementById('signout'),
    editProfile: document.getElementById('editProfile'),
    adminLink: document.getElementById('adminLink')
  };

  function initials(n){ if(!n) return 'LM'; const p=n.trim().split(/\s+/); return (p[0]?.[0]||'L')+(p[1]?.[0]||'M'); }

  // “Kirish” linki login.html ga qaytish parami bilan olib boradi
  el.signin.addEventListener('click', (e)=>{
    e.preventDefault();
    const ret = encodeURIComponent(location.pathname + location.search + location.hash);
    location.href = `/login.html?return=${ret}`;
  });

  el.signout.addEventListener('click', async (e)=>{
    e.preventDefault();
    await signOut(auth);
    // ixtiyoriy: logoutdan keyin ham login sahifasiga olib borish
    const ret = encodeURIComponent('/index.html');
    location.href = `/login.html?return=${ret}`;
  });

  // UI holatini kuzatish
  watchAuth((user)=>{
    if(!user){
      el.uname.textContent='Mehmon';
      el.uid.textContent='ID: —';
      el.points.textContent='Ball: —';
      el.uschool.textContent='—';
      el.uclass.textContent='—';
      el.ava.textContent='LM';
      el.ava.style.backgroundImage='';
      el.signin.style.display='inline';
      el.signout.style.display='none';
      if(el.adminLink) el.adminLink.style.display='none';
      el.editProfile.style.display='none';
      return;
    }

    // bu yerda siz users/{uid} dan ma’lumot olib UI ni to‘ldirasiz (o‘zingizdagi logika bilan)
    el.signin.style.display='none';
    el.signout.style.display='inline';
    el.uname.textContent = user.displayName || (user.email?.split('@')[0] ?? 'Foydalanuvchi');
    el.uid.textContent = 'ID: —';
    el.points.textContent = 'Ball: —';
    el.uschool.textContent='Maktab: —';
    el.uclass.textContent='Sinf: —';
    if(user.photoURL){
      el.ava.style.backgroundImage = `url(${user.photoURL})`;
      el.ava.style.backgroundSize = 'cover';
      el.ava.textContent = '';
    } else {
      el.ava.textContent = initials(el.uname.textContent);
    }
    // adminLink’ni ko‘rsatish logikasini users hujjatidan o‘qib qo‘shing (o‘zingizdagi kodni shu yerga ko‘chirasiz)
    el.editProfile.style.display='inline';
  });
</script>
