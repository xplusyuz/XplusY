<!doctype html>
<html lang="uz"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MathCenter — Lite</title><meta name="color-scheme" content="dark"/>
<link rel="stylesheet" href="assets/styles.css"/>
</head><body>
<header class="nav">
  <div class="container stack">
    <div class="brand"><div class="pi">π</div><div>MathCenter Lite</div></div>
    <div class="spacer"></div>
    <button id="btnReyting" class="btn ghost" onclick="location.href='rating-firebase.html'">Reyting</button>
    <button id="btnProfile" class="btn ghost" style="display:none">Profil</button>
    <button id="btnLogout" class="btn ghost" style="display:none">Chiqish</button>
  </div>
</header>

<section id="loginPanel" class="card" style="max-width:420px;margin:56px auto;padding:22px">
  <h2>Kirish</h2>
  <p class="hint">Admin ro‘yxatidan o‘tgan foydalanuvchilar kiradi.</p>
  <div class="grid">
    <div><div class="label">Login</div><input class="input" id="login" placeholder="student1" autocomplete="username"></div>
    <div><div class="label">Parol</div><input class="input" id="password" type="password" placeholder="••••••••" autocomplete="current-password"></div>
    <button id="doLogin" class="btn">Kirish</button>
    <div id="loginErr" class="hint" style="color:#fca5a5;display:none"></div>
  </div>
</section>

<main id="home" style="display:none">
  <div class="container grid" style="gap:16px">
    <div class="card" style="padding:12px;display:flex;align-items:center;gap:12px">
      <div class="avatar" id="avatar"><span id="avatarInit">U</span></div>
      <div style="line-height:1.2">
        <div id="greet" style="font-weight:800"></div>
        <div class="hint">Umumiy ball: <span id="points">0</span> <span class="badge" id="pointSrc">ball.json</span></div>
      </div>
      <div class="spacer"></div>
      <button class="btn ghost" onclick="location.href='liteadmin.html'">Admin</button>
      <button class="btn" id="openProfile">Profil</button>
    </div>

    <div class="card" id="bannerBox" style="overflow:hidden;border-radius:18px"></div>
    <div class="grid" id="grid" style="grid-template-columns:repeat(3,1fr)"></div>
  </div>
</main>

<!-- Profil modal -->
<div class="card" id="profileModal" style="display:none;max-width:640px;margin:16px auto;padding:16px">
  <div style="display:flex;gap:8px;align-items:center">
    <h3 style="margin:0">Profilni tahrirlash</h3><div class="spacer"></div>
    <button class="btn ghost" id="closeProf">Yopish</button>
  </div>
  <div class="grid cols-12">
    <div class="col-3">
      <div class="label">Avatar</div>
      <div class="avatar" id="editAvatar"><img id="editAvatarImg" style="width:100%;height:100%;object-fit:cover;display:none"><span id="editAvatarInit"></span></div>
      <input type="file" id="avatarFile" accept="image/*" style="margin-top:8px">
    </div>
    <div class="col-9 grid cols-12">
      <div class="col-6"><div class="label">Ism</div><input class="input" id="p_name"></div>
      <div class="col-6"><div class="label">Familiya</div><input class="input" id="p_surname"></div>
      <div class="col-6"><div class="label">Sinf</div><input class="input" id="p_class"></div>
      <div class="col-6"><div class="label">Parol</div><input class="input" id="p_password" type="password"></div>
      <div class="col-12" style="display:flex;gap:8px">
        <button class="btn" id="saveProf">Saqlash (mahalliy)</button>
        <button class="btn ghost" id="exportPatch">O‘zgarishni JSON qilib olish</button>
      </div>
      <div class="notice">Lite rejimda faylga yozib bo‘lmaydi. Export qilingan JSON’ni admin <b>liteadmin.html</b> orqali import qiladi.</div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { firebaseConfig } from "./config.js";

const $ = s=>document.querySelector(s);
const state = { db:null, me:null, tests:null, fs:null };

function saveSession(me){ localStorage.setItem('lite.me', JSON.stringify(me)); }
function getSession(){ try{return JSON.parse(localStorage.getItem('lite.me'));}catch{return null;} }
function renderAvatar(el, user){
  const img = el.querySelector('img'); const init = el.querySelector('span');
  if(user.avatar){ if(img){ img.src=user.avatar; img.style.display='block'; } if(init) init.style.display='none'; }
  else{ if(img) img.style.display='none'; if(init) init.textContent=(user.name?.[0]||'U').toUpperCase(); }
}

async function loadJSON(path){ const res = await fetch(path + '?_=' + Date.now()); if(!res.ok) throw new Error(path+' yuklanmadi'); return res.json(); }

async function loadPoints(){
  try{
    if(!state.fs) return await loadFromBall();
    const qy = query(collection(state.fs,"results"), where("login","==", state.me.login));
    const snap = await getDocs(qy);
    let total = 0; snap.forEach(d=>{ const x=d.data(); total += Number(x.score)||0; });
    document.getElementById('points').textContent = total; document.getElementById('pointSrc').textContent='Firestore';
    return;
  }catch(e){
    await loadFromBall();
  }
}
async function loadFromBall(){
  try{
    const b = await loadJSON('ball.json'); const mine = (b.results||[]).filter(r=>r.login===state.me.login);
    const total = mine.reduce((s,r)=>s+(Number(r.score)||0),0);
    document.getElementById('points').textContent = total; document.getElementById('pointSrc').textContent='ball.json';
  }catch(e){ document.getElementById('points').textContent='0'; document.getElementById('pointSrc').textContent='none'; }
}

function openProfile(){
  document.getElementById('profileModal').style.display='block';
  document.getElementById('p_name').value=state.me.name||''; document.getElementById('p_surname').value=state.me.surname||''; document.getElementById('p_class').value=state.me.class||''; document.getElementById('p_password').value=state.me.password||'';
  renderAvatar(document.getElementById('editAvatar'), state.me);
}
function closeProfile(){ document.getElementById('profileModal').style.display='none'; }
function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

async function saveProfile(){
  const me = state.me;
  me.name = document.getElementById('p_name').value.trim(); me.surname = document.getElementById('p_surname').value.trim(); me.class = document.getElementById('p_class').value.trim();
  const pw = document.getElementById('p_password').value.trim(); if(pw) me.password = pw;
  const f = document.getElementById('avatarFile').files[0]; if(f) me.avatar = await fileToDataURL(f);
  saveSession(me); renderAvatar(document.getElementById('avatar'), me); document.getElementById('greet').textContent = `Salom, ${me.name} ${me.surname}`;
  alert('Mahalliy profil yangilandi. Export qiling va admin import qilsin.');
}
function exportProfilePatch(){
  const patch = {type:'profile_patch', login: state.me.login, changes:{
    name: document.getElementById('p_name').value.trim(), surname: document.getElementById('p_surname').value.trim(), class: document.getElementById('p_class').value.trim(),
    password: document.getElementById('p_password').value.trim() || undefined, avatar: state.me.avatar || undefined
  }};
  const blob = new Blob([JSON.stringify(patch,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download = `profile_update_${state.me.login}.json`; a.click(); URL.revokeObjectURL(a.href);
}

async function render(){
  const banners = (state.db.banners||[]).filter(b=>b.active);
  const box = document.getElementById('bannerBox'); box.innerHTML='';
  banners.forEach(b=>{ const wrap=document.createElement('a'); wrap.href=b.link||'#'; wrap.innerHTML=`<img src="${b.image}" style="width:100%;max-height:300px;object-fit:cover;border-radius:18px">`; box.appendChild(wrap); });
  const grid = document.getElementById('grid'); grid.innerHTML=''; (state.db.cards||[]).filter(c=>c.active).forEach(c=>{
    const a=document.createElement('a'); a.className='card'; a.href=c.link||'#'; a.style.overflow='hidden'; a.innerHTML=`
      <div style="height:180px;overflow:hidden"><img src="${c.image}" alt="${c.title}" style="width:100%;height:100%;object-fit:cover"></div>
      <div style="padding:12px"><div style="font-weight:800">${c.title}</div><div class="hint">${(c.tags||[]).join(' · ')}</div></div>`; grid.appendChild(a);
  });
}

async function tryAutoLogin(){
  const me = getSession(); if(!me) return;
  state.me = me; document.getElementById('loginPanel').style.display='none'; document.getElementById('home').style.display='block';
  document.getElementById('greet').textContent = `Salom, ${me.name} ${me.surname}`; renderAvatar(document.getElementById('avatar'), me);
  state.db = await loadJSON('liteadmin.json'); await render(); await loadPoints();
}

document.getElementById('doLogin').onclick = async ()=>{
  try{
    document.getElementById('loginErr').style.display='none';
    const login = document.getElementById('login').value.trim(); const pass = document.getElementById('password').value.trim();
    const db = await loadJSON('liteadmin.json');
    if(login===db.auth?.admin?.login && pass===db.auth?.admin?.password){
      const me={login, name:'Admin', surname:'', class:'', role:'admin'}; state.me=me; saveSession(me); location.href='liteadmin.html'; return;
    }
    const u = (db.users||[]).find(u=>u.login===login && u.password===pass);
    if(!u) throw new Error('Login yoki parol xato.');
    const me={...u, role:'user'}; state.me=me; saveSession(me);
    document.getElementById('loginPanel').style.display='none'; document.getElementById('home').style.display='block';
    document.getElementById('greet').textContent = `Salom, ${me.name} ${me.surname}`; renderAvatar(document.getElementById('avatar'), me);
    state.db = db;
    try{
      const app = initializeApp(firebaseConfig);
      state.fs = getFirestore(app);
    }catch(e){}
    await render(); await loadPoints();
  }catch(err){
    document.getElementById('loginErr').textContent = err.message; document.getElementById('loginErr').style.display='block';
  }
};

document.getElementById('btnLogout').onclick = ()=>{ localStorage.removeItem('lite.me'); location.reload(); };
document.getElementById('openProfile').onclick = ()=>openProfile();
document.getElementById('btnProfile').onclick = ()=>openProfile();
document.getElementById('closeProf').onclick = ()=>closeProfile();
document.getElementById('saveProf').onclick = ()=>saveProfile();
document.getElementById('exportPatch').onclick = ()=>exportProfilePatch();

tryAutoLogin();
</script>
</body></html>