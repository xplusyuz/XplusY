<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MathCenter — Lite</title>
  <meta name="color-scheme" content="light"/>
  <style>
    :root{
      --green:#2E8B57;
      --green-700:#1F6B45;
      --bg:#f7faf8;
      --text:#1a1f1c;
      --muted:#6b7280;
      --card:#ffffff;
      --shadow:0 8px 24px rgba(0,0,0,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{text-decoration:none;color:inherit}
    img{display:block;max-width:100%}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow)}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;background:var(--green);color:#fff;border:0;cursor:pointer;font-weight:600}
    .btn.ghost{background:#e9f5ef;color:var(--green)}
    header.nav{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.8);backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid #eee}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--green)}
    .brand .pi{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--green),var(--green-700));display:grid;place-items:center;color:#fff;box-shadow:var(--shadow)}
    .stack{display:flex;align-items:center;gap:10px}
    .spacer{flex:1}
    /* Login panel */
    #loginPanel{max-width:420px;margin:56px auto;padding:22px}
    #loginPanel h2{margin:0 0 8px}
    label{font-size:13px;color:var(--muted)}
    input,select{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;outline:0}
    .hint{font-size:12px;color:var(--muted)}
    /* Banner carousel */
    .carousel{position:relative;overflow:hidden;border-radius:var(--radius)}
    .carousel .slides{display:flex;transition:transform .4s ease}
    .carousel .slide{min-width:100%;position:relative;height:220px}
    .carousel .slide img{object-fit:cover;width:100%;height:100%}
    .carousel .caption{position:absolute;inset:auto 16px 16px 16px;background:rgba(0,0,0,.45);color:#fff;padding:12px;border-radius:14px}
    .carousel .dots{position:absolute;left:0;right:0;bottom:10px;display:flex;justify-content:center;gap:6px}
    .dot{width:8px;height:8px;border-radius:50%;background:#ffffff80}
    .dot.active{background:#fff}
    /* Filters */
    .filters{display:flex;flex-wrap:wrap;gap:8px;margin:16px 0}
    .chip{padding:8px 12px;border-radius:999px;border:1px solid #d1d5db;background:#fff;font-size:13px;cursor:pointer}
    .chip.main{font-weight:700;padding:10px 16px}
    .chip.active{background:#e9f5ef;border-color:#b7e2c7;color:var(--green)}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
    .tile{overflow:hidden}
    .tile .thumb{height:160px}
    .tile .body{padding:12px}
    .meta{font-size:12px;color:var(--muted)}
    .badge{padding:4px 8px;border-radius:999px;background:#e9f5ef;color:var(--green);font-size:12px}
    /* User bar */
    .userbar{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;background:#f0f7f3}
    .avatar{width:36px;height:36px;border-radius:50%;background:#e0f2e9;display:grid;place-items:center;font-weight:700;color:var(--green-700);overflow:hidden}
    .avatar img{width:36px;height:36px;object-fit:cover;border-radius:50%}
    /* Footer */
    footer{padding:30px 0;color:var(--muted);text-align:center}
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px}
    .modal .box{max-width:520px;width:100%;background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:16px}
    /* Responsive */
    @media (max-width:960px){ .grid{grid-template-columns:repeat(2,1fr)} .carousel .slide{height:180px} }
    @media (max-width:640px){ .row{grid-template-columns:repeat(6,1fr)} .grid{grid-template-columns:1fr} #loginPanel{margin:24px auto} }
  </style>
</head>
<body>
  <header class="nav">
    <div class="container stack">
      <div class="brand">
        <div class="pi">π</div>
        <div>MathCenter Lite</div>
      </div>
      <div class="spacer"></div>
      <a class="btn ghost" href="reyting.html">Reyting</a>
      <button id="btnAdmin" class="btn ghost" style="display:none">Admin</button>
      <button id="btnProfile" class="btn ghost" style="display:none">Profil</button>
      <button id="btnLogout" class="btn ghost" style="display:none">Chiqish</button>
    </div>
  </header>

  <!-- LOGIN -->
  <section id="loginPanel" class="card">
    <h2>Kirish</h2>
    <p class="hint">Tizimga kirish faqat admin tomonidan ro‘yxatga olingan foydalanuvchilar uchun.</p>
    <div style="display:grid;gap:12px;margin-top:12px">
      <div><label>Login</label><input id="login" placeholder="Masalan: student1" autocomplete="username"/></div>
      <div><label>Parol</label><input id="password" type="password" placeholder="••••••••" autocomplete="current-password"/></div>
      <button id="doLogin" class="btn">Kirish</button>
      <div id="loginErr" class="hint" style="color:#b91c1c;display:none"></div>
    </div>
  </section>

  <!-- HOME -->
  <main id="home" style="display:none">
    <div class="container" style="display:grid;gap:16px">
      <div class="userbar card">
        <div class="avatar" id="avatar"><span id="avatarText">U</span></div>
        <div style="line-height:1.2">
          <div id="greet" style="font-weight:700"></div>
          <div class="meta">Ball (ball.json): <span id="points">0</span></div>
        </div>
        <div class="spacer"></div>
        <div class="badge" id="roleBadge">User</div>
      </div>

      <!-- Banners -->
      <div class="carousel card" id="carousel" aria-label="bannerlar">
        <div class="slides" id="slides"></div>
        <div class="dots" id="dots"></div>
      </div>

      <!-- Main tags (asosiy) -->
      <div class="filters" id="mainTags"></div>
      <!-- Sub tags (mayda) -->
      <div class="filters" id="filters"></div>

      <!-- Cards -->
      <div class="grid" id="grid"></div>
    </div>
  </main>

  <!-- PROFILE MODAL -->
  <div class="modal" id="modal">
    <div class="box">
      <h3>Profilni tahrirlash</h3>
      <p class="hint">Ma'lumotlaringizni yangilang. Parolni o'zgartirsangiz, keyingi kirishda yangi parol bilan kiring.</p>
      <div class="row" style="margin-top:8px">
        <div class="card" style="grid-column:span 12;padding:12px;display:flex;gap:12px;align-items:center">
          <div class="avatar"><img id="p_avatar_preview" alt=""></div>
          <div>
            <label>Avatar rasm</label>
            <input id="p_avatar_file" type="file" accept="image/*"/>
          </div>
        </div>
        <div style="grid-column:span 6"><label>Ism</label><input id="p_name"></div>
        <div style="grid-column:span 6"><label>Familiya</label><input id="p_surname"></div>
        <div style="grid-column:span 6"><label>Sinf</label><input id="p_class"></div>
        <div style="grid-column:span 6"><label>Parolni o'zgartirish</label><input id="p_password" type="password" placeholder="Yangi parol"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn ghost" id="p_close">Bekor qilish</button>
        <button class="btn" id="p_save">Saqlash (JSON yuklash)</button>
      </div>
    </div>
  </div>

  <footer>
    <div class="container">© 2025 MathCenter Lite — faqat ballik, balanssiz.</div>
  </footer>

  <script>
    const $ = sel => document.querySelector(sel);
    const state = { db: null, me: null, main: 'hammasi', tag: 'hammasi', tags: new Set(['hammasi']), mains: new Set(['hammasi']), scores: [] };

    async function loadJSON(url){
      const res = await fetch(url + '?_=' + Date.now());
      if(!res.ok) throw new Error(url + ' yuklanmadi');
      return res.json();
    }

    async function loadDB(){
      const db = await loadJSON('liteadmin.json');
      state.db = db;
      return db;
    }
    async function loadScores(){
      try{ state.scores = await loadJSON('ball.json'); }
      catch{ state.scores = []; }
    }

    function saveSession(me){ localStorage.setItem('lite.me', JSON.stringify(me)); }
    function getSession(){ try{return JSON.parse(localStorage.getItem('lite.me'));}catch{return null;} }
    function logout(){ localStorage.removeItem('lite.me'); location.reload(); }

    function dataURL(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = e=>resolve(e.target.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }
    function downloadJSON(obj, name){
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);
    }

    function renderHome(){
      $('#btnLogout').style.display='inline-flex';
      $('#btnProfile').style.display='inline-flex';
      const isAdmin = state.me.role === 'admin';
      $('#btnAdmin').style.display = isAdmin ? 'inline-flex' : 'none';
      $('#greet').textContent = `Salom, ${state.me.name} ${state.me.surname}`;
      $('#roleBadge').textContent = isAdmin ? 'Admin' : 'Foydalanuvchi';

      // avatar
      const av = state.me.avatar;
      if(av){
        $('#avatar').innerHTML = '<img src="'+av+'"/>';
      }else{
        $('#avatar').innerHTML = '<span id="avatarText">'+(state.me.name?.[0] ?? 'U').toUpperCase()+'</span>';
      }

      // total points from ball.json for this login
      const myLogin = state.me.login;
      const total = (state.scores||[]).filter(x=>x.login===myLogin).reduce((s,x)=>s+(x.score||0),0);
      $('#points').textContent = total;

      // banners
      const slides = $('#slides'); slides.innerHTML='';
      const dots = $('#dots'); dots.innerHTML='';
      const banners = (state.db.banners||[]).filter(b=>b.active);
      banners.forEach((b,i)=>{
        const s = document.createElement('a');
        s.className='slide'; s.href=b.link||'#'; s.target='_blank';
        s.innerHTML = `<img src="${b.image}" alt="${b.title}"><div class="caption"><div style="font-weight:800;font-size:18px">${b.title}</div><div>${b.subtitle||''}</div></div>`;
        slides.appendChild(s);
        const dot = document.createElement('div'); dot.className='dot'+(i===0?' active':''); dots.appendChild(dot);
      });
      let idx=0; setInterval(()=>{
        if(!banners.length) return;
        idx=(idx+1)%banners.length;
        slides.style.transform=`translateX(-${idx*100}%)';
        [...dots.children].forEach((d,i)=>d.classList.toggle('active', i===idx));
      }, 3500);

      // Main & Sub tags
      const mainBox = $('#mainTags'); mainBox.innerHTML='';
      const filters = $('#filters'); filters.innerHTML='';
      state.mains = new Set(['hammasi']);
      (state.db.cards||[]).filter(c=>c.active).forEach(c=>state.mains.add(c.main||'boshqa'));
      [...state.mains].forEach(m=>{
        const chip=document.createElement('button');
        chip.className='chip main'+(m===state.main?' active':''); chip.textContent=m;
        chip.onclick=()=>{ state.main=m; state.tag='hammasi'; renderHome(); };
        mainBox.appendChild(chip);
      });
      state.tags = new Set(['hammasi']);
      (state.db.cards||[]).filter(c=>c.active && (state.main==='hammasi' || (c.main||'boshqa')===state.main)).forEach(c=>c.tags?.forEach(t=>state.tags.add(t)));
      [...state.tags].forEach(t=>{
        const chip=document.createElement('button');
        chip.className='chip'+(t===state.tag?' active':''); chip.textContent=t;
        chip.onclick=()=>{state.tag=t; renderCards(); renderFilters();};
        filters.appendChild(chip);
      });
      function renderFilters(){
        filters.querySelectorAll('.chip').forEach(ch=>ch.classList.toggle('active', ch.textContent===state.tag));
        mainBox.querySelectorAll('.chip.main').forEach(ch=>ch.classList.toggle('active', ch.textContent===state.main));
      }
      renderCards();
      function renderCards(){
        const grid = $('#grid'); grid.innerHTML='';
        const list = (state.db.cards||[]).filter(c=>{
          if(!c.active) return false;
          const inMain = (state.main==='hammasi') || ((c.main||'boshqa')===state.main);
          const inSub = (state.tag==='hammasi') || ((c.tags||[]).includes(state.tag));
          return inMain && inSub;
        });
        list.forEach(c=>{
          const el = document.createElement('a');
          el.className='tile card'; el.href=c.link||'#'; el.target='_blank';
          el.innerHTML = `
            <div class="thumb"><img src="${c.image}" alt="${c.title}" style="width:100%;height:100%;object-fit:cover"></div>
            <div class="body">
              <div style="font-weight:700">${c.title}</div>
              <div class="meta" style="margin-top:4px">${(c.tags||[]).join(' · ')}</div>
            </div>`;
          grid.appendChild(el);
        });
      }
    }

    async function tryAutoLogin(){
      const me = getSession();
      if(me){
        state.me = me;
        $('#loginPanel').style.display='none';
        $('#home').style.display='block';
        await loadDB();
        await loadScores();
        renderHome();
      }
    }

    // Profile modal handlers
    $('#btnProfile').onclick = async ()=>{
      const db = state.db || await loadDB();
      const u = (db.users||[]).find(x=>x.login===state.me.login);
      $('#p_name').value = u?.name || '';
      $('#p_surname').value = u?.surname || '';
      $('#p_class').value = u?.class || '';
      $('#p_password').value = '';
      if(u?.avatar){ $('#p_avatar_preview').src = u.avatar; } else { $('#p_avatar_preview').removeAttribute('src'); }
      $('#modal').style.display='flex';
    };
    $('#p_close').onclick = ()=>$('#modal').style.display='none';
    $('#p_avatar_file').addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const url = await dataURL(f);
      $('#p_avatar_preview').src = url;
    });
    $('#p_save').onclick = async ()=>{
      const db = state.db || await loadDB();
      const u = (db.users||[]).find(x=>x.login===state.me.login);
      if(!u) return alert('Foydalanuvchi topilmadi');
      u.name = $('#p_name').value.trim();
      u.surname = $('#p_surname').value.trim();
      u.class = $('#p_class').value.trim();
      const npass = $('#p_password').value.trim();
      if(npass) u.password = npass;
      const img = $('#p_avatar_preview').getAttribute('src');
      if(img) u.avatar = img;

      // session update
      state.me.name = u.name; state.me.surname = u.surname; state.me.avatar = u.avatar;
      saveSession(state.me);
      renderHome();
      // Download updated JSON so admin can replace the file on hosting
      downloadJSON(db, 'liteadmin.json');
      alert('Profil yangilandi. Yangi liteadmin.json faylini hostingga qo\'ying.');
      $('#modal').style.display='none';
    };

    $('#btnLogout').onclick=logout;
    $('#btnAdmin').onclick=()=>location.href='liteadmin.html';
    document.getElementById('doLogin').onclick=async ()=>{
      try{
        document.getElementById('loginErr').style.display='none';
        const login = document.getElementById('login').value.trim();
        const pass = document.getElementById('password').value.trim();
        const db = await loadDB();
        if(login===db.auth?.admin?.login && pass===db.auth?.admin?.password){
          const me={login:'admin',name:'Admin',surname:'',role:'admin',points:0};
          state.me=me; saveSession(me); location.href='liteadmin.html'; return;
        }
        const u = (db.users||[]).find(u=>u.login===login && u.password===pass);
        if(!u){ throw new Error('Login yoki parol xato.'); }
        const me={login:u.login,name:u.name,surname:u.surname,role:'user',avatar:u.avatar||null};
        state.me=me; saveSession(me);
        document.getElementById('loginPanel').style.display='none';
        document.getElementById('home').style.display='block';
        await loadScores();
        renderHome();
      }catch(err){
        document.getElementById('loginErr').textContent=err.message;
        document.getElementById('loginErr').style.display='block';
      }
    };

    tryAutoLogin();
  </script>
</body>
</html>
