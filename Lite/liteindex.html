<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MathCenter — Lite</title>
  <meta name="color-scheme" content="light"/>
  <style>
:root{--green:#2E8B57;--green-700:#1F6B45;--bg:#f7faf8;--text:#1a1f1c;--muted:#6b7280;--card:#fff;--shadow:0 8px 24px rgba(0,0,0,.08);--radius:18px}
*{box-sizing:border-box} html,body{margin:0;height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
.container{max-width:1100px;margin:0 auto;padding:16px}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow)}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;background:var(--green);color:#fff;border:0;cursor:pointer;font-weight:600}
.btn.ghost{background:#e9f5ef;color:var(--green)}
header.nav{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid #eee}
.brand{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--green)}
.brand .pi{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--green),var(--green-700));display:grid;place-items:center;color:#fff;box-shadow:var(--shadow)}
.stack{display:flex;align-items:center;gap:10px}.spacer{flex:1}
label{font-size:13px;color:var(--muted)}
input,select,textarea{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;outline:0}
.hint{font-size:12px;color:var(--muted)}
.avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#d1fae5,#a7f3d0);display:grid;place-items:center;font-weight:700;color:var(--green-700);overflow:hidden}
.table{width:100%;border-collapse:separate;border-spacing:0 10px}
.table th,.table td{text-align:left;padding:10px 12px;vertical-align:middle;background:#fff}
.table tr td:first-child,.table tr th:first-child{border-top-left-radius:12px;border-bottom-left-radius:12px}
.table tr td:last-child,.table tr th:last-child{border-top-right-radius:12px;border-bottom-right-radius:12px}

  .userbar{display:flex;align-items:center;gap:12px;padding:10px;border-radius:12px;background:#f0f7f3;margin-top:12px}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  .tile .thumb{height:160px;overflow:hidden;border-top-left-radius:18px;border-top-right-radius:18px}
  .tile .body{padding:12px}
  .meta{font-size:12px;color:var(--muted)}
  @media (max-width:960px){ .grid{grid-template-columns:repeat(2,1fr)} }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px}
  .modal .panel{max-width:540px;width:100%;background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:16px}
  </style>
</head>
<body>
  <header class="nav">
    <div class="container stack">
      <div class="brand"><div class="pi">π</div><div>MathCenter Lite</div></div>
      <div class="spacer"></div>
      <button id="btnReyting" class="btn ghost" onclick="location.href='rating.html'">Reyting</button>
      <button id="btnAdmin" class="btn ghost" style="display:none">Admin</button>
      <button id="btnProfile" class="btn ghost" style="display:none">Profil</button>
      <button id="btnLogout" class="btn ghost" style="display:none">Chiqish</button>
    </div>
  </header>

  <!-- LOGIN -->
  <section id="loginPanel" class="card" style="max-width:420px;margin:56px auto;padding:22px">
    <h2>Kirish</h2>
    <p class="hint">Admin ro‘yxatidan o‘tgan foydalanuvchilar kirishi mumkin.</p>
    <div style="display:grid;gap:12px;margin-top:12px">
      <div><label>Login</label><input id="login" placeholder="student1" autocomplete="username"></div>
      <div><label>Parol</label><input id="password" type="password" placeholder="••••••••" autocomplete="current-password"></div>
      <button id="doLogin" class="btn">Kirish</button>
      <div id="loginErr" class="hint" style="color:#b91c1c;display:none"></div>
    </div>
  </section>

  <!-- HOME -->
  <main id="home" style="display:none">
    <div class="container" style="display:grid;gap:16px">
      <div class="userbar card">
        <div class="avatar" id="avatar"><span id="avatarInit">U</span></div>
        <div style="line-height:1.2">
          <div id="greet" style="font-weight:700"></div>
          <div class="meta">Umumiy ball (ball.json): <span id="points">0</span></div>
        </div>
        <div class="spacer"></div>
        <div class="meta" id="roleBadge">User</div>
      </div>

      <!-- Bannerlar -->
      <div class="card" id="bannerBox" style="overflow:hidden;border-radius:18px">
        <div id="banners"></div>
      </div>

      <!-- Cards -->
      <div class="grid" id="grid"></div>

      <!-- Testlar (test.json) -->
      <div class="card" style="padding:16px">
        <h3>Testlar</h3>
        <table class="table" id="testsT">
          <thead><tr><th>Sarlavha</th><th>Boshlash</th><th>Tugash</th><th>Davomiylik</th><th>Amal</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Profil tahrirlash -->
  <div class="modal" id="profileModal" aria-hidden="true">
    <div class="panel">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <h3 style="margin:0">Profilni tahrirlash</h3>
        <div class="spacer"></div>
        <button class="btn ghost" onclick="closeProfile()">Yopish</button>
      </div>
      <div class="card" style="padding:12px;display:grid;gap:10px">
        <div style="display:grid;grid-template-columns:96px 1fr;gap:12px;align-items:center">
          <div class="avatar" id="editAvatar"><img id="editAvatarImg" alt="" style="width:100%;height:100%;object-fit:cover;display:none"><span id="editAvatarInit"></span></div>
          <div>
            <input type="file" id="avatarFile" accept="image/*">
            <div class="hint">Yangi avatar yuklang (ixtiyoriy).</div>
          </div>
        </div>
        <div><label>Ism</label><input id="p_name"></div>
        <div><label>Familiya</label><input id="p_surname"></div>
        <div><label>Sinf</label><input id="p_class"></div>
        <div><label>Parol</label><input id="p_password" type="password" placeholder="Yangi parol"></div>
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="saveProfile()">Saqlash (mahalliy)</button>
          <button class="btn ghost" onclick="exportProfilePatch()">O‘zgarishni JSON qilib yuklab olish</button>
        </div>
        <div class="hint">Eslatma: Lite rejimda fayllarni serverga yozib bo‘lmaydi. Bu tugma profil o‘zgarishlaringizni JSON ko‘rinishida yuklab beradi — admin ularni <b>liteadmin.html</b> sahifasiga import qiladi.</div>
      </div>
    </div>
  </div>

  <script>
  const $ = s=>document.querySelector(s);
  const state = { db:null, me:null, results:null, tests:null };

  function saveSession(me){ localStorage.setItem('lite.me', JSON.stringify(me)); }
  function getSession(){ try{return JSON.parse(localStorage.getItem('lite.me'));}catch{return null;} }
  function logout(){ localStorage.removeItem('lite.me'); location.reload(); }

  async function loadJSON(path){ const res = await fetch(path + '?_=' + Date.now()); if(!res.ok) throw new Error(path+' yuklanmadi'); return res.json(); }

  function renderAvatar(el, user){
    const img = el.querySelector('img');
    const init = el.querySelector('span');
    if(user.avatar){ img.src = user.avatar; img.style.display='block'; if(init) init.style.display='none'; }
    else{ if(img) img.style.display='none'; if(init) init.textContent = (user.name?.[0]||'U').toUpperCase(); }
  }

  function openProfile(){
    document.getElementById('profileModal').style.display='flex';
    document.getElementById('p_name').value = state.me.name||'';
    document.getElementById('p_surname').value = state.me.surname||'';
    document.getElementById('p_class').value = state.me.class||'';
    document.getElementById('p_password').value = state.me.password||'';
    renderAvatar(document.getElementById('editAvatar'), state.me);
  }
  function closeProfile(){ document.getElementById('profileModal').style.display='none'; }

  function fileToDataURL(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(file);
    });
  }

  async function saveProfile(){
    const me = state.me;
    me.name = document.getElementById('p_name').value.trim();
    me.surname = document.getElementById('p_surname').value.trim();
    me.class = document.getElementById('p_class').value.trim();
    const pw = document.getElementById('p_password').value.trim();
    if(pw) me.password = pw;
    const f = document.getElementById('avatarFile').files[0];
    if(f) me.avatar = await fileToDataURL(f);
    saveSession(me);
    document.getElementById('greet').textContent = `Salom, ${me.name} ${me.surname}`;
    renderAvatar(document.getElementById('avatar'), me);
    alert('Mahalliy profil yangilandi. Admin import qilishi uchun «O‘zgarishni JSON qilib yuklab olish» tugmasidan foydalaning.');
  }

  function exportProfilePatch(){
    const patch = {
      type: 'profile_patch',
      login: state.me.login,
      changes: {
        name: document.getElementById('p_name').value.trim(),
        surname: document.getElementById('p_surname').value.trim(),
        class: document.getElementById('p_class').value.trim(),
        password: document.getElementById('p_password').value.trim() || undefined,
      }
    };
    if(state.me.avatar) patch.changes.avatar = state.me.avatar;
    const blob = new Blob([JSON.stringify(patch,null,2)],{type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = `profile_update_${state.me.login}.json`; a.click(); URL.revokeObjectURL(a.href);
  }

  async function recalcPoints(){
    try{
      const ball = await loadJSON('ball.json');
      const mine = (ball.results||[]).filter(r=>r.login===state.me.login);
      const total = mine.reduce((s,r)=>s+(Number(r.score)||0),0);
      document.getElementById('points').textContent = total;
    }catch(e){ console.warn(e); }
  }

  async function render(){
    const banners = (state.db.banners||[]).filter(b=>b.active);
    const box = document.getElementById('banners'); box.innerHTML='';
    banners.forEach(b=>{ 
      const el = document.createElement('a'); el.href=b.link||'#'; el.target='_blank';
      el.innerHTML = `<img src="${b.image}" alt="${b.title}"><div style="position:absolute;inset:auto 16px 16px 16px;background:rgba(0,0,0,.45);color:#fff;padding:12px;border-radius:14px"><div style="font-weight:800;font-size:18px">${b.title}</div><div>${b.subtitle||''}</div></div>`;
      const wrapper = document.createElement('div'); wrapper.style.position='relative'; wrapper.appendChild(el);
      box.appendChild(wrapper);
    });

    const grid = document.getElementById('grid'); grid.innerHTML='';
    (state.db.cards||[]).filter(c=>c.active).forEach(c=>{
      const a = document.createElement('a');
      a.className='tile card'; a.href=c.link||'#';
      a.innerHTML = `<div class="thumb"><img src="${c.image}" alt="${c.title}" style="width:100%;height:100%;object-fit:cover"></div>
        <div class="body"><div style="font-weight:700">${c.title}</div><div class="meta">${(c.tags||[]).join(' · ')}</div></div>`;
      grid.appendChild(a);
    });

    const testsT = document.querySelector('#testsT tbody'); testsT.innerHTML='';
    (state.tests?.tests||[]).forEach(t=>{
      const tr = document.createElement('tr');
      const dur = Math.round((t.durationSec||0)/60)+' min';
      tr.innerHTML = `<td>${t.title}</td><td>${t.start}</td><td>${t.end}</td><td>${dur}</td>
        <td><a class="btn" href="test.html?id=${t.id}">Boshlash</a></td>`;
      testsT.appendChild(tr);
    });
  }

  async function tryAutoLogin(){
    const me = getSession();
    if(me){
      state.me = me;
      document.getElementById('loginPanel').style.display='none'; document.getElementById('home').style.display='block';
      document.getElementById('btnLogout').style.display='inline-flex'; document.getElementById('btnProfile').style.display='inline-flex';
      document.getElementById('btnAdmin').style.display = (me.role==='admin') ? 'inline-flex' : 'none';
      document.getElementById('greet').textContent = `Salom, ${me.name} ${me.surname}`;
      document.getElementById('roleBadge').textContent = (me.role==='admin')?'Admin':'Foydalanuvchi';
      renderAvatar(document.getElementById('avatar'), me);
      state.db = await loadJSON('liteadmin.json');
      state.tests = await loadJSON('test.json');
      await render(); await recalcPoints();
    }
  }

  document.getElementById('doLogin').onclick = async ()=>{
    try{
      document.getElementById('loginErr').style.display='none';
      const login = document.getElementById('login').value.trim();
      const pass = document.getElementById('password').value.trim();
      const db = await loadJSON('liteadmin.json');
      if(login===db.auth?.admin?.login && pass===db.auth?.admin?.password){
        const me={login, name:'Admin', surname:'', class:'', role:'admin', points:0};
        state.me=me; saveSession(me); location.href='liteadmin.html'; return;
      }
      const u = (db.users||[]).find(u=>u.login===login && u.password===pass);
      if(!u) throw new Error('Login yoki parol xato.');
      const me={...u, role:'user'}; state.me=me; saveSession(me);
      document.getElementById('loginPanel').style.display='none'; document.getElementById('home').style.display='block';
      document.getElementById('btnLogout').style.display='inline-flex'; document.getElementById('btnProfile').style.display='inline-flex';
      document.getElementById('btnAdmin').style.display='none';
      document.getElementById('greet').textContent = `Salom, ${me.name} ${me.surname}`;
      renderAvatar(document.getElementById('avatar'), me);
      state.db = db; state.tests = await loadJSON('test.json');
      await render(); await recalcPoints();
    }catch(err){
      document.getElementById('loginErr').textContent = err.message; document.getElementById('loginErr').style.display='block';
    }
  };

  document.getElementById('btnLogout').onclick = logout;
  document.getElementById('btnAdmin').onclick = ()=>location.href='liteadmin.html';
  document.getElementById('btnProfile').onclick = openProfile;

  tryAutoLogin();
  </script>
</body>
</html>
