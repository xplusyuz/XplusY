<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MathCenter ‚Äî Rasm-Only Test (Firebase + Bo‚Äòlimlar + Tahlil + Random opts)</title>

  <!-- MathJax v3 -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$','$'],['\\(','\\)']], displayMath: [['$$','$$'],['\\[','\\]']], processEscapes:true, packages:{'[+]':['noerrors']} },
      options: { renderActions: { addMenu: [] } }, loader: { load: ['[tex]/noerrors'] }
    };
  </script>
  <script id="MathJax-script" async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root{
      --green:#2E8B57; --green-dark:#1F6B45;
      --red:#c62828; --red-bg:#fff2f2; --red-ring:rgba(198,40,40,.18);
      --ok-bg:#f3fbf6; --ok-bd:#cfe4d7; --bg:#f7faf8; --card:#fff; --text:#0f172a; --muted:#475569; --outline:#e6efe8; --ring:rgba(46,139,87,.25);
      --chip:#ffffffc9;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:linear-gradient(180deg,#f1f8f4 0%,#f7faf8 100%)}
    .wrap{max-width:980px;margin:26px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--outline);border-radius:18px;padding:18px;box-shadow:0 8px 24px rgba(31,107,69,.06)}
    .header{background:radial-gradient(1200px 600px at -10% -10%, #e8f5ee, transparent 60%), radial-gradient(1200px 600px at 110% -10%, #e3f3ec, transparent 60%); display:grid;gap:10px}
    .title{display:flex;align-items:center;gap:12px;font-weight:700;font-size:22px}
    .pi{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(135deg,var(--green),var(--green-dark));color:#fff;font-weight:800;box-shadow:0 6px 18px rgba(46,139,87,.35)}
    .sub{color:var(--muted);font-size:14px}
    .meta{display:flex;flex-wrap:wrap;gap:10px;color:#0b3a25;font-size:13px}
    .chip{border:1px solid #d8e9df;background:var(--chip);padding:8px 10px;border-radius:999px;font-variant-numeric:tabular-nums}
    .timer.warn{color:#a15b00;border-color:#f5d7b4;background:#fff9f0}
    .timer.crit{color:#a11212;border-color:#f2c6c6;background:#fff4f4}

    .qwrap{display:grid;gap:12px}
    .qhead{display:flex;justify-content:space-between;align-items:baseline;gap:12px}
    .qname{font-weight:700}
    .qpts{color:var(--muted);font-size:13px}

    .qimg{ margin:8px 0 4px; }
    .qimg img{ max-width:100%;height:auto;display:block;border-radius:12px;border:1px solid #edf3ee;box-shadow:0 6px 18px rgba(31,107,69,.06) }

    .opts{display:grid;gap:10px}
    .opt{display:grid;grid-template-columns:24px 1fr;gap:10px;align-items:start;padding:10px 12px;border:1px solid #edf3ee;border-radius:12px;background:#fbfdfc;transition:border-color .15s,box-shadow .15s,background .15s}
    .opt:hover{border-color:var(--green);box-shadow:0 0 0 4px var(--ring);background:#fff}
    .opt input{transform:translateY(2px)}
    .opt label .mj{display:inline-block}

    .actions{display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;margin-top:16px}
    .btn{appearance:none;border:none;cursor:pointer;padding:12px 16px;border-radius:12px;font-weight:700;background:linear-gradient(135deg,var(--green),var(--green-dark));color:#fff;box-shadow:0 10px 24px rgba(46,139,87,.35)}
    .btn.secondary{background:#fff;color:#1F6B45;border:1px solid #cfe4d7;box-shadow:none}
    .btn.warn{background:linear-gradient(135deg,#e65100,#bf360c)}
    .btn.ghost{background:#fff;color:#0b3a25;border:1px dashed #cfe4d7}

    .hidden{display:none !important}
    .muted{color:var(--muted);font-size:14px}
    .divider{height:1px;background:#edf3ee;margin:8px 0}

    /* Navigator */
    .navwrap{margin-top:16px}
    .navlegend{display:flex;gap:12px;align-items:center;color:#64748b;font-size:13px;margin-bottom:8px}
    .dot{width:10px;height:10px;border-radius:50%}
    .navgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(40px,1fr));gap:10px}
    .navbtn{appearance:none;border:1px solid var(--outline);background:#fff;color:#0b3a25;border-radius:12px;padding:10px 0;cursor:pointer;font-weight:800;transition:.15s}
    .navbtn.current{background:linear-gradient(135deg,var(--green),var(--green-dark));color:#fff;border-color:transparent}
    .navbtn.answered:not(.current){background:var(--ok-bg);border-color:var(--ok-bd)}
    .navbtn.unanswered:not(.current){background:var(--red-bg);border-color:#f1c9c9;color:#var(--red);box-shadow:0 0 0 3px var(--red-ring)}

    /* Result */
    .score{display:grid;gap:10px;padding:16px;border:1px dashed #cfe4d7;border-radius:14px;background:#f8fbf9}
    .big{font-weight:800;font-size:22px;color:#1F6B45}
    .kpi{display:flex;flex-wrap:wrap;gap:10px}
    .authbar{display:flex;gap:10px;align-items:center}

    /* Sections chips */
    .sections{display:flex;flex-wrap:wrap;gap:8px}
    .s-chip{border:1px solid #dfeae3;background:#fff;border-radius:999px;padding:6px 10px;font-size:12px}

    /* Analysis table */
    table.analysis{width:100%;border-collapse:collapse;font-size:14px}
    .analysis th,.analysis td{border:1px solid #edf3ee;padding:8px;vertical-align:top}
    .analysis th{background:#f6faf8;text-align:left}
    .analysis .ok{color:#1F6B45;font-weight:700}
    .analysis .bad{color:#b71c1c;font-weight:700}
    .pill{display:inline-block;border-radius:999px;border:1px solid #dfeae3;background:#fff;padding:2px 8px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <section class="header card">
      <div class="title">
        <div class="pi">œÄ</div>
        <div id="testTitle">Rasm-Only Test</div>
      </div>
      <div id="testDesc" class="sub">Savol matnisiz: rasm + variantlar.</div>
      <div class="meta">
        <div id="metaCount" class="chip">Savollar: ‚Äî</div>
        <div id="metaPoints" class="chip">Umumiy ball: ‚Äî</div>
        <div id="metaType" class="chip">‚Äî</div>
        <div id="metaTimer" class="chip timer hidden">00:00</div>
        <div id="authInfo" class="chip">Kirish: tekshirilmoqda‚Ä¶</div>
      </div>
    </section>

    <!-- One-by-one Question View -->
    <section id="questionsCard" class="card">
      <div id="questionView" class="qwrap"></div>

      <div class="navwrap">
        <div class="navlegend">
          <span class="dot" style="background:var(--red)"></span> qizil ‚Äî yechilmagan
          <span class="dot" style="background:var(--green)"></span> yashil ‚Äî yechilgan
          <span class="dot" style="background:linear-gradient(135deg,var(--green),var(--green-dark))"></span> current
        </div>
        <div id="navgrid" class="navgrid"></div>
      </div>

      <div class="actions">
        <div style="display:flex; gap:8px;">
          <button id="prevBtn" class="btn secondary">‚¨ÖÔ∏è Oldingi</button>
          <button id="nextBtn" class="btn secondary">Keyingi ‚û°Ô∏è</button>
        </div>
        <button id="submitBtn" class="btn warn">Testni yakunlash</button>
      </div>
      <div class="muted" style="margin-top:6px;">Raqamga bosib savolga o‚Äòting.</div>
    </section>

    <!-- Results -->
    <section id="resultCard" class="card hidden">
      <div class="score">
        <div class="big" id="scoreText">Natija: 0 / 0</div>
        <div class="kpi">
          <div id="kpiPercent" class="chip">Foiz: 0%</div>
          <div id="kpiCorrect" class="chip">To‚Äòg‚Äòri: 0 / 0</div>
          <div id="kpiTime" class="chip">Vaqt: ‚Äî</div>
          <div id="kpiSaved" class="chip">Saqlash: ‚Äî</div>
        </div>

        <div id="sectionChips" class="sections"></div>

        <div class="divider"></div>
        <div id="resultMsg" class="muted">Zo‚Äòr ish!</div>

        <div class="divider"></div>
        <h3 style="margin:0 0 6px">Savollar tahlili</h3>
        <div class="muted" style="margin-bottom:6px">Bo‚Äòlim, ball, tanlangan/to‚Äòg‚Äòri variant(lar) va holat.</div>
        <div style="overflow:auto">
          <table class="analysis" id="analysisTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Bo‚Äòlim</th>
                <th>Ball</th>
                <th>Tanlangan</th>
                <th>To‚Äòg‚Äòri</th>
                <th>Holat</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="divider"></div>
        <div class="actions">
          <div class="authbar"><span id="userName" class="muted"></span></div>
          <div style="display:flex; gap:8px; margin-left:auto;">
            <button class="btn secondary" onclick="location.reload()">Qayta boshlash</button>
            <button class="btn" id="reviewBtn">To‚Äòg‚Äòri javoblarni ko‚Äòrish</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Empty -->
    <section id="emptyCard" class="card hidden" style="text-align:center">
      <h3>Test topilmadi</h3>
      <p class="muted">Shu papkaga <code>test.json</code> qo‚Äòying yoki <code>localStorage['testData']</code>ga yozing.</p>
    </section>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, runTransaction, serverTimestamp, collection, addDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.firebasestorage.app",
      messagingSenderId: "992512966017",
      appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId: "G-459PLJ7P7L"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence);

    window.__firebase = { app, auth, db, onAuthStateChanged, serverTimestamp, addDoc, collection, increment, runTransaction, doc, setDoc, updateDoc };
  </script>

<script>
/* ========= SETTINGS ========= */
const TEST_ID = 'CHSB-2025-demo';
const SCALE   = 100; // 1.23 ‚Üí 123 (yuzdan birgacha aniqlik)

/* ========= HELPERS ========= */
const $ = (s, el=document)=>el.querySelector(s);
function isMulti(q){ return Array.isArray(q.correctIndices); }

/* ========= GLOBALS ========= */
let fb=null, currentUser=null, startedAt=null, testData=null, currentIndex=0;
let guardOverlay=null; // blok overlay
let userDocUnsub=null; // users/{uid} snapshot listerner

document.addEventListener('DOMContentLoaded', () => {
  const authInfoEl = $('#authInfo');
  let authResolved = false;

  setTimeout(()=>{ if(!authResolved) authInfoEl.textContent='Kirish: mehmon'; }, 3000);

  if (window.__firebase?.onAuthStateChanged){
    fb = window.__firebase;

    // üîÑ Auth holatini avtomatik kuzatamiz
    fb.onAuthStateChanged(fb.auth, (user)=>{
      authResolved = true;
      currentUser = user;
      authInfoEl.textContent = user
        ? `Kirish: ${user.displayName || user.email}`
        : 'Kirish: mehmon';

      // Har safar user o'zgarsa, users/{uid} ga qayta yozilishlarni kuzatamiz
      detachUserDocListener();
      if (user){
        watchUserDocAndGate(user.uid);
      } else {
        // user yo'q ‚Äî blok
        showGuardOverlay('Kirish talab qilinadi', 'Ushbu sahifadan foydalanish uchun hisobingizga kiring.');
      }
    });

    // Agar sessiya allaqachon bor bo‚Äòlsa
    if (fb.auth.currentUser){
      authResolved = true;
      currentUser = fb.auth.currentUser;
      authInfoEl.textContent = `Kirish: ${currentUser.displayName || currentUser.email}`;
      watchUserDocAndGate(currentUser.uid);
    }
  } else {
    // Firebase mavjud emas ‚Äî blok
    authInfoEl.textContent='Kirish: mehmon';
    showGuardOverlay('Xatolik', 'Firebase topilmadi. Ilovani to‚Äòg‚Äòri yuklang.');
  }
});

/* ========= users/{uid} ni kuzatish va ruxsat berish logikasi ========= */
function watchUserDocAndGate(uid){
  if (!fb?.db) {
    showGuardOverlay('Xatolik', 'Firestore ulanmaganga o‚Äòxshaydi.');
    return;
  }
  const ref = fb.doc(fb.db, 'users', uid);

  // üîÑ Avtomatik yangilanish: users/{uid} mavjud bo‚Äòlsa ‚Üí och, bo‚Äòlmasa ‚Üí blok
  userDocUnsub = fb.onSnapshot(ref, (snap)=>{
    if (snap.exists()){
      removeGuardOverlay();
      startAppAfterAuthorized(); // faqat shu yerda test yuklanadi
    } else {
      showGuardOverlay('Ruxsat yo‚Äòq', 'Hisobingiz ro‚Äòyxatda topilmadi (users/uid). Administrator bilan bog‚Äòlaning.');
    }
  }, (err)=>{
    console.warn('users/{uid} snapshot error:', err);
    showGuardOverlay('Xatolik', 'Foydalanuvchi ma‚Äôlumotini o‚Äòqishda xatolik.');
  });
}

function detachUserDocListener(){
  if (typeof userDocUnsub === 'function'){
    userDocUnsub();
    userDocUnsub = null;
  }
}

/* ========= BLOK OVERLAY (redirectsiz) ========= */
function showGuardOverlay(title, body){
  if (!guardOverlay){
    guardOverlay = document.createElement('div');
    guardOverlay.setAttribute('aria-live','polite');
    guardOverlay.style.cssText = `
      position:fixed; inset:0; background:rgba(0,0,0,.55); color:#fff;
      display:flex; align-items:center; justify-content:center; z-index:9999; padding:24px; text-align:center;
      backdrop-filter:saturate(1.2) blur(2px);
    `;
    document.body.appendChild(guardOverlay);
  }
  guardOverlay.innerHTML = `
    <div style="background:#0f1714; border:1px solid #2E8B57; padding:22px; border-radius:16px; max-width:560px;">
      <h2 style="margin:0 0 10px">${title}</h2>
      <p style="margin:0; opacity:.9">${body}</p>
    </div>`;
  disableTestInteractions(true);
}

function removeGuardOverlay(){
  if (guardOverlay){
    guardOverlay.remove();
    guardOverlay=null;
  }
  disableTestInteractions(false);
}

function disableTestInteractions(block){
  const root = $('#questionsCard') || document.body;
  if (!root) return;
  root.querySelectorAll('button, input, select, textarea, a').forEach(el=>{
    if (block){
      el.setAttribute('data-prev-tabindex', el.getAttribute('tabindex') ?? '');
      el.setAttribute('tabindex','-1');
      el.setAttribute('aria-disabled','true');
      if ('disabled' in el) el.disabled = true;
    } else {
      const prev = el.getAttribute('data-prev-tabindex');
      if (prev !== null){
        if (prev==='') el.removeAttribute('tabindex'); else el.setAttribute('tabindex', prev);
        el.removeAttribute('data-prev-tabindex');
      }
      el.removeAttribute('aria-disabled');
      if ('disabled' in el) el.disabled = false;
    }
  });
}

/* ========= START AFTER AUTHORIZED (user doc mavjud bo‚Äòlsa) ========= */
async function startAppAfterAuthorized(){
  if (!startedAt){ startedAt = new Date(); }
  if (!testData){
    await loadTestData(); // sizdagi mavjud funksiya testData ni to‚Äòldiradi
    // kerak bo‚Äòlsa dastlabki render
    // renderQuestion(0);
  }
}

/* ========= TO‚ÄòG‚ÄòRI JAVOBNI CHIZISH (sizda bor edi) ========= */
function revealCorrect(){
  $('#resultCard').classList.add('hidden');
  $('#questionsCard').classList.remove('hidden');
  const q = testData.questions[currentIndex];
  const multi = isMulti(q);
  const correct = multi ? (q.correctIndices||[]) : [Number(q.correctIndex ?? -1)];

  document.querySelectorAll('#questionView .opt').forEach(row=>{
    row.style.borderColor='#edf3ee'; row.style.boxShadow='none'; row.style.background='#fbfdfc';
  });
  document.querySelectorAll('#questionView input').forEach(inp=>{
    const orig = Number(inp.value);
    const row = inp.closest('.opt');
    if (correct.includes(orig)){
      row.style.borderColor='rgba(46,139,87,.55)';
      row.style.boxShadow='0 0 0 4px rgba(46,139,87,.18)';
      row.style.background='#f3fbf6';
    }
  });
}

/* ========= ANIQLIK: FIXED-POINT (2 xonali) ========= */
function toIntPoints(x){ return Math.round(Number(x) * SCALE); } // 1.23 ‚Üí 123

function isAnswerCorrect(q, userAnswer){
  if (isMulti(q)){
    const correct = (q.correctIndices||[]).slice().sort((a,b)=>a-b);
    const ans = (Array.isArray(userAnswer)? userAnswer: []).slice().sort((a,b)=>a-b);
    if (ans.length !== correct.length) return false;
    for (let i=0;i<correct.length;i++) if (ans[i]!==correct[i]) return false;
    return true;
  } else {
    return Number(userAnswer) === Number(q.correctIndex ?? -1);
  }
}

function computeScoreInt(questions, userAnswers){
  let totalInt = 0;
  for (let i=0;i<questions.length;i++){
    const q = questions[i];
    const ok = isAnswerCorrect(q, userAnswers[i]);
    const ptsInt = toIntPoints(q.points ?? 1);
    if (ok) totalInt += ptsInt;
  }
  return totalInt; // butun
}

function formatPoints(totalInt, fractionDigits=2){
  return (totalInt / SCALE).toFixed(fractionDigits);
}

/* ========= FIRESTORE: FAQAT BIRINCHI URINISHNI YOZISH ========= */
async function saveResultOnce({ testId, totalInt, durationSec, meta={} }){
  if (!fb || !fb.db || !currentUser) throw new Error('Auth yoki Firestore yo‚Äòq');
  const uid = currentUser.uid;
  const docId = `${testId}_${uid}`;
  const ref = fb.doc(fb.db, 'results', docId);

  await fb.runTransaction(fb.db, async (tx)=>{
    const snap = await fb.getDoc(ref);
    if (snap.exists()){ return; } // allaqachon bor ‚Äî yangilamaymiz
    tx.set(ref, {
      uid, testId,
      pointsInt: totalInt,
      scale: SCALE,
      points: totalInt / SCALE,
      durationSec,
      startedAt: startedAt ? fb.Timestamp.fromDate(startedAt) : null,
      createdAt: fb.serverTimestamp(),
      meta,
    });
  });
}

/* ========= SUBMIT HANDLER (avtorizatsiya guard bilan) ========= */
async function onSubmitResults(userAnswers){
  // üëá Faqat user ham, uning users/{uid} hujjati ham bo‚Äòlganda ishlaydi
  if (!currentUser || guardOverlay){
    showGuardOverlay('Ruxsat yo‚Äòq', 'Kirish yoki ro‚Äòyxatga kiritish talab qilinadi.');
    return;
  }

  const totalInt = computeScoreInt(testData.questions, userAnswers);
  $('#finalScore').textContent = formatPoints(totalInt, 2);

  const durationSec = Math.max(0, Math.round((Date.now() - (startedAt?.getTime()||Date.now()))/1000));
  try{
    await saveResultOnce({ testId: TEST_ID, totalInt, durationSec, meta:{} });
  } catch(e){ console.warn('saveResultOnce:', e); }

  $('#questionsCard').classList.add('hidden');
  $('#resultCard').classList.remove('hidden');
}

/* ========= MISOL: SUBMIT tugmasiga ulash ========= */
// $('#submitBtn')?.addEventListener('click', ()=>{
//   const userAnswers = collectAnswersFromUI(); // o'zingizning funksiyangiz
//   onSubmitResults(userAnswers);
// });
</script>

</body>
</html>
