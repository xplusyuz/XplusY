<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MathCenter ‚Äî Rasm-Only Test (Firebase + Bo‚Äòlimlar + Tahlil + Random opts)</title>

  <!-- MathJax v3 -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$','$'],['\\(','\\)']], displayMath: [['$$','$$'],['\\[','\\]']], processEscapes:true, packages:{'[+]':['noerrors']} },
      options: { renderActions: { addMenu: [] } }, loader: { load: ['[tex]/noerrors'] }
    };
  </script>
  <script id="MathJax-script" async
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root{
      --green:#2E8B57; --green-dark:#1F6B45;
      --red:#c62828; --red-bg:#fff2f2; --red-ring:rgba(198,40,40,.18);
      --ok-bg:#f3fbf6; --ok-bd:#cfe4d7; --bg:#f7faf8; --card:#fff; --text:#0f172a; --muted:#475569; --outline:#e6efe8; --ring:rgba(46,139,87,.25);
      --chip:#ffffffc9;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:linear-gradient(180deg,#f1f8f4 0%,#f7faf8 100%)}
    .wrap{max-width:980px;margin:26px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--outline);border-radius:18px;padding:18px;box-shadow:0 8px 24px rgba(31,107,69,.06)}
    .header{background:radial-gradient(1200px 600px at -10% -10%, #e8f5ee, transparent 60%), radial-gradient(1200px 600px at 110% -10%, #e3f3ec, transparent 60%); display:grid;gap:10px}
    .title{display:flex;align-items:center;gap:12px;font-weight:700;font-size:22px}
    .pi{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(135deg,var(--green),var(--green-dark));color:#fff;font-weight:800;box-shadow:0 6px 18px rgba(46,139,87,.35)}
    .sub{color:var(--muted);font-size:14px}
    .meta{display:flex;flex-wrap:wrap;gap:10px;color:#0b3a25;font-size:13px}
    .chip{border:1px solid #d8e9df;background:var(--chip);padding:8px 10px;border-radius:999px;font-variant-numeric:tabular-nums}
    .timer.warn{color:#a15b00;border-color:#f5d7b4;background:#fff9f0}
    .timer.crit{color:#a11212;border-color:#f2c6c6;background:#fff4f4}

    .qwrap{display:grid;gap:12px}
    .qhead{display:flex;justify-content:space-between;align-items:baseline;gap:12px}
    .qname{font-weight:700}
    .qpts{color:var(--muted);font-size:13px}

    .qimg{ margin:8px 0 4px; }
    .qimg img{ max-width:100%;height:auto;display:block;border-radius:12px;border:1px solid #edf3ee;box-shadow:0 6px 18px rgba(31,107,69,.06) }

    .opts{display:grid;gap:10px}
    .opt{display:grid;grid-template-columns:24px 1fr;gap:10px;align-items:start;padding:10px 12px;border:1px solid #edf3ee;border-radius:12px;background:#fbfdfc;transition:border-color .15s,box-shadow .15s,background .15s}
    .opt:hover{border-color:var(--green);box-shadow:0 0 0 4px var(--ring);background:#fff}
    .opt input{transform:translateY(2px)}
    .opt label .mj{display:inline-block}

    .actions{display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;margin-top:16px}
    .btn{appearance:none;border:none;cursor:pointer;padding:12px 16px;border-radius:12px;font-weight:700;background:linear-gradient(135deg,var(--green),var(--green-dark));color:#fff;box-shadow:0 10px 24px rgba(46,139,87,.35)}
    .btn.secondary{background:#fff;color:#1F6B45;border:1px solid #cfe4d7;box-shadow:none}
    .btn.warn{background:linear-gradient(135deg,#e65100,#bf360c)}
    .btn.ghost{background:#fff;color:#0b3a25;border:1px dashed #cfe4d7}

    .hidden{display:none !important}
    .muted{color:var(--muted);font-size:14px}
    .divider{height:1px;background:#edf3ee;margin:8px 0}

    /* Navigator */
    .navwrap{margin-top:16px}
    .navlegend{display:flex;gap:12px;align-items:center;color:#64748b;font-size:13px;margin-bottom:8px}
    .dot{width:10px;height:10px;border-radius:50%}
    .navgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(40px,1fr));gap:10px}
    .navbtn{appearance:none;border:1px solid var(--outline);background:#fff;color:#0b3a25;border-radius:12px;padding:10px 0;cursor:pointer;font-weight:800;transition:.15s}
    .navbtn.current{background:linear-gradient(135deg,var(--green),var(--green-dark));color:#fff;border-color:transparent}
    .navbtn.answered:not(.current){background:var(--ok-bg);border-color:var(--ok-bd)}
    .navbtn.unanswered:not(.current){background:var(--red-bg);border-color:#f1c9c9;color:#var(--red);box-shadow:0 0 0 3px var(--red-ring)}

    /* Result */
    .score{display:grid;gap:10px;padding:16px;border:1px dashed #cfe4d7;border-radius:14px;background:#f8fbf9}
    .big{font-weight:800;font-size:22px;color:#1F6B45}
    .kpi{display:flex;flex-wrap:wrap;gap:10px}
    .authbar{display:flex;gap:10px;align-items:center}

    /* Sections chips */
    .sections{display:flex;flex-wrap:wrap;gap:8px}
    .s-chip{border:1px solid #dfeae3;background:#fff;border-radius:999px;padding:6px 10px;font-size:12px}

    /* Analysis table */
    table.analysis{width:100%;border-collapse:collapse;font-size:14px}
    .analysis th,.analysis td{border:1px solid #edf3ee;padding:8px;vertical-align:top}
    .analysis th{background:#f6faf8;text-align:left}
    .analysis .ok{color:#1F6B45;font-weight:700}
    .analysis .bad{color:#b71c1c;font-weight:700}
    .pill{display:inline-block;border-radius:999px;border:1px solid #dfeae3;background:#fff;padding:2px 8px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <section class="header card">
      <div class="title">
        <div class="pi">œÄ</div>
        <div id="testTitle">Rasm-Only Test</div>
      </div>
      <div id="testDesc" class="sub">Savol matnisiz: rasm + variantlar.</div>
      <div class="meta">
        <div id="metaCount" class="chip">Savollar: ‚Äî</div>
        <div id="metaPoints" class="chip">Umumiy ball: ‚Äî</div>
        <div id="metaType" class="chip">‚Äî</div>
        <div id="metaTimer" class="chip timer hidden">00:00</div>
        <div id="authInfo" class="chip">Kirish: tekshirilmoqda‚Ä¶</div>
      </div>
    </section>

    <!-- One-by-one Question View -->
    <section id="questionsCard" class="card">
      <div id="questionView" class="qwrap"></div>

      <div class="navwrap">
        <div class="navlegend">
          <span class="dot" style="background:var(--red)"></span> qizil ‚Äî yechilmagan
          <span class="dot" style="background:var(--green)"></span> yashil ‚Äî yechilgan
          <span class="dot" style="background:linear-gradient(135deg,var(--green),var(--green-dark))"></span> current
        </div>
        <div id="navgrid" class="navgrid"></div>
      </div>

      <div class="actions">
        <div style="display:flex; gap:8px;">
          <button id="prevBtn" class="btn secondary">‚¨ÖÔ∏è Oldingi</button>
          <button id="nextBtn" class="btn secondary">Keyingi ‚û°Ô∏è</button>
        </div>
        <button id="submitBtn" class="btn warn">Testni yakunlash</button>
      </div>
      <div class="muted" style="margin-top:6px;">Raqamga bosib savolga o‚Äòting.</div>
    </section>

    <!-- Results -->
    <section id="resultCard" class="card hidden">
      <div class="score">
        <div class="big" id="scoreText">Natija: 0 / 0</div>
        <div class="kpi">
          <div id="kpiPercent" class="chip">Foiz: 0%</div>
          <div id="kpiCorrect" class="chip">To‚Äòg‚Äòri: 0 / 0</div>
          <div id="kpiTime" class="chip">Vaqt: ‚Äî</div>
          <div id="kpiSaved" class="chip">Saqlash: ‚Äî</div>
        </div>

        <div id="sectionChips" class="sections"></div>

        <div class="divider"></div>
        <div id="resultMsg" class="muted">Zo‚Äòr ish!</div>

        <div class="divider"></div>
        <h3 style="margin:0 0 6px">Savollar tahlili</h3>
        <div class="muted" style="margin-bottom:6px">Bo‚Äòlim, ball, tanlangan/to‚Äòg‚Äòri variant(lar) va holat.</div>
        <div style="overflow:auto">
          <table class="analysis" id="analysisTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Bo‚Äòlim</th>
                <th>Ball</th>
                <th>Tanlangan</th>
                <th>To‚Äòg‚Äòri</th>
                <th>Holat</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="divider"></div>
        <div class="actions">
          <div class="authbar"><span id="userName" class="muted"></span></div>
          <div style="display:flex; gap:8px; margin-left:auto;">
            <button class="btn secondary" onclick="location.reload()">Qayta boshlash</button>
            <button class="btn" id="reviewBtn">To‚Äòg‚Äòri javoblarni ko‚Äòrish</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Empty -->
    <section id="emptyCard" class="card hidden" style="text-align:center">
      <h3>Test topilmadi</h3>
      <p class="muted">Shu papkaga <code>test.json</code> qo‚Äòying yoki <code>localStorage['testData']</code>ga yozing.</p>
    </section>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, updateDoc, runTransaction, serverTimestamp, collection, addDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.firebasestorage.app",
      messagingSenderId: "992512966017",
      appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId: "G-459PLJ7P7L"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    await setPersistence(auth, browserLocalPersistence);

    window.__firebase = { app, auth, db, onAuthStateChanged, serverTimestamp, addDoc, collection, increment, runTransaction, doc, setDoc, updateDoc };
  </script>

  <script>
    /* ===================== UTIL ===================== */
    const $ = s => document.querySelector(s);
    const sum = a => a.reduce((x,y)=>x+y,0);
    const pad2 = n => String(Math.max(0,n)).padStart(2,'0');
    const isMulti = q => Array.isArray(q.correctIndices);
    const arraysEqualUnordered = (a,b)=>a.length===b.length && [...a].sort((x,y)=>x-y).every((v,i)=>v===[...b].sort((x,y)=>x-y)[i]);
    async function typeset(el){ if(window.MathJax?.typesetPromise){ try{ await MathJax.typesetPromise([el]); }catch(_){} } }

    function escapeHtml(t){ return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function looksLikeTeX(s){ return /[\\^_{}]|\\(frac|sqrt|sum|int|log|ln|sin|cos|tan|vec|pi|le|ge|ne|pm|times|cdot|left|right)/.test(s); }
    function renderLineForMath(s){
      const hasDollar = /\$.*\$/.test(s);
      const safe = escapeHtml(s);
      if(hasDollar) return safe;
      if(looksLikeTeX(s)) return '\\(' + safe + '\\)';
      return safe;
    }

    // Fisher‚ÄìYates shuffle
    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    /* ===================== STATE ===================== */
    let testData = null, currentIndex = 0, answers = [], timerId = null, timeLeftSec = 0, submitted = false, startedAt = new Date();
    let fb = null, currentUser = null;

    // NEW: per-question option order (array of arrays of ORIGINAL indices)
    let optionOrders = [];

    /* ===================== RASMLAR ===================== */
    function resolveQuestionImageSrc(i) {
      return new Promise((resolve) => {
        const tryJpg = `./${i}.jpg`;
        const tryPng = `./${i}.png`;
        const img = new Image();
        img.onload = () => resolve(tryJpg);
        img.onerror = () => {
          const img2 = new Image();
          img2.onload = () => resolve(tryPng);
          img2.onerror = () => resolve(null);
          img2.src = tryPng + `?t=${Date.now()}`;
        };
        img.src = tryJpg + `?t=${Date.now()}`;
      });
    }

    /* ===================== ADAPTER ===================== */
    function normalizeTestData(data){
      if(!data || !Array.isArray(data.questions)) return data;
      if (data.totalTime && !data.durationMinutes) data.durationMinutes = Number(data.totalTime);
      data.title = data.title || 'Rasm-Only Test';
      data.description = data.description || 'Rasm + variant';
      data.type = data.type || 'aralash';
      data.questions = data.questions.map(q=>{
        const qq = {...q};
        qq.points = Number(qq.points || 1);
        return qq;
      });
      return data;
    }

    /* ===================== LOAD TEST ===================== */
    async function loadTestData(){
      const stored = localStorage.getItem('testData');
      if(stored){
        try{ testData = normalizeTestData(JSON.parse(stored)); initTest(); return; }
        catch(e){ console.error('localStorage parse xato:', e); }
      }
      try{
        const r = await fetch('test.json', { cache: 'no-store' });
        if(!r.ok) throw new Error('test.json o‚Äòqilmadi');
        testData = normalizeTestData(await r.json());
        initTest();
      }catch(e){
        console.warn(e);
        showNoTest();
      }
    }

    function showNoTest(){
      $('#questionsCard').classList.add('hidden');
      $('#resultCard').classList.add('hidden');
      $('#emptyCard').classList.remove('hidden');
    }

    /* ===================== SECTIONS ===================== */
    function buildSections(){
      const n = testData.questions.length;
      if(Array.isArray(testData.sections) && testData.sections.length){
        return testData.sections.map(s=>({
          name: s.name || 'Bo‚Äòlim',
          start: Math.max(1, Number(s.start||1)),
          end: Math.min(n, Number(s.end||n))
        }));
      }
      if(n<=12) return [{name:'Algebra', start:1, end:n}];
      return [
        {name:'Algebra',   start:1,  end:Math.min(12,n)},
        {name:'Geometriya',start:13, end:n}
      ];
    }
    function sectionOf(index1, sections){
      for(const s of sections){
        if(index1>=s.start && index1<=s.end) return s.name;
      }
      return '‚Äî';
    }

    /* ===================== INIT ===================== */
    function initTest(){
      if(!testData || !Array.isArray(testData.questions) || testData.questions.length===0){ showNoTest(); return; }
      const qn = testData.questions.length;
      answers = Array.from({length: qn}, ()=>[]);
      optionOrders = Array.from({length: qn}, ()=>[]); // init

      $('#testTitle').textContent = testData.title || 'Rasm-Only Test';
      $('#testDesc').textContent = testData.description || 'Rasm + variant';
      $('#metaCount').textContent = `Savollar: ${qn}`;
      const totalPts = testData.questions.map(q=>Number(q.points||1)).reduce((a,b)=>a+b,0);
      $('#metaPoints').textContent = `Umumiy ball: ${totalPts}`;
      $('#metaType').textContent = (testData.type || 'aralash').toUpperCase();

      const minutes = Number(testData.durationMinutes || 0);
      if(minutes>0){
        timeLeftSec = Math.round(minutes*60);
        $('#metaTimer').classList.remove('hidden');
        updateTimerBadge();
        timerId = setInterval(tick, 1000);
      } else { $('#metaTimer').classList.add('hidden'); }

      // section chips
      const sections = buildSections();
      const chips = sections.map(s=>`<span class="s-chip">${s.name}: ${s.start}‚Äì${s.end}</span>`).join(' ');
      const desc = document.createElement('div'); desc.className='muted'; desc.innerHTML = chips;
      $('.header').appendChild(desc);

      buildNavigator();
      $('#prevBtn').onclick = ()=>gotoQuestion(currentIndex-1);
      $('#nextBtn').onclick = ()=>gotoQuestion(currentIndex+1);
      $('#submitBtn').onclick = onSubmit;
      $('#reviewBtn').onclick = revealCorrect;

      gotoQuestion(0);
    }

    /* ===================== NAVIGATOR ===================== */
    function buildNavigator(){
      const grid = $('#navgrid'); grid.innerHTML = '';
      testData.questions.forEach((_,i)=>{
        const b = document.createElement('button');
        b.className = 'navbtn'; b.textContent = i+1; b.id = `navbtn-${i}`;
        b.addEventListener('click', ()=>gotoQuestion(i));
        grid.appendChild(b);
      });
      refreshNavigator();
    }
    function refreshNavigator(){
      testData.questions.forEach((_,i)=>{
        const b = document.getElementById(`navbtn-${i}`); if(!b) return;
        const ans = (answers[i] && answers[i].length>0);
        b.classList.toggle('current', i===currentIndex);
        b.classList.toggle('answered', ans);
        b.classList.toggle('unanswered', !ans);
      });
    }

    async function gotoQuestion(i){
      const n = testData.questions.length;
      if(i<0) i=0; if(i>=n) i=n-1;
      currentIndex = i;
      await renderCurrentQuestion();
      refreshNavigator();
      $('#prevBtn').disabled = (currentIndex===0);
      $('#nextBtn').disabled = (currentIndex===testData.questions.length-1);
    }

    /* ===================== RENDER (with RANDOM options) ===================== */
    async function renderCurrentQuestion(){
      const q = testData.questions[currentIndex];
      const wrap = $('#questionView'); wrap.innerHTML = '';

      const head = document.createElement('div'); head.className='qhead';
      head.appendChild(Object.assign(document.createElement('div'), {className:'qname', textContent:`#${currentIndex+1}`}));
      head.appendChild(Object.assign(document.createElement('div'), {className:'qpts',  textContent:`${q.points||1} ball`}));

      const qimgWrap = document.createElement('div'); qimgWrap.className = 'qimg';
      const qimg = document.createElement('img'); qimg.alt = `Savol ${currentIndex+1} rasmi`; qimg.loading='lazy'; qimg.decoding='async';
      qimgWrap.appendChild(qimg);

      const opts = document.createElement('div'); opts.className='opts';
      const multi = isMulti(q); const nameAttr = `q_${currentIndex}`;
      const chosenOriginal = new Set(answers[currentIndex] || []); // store as ORIGINAL indices

      // Build order once per question (stable across navigation)
      if(optionOrders[currentIndex].length === 0){
        const origIdx = (q.options||[]).map((_,j)=>j);
        optionOrders[currentIndex] = shuffle(origIdx);
      }
      const order = optionOrders[currentIndex]; // display order of ORIGINAL indices

      order.forEach((origJ, dispJ)=>{
        const text = (q.options && q.options[origJ]) ? q.options[origJ] : '';
        const row = document.createElement('div'); row.className='opt';
        const inp = document.createElement('input');
        inp.type = multi ? 'checkbox' : 'radio'; inp.name=nameAttr;
        inp.value = String(origJ);         // store ORIGINAL index in value!
        inp.id=`${nameAttr}_${dispJ}`;
        inp.checked = multi ? chosenOriginal.has(origJ) : (chosenOriginal.has(origJ));
        inp.addEventListener('change', ()=>{
          if(multi){
            if(inp.checked) chosenOriginal.add(origJ); else chosenOriginal.delete(origJ);
            answers[currentIndex] = Array.from(chosenOriginal).sort((a,b)=>a-b);
          } else {
            answers[currentIndex] = inp.checked ? [origJ] : [];
          }
          refreshNavigator();
        });
        const lbl = document.createElement('label'); lbl.setAttribute('for', inp.id);
        lbl.innerHTML = `<span class="mj">${renderLineForMath(String(text))}</span>`;
        row.appendChild(inp); row.appendChild(lbl); opts.appendChild(row);
      });

      wrap.appendChild(head);
      wrap.appendChild(qimgWrap);
      wrap.appendChild(opts);

      const idx1 = currentIndex + 1;
      const src = await resolveQuestionImageSrc(idx1);
      qimg.src = src || '';

      await typeset(wrap);
    }

    /* ===================== TIMER ===================== */
    function tick(){ if(submitted){ clearInterval(timerId); return; } timeLeftSec--; updateTimerBadge(); if(timeLeftSec<=0){ clearInterval(timerId); onSubmit(); } }
    function updateTimerBadge(){
      const b = $('#metaTimer'); const m = Math.max(0,Math.floor(timeLeftSec/60)); const s = Math.max(0,timeLeftSec%60);
      b.textContent = `${pad2(m)}:${pad2(s)}`;
      b.classList.toggle('warn', timeLeftSec<=180 && timeLeftSec>60);
      b.classList.toggle('crit', timeLeftSec<=60);
    }

    /* ===================== FIREBASE HELPERS ===================== */
    async function ensureUserDoc() {
      if(!fb) fb = window.__firebase;
      const { db, runTransaction, doc, setDoc } = fb;
      const user = fb.auth.currentUser;
      if (!user) return;
      const uref = doc(db, 'users', user.uid);
      try {
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(uref);
          if (!snap.exists()) {
            tx.set(uref, { name: user.displayName || 'Foydalanuvchi', email: user.email || null, points: 0, createdAt: Date.now() });
          }
        });
      } catch (e) {
        await setDoc(uref, { name: user.displayName || 'Foydalanuvchi', points: 0, createdAt: Date.now() }, { merge: true });
      }
    }

    async function saveResultToFirebase(payload){
      const { db, serverTimestamp, addDoc, collection, increment, runTransaction, doc, setDoc } = fb;
      const { uid, score, total, percent, startedAt, finishedAt, testId, sectionsSummary } = payload;

      await addDoc(collection(db,'results'), {
        uid, testId, score, total, percent,
        sections: sectionsSummary,
        startedAt: startedAt?.toISOString() || null,
        finishedAt: finishedAt?.toISOString() || null,
        createdAt: serverTimestamp()
      });

      const uref = doc(db,'users',uid);
      try{
        await runTransaction(db, async (tx)=>{
          const snap = await tx.get(uref);
          if(!snap.exists()){ tx.set(uref, { points: score, updatedAt: serverTimestamp() }, { merge:true }); }
          else { tx.update(uref, { points: increment(score), updatedAt: serverTimestamp() }); }
        });
      }catch(e){
        await setDoc(uref, { points: score, updatedAt: serverTimestamp() }, { merge:true });
      }
    }

    /* ===================== SUBMIT / ANALYSIS ===================== */
    async function onSubmit(){
      if(submitted) return; submitted = true;

      const sections = buildSections();
      const sectionTotals = {}; const sectionGained = {};
      sections.forEach(s=>{ sectionTotals[s.name]=0; sectionGained[s.name]=0; });

      let gained=0, correctCount=0;
      const perQuestion = [];

      testData.questions.forEach((q,i)=>{
        const pts=Number(q.points||1);
        const idx1=i+1;
        const secName = sectionOf(idx1, sections);
        sectionTotals[secName]+=pts;

        const chosen=answers[i]||[]; // already ORIGINAL indices
        const correct = isMulti(q) ? (q.correctIndices||[]) : [Number(q.correctIndex??-1)];
        const ok = isMulti(q) ? arraysEqualUnordered(chosen, correct) : (chosen.length===1 && chosen[0]===correct[0]);
        if(ok){ gained+=pts; correctCount++; sectionGained[secName]+=pts; }

        perQuestion.push({ i: idx1, section: secName, points: pts, chosen, correct, ok });
      });

      const totalPts = sum(testData.questions.map(q=>Number(q.points||1)));
      const percent = totalPts ? Math.round((gained/totalPts)*100) : 0;
      const finishedAt = new Date(); const spentSec = Math.max(0,Math.round((finishedAt-startedAt)/1000));
      const tMM = Math.floor(spentSec/60), tSS = spentSec%60;

      $('#questionsCard').classList.add('hidden');
      $('#resultCard').classList.remove('hidden');
      $('#scoreText').textContent = `Natija: ${gained} / ${totalPts}`;
      $('#kpiPercent').textContent = `Foiz: ${percent}%`;
      $('#kpiCorrect').textContent = `To‚Äòg‚Äòri: ${correctCount} ta / ${testData.questions.length} ta`;
      $('#kpiTime').textContent = `Vaqt: ${pad2(tMM)}:${pad2(tSS)}`;
      $('#resultMsg').textContent = percent>=86 ? 'Ajoyib! üî•' : percent>=70 ? 'Barakalla! üí™' : percent>=50 ? 'Yaxshi urinish. üôÇ' : 'Mashqni ko‚Äòpaytiring. üìö';

      const sc = $('#sectionChips'); sc.innerHTML='';
      const sectionsSummary = sections.map(s=>{
        const tot = sectionTotals[s.name]||0;
        const win = sectionGained[s.name]||0;
        const prc = tot? Math.round((win/tot)*100) : 0;
        const div = document.createElement('span');
        div.className='s-chip';
        div.textContent = `${s.name}: ${win} / ${tot} (${prc}%)`;
        sc.appendChild(div);
        return { name:s.name, gained: win, total: tot, percent: prc };
      });

      const tbody = $('#analysisTable tbody'); tbody.innerHTML='';
      perQuestion.forEach(row=>{
        const tr = document.createElement('tr');
        const td = (h)=>{ const x=document.createElement('td'); x.innerHTML=h; return x; };
        const chosenText = row.chosen.length ? row.chosen.map(n=>n+1).join(', ') : '<span class="muted">‚Äî</span>';
        const correctText = row.correct.length ? row.correct.map(n=>n+1).join(', ') : '<span class="muted">‚Äî</span>';
        tr.appendChild(td(String(row.i)));
        tr.appendChild(td(`<span class="pill">${row.section}</span>`));
        tr.appendChild(td(String(row.points)));
        tr.appendChild(td(chosenText));
        tr.appendChild(td(correctText));
        tr.appendChild(td(row.ok? '<span class="ok">to‚Äòg‚Äòri</span>' : '<span class="bad">noto‚Äòg‚Äòri</span>'));
        tbody.appendChild(tr);
      });

      const infoEl = $('#kpiSaved'); const nameEl = $('#userName');
      if(!fb) fb = window.__firebase;
      if(fb?.auth?.currentUser){
        try{
          await ensureUserDoc();
          await saveResultToFirebase({
            uid: fb.auth.currentUser.uid,
            testId: testData.id || (testData.title||'unknown').toLowerCase().replace(/\s+/g,'-'),
            score: gained, total: totalPts, percent, startedAt, finishedAt,
            sectionsSummary
          });
          infoEl.textContent = 'Saqlash: ‚úÖ Ball saqlandi!';
          nameEl.textContent = `üë§ ${fb.auth.currentUser.displayName || fb.auth.currentUser.email}`;
        }catch(e){
          console.error('save failed:', e);
          infoEl.textContent = 'Saqlash: ‚ùå Xatolik';
          nameEl.textContent = `üë§ ${fb.auth.currentUser.displayName || fb.auth.currentUser.email}`;
        }
      } else {
        infoEl.textContent = 'Saqlash: ‚ùå Faqat kirgan foydalanuvchilar uchun';
        nameEl.textContent = 'üë§ Mehmon';
      }
    }

    function revealCorrect(){
      $('#resultCard').classList.add('hidden');
      $('#questionsCard').classList.remove('hidden');
      const q=testData.questions[currentIndex]; const multi=isMulti(q);
      const correct = multi?(q.correctIndices||[]):[Number(q.correctIndex??-1)];
      document.querySelectorAll('#questionView .opt').forEach(row=>{
        row.style.borderColor='#edf3ee'; row.style.boxShadow='none'; row.style.background='#fbfdfc';
      });
      document.querySelectorAll('#questionView input').forEach(inp=>{
        const orig = Number(inp.value); // ORIGINAL index stored in value
        const row=inp.closest('.opt');
        if(correct.includes(orig)){
          row.style.borderColor='rgba(46,139,87,.55)';
          row.style.boxShadow='0 0 0 4px rgba(46,139,87,.18)';
          row.style.background='#f3fbf6';
        }
      });
    }

    /* ===================== AUTH BANNER ===================== */
    document.addEventListener('DOMContentLoaded', ()=>{
      const authInfoEl = $('#authInfo');
      let authResolved = false;

      setTimeout(()=>{ if(!authResolved) authInfoEl.textContent='Kirish: mehmon'; }, 3000);

      if(window.__firebase?.onAuthStateChanged){
        fb = window.__firebase;
        fb.onAuthStateChanged(fb.auth, (user)=>{
          authResolved = true;
          currentUser = user;
          authInfoEl.textContent = user ? `Kirish: ${user.displayName||user.email}` : 'Kirish: mehmon';
        });
        if (fb.auth.currentUser) {
          authResolved = true;
          const u = fb.auth.currentUser;
          authInfoEl.textContent = `Kirish: ${u.displayName || u.email}`;
        }
      } else {
        authInfoEl.textContent='Kirish: mehmon';
      }

      startedAt = new Date();
      loadTestData();
    });
  </script>
</body>
</html>
