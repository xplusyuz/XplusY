<!doctype html>
<html lang="uz">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LeaderMath — Test</title>
<link rel="icon" href="./favicon.ico">
<style>
  :root{--brand:#2E8B57;--b2:#1F6B45;--bg:#f6faf8;--ink:#0f172a;--muted:#6b7c75;--frame:#e3efe8;--card:#fff;--r:16px}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:5;background:linear-gradient(135deg,var(--brand),var(--b2));color:#fff;padding:10px 14px;font-weight:800;display:flex;gap:12px;align-items:center}
  .wrap{max-width:980px;margin:18px auto;padding:0 12px}
  .card{background:var(--card);border:1px dashed var(--frame);border-radius:var(--r);box-shadow:0 10px 24px #0000000d;padding:14px}
  .title{font-weight:900;font-size:20px;margin:0}
  .muted{color:var(--muted);font-size:13px}
  .q{background:var(--card);border:1px dashed var(--frame);border-radius:12px;padding:12px;margin:12px 0}
  .opts{display:grid;gap:8px}
  .opt{display:flex;gap:10px;align-items:flex-start;border:1px solid var(--frame);border-radius:12px;padding:10px;cursor:pointer;background:#f8fcfa}
  .opt input{margin-top:3px}
  .opt.correct{border-color:#2ecc71;background:#edfbf1}
  .opt.wrong{border-color:#e74c3c;background:#ffecec}
  .bar{height:8px;border-radius:999px;background:#e7f2ec;overflow:hidden}
  .bar>i{display:block;height:100%;background:linear-gradient(135deg,var(--brand),var(--b2));width:0%}
  .btn{background:linear-gradient(135deg,var(--brand),var(--b2));color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
  .ghost{background:#eef6f1;color:#154232;border:1px solid #cfe9dc}
  .footer{position:sticky;bottom:0;background:rgba(246,250,248,.9);backdrop-filter:blur(6px);border-top:1px dashed var(--frame);padding:10px 12px}
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
</style>
<script>window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]}};</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
</head>
<body>
<header>
  <div style="font-size:18px">LeaderMath — Test</div>
  <div class="muted" id="headInfo"></div>
  <div style="margin-left:auto" class="muted">⏱️ <span id="time">—:—</span></div>
</header>

<div class="wrap">
  <div class="card">
    <h1 class="title" id="tTitle">Test</h1>
    <div class="muted" id="tMeta"></div>
  </div>

  <div id="qRoot"></div>

  <div class="footer">
    <div class="row">
      <div style="min-width:180px">
        <div class="muted">Jarayon</div>
        <div class="bar"><i id="bar"></i></div>
      </div>
      <div>
        <button class="ghost btn" id="prev">Oldingi</button>
        <button class="ghost btn" id="next">Keyingi</button>
        <button class="btn" id="finish">Testni yakunlash</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  // ===== Firebase =====
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
  import { getFirestore, doc, setDoc, getDoc, runTransaction } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

  const cfg = {
    apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
    authDomain: "xplusy-760fa.firebaseapp.com",
    projectId: "xplusy-760fa",
    storageBucket: "xplusy-760fa.firebasestorage.app",
    messagingSenderId: "992512966017",
    appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
    measurementId: "G-459PLJ7P7L"
  };
  const app = initializeApp(cfg);
  const auth = getAuth(app);
  const db = getFirestore(app);

  async function requireUser(){
    return new Promise((resolve)=>{
      onAuthStateChanged(auth, async(u)=>{
        if(u) return resolve(u);
        try{ const res=await signInWithPopup(auth,new GoogleAuthProvider()); resolve(res.user); }
        catch(e){ alert('Kirish kerak!'); location.reload(); }
      });
    });
  }

  // ===== Test loader (Firestore yoki JSON) =====
  import { getDoc as fsGetDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
  const qs = new URLSearchParams(location.search);
  const ID  = qs.get('id');
  const SRC = qs.get('src') || './test.json';

  async function loadTest(){
    if(ID){
      const snap = await fsGetDoc(doc(db,'tests',ID));
      if(!snap.exists()) throw new Error('Test topilmadi: '+ID);
      return snap.data();
    }else{
      const r = await fetch(SRC,{cache:'no-store'});
      if(!r.ok) throw new Error('JSON o‘qib bo‘lmadi: '+r.status);
      return await r.json();
    }
  }

  const headInfo = document.getElementById('headInfo');
  const tTitle = document.getElementById('tTitle');
  const tMeta  = document.getElementById('tMeta');
  const qRoot  = document.getElementById('qRoot');
  const bar    = document.getElementById('bar');
  const showTime= document.getElementById('time');

  let TEST=null, cur=0, answers=[], startedAt=Date.now(), deadline=0, timerId=null;

  function fmtMin(m){ return m.toString().padStart(2,'0'); }
  function tick(){
    const left = Math.max(0, Math.floor((deadline - Date.now())/1000));
    const m = Math.floor(left/60), s = left%60;
    showTime.textContent = `${fmtMin(m)}:${fmtMin(s)}`;
    if(left<=0){ clearInterval(timerId); finishTest(); }
  }

  function renderQ(i){
    const q = TEST.questions[i];
    qRoot.innerHTML = `
      <div class="card q">
        <div><b>${i+1}. (${q.type}, ${q.points} ball)</b></div>
        <div style="margin-top:6px">${q.text}</div>
        <div class="opts" style="margin-top:8px">
          ${q.options.map((o,ix)=>`
            <label class="opt">
              <input ${q.type==='single'?'type="radio" name="opt"':'type="checkbox"'} ${answers[i]?.includes(ix)?'checked':''} data-ix="${ix}">
              <div>${o.text}</div>
            </label>
          `).join('')}
        </div>
      </div>`;
    MathJax.typesetPromise();
    qRoot.querySelectorAll('input').forEach(inp=>{
      inp.onchange=()=>{
        const ix = Number(inp.dataset.ix);
        if(q.type==='single'){ answers[i]=[ix]; qRoot.querySelectorAll('input').forEach(x=>{ if(x!==inp) x.checked=false; }); }
        else{
          const set = new Set(answers[i]||[]);
          if(inp.checked) set.add(ix); else set.delete(ix);
          answers[i]=[...set];
        }
        saveProgress();
      };
    });
    bar.style.width = `${Math.round((i)/TEST.questions.length*100)}%`;
    document.getElementById('prev').disabled=(i===0);
    document.getElementById('next').disabled=(i>=TEST.questions.length-1);
  }

  function saveProgress(){
    const key = 'lm-test-' + (TEST?.id||'tmp');
    localStorage.setItem(key, JSON.stringify({cur,answers,startedAt,deadline}));
  }
  function restoreProgress(){
    try{
      const key='lm-test-'+TEST.id; const raw=localStorage.getItem(key);
      if(!raw) return;
      const obj=JSON.parse(raw);
      cur=obj.cur||0; answers=obj.answers||[]; startedAt=obj.startedAt||Date.now(); deadline=obj.deadline||deadline;
    }catch(e){}
  }

  function scoreTest(){
    let gained=0, max=0, details=[];
    TEST.questions.forEach((q,qi)=>{
      max += q.points;
      const gold = new Set(q.options.map((o,i)=> o.correct?i:null).filter(i=>i!==null));
      const pick = new Set((answers[qi]||[]));
      const good = gold.size===pick.size && [...gold].every(i=>pick.has(i));
      gained += good ? q.points : 0;
      details.push({qi, good, picked:[...pick], gold:[...gold], points: good?q.points:0});
    });
    return {score:gained, max, details};
  }

  async function finishTest(){
    clearInterval(timerId);
    document.getElementById('prev').disabled=true;
    document.getElementById('next').disabled=true;
    document.getElementById('finish').disabled=true;

    const res = scoreTest(); bar.style.width='100%';
    const user = await requireUser();

    try{
      await setDoc(doc(db,'tests',TEST.id,'results',user.uid),{
        uid:user.uid, email:user.email||null, displayName:user.displayName||null,
        score:res.score, max:res.max, percent:Math.round(res.score/res.max*100),
        startedAt, finishedAt:Date.now(), answers, details:res.details
      }, {merge:true});

      await runTransaction(db, async(tx)=>{
        const uref = doc(db,'users',user.uid);
        const us = await tx.get(uref);
        const prev = (us.exists()? (Number(us.data().points)||0) : 0);
        tx.set(uref, { points: prev + res.score }, {merge:true});
      });
    }catch(e){ console.warn('Natijani yozishda xato:', e?.message||e); }

    qRoot.innerHTML = `
      <div class="card">
        <h3>Natija</h3>
        <p><b>${res.score}</b> / ${res.max} ball (${Math.round(res.score/res.max*100)}%)</p>
        <div style="margin-top:8px">
          ${res.details.map(d=>{
            const q=TEST.questions[d.qi];
            const s = d.good? '✅ to‘g‘ri' : '❌ noto‘g‘ri';
            const pick = d.picked.map(i=>String.fromCharCode(65+i)).join(',') || '—';
            const gold = d.gold.map(i=>String.fromCharCode(65+i)).join(',');
            return `
              <div class="q">
                <div><b>${d.qi+1}.</b> ${s} — +${d.points} ball</div>
                <div style="margin-top:4px">${q.text}</div>
                <div class="opts" style="margin-top:6px">
                  ${q.options.map((o,i)=>`
                    <div class="opt ${(d.gold.includes(i)?'correct':'') || (d.picked.includes(i)&&!d.gold.includes(i)?'wrong':'')}">
                      <div style="min-width:22px">${String.fromCharCode(65+i)}.</div>
                      <div>${o.text}${o.correct?' ✅':''}</div>
                    </div>
                  `).join('')}
                </div>
                <div class="muted" style="margin-top:6px">Siz: ${pick} · To‘g‘ri: ${gold}</div>
              </div>
            `;
          }).join('')}
        </div>
      </div>`;
    MathJax.typesetPromise();

    localStorage.removeItem('lm-test-'+TEST.id);
  }

  document.getElementById('prev').onclick=()=>{ if(cur>0){ cur--; renderQ(cur); saveProgress(); } };
  document.getElementById('next').onclick=()=>{ if(cur<TEST.questions.length-1){ cur++; renderQ(cur); saveProgress(); } };
  document.getElementById('finish').onclick=finishTest;

  // start
  const json = await loadTest();
  TEST = json;
  tTitle.textContent = TEST.title || 'Test';
  headInfo.textContent = TEST.id || '';
  tMeta.textContent = `Vaqt: ${TEST.durationMinutes} daqiqa · Savollar: ${TEST.questions.length} · Teglar: ${(TEST.tags||[]).join(', ')}`;

  deadline = Date.now() + (Math.max(1,Number(TEST.durationMinutes)||30) * 60 * 1000);
  restoreProgress();
  if(!deadline || deadline < Date.now()){ deadline = Date.now() + (Math.max(1,Number(TEST.durationMinutes)||30) * 60 * 1000); }
  renderQ(cur);
  timerId = setInterval(tick, 1000);
  tick();
</script>
</body>
</html>
