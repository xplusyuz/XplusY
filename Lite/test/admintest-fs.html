<!doctype html>
<html lang="uz">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AdminTest — Firestore</title>
<link rel="icon" href="./favicon.ico">
<script>window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]}};</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
<style>
  :root{--brand:#2E8B57;--b2:#1F6B45;--bg:#f6faf8;--card:#fff;--ink:#0f172a;--muted:#6b7c75;--frame:#dfeae4;--r:14px}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:5;background:linear-gradient(135deg,var(--brand),var(--b2));color:#fff;padding:10px 14px;font-weight:800;display:flex;gap:10px;align-items:center}
  .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:900px){.row{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px dashed var(--frame);border-radius:var(--r);box-shadow:0 10px 24px #0000000d;padding:14px}
  .card h3{margin:0 0 10px}
  label{font-size:12px;color:var(--muted)}
  input[type="text"],input[type="number"],textarea,select{width:100%;padding:10px;border:1px solid var(--frame);border-radius:10px;font-size:14px;background:#fff}
  textarea{min-height:96px;resize:vertical}
  .btn{background:linear-gradient(135deg,var(--brand),var(--b2));color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
  .ghost{background:#eef6f1;color:#154232;border:1px solid #cfe9dc}
  .danger{background:#c0392b}
  .q{border:1px dashed var(--frame);border-radius:12px;padding:10px;margin-bottom:10px}
  .opts{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .opt{display:flex;gap:6px;align-items:center}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .tiny{font-size:12px;color:var(--muted)}
  .preview{padding:10px;border-radius:12px;background:#f5faf7;border:1px dashed var(--frame)}
  .tag{display:inline-block;background:#e9f5ef;border:1px solid #cfe9dc;padding:4px 8px;border-radius:999px;margin-right:6px;font-size:12px}
</style>
</head>
<body>
<header>
  AdminTest — Firestore
  <span id="me" style="margin-left:auto;font-weight:600"></span>
</header>

<div class="wrap">
  <div class="card">
    <h3>Test ma’lumotlari</h3>
    <div class="grid2">
      <div>
        <label>Test ID (inglizcha, bo‘shliq yo‘q)</label>
        <input id="testId" type="text" placeholder="algebra_1q_01">
      </div>
      <div>
        <label>Sarlavha</label>
        <input id="title" type="text" placeholder="Algebra — 1-chorak test">
      </div>
    </div>
    <div class="grid2" style="margin-top:8px">
      <div>
        <label>Umumiy vaqt (daq.)</label>
        <input id="duration" type="number" min="1" value="30">
      </div>
      <div>
        <label>Teglar (vergul bilan)</label>
        <input id="tags" type="text" placeholder="BSB, 1-chorak">
      </div>
    </div>
    <div class="grid2" style="margin-top:8px">
      <div>
        <label>Status</label>
        <select id="published">
          <option value="true">Published</option>
          <option value="false">Draft</option>
        </select>
      </div>
      <div>
        <label>Mavjud testni yuklab tahrirlash (ID ni kiriting → Yuklash)</label>
        <div style="display:flex;gap:8px">
          <input id="loadId" type="text" placeholder="mavjud_test_id">
          <button class="ghost btn" id="loadBtn">Yuklash</button>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="card">
      <h3>Yangi savol</h3>
      <label>Savol matni (LaTeX: $...$)</label>
      <textarea id="qText"></textarea>
      <div class="grid2" style="margin-top:8px">
        <div>
          <label>Ball</label>
          <input id="qPoints" type="number" min="1" value="1">
        </div>
        <div>
          <label>Tip</label>
          <select id="qType">
            <option value="single">Bitta to‘g‘ri</option>
            <option value="multi">Bir nechta to‘g‘ri</option>
          </select>
        </div>
      </div>
      <div class="opts" style="margin-top:8px">
        <div class="opt"><input type="checkbox" class="isc"> <input type="text" class="optv" placeholder="Variant A"></div>
        <div class="opt"><input type="checkbox" class="isc"> <input type="text" class="optv" placeholder="Variant B"></div>
        <div class="opt"><input type="checkbox" class="isc"> <input type="text" class="optv" placeholder="Variant C"></div>
        <div class="opt"><input type="checkbox" class="isc"> <input type="text" class="optv" placeholder="Variant D"></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" id="addQ">Savolni qo‘shish</button>
        <button class="ghost btn" id="clearQ">Tozalash</button>
      </div>
      <p class="tiny" style="margin-top:8px">single — faqat bitta ✅; multi — bir nechta ✅.</p>
    </div>

    <div class="card">
      <h3>Jonli preview</h3>
      <div class="preview" id="livePreview">Savol va variantlar LaTeX bilan ko‘rinadi.</div>
    </div>
  </div>

  <div class="card">
    <h3>Savollar ro‘yxati</h3>
    <div id="list"></div>
  </div>

  <div class="card">
    <h3>Firestore’ga saqlash</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="saveFS">tests/{id} ga saqlash</button>
      <button class="ghost btn danger" id="deleteFS">tests/{id} ni o‘chirish</button>
      <a id="previewLink" class="ghost btn" target="_blank" rel="noopener">Preview</a>
    </div>
    <pre id="jsonOut" style="white-space:pre-wrap;margin-top:10px;background:#f7fbf8;border:1px dashed var(--frame);padding:10px;border-radius:10px;max-height:260px;overflow:auto"></pre>
    <p class="tiny">Natija: tests/<b id="idEcho">—</b> hujjati yaratiladi/yangi yoziladi. `published=true` bo‘lsa test.html’da ko‘rinadi.</p>
  </div>
</div>

<script type="module">
  // ===== Firebase =====
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
  import { getFirestore, doc, setDoc, getDoc, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

  const cfg = {
    apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
    authDomain: "xplusy-760fa.firebaseapp.com",
    projectId: "xplusy-760fa",
    storageBucket: "xplusy-760fa.firebasestorage.app",
    messagingSenderId: "992512966017",
    appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
    measurementId: "G-459PLJ7P7L"
  };
  const app = initializeApp(cfg);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Auth
  const me = document.getElementById('me');
  const user = await new Promise(res=>{
    onAuthStateChanged(auth, async(u)=>{
      if(u){ me.textContent=u.email||u.uid; res(u); }
      else{
        try{ const r=await signInWithPopup(auth,new GoogleAuthProvider()); me.textContent=r.user.email; res(r.user); }
        catch(e){ alert('Kirish talab qilinadi.'); location.reload(); }
      }
    });
  });

  // UI refs
  const S = {
    testId: document.getElementById('testId'),
    title: document.getElementById('title'),
    duration: document.getElementById('duration'),
    tags: document.getElementById('tags'),
    published: document.getElementById('published'),
    qText: document.getElementById('qText'),
    qPoints: document.getElementById('qPoints'),
    qType: document.getElementById('qType'),
    list: document.getElementById('list'),
    out: document.getElementById('jsonOut'),
    live: document.getElementById('livePreview'),
    idEcho: document.getElementById('idEcho'),
    loadId: document.getElementById('loadId'),
    loadBtn: document.getElementById('loadBtn'),
    previewLink: document.getElementById('previewLink')
  };
  let questions = [];

  const buildJSON = ()=>({
    schema:'lm-test-v1',
    id: (S.testId.value.trim() || 'test-'+Date.now()),
    title: S.title.value.trim() || 'No title',
    durationMinutes: Math.max(1, Number(S.duration.value)||30),
    tags: S.tags.value.split(',').map(s=>s.trim()).filter(Boolean),
    published: (S.published.value==='true'),
    questions
  });

  function renderList(){
    S.list.innerHTML = questions.map((q,idx)=>`
      <div class="q">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><b>${idx+1}.</b> <span style="color:#6b7c75;font-size:12px">(${q.type}, ${q.points} ball)</span></div>
          <div style="display:flex;gap:6px">
            <button class="ghost btn" onclick="moveQ(${idx},-1)">↑</button>
            <button class="ghost btn" onclick="moveQ(${idx},1)">↓</button>
            <button class="btn danger" onclick="delQ(${idx})">O‘chirish</button>
          </div>
        </div>
        <div style="margin-top:6px">${q.text}</div>
        <div style="margin-top:6px">${q.options.map((o,i)=>`<span class="tag">${String.fromCharCode(65+i)}. ${o.text}${o.correct?' ✅':''}</span>`).join('')}</div>
      </div>
    `).join('');
    MathJax.typesetPromise();
    const data = buildJSON();
    S.out.textContent = JSON.stringify(data, null, 2);
    S.idEcho.textContent = data.id;
    S.previewLink.href = `./test.html?id=${encodeURIComponent(data.id)}`;
  }
  window.moveQ=(i,d)=>{ const j=i+d; if(j<0||j>=questions.length) return; [questions[i],questions[j]]=[questions[j],questions[i]]; renderList(); }
  window.delQ=(i)=>{ questions.splice(i,1); renderList(); }

  const curQ = ()=>{
    const vs=[...document.querySelectorAll('.optv')].map(i=>i.value.trim());
    const cs=[...document.querySelectorAll('.isc')].map(i=>i.checked);
    const opts=vs.filter((t,ix)=>t!==''||cs[ix]).map((t,ix)=>({text:t||('Variant '+String.fromCharCode(65+ix)), correct:!!cs[ix]}));
    return { text:S.qText.value.trim()||'—', points:Math.max(1,Number(S.qPoints.value)||1), type:S.qType.value, options:opts };
  };
  function updateLive(){
    const q=curQ();
    S.live.innerHTML = `<div><b>Matn:</b> ${q.text}</div>
      <div style="margin-top:6px"><b>Variantlar:</b> ${q.options.map((o,i)=>`<span class="tag">${String.fromCharCode(65+i)}. ${o.text}${o.correct?' ✅':''}</span>`).join('')}</div>
      <div style="margin-top:6px;color:#6b7c75;font-size:12px">Tip: ${q.type}, Ball: ${q.points}</div>`;
    MathJax.typesetPromise();
  }
  document.getElementById('addQ').onclick=()=>{
    const q=curQ();
    if(q.options.length<2) return alert('Kamida 2 ta variant kiriting.');
    const ok = q.type==='single' ? q.options.filter(o=>o.correct).length===1 : q.options.some(o=>o.correct);
    if(!ok) return alert('To‘g‘ri variant(lar)ni belgilang.');
    questions.push(q); renderList();
  };
  document.getElementById('clearQ').onclick=()=>{
    S.qText.value=''; S.qPoints.value=1; S.qType.value='single';
    document.querySelectorAll('.optv').forEach(i=>i.value='');
    document.querySelectorAll('.isc').forEach(i=>i.checked=false);
    updateLive();
  };
  ['qText','qPoints','qType'].forEach(id=>document.getElementById(id).addEventListener('input',updateLive));
  document.querySelectorAll('.optv,.isc').forEach(e=>e.addEventListener('input',updateLive));

  // save
  document.getElementById('saveFS').onclick = async ()=>{
    const data = buildJSON();
    if(!questions.length) return alert('Avval savollar qo‘shing.');
    try{
      await setDoc(doc(db,'tests',data.id),{
        ...data,
        updatedAt: serverTimestamp(),
        createdBy: { uid:user.uid, email:user.email||null, displayName:user.displayName||null }
      }, { merge:true });
      alert('Saqlandi: tests/'+data.id);
    }catch(e){ alert('Saqlashda xato: '+(e?.message||e)); }
  };

  // load
  S.loadBtn.onclick = async ()=>{
    const id=S.loadId.value.trim(); if(!id) return;
    const d=await getDoc(doc(db,'tests',id));
    if(!d.exists()) return alert('Topilmadi: '+id);
    const t=d.data();
    S.testId.value=t.id||id; S.title.value=t.title||''; S.duration.value=t.durationMinutes||30;
    S.tags.value=(t.tags||[]).join(', '); S.published.value=String(!!t.published);
    questions=t.questions||[]; renderList(); updateLive();
    alert('Yuklandi: '+id); window.scrollTo({top:0,behavior:'smooth'});
  };

  // delete
  document.getElementById('deleteFS').onclick = async ()=>{
    const id=(S.testId.value.trim()||S.loadId.value.trim());
    if(!id) return alert('ID kiriting.');
    if(!confirm('Haqiqatan o‘chirilsinmi? '+id)) return;
    try{ await deleteDoc(doc(db,'tests',id)); alert('O‘chirildi: '+id); }
    catch(e){ alert('O‘chirishda xato: '+(e?.message||e)); }
  };

  updateLive(); renderList();
</script>
</body>
</html>
