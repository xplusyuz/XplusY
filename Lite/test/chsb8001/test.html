<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>MathCenter — Test</title>
  <meta name="color-scheme" content="dark light"/>

  <!-- MathJax (LaTeX) -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$','$'],['\\(','\\)']], displayMath: [['$$','$$'],['\\[','\\]']], processEscapes: true, packages:{'[+]':['noerrors']} },
      options: { renderActions: { addMenu: [] } }, loader: { load: ['[tex]/noerrors'] }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root{
      --brand:#2E8B57;--brand2:#1F6B45;
      --bg:#f6faf8;--text:#0f172a;--muted:#6b7c75;--card:#ffffff;--frame:#e3efe8;
      --ok:#2E8B57;--bad:#b91c1c;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--frame);z-index:10}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand .pi{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand2));
      color:#fff;display:grid;place-items:center;box-shadow:0 6px 24px rgba(31,107,69,.25);font-weight:700}
    #authInfo{margin-left:auto;color:#0f172a;background:#f2f8f4;border:1px solid #e3efe8;padding:6px 10px;border-radius:8px}

    main .card{background:var(--card);border:1px solid var(--frame);border-radius:16px;padding:16px;margin:16px 0;box-shadow:0 10px 30px rgba(20,40,30,.06)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    button{padding:10px 14px;border-radius:12px;border:1px solid var(--brand);background:var(--brand);color:#fff;cursor:pointer}
    button.ghost{background:#fff;color:var(--brand)}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .hidden{display:none!important}

    #questionView .qtext{font-size:18px;margin-bottom:10px}
    #questionView .opt{display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border:1px solid #edf3ee;border-radius:12px;background:#fbfdfc;margin:8px 0;
      transition: box-shadow .2s ease, background .2s ease, border-color .2s ease;}
    #questionView img{width:min(780px,100%);max-height:80vh;display:block;margin:14px auto;object-fit:contain;-webkit-user-drag:none;user-select:none;pointer-events:auto}

    .navdots{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .dot{width:36px;height:36px;border-radius:10px;border:1px solid var(--frame);display:grid;place-items:center;background:#fff;cursor:pointer}
    .dot.active{border-color:var(--brand);box-shadow:0 0 0 3px rgba(46,139,87,.15)}
    .score{font-size:20px;font-weight:700}
    .ok{color:var(--ok)} .bad{color:var(--bad)}

    /* AUTH OVERLAY */
    #authOverlay{
      position:fixed;inset:0;background:rgba(15,23,42,.55);display:none;z-index:9999;
      backdrop-filter:blur(2px);align-items:center;justify-content:center;text-align:center;color:#fff;padding:20px
    }
    #authOverlay .panel{max-width:520px;background:#0f172a;border:1px solid #1f2937;border-radius:16px;padding:24px}

    /* Print/source/save block (soft) */
    @media print { body{display:none} }
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <div class="brand">
        <div class="pi">π</div>
        <div>
          <div style="font-weight:700">MathCenter — Test</div>
          <small style="color:var(--muted)">CHSB/BSB tayyorgarlik sinov</small>
        </div>
      </div>
      <div class="row" style="margin-left:auto;gap:8px">
        <div id="authInfo">Kirish: aniqlanmoqda…</div>
      </div>
    </div>
  </header>

  <!-- AUTH OVERLAY -->
  <div id="authOverlay">
    <div class="panel">
      <h3 style="margin:0 0 10px;">Kirish talab qilinadi</h3>
      <p style="margin:0 0 16px;opacity:.9">Testni yechish uchun avval tizimga kiring. Kirmagan foydalanuvchilarga ruxsat berilmaydi.</p>
      <button id="loginBtn">Google orqali kirish</button>
    </div>
  </div>

  <main class="wrap">
    <!-- Boshlash -->
    <div id="introCard" class="card">
      <div class="row">
        <div style="flex:1">
          <h2 style="margin:6px 0 10px">Testga xush kelibsiz!</h2>
          <p style="margin:0;color:var(--muted)">Boshlash tugmasini bosing. Vaqt va natijalar qayd etiladi. Ko‘p javobli savollarda barcha to‘g‘ri variantlarni tanlash shart.</p>
        </div>
        <div class="row">
          <button id="startBtn" class="ghost">Boshlash</button>
        </div>
      </div>
    </div>

    <!-- Savollar -->
    <div id="questionsCard" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <div><b id="qIndex">1</b>/<span id="qTotal">—</span></div>
        <div class="row">
          <button id="prevBtn" class="ghost">← Oldingi</button>
          <button id="nextBtn">Keyingi →</button>
        </div>
      </div>

      <div id="questionView" style="margin-top:8px">
        <div class="qtext" id="qText"></div>
        <div id="opts"></div>
        <div id="qImageWrap"></div>
      </div>

      <div class="row" style="justify-content:space-between;margin-top:12px">
        <div class="navdots" id="navDots"></div>
        <div class="row">
          <button id="revealBtn" class="ghost">To‘g‘ri javob(lar)ni ko‘rsat</button>
          <button id="finishBtn" style="margin-left:8px">Yakunlash</button>
        </div>
      </div>
    </div>

    <!-- Natijalar -->
    <div id="resultCard" class="card hidden">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div class="score">Umumiy ball: <span id="scoreTotal">0</span>/<span id="scoreMax">0</span></div>
          <div id="scoreNote" style="color:var(--muted);margin-top:6px"></div>
        </div>
        <div class="row">
          <button id="againBtn" class="ghost">Savollarga qaytish</button>
        </div>
      </div>
      <div id="detailTable" style="margin-top:10px"></div>
    </div>
  </main>

  <!-- Firebase (modular v9) -->
  <script type="module">
    // ---------- Minimal helper ----------
    const $ = (sel)=>document.querySelector(sel);

    // ---------- Firebase setup ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import {
      getFirestore, doc, runTransaction, serverTimestamp, setDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // !!! Siz bergan config (o'zgartirishingiz mumkin) !!!
    const firebaseConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.firebasestorage.app",
      messagingSenderId: "992512966017",
      appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId: "G-459PLJ7P7L"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // window.__firebase shim (sizning eski kod bilan mos)
    window.__firebase = {
      app, auth, db,
      GoogleAuthProvider,
      signInWithPopup,
      onAuthStateChanged,
      doc, runTransaction, serverTimestamp, setDoc, getDoc
    };

    // ---------- Global holatlar ----------
    let testData = null;
    let currentIndex = 0;
    let startedAt = null;
    let currentUser = null;
    let currentTestId = 'demo-test'; // xohlasangiz URLdan o‘qing

    // ---------- AUTH & START ----------
    document.addEventListener('DOMContentLoaded', ()=>{
      const authInfoEl = $('#authInfo');
      const overlay = $('#authOverlay');
      const loginBtn = $('#loginBtn');
      let authResolved = false;

      authInfoEl.textContent='Kirish: aniqlanmoqda…';
      setTimeout(()=>{ if(!authResolved) authInfoEl.textContent='Kirish: mehmon'; }, 3000);

      if (loginBtn){
        loginBtn.addEventListener('click', async ()=>{
          try{
            await signInWithPopup(auth, new GoogleAuthProvider());
          }catch(e){ console.error('Sign in error:', e); }
        });
      }

      function blockTest(){
        overlay.style.display='flex';
        disableTestUI(true);
      }
      function allowTest(){
        overlay.style.display='none';
        disableTestUI(false);
      }
      function disableTestUI(disabled){
        $('#startBtn')?.toggleAttribute('disabled', disabled);
        $('#questionsCard')?.classList.toggle('pointer-events-none', disabled);
        $('#questionsCard')?.classList.toggle('opacity-50', disabled);
      }

      onAuthStateChanged(auth, (user)=>{
        authResolved = true;
        currentUser = user || null;
        authInfoEl.textContent = user ? `Kirish: ${user.displayName || user.email}` : 'Kirish: mehmon';
        if (user){
          allowTest();
          startedAt = new Date();
          loadTestData();
        } else {
          blockTest();
        }
      });

      // Tugmalar
      $('#startBtn').addEventListener('click', ()=>{
        if (!auth.currentUser){ alert('Avval tizimga kiring.'); return; }
        $('#introCard').classList.add('hidden');
        $('#questionsCard').classList.remove('hidden');
        renderQuestion();
      });
      $('#prevBtn').addEventListener('click', ()=>{ if (currentIndex>0){ currentIndex--; renderQuestion(); } });
      $('#nextBtn').addEventListener('click', ()=>{ if (currentIndex<testData.questions.length-1){ currentIndex++; renderQuestion(); } });
      $('#finishBtn').addEventListener('click', onTestFinish);
      $('#againBtn').addEventListener('click', ()=>{
        $('#resultCard').classList.add('hidden');
        $('#questionsCard').classList.remove('hidden');
      });
      $('#revealBtn').addEventListener('click', revealCorrect);

      // O‘ng tugma, drag va ba’zi klavishlarni “qiyinlashtirish”
      document.addEventListener('contextmenu', e=> e.preventDefault());
      document.addEventListener('dragstart', e=> e.preventDefault());
      document.addEventListener('keydown', (e)=>{
        const k = (e.key||'').toLowerCase();
        if ((e.ctrlKey||e.metaKey) && ['s','p','u'].includes(k)) e.preventDefault();
      });
    });

    // ---------- Test data yuklash ----------
    async function loadTestData(){
      try{
        const res = await fetch('./test.json',{cache:'no-store'});
        if (!res.ok) throw new Error('test.json yo‘q yoki xato');
        testData = await res.json();
      }catch(e){
        console.warn('test.json topilmadi, fallback ishlatiladi.', e);
        testData = fallbackTestData();
      }
      $('#qTotal').textContent = testData.questions.length;
      buildNavDots();
    }

    function fallbackTestData(){
      return {
        title: "Demo test",
        questions: [
          { text: "1) $2+2$ nechiga teng?", options:["2","3","4","5"], correctIndex:2, points:1 },
          { text: "2) Quyidagilardan qaysilari tub son? (ko‘p tanlov)", options:["2","4","5","9"], correctIndices:[0,2], points:2 },
          { text: "3) Rasmga qarab nisbatni toping.", image:"https://upload.wikimedia.org/wikipedia/commons/thumb/3/3b/Geometric_figure_square.svg/512px-Geometric_figure_square.svg.png", options:["1:1","1:2","2:3","3:4"], correctIndex:0, points:1 }
        ]
      };
    }

    // ---------- Render savol ----------
    function renderQuestion(){
      const q = testData.questions[currentIndex];
      $('#qIndex').textContent = String(currentIndex+1);
      $('#qText').innerHTML = q.text || '';

      // Variantlar
      const optsEl = $('#opts'); optsEl.innerHTML = '';
      const multi = isMulti(q);
      q.options.forEach((opt, i)=>{
        const wrap = document.createElement('label');
        wrap.className = 'opt';
        const input = document.createElement('input');
        input.type = multi ? 'checkbox' : 'radio';
        input.name = multi ? `q${currentIndex}[]` : `q${currentIndex}`;
        input.value = String(i);
        input.style.marginTop = '5px';
        const span = document.createElement('span');
        span.innerHTML = opt;
        wrap.appendChild(input);
        wrap.appendChild(span);
        wrap.setAttribute('oncontextmenu','return false');
        optsEl.appendChild(wrap);
      });

      // Rasm bo‘lsa
      const imgWrap = $('#qImageWrap'); imgWrap.innerHTML='';
      if (q.image){
        const img = document.createElement('img');
        img.src = q.image;
        img.alt = 'Savol rasmi';
        img.draggable = false;
        img.setAttribute('oncontextmenu','return false');
        imgWrap.appendChild(img);
      }

      // Dots
      highlightDot(currentIndex);

      // MathJax render
      if (window.MathJax?.typesetPromise) MathJax.typesetPromise();
    }

    function buildNavDots(){
      const c = $('#navDots'); c.innerHTML='';
      for (let i=0;i<testData.questions.length;i++){
        const d = document.createElement('button');
        d.className='dot';
        d.textContent = String(i+1);
        d.addEventListener('click', ()=>{ currentIndex=i; renderQuestion(); });
        c.appendChild(d);
      }
      highlightDot(0);
    }
    function highlightDot(i){
      [...document.querySelectorAll('.dot')].forEach((el,idx)=> el.classList.toggle('active', idx===i));
    }

    // ---------- Ball hisoblash ----------
    function isMulti(q){ return Array.isArray(q.correctIndices); }
    function normalize(arr){ return Array.from(new Set((arr||[]).map(Number))).sort((a,b)=>a-b); }
    function arraysEqual(a,b){
      if (a.length!==b.length) return false;
      for (let i=0;i<a.length;i++) if (a[i]!==b[i]) return false;
      return true;
    }
    function userPickedFor(i){
      const q = testData.questions[i];
      if (isMulti(q)){
        return [...document.querySelectorAll(`input[name="q${i}[]"]:checked`)].map(x=>Number(x.value));
      } else {
        const r = document.querySelector(`input[name="q${i}"]:checked`);
        return r ? [Number(r.value)] : [];
      }
    }
    function isCorrect(i, picked){
      const q = testData.questions[i];
      if (isMulti(q)){
        const correct = normalize(q.correctIndices||[]);
        return arraysEqual(normalize(picked), correct);
      } else {
        const ci = Number(q.correctIndex ?? -1);
        return picked.length===1 && picked[0]===ci;
      }
    }
    function computeTotals(){
      let total = 0, max = 0;
      const perQuestion = [];
      testData.questions.forEach((q,i)=>{
        const pts = Number(q.points ?? q.ball ?? 1);
        max += pts;
        const picked = userPickedFor(i);
        const ok = isCorrect(i, picked);
        if (ok) total += pts;
        perQuestion.push({i, pts, ok, picked});
      });
      return { total, max, perQuestion };
    }

    // ---------- Birinchi natijani yozish ----------
    async function writeFirstScoreOnly({testId, uid, total, max, detail}){
      const ref = doc(db, 'results', testId, 'users', uid);
      return runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        if (snap.exists()){
          return {skipped:true, already:snap.data()};
        }
        tx.set(ref, {
          uid, testId,
          firstTotal: total,
          max, detail,
          createdAt: serverTimestamp()
        });
        return {skipped:false};
      });
    }

    // ---------- Testni yakunlash ----------
    async function onTestFinish(){
      const { total, max, perQuestion } = computeTotals();

      // Firebaseda faqat birinchi urinish
      const user = auth.currentUser;
      if (user){
        try{
          const res = await writeFirstScoreOnly({
            testId: currentTestId, uid: user.uid, total, max, detail: perQuestion
          });
          console.log(res.skipped ? 'Avval yozilgan, bu safar yozilmadi.' : 'Birinchi natija yozildi.');
        }catch(e){ console.error('Yozish xatosi:', e); }
      }

      // UI
      $('#questionsCard').classList.add('hidden');
      $('#resultCard').classList.remove('hidden');
      $('#scoreTotal').textContent = String(total);
      $('#scoreMax').textContent = String(max);
      $('#scoreNote').textContent = `To‘g‘ri: ${perQuestion.filter(x=>x.ok).length} ta / ${perQuestion.length} ta`;

      // Batafsil jadval
      const tbl = document.createElement('div');
      perQuestion.forEach(row=>{
        const el = document.createElement('div');
        el.style.border='1px solid var(--frame)';
        el.style.borderRadius='12px';
        el.style.padding='10px';
        el.style.margin='6px 0';
        el.innerHTML = `
          <div><b>${row.i+1}-savol</b> — <span class="${row.ok?'ok':'bad'}">${row.ok?'to‘g‘ri':'noto‘g‘ri'}</span> (<b>${row.pts}</b> ball)</div>
          <div style="color:var(--muted)">tanlangan: [${row.picked.join(', ')}]</div>
        `;
        tbl.appendChild(el);
      });
      const container = $('#detailTable'); container.innerHTML=''; container.appendChild(tbl);
    }

    // ---------- To‘g‘ri javoblarni ko‘rsatish (siz bergan logika) ----------
    function revealCorrect(){
      $('#resultCard').classList.add('hidden');
      $('#questionsCard').classList.remove('hidden');
      const q=testData.questions[currentIndex]; const multi=isMulti(q);
      const correct = multi?(q.correctIndices||[]):[Number(q.correctIndex??-1)];
      document.querySelectorAll('#questionView .opt').forEach(row=>{
        row.style.borderColor='#edf3ee'; row.style.boxShadow='none'; row.style.background='#fbfdfc';
      });
      document.querySelectorAll('#questionView input').forEach(inp=>{
        const orig = Number(inp.value); // ORIGINAL index stored in value
        const row=inp.closest('.opt');
        if(correct.includes(orig)){
          row.style.borderColor='rgba(46,139,87,.55)';
          row.style.boxShadow='0 0 0 4px rgba(46,139,87,.18)';
          row.style.background='#f3fbf6';
        }
      });
    }
  </script>
</body>
</html>
