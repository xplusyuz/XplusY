<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#2E8B57" />
  <title>LeaderMath.UZ â€” App</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="icon" href="logo.png" type="image/png" />
  <style>
    :root{
      --primary:#2E8B57;
      --primary-light:#3CB371;
      --primary-dark:#1E6B47;
      --gradient:linear-gradient(135deg,#2E8B57,#3CB371);
      --glass:rgba(255,255,255,.86);
      --glass-border:rgba(255,255,255,.22);
      --shadow:0 20px 50px rgba(46,139,87,.15);
      --text:#1A202C;
      --text-light:#718096;
      --radius:24px;
      --transition:all .25s ease;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',system-ui,-apple-system,sans-serif}
    body{
      min-height:100vh;
      background:linear-gradient(135deg,#f0fdf4,#dcfce7,#f0f9ff);
      padding:20px;
      position:relative;
      overflow-x:hidden;
    }
    .bg-circle{position:absolute;border-radius:50%;z-index:0;opacity:.6}
    .bg-circle:nth-child(1){width:300px;height:300px;background:linear-gradient(135deg,rgba(46,139,87,.08),transparent);top:5%;left:5%}
    .bg-circle:nth-child(2){width:420px;height:420px;background:linear-gradient(135deg,transparent,rgba(60,179,113,.05));bottom:5%;right:5%}
    .bg-circle:nth-child(3){width:220px;height:220px;background:linear-gradient(135deg,rgba(46,139,87,.06),transparent);top:60%;left:80%}
    .app-container{position:relative;z-index:10;width:100%;max-width:1200px;margin:0 auto}

    /* Header */
    .header{
      background:var(--glass);
      backdrop-filter:blur(20px);
      border-radius:var(--radius);
      padding:20px 30px;
      display:flex;
      align-items:center;
      gap:20px;
      margin-bottom:25px;
      box-shadow:var(--shadow);
      border:1px solid var(--glass-border);
      animation:slideDown .6s ease-out;
    }
    .logo-container{
      width:76px;height:76px;border-radius:22px;
      background:linear-gradient(135deg,#ffffff,rgba(255,255,255,.75));
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 12px 32px rgba(46,139,87,.18);
      border:2px solid rgba(60,179,113,.55);
      overflow:hidden;
      position:relative;
    }
    /* Shine */
    .logo-container:before{
      content:"";
      position:absolute;inset:-40%;
      background:linear-gradient(120deg,transparent,rgba(255,255,255,.55),transparent);
      transform:translateX(-60%) rotate(20deg);
      animation:shine 3.8s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes shine{
      0%,60%{transform:translateX(-70%) rotate(20deg)}
      100%{transform:translateX(70%) rotate(20deg)}
    }
    .logo-container img{
      width:100%;
      height:100%;
      object-fit:contain; /* kvadrat logo cho'zilmaydi */
      padding:10px; /* frame ichida premium spacing */
      position:relative;z-index:1;
      filter:drop-shadow(0 4px 10px rgba(0,0,0,.12));
    }
    .header-info{flex:1}
    .header-title{
      font-size:22px;font-weight:900;
      background:var(--gradient);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      margin-bottom:5px;
    }
    .header-subtitle{font-size:13px;color:var(--text-light)}
    .user-profile{
      display:flex;align-items:center;gap:15px;
      background:rgba(255,255,255,.82);
      padding:10px 20px;border-radius:50px;
      border:1px solid rgba(46,139,87,.12);
    }
    .user-avatar{width:48px;height:48px;border-radius:50%;border:2px solid var(--primary);object-fit:cover}
    .user-details{display:flex;flex-direction:column;gap:3px}
    .user-name{font-weight:800;font-size:14px;color:var(--text)}
    .user-stats{display:flex;gap:10px;font-size:11px;color:var(--text-light)}
    .user-stat{display:flex;align-items:center;gap:4px}
    .header-actions{display:flex;gap:10px}
    .header-btn{
      width:48px;height:48px;border-radius:50%;
      background:rgba(255,255,255,.85);
      border:1px solid rgba(46,139,87,.12);
      display:flex;align-items:center;justify-content:center;
      color:var(--primary);font-size:18px;
      cursor:pointer;transition:var(--transition);
    }
    .header-btn:hover{background:var(--primary);color:white;transform:translateY(-2px)}
    .main-content{display:grid;grid-template-columns:1fr;gap:25px}

    /* Shared sections */
    .level-section,.video-section,.challenge-section,.content-section,.footer{
      background:var(--glass);
      backdrop-filter:blur(20px);
      border-radius:var(--radius);
      padding:30px;
      box-shadow:var(--shadow);
      border:1px solid var(--glass-border);
    }
    .level-section{animation:fadeIn .8s ease-out .2s both}
    .video-section{animation:fadeIn .8s ease-out .3s both}
    .challenge-section{animation:fadeIn .8s ease-out .4s both}
    .content-section{animation:fadeIn .8s ease-out .5s both}
    .footer{animation:fadeIn .8s ease-out .6s both}

    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px}
    .section-title{font-size:20px;font-weight:900;color:var(--text);display:flex;align-items:center;gap:10px}
    .section-title i{color:var(--primary)}
    .section-subtitle{font-size:13px;color:var(--text-light)}

    /* Level */
    .level-card{display:grid;grid-template-columns:auto 1fr;gap:25px;align-items:center}
    .medal-container{
      position:relative;width:120px;height:120px;border-radius:30px;background:white;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 15px 35px rgba(46,139,87,.2);
      border:3px solid var(--primary-light);overflow:hidden;
    }
    .medal-container img{width:80px;height:80px;object-fit:contain}
    .medal-glow{position:absolute;width:150px;height:150px;background:radial-gradient(circle at center,rgba(46,139,87,.2),transparent 70%);filter:blur(10px);z-index:0}
    .level-info{display:flex;flex-direction:column;gap:15px}
    .level-row{display:flex;justify-content:space-between;align-items:center}
    .level-text{font-size:18px;font-weight:800;color:var(--text)}
    .level-range{font-size:13px;color:var(--text-light)}
    .progress-container{width:100%;height:12px;background:rgba(46,139,87,.1);border-radius:10px;overflow:hidden}
    .progress-bar{height:100%;background:var(--gradient);border-radius:10px;transition:width .5s ease}
    .level-stats{display:flex;justify-content:space-between;font-size:13px;color:var(--text-light)}
    .rating-btn{
      background:var(--gradient);color:white;border:none;border-radius:50px;
      padding:10px 20px;font-weight:800;display:flex;align-items:center;gap:8px;
      cursor:pointer;transition:var(--transition)
    }
    .rating-btn:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(46,139,87,.2)}

    /* Video */
    .video-container{position:relative;width:100%;border-radius:18px;overflow:hidden;aspect-ratio:16/9;margin-top:15px}
    .video-element{width:100%;height:100%;object-fit:cover;display:block}
    .video-controls{position:absolute;right:20px;bottom:20px;display:flex;gap:10px;z-index:10}
    .video-btn{
      width:50px;height:50px;border-radius:50%;
      background:rgba(255,255,255,.92);
      border:1px solid rgba(46,139,87,.2);
      display:flex;align-items:center;justify-content:center;
      color:var(--primary);font-size:18px;cursor:pointer;transition:var(--transition)
    }
    .video-btn:hover{background:var(--primary);color:white}

    /* Challenge */
    .challenge-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px;margin-top:20px}
    .challenge-card{
      background:rgba(255,255,255,.72);
      border-radius:20px;padding:20px;
      border:1px solid rgba(46,139,87,.1);
      transition:var(--transition)
    }
    .challenge-card:hover{transform:translateY(-5px);box-shadow:0 15px 35px rgba(46,139,87,.1)}
    .challenge-header{display:flex;align-items:center;gap:15px;margin-bottom:15px}
    .challenge-icon{
      width:56px;height:56px;border-radius:16px;
      background:linear-gradient(135deg,rgba(46,139,87,.14),rgba(60,179,113,.10));
      border:1px solid rgba(46,139,87,.18);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;flex:0 0 auto;
      box-shadow:0 10px 22px rgba(46,139,87,.10);
    }
    .challenge-icon img{width:74%;height:74%;object-fit:contain;filter:drop-shadow(0 2px 8px rgba(0,0,0,.10))}
    .challenge-info h3{font-size:16px;font-weight:800;color:var(--text);margin-bottom:5px}
    .challenge-info p{font-size:13px;color:var(--text-light);line-height:1.35}
    .challenge-status{display:inline-block;padding:4px 12px;border-radius:50px;font-size:11px;font-weight:900;margin-top:6px}
    .status-live{background:rgba(46,139,87,.15);color:var(--primary)}
    .status-upcoming{background:rgba(245,158,11,.15);color:#F59E0B}
    .status-ended{background:rgba(148,163,184,.15);color:#94A3B8}
    .challenge-timer{font-size:12px;color:var(--text-light);margin:10px 0}
    .challenge-action{
      width:100%;padding:12px;background:var(--gradient);color:white;border:none;border-radius:12px;
      font-weight:900;cursor:pointer;transition:var(--transition)
    }
    .challenge-action:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(46,139,87,.2)}
    .challenge-action[disabled]{cursor:not-allowed}

    /* Content (BigChips) */
    .content-filters{
      display:flex;gap:12px;overflow-x:auto;padding:10px 0;margin-bottom:18px;
      -ms-overflow-style:none;scrollbar-width:none;
    }
    .content-filters::-webkit-scrollbar{display:none}
    .filter-chip{
      flex:0 0 auto;
      padding:10px 14px;
      border-radius:18px;
      background:rgba(255,255,255,.76);
      border:1px solid rgba(46,139,87,.12);
      font-weight:800;
      font-size:14px;
      color:var(--text);
      cursor:pointer;
      transition:var(--transition);
      display:flex;align-items:center;gap:10px;
      min-height:52px;
    }
    .filter-chip:hover{transform:translateY(-1px);box-shadow:0 10px 22px rgba(46,139,87,.08)}
    .filter-chip.active{
      background:linear-gradient(135deg,rgba(46,139,87,.18),rgba(60,179,113,.12));
      border-color:rgba(46,139,87,.25);
    }
    .chip-ic{
      width:40px;height:40px;border-radius:14px;
      background:linear-gradient(135deg,rgba(46,139,87,.12),rgba(60,179,113,.08));
      border:1px solid rgba(46,139,87,.16);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;flex:0 0 auto;
    }
    .chip-ic img{width:78%;height:78%;object-fit:contain}
    .chip-meta{display:flex;flex-direction:column;gap:2px;line-height:1.1}
    .chip-title{font-size:14px;font-weight:900}
    .chip-sub{font-size:12px;color:var(--text-light);font-weight:700}
    .chip-count{
      margin-left:8px;
      min-width:34px;height:34px;border-radius:14px;
      background:rgba(46,139,87,.10);
      border:1px solid rgba(46,139,87,.14);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;color:var(--primary);
    }
    .filter-chip.active .chip-count{background:rgba(46,139,87,.18);border-color:rgba(46,139,87,.22)}
    .filter-chip.active .chip-title{color:var(--primary-dark)}

    /* Content grid */
    .content-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-top:10px}
    .content-card{
      background:rgba(255,255,255,.72);
      border-radius:18px;padding:20px;border:1px solid rgba(46,139,87,.1);
      transition:var(--transition)
    }
    .content-card:hover{transform:translateY(-5px);box-shadow:0 15px 35px rgba(46,139,87,.1)}
    .content-icon{
      width:56px;height:56px;border-radius:16px;
      background:linear-gradient(135deg,rgba(46,139,87,.14),rgba(60,179,113,.10));
      border:1px solid rgba(46,139,87,.16);
      display:flex;align-items:center;justify-content:center;
      margin-bottom:14px;
      overflow:hidden;
    }
    .content-icon img{width:74%;height:74%;object-fit:contain;filter:drop-shadow(0 2px 8px rgba(0,0,0,.10))}
    .content-card h4{font-size:16px;font-weight:900;color:var(--text);margin-bottom:10px}
    .content-card p{font-size:13px;color:var(--text-light);margin-bottom:15px;line-height:1.4}
    .content-tags{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:15px}
    .content-tag{padding:4px 10px;border-radius:50px;background:rgba(46,139,87,.08);font-size:11px;color:var(--primary);font-weight:700}
    .content-action{
      width:100%;padding:10px;background:rgba(46,139,87,.10);border:1px solid rgba(46,139,87,.20);
      border-radius:12px;color:var(--primary);font-weight:900;font-size:13px;cursor:pointer;transition:var(--transition);
      display:flex;align-items:center;justify-content:center;gap:8px
    }
    .content-action:hover{background:var(--primary);color:white}

    /* Comments Dock */
    .comments-dock{position:fixed;right:30px;bottom:30px;z-index:100}
    .comments-btn{
      width:60px;height:60px;border-radius:50%;
      background:var(--gradient);color:white;border:none;font-size:24px;cursor:pointer;
      box-shadow:0 10px 30px rgba(46,139,87,.3);
      transition:var(--transition);
      display:flex;align-items:center;justify-content:center;position:relative
    }
    .comments-btn:hover{transform:scale(1.1);box-shadow:0 15px 40px rgba(46,139,87,.4)}
    .comments-badge{position:absolute;top:-5px;right:-5px;width:25px;height:25px;border-radius:50%;background:#EF4444;color:white;font-size:12px;font-weight:900;display:flex;align-items:center;justify-content:center}

    /* Footer */
    .footer-content{display:flex;justify-content:space-between;align-items:center;gap:20px}
    .footer-info h3{font-size:18px;font-weight:900;color:var(--primary);margin-bottom:5px}
    .footer-info p{font-size:13px;color:var(--text-light)}
    .footer-links{display:flex;gap:15px}
    .footer-link{
      padding:10px 20px;border-radius:50px;background:rgba(46,139,87,.10);
      border:1px solid rgba(46,139,87,.20);color:var(--primary);text-decoration:none;font-weight:800;font-size:14px;
      display:flex;align-items:center;gap:8px;transition:var(--transition);cursor:pointer
    }
    .footer-link:hover{background:var(--primary);color:white}

    /* Toast */
    .toast{
      position:fixed;bottom:100px;left:50%;
      transform:translateX(-50%) translateY(100px);
      background:rgba(15,23,42,.95);color:white;padding:15px 25px;border-radius:50px;font-weight:700;
      z-index:1000;opacity:0;transition:all .3s ease;backdrop-filter:blur(10px)
    }
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1}

    /* Animations */
    @keyframes slideDown{from{opacity:0;transform:translateY(-30px)}to{opacity:1;transform:translateY(0)}}
    @keyframes fadeIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}

    /* Responsive */
    @media (max-width:768px){
      .header{flex-direction:column;text-align:center;gap:15px}
      .user-profile{width:100%;justify-content:center}
      .header-actions{width:100%;justify-content:center}
      .level-card{grid-template-columns:1fr;text-align:center;gap:20px}
      .medal-container{margin:0 auto}
      .challenge-grid,.content-grid{grid-template-columns:1fr}
      .footer-content{flex-direction:column;text-align:center}
      .comments-dock{right:20px;bottom:20px}
      .comments-btn{width:50px;height:50px;font-size:20px}
    }
    @media (max-width:480px){
      body{padding:10px}
      .header,.level-section,.video-section,.challenge-section,.content-section,.footer{padding:20px}
      .section-title{font-size:18px}
      .medal-container{width:100px;height:100px}
      .medal-container img{width:60px;height:60px}
    }
  </style>
</head>
<body>
  <div class="bg-circle"></div>
  <div class="bg-circle"></div>
  <div class="bg-circle"></div>

  <div class="app-container">
    <header class="header">
      <div class="logo-container">
        <img src="logo.png" alt="LeaderMath.UZ" />
      </div>
      <div class="header-info">
        <h1 class="header-title">LeaderMath.UZ â€” App</h1>
        <p class="header-subtitle">Matematik interaktiv platforma â€¢ Premium tajriba</p>
      </div>
      <div class="user-profile">
        <img src="logo.png" alt="Foydalanuvchi" class="user-avatar" id="userAvatar" />
        <div class="user-details">
          <div class="user-name" id="userName">Foydalanuvchi</div>
          <div class="user-stats">
            <div class="user-stat"><i class="fas fa-trophy"></i> <span id="userPoints">0</span></div>
            <div class="user-stat"><i class="fas fa-coins"></i> <span id="userBalance">0</span></div>
            <div class="user-stat"><i class="fas fa-birthday-cake"></i> <span id="userAge">â€”</span></div>
          </div>
        </div>
      </div>
      <div class="header-actions">
        <button class="header-btn" id="btnNotifications" title="Bildirishnomalar"><i class="fas fa-bell"></i></button>
        <button class="header-btn" id="btnLogout" title="Chiqish"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </header>

    <main class="main-content">
      <section class="level-section">
        <div class="section-header">
          <div>
            <h2 class="section-title"><i class="fas fa-medal"></i> Sizning Darajangiz</h2>
            <p class="section-subtitle">Ball â†’ bosqich â€¢ medallar</p>
          </div>
          <button class="rating-btn" id="btnRating"><i class="fas fa-chart-line"></i><span>Reyting</span></button>
        </div>
        <div class="level-card">
          <div class="medal-container">
            <div class="medal-glow"></div>
            <img src="logo.png" alt="Medalyon" id="medalImage" />
          </div>
          <div class="level-info">
            <div class="level-row">
              <div class="level-text" id="levelText">Daraja: 1</div>
              <div class="level-range" id="levelRange">0 â†’ 100 ball</div>
            </div>
            <div class="progress-container"><div class="progress-bar" id="levelProgress" style="width:25%"></div></div>
            <div class="level-stats">
              <div id="currentPoints">25 ball</div>
              <div id="levelPercentage">25%</div>
              <div id="nextLevelHint">Keyingi: 75 ball</div>
            </div>
          </div>
        </div>
      </section>

      <section class="video-section">
        <div class="section-header">
          <div>
            <h2 class="section-title"><i class="fas fa-video"></i> Yangiliklar</h2>
            <p class="section-subtitle">Eng soâ€˜ngi video yangiliklar</p>
          </div>
        </div>
        <div class="video-container">
          <video class="video-element" id="heroVideo" autoplay muted loop playsinline>
            <source src="videos/banner.mp4" type="video/mp4" />
          </video>
          <div class="video-controls">
            <button class="video-btn" id="btnPlayPause"><i class="fas fa-pause"></i></button>
            <button class="video-btn" id="btnMute"><i class="fas fa-volume-mute"></i></button>
          </div>
        </div>
      </section>

      <section class="challenge-section">
        <div class="section-header">
          <div>
            <h2 class="section-title"><i class="fas fa-bolt"></i> Challengelar</h2>
            <p class="section-subtitle">Bellashing! Bilimingizni sinab koâ€˜ring!</p>
          </div>
        </div>
        <div class="challenge-grid" id="challengeGrid">
          <div class="loading-text">Challengelar yuklanmoqda...</div>
        </div>
      </section>

      <section class="content-section">
        <div class="section-header">
          <div>
            <h2 class="section-title"><i class="fas fa-layer-group"></i> Kontent</h2>
            <p class="section-subtitle">Boâ€˜lim â†’ tag â†’ qidiruv</p>
          </div>
        </div>

        <!-- BIG CHIPS -->
        <div class="content-filters" id="contentFilters"></div>

        <!-- ITEMS -->
        <div class="content-grid" id="contentGrid">
          <div class="loading-text">Kontentlar yuklanmoqda...</div>
        </div>
      </section>
    </main>

    <footer class="footer">
      <div class="footer-content">
        <div class="footer-info">
          <h3>LeaderMath.UZ</h3>
          <p>Matematikadan super interaktiv platforma!</p>
        </div>
        <div class="footer-links">
          <a href="index.html" class="footer-link"><i class="fas fa-home"></i><span>Bosh sahifa</span></a>
          <button class="footer-link" id="btnInstall"><i class="fas fa-download"></i><span>Oâ€˜rnatish</span></button>
        </div>
      </div>
    </footer>
  </div>

  <div class="comments-dock">
    <button class="comments-btn" id="btnComments">
      <i class="fas fa-comments"></i>
      <span class="comments-badge" id="commentsBadge" style="display:none;">3</span>
    </button>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // DOM
    const toastElement = document.getElementById('toast');
    const medalImage = document.getElementById('medalImage');
    const levelText = document.getElementById('levelText');
    const levelRange = document.getElementById('levelRange');
    const levelProgress = document.getElementById('levelProgress');
    const currentPoints = document.getElementById('currentPoints');
    const levelPercentage = document.getElementById('levelPercentage');
    const nextLevelHint = document.getElementById('nextLevelHint');
    const userName = document.getElementById('userName');
    const userPoints = document.getElementById('userPoints');
    const userBalance = document.getElementById('userBalance');
    const userAge = document.getElementById('userAge');
    const userAvatar = document.getElementById('userAvatar');
    const challengeGrid = document.getElementById('challengeGrid');
    const contentFilters = document.getElementById('contentFilters');
    const contentGrid = document.getElementById('contentGrid');
    const heroVideo = document.getElementById('heroVideo');
    const btnPlayPause = document.getElementById('btnPlayPause');
    const btnMute = document.getElementById('btnMute');
    const btnRating = document.getElementById('btnRating');
    const btnNotifications = document.getElementById('btnNotifications');
    const btnLogout = document.getElementById('btnLogout');
    const btnComments = document.getElementById('btnComments');
    const commentsBadge = document.getElementById('commentsBadge');
    const btnInstall = document.getElementById('btnInstall');

    const FALLBACK_ICON = 'logo.png';

    function showToast(message) {
      toastElement.textContent = message;
      toastElement.className = 'toast show';
      setTimeout(() => toastElement.classList.remove('show'), 3000);
    }

    function safeNum(x){ const n = Number(x); return Number.isFinite(n) ? n : 0; }

    async function fetchJSON(url){
      const res = await fetch(url, { cache: 'no-store' });
      if(!res.ok) throw new Error('Fetch failed: ' + url);
      return await res.json();
    }

    function formatTimeRemaining(endTime) {
      const now = Date.now();
      const diff = endTime - now;
      if (diff <= 0) return "Tugadi";
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      if (days > 0) return `${days} kun ${hours} soat`;
      if (hours > 0) return `${hours} soat ${minutes} daqiqa`;
      return `${minutes} daqiqa`;
    }

    // ---- USER (demo) ----
    function loadUserData() {
      const userData = {
        name: "Foydalanuvchi",
        points: 0,
        balance: 0,
        age: "â€”",
        level: 1,
        currentPoints: 25,
        nextLevelPoints: 100,
        totalLevelPoints: 100
      };

      userName.textContent = userData.name;
      userPoints.textContent = userData.points;
      userBalance.textContent = userData.balance;
      userAge.textContent = userData.age;

      const progress = (userData.currentPoints / userData.totalLevelPoints) * 100;
      levelText.textContent = `Daraja: ${userData.level}`;
      levelRange.textContent = `${userData.currentPoints} â†’ ${userData.nextLevelPoints} ball`;
      levelProgress.style.width = `${progress}%`;
      currentPoints.textContent = `${userData.currentPoints} ball`;
      levelPercentage.textContent = `${Math.round(progress)}%`;
      nextLevelHint.textContent = `Keyingi: ${userData.nextLevelPoints - userData.currentPoints} ball`;

      medalImage.src = `medals/${userData.level}.webp`;
      medalImage.onerror = () => medalImage.src = FALLBACK_ICON;
      userAvatar.src = `medals/${userData.level}.webp`;
      userAvatar.onerror = () => userAvatar.src = FALLBACK_ICON;
    }

    // ---- CHALLENGES (JSON) ----
    function deriveChallengeStatus(ch){
      // status priority:
      // 1) explicit ch.status: "live|upcoming|ended"
      // 2) by dates: startAt/endAt (ms or ISO)
      const now = Date.now();
      const toMs = (v) => {
        if(!v) return null;
        if(typeof v === 'number') return v;
        const t = Date.parse(v);
        return Number.isFinite(t) ? t : null;
      };
      const start = toMs(ch.startAt);
      const end = toMs(ch.endAt);

      if (ch.status) return ch.status;

      if (start && now < start) return 'upcoming';
      if (end && now > end) return 'ended';
      if ((start && now >= start) || (end && now <= end)) return 'live';
      return 'live';
    }

    function renderChallenges(challenges){
      if(!Array.isArray(challenges) || challenges.length===0){
        challengeGrid.innerHTML = `<div class="loading-text">Hozircha challenge yoâ€˜q.</div>`;
        return;
      }

      challengeGrid.innerHTML = challenges.map(ch => {
        const status = deriveChallengeStatus(ch);
        let statusClass = 'status-live', statusText='LIVE', timerText='';
        let disabled = '';

        const now = Date.now();
        const toMs = (v) => typeof v === 'number' ? v : (v ? Date.parse(v) : NaN);

        if (status === 'live') {
          statusClass='status-live'; statusText='LIVE';
          const endMs = toMs(ch.endAt);
          timerText = Number.isFinite(endMs) ? `Tugashiga: ${formatTimeRemaining(endMs)}` : (ch.timerText || '');
        } else if (status === 'upcoming') {
          statusClass='status-upcoming'; statusText='TEZ KUNDA';
          const startMs = toMs(ch.startAt);
          timerText = Number.isFinite(startMs) ? `Boshlanishiga: ${formatTimeRemaining(startMs)}` : (ch.timerText || '');
          disabled = 'disabled style="opacity:.6"';
        } else {
          statusClass='status-ended'; statusText='TUGADI';
          timerText = 'Yakunlandi';
          disabled = 'disabled style="opacity:.6"';
        }

        const icon = ch.icon || `icons/challenges/${ch.id}.png`;

        return `
          <div class="challenge-card">
            <div class="challenge-header">
              <div class="challenge-icon">
                <img src="${icon}" alt="" onerror="this.src='${FALLBACK_ICON}'">
              </div>
              <div class="challenge-info">
                <h3>${(ch.title||'Challenge').toString()}</h3>
                <p>${(ch.desc||ch.description||'').toString()}</p>
                <span class="challenge-status ${statusClass}">${statusText}</span>
              </div>
            </div>
            <div class="challenge-timer">${timerText || ''}</div>
            <button class="challenge-action" data-href="${ch.href || ''}" ${disabled}>
              ${status === 'live' ? 'Boshlash â†’' : status === 'upcoming' ? 'Kutib turing' : 'Yakunlandi'}
            </button>
          </div>
        `;
      }).join('');
    }

    async function loadChallenges(){
      try{
        // sizning namingizga mos: challenge.json
        const data = await fetchJSON('challenge.json');
        // data: [] yoki { challenges: [] }
        const list = Array.isArray(data) ? data : (data.challenges || data.items || []);
        renderChallenges(list);
      }catch(e){
        // fallback: bo'sh qoldirmaymiz
        console.warn(e);
        challengeGrid.innerHTML = `<div class="loading-text">challenge.json topilmadi (yoki xato). JSON qoâ€˜ysangiz avtomatik chiqadi.</div>`;
      }
    }

    // ---- CONTENT (JSON BIGCHIPS + ITEMS) ----
    function countByType(items){
      const m = {};
      for(const it of (items||[])){
        const t = (it.type || 'all');
        m[t] = (m[t]||0) + 1;
      }
      m.all = (items||[]).length;
      return m;
    }

    function renderBigChips(bigChips, counts, activeId){
      contentFilters.innerHTML = (bigChips||[]).map(ch => {
        const id = ch.id || 'all';
        const title = ch.title || 'Boâ€˜lim';
        const icon = ch.icon || `icons/sections/${id}.png`;
        const c = safeNum(counts[id]);
        const active = id === activeId ? 'active' : '';
        return `
          <button class="filter-chip ${active}" data-filter="${id}">
            <span class="chip-ic"><img src="${icon}" alt="" onerror="this.src='${FALLBACK_ICON}'"></span>
            <span class="chip-meta">
              <span class="chip-title">${title}</span>
              <span class="chip-sub">${c} ta</span>
            </span>
            <span class="chip-count">${c}</span>
          </button>
        `;
      }).join('');
    }

    function renderContentItems(items){
      if(!Array.isArray(items) || items.length===0){
        contentGrid.innerHTML = `<div class="loading-text">Hech narsa topilmadi.</div>`;
        return;
      }

      contentGrid.innerHTML = items.map(item => {
        const icon = item.icon || `icons/content/${item.id}.png`;
        const title = item.title || 'Kontent';
        const desc = item.desc || item.description || '';
        const tags = Array.isArray(item.tags) ? item.tags : [];
        const href = item.href || '#';

        return `
          <div class="content-card">
            <div class="content-icon">
              <img src="${icon}" alt="" onerror="this.src='${FALLBACK_ICON}'">
            </div>
            <h4>${title}</h4>
            <p>${desc}</p>
            <div class="content-tags">
              ${tags.map(t => `<span class="content-tag">${t}</span>`).join('')}
            </div>
            <button class="content-action" data-href="${href}">
              <i class="fas fa-external-link-alt"></i>
              <span>Ochish</span>
            </button>
          </div>
        `;
      }).join('');
    }

    async function loadContent(){
      try{
        const data = await fetchJSON('content.json'); // sizning config faylingiz
        const bigChips = Array.isArray(data.bigChips) ? data.bigChips : [];
        const items = Array.isArray(data.items) ? data.items : [];

        // Hammasi chipi bo'lmasa â€” avtomatik qo'shamiz
        const hasAll = bigChips.some(x => (x.id||'') === 'all');
        const finalBigChips = hasAll ? bigChips : [{ id:'all', title:'Hammasi', icon:'icons/sections/all.png' }, ...bigChips];

        const counts = countByType(items);

        let active = 'all';
        renderBigChips(finalBigChips, counts, active);

        const applyFilter = (fid) => {
          active = fid;
          renderBigChips(finalBigChips, counts, active);

          const filtered = (fid === 'all') ? items : items.filter(it => it.type === fid);
          renderContentItems(filtered);
        };

        applyFilter('all');

        // click handlers
        contentFilters.querySelectorAll('.filter-chip').forEach(btn => {
          btn.addEventListener('click', () => applyFilter(btn.dataset.filter || 'all'));
        });

        // open handlers
        contentGrid.addEventListener('click', (e) => {
          const btn = e.target.closest('.content-action');
          if(!btn) return;
          const href = btn.dataset.href;
          if(href && href !== '#') window.location.href = href;
          else showToast("Havola yoâ€˜q (href boâ€˜sh).");
        });

      }catch(e){
        console.warn(e);
        contentFilters.innerHTML = '';
        contentGrid.innerHTML = `<div class="loading-text">content.json topilmadi (yoki xato). JSON qoâ€˜ysangiz avtomatik chiqadi.</div>`;
      }
    }

    // Video controls
    function setupVideoControls() {
      let isPlaying = true;
      let isMuted = true;

      btnPlayPause.addEventListener('click', function() {
        if (isPlaying) {
          heroVideo.pause();
          this.innerHTML = '<i class="fas fa-play"></i>';
        } else {
          heroVideo.play();
          this.innerHTML = '<i class="fas fa-pause"></i>';
        }
        isPlaying = !isPlaying;
      });

      btnMute.addEventListener('click', function() {
        heroVideo.muted = !heroVideo.muted;
        isMuted = heroVideo.muted;
        this.innerHTML = isMuted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
      });

      heroVideo.muted = true;
      heroVideo.play().catch(() => {});
    }

    // Buttons
    function setupEventHandlers() {
      btnRating.addEventListener('click', () => showToast("Reyting jadvali ochilmoqda..."));
      btnNotifications.addEventListener('click', () => showToast("Bildirishnomalar ochilmoqda..."));

      btnLogout.addEventListener('click', function() {
        if (confirm("Rostdan tizimdan chiqmoqchimisiz?")) {
          localStorage.removeItem('lm_token');
          showToast("Chiqildi. Yangi sahifaga yo'naltirilmoqda...");
          setTimeout(() => { window.location.href = 'index.html'; }, 900);
        }
      });

      btnComments.addEventListener('click', function() {
        showToast("Izohlar paneli ochilmoqda...");
        commentsBadge.style.display = 'none';
      });

      btnInstall.addEventListener('click', () => showToast("Ilova oâ€˜rnatish boshlanmoqda..."));

      setTimeout(() => {
        commentsBadge.textContent = '3';
        commentsBadge.style.display = 'flex';
      }, 1600);
    }

    // Challenge start click
    challengeGrid.addEventListener('click', function(e) {
      const btn = e.target.closest('.challenge-action');
      if(!btn) return;
      if(btn.disabled) return;

      const href = btn.dataset.href || '';
      if(href) window.location.href = href;
      else showToast("Challenge havolasi yoâ€˜q (href boâ€˜sh).");
    });

    document.addEventListener('DOMContentLoaded', async function() {
      loadUserData();
      await loadChallenges();
      await loadContent();
      setupVideoControls();
      setupEventHandlers();
      showToast("LeaderMath.UZ ga xush kelibsiz! ðŸŽ‰");
    });
  </script>
</body>
</html>
