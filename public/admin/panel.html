<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OrzuMall ‚Äî Admin Panel</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --panel2:#111c33;
      --text:#e5e7eb; --muted:#94a3b8; --border:rgba(255,255,255,.10);
      --green:#2E8B57; --gold:#D4AF37; --danger:#ff4d6d; --warn:#f6c177;
      --chip:#0b1830;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1100px 700px at 20% -10%, rgba(46,139,87,.18), transparent 60%),var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    a{color:inherit}
    .wrap{max-width:1180px;margin:0 auto;padding:16px}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;border:1px solid var(--border);background:rgba(15,23,42,.72);border-radius:18px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:34px;height:34px;border-radius:12px;background:rgba(46,139,87,.20);display:grid;place-items:center;border:1px solid rgba(46,139,87,.35)}
    .brand h1{font-size:14px;margin:0;letter-spacing:.2px}
    .brand .sub{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:10px;align-items:center}
    .btn{border:1px solid var(--border);background:rgba(255,255,255,.04);color:var(--text);padding:10px 12px;border-radius:14px;cursor:pointer;font-weight:700}
    .btn:hover{background:rgba(255,255,255,.07)}
    .btn.primary{border-color:rgba(46,139,87,.5);background:rgba(46,139,87,.18)}
    .btn.primary:hover{background:rgba(46,139,87,.26)}
    .btn.danger{border-color:rgba(255,77,109,.5);background:rgba(255,77,109,.12)}
    .btn.danger:hover{background:rgba(255,77,109,.18)}
    .grid{display:grid;grid-template-columns:280px 1fr;gap:14px;margin-top:14px}
    .side,.main{border:1px solid var(--border);background:rgba(15,23,42,.68);border-radius:18px;overflow:hidden;box-shadow:0 18px 50px rgba(0,0,0,.25)}
    .side{padding:12px}
    .navbtn{width:100%;text-align:left;padding:10px 12px;border-radius:14px;border:1px solid transparent;background:transparent;color:var(--text);cursor:pointer;font-weight:700;display:flex;gap:10px;align-items:center}
    .navbtn:hover{background:rgba(255,255,255,.05)}
    .navbtn.active{border-color:rgba(46,139,87,.45);background:rgba(46,139,87,.12)}
    .main{padding:14px}
    .title{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    .title h2{margin:0;font-size:15px}
    .title p{margin:0;color:var(--muted);font-size:12px}
    .card{border:1px solid var(--border);background:rgba(17,28,51,.35);border-radius:16px;padding:12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .field label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .field input,.field select, .field textarea{
      width:100%;padding:10px 12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);color:var(--text);outline:none
    }
    .field textarea{min-height:96px;resize:vertical}
    .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.5}
    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table th{font-size:12px;color:var(--muted);text-align:left;padding:0 10px}
    .tr{background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.10)}
    .table td{padding:10px}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);font-size:12px}
    .pill.ok{border-color:rgba(46,139,87,.5);background:rgba(46,139,87,.12)}
    .pill.warn{border-color:rgba(246,193,119,.5);background:rgba(246,193,119,.12)}
    .pill.bad{border-color:rgba(255,77,109,.5);background:rgba(255,77,109,.12)}
    .log{margin-top:10px;background:#000;color:#0f0;padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.10);max-height:220px;overflow:auto;font-size:12px}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.62);display:none;place-items:center;padding:16px}
    .modal{width:min(520px,96vw);border:1px solid var(--border);background:rgba(15,23,42,.92);border-radius:18px;box-shadow:0 30px 90px rgba(0,0,0,.65);padding:16px}
    .modal h3{margin:0 0 8px 0;font-size:15px}
    .modal p{margin:0;color:var(--muted);font-size:12px;line-height:1.5}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} .side{order:2} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"><i class="fa-solid fa-shield-halved"></i></div>
        <div>
          <h1>OrzuMall Admin</h1>
          <div class="sub" id="subline">Kirish tekshirilmoqda...</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" id="btnReload"><i class="fa-solid fa-rotate"></i> Reload</button>
        <button class="btn danger" id="btnLogout"><i class="fa-solid fa-right-from-bracket"></i> Chiqish</button>
      </div>
    </div>

    <div class="grid">
      <div class="side">
        <button class="navbtn active" data-tab="dash"><i class="fa-solid fa-gauge"></i> Dashboard</button>
        <button class="navbtn" data-tab="orders"><i class="fa-solid fa-bag-shopping"></i> Buyurtmalar</button>
        <button class="navbtn" data-tab="tx"><i class="fa-solid fa-receipt"></i> Payme cheklar</button>
        <button class="navbtn" data-tab="import"><i class="fa-solid fa-file-import"></i> JSON import</button>
        <div class="hint" style="margin-top:10px">
          <b>Eslatma:</b> Bu panel faqat admin gmail uchun. Agar <span style="color:var(--gold)">permissions</span> xatosi chiqsa ‚Äî Firestore rules admin emailga yozishga ruxsat bermayapti.
        </div>
      </div>

      <div class="main">
        <div id="tab-dash">
          <div class="title">
            <div>
              <h2>Dashboard</h2>
              <p>Tezkor ko‚Äòrsatkichlar va tizim holati.</p>
            </div>
          </div>
          <div class="row3">
            <div class="card">
              <div class="hint">Admin</div>
              <div style="font-size:18px;font-weight:900;margin-top:6px" id="meEmail">‚Äî</div>
            </div>
            <div class="card">
              <div class="hint">So‚Äònggi buyurtmalar</div>
              <div style="font-size:18px;font-weight:900;margin-top:6px" id="kpiOrders">‚Äî</div>
            </div>
            <div class="card">
              <div class="hint">So‚Äònggi Payme cheklar</div>
              <div style="font-size:18px;font-weight:900;margin-top:6px" id="kpiTx">‚Äî</div>
            </div>
          </div>
          <div class="card" style="margin-top:12px">
            <div class="hint"><b>Tez test:</b> Firestore ulanish</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
              <button class="btn primary" id="btnPing"><i class="fa-solid fa-wifi"></i> Ping</button>
              <span class="pill" id="pingPill"><i class="fa-solid fa-circle-question"></i> kutilyapti</span>
            </div>
            <div class="hint" id="pingHint" style="margin-top:10px"></div>
          </div>
        </div>

        <div id="tab-orders" style="display:none">
          <div class="title">
            <div>
              <h2>Buyurtmalar</h2>
              <p>So‚Äònggi buyurtmalar ro‚Äòyxati (50 ta).</p>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button class="btn primary" id="btnLoadOrders"><i class="fa-solid fa-download"></i> Yuklash</button>
            </div>
          </div>
          <div class="card">
            <table class="table" id="ordersTable">
              <thead><tr>
                <th>ID</th><th>User</th><th>Summa</th><th>To‚Äòlov</th><th>Yetkazish</th><th>Status</th><th></th>
              </tr></thead>
              <tbody></tbody>
            </table>
            <div class="hint" id="ordersHint"></div>
          </div>
        </div>

        <div id="tab-tx" style="display:none">
          <div class="title">
            <div>
              <h2>Payme cheklar</h2>
              <p>payme_transactions collection (50 ta).</p>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <select id="txFilter" class="btn">
                <option value="all">Barchasi</option>
                <option value="performed">performed</option>
                <option value="created">created</option>
                <option value="canceled">canceled</option>
                <option value="rejected">rejected</option>
              </select>
              <button class="btn primary" id="btnLoadTx"><i class="fa-solid fa-download"></i> Yuklash</button>
            </div>
          </div>
          <div class="card">
            <table class="table" id="txTable">
              <thead><tr>
                <th>TransID</th><th>User ID</th><th>Summa</th><th>Status</th><th>Vaqt</th>
              </tr></thead>
              <tbody></tbody>
            </table>
            <div class="hint" id="txHint"></div>
          </div>
        </div>

        <div id="tab-import" style="display:none">
          <div class="title">
            <div>
              <h2>JSON import</h2>
              <p>payme_transactions.json faylni Firestore‚Äôga yuklash.</p>
            </div>
          </div>

          <div class="card">
            <div class="row">
              <div class="field">
                <label>Collection</label>
                <input id="importCol" value="payme_transactions" />
              </div>
              <div class="field">
                <label>Mode</label>
                <select id="importMode">
                  <option value="merge">merge (tavsiya)</option>
                  <option value="overwrite">overwrite</option>
                </select>
              </div>
            </div>

            <div class="field" style="margin-top:10px">
              <label>JSON fayl</label>
              <input type="file" id="importFile" accept=".json" />
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
              <button class="btn primary" id="btnImport"><i class="fa-solid fa-cloud-arrow-up"></i> Yuklash</button>
              <span class="pill" id="importPill"><i class="fa-solid fa-circle-question"></i> kutilyapti</span>
            </div>

            <div class="hint" style="margin-top:10px">
              <b>Eslatma:</b> Firestore batch limiti 500. Import avtomatik bo‚Äòlib 450 tadan bo‚Äòlib yuboradi.
              Agar ‚Äúinsufficient permissions‚Äù chiqsa ‚Äî rules‚Äôda admin write ruxsati yo‚Äòq.
            </div>

            <div class="log" id="importLog"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h3>Admin kirish</h3>
      <p>Panelga kirish uchun admin gmail kerak: <b>sohibjonmath@gmail.com</b></p>
      <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap">
        <button class="btn primary" id="btnLogin"><i class="fa-brands fa-google"></i> Google bilan kirish</button>
        <button class="btn" id="btnGoLogin"><i class="fa-solid fa-arrow-right-to-bracket"></i> login.html</button>
      </div>
      <div class="hint" id="loginErr" style="margin-top:10px;color:#fca5a5"></div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, collection, doc, getDoc, getDocs, query, orderBy, limit, writeBatch, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    getAuth, GoogleAuthProvider, onAuthStateChanged, signInWithPopup, setPersistence, browserLocalPersistence, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const ADMIN_EMAILS = ["sohibjonmath@gmail.com"];
  const FIREBASE_CONFIG = {
  "apiKey": "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  "authDomain": "xplusy-760fa.firebaseapp.com",
  "databaseURL": "https://xplusy-760fa-default-rtdb.firebaseio.com",
  "projectId": "xplusy-760fa",
  "storageBucket": "xplusy-760fa.firebasestorage.app",
  "messagingSenderId": "992512966017",
  "appId": "1:992512966017:web:5e919dbc9b8d8abcb43c80",
  "measurementId": "G-459PLJ7P7L"
};

  const app = initializeApp(FIREBASE_CONFIG);
  const db = getFirestore(app);
  const auth = getAuth(app);
  setPersistence(auth, browserLocalPersistence).catch(()=>{});
  const provider = new GoogleAuthProvider();
  provider.setCustomParameters({ prompt: "select_account" });

  const $ = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));

  const overlay = $("#overlay");
  const loginErr = $("#loginErr");
  const subline = $("#subline");
  const meEmail = $("#meEmail");

  const isAdminEmail = (email)=> !!email && ADMIN_EMAILS.includes(String(email).toLowerCase().trim());

  function showTab(name){
    $$("[data-tab]").forEach(b=>b.classList.toggle("active", b.dataset.tab===name));
    ["dash","orders","tx","import"].forEach(t=>{
      const el = document.getElementById("tab-"+t);
      if(el) el.style.display = (t===name) ? "" : "none";
    });
  }
  $$("[data-tab]").forEach(b=>b.addEventListener("click", ()=>showTab(b.dataset.tab)));

  $("#btnReload").addEventListener("click", ()=>location.reload());
  $("#btnGoLogin").addEventListener("click", ()=>location.href="./login.html");
  $("#btnLogout").addEventListener("click", async ()=>{
    try{ await signOut(auth);}catch(e){}
    location.replace("./login.html");
  });

  async function requireAdmin(){
    return new Promise((resolve)=>{
      onAuthStateChanged(auth, async (user)=>{
        if(!user){
          overlay.style.display="grid";
          subline.textContent="Kirish kerak";
          meEmail.textContent="‚Äî";
          resolve(null);
          return;
        }
        if(!isAdminEmail(user.email)){
          subline.textContent="Ruxsat yo‚Äòq";
          meEmail.textContent=user.email || "unknown";
          overlay.style.display="grid";
          loginErr.textContent="Bu akkaunt admin emas. Admin gmail bilan kiring.";
          try{ await signOut(auth);}catch(e){}
          resolve(null);
          return;
        }
        overlay.style.display="none";
        loginErr.textContent="";
        subline.textContent="Admin: " + user.email;
        meEmail.textContent=user.email;
        resolve(user);
      });
    });
  }

  $("#btnLogin").addEventListener("click", async ()=>{
    loginErr.textContent="";
    try{
      await setPersistence(auth, browserLocalPersistence);
      const res = await signInWithPopup(auth, provider);
      if(!isAdminEmail(res?.user?.email)){
        loginErr.textContent="Ruxsat yo‚Äòq. Admin gmail bilan kiring.";
        try{ await signOut(auth);}catch(e){}
      }
    }catch(e){
      console.error(e);
      loginErr.textContent = "Kirishda xatolik: " + (e?.message||e);
    }
  });

  const pingPill=$("#pingPill");
  const pingHint=$("#pingHint");
  $("#btnPing").addEventListener("click", async ()=>{
    pingPill.className="pill";
    pingPill.innerHTML='<i class="fa-solid fa-circle-notch fa-spin"></i> tekshiryapti';
    pingHint.textContent="";
    try{
      const snap = await getDoc(doc(db, "configs", "home"));
      pingPill.className="pill ok";
      pingPill.innerHTML='<i class="fa-solid fa-circle-check"></i> OK';
      pingHint.textContent = "Firestore o‚Äòqish OK. (configs/home mavjud: " + (snap.exists() ? "ha" : "yo‚Äòq") + ")";
    }catch(e){
      console.error(e);
      pingPill.className="pill bad";
      pingPill.innerHTML='<i class="fa-solid fa-triangle-exclamation"></i> xato';
      pingHint.textContent = "Firestore xatosi: " + (e?.message||e);
    }
  });

  const ordersTableBody = $("#ordersTable tbody");
  const ordersHint = $("#ordersHint");
  $("#btnLoadOrders").addEventListener("click", loadOrders);

  function moneyUZSFromAny(o){
    const t = o?.totalUZS ?? o?.total ?? o?.amountUZS ?? o?.amount ?? 0;
    return Number(t)||0;
  }
  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

  async function loadOrders(){
    ordersHint.textContent="Yuklanyapti...";
    ordersTableBody.innerHTML="";
    try{
      const qy = query(collection(db,"orders"), orderBy("createdAt","desc"), limit(50));
      const snap = await getDocs(qy);
      let n=0;
      snap.forEach(docu=>{
        n++;
        const d = docu.data() || {};
        const id = docu.id;
        const user = d?.numericId ?? d?.userNumericId ?? d?.uid ?? "‚Äî";
        const sum = moneyUZSFromAny(d);
        const pay = d?.paymentMethod ?? d?.payment ?? "‚Äî";
        const del = d?.deliveryType ?? d?.delivery ?? "‚Äî";
        const st = d?.status ?? "‚Äî";
        const pillClass = st==="paid"||st==="delivered" ? "ok" : (st==="canceled" ? "bad" : "warn");
        const tr = document.createElement("tr");
        tr.className="tr";
        tr.innerHTML = `
          <td><div class="pill">${esc(id)}</div></td>
          <td>${esc(user)}</td>
          <td><b>${esc(sum)}</b> so‚Äòm</td>
          <td>${esc(pay)}</td>
          <td>${esc(del)}</td>
          <td><span class="pill ${pillClass}">${esc(st)}</span></td>
          <td style="text-align:right">
            <button class="btn" data-act="paid" data-id="${esc(id)}">paid</button>
            <button class="btn danger" data-act="canceled" data-id="${esc(id)}">cancel</button>
          </td>`;
        ordersTableBody.appendChild(tr);
      });
      ordersHint.textContent = "Yuklandi: " + n + " ta";
      $("#kpiOrders").textContent = String(n);
    }catch(e){
      console.error(e);
      ordersHint.textContent = "Xato: " + (e?.message||e);
    }
  }

  ordersTableBody.addEventListener("click", async (e)=>{
    const btn = e.target.closest("button[data-id]");
    if(!btn) return;
    const id = btn.dataset.id;
    const act = btn.dataset.act;
    try{
      await updateDoc(doc(db,"orders",id), { status: act, updatedAt: new Date().toISOString() });
      await loadOrders();
    }catch(err){
      alert("Update xato: " + (err?.message||err));
    }
  });

  const txTableBody = $("#txTable tbody");
  const txHint = $("#txHint");
  $("#btnLoadTx").addEventListener("click", loadTx);

  function fmtTime(x){
    if(!x) return "‚Äî";
    const d = (typeof x==="number") ? new Date(x) : new Date(String(x));
    if(isNaN(d.getTime())) return "‚Äî";
    return d.toLocaleString();
  }

  async function loadTx(){
    txHint.textContent="Yuklanyapti...";
    txTableBody.innerHTML="";
    const filter = $("#txFilter").value;
    try{
      const qy = query(collection(db,"payme_transactions"), orderBy("updatedAt","desc"), limit(50));
      const snap = await getDocs(qy);
      let n=0, shown=0;
      snap.forEach(docu=>{
        n++;
        const d = docu.data() || {};
        const st = d?.status ?? "‚Äî";
        if(filter!=="all" && st!==filter) return;
        shown++;
        const transId = d?.payme?.transId ?? docu.id;
        const uid = d?.numericId ?? d?.account?.user_id ?? "‚Äî";
        const amountT = Number(d?.amountTiyin || 0);
        const amountS = Math.round(amountT/100);
        const pillClass = st==="performed" ? "ok" : (st==="rejected" ? "bad" : "warn");
        const tr = document.createElement("tr");
        tr.className="tr";
        tr.innerHTML = `
          <td><div class="pill">${esc(transId)}</div></td>
          <td>${esc(uid)}</td>
          <td><b>${esc(amountS)}</b> so‚Äòm</td>
          <td><span class="pill ${pillClass}">${esc(st)}</span></td>
          <td>${esc(fmtTime(d?.payme?.performTimeMs || d?.payme?.createTimeMs || d?.updatedAt))}</td>`;
        txTableBody.appendChild(tr);
      });
      txHint.textContent = "Ko‚Äòrsatildi: " + shown + " / " + n;
      $("#kpiTx").textContent = String(shown);
    }catch(e){
      console.error(e);
      txHint.textContent = "Xato: " + (e?.message||e);
    }
  }

  const importLog=$("#importLog");
  const importPill=$("#importPill");
  function log(msg){
    importLog.innerHTML += msg.replaceAll("<","&lt;").replaceAll(">","&gt;") + "<br>";
    importLog.scrollTop = importLog.scrollHeight;
  }
  function setImportState(kind, text){
    importPill.className = "pill " + (kind==="ok"?"ok":(kind==="bad"?"bad":"warn"));
    importPill.innerHTML = (kind==="ok"
      ? '<i class="fa-solid fa-circle-check"></i> '
      : kind==="bad"
        ? '<i class="fa-solid fa-triangle-exclamation"></i> '
        : '<i class="fa-solid fa-circle-notch fa-spin"></i> ') + text;
  }

  $("#btnImport").addEventListener("click", async ()=>{
    importLog.innerHTML="";
    const file = $("#importFile").files?.[0];
    const colName = $("#importCol").value.trim() || "payme_transactions";
    const mode = $("#importMode").value;
    if(!file){ alert("JSON fayl tanlang"); return; }

    setImportState("run","o‚Äòqilyapti");
    try{
      const text = await file.text();
      const data = JSON.parse(text);
      const keys = Object.keys(data || {});
      if(!keys.length) throw new Error("JSON bo‚Äòsh");
      log("Topildi: " + keys.length + " ta hujjat. Collection: " + colName);

      const chunkSize = 450;
      let done = 0;
      for(let i=0;i<keys.length;i+=chunkSize){
        const batch = writeBatch(db);
        const slice = keys.slice(i,i+chunkSize);
        slice.forEach(id=>{
          const ref = doc(db, colName, id);
          batch.set(ref, data[id], { merge: mode==="merge" });
        });
        setImportState("run", "batch " + (Math.floor(i/chunkSize)+1));
        await batch.commit();
        done += slice.length;
        log("‚úÖ Batch commit: " + slice.length + " (jami: " + done + ")");
      }
      setImportState("ok", "yakunlandi ("+done+")");
      log("<b>Yakunlandi.</b>");
    }catch(e){
      console.error(e);
      setImportState("bad","xato");
      log("‚ùå Xato: " + (e?.message||e));
      if(String(e?.message||"").toLowerCase().includes("permission")){
        log("üëâ Firestore rules‚Äôda admin write ruxsati yo‚Äòq. (isAdmin/email tekshiruvi kerak)");
      }
    }
  });

  const user = await requireAdmin();
  if(user){
    try{ await loadOrders(); }catch(e){}
    try{ await loadTx(); }catch(e){}
  }
</script>
</body>
</html>
