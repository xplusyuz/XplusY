<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#0ea5e9"/>
<link rel="icon" sizes="192x192" href="logo.png"/>
<link rel="apple-touch-icon" href="logo.png"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
<link rel="stylesheet" href="assets/css/style.css"/>
<link rel="stylesheet" href="assets/css/ui.css"/>
<link rel="stylesheet" href="assets/css/app.css"/>
<link rel="stylesheet" href="assets/css/bridge.css"/>
<title>LeaderMath.UZ ‚Äî App</title>
<style>
  /* --- Content (big chip + tag + search) --- */
  .ctRow{
    display:flex; gap:10px;
    overflow-x:auto; overflow-y:hidden;
    padding-bottom:4px;
    -webkit-overflow-scrolling:touch;
    overscroll-behavior-x:contain;
    scrollbar-width:none;
    user-select:none;
    cursor:grab;
    scroll-snap-type:x proximity;
  }
  .ctRow::-webkit-scrollbar{display:none}
  .ctRow:active{cursor:grabbing}
  .ctRow > *{scroll-snap-align:start}

  .ctChip{
    flex:0 0 auto;
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 12px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.10);
    color: rgba(255,255,255,.92);
    cursor:pointer;
    white-space:nowrap;
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
  }
  .ctChip:active{transform:scale(.98)}
  .ctChip.active{
    background: rgba(46,139,87,.22);
    border-color: rgba(46,139,87,.35);
  }
  .ctChip.small{padding:8px 10px; font-size: 12px; opacity:.95}
  .ctChip.small.active{
    background: rgba(14,165,233,.18);
    border-color: rgba(14,165,233,.35);
  }
  .ctDot{width:8px;height:8px;border-radius:50%; background: rgba(46,139,87,.9); display:inline-block}
  .ctCount{
    margin-left:2px;
    padding:2px 8px;
    border-radius:999px;
    background: rgba(2,6,23,.35);
    color: rgba(255,255,255,.92);
    font-size:12px;
  }
  .ctSearchRow{
    position:relative;
    display:flex; align-items:center; gap:10px;
    background: rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.16);
    border-radius: 16px;
    padding: 10px 12px;
  }
  .ctSearchRow i{opacity:.85}
  .ctSearchRow input{
    width:100%;
    border:none;
    outline:none;
    background:transparent;
    color: rgba(255,255,255,.95);
  }
  .ctSearchRow input::placeholder{color: rgba(255,255,255,.65)}
  .ctEmpty{display:none; padding:12px 2px; opacity:.9}
</style>
<style>
/* ===== Discovery Home (Banner osti) ===== */
#contentSection.discover{
  margin: 22px auto 0;
  padding: 18px 18px 20px;
  border-radius: 24px;
  border: 1px solid rgba(20,40,60,.10);
  background: rgba(255,255,255,.72);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  box-shadow: 0 18px 50px rgba(15,23,42,.10);
}

#contentSection .discoverTop{
  display:flex; gap:14px; align-items:flex-end; justify-content:space-between;
  margin-bottom: 14px;
}
#contentSection .discoverTitle h2{
  margin:0; font-size:18px; letter-spacing:.2px;
}
#contentSection .discoverTitle p{
  margin:6px 0 0; font-size:12.5px; opacity:.72;
}

#contentSection .discoverSearch{
  flex: 1;
  max-width: 560px;
  display:flex;
  align-items:center;
  gap:10px;
  padding: 10px 10px 10px 12px;
  border-radius: 18px;
  border: 1px solid rgba(20,40,60,.10);
  background: rgba(255,255,255,.88);
  box-shadow: 0 10px 24px rgba(15,23,42,.06);
}
#contentSection .discoverSearch .sIcon{opacity:.8}
#contentSection .discoverSearch input{
  border:none; outline:none;
  flex:1;
  font-size:14px;
  background: transparent;
  padding: 6px 4px;
}
#contentSection .discoverSearch .sClear{
  border:none;
  cursor:pointer;
  padding: 10px 14px;
  border-radius: 14px;
  background: rgba(46,139,87,.12);
  color: rgba(25,90,55,1);
  font-weight: 700;
  font-size: 12px;
}
#contentSection .discoverSearch .sClear:active{transform: scale(.98)}

#contentSection .bigRow,
#contentSection .tagRow{
  display:flex;
  gap:12px;
  overflow-x:auto; overflow-y:hidden;
  padding: 8px 2px 10px;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
  scroll-snap-type: x proximity;
  overscroll-behavior-x: contain;
}
#contentSection .bigRow::-webkit-scrollbar,
#contentSection .tagRow::-webkit-scrollbar{display:none}
#contentSection .bigRow{margin-top: 2px;}
#contentSection .tagRow{margin-top: -2px;}

.bigChip{
  flex: 0 0 auto;
  min-width: 210px;
  padding: 14px 16px;
  border-radius: 22px;
  border: 1px solid rgba(20,40,60,.10);
  background: rgba(255,255,255,.85);
  box-shadow: 0 12px 30px rgba(15,23,42,.08);
  cursor:pointer;
  user-select:none;
  display:flex; align-items:center; gap:12px;
  scroll-snap-align: start;
  transition: transform .15s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;
}
.bigChip:active{transform: scale(.985)}
.bigChip .ic{
  width:44px;height:44px;border-radius:16px;
  display:grid;place-items:center;
  background: rgba(46,139,87,.10);
  border: 1px solid rgba(46,139,87,.16);
  font-size: 20px;
}
.bigChip .txt{display:flex;flex-direction:column;line-height:1.1}
.bigChip .txt b{font-size:14px}
.bigChip .txt small{margin-top:6px; font-size:12px; opacity:.72}
.bigChip .cnt{
  margin-left:auto;
  font-weight:800;
  font-size:12px;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(15,23,42,.06);
  color: rgba(15,23,42,.70);
}
.bigChip.active{
  background: linear-gradient(135deg, rgba(46,139,87,.95), rgba(59,183,143,.90));
  border-color: rgba(46,139,87,.20);
  color:#fff;
  box-shadow: 0 18px 42px rgba(46,139,87,.20);
}
.bigChip.active .ic{background: rgba(255,255,255,.18); border-color: rgba(255,255,255,.20)}
.bigChip.active .cnt{background: rgba(255,255,255,.18); color:#fff}
.bigChip.active .txt small{opacity:.90}

.tagChip{
  flex: 0 0 auto;
  padding: 9px 14px;
  border-radius: 999px;
  border: 1px solid rgba(20,40,60,.10);
  background: rgba(255,255,255,.72);
  cursor:pointer;
  user-select:none;
  font-size: 13px;
  display:inline-flex;
  align-items:center;
  gap:10px;
  scroll-snap-align: start;
}
.tagChip .tCnt{
  font-size: 12px;
  padding: 3px 9px;
  border-radius: 999px;
  background: rgba(15,23,42,.06);
  color: rgba(15,23,42,.70);
  font-weight:800;
}
.tagChip.active{
  background: rgba(59,130,246,.12);
  border-color: rgba(59,130,246,.22);
}
.tagChip.active .tCnt{
  background: rgba(59,130,246,.18);
}

#contentSection .resultBar{
  margin-top: 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  font-size: 12.5px;
  opacity:.75;
}

#contentSection .cardsGrid{
  margin-top: 12px;
  display:grid;
  grid-template-columns: repeat(12, 1fr);
  gap: 12px;
}

.cCard{
  grid-column: span 6;
  border-radius: 20px;
  border: 1px solid rgba(20,40,60,.10);
  background: rgba(255,255,255,.78);
  box-shadow: 0 14px 34px rgba(15,23,42,.08);
  padding: 14px 14px 12px;
  position:relative;
  overflow:hidden;
  transition: transform .16s ease, box-shadow .16s ease, border-color .16s ease;
}
.cCard:hover{
  transform: translateY(-3px);
  box-shadow: 0 22px 48px rgba(15,23,42,.10);
  border-color: rgba(46,139,87,.18);
}
.cTop{display:flex;gap:10px;align-items:flex-start;justify-content:space-between}
.cTitle{margin:0;font-size:14.5px;line-height:1.25}
.cDesc{margin:8px 0 0;font-size:12.5px;opacity:.72;line-height:1.45}
.cBadge{
  flex:0 0 auto;
  font-size:11px;
  padding: 5px 10px;
  border-radius: 999px;
  border: 1px solid rgba(46,139,87,.22);
  background: rgba(46,139,87,.12);
  color: rgba(25,90,55,1);
  font-weight:800;
}
.cBadge.soon{
  border-color: rgba(245,158,11,.26);
  background: rgba(245,158,11,.14);
  color: rgba(130,80,10,1);
}
.cTags{
  margin-top: 12px;
  display:flex; flex-wrap:wrap; gap:8px; align-items:center;
}
.cTag{
  font-size: 11.5px;
  padding: 5px 10px;
  border-radius: 999px;
  border: 1px dashed rgba(15,23,42,.16);
  background: rgba(255,255,255,.65);
  opacity:.9;
}
.cGo{
  margin-left:auto;
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(46,139,87,.22);
  background: rgba(46,139,87,.12);
  color: rgba(25,90,55,1);
  font-weight:900;
  font-size: 12px;
}
.cGo.disabled{
  pointer-events:none;
  opacity:.72;
  border-color: rgba(245,158,11,.26);
  background: rgba(245,158,11,.12);
  color: rgba(130,80,10,1);
}

#contentSection .emptyState{
  margin-top: 14px;
  border-radius: 20px;
  border: 1px dashed rgba(20,40,60,.18);
  background: rgba(255,255,255,.58);
  padding: 18px 14px;
  display:flex;
  gap:12px;
  align-items:center;
  justify-content:flex-start;
}
#contentSection .emptyIcon{
  width:46px;height:46px;border-radius:18px;
  display:grid;place-items:center;
  background: rgba(15,23,42,.06);
  font-size: 20px;
}
#contentSection .emptyTxt{display:flex;flex-direction:column;gap:4px}
#contentSection .emptyTxt b{font-size:13.5px}
#contentSection .emptyTxt span{font-size:12.5px;opacity:.75}

@media (max-width: 860px){
  #contentSection .discoverTop{flex-direction:column; align-items:stretch}
  #contentSection .discoverSearch{max-width:none}
  .bigChip{min-width: 190px}
  .cCard{grid-column: span 12}
}
</style>
</head>
<body data-page="app">
  <div class="scroll-progress"><div class="scroll-progress-bar" id="scrollProgress"></div></div>
  <button class="scroll-to-top" id="scrollToTop" aria-label="Yuqoriga"><i class="fa-solid fa-arrow-up"></i></button>
  <canvas id="three-canvas"></canvas>

  <!-- old seasonal particles (kept for logic) -->
  <canvas class="seasonCanvas" id="seasonCanvas"></canvas>

  <div class="app">
    <header>
      <div class="header-card">
        <div class="brandBox" aria-label="LeaderMath">
          <img src="logo.png" alt="LeaderMath.UZ" class="logo-img">
          <div class="brandText">
            <div class="brandName">LeaderMath<span class="dot">.uz</span></div>
            <div class="brandTag" id="dtMini">...</div>
          </div>
        </div>

        <div class="header-text">
          <div class="header-title">LeaderMath.UZ ‚Äî App</div>
          <div class="header-sub" id="dt">...</div>
        </div>

        <div class="user-chip" id="profileMini" title="Profil / Avatar">
          <img id="userAvatar" src="logo.png" alt="avatar" style="width:36px;height:36px;border-radius:999px;border:2px solid rgba(56,189,248,.65)"/>
          <div class="user-meta">
            <div class="name"><span id="userName">‚Äî</span> ¬∑ <span id="userId">‚Äî</span></div>
            <div class="mini">üèÜ <span id="userPoints">0</span> ‚Ä¢ üí∞ <span id="userBalance">0</span> ‚Ä¢ üéÇ <span id="userAge">‚Äî</span></div>
          </div>
        </div>

        <div class="header-actions" aria-label="Header actions">
          <button class="icon-btn" id="btnBell" aria-label="Bildirishnoma" title="Tez kunda"><i class="fa-solid fa-bell"></i></button>
          <button class="icon-btn" id="btnLogout" aria-label="Chiqish"><i class="fa-solid fa-right-from-bracket"></i></button>
        </div>
      </div>
    </header>

    <main style="display:flex;flex-direction:column;gap:18px;">

      <!-- 1) Stories-style Banner Carousel (banner/1.png,2.png...) -->
      <section class="glass section" id="bannerSection">
        <div class="sectionTitle">
          <h2>Bannerlar</h2>
          <div class="hint">Instagram stories uslubida</div>
        </div>

        <div class="storyBar" id="storyBar" aria-label="Banner stories"></div>

        <div class="storyViewer" id="storyViewer" aria-label="Banner ko‚Äòruvchi" style="margin-top:12px;">
          <div class="storyProgress" id="storyProgressDots" aria-hidden="true"></div>
          <button class="storyNav prev" id="storyPrev" type="button" aria-label="Oldingi">‚Äπ</button>
          <img class="storyImg" id="storyImg" alt="Banner" />
          <button class="storyNav next" id="storyNext" type="button" aria-label="Keyingi">‚Ä∫</button>
          <div class="storyEmpty" id="storyEmpty" style="display:none;">
            <div class="big">Banner yo‚Äòq</div>
            <div class="small muted">banner/1.png, 2.png, 3.png‚Ä¶ fayllarni joylang</div>
          </div>
        </div>
      </section>

      <!-- 2) NEW CONTENT (old content removed) -->
      <section class="discover" id="contentSection">
  <div class="discoverTop">
    <div class="discoverTitle">
      <h2>Kontent</h2>
      <p>Katta chip ‚Üí tag ‚Üí qidiruv orqali tez toping</p>
    </div>

    <div class="discoverSearch">
      <span class="sIcon">üîé</span>
      <input id="contentSearch" type="search" placeholder="Test, simulyator, o‚Äòyin yoki mavzu qidiring‚Ä¶" autocomplete="off" />
      <button class="sClear" id="clearBtn" title="Tozalash">Tozalash</button>
    </div>
  </div>

  <div class="bigRow" id="bigChipsRow" aria-label="Bo‚Äòlimlar"></div>
  <div class="tagRow" id="tagChipsRow" aria-label="Taglar"></div>

  <div class="resultBar">
    <div id="resultInfo">Yuklanmoqda‚Ä¶</div>
  </div>

  <div class="cardsGrid" id="grid"></div>

  <div class="emptyState" id="empty" style="display:none;">
    <div class="emptyIcon">üß≠</div>
    <div class="emptyTxt">
      <b>Hech narsa topilmadi</b>
      <span>Tag yoki qidiruvni o‚Äòzgartirib ko‚Äòring.</span>
    </div>
  </div>
</section>

      <!-- Onboard overlay kept (profile completion) -->
      <div id="onboardOverlay" style="display:none; position:fixed; inset:0; background: rgba(2,6,23,.55); backdrop-filter: blur(10px); z-index: 9998;">
        <div class="container" style="display:flex; align-items:center; justify-content:center; min-height: 100%;">
          <div class="glass section" style="max-width: 520px; width: 100%;">
            <div class="sectionTitle">
              <h2>Profilni to‚Äòldiring</h2>
              <div class="hint">Birinchi kirishda</div>
            </div>
            <p class="p">Ism, familiya, tug‚Äòilgan sana va yangi parolni kiriting.</p>
            <div class="hr"></div>

            <div class="row">
              <input class="input" id="obFirst" placeholder="Ism"/>
              <input class="input" id="obLast" placeholder="Familiya"/>
            </div>
            <div style="height:10px;"></div>
            <div class="row">
              <input class="input" id="obBirth" type="date" placeholder="Tug‚Äòilgan sana (YYYY-MM-DD)"/>
              <input class="input" id="obPass1" type="password" placeholder="Yangi parol"/>
            </div>
            <div style="height:10px;"></div>
            <div class="row">
              <input class="input" id="obPass2" type="password" placeholder="Yangi parolni takrorlang"/>
              <div></div>
            </div>

            <div style="height:12px;"></div>
            <button class="btn btnPrimary" id="obSave" style="width:100%;">Saqlash va davom etish</button>
            <div class="small" style="margin-top:10px;">‚ö†Ô∏è Parolni eslab qoling. Keyingi kirishda shu parol ishlaydi.</div>
          </div>
        </div>
      </div>

      <script type="module">
        import { initSeasons } from "./assets/js/seasons.js";
        initSeasons("seasonCanvas");
      </script>

    </main>

    <footer>
      <div class="footer-card">
        <div class="footer-left">
          <div class="footer-name">LeaderMath.UZ</div>
          <div class="small-note">Banner saqlandi ‚Ä¢ Kontent JSON‚Äôdan</div>
        </div>
        <div class="footer-right">
          <a class="footer-link" href="index.html"><i class="fa-solid fa-house"></i> Home</a>
        </div>
      </div>
    </footer>
  </div>

  <div class="toast" id="toast">...</div>

  <script src="assets/js/core.js"></script>

  <script type="module">
    import { me, logout, updateProfile, changePassword, getToken } from "./assets/js/auth.js";

    const $ = (id)=>document.getElementById(id);

    // Guard
    try{
      if(!getToken || !getToken()) location.href = "./index.html";
    }catch{ location.href = "./index.html"; }

    // Date
    const months = ["yanvar","fevral","mart","aprel","may","iyun","iyul","avgust","sentabr","oktabr","noyabr","dekabr"];
    const days = ["yakshanba","dushanba","seshanba","chorshanba","payshanba","juma","shanba"];
    function setDate(){
      const d = new Date();
      const s = `${days[d.getDay()]}, ${d.getDate()}-${months[d.getMonth()]} ${d.getFullYear()} ‚Ä¢ ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      $("dt").textContent = s;
      const mini = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      const dtMini = $("dtMini");
      if(dtMini) dtMini.textContent = mini;
    }
    setDate(); setInterval(setDate, 15000);

    // Toast
    const toastEl = $("toast");
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=>toastEl.classList.remove("show"), 1800);
    }

    // Profile
    function calcAge(iso){
      if(!iso) return "‚Äî";
      const b = new Date(iso);
      if(Number.isNaN(b.getTime())) return "‚Äî";
      const n = new Date();
      let y=n.getFullYear()-b.getFullYear();
      let m=n.getMonth()-b.getMonth();
      let d=n.getDate()-b.getDate();
      if(d<0){ m--; d += new Date(n.getFullYear(), n.getMonth(), 0).getDate(); }
      if(m<0){ y--; m+=12; }
      return `${y}y ${m}oy`;
    }
    function setAvatarFromUser(u){
      const img = $("userAvatar");
      const id = u?.avatarId || u?.avatar || u?.profile?.avatarId;
      if(!img) return;
      if(id){ img.src = `avatar/${id}.png`; }
      else { img.src = "logo.png"; }
    }

    async function ensureProfile(user){
      // agar ism/familiya yo‚Äòq bo‚Äòlsa onboard ko‚Äòrsatamiz
      const needs = !(user?.firstName && user?.lastName && user?.birthdate);
      if(!needs) return;
      const overlay = $("onboardOverlay");
      if(!overlay) return;
      overlay.style.display = "block";

      $("obSave").onclick = async ()=>{
        const fn = $("obFirst").value.trim();
        const ln = $("obLast").value.trim();
        const bd = $("obBirth").value;
        const p1 = $("obPass1").value;
        const p2 = $("obPass2").value;
        if(!fn || !ln || !bd) return toast("Ism, familiya, tug‚Äòilgan sana kerak");
        if(!p1 || p1.length<4) return toast("Parol kamida 4 belgi");
        if(p1!==p2) return toast("Parol mos emas");
        try{
          $("obSave").disabled = true;
          await updateProfile(fn, ln, bd);
          await changePassword(p1);
          overlay.style.display = "none";
          toast("‚úÖ Saqlandi");
          await loadMe();
        }catch(e){
          toast(e?.message || "Xatolik");
        }finally{
          $("obSave").disabled = false;
        }
      };
    }

    async function loadMe(){
      try{
        const r = await me();
        const u = r?.user || r;
        $("userName").textContent = [u?.firstName, u?.lastName].filter(Boolean).join(" ") || "‚Äî";
        $("userId").textContent = u?.loginId || u?.id || "‚Äî";
        $("userPoints").textContent = u?.points ?? 0;
        $("userBalance").textContent = u?.balance ?? 0;
        $("userAge").textContent = calcAge(u?.birthdate);
        setAvatarFromUser(u);
        ensureProfile(u);
      }catch(e){
        toast("Sessiya tugagan. Qayta kiring.");
        location.href = "./index.html";
      }
    }

    $("btnLogout")?.addEventListener("click", async ()=>{
      await logout();
      location.href = "./index.html";
    });
    $("btnBell")?.addEventListener("click", ()=>toast("üîî Tez kunda"));

    // --- Banner stories ---
    const BANNER_DIR = "banner";
    const BANNER_MANIFEST = "banner/manifest.json";
    let storyItems = [];
    let storyIdx = 0;
    let storyTimer = null;

    function preloadImage(url){
      return new Promise((resolve)=>{
        const img = new Image();
        img.onload = ()=>resolve(true);
        img.onerror = ()=>resolve(false);
        img.src = url;
      });
    }

    async function probeSequentialImages(dir, max=24, stopAfter=4){
      const out = [];
      let misses = 0;
      for(let i=1;i<=max;i++){
        const url = `${dir}/${i}.png`;
        const ok = await preloadImage(url);
        if(ok){ out.push({id:i, url}); misses = 0; }
        else { misses++; if(misses>=stopAfter) break; }
      }
      return out;
    }

    function clearStoryTimer(){
      if(storyTimer){ clearInterval(storyTimer); storyTimer=null; }
    }

    function renderStoryBar(){
      const bar = $("storyBar");
      if(!bar) return;
      if(!storyItems.length){
        bar.innerHTML = `<div class="small" style="padding:6px 2px;">banner/ papkada 1.png, 2.png... bo‚Äòlsa, shu yerda stories chiqadi.</div>`;
        return;
      }
      bar.innerHTML = storyItems.map((s,i)=>`
        <button class="storyBubble" type="button" data-idx="${i}" aria-label="Banner ${i+1}">
          <div class="storyRing"><img class="storyAvatar" alt="Banner ${i+1}" src="${s.url}"></div>
          <div class="storyLabel">${i+1}</div>
        </button>
      `).join("");
      bar.onclick = (e)=>{
        const b = e.target.closest("[data-idx]");
        if(!b) return;
        renderStoryViewer(Number(b.getAttribute("data-idx"))||0, true);
      };
    }

    function renderStoryViewer(idx, autoplay=false){
      const viewer = $("storyViewer");
      const img = $("storyImg");
      const dots = $("storyProgressDots");
      const empty = $("storyEmpty");
      if(!viewer || !img || !dots) return;

      storyIdx = Math.max(0, Math.min(idx, Math.max(0, storyItems.length-1)));

      if(!storyItems.length){
        img.removeAttribute("src");
        dots.innerHTML = "";
        if(empty) empty.style.display = "block";
        clearStoryTimer();
        return;
      }

      if(empty) empty.style.display = "none";
      img.src = storyItems[storyIdx].url;
      dots.innerHTML = storyItems.map((_,i)=>`<span class="storyProgressDot ${i===storyIdx?"active":""}"></span>`).join("");

      clearStoryTimer();
      if(autoplay){
        let t=0;
        storyTimer = setInterval(()=>{
          t++;
          if(t>=6){
            t=0;
            const next = (storyIdx+1) % storyItems.length;
            renderStoryViewer(next, true);
          }
        }, 800);
      }
    }

    function setupStoryControls(){
      $("storyPrev")?.addEventListener("click", (e)=>{
        e.stopPropagation();
        if(!storyItems.length) return;
        renderStoryViewer((storyIdx-1+storyItems.length)%storyItems.length, true);
      });
      $("storyNext")?.addEventListener("click", (e)=>{
        e.stopPropagation();
        if(!storyItems.length) return;
        renderStoryViewer((storyIdx+1)%storyItems.length, true);
      });
      $("storyViewer")?.addEventListener("click", ()=>{
        if(!storyItems.length) return;
        renderStoryViewer((storyIdx+1)%storyItems.length, true);
      }, {passive:true});
    }

    async function loadStories(){
      storyItems = [];
      // 1) manifest.json (optional)
      try{
        const r = await fetch(BANNER_MANIFEST, {cache:"no-store"});
        if(r.ok){
          const j = await r.json();
          const ids = Array.isArray(j?.ids) ? j.ids : [];
          storyItems = ids.map(id=>({id, url:`${BANNER_DIR}/${id}.png`}));
        }
      }catch(_){ }
      // 2) fallback probe
      if(!storyItems.length){
        storyItems = await probeSequentialImages(BANNER_DIR, 24, 4);
      }
      renderStoryBar();
      renderStoryViewer(0, true);
    }

    // --- Content from content.json ---
    const ct = {
      activeType: null,
      activeTag: "all",
      q: "",
      data: null
    };

    function norm(s){
      return (s??"").toString().trim().toLowerCase().replace(/\s+/g," ");
    }
    function esc(s){
      return String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
    }

    function enhanceRow(row){
      if(!row) return;
      // wheel -> horizontal
      row.addEventListener("wheel", (e)=>{
        if(Math.abs(e.deltaY) > Math.abs(e.deltaX)){
          row.scrollLeft += e.deltaY;
          e.preventDefault();
        }
      }, {passive:false});
      // drag
      let isDown=false, startX=0, startLeft=0;
      row.addEventListener("mousedown", (e)=>{
        isDown=true;
        startX = e.pageX;
        startLeft = row.scrollLeft;
      });
      window.addEventListener("mouseup", ()=>isDown=false);
      window.addEventListener("mousemove", (e)=>{
        if(!isDown) return;
        const dx = e.pageX - startX;
        row.scrollLeft = startLeft - dx;
      });
    }

    function ctItemsByType(){
      const items = ct.data?.items || [];
      return items.filter(it => norm(it.type) === ct.activeType);
    }

    function ctPickTags(items){
      const set = new Set();
      items.forEach(it => (it.tags||[]).forEach(t => set.add(norm(t))));
      return [...set].filter(Boolean).sort((a,b)=>a.localeCompare(b));
    }

    function ctCountType(typeId){
      const items = ct.data?.items || [];
      return items.filter(it => norm(it.type)===typeId).length;
    }

    function ctCountTag(tag){
      const items = ctItemsByType();
      if(tag==="all") return items.length;
      return items.filter(it => (it.tags||[]).map(norm).includes(tag)).length;
    }

    function ctSetActive(container, id){
      [...container.querySelectorAll(".ctChip")].forEach(c=>c.classList.toggle("active", c.dataset.id===id));
    }

    function ctRenderBig(){
      const row = $("ctBigRow");
      const big = (ct.data?.bigChips || []).map(c=>({ ...c, id: norm(c.id) }));
      if(!ct.activeType && big.length) ct.activeType = big[0].id; // BARCHASI YO‚ÄòQ

      row.innerHTML = big.map(c=>`
        <div class="ctChip ${c.id===ct.activeType?"active":""}" data-id="${c.id}">
          <span class="ctDot"></span>
          <span>${esc(c.icon||"")} ${esc(c.title||"")}</span>
          <span class="ctCount">${ctCountType(c.id)}</span>
        </div>
      `).join("");

      row.querySelectorAll(".ctChip").forEach(ch=>{
        ch.addEventListener("click", ()=>{
          ct.activeType = ch.dataset.id;
          ct.activeTag = "all";
          ctSetActive(row, ct.activeType);
          ctRenderTags();
          ctRenderCards();
        });
      });

      enhanceRow(row);
    }

    function ctRenderTags(){
      const row = $("ctTagRow");
      const tags = ctPickTags(ctItemsByType());
      const list = ["all", ...tags];
      row.innerHTML = list.map(t=>`
        <div class="ctChip small ${t===ct.activeTag?"active":""}" data-id="${t}">
          <span>${esc(t==="all"?"Hammasi":t)}</span>
          <span class="ctCount">${ctCountTag(t)}</span>
        </div>
      `).join("");

      row.querySelectorAll(".ctChip").forEach(ch=>{
        ch.addEventListener("click", ()=>{
          ct.activeTag = ch.dataset.id;
          ctSetActive(row, ct.activeTag);
          ctRenderCards();
        });
      });

      enhanceRow(row);
    }

    function ctFiltered(){
      const q = norm(ct.q);
      return ctItemsByType()
        .filter(it=>{
          if(ct.activeTag!=="all"){
            const tags = (it.tags||[]).map(norm);
            if(!tags.includes(ct.activeTag)) return false;
          }
          if(q){
            const hay = [it.title, it.desc, it.type, (it.tags||[]).join(" ")].map(norm).join(" | ");
            if(!hay.includes(q)) return false;
          }
          return true;
        })
        .sort((a,b)=>(b.order||0)-(a.order||0));
    }

    function ctRenderCards(){
      const grid = $("ctGrid");
      const info = $("ctInfo");
      const empty = $("ctEmpty");
      const items = ctFiltered();

      info.textContent = `Natija: ${items.length} ta`;
      if(!items.length){
        grid.innerHTML = "";
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";

      grid.innerHTML = items.map(it=>{
        const status = norm(it.status)||"available";
        const disabled = status==="soon";
        const badge = it.badge || (disabled?"SOON":"");
        return `
          <div class="card" style="min-height: 124px;">
            <div class="cardTop">
              <div>
                <div class="cardTitle">${esc(it.title||"")}</div>
                <div class="cardDesc">${esc(it.desc||"")}</div>
              </div>
              ${badge?`<div class="pill" style="margin-left:auto;">${esc(badge)}</div>`:""}
            </div>
            <div class="cardTags" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
              ${(it.tags||[]).slice(0,6).map(t=>`<span class="pill" style="opacity:.92">${esc(t)}</span>`).join("")}
              <a class="btn ${disabled?"":"btnPrimary"}" href="${esc(it.href||"#")}" style="margin-left:auto; padding:10px 12px; ${disabled?"pointer-events:none; opacity:.7;":""}">
                ${disabled?"Tez kunda":"Ochish"}
              </a>
            </div>
          </div>
        `;
      }).join("");
    }

    async function ctInit(){
      try{
        const r = await fetch("./content.json", {cache:"no-store"});
        if(!r.ok) throw new Error("content.json topilmadi");
        ct.data = await r.json();
        ctRenderBig();
        ctRenderTags();
        ctRenderCards();

        const q = $("ctQ");
        let t=null;
        q.addEventListener("input", ()=>{
          clearTimeout(t);
          t=setTimeout(()=>{ ct.q=q.value; ctRenderCards(); }, 120);
        });

        $("ctClear").addEventListener("click", ()=>{
          ct.activeTag = "all";
          ct.q = "";
          q.value = "";
          ctRenderTags();
          ctRenderCards();
        });

      }catch(e){
        $("ctInfo").textContent = "Xatolik: kontent yuklanmadi";
        toast(e?.message || "Xatolik");
      }
    }

    // boot
    await loadMe();
    setupStoryControls();
    await loadStories();
    await ctInit();

  </script>
<script>
(() => {
  const state = { data:null, activeType:null, activeTag:"all", query:"" };

  const elBig = document.getElementById("bigChipsRow");
  const elTag = document.getElementById("tagChipsRow");
  const elGrid = document.getElementById("grid");
  const elEmpty = document.getElementById("empty");
  const elInfo = document.getElementById("resultInfo");
  const elQ = document.getElementById("contentSearch");
  const elClear = document.getElementById("clearBtn");

  const norm = (s) => (s ?? "").toString().trim().toLowerCase().replace(/\s+/g," ");
  const esc = (s) => (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");

  function enhanceRow(row){
    if(!row) return;
    // Wheel vertical -> horizontal
    row.addEventListener("wheel", (e) => {
      if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
        row.scrollLeft += e.deltaY;
        e.preventDefault();
      }
    }, { passive:false });

    // Drag-scroll (mouse)
    let down=false, sx=0, sl=0;
    row.addEventListener("mousedown", (e) => {
      down=true; sx=e.pageX; sl=row.scrollLeft;
    });
    window.addEventListener("mouseup", () => down=false);
    window.addEventListener("mousemove", (e) => {
      if(!down) return;
      row.scrollLeft = sl - (e.pageX - sx);
    });
  }

  function tagsOf(items){
    const set = new Set();
    items.forEach(it => (it.tags||[]).forEach(t => set.add(norm(t))));
    return [...set].filter(Boolean).sort((a,b)=>a.localeCompare(b));
  }

  function countByType(typeId){
    return (state.data?.items||[]).filter(it => norm(it.type)===typeId).length;
  }

  function countByTag(tag){
    const items = (state.data?.items||[]).filter(it => norm(it.type)===state.activeType);
    if(tag==="all") return items.length;
    return items.filter(it => (it.tags||[]).map(norm).includes(tag)).length;
  }

  function setActive(container, id){
    [...container.querySelectorAll("[data-id]")].forEach(x => x.classList.toggle("active", x.dataset.id===id));
  }

  function filtered(){
    const items = (state.data?.items||[]).filter(it => norm(it.type)===state.activeType);
    const q = norm(state.query);
    const tg = state.activeTag;
    return items.filter(it => {
      if(tg!=="all"){
        const tags = (it.tags||[]).map(norm);
        if(!tags.includes(tg)) return false;
      }
      if(q){
        const hay = [it.title,it.desc,it.type,(it.tags||[]).join(" ")].map(norm).join(" | ");
        if(!hay.includes(q)) return false;
      }
      return true;
    }).sort((a,b)=>(b.order||0)-(a.order||0));
  }

  function renderBig(){
    const big = (state.data?.bigChips||[]).map(c => ({...c, id:norm(c.id)}));
    if(!big.length){ elBig.innerHTML=""; return; }
    if(!state.activeType) state.activeType = big[0].id; // Barchasi yo‚Äòq: default birinchi

    elBig.innerHTML = big.map(c => {
      const cnt = countByType(c.id);
      return `
        <div class="bigChip ${c.id===state.activeType?"active":""}" data-id="${c.id}">
          <div class="ic">${esc(c.icon||"‚ú®")}</div>
          <div class="txt">
            <b>${esc(c.title||"")}</b>
            <small>${cnt} ta</small>
          </div>
          <div class="cnt">${cnt}</div>
        </div>
      `;
    }).join("");

    elBig.querySelectorAll(".bigChip").forEach(ch => {
      ch.addEventListener("click", () => {
        state.activeType = ch.dataset.id;
        state.activeTag = "all";
        state.query = "";
        elQ.value = "";
        setActive(elBig, state.activeType);
        renderTags();
        renderCards();
      });
    });
  }

  function renderTags(){
    const itemsScope = (state.data?.items||[]).filter(it => norm(it.type)===state.activeType);
    const tags = tagsOf(itemsScope);
    const list = ["all", ...tags]; // taglarda Hammasi bo'lsin

    elTag.innerHTML = list.map(t => {
      const label = (t==="all") ? "Hammasi" : t;
      const cnt = countByTag(t);
      return `
        <div class="tagChip ${t===state.activeTag?"active":""}" data-id="${t}">
          <span>${esc(label)}</span>
          <span class="tCnt">${cnt}</span>
        </div>
      `;
    }).join("");

    elTag.querySelectorAll(".tagChip").forEach(ch => {
      ch.addEventListener("click", () => {
        state.activeTag = ch.dataset.id;
        setActive(elTag, state.activeTag);
        renderCards();
      });
    });
  }

  function renderCards(){
    const out = filtered();
    elInfo.textContent = out.length ? `Natija: ${out.length} ta` : `Natija: 0 ta`;
    elEmpty.style.display = out.length ? "none" : "flex";

    elGrid.innerHTML = out.map(it => {
      const status = norm(it.status||"available");
      const badge = it.badge || (status==="soon" ? "SOON" : "");
      const badgeCls = status==="soon" ? "cBadge soon" : "cBadge";
      const href = it.href || "#";
      const goCls = status==="soon" ? "cGo disabled" : "cGo";
      const goTxt = status==="soon" ? "Tez kunda" : "Boshlash";
      const tgs = (it.tags||[]).slice(0,6).map(t => `<span class="cTag">${esc(t)}</span>`).join("");

      return `
        <div class="cCard">
          <div class="cTop">
            <div style="min-width:0">
              <div class="cTitle">${esc(it.title||"")}</div>
              <div class="cDesc">${esc(it.desc||"")}</div>
            </div>
            ${badge ? `<div class="${badgeCls}">${esc(badge)}</div>` : ``}
          </div>

          <div class="cTags">
            ${tgs}
            <a class="${goCls}" href="${esc(href)}">${esc(goTxt)} <span>‚Üí</span></a>
          </div>
        </div>
      `;
    }).join("");
  }

  function bind(){
    let t=null;
    elQ.addEventListener("input", () => {
      clearTimeout(t);
      t=setTimeout(() => {
        state.query = elQ.value;
        renderCards();
      }, 120);
    });

    elClear.addEventListener("click", () => {
      state.activeTag = "all";
      state.query = "";
      elQ.value = "";
      renderTags();
      renderCards();
    });
  }

  async function init(){
    try{
      const res = await fetch("./content.json", { cache:"no-store" });
      if(!res.ok) throw new Error("content.json topilmadi");
      state.data = await res.json();

      renderBig();
      renderTags();
      bind();
      enhanceRow(elBig);
      enhanceRow(elTag);
      renderCards();
    } catch(e){
      elInfo.textContent = "Xatolik: kontent yuklanmadi";
      elGrid.innerHTML = `<div style="opacity:.75; padding:12px;">‚ùå ${esc(e.message||e)}</div>`;
      elEmpty.style.display = "none";
    }
  }

  init();
})();
</script>
</body>
</html>
