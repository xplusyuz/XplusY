<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LeaderMath.UZ ‚Äî App</title>
  <link rel="stylesheet" href="assets/css/app.css"/>
</head>
<body>
  <canvas class="seasonCanvas" id="seasonCanvas"></canvas>
  <div class="toast" id="toast"></div>

  <div class="container">
    <div class="glass topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"><span>œÄ</span></div>
        <div class="titleWrap">
          <div class="title">LeaderMath.UZ</div>
          <div class="subtitle" id="dt">‚Äî</div>
        </div>
      </div>
      <button class="btn" id="btnLogout">Chiqish</button>
    </div>

    <div class="glass section">
      <div class="sectionTitle">
        <h2>Profil</h2>
        <div class="hint">Tezkor ma‚Äôlumot</div>
      </div>

      <div class="profileRow">
        <div class="chip"><span class="k">Ism:</span> <b id="userName">‚Äî</b></div>
        <div class="chip"><span class="k">ID:</span> <b id="userId">‚Äî</b></div>
        <div class="chip"><span class="k">Yosh:</span> <b id="userAge">‚Äî</b></div>

        <div class="stats">
          <div class="stat"><span class="dot"></span><b>Ball:</b> <span id="userPoints">0</span></div>
          <div class="stat"><span class="dot"></span><b>Balans:</b> <span id="userBalance">0</span></div>
        </div>
      </div>
    </div>

    <div class="glass section">
      <div class="sectionTitle">
        <h2>Bo‚Äòlimlar</h2>
        <div class="hint">Kartani bosib oching</div>
      </div>
      <div class="cards" id="sections"></div>
    </div>

    <div class="glass section">
      <div class="sectionTitle">
        <h2>Reyting va izohlar</h2>
        <div class="hint">Point bo‚Äòyicha Top-20</div>
      </div>

      <div class="lbGrid">
        <div class="glass" style="padding:14px;">
          <table class="table" aria-label="Leaderboard">
            <thead>
              <tr>
                <th style="width:60px;">#</th>
                <th>Foydalanuvchi</th>
                <th style="width:90px;">Ball</th>
              </tr>
            </thead>
            <tbody id="lbBody">
              <tr><td colspan="3" class="small">Yuklanmoqda‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>

        <div class="glass" style="padding:14px;">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <div>
              <div class="nameLine">Izohlar</div>
              <div class="small">Fikr qoldiring (qisqa)</div>
            </div>
            <span class="pill" id="commentCount">0</span>
          </div>

          <div class="commentBox">
            <input id="commentInput" maxlength="140" placeholder="Izoh yozing‚Ä¶ (140 ta belgi)"/>
            <button class="btn btnPrimary" id="commentSend">Yuborish</button>
          </div>

          <div class="hr"></div>
          <ul class="commentList" id="commentList"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Onboarding overlay (original flow preserved) -->
  <div id="onboardOverlay" style="display:none; position:fixed; inset:0; background: rgba(2,6,23,.55); backdrop-filter: blur(10px); z-index: 9998;">
    <div class="container" style="display:flex; align-items:center; justify-content:center; min-height: 100%;">
      <div class="glass section" style="max-width: 520px; width: 100%;">
        <div class="sectionTitle">
          <h2>Profilni to‚Äòldiring</h2>
          <div class="hint">Birinchi kirishda</div>
        </div>
        <p class="p">Ism, familiya, tug‚Äòilgan sana va yangi parolni kiriting.</p>
        <div class="hr"></div>

        <div class="row">
          <input class="input" id="obFirst" placeholder="Ism"/>
          <input class="input" id="obLast" placeholder="Familiya"/>
        </div>
        <div style="height:10px;"></div>
        <div class="row">
          <input class="input" id="obBirth" placeholder="Tug‚Äòilgan sana (YYYY-MM-DD)"/>
          <input class="input" id="obPass1" type="password" placeholder="Yangi parol"/>
        </div>
        <div style="height:10px;"></div>
        <div class="row">
          <input class="input" id="obPass2" type="password" placeholder="Yangi parolni takrorlang"/>
          <div></div>
        </div>

        <div style="height:12px;"></div>
        <button class="btn btnPrimary" id="obSave" style="width:100%;">Saqlash va davom etish</button>
        <div class="small" style="margin-top:10px;">‚ö†Ô∏è Parolni eslab qoling. Keyingi kirishda shu parol ishlaydi.</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initSeasons } from "./assets/js/seasons.js";
    initSeasons("seasonCanvas");
  </script>

  <script type="module">
    import { me, logout, updateProfile, changePassword, getToken } from "./assets/js/auth.js";
    import { api } from "./assets/js/api.js";

    const $ = (id)=>document.getElementById(id);

    // UZ date formatter
    const months = ["yanvar","fevral","mart","aprel","may","iyun","iyul","avgust","sentabr","oktabr","noyabr","dekabr"];
    const days = ["yakshanba","dushanba","seshanba","chorshanba","payshanba","juma","shanba"];
    function setDate(){
      const d = new Date();
      const s = `${days[d.getDay()]}, ${d.getDate()}-${months[d.getMonth()]} ${d.getFullYear()} ‚Ä¢ ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      $("dt").textContent = s;
    }
    setDate(); setInterval(setDate, 15000);

    // Toast
    const toastEl = $("toast");
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=>toastEl.classList.remove("show"), 1800);
    }

    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
    }

    function calcAgePrecise(iso){
      if(!iso) return "‚Äî";
      const b = new Date(iso);
      if(Number.isNaN(b.getTime())) return "‚Äî";
      const n = new Date();
      let y=n.getFullYear()-b.getFullYear();
      let m=n.getMonth()-b.getMonth();
      let d=n.getDate()-b.getDate();
      if(d<0){ m--; d += new Date(n.getFullYear(), n.getMonth(), 0).getDate(); }
      if(m<0){ y--; m+=12; }
      return `${y} yosh ${m} oy ${d} kun`;
    }

    // Feature cards
    const FEATURES = [
      { title:"Online Challenge", desc:"Kunlik/haftalik jonli masalalar", img:"assets/images/online_challenge.svg", href:"challenge.html" },
      { title:"EXAM", desc:"Imtihon rejimi: vaqt, ball, natija", img:"assets/images/exam.svg", href:"exam.html" },
      { title:"PLAY", desc:"O‚Äòyin tarzida mantiqiy mashqlar", img:"assets/images/play.svg", href:"play.html" },
    ];

    function renderSections(){
      const root = $("sections");
      root.innerHTML = FEATURES.map(f=>`
        <div class="featureCard" tabindex="0" data-href="${f.href}">
          <div class="poster"><img alt="${f.title}" src="${f.img}"></div>
          <div class="fOverlay"></div>
          <div class="fMeta">
            <div class="fText">
              <h3>${f.title}</h3>
              <p>${f.desc}</p>
            </div>
            <a class="playBtn" href="${f.href}" aria-label="${f.title} ochish">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
            </a>
          </div>
        </div>
      `).join("");

      root.addEventListener("click", (e)=>{
        const card = e.target.closest(".featureCard");
        if(!card) return;
        const href = card.getAttribute("data-href");
        if(href) location.href = href;
      }, { passive:true });

      root.addEventListener("keydown", (e)=>{
        if(e.key !== "Enter") return;
        const card = e.target.closest(".featureCard");
        if(card){
          const href = card.getAttribute("data-href");
          if(href) location.href = href;
        }
      });
    }

    async function runOnboarding(){
      return new Promise((resolve)=>{
        const overlay=$("onboardOverlay");
        const bSave=$("obSave");
        overlay.style.display="flex";
        bSave.onclick = async ()=>{
          bSave.disabled=true;
          try{
            const first=$("obFirst").value.trim();
            const last=$("obLast").value.trim();
            const birth=$("obBirth").value.trim();
            const p1=$("obPass1").value, p2=$("obPass2").value;
            if(first.length<2) throw new Error("Ism kamida 2 ta harf bo‚Äòlsin");
            if(last.length<2) throw new Error("Familiya kamida 2 ta harf bo‚Äòlsin");
            if(!birth) throw new Error("Tug‚Äòilgan sanani kiriting");
            if(p1.length<6) throw new Error("Yangi parol kamida 6 belgidan iborat bo‚Äòlsin");
            if(p1!==p2) throw new Error("Parollar mos emas");
            await changePassword(p1);
            await updateProfile(first,last,birth);
            overlay.style.display="none";
            resolve(true);
          }catch(e){ toast(e.message||"Xatolik"); }
          finally{ bSave.disabled=false; }
        };
      });
    }

    // Leaderboard
    async function loadLeaderboard(){
      const body = $("lbBody");
      try{
        const data = await api("leaderboard");
        const items = (data?.items || []).slice(0,20);
        body.innerHTML = items.map((u,i)=>`
          <tr>
            <td><span class="rankBadge">${i+1}</span></td>
            <td>
              <div class="nameLine">${escapeHtml(u.name || u.loginId || "‚Äî")}</div>
              <div class="small">${escapeHtml(u.loginId || "")}</div>
            </td>
            <td><b>${Number(u.points||0)}</b></td>
          </tr>
        `).join("") || `<tr><td colspan="3" class="small">Hozircha reyting yo‚Äòq</td></tr>`;
      }catch(_){
        body.innerHTML = `<tr><td colspan="3" class="small">Reytingni yuklab bo‚Äòlmadi</td></tr>`;
      }
    }

    // Comments
    function fmtTime(ts){
      const d = ts ? new Date(ts) : new Date();
      return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }
    async function loadComments(){
      const list = $("commentList");
      const count = $("commentCount");
      try{
        const data = await api("comments");
        const items = data?.items || [];
        count.textContent = items.length;
        list.innerHTML = items.map(c=>`
          <li class="commentItem">
            <div class="top">
              <div class="nameLine">${escapeHtml(c.name || c.loginId || "‚Äî")}</div>
              <div class="small">${escapeHtml(fmtTime(c.createdAt))}</div>
            </div>
            <div style="margin-top:6px;">${escapeHtml(c.text || "")}</div>
          </li>
        `).join("") || `<li class="small">Hozircha izoh yo‚Äòq. Birinchi bo‚Äòling üôÇ</li>`;
      }catch(_){
        list.innerHTML = `<li class="small">Izohlarni yuklab bo‚Äòlmadi</li>`;
      }
    }
    async function sendComment(){
      const input = $("commentInput");
      const text = (input.value||"").trim();
      if(!text) return toast("Izoh bo‚Äòsh");
      input.value = "";
      try{
        const token = await getToken();
        await api("comments", { method:"POST", token, body: { text } });
        toast("Yuborildi ‚úÖ");
        await loadComments();
      }catch(e){
        toast("Xato: yuborilmadi");
      }
    }

    $("btnLogout").onclick = ()=>{ logout(); location.href="./"; };
    $("commentSend").onclick = sendComment;
    $("commentInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendComment(); });

    async function boot(){
      try{
        const r = await me();
        const u = r.user;
        $("userId").textContent = u.loginId;
        $("userName").textContent = u.name || u.loginId;
        $("userPoints").textContent = String(u.points ?? 0);
        $("userBalance").textContent = String(u.balance ?? 0);
        $("userAge").textContent = calcAgePrecise(u.birthdate);

        renderSections();
        loadLeaderboard();
        loadComments();

        if(!u.profileComplete){
          await runOnboarding();
          const r2 = await me();
          $("userName").textContent = r2.user.name || r2.user.loginId;
          $("userAge").textContent = calcAgePrecise(r2.user.birthdate);
        }
      }catch(e){
        toast(e.message||"Kirish yo‚Äòq");
        setTimeout(()=>location.href="./", 600);
      }
    }
    boot();
  </script>
</body>
</html>
