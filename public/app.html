<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LeaderMath.UZ ‚Äî Ilova</title>
  <link rel="icon" href="logo.png" />
  <link rel="stylesheet" href="./assets/css/app.css" />
</head>
<body>
  <div class="season-wrap" id="seasonWrap"></div>

  <main class="page">
    <div class="shell">
      <!-- Topbar -->
      <header class="glass topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true">
            <img src="logo.png" alt="LeaderMath.UZ logo">
          </div>
          <div class="title">
            <b>LeaderMath.UZ</b>
            <span id="dateText">‚Äî</span>
          </div>
        </div>
        <button class="btn" id="btnLogout">Chiqish</button>
      </header>

      <!-- Profile -->
      <section class="glass profile" aria-label="Profil">
        <div class="profileRow">
          <div class="nameBox">
            <div class="name" id="uName">‚Äî</div>
            <div class="meta" id="uMeta">ID: ‚Äî ‚Ä¢ Yosh: ‚Äî</div>
          </div>

          <div class="chips">
            <div class="chip"><span>‚≠ê</span><b class="mono" id="uPoints">0</b><small>Ball</small></div>
            <div class="chip"><span>ü™ô</span><b class="mono" id="uBalance">0</b><small>Balans</small></div>
          </div>
        </div>
      </section>

      <!-- Sections -->
      <section class="glass section" aria-label="Bo‚Äòlimlar">
        <h2>Bo‚Äòlimlar</h2>
        <div class="cards">
          <article class="card" data-href="online.html">
            <div class="poster">
              <img src="./assets/img/online.jpg" alt="Online Challenge">
            </div>
            <div class="cardFooter">
              <div class="badge"><span class="dot"></span> Online Challenge</div>
              <button class="playBtn" aria-label="Ochish">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
              </button>
            </div>
          </article>

          <article class="card" data-href="exam.html">
            <div class="poster">
              <img src="./assets/img/exam.jpg" alt="EXAM">
            </div>
            <div class="cardFooter">
              <div class="badge"><span class="dot"></span> EXAM</div>
              <button class="playBtn" aria-label="Ochish">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
              </button>
            </div>
          </article>

          <article class="card" data-href="play.html">
            <div class="poster">
              <img src="./assets/img/play.jpg" alt="PLAY">
            </div>
            <div class="cardFooter">
              <div class="badge"><span class="dot"></span> PLAY</div>
              <button class="playBtn" aria-label="Ochish">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
              </button>
            </div>
          </article>
        </div>
      </section>
    </div>
  </main>

  <!-- Profile forced modal -->
  <div class="overlay" id="profileOverlay" role="dialog" aria-modal="true" aria-labelledby="profTitle">
    <div class="modal">
      <div class="modalHeader">
        <b id="profTitle">Profilni to‚Äòldiring</b>
        <button class="btn" id="btnProfClose" title="Yopish">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="fieldRow">
          <input class="input" id="firstName" placeholder="Ism" autocomplete="given-name">
          <input class="input" id="lastName" placeholder="Familiya" autocomplete="family-name">
        </div>
        <div style="margin-top:10px">
          <input class="input" id="birthdate" type="date" />
        </div>
        <div style="margin-top:10px">
          <input class="input" id="newPass" type="password" placeholder="Yangi parol (kamida 6 ta)" autocomplete="new-password">
        </div>
        <div style="margin-top:10px">
          <input class="input" id="newPass2" type="password" placeholder="Yangi parolni takrorlang" autocomplete="new-password">
        </div>

        <div class="actions">
          <button class="btn green" id="btnSaveProfile">Saqlash va davom etish</button>
        </div>
        <div class="help" id="profHint">Birinchi kirishda ism, familiya, tug‚Äòilgan sana va yangi parol kiritish majburiy.</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initSeasonalBackground } from "./assets/js/seasons.js";
    import { me, logout, updateProfile, changePassword } from "./assets/js/auth.js";

    const $ = (s, r=document) => r.querySelector(s);

    const UZ_MONTHS = ["yanvar","fevral","mart","aprel","may","iyun","iyul","avgust","sentabr","oktabr","noyabr","dekabr"];
    const UZ_DAYS = ["yakshanba","dushanba","seshanba","chorshanba","payshanba","juma","shanba"];

    function pad2(n){ return String(n).padStart(2,"0"); }
    function fmtDate(d){
      const dayName = UZ_DAYS[d.getDay()];
      const day = d.getDate();
      const month = UZ_MONTHS[d.getMonth()];
      const year = d.getFullYear();
      const hh = pad2(d.getHours());
      const mm = pad2(d.getMinutes());
      return `${dayName}, ${day}-${month} ${year} ‚Ä¢ ${hh}:${mm}`;
    }

    function ageExact(birthISO){
      if(!birthISO) return null;
      const b = new Date(birthISO);
      const now = new Date();
      let years = now.getFullYear() - b.getFullYear();
      let months = now.getMonth() - b.getMonth();
      let days = now.getDate() - b.getDate();

      if(days < 0){
        const prevMonth = new Date(now.getFullYear(), now.getMonth(), 0); // last day prev month
        days += prevMonth.getDate();
        months -= 1;
      }
      if(months < 0){
        months += 12;
        years -= 1;
      }
      return {years, months, days};
    }

    function setDateTicker(){
      const el = $("#dateText");
      const tick = () => { el.textContent = fmtDate(new Date()); };
      tick();
      setInterval(tick, 1000 * 20);
    }

    function toast(msg){
      // tiny non-blocking hint
      const h = $("#profHint");
      if(h){ h.textContent = msg; }
      alert(msg);
    }

    function openLink(href){
      if(!href) return;
      window.location.href = href;
    }

    function wireCards(){
      document.querySelectorAll(".card").forEach(card => {
        const href = card.getAttribute("data-href");
        card.addEventListener("click", (e) => {
          // if clicked on button or image, still open
          e.preventDefault();
          openLink(href);
        });
        const btn = card.querySelector(".playBtn");
        if(btn){
          btn.addEventListener("click", (e)=>{ e.preventDefault(); e.stopPropagation(); openLink(href); });
        }
      });
    }

    function showProfileModal(force){
      const ov = $("#profileOverlay");
      if(force) ov.classList.add("show");
      else ov.classList.remove("show");
    }

    async function ensureProfile(u){
      const needName = !u?.firstName || !u?.lastName;
      const needBirth = !u?.birthdate;
      const needPass = !!u?.needsPasswordChange; // backend can send
      const must = needName || needBirth || needPass;
      if(!must) return;

      $("#firstName").value = u?.firstName || "";
      $("#lastName").value = u?.lastName || "";
      $("#birthdate").value = u?.birthdate || "";

      // lock close if profile missing
      $("#btnProfClose").style.display = "none";
      showProfileModal(true);
    }

    async function renderUser(u){
      const full = [u?.firstName, u?.lastName].filter(Boolean).join(" ").trim() || "Foydalanuvchi";
      $("#uName").textContent = full;

      const a = ageExact(u?.birthdate);
      const ageTxt = a ? `${a.years} yosh ${a.months} oy ${a.days} kun` : "‚Äî";
      $("#uMeta").textContent = `ID: ${u?.loginId || "‚Äî"} ‚Ä¢ Yosh: ${ageTxt}`;
      $("#uPoints").textContent = String(u?.points ?? 0);
      $("#uBalance").textContent = String(u?.balance ?? 0);
    }

    async function boot(){
      setDateTicker();
      initSeasonalBackground(document.getElementById("seasonWrap"));

      wireCards();

      $("#btnLogout").addEventListener("click", async ()=>{
        await logout();
        window.location.href = "./";
      });

      // load user
      let u;
      try{
        const r = await me();
        u = r?.user || r;
      }catch(err){
        // token invalid -> go login
        window.location.href = "./";
        return;
      }
      await renderUser(u);
      await ensureProfile(u);

      $("#btnSaveProfile").addEventListener("click", async ()=>{
        const fn = $("#firstName").value.trim();
        const ln = $("#lastName").value.trim();
        const bd = $("#birthdate").value;
        const p1 = $("#newPass").value;
        const p2 = $("#newPass2").value;

        if(!fn || !ln) return toast("Ism va familiyani kiriting.");
        if(!bd) return toast("Tug‚Äòilgan sanani tanlang.");

        // password required on first fill
        if(!p1 || p1.length < 6) return toast("Yangi parol kamida 6 ta belgidan iborat bo‚Äòlsin.");
        if(p1 !== p2) return toast("Parollar mos kelmadi.");

        try{
          await updateProfile(fn, ln, bd);
          await changePassword(p1);
          showProfileModal(false);
          // reload user
          const rr = await me();
          const uu = rr?.user || rr;
          await renderUser(uu);
        }catch(err){
          toast(err?.message || "Saqlashda xato");
        }
      });
    }

    boot();
  </script>
</body>
</html>
