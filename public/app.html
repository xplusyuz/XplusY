<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover"/>
  <title>LeaderMath.UZ ‚Äî App</title>

  <link rel="icon" href="logo.png" sizes="192x192" />
  <meta name="theme-color" content="#0ea5e9">

  <!-- Base UI -->
  <link rel="stylesheet" href="assets/css/app.css"/>
  <link rel="stylesheet" href="assets/css/ui.css"/>

  <!-- Icons + 3D -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>

  <style>

    :root {
      --brand: #0ea5e9;
      --brand-light: #38bdf8;
      --brand-dark: #0369a1;
      --bg: #0f172a;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --card-bg: rgba(30, 41, 59, 0.8);
      --glass: rgba(255, 255, 255, 0.05);
      --shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      --radius: 24px;
      --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    html, body {
      width: 100%;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
    }

    body {
      position: relative;
      min-height: 100vh;
    }

    /* 3D CANVAS - FIXED BACKGROUND */
    .portal3d #three-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
    }

    /* MAIN CONTENT */
    .portal3d .app {
      position: relative;
      z-index: 10;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    /* SCROLLBAR STYLING */
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(10px);
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--brand), var(--brand-dark));
      border-radius: 5px;
      border: 2px solid rgba(15, 23, 42, 0.8);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, var(--brand-light), var(--brand));
    }

    /* HEADER */
    .portal3d header {
      animation: slideDown 0.8s ease-out;
    }

    .portal3d .header-card {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass);
      border-radius: var(--radius);
      padding: 18px 24px;
      display: flex;
      align-items: center;
      gap: 20px;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .portal3d .header-card:hover {
      transform: translateY(-5px);
      border-color: var(--brand);
      box-shadow: 0 25px 50px rgba(14, 165, 233, 0.2);
    }

    .portal3d .logo-img {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--brand);
      box-shadow: 0 0 30px var(--brand);
      animation: pulse 4s infinite;
    }

    .portal3d .header-text {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .portal3d .header-title {
      font-size: 24px;
      font-weight: 800;
      background: linear-gradient(90deg, var(--brand), var(--brand-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }

    .portal3d .header-sub {
      font-size: 14px;
      color: var(--muted);
    }

    .portal3d .header-tag {
      padding: 10px 20px;
      background: rgba(14, 165, 233, 0.15);
      border: 1px solid rgba(14, 165, 233, 0.3);
      border-radius: 50px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 600;
      color: var(--brand-light);
      backdrop-filter: blur(10px);
      transition: var(--transition);
    }

    .portal3d .header-tag:hover {
      background: rgba(14, 165, 233, 0.25);
      transform: scale(1.05);
    }

    /* MAIN SECTION */
    .portal3d main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 30px;
    }

    .portal3d .section-shell {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass);
      border-radius: var(--radius);
      padding: 25px;
      box-shadow: var(--shadow);
      animation: fadeIn 1s ease-out 0.2s both;
    }

    .portal3d .section-header {
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 15px;
    }

    .portal3d .section-title-wrap {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .portal3d .section-title {
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .portal3d .section-title i {
      color: var(--brand);
      font-size: 24px;
    }

    .portal3d .section-sub {
      font-size: 14px;
      color: var(--muted);
      max-width: 600px;
    }

    .portal3d .section-chip {
      padding: 8px 16px;
      background: rgba(14, 165, 233, 0.1);
      border: 1px dashed var(--brand);
      border-radius: 50px;
      font-size: 12px;
      font-weight: 600;
      color: var(--brand-light);
    }

    /* CARD GRID */
    .portal3d .card-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 25px;
    }

    .portal3d .card {
      background: rgba(30, 41, 59, 0.6);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      overflow: hidden;
      transition: var(--transition);
      position: relative;
      cursor: pointer;
      transform-style: preserve-3d;
      perspective: 1000px;
      height: 100%;
    }

    .portal3d .card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(14, 165, 233, 0.1), transparent);
      border-radius: 20px;
      opacity: 0;
      transition: opacity 0.4s;
    }

    .portal3d .card:hover {
      transform: translateY(-15px) rotateX(5deg);
      border-color: var(--brand);
      box-shadow: 0 30px 60px rgba(14, 165, 233, 0.3);
    }

    .portal3d .card:hover::before {
      opacity: 1;
    }

    .portal3d .card-img-wrap {
      position: relative;
      height: 180px;
      overflow: hidden;
    }

    .portal3d .card-img-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.6s;
    }

    .portal3d .card:hover .card-img-wrap img {
      transform: scale(1.1);
    }

    .portal3d .card-label {
      position: absolute;
      top: 15px;
      left: 15px;
      padding: 8px 15px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 50px;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
      backdrop-filter: blur(10px);
    }

    .portal3d .card-label i {
      color: var(--brand);
    }

    .portal3d .card-body {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: calc(100% - 180px);
    }

    .portal3d .card-title {
      font-size: 18px;
      font-weight: 700;
      color: white;
    }

    .portal3d .card-desc {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
      flex-grow: 1;
    }

    .portal3d .card-meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
    }

    .portal3d .card-meta-left {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: var(--brand-light);
    }

    .portal3d .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--brand);
      box-shadow: 0 0 10px var(--brand);
    }

    .portal3d .card-tag-mini {
      padding: 5px 12px;
      background: rgba(14, 165, 233, 0.1);
      border-radius: 50px;
      font-size: 11px;
      font-weight: 600;
      color: var(--brand-light);
    }

    .portal3d .card-footer {
      margin-top: auto;
    }

    .portal3d .pbtn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, var(--brand), var(--brand-dark));
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .portal3d .pbtn::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
      transform: rotate(45deg);
      transition: transform 0.6s;
    }

    .portal3d .pbtn:hover {
      transform: translateY(-3px);
      box-shadow: 0 15px 30px rgba(14, 165, 233, 0.4);
    }

    .portal3d .pbtn:hover::after {
      transform: rotate(45deg) translate(10%, 10%);
    }

    .portal3d .pbtn i {
      font-size: 16px;
    }

    /* FOOTER */
    .portal3d footer {
      animation: slideUp 0.8s ease-out 0.4s both;
      margin-top: 40px;
    }

    .portal3d .footer-card {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass);
      border-radius: var(--radius);
      padding: 20px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      box-shadow: var(--shadow);
    }

    .portal3d .footer-left {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .portal3d .footer-name {
      font-size: 16px;
      font-weight: 800;
      color: var(--brand);
      letter-spacing: 1px;
    }

    .portal3d .footer-right {
      display: flex;
      gap: 15px;
    }

    .portal3d .footer-link {
      padding: 10px 20px;
      background: rgba(14, 165, 233, 0.1);
      border: 1px solid rgba(14, 165, 233, 0.3);
      border-radius: 50px;
      color: var(--brand-light);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 600;
      transition: var(--transition);
    }

    .portal3d .footer-link:hover {
      background: rgba(14, 165, 233, 0.2);
      transform: translateY(-3px);
    }

    /* MODAL */
    .portal3d #page-modal {
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: none;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(20px);
    }

    .portal3d #page-modal.open {
      display: flex;
      animation: modalFadeIn 0.3s ease-out;
    }

    .portal3d .modal-inner {
      flex: 1;
      max-width: 1200px;
      margin: auto;
      padding: 20px;
      position: relative;
    }

    .portal3d .close-btn {
      position: absolute;
      top: 30px;
      right: 30px;
      width: 50px;
      height: 50px;
      background: rgba(14, 165, 233, 0.2);
      border: 2px solid var(--brand);
      border-radius: 50%;
      color: white;
      font-size: 20px;
      cursor: pointer;
      z-index: 1001;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .portal3d .close-btn:hover {
      background: var(--brand);
      transform: rotate(90deg);
    }

    .portal3d .modal-frame {
      width: 100%;
      height: 100%;
      border-radius: var(--radius);
      border: 2px solid var(--brand);
      background: white;
      box-shadow: 0 40px 80px rgba(0, 0, 0, 0.5);
    }

    /* ANIMATIONS */
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 0 30px var(--brand);
      }
      50% {
        box-shadow: 0 0 50px var(--brand-light);
      }
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    /* SCROLL PROGRESS BAR */
    .portal3d .scroll-progress {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: rgba(14, 165, 233, 0.1);
      z-index: 1000;
    }

    .portal3d .scroll-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--brand), var(--brand-light));
      width: 0%;
      transition: width 0.1s;
      box-shadow: 0 0 10px var(--brand);
    }

    /* SCROLL TO TOP BUTTON */
    .portal3d .scroll-to-top {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 50px;
      height: 50px;
      background: rgba(14, 165, 233, 0.2);
      border: 2px solid var(--brand);
      border-radius: 50%;
      color: white;
      font-size: 20px;
      cursor: pointer;
      z-index: 99;
      display: none;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
      backdrop-filter: blur(10px);
    }

    .portal3d .scroll-to-top:hover {
      background: var(--brand);
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(14, 165, 233, 0.3);
    }

    .portal3d .scroll-to-top.show {
      display: flex;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .portal3d .app {
        padding: 15px;
      }
      
      .portal3d .header-card {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }
      
      .portal3d .header-tag {
        margin-top: 10px;
      }
      
      .portal3d .card-list {
        grid-template-columns: 1fr;
      }
      
      .portal3d .footer-card {
        flex-direction: column;
        text-align: center;
        gap: 20px;
      }
      
      .portal3d .section-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .portal3d .scroll-to-top {
        bottom: 20px;
        right: 20px;
      }
    }

    @media (max-width: 480px) {
      .portal3d .header-title {
        font-size: 20px;
      }
      
      .portal3d .section-title {
        font-size: 18px;
      }
      
      .portal3d .card-title {
        font-size: 16px;
      }
    }

  /* small bridge styles for auth widgets inside portal header */
  .portal3d .headerRight {
    display:flex;
    align-items:center;
    gap:12px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }
  .portal3d .headerRight .btn {
    padding: 10px 14px;
    border-radius: 14px;
  }
  .portal3d .headerRight .profileMini {
    cursor:pointer;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.08);
    padding: 10px 12px;
    border-radius: 18px;
  }
  .portal3d .headerRight .bellBtn {
    width: 44px;
    height: 44px;
    border-radius: 999px;
  }
  @media (max-width: 768px){
    .portal3d .header-card { padding: 14px 16px; }
    .portal3d .headerRight { width:100%; justify-content:center; }
    .portal3d .logo-img { width: 62px; height: 62px; }
  }
  </style>
</head>
<body>

  <canvas class="seasonCanvas" id="seasonCanvas" style="display:none;"></canvas>
  <div class="toast" id="toast"></div>

  <div class="portal3d">
    <div class="scroll-progress">
      <div class="scroll-progress-bar" id="scrollProgress"></div>
    </div>

    <button class="scroll-to-top" id="scrollToTop" type="button" aria-label="Yuqoriga">
      <i class="fa-solid fa-arrow-up"></i>
    </button>

    <canvas id="three-canvas"></canvas>

    <div class="app">
      <header>
        <div class="header-card">
          <img src="logo.png" alt="LeaderMath.UZ" class="logo-img">
          <div class="header-text">
            <div class="header-title">LeaderMath.UZ</div>
            <div class="header-sub" id="dt">‚Äî</div>
          </div>

          <div class="headerRight">
            <div class="profileMini" id="profileMini" title="Profil / Avatar">
              <img class="avatarImg" id="userAvatar" alt="Avatar" src="" />
              <div style="display:flex; flex-direction:column; line-height:1.1;">
                <div class="line1"><span id="userName">‚Äî</span> ¬∑ <b id="userId">‚Äî</b></div>
                <div class="line2">
                  <span>üèÜ <b id="userPoints">0</b></span>
                  <span>üí∞ <b id="userBalance">0</b></span>
                  <span class="muted">üéÇ <span id="userAge">‚Äî</span></span>
                </div>
              </div>
            </div>

            <button class="iconBtn bellBtn" id="btnBell" type="button" aria-label="Bildirishnomalar" title="Bildirishnomalar">
              üîî <span class="badge" id="notifBadge" aria-label="o‚Äòqilmagan">0</span>
            </button>

            <button class="btn" id="btnLogout" type="button">Chiqish</button>
          </div>
        </div>
      </header>

      <main>
        <div class="section-shell" style="text-align:center;">
          <div class="section-title">
            <i class="fa-solid fa-hand-pointer"></i>
            Xush kelibsiz!
          </div>
          <div class="section-sub" style="margin-top:10px;">
            3D fon + premium kartalar. Bo‚Äòlimni tanlang ‚Äî sahifa ochiladi.
          </div>
        </div>

        <section class="section-shell">
          <div class="section-header">
            <div class="section-title-wrap">
              <div class="section-title">
                <i class="fa-solid fa-cube"></i>
                Bo‚Äòlimlar
              </div>
              <div class="section-sub">Online challenge, exam, play va testlar</div>
            </div>
            <div class="section-chip">Karta ‚Üí ochiladi</div>
          </div>

          <div class="card-list" id="sections"></div>
        </section>

        <div class="section-shell">
          <div class="section-title" style="text-align:center; margin-bottom:20px;">
            <i class="fa-solid fa-sliders"></i>
            3D Effektlar
          </div>
          <div style="display:flex; justify-content:center; gap:15px; flex-wrap:wrap;">
            <button id="effect-rotate" class="pbtn" style="width:auto; padding:12px 24px;" type="button">
              <i class="fa-solid fa-rotate"></i> Aylantirish
            </button>
            <button id="effect-zoom" class="pbtn" style="width:auto; padding:12px 24px;" type="button">
              <i class="fa-solid fa-magnifying-glass"></i> Zoom
            </button>
            <button id="effect-particles" class="pbtn" style="width:auto; padding:12px 24px;" type="button">
              <i class="fa-solid fa-sparkles"></i> Zarralar
            </button>
            <button id="effect-reset" class="pbtn" style="width:auto; padding:12px 24px; background: linear-gradient(135deg, #64748b, #475569);" type="button">
              <i class="fa-solid fa-rotate-left"></i> Reset
            </button>
          </div>
        </div>

      </main>

      <footer>
        <div class="footer-card">
          <div class="footer-left">
            <div class="footer-name">LeaderMath.UZ</div>
            <div>3D portal dizayn ‚Ä¢ Login/Profil/Reyting/Izohlar tizimi ulangan</div>
            <div style="font-size:12px; color: var(--muted); margin-top:10px;">¬© 2025 LeaderMath.UZ</div>
          </div>
          <div class="footer-right">
            <a href="#" class="footer-link"><i class="fa-brands fa-telegram"></i> Telegram</a>
            <a href="#" class="footer-link"><i class="fa-solid fa-headset"></i> Yordam</a>
          </div>
        </div>
      </footer>

    </div>
  </div>

  <!-- Side Panel Toggle (Reyting / Sharhlar) -->
  <button class="sideFab" id="sidePanelBtn" type="button" aria-label="Reyting va sharhlar paneli" title="Reyting / Sharhlar">
    <span class="sideFabIcon">üèÜüí¨<small>TOP</small></span>
  </button>

  <div class="sideOverlay" id="sidePanelOverlay" aria-hidden="true">
    <aside class="sidePanel glass" id="sidePanel" role="dialog" aria-modal="true" aria-label="Reyting va sharhlar">
      <div class="sideHead">
        <div>
          <div class="sideTitle">Reyting & Sharhlar</div>
          <div class="small">Top-20 preview ‚Ä¢ ‚ÄúBarchasini ko‚Äòrish‚Äù bilan to‚Äòliq</div>
        </div>
        <button class="iconBtn" id="sideClose" type="button" aria-label="Yopish">‚úï</button>
      </div>

      <div class="sideTabs" role="tablist" aria-label="Panel tablari">
        <button class="tabBtn active" id="sideTabLb" type="button" role="tab" aria-selected="true">Reyting</button>
        <button class="tabBtn" id="sideTabComments" type="button" role="tab" aria-selected="false">Sharhlar</button>
      </div>

      <div class="sideBody">
        <div class="sidePane active" id="sidePaneLb" role="tabpanel">
          <div class="glass" style="padding:14px;">
          <div class="panelHead">
            <div>
              <div class="nameLine">Reyting</div>
              <div class="small">Top-20 (point bo‚Äòyicha) ‚Ä¢ Podium + qidiruv</div>
            </div>
            <button class="linkBtn" id="btnLbAll" type="button">Barchasini ko‚Äòrish</button>
          </div>

          <div class="lbTools">
            <input class="lbSearch" id="lbSearch" placeholder="Qidirish (ID yoki ism)‚Ä¶" />
            <button class="chipBtn" id="lbOnlyMe" type="button" aria-pressed="false">‚≠ê Meni</button>
          </div>

          <div class="lbPodium" id="lbPodium" aria-label="Top-3 podium"></div>
          <table class="table" aria-label="Leaderboard">
            <thead>
              <tr>
                <th style="width:60px;">#</th>
                <th>Foydalanuvchi</th>
                <th style="width:90px;">Ball</th>
              </tr>
            </thead>
            <tbody id="lbBody">
              <tr><td colspan="3" class="small">Yuklanmoqda‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
        </div>

        <div class="sidePane" id="sidePaneComments" role="tabpanel">
          <div class="glass" style="padding:14px;">
          <div class="panelHead">
            <div>
              <div class="nameLine">Izohlar</div>
              <div class="small">Barcha izohlar (paging) ‚Ä¢ like + reply</div>
            </div>
            <div style="display:flex;align-items:center;gap:10px;">
              <span class="pill" id="commentCount">20</span>
            </div>
          </div>

          <div class="commentBox">
            <input id="commentInput" maxlength="140" placeholder="Izoh yozing‚Ä¶ (140 ta belgi)"/>
            <button class="btn btnPrimary" id="commentSend" type="button">Yuborish</button>
          </div>

          <div class="hr"></div>
          <ul class="commentList" id="commentList"></ul>

          <div style="height:10px;"></div>
          <button class="btn" id="cmLoadMoreInline" type="button">Yana yuklash</button>
        </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Leaderboard Modal -->
  <div class="modalOverlay modalApp" id="lbModal" aria-hidden="true">
    <div class="modal glass" role="dialog" aria-modal="true" aria-label="Reyting">
      <div class="modalHead">
        <div>
          <div class="modalTitle">Reyting ‚Äî barcha o‚Äòrinlar</div>
          <div class="small" id="lbModalHint">Point bo‚Äòyicha saralangan</div>
        </div>
        <button class="iconBtn" id="lbModalClose" type="button" aria-label="Yopish">‚úï</button>
      </div>
      <div class="hr"></div>
      <div class="modalBody">
        <table class="table" aria-label="Leaderboard all">
          <thead>
            <tr>
              <th style="width:60px;">#</th>
              <th>Foydalanuvchi</th>
              <th style="width:90px;">Ball</th>
            </tr>
          </thead>
          <tbody id="lbAllBody">
            <tr><td colspan="3" class="small">Yuklanmoqda‚Ä¶</td></tr>
          </tbody>
        </table>
        <div style="height:10px;"></div>
        <button class="btn" id="lbLoadMore" type="button">Yana yuklash</button>
      </div>
    </div>
  </div>

  <!-- Notifications Modal -->
  <div class="modalOverlay modalApp" id="notifModal" aria-hidden="true">
    <div class="modal glass" role="dialog" aria-modal="true" aria-label="Bildirishnomalar">
      <div class="modalHead">
        <div>
          <div class="modalTitle">Bildirishnomalar</div>
          <div class="small" id="notifHint">Yangi xabarlar shu yerda chiqadi</div>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
          <button class="chipBtn" id="notifMarkAll" type="button">‚úÖ Hammasini o‚Äòqildi</button>
          <button class="iconBtn" id="notifClose" type="button" aria-label="Yopish">‚úï</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="modalBody">
        <ul class="notifList" id="notifList"></ul>
        <div style="height:10px;"></div>
        <button class="btn" id="notifLoadMore" type="button">Yana yuklash</button>
      </div>
    </div>
  </div>

  <!-- Avatar Picker Modal -->
  <div class="modalOverlay modalApp" id="avatarModal" aria-hidden="true">
    <div class="modal glass" role="dialog" aria-modal="true" aria-label="Avatar tanlash">
      <div class="modalHead">
        <div>
          <div class="modalTitle">Avatar tanlang</div>
          <div class="small">avatar/1.png, 2.png, 3.png... papkadan avtomatik topiladi</div>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
          <button class="chipBtn" id="avatarRefresh" type="button">üîÑ Qayta tekshir</button>
          <button class="iconBtn" id="avatarClose" type="button" aria-label="Yopish">‚úï</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="modalBody">
        <div class="avatarGrid" id="avatarGrid"></div>
        <div class="small muted" id="avatarHint" style="margin-top:10px;">Yuklanmoqda‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- Onboarding overlay -->
  <div id="onboardOverlay" style="display:none; position:fixed; inset:0; background: rgba(2,6,23,.55); backdrop-filter: blur(10px); z-index: 9998;">
    <div class="container" style="display:flex; align-items:center; justify-content:center; min-height: 100%;">
      <div class="glass section" style="max-width: 520px; width: 100%;">
        <div class="sectionTitle">
          <h2>Profilni to‚Äòldiring</h2>
          <div class="hint">Birinchi kirishda</div>
        </div>
        <p class="p">Ism, familiya, tug‚Äòilgan sana va yangi parolni kiriting.</p>
        <div class="hr"></div>

        <div class="row">
          <input class="input" id="obFirst" placeholder="Ism"/>
          <input class="input" id="obLast" placeholder="Familiya"/>
        </div>
        <div style="height:10px;"></div>
        <div class="row">
          <input class="input" id="obBirth" type="date" placeholder="Tug‚Äòilgan sana (YYYY-MM-DD)"/>
          <input class="input" id="obPass1" type="password" placeholder="Yangi parol"/>
        </div>
        <div style="height:10px;"></div>
        <div class="row">
          <input class="input" id="obPass2" type="password" placeholder="Yangi parolni takrorlang"/>
          <div></div>
        </div>

        <div style="height:12px;"></div>
        <button class="btn btnPrimary" id="obSave" style="width:100%;">Saqlash va davom etish</button>
        <div class="small" style="margin-top:10px;">‚ö†Ô∏è Parolni eslab qoling. Keyingi kirishda shu parol ishlaydi.</div>
      </div>
    </div>
  </div>

<script type="module">
    import { initSeasons } from "./assets/js/seasons.js";
    initSeasons("seasonCanvas");
  </script>

<script type="module">
    import { me, logout, updateProfile, changePassword, setAvatar, getToken } from "./assets/js/auth.js";
    import { api } from "./assets/js/api.js";

    const $ = (id)=>document.getElementById(id);

    // UZ date formatter
    const months = ["yanvar","fevral","mart","aprel","may","iyun","iyul","avgust","sentabr","oktabr","noyabr","dekabr"];
    const days = ["yakshanba","dushanba","seshanba","chorshanba","payshanba","juma","shanba"];
    function setDate(){
      const d = new Date();
      const s = `${days[d.getDay()]}, ${d.getDate()}-${months[d.getMonth()]} ${d.getFullYear()} ‚Ä¢ ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      $("dt").textContent = s;
    }
    setDate(); setInterval(setDate, 15000);

    // Toast
    const toastEl = $("toast");
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=>toastEl.classList.remove("show"), 1800);
    }

    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
    }

    // Simple modal helpers
    function openModal(el){
      if(!el) return;
      el.style.display = "flex";
      el.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
    }
    function closeModal(el){
      if(!el) return;
      el.style.display = "none";
      el.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
    }

    function calcAgePrecise(iso){
      if(!iso) return "‚Äî";
      const b = new Date(iso);
      if(Number.isNaN(b.getTime())) return "‚Äî";
      const n = new Date();
      let y=n.getFullYear()-b.getFullYear();
      let m=n.getMonth()-b.getMonth();
      let d=n.getDate()-b.getDate();
      if(d<0){ m--; d += new Date(n.getFullYear(), n.getMonth(), 0).getDate(); }
      if(m<0){ y--; m+=12; }
      return `${y} yosh ${m} oy ${d} kun`;
    }

    // Avatar helpers (auto-detect avatar/1.png,2.png...) by probing images
    function avatarUrl(id){
      if(!id) return "";
      return `avatar/${id}.png`;
    }
    function setUserAvatar(id){
      const img = $("userAvatar");
      if(!img) return;
      const src = avatarUrl(id);
      if(!src){
        img.removeAttribute("src");
        img.dataset.avatarId = "";
        return;
      }
      img.src = src;
      img.dataset.avatarId = String(id);
      img.onerror = ()=>{
        img.removeAttribute("src");
        img.dataset.avatarId = "";
      };
    }

    async function probeAvatar(id){
      return new Promise((resolve)=>{
        const im = new Image();
        const t = setTimeout(()=>resolve(false), 900);
        im.onload = ()=>{ clearTimeout(t); resolve(true); };
        im.onerror = ()=>{ clearTimeout(t); resolve(false); };
        im.src = avatarUrl(id) + `?v=${Date.now()}`;
      });
    }

    async function loadAvatarGrid(){
      const grid = $("avatarGrid");
      const hint = $("avatarHint");
      if(!grid) return;
      grid.innerHTML = "";
      hint.textContent = "Tekshirilmoqda‚Ä¶";
      const found = [];
      // probe 1..60 (fast) and keep those that exist
      for(let i=1;i<=60;i++){
        // eslint-disable-next-line no-await-in-loop
        const ok = await probeAvatar(i);
        if(ok) found.push(i);
      }
      if(!found.length){
        hint.textContent = "avatar/ papkada 1.png,2.png... topilmadi (kamida bitta rasm qo‚Äòying)";
        return;
      }
      const cur = Number($("userAvatar")?.dataset?.avatarId || 0);
      grid.innerHTML = found.map(i=>`
        <button class="avaBtn ${i===cur?"active":""}" type="button" data-ava="${i}">
          <img alt="Avatar ${i}" src="${avatarUrl(i)}" />
          <div class="small">#${i}</div>
        </button>
      `).join("");
      hint.textContent = `${found.length} ta avatar topildi`;
    }

    function setupAvatarPicker(){
      const modal = $("avatarModal");
      const openTargets = [$("profileMini"), $("userAvatar")].filter(Boolean);
      const closeBtn = $("avatarClose");
      const refresh = $("avatarRefresh");
      openTargets.forEach(el=>el.addEventListener("click", async ()=>{
        openModal(modal);
        await loadAvatarGrid();
      }));
      closeBtn?.addEventListener("click", ()=>closeModal(modal));
      modal?.addEventListener("click", (e)=>{ if(e.target===modal) closeModal(modal); });
      refresh?.addEventListener("click", loadAvatarGrid);
      $("avatarGrid")?.addEventListener("click", async (e)=>{
        const b = e.target.closest("[data-ava]");
        if(!b) return;
        const id = Number(b.getAttribute("data-ava"));
        try{
          b.disabled = true;
          const r = await setAvatar(id);
          setUserAvatar(r.user?.avatarId || id);
          toast("Avatar saqlandi");
          await loadAvatarGrid();
        }catch(err){
          toast(err.message||"Xatolik");
        }finally{
          b.disabled = false;
        }
      });
    }

    // Feature cards (TEST Builder faqat admin ko‚Äòrsin)
    let FEATURES = [
      { title:"Online Challenge", desc:"Kunlik/haftalik jonli masalalar", img:"assets/images/online_challenge.svg", href:"challenge.html" },
      { title:"EXAM", desc:"Imtihon rejimi: vaqt, ball, natija", img:"assets/images/exam.svg", href:"exam.html" },
      { title:"PLAY", desc:"O‚Äòyin tarzida mantiqiy mashqlar", img:"assets/images/play.svg", href:"play.html" },
      { title:"TEST", desc:"Oddiy test (JSON) + Challenge (kod bilan)", img:"assets/images/exam.svg", href:"test.html" },
    ];

        function renderSections(){
      const root = $("sections");
      // Index1-card style renderer
      root.innerHTML = FEATURES.map((f, idx)=>`
        <div class="card" tabindex="0" data-href="${f.href}">
          <div class="card-img-wrap">
            <img src="${f.img}" alt="${f.title}" loading="lazy">
            <div class="card-label">
              <i class="fa-solid fa-bolt"></i> ${escapeHtml(f.title)}
            </div>
          </div>
          <div class="card-body">
            <div class="card-title">${escapeHtml(f.title)}</div>
            <div class="card-desc">${escapeHtml(f.desc)}</div>
            <div class="card-meta-row">
              <div class="card-meta-left">
                <span class="dot"></span>
                <span>Ochish</span>
              </div>
              <span class="card-tag-mini">${escapeHtml(f.tag || "LeaderMath")}</span>
            </div>
            <div class="card-footer">
              <button class="pbtn" type="button">
                <i class="fa-solid fa-play"></i> Boshlash
              </button>
            </div>
          </div>
        </div>
      `).join("");

      root.addEventListener("click", (e)=>{
        const card = e.target.closest(".card");
        if(!card) return;
        const href = card.getAttribute("data-href");
        if(href) location.href = href;
      }, { passive:true });

      root.addEventListener("keydown", (e)=>{
        if(e.key !== "Enter") return;
        const card = e.target.closest(".card");
        if(card){
          const href = card.getAttribute("data-href");
          if(href) location.href = href;
        }
      });
    }, { passive:true });

      root.addEventListener("keydown", (e)=>{
        if(e.key !== "Enter") return;
        const card = e.target.closest(".featureCard");
        if(card){
          const href = card.getAttribute("data-href");
          if(href) location.href = href;
        }
      });
    }

    async function runOnboarding(){
      return new Promise((resolve)=>{
        const overlay=$("onboardOverlay");
        const bSave=$("obSave");
        overlay.style.display="flex";
        bSave.onclick = async ()=>{
          bSave.disabled=true;
          try{
            const first=$("obFirst").value.trim();
            const last=$("obLast").value.trim();
            const birth=$("obBirth").value.trim();
            const p1=$("obPass1").value, p2=$("obPass2").value;
            if(first.length<2) throw new Error("Ism kamida 2 ta harf bo‚Äòlsin");
            if(last.length<2) throw new Error("Familiya kamida 2 ta harf bo‚Äòlsin");
            if(!birth) throw new Error("Tug‚Äòilgan sanani kiriting");
            if(p1.length<6) throw new Error("Yangi parol kamida 6 belgidan iborat bo‚Äòlsin");
            if(p1!==p2) throw new Error("Parollar mos emas");
            await changePassword(p1);
            await updateProfile(first,last,birth);
            overlay.style.display="none";
            resolve(true);
          }catch(e){ toast(e.message||"Xatolik"); }
          finally{ bSave.disabled=false; }
        };
      });
    }

    // Leaderboard (interactive)
    let lbAll = [];
    let lbMeOnly = false;
    let lbQuery = "";
    let myLoginId = null;

    function medal(i){
      return i===0 ? "ü•á" : i===1 ? "ü•à" : i===2 ? "ü•â" : "";
    }

    function renderLeaderboard(){
      const body = $("lbBody");
      const podium = $("lbPodium");
      const q = (lbQuery||"").toLowerCase();

      let items = lbAll.slice();
      if(lbMeOnly && myLoginId){
        items = items.filter(u=>String(u.loginId||"")===String(myLoginId));
      }
      if(q){
        items = items.filter(u=>
          String(u.loginId||"").toLowerCase().includes(q) ||
          String(u.name||"").toLowerCase().includes(q)
        );
      }

      const top = items.slice(0,3);
      const topPts = Number(top?.[0]?.points || 0) || 1;

      // Podium (Top-3)
      podium.innerHTML = top.map((u,i)=>{
        const pts = Number(u.points||0);
        const pct = Math.max(8, Math.round((pts/topPts)*100));
        const me = myLoginId && String(u.loginId||"")===String(myLoginId);
        return `
          <button class="podCard ${me?"me":""}" type="button" data-pick="${escapeHtml(u.loginId||"")}" title="${escapeHtml(u.name||u.loginId||"")}">
            <div class="podTop">
              <div class="podMedal">${medal(i)}</div>
              <div class="podRank">#${i+1}</div>
            </div>
            <div class="podName">${escapeHtml(u.name || u.loginId || "‚Äî")}</div>
            <div class="podId">${escapeHtml(u.loginId || "")}</div>
            <div class="podBar"><span style="width:${pct}%"></span></div>
            <div class="podPts">${pts} ball</div>
          </button>
        `;
      }).join("") || `<div class="small">Hozircha reyting yo‚Äòq</div>`;

      // Table (Top-20 of filtered)
      const show = items.slice(0,20);
      body.innerHTML = show.map((u,i)=>{
        const pts = Number(u.points||0);
        const me = myLoginId && String(u.loginId||"")===String(myLoginId);
        const pct = Math.max(6, Math.round((pts/topPts)*100));
        return `
          <tr class="lbRow ${me?"me":""}" data-pick="${escapeHtml(u.loginId||"")}">
            <td><span class="rankBadge">${i+1}</span></td>
            <td>
              <div class="nameLine">${escapeHtml(u.name || u.loginId || "‚Äî")}</div>
              <div class="small">${escapeHtml(u.loginId || "")}</div>
              <div class="miniBar"><span style="width:${pct}%"></span></div>
            </td>
            <td><b>${pts}</b></td>
          </tr>
        `;
      }).join("") || `<tr><td colspan="3" class="small">Mos natija topilmadi</td></tr>`;
    }

    async function loadLeaderboard(){
      const body = $("lbBody");
      body.innerHTML = `<tr><td colspan="3" class="small">Yuklanmoqda‚Ä¶</td></tr>`;
      try{
        const data = await api("leaderboard", { query: { limit: 120 } });
        lbAll = (data?.items || []);
        renderLeaderboard();
      }catch(_){
        body.innerHTML = `<tr><td colspan="3" class="small">Reytingni yuklab bo‚Äòlmadi</td></tr>`;
      }
    }

    // ===== Leaderboard modal (all with paging) =====
    let lbCursor = null;
    let lbRankBase = 0;
    async function loadLeaderboardMore(reset=false){
      const body = $("lbAllBody");
      const btn = $("lbLoadMore");
      try{
        btn.disabled = true;
        if(reset){
          lbCursor = null;
          lbRankBase = 0;
          body.innerHTML = `<tr><td colspan="3" class="small">Yuklanmoqda‚Ä¶</td></tr>`;
        }
        const data = await api("leaderboard", { query: { limit: 60, cursor: lbCursor } });
        const items = data?.items || [];
        if(reset) body.innerHTML = "";
        body.insertAdjacentHTML("beforeend", items.map((u,i)=>`
          <tr>
            <td><span class="rankBadge">${lbRankBase + i + 1}</span></td>
            <td>
              <div class="nameLine">${escapeHtml(u.name || u.loginId || "‚Äî")}</div>
              <div class="small">${escapeHtml(u.loginId || "")}</div>
            </td>
            <td><b>${Number(u.points||0)}</b></td>
          </tr>
        `).join(""));
        lbRankBase += items.length;
        lbCursor = data?.nextCursor || null;
        btn.style.display = lbCursor ? "inline-flex" : "none";
        if(!items.length && reset){
          body.innerHTML = `<tr><td colspan="3" class="small">Hozircha reyting yo‚Äòq</td></tr>`;
          btn.style.display = "none";
        }
      }catch(_){
        if(reset) body.innerHTML = `<tr><td colspan="3" class="small">Reytingni yuklab bo‚Äòlmadi</td></tr>`;
      }finally{
        btn.disabled = false;
      }
    }

    // Comments
    function fmtTime(ts){
      const d = ts ? new Date(ts) : new Date();
      return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }
    let likedSet = new Set();

    function renderReplies(replies){
      const items = (replies||[]).map(r=>`
        <li class="replyItem">
          <div class="top">
            <div class="nameLine">${escapeHtml(r.name || r.loginId || "‚Äî")}</div>
            <div class="small">${escapeHtml(fmtTime(r.createdAt))}</div>
          </div>
          <div class="replyText">${escapeHtml(r.text || "")}</div>
        </li>
      `).join("");
      return items || `<li class="small">Hozircha javob yo‚Äòq</li>`;
    }

    function renderCommentItem(c){
      const liked = likedSet.has(String(c.id));
      const isOwner = myLoginId && String(c.loginId||"") === String(myLoginId);
      const edited = c.edited === true;
      return `
        <li class="commentItem" data-id="${escapeHtml(c.id)}">
          <div class="top">
            <div class="nameLine">${escapeHtml(c.name || c.loginId || "‚Äî")}</div>
            <div class="small">${escapeHtml(fmtTime(c.createdAt))}</div>
          </div>
          <div class="commentText" data-role="text">${escapeHtml(c.text || "")}</div>
          ${edited ? `<div class="small editedTag">tahrirlangan</div>` : ``}

          ${isOwner ? `
            <div class="ownerActions">
              <button class="miniBtn" data-act="edit" type="button" title="Tahrirlash">‚úé</button>
              <button class="miniBtn danger" data-act="delete" type="button" title="O‚Äòchirish">üóë</button>
            </div>
          ` : ``}

          <div class="commentActions compact">
            <button class="actBtn ${liked?"liked":""}" data-act="like" type="button" aria-label="Like">
              <span class="ic">‚ù§</span>
              <span class="lbl">Like</span>
              <span class="cnt" data-k="likeCount">${Number(c.likeCount||0)}</span>
            </button>
            <button class="actBtn" data-act="toggleReplies" type="button" aria-label="Javoblar">
              <span class="ic">‚Ü©</span>
              <span class="lbl">Reply</span>
              <span class="cnt" data-k="replyCount">${Number(c.replyCount||0)}</span>
            </button>
          </div>

          <div class="repliesWrap" data-open="0">
            <ul class="replyList" data-loaded="0"></ul>
            <div class="replyBox">
              <input class="replyInput" maxlength="160" placeholder="Javob yozing‚Ä¶ (160)" />
              <button class="btn btnPrimary replySend" data-act="sendReply" type="button">Yuborish</button>
            </div>
          </div>
        </li>
      `;
    }

    async function loadLiked(){
      likedSet = new Set();
      try{
        const token = await getToken();
        const data = await api("comments/liked", { token });
        for(const id of (data?.ids || [])) likedSet.add(String(id));
      }catch(_){ /* ignore */ }
    }

    // ===== Comments (always show all, paging in the panel) =====
    let cmCursor = null;
    async function loadComments(reset=false){
      const list = $("commentList");
      const btn = $("cmLoadMoreInline");
      const count = $("commentCount");
      try{
        btn.disabled = true;
        if(reset){
          cmCursor = null;
          list.innerHTML = `<li class="small">Yuklanmoqda‚Ä¶</li>`;
        }
        await loadLiked();
        const data = await api("comments", { query: { limit: 30, cursor: cmCursor } });
        const items = data?.items || [];
        if(reset) list.innerHTML = "";
        list.insertAdjacentHTML("beforeend", items.map(renderCommentItem).join(""));
        cmCursor = data?.nextCursor || null;
        btn.style.display = cmCursor ? "inline-flex" : "none";
        // total (if server returns it), else show loaded count
        const total = Number(data?.total || 0);
        const loaded = list.querySelectorAll(".commentItem").length;
        count.textContent = total ? String(total) : String(loaded);
        if(!items.length && reset){
          list.innerHTML = `<li class="small">Hozircha izoh yo‚Äòq. Birinchi bo‚Äòling üôÇ</li>`;
          btn.style.display = "none";
          count.textContent = "0";
        }
      }catch(_){
        if(reset) list.innerHTML = `<li class="small">Izohlarni yuklab bo‚Äòlmadi</li>`;
      }finally{
        btn.disabled = false;
      }
    }

    async function loadReplies(commentId, li){
      const wrap = li.querySelector(".repliesWrap");
      const ul = li.querySelector(".replyList");
      if(!wrap || !ul) return;
      try{
        const data = await api("comments/replies", { method:"POST", body:{ commentId, limit: 30 } });
        ul.innerHTML = renderReplies(data?.items || []);
        ul.setAttribute("data-loaded","1");
      }catch(_){
        ul.innerHTML = `<li class="small">Javoblarni yuklab bo‚Äòlmadi</li>`;
      }
    }

    function setRepliesOpen(li, open){
      const wrap = li.querySelector(".repliesWrap");
      if(!wrap) return;
      wrap.setAttribute("data-open", open?"1":"0");
    }

    // Delegated actions on comment lists (preview + modal)
    async function handleCommentActions(e){
      const btn = e.target.closest("button[data-act]");
      if(!btn) return;
      const li = e.target.closest(".commentItem");
      if(!li) return;
      const id = li.getAttribute("data-id");
      const act = btn.getAttribute("data-act");

      if(act === "like"){
        try{
          const token = await getToken();
          const out = await api("comments/like", { method:"POST", token, body:{ commentId: id } });
          const liked = !!out.liked;
          if(liked) likedSet.add(String(id)); else likedSet.delete(String(id));
          btn.classList.toggle("liked", liked);
          const cnt = li.querySelector('[data-k="likeCount"]');
          if(cnt) cnt.textContent = String(out.likeCount ?? 0);
        }catch(_){ toast("Like uchun kirish kerak"); }
        return;
      }

      if(act === "toggleReplies"){
        const wrap = li.querySelector(".repliesWrap");
        const isOpen = wrap?.getAttribute("data-open") === "1";
        setRepliesOpen(li, !isOpen);
        const ul = li.querySelector(".replyList");
        if(!isOpen && ul && ul.getAttribute("data-loaded") !== "1"){
          await loadReplies(id, li);
        }
        return;
      }

      if(act === "sendReply"){
        const input = li.querySelector(".replyInput");
        const text = (input?.value || "").trim();
        if(!text) return toast("Javob bo‚Äòsh");
        try{
          const token = await getToken();
          btn.disabled = true;
          await api("comments/reply", { method:"POST", token, body:{ commentId: id, text } });
          if(input) input.value = "";
          toast("Javob yuborildi ‚úÖ");
          // update reply count UI
          const rc = li.querySelector('[data-k="replyCount"]');
          if(rc) rc.textContent = String(Number(rc.textContent||0) + 1);
          await loadReplies(id, li);
          setRepliesOpen(li, true);
        }catch(_){ toast("Reply uchun kirish kerak"); }
        finally{ btn.disabled = false; }
        return;
      }

      if(act === "edit"){
        const textEl = li.querySelector('[data-role="text"]');
        const cur = textEl ? (textEl.textContent || "") : "";
        // swap to editor
        li.classList.add("editing");
        if(textEl){
          textEl.innerHTML = `
            <textarea class="editArea" maxlength="140">${escapeHtml(cur)}</textarea>
            <div class="editBar">
              <button class="btn btnPrimary btnSm" data-act="saveEdit" type="button">Saqlash</button>
              <button class="btn btnSm" data-act="cancelEdit" type="button">Bekor</button>
            </div>
          `;
        }
        return;
      }

      if(act === "cancelEdit"){
        // easiest: reload comments to restore template
        await loadComments(true);
        return;
      }

      if(act === "saveEdit"){
        const area = li.querySelector(".editArea");
        const text = (area?.value || "").trim();
        if(!text) return toast("Izoh bo‚Äòsh");
        try{
          const token = await getToken();
          btn.disabled = true;
          await api("comments/update", { method:"POST", token, body:{ commentId: id, text } });
          toast("Tahrirlandi ‚úÖ");
          await loadComments(true);
        }catch(_){ toast("Tahrirlash uchun ruxsat yo‚Äòq"); }
        finally{ btn.disabled = false; }
        return;
      }

      if(act === "delete"){
        if(!confirm("Izoh o‚Äòchirilsinmi?")) return;
        try{
          const token = await getToken();
          btn.disabled = true;
          await api("comments/delete", { method:"POST", token, body:{ commentId: id } });
          toast("O‚Äòchirildi ‚úÖ");
          await loadComments(true);
        }catch(_){ toast("O‚Äòchirish uchun ruxsat yo‚Äòq"); }
        finally{ btn.disabled = false; }
        return;
      }
    }

    $("commentList").addEventListener("click", handleCommentActions, { passive:false });
    async function sendComment(){
      const input = $("commentInput");
      const text = (input.value||"").trim();
      if(!text) return toast("Izoh bo‚Äòsh");
      input.value = "";
      try{
        const token = await getToken();
        await api("comments", { method:"POST", token, body: { text } });
        toast("Yuborildi ‚úÖ");
        await loadComments(true);
      }catch(e){
        toast("Xato: yuborilmadi");
      }
    }

    // Modal wiring (leaderboard only)
    const lbModal = $("lbModal");
    $("btnLbAll").onclick = async ()=>{ openModal(lbModal); await loadLeaderboardMore(true); };
    $("lbModalClose").onclick = ()=>closeModal(lbModal);
    $("lbLoadMore").onclick = ()=>loadLeaderboardMore(false);

    // close on backdrop click
    lbModal.addEventListener("click", (e)=>{ if(e.target === lbModal) closeModal(lbModal); });

    // ===== Notifications =====
    const notifModal = $("notifModal");
    let notifCursor = null;
    async function refreshUnread(){
      try{
        const token = await getToken();
        const d = await api("notifications/unread-count", { token });
        const n = Number(d?.unreadCount||0);
        const b = $("notifBadge");
        const bell = $("btnBell");
        if(b){
          b.textContent = String(n);
          b.style.display = n>0 ? "inline-flex" : "none";
        }
        if(bell) bell.classList.toggle("hasUnread", n>0);
      }catch(_){
        const b = $("notifBadge");
        if(b) b.style.display = "none";
        const bell = $("btnBell");
        if(bell) bell.classList.remove("hasUnread");
      }
    }

    function renderNotifItem(n){
      const read = !!n.read;
      return `
        <li class="notifItem ${read?"read":"unread"}" data-id="${escapeHtml(n.id)}">
          <div class="top">
            <div class="nameLine">${escapeHtml(n.title||"Xabar")}</div>
            <div class="small">${escapeHtml(fmtTime(n.createdAt))}</div>
          </div>
          <div class="notifBody">${escapeHtml(n.body||"")}</div>
          <div class="notifActions">
            <button class="miniBtn ghost" data-act="delNotif" type="button" aria-label="O‚Äòchirish">üóë</button>
            ${read?"":"<button class=\"miniBtn\" data-act=\"readNotif\" type=\"button\">O‚Äòqildi</button>"}
          </div>
        </li>
      `;
    }

    async function loadNotifs(reset=false){
      const list = $("notifList");
      const btn = $("notifLoadMore");
      try{
        btn.disabled = true;
        if(reset){
          notifCursor = null;
          list.innerHTML = `<li class="small">Yuklanmoqda‚Ä¶</li>`;
        }
        const token = await getToken();
        const data = await api("notifications", { token, query:{ limit: 20, cursor: notifCursor } });
        const items = data?.items || [];
        if(reset) list.innerHTML = "";
        list.insertAdjacentHTML("beforeend", items.map(renderNotifItem).join(""));
        notifCursor = data?.nextCursor || null;
        btn.style.display = notifCursor ? "inline-flex" : "none";
        const unreadCount = Number(data?.unreadCount||0);
        const b = $("notifBadge");
        if(b){
          b.textContent = String(unreadCount);
          b.style.display = unreadCount>0 ? "inline-flex" : "none";
        }
        if(!items.length && reset){
          list.innerHTML = `<li class="small">Hozircha bildirishnoma yo‚Äòq üôÇ</li>`;
          btn.style.display = "none";
        }
      }catch(_){
        if(reset) $("notifList").innerHTML = `<li class="small">Yuklab bo‚Äòlmadi</li>`;
      }finally{ btn.disabled = false; }
    }

    async function markNotifRead(id){
      const token = await getToken();
      await api("notifications/read", { method:"POST", token, body:{ id } });
    }
    async function deleteNotif(id){
      const token = await getToken();
      await api("notifications/delete", { method:"POST", token, body:{ id } });
    }
    async function markAllRead(){
      const token = await getToken();
      await api("notifications/read", { method:"POST", token, body:{ all:true } });
    }

    $("btnBell")?.addEventListener("click", async ()=>{ openModal(notifModal); await loadNotifs(true); });
    $("notifClose")?.addEventListener("click", ()=>closeModal(notifModal));
    $("notifLoadMore")?.addEventListener("click", ()=>loadNotifs(false));
    $("notifMarkAll")?.addEventListener("click", async ()=>{ try{ await markAllRead(); await loadNotifs(true); await refreshUnread(); }catch(_){ toast("Xato"); } });
    notifModal.addEventListener("click", (e)=>{ if(e.target===notifModal) closeModal(notifModal); });
    $("notifList")?.addEventListener("click", async (e)=>{
      const li = e.target.closest(".notifItem");
      const id = li?.getAttribute("data-id");
      if(!id) return;

      const del = e.target.closest("button[data-act='delNotif']");
      if(del){
        try{ del.disabled = true; await deleteNotif(id); li.remove(); await refreshUnread(); }
        catch(_){ toast("Xato"); }
        finally{ del.disabled = false; }
        return;
      }

      const b = e.target.closest("button[data-act='readNotif']");
      if(!b) return;
      try{ b.disabled = true; await markNotifRead(id); li.classList.add("read"); li.classList.remove("unread"); await refreshUnread(); }
      catch(_){ toast("Xato"); }
      finally{ b.disabled=false; }
    });

    $("btnLogout").onclick = ()=>{ logout(); location.href="./"; };
    $("commentSend").onclick = sendComment;
    $("commentInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendComment(); });
    $("cmLoadMoreInline").onclick = ()=>loadComments(false);

    // Leaderboard interactivity
    $("lbSearch")?.addEventListener("input", (e)=>{
      lbQuery = e.target.value || "";
      renderLeaderboard();
    });
    $("lbOnlyMe")?.addEventListener("click", (e)=>{
      lbMeOnly = !lbMeOnly;
      e.currentTarget.setAttribute("aria-pressed", String(lbMeOnly));
      e.currentTarget.classList.toggle("active", lbMeOnly);
      renderLeaderboard();
    });
    // Click to spotlight a user in the table/podium
    function pickUser(loginId){
      if(!loginId) return;
      lbQuery = String(loginId);
      const inp = $("lbSearch");
      if(inp) inp.value = lbQuery;
      renderLeaderboard();
    }
    $("lbPodium")?.addEventListener("click", (e)=>{
      const b = e.target.closest("[data-pick]");
      if(b) pickUser(b.getAttribute("data-pick"));
    });
    $("lbBody")?.addEventListener("click", (e)=>{
      const r = e.target.closest("[data-pick]");
      if(r) pickUser(r.getAttribute("data-pick"));
    });

    async function boot(){
      setupSidePanel();
      setupAvatarPicker();

      try{
        const r = await me();
        const u = r.user;

        // Admin bo‚Äòlsa: TEST Builder ko‚Äòrsatamiz (bosh sahifada oddiy user ko‚Äòrmasin)
        if(u && (u.role === "admin" || u.isAdmin === true)){
          FEATURES.push({ title:"TEST Builder", desc:"Test yaratish: Firestore + JSON eksport", img:"assets/images/play.svg", href:"test_builder.html" });
        }

        setUserAvatar(u.avatarId);
        $("userId").textContent = u.loginId;
        $("userName").textContent = u.name || u.loginId;
        $("userPoints").textContent = String(u.points ?? 0);
        $("userBalance").textContent = String(u.balance ?? 0);
        $("userAge").textContent = calcAgePrecise(u.birthdate);

        myLoginId = u.loginId;
        await refreshUnread();
        renderSections();
        loadLeaderboard();
        loadComments(true);

        if(!u.profileComplete){
          await runOnboarding();
          const r2 = await me();
          $("userName").textContent = r2.user.name || r2.user.loginId;
          $("userAge").textContent = calcAgePrecise(r2.user.birthdate);
          setUserAvatar(r2.user.avatarId);
        }
      }catch(e){
        toast(e.message||"Kirish yo‚Äòq");
        setTimeout(()=>location.href="./", 600);
      }
    }
    
    function setupSidePanel(){
      const btn = $("sidePanelBtn");
      const overlay = $("sidePanelOverlay");
      const closeBtn = $("sideClose");
      const panel = $("sidePanel");

      const tabLb = $("sideTabLb");
      const tabCm = $("sideTabComments");
      const paneLb = $("sidePaneLb");
      const paneCm = $("sidePaneComments");

      function open(){
        overlay.setAttribute("aria-hidden","false");
        overlay.classList.add("open");
        // focus
        setTimeout(()=>closeBtn?.focus(), 50);
        document.body.classList.add("noScroll");
      }
      function close(){
        overlay.setAttribute("aria-hidden","true");
        overlay.classList.remove("open");
        document.body.classList.remove("noScroll");
      }
      function setTab(which){
        const isLb = which==="lb";
        tabLb.classList.toggle("active", isLb);
        tabCm.classList.toggle("active", !isLb);
        tabLb.setAttribute("aria-selected", String(isLb));
        tabCm.setAttribute("aria-selected", String(!isLb));
        paneLb.classList.toggle("active", isLb);
        paneCm.classList.toggle("active", !isLb);
      }

      btn?.addEventListener("click", ()=> {
        open();
        // default tab: if user last used keep in session
        const last = sessionStorage.getItem("sideTab") || "lb";
        setTab(last);
      });
      closeBtn?.addEventListener("click", close);
      overlay?.addEventListener("click", (e)=>{ if(e.target===overlay) close(); });

      tabLb?.addEventListener("click", ()=>{ sessionStorage.setItem("sideTab","lb"); setTab("lb"); });
      tabCm?.addEventListener("click", ()=>{ sessionStorage.setItem("sideTab","cm"); setTab("cm"); });

      document.addEventListener("keydown",(e)=>{
        if(e.key==="Escape" && overlay.classList.contains("open")) close();
      });
    }

    boot();

  </script>

  <script>

    // SCROLL FUNCTIONALITY
    const scrollProgress = document.getElementById('scrollProgress');
    const scrollToTopBtn = document.getElementById('scrollToTop');

    // Scroll progress tracking
    window.addEventListener('scroll', () => {
      const totalHeight = document.body.scrollHeight - window.innerHeight;
      const progress = (window.pageYOffset / totalHeight) * 100;
      scrollProgress.style.width = progress + '%';
      
      // Show/hide scroll to top button
      if (window.pageYOffset > 300) {
        scrollToTopBtn.classList.add('show');
      } else {
        scrollToTopBtn.classList.remove('show');
      }
    });

    // Scroll to top functionality
    scrollToTopBtn.addEventListener('click', () => {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    });

    // 3D SCENE SETUP
    let scene, camera, renderer, controls;
    let particles = [];
    let isRotating = true;
    let particleEffect = true;

    function initThreeJS() {
      scene = new THREE.Scene();
      
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.z = 15;
      
      renderer = new THREE.WebGLRenderer({ 
        canvas: document.getElementById('three-canvas'),
        antialias: true,
        alpha: true 
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      
      // Make canvas non-interactive
      renderer.domElement.style.pointerEvents = 'none';
      
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.maxPolarAngle = Math.PI;
      controls.minDistance = 5;
      controls.maxDistance = 50;
      controls.enablePan = false;
      controls.enableZoom = false;
      
      // LIGHTS
      const ambientLight = new THREE.AmbientLight(0x0ea5e9, 0.3);
      scene.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0x38bdf8, 0.8);
      directionalLight.position.set(10, 10, 5);
      scene.add(directionalLight);
      
      const pointLight = new THREE.PointLight(0x0ea5e9, 0.5, 100);
      pointLight.position.set(-10, -10, 10);
      scene.add(pointLight);
      
      // CREATE GEOMETRIES
      createParticles();
      createFloatingShapes();
      
      // RESIZE HANDLER
      window.addEventListener('resize', onWindowResize);
    }
    
    function createParticles() {
      const particleCount = 1500;
      const particlesGeometry = new THREE.BufferGeometry();
      const posArray = new Float32Array(particleCount * 3);
      
      for(let i = 0; i < particleCount * 3; i++) {
        posArray[i] = (Math.random() - 0.5) * 100;
      }
      
      particlesGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
      
      const particlesMaterial = new THREE.PointsMaterial({
        size: 0.08,
        color: 0x0ea5e9,
        transparent: true,
        opacity: 0.5
      });
      
      const particlesMesh = new THREE.Points(particlesGeometry, particlesMaterial);
      scene.add(particlesMesh);
      particles.push(particlesMesh);
    }
    
    function createFloatingShapes() {
      // TORUS
      const torusGeometry = new THREE.TorusGeometry(3, 1, 16, 100);
      const torusMaterial = new THREE.MeshStandardMaterial({ 
        color: 0x0ea5e9,
        transparent: true,
        opacity: 0.2,
        wireframe: true 
      });
      const torus = new THREE.Mesh(torusGeometry, torusMaterial);
      torus.position.x = -12;
      torus.position.y = 8;
      scene.add(torus);
      
      // ICOSAHEDRON
      const icosahedronGeometry = new THREE.IcosahedronGeometry(2);
      const icosahedronMaterial = new THREE.MeshStandardMaterial({ 
        color: 0x38bdf8,
        transparent: true,
        opacity: 0.3,
        wireframe: true 
      });
      const icosahedron = new THREE.Mesh(icosahedronGeometry, icosahedronMaterial);
      icosahedron.position.x = 12;
      icosahedron.position.y = -8;
      scene.add(icosahedron);
      
      // SPHERE
      const sphereGeometry = new THREE.SphereGeometry(2.5, 32, 32);
      const sphereMaterial = new THREE.MeshStandardMaterial({ 
        color: 0x0369a1,
        transparent: true,
        opacity: 0.15,
        wireframe: true 
      });
      const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
      sphere.position.x = -10;
      sphere.position.y = -12;
      scene.add(sphere);
      
      // TETRAHEDRON
      const tetraGeometry = new THREE.TetrahedronGeometry(1.8);
      const tetraMaterial = new THREE.MeshStandardMaterial({ 
        color: 0x7dd3fc,
        transparent: true,
        opacity: 0.25,
        wireframe: true 
      });
      const tetrahedron = new THREE.Mesh(tetraGeometry, tetraMaterial);
      tetrahedron.position.x = 8;
      tetrahedron.position.y = 12;
      scene.add(tetrahedron);
    }
    
    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }
    
    function animate() {
      requestAnimationFrame(animate);
      
      if(isRotating) {
        scene.children.forEach(child => {
          if(child instanceof THREE.Mesh && child.geometry.type !== 'PlaneGeometry') {
            child.rotation.x += 0.003;
            child.rotation.y += 0.003;
          }
        });
      }
      
      particles.forEach(particle => {
        if(particleEffect) {
          particle.rotation.x += 0.0005;
          particle.rotation.y += 0.0005;
        }
      });
      
      controls.update();
      renderer.render(scene, camera);
    }
    
    // INITIALIZE 3D
    initThreeJS();
    animate();
    
    // EFFECT CONTROLS
    document.getElementById('effect-rotate').addEventListener('click', () => {
      isRotating = !isRotating;
      const btn = document.getElementById('effect-rotate');
      btn.innerHTML = isRotating ? 
        '<i class="fa-solid fa-pause"></i> To\'xtatish' : 
        '<i class="fa-solid fa-play"></i> Davom ettirish';
    });
    
    document.getElementById('effect-zoom').addEventListener('click', () => {
      camera.position.z = camera.position.z === 15 ? 8 : 15;
    });
    
    document.getElementById('effect-particles').addEventListener('click', () => {
      particleEffect = !particleEffect;
      const btn = document.getElementById('effect-particles');
      btn.innerHTML = particleEffect ? 
        '<i class="fa-solid fa-sparkles"></i> Zarralar (ON)' : 
        '<i class="fa-solid fa-ban"></i> Zarralar (OFF)';
    });
    
    document.getElementById('effect-reset').addEventListener('click', () => {
      camera.position.set(0, 0, 15);
      controls.reset();
      isRotating = true;
      particleEffect = true;
      document.getElementById('effect-rotate').innerHTML = '<i class="fa-solid fa-pause"></i> To\'xtatish';
      document.getElementById('effect-particles').innerHTML = '<i class="fa-solid fa-sparkles"></i> Zarralar (ON)';
    });
    
    // MODAL FUNCTIONALITY
    const modal = document.getElementById('page-modal');
    const frame = document.getElementById('modal-frame');
    const closeBtn = document.getElementById('modal-close');
    
    document.querySelectorAll('[data-link]').forEach(card => {
      card.addEventListener('click', () => {
        const url = card.dataset.link;
        const title = card.dataset.title;
        
        if(!url) return;
        
        // Add 3D transition effect
        card.style.transform = 'scale(0.95)';
        setTimeout(() => {
          card.style.transform = '';
        }, 200);
        
        frame.src = url;
        modal.classList.add('open');
        document.body.style.overflow = 'hidden';
      });
    });
    
    closeBtn.addEventListener('click', () => {
      modal.classList.remove('open');
      frame.src = '';
      document.body.style.overflow = '';
    });
    
    modal.addEventListener('click', e => {
      if(e.target === modal) {
        modal.classList.remove('open');
        frame.src = '';
        document.body.style.overflow = '';
      }
    });
    
    // CARD HOVER EFFECTS
    document.querySelectorAll('.card').forEach(card => {
      card.addEventListener('mousemove', (e) => {
        if (window.innerWidth > 768) {
          const rect = card.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;
          
          const centerX = rect.width / 2;
          const centerY = rect.height / 2;
          
          const rotateY = (x - centerX) / 20;
          const rotateX = (centerY - y) / 20;
          
          card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) translateY(-10px)`;
        }
      });
      
      card.addEventListener('mouseleave', () => {
        card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) translateY(0)';
      });
    });

    // Add some content to ensure scrolling works
    document.addEventListener('DOMContentLoaded', () => {
      console.log('3D Portal loaded successfully!');
      console.log('Scroll enabled: Yes');
      console.log('3D Effects: Active');
    });
  </script>

</body>
</html>
