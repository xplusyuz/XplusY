<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<meta name="theme-color" content="#0ea5e9"/>
<link rel="icon" sizes="192x192" href="logo.png"/>
<link rel="apple-touch-icon" href="logo.png"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
<link rel="stylesheet" href="assets/css/style.css"/>
<link rel="stylesheet" href="assets/css/ui.css"/>
<link rel="stylesheet" href="assets/css/app.css"/>
<link rel="stylesheet" href="assets/css/bridge.css"/>
<title>LeaderMath.UZ ‚Äî App</title>
<style>
  /* --- Content (big chip + tag + search) --- */
  .ctRow{
    display:flex; gap:10px;
    overflow-x:auto; overflow-y:hidden;
    padding-bottom:4px;
    -webkit-overflow-scrolling:touch;
    overscroll-behavior-x:contain;
    scrollbar-width:none;
    user-select:none;
    cursor:grab;
    scroll-snap-type:x proximity;
  }
  .ctRow::-webkit-scrollbar{display:none}
  .ctRow:active{cursor:grabbing}
  .ctRow > *{scroll-snap-align:start}

  .ctChip{
    flex:0 0 auto;
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 12px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(255,255,255,.10);
    color: rgba(255,255,255,.92);
    cursor:pointer;
    white-space:nowrap;
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
  }
  .ctChip:active{transform:scale(.98)}
  .ctChip.active{
    background: rgba(46,139,87,.22);
    border-color: rgba(46,139,87,.35);
  }
  .ctChip.small{padding:8px 10px; font-size: 12px; opacity:.95}
  .ctChip.small.active{
    background: rgba(14,165,233,.18);
    border-color: rgba(14,165,233,.35);
  }
  .ctDot{width:8px;height:8px;border-radius:50%; background: rgba(46,139,87,.9); display:inline-block}
  .ctCount{
    margin-left:2px;
    padding:2px 8px;
    border-radius:999px;
    background: rgba(2,6,23,.35);
    color: rgba(255,255,255,.92);
    font-size:12px;
  }
  .ctSearchRow{
    position:relative;
    display:flex; align-items:center; gap:10px;
    background: rgba(255,255,255,.10);
    border:1px solid rgba(255,255,255,.16);
    border-radius: 16px;
    padding: 10px 12px;
  }
  .ctSearchRow i{opacity:.85}
  .ctSearchRow input{
    width:100%;
    border:none;
    outline:none;
    background:transparent;
    color: rgba(255,255,255,.95);
  }
  .ctSearchRow input::placeholder{color: rgba(255,255,255,.65)}
  .ctEmpty{display:none; padding:12px 2px; opacity:.9}
</style>
</head>
<body data-page="app">
  <div class="scroll-progress"><div class="scroll-progress-bar" id="scrollProgress"></div></div>
  <button class="scroll-to-top" id="scrollToTop" aria-label="Yuqoriga"><i class="fa-solid fa-arrow-up"></i></button>
  <canvas id="three-canvas"></canvas>

  <!-- old seasonal particles (kept for logic) -->
  <canvas class="seasonCanvas" id="seasonCanvas"></canvas>

  <div class="app">
    <header>
      <div class="header-card">
        <div class="brandBox" aria-label="LeaderMath">
          <img src="logo.png" alt="LeaderMath.UZ" class="logo-img">
          <div class="brandText">
            <div class="brandName">LeaderMath<span class="dot">.uz</span></div>
            <div class="brandTag" id="dtMini">...</div>
          </div>
        </div>

        <div class="header-text">
          <div class="header-title">LeaderMath.UZ ‚Äî App</div>
          <div class="header-sub" id="dt">...</div>
        </div>

        <div class="user-chip" id="profileMini" title="Profil / Avatar">
          <img id="userAvatar" src="logo.png" alt="avatar" style="width:36px;height:36px;border-radius:999px;border:2px solid rgba(56,189,248,.65)"/>
          <div class="user-meta">
            <div class="name"><span id="userName">‚Äî</span> ¬∑ <span id="userId">‚Äî</span></div>
            <div class="mini">üèÜ <span id="userPoints">0</span> ‚Ä¢ üí∞ <span id="userBalance">0</span> ‚Ä¢ üéÇ <span id="userAge">‚Äî</span></div>
          </div>
        </div>

        <div class="header-actions" aria-label="Header actions">
          <button class="icon-btn" id="btnBell" aria-label="Bildirishnoma" title="Tez kunda"><i class="fa-solid fa-bell"></i></button>
          <button class="icon-btn" id="btnLogout" aria-label="Chiqish"><i class="fa-solid fa-right-from-bracket"></i></button>
        </div>
      </div>
    </header>

    <main style="display:flex;flex-direction:column;gap:18px;">

      <!-- 1) Stories-style Banner Carousel (banner/1.png,2.png...) -->
      <section class="glass section" id="bannerSection">
        <div class="sectionTitle">
          <h2>Bannerlar</h2>
          <div class="hint">Instagram stories uslubida</div>
        </div>

        <div class="storyBar" id="storyBar" aria-label="Banner stories"></div>

        <div class="storyViewer" id="storyViewer" aria-label="Banner ko‚Äòruvchi" style="margin-top:12px;">
          <div class="storyProgress" id="storyProgressDots" aria-hidden="true"></div>
          <button class="storyNav prev" id="storyPrev" type="button" aria-label="Oldingi">‚Äπ</button>
          <img class="storyImg" id="storyImg" alt="Banner" />
          <button class="storyNav next" id="storyNext" type="button" aria-label="Keyingi">‚Ä∫</button>
          <div class="storyEmpty" id="storyEmpty" style="display:none;">
            <div class="big">Banner yo‚Äòq</div>
            <div class="small muted">banner/1.png, 2.png, 3.png‚Ä¶ fayllarni joylang</div>
          </div>
        </div>
      </section>

      <!-- 2) NEW CONTENT (old content removed) -->
      <section class="glass section" id="contentSection">
        <div class="sectionTitle">
          <h2>Kontent</h2>
          <div class="hint">Katta chip ‚Üí tag ‚Üí qidiruv</div>
        </div>

        <div class="ctSearchRow">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input id="ctQ" placeholder="Qidiruv: ko'phad, kvadrat, latex..." autocomplete="off" />
          <button class="btn" id="ctClear" type="button" style="padding:10px 12px;">Tozalash</button>
        </div>

        <div style="height:10px"></div>
        <div class="ctRow" id="ctBigRow" aria-label="Katta chiplar"></div>
        <div style="height:10px"></div>
        <div class="ctRow" id="ctTagRow" aria-label="Tag chiplar"></div>

        <div class="small muted" id="ctInfo" style="margin-top:10px;">Yuklanmoqda‚Ä¶</div>
        <div class="cardsGrid" id="ctGrid" style="margin-top:12px;"></div>
        <div class="small muted ctEmpty" id="ctEmpty">Hech narsa topilmadi. Tag/qidiruvni o‚Äòzgartirib ko‚Äòring.</div>
      </section>

      <!-- Onboard overlay kept (profile completion) -->
      <div id="onboardOverlay" style="display:none; position:fixed; inset:0; background: rgba(2,6,23,.55); backdrop-filter: blur(10px); z-index: 9998;">
        <div class="container" style="display:flex; align-items:center; justify-content:center; min-height: 100%;">
          <div class="glass section" style="max-width: 520px; width: 100%;">
            <div class="sectionTitle">
              <h2>Profilni to‚Äòldiring</h2>
              <div class="hint">Birinchi kirishda</div>
            </div>
            <p class="p">Ism, familiya, tug‚Äòilgan sana va yangi parolni kiriting.</p>
            <div class="hr"></div>

            <div class="row">
              <input class="input" id="obFirst" placeholder="Ism"/>
              <input class="input" id="obLast" placeholder="Familiya"/>
            </div>
            <div style="height:10px;"></div>
            <div class="row">
              <input class="input" id="obBirth" type="date" placeholder="Tug‚Äòilgan sana (YYYY-MM-DD)"/>
              <input class="input" id="obPass1" type="password" placeholder="Yangi parol"/>
            </div>
            <div style="height:10px;"></div>
            <div class="row">
              <input class="input" id="obPass2" type="password" placeholder="Yangi parolni takrorlang"/>
              <div></div>
            </div>

            <div style="height:12px;"></div>
            <button class="btn btnPrimary" id="obSave" style="width:100%;">Saqlash va davom etish</button>
            <div class="small" style="margin-top:10px;">‚ö†Ô∏è Parolni eslab qoling. Keyingi kirishda shu parol ishlaydi.</div>
          </div>
        </div>
      </div>

      <script type="module">
        import { initSeasons } from "./assets/js/seasons.js";
        initSeasons("seasonCanvas");
      </script>

    </main>

    <footer>
      <div class="footer-card">
        <div class="footer-left">
          <div class="footer-name">LeaderMath.UZ</div>
          <div class="small-note">Banner saqlandi ‚Ä¢ Kontent JSON‚Äôdan</div>
        </div>
        <div class="footer-right">
          <a class="footer-link" href="index.html"><i class="fa-solid fa-house"></i> Home</a>
        </div>
      </div>
    </footer>
  </div>

  <div class="toast" id="toast">...</div>

  <script src="assets/js/core.js"></script>

  <script type="module">
    import { me, logout, updateProfile, changePassword, getToken } from "./assets/js/auth.js";

    const $ = (id)=>document.getElementById(id);

    // Guard
    try{
      if(!getToken || !getToken()) location.href = "./index.html";
    }catch{ location.href = "./index.html"; }

    // Date
    const months = ["yanvar","fevral","mart","aprel","may","iyun","iyul","avgust","sentabr","oktabr","noyabr","dekabr"];
    const days = ["yakshanba","dushanba","seshanba","chorshanba","payshanba","juma","shanba"];
    function setDate(){
      const d = new Date();
      const s = `${days[d.getDay()]}, ${d.getDate()}-${months[d.getMonth()]} ${d.getFullYear()} ‚Ä¢ ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      $("dt").textContent = s;
      const mini = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      const dtMini = $("dtMini");
      if(dtMini) dtMini.textContent = mini;
    }
    setDate(); setInterval(setDate, 15000);

    // Toast
    const toastEl = $("toast");
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=>toastEl.classList.remove("show"), 1800);
    }

    // Profile
    function calcAge(iso){
      if(!iso) return "‚Äî";
      const b = new Date(iso);
      if(Number.isNaN(b.getTime())) return "‚Äî";
      const n = new Date();
      let y=n.getFullYear()-b.getFullYear();
      let m=n.getMonth()-b.getMonth();
      let d=n.getDate()-b.getDate();
      if(d<0){ m--; d += new Date(n.getFullYear(), n.getMonth(), 0).getDate(); }
      if(m<0){ y--; m+=12; }
      return `${y}y ${m}oy`;
    }
    function setAvatarFromUser(u){
      const img = $("userAvatar");
      const id = u?.avatarId || u?.avatar || u?.profile?.avatarId;
      if(!img) return;
      if(id){ img.src = `avatar/${id}.png`; }
      else { img.src = "logo.png"; }
    }

    async function ensureProfile(user){
      // agar ism/familiya yo‚Äòq bo‚Äòlsa onboard ko‚Äòrsatamiz
      const needs = !(user?.firstName && user?.lastName && user?.birthdate);
      if(!needs) return;
      const overlay = $("onboardOverlay");
      if(!overlay) return;
      overlay.style.display = "block";

      $("obSave").onclick = async ()=>{
        const fn = $("obFirst").value.trim();
        const ln = $("obLast").value.trim();
        const bd = $("obBirth").value;
        const p1 = $("obPass1").value;
        const p2 = $("obPass2").value;
        if(!fn || !ln || !bd) return toast("Ism, familiya, tug‚Äòilgan sana kerak");
        if(!p1 || p1.length<4) return toast("Parol kamida 4 belgi");
        if(p1!==p2) return toast("Parol mos emas");
        try{
          $("obSave").disabled = true;
          await updateProfile(fn, ln, bd);
          await changePassword(p1);
          overlay.style.display = "none";
          toast("‚úÖ Saqlandi");
          await loadMe();
        }catch(e){
          toast(e?.message || "Xatolik");
        }finally{
          $("obSave").disabled = false;
        }
      };
    }

    async function loadMe(){
      try{
        const r = await me();
        const u = r?.user || r;
        $("userName").textContent = [u?.firstName, u?.lastName].filter(Boolean).join(" ") || "‚Äî";
        $("userId").textContent = u?.loginId || u?.id || "‚Äî";
        $("userPoints").textContent = u?.points ?? 0;
        $("userBalance").textContent = u?.balance ?? 0;
        $("userAge").textContent = calcAge(u?.birthdate);
        setAvatarFromUser(u);
        ensureProfile(u);
      }catch(e){
        toast("Sessiya tugagan. Qayta kiring.");
        location.href = "./index.html";
      }
    }

    $("btnLogout")?.addEventListener("click", async ()=>{
      await logout();
      location.href = "./index.html";
    });
    $("btnBell")?.addEventListener("click", ()=>toast("üîî Tez kunda"));

    // --- Banner stories ---
    const BANNER_DIR = "banner";
    const BANNER_MANIFEST = "banner/manifest.json";
    let storyItems = [];
    let storyIdx = 0;
    let storyTimer = null;

    function preloadImage(url){
      return new Promise((resolve)=>{
        const img = new Image();
        img.onload = ()=>resolve(true);
        img.onerror = ()=>resolve(false);
        img.src = url;
      });
    }

    async function probeSequentialImages(dir, max=24, stopAfter=4){
      const out = [];
      let misses = 0;
      for(let i=1;i<=max;i++){
        const url = `${dir}/${i}.png`;
        const ok = await preloadImage(url);
        if(ok){ out.push({id:i, url}); misses = 0; }
        else { misses++; if(misses>=stopAfter) break; }
      }
      return out;
    }

    function clearStoryTimer(){
      if(storyTimer){ clearInterval(storyTimer); storyTimer=null; }
    }

    function renderStoryBar(){
      const bar = $("storyBar");
      if(!bar) return;
      if(!storyItems.length){
        bar.innerHTML = `<div class="small" style="padding:6px 2px;">banner/ papkada 1.png, 2.png... bo‚Äòlsa, shu yerda stories chiqadi.</div>`;
        return;
      }
      bar.innerHTML = storyItems.map((s,i)=>`
        <button class="storyBubble" type="button" data-idx="${i}" aria-label="Banner ${i+1}">
          <div class="storyRing"><img class="storyAvatar" alt="Banner ${i+1}" src="${s.url}"></div>
          <div class="storyLabel">${i+1}</div>
        </button>
      `).join("");
      bar.onclick = (e)=>{
        const b = e.target.closest("[data-idx]");
        if(!b) return;
        renderStoryViewer(Number(b.getAttribute("data-idx"))||0, true);
      };
    }

    function renderStoryViewer(idx, autoplay=false){
      const viewer = $("storyViewer");
      const img = $("storyImg");
      const dots = $("storyProgressDots");
      const empty = $("storyEmpty");
      if(!viewer || !img || !dots) return;

      storyIdx = Math.max(0, Math.min(idx, Math.max(0, storyItems.length-1)));

      if(!storyItems.length){
        img.removeAttribute("src");
        dots.innerHTML = "";
        if(empty) empty.style.display = "block";
        clearStoryTimer();
        return;
      }

      if(empty) empty.style.display = "none";
      img.src = storyItems[storyIdx].url;
      dots.innerHTML = storyItems.map((_,i)=>`<span class="storyProgressDot ${i===storyIdx?"active":""}"></span>`).join("");

      clearStoryTimer();
      if(autoplay){
        let t=0;
        storyTimer = setInterval(()=>{
          t++;
          if(t>=6){
            t=0;
            const next = (storyIdx+1) % storyItems.length;
            renderStoryViewer(next, true);
          }
        }, 800);
      }
    }

    function setupStoryControls(){
      $("storyPrev")?.addEventListener("click", (e)=>{
        e.stopPropagation();
        if(!storyItems.length) return;
        renderStoryViewer((storyIdx-1+storyItems.length)%storyItems.length, true);
      });
      $("storyNext")?.addEventListener("click", (e)=>{
        e.stopPropagation();
        if(!storyItems.length) return;
        renderStoryViewer((storyIdx+1)%storyItems.length, true);
      });
      $("storyViewer")?.addEventListener("click", ()=>{
        if(!storyItems.length) return;
        renderStoryViewer((storyIdx+1)%storyItems.length, true);
      }, {passive:true});
    }

    async function loadStories(){
      storyItems = [];
      // 1) manifest.json (optional)
      try{
        const r = await fetch(BANNER_MANIFEST, {cache:"no-store"});
        if(r.ok){
          const j = await r.json();
          const ids = Array.isArray(j?.ids) ? j.ids : [];
          storyItems = ids.map(id=>({id, url:`${BANNER_DIR}/${id}.png`}));
        }
      }catch(_){ }
      // 2) fallback probe
      if(!storyItems.length){
        storyItems = await probeSequentialImages(BANNER_DIR, 24, 4);
      }
      renderStoryBar();
      renderStoryViewer(0, true);
    }

    // --- Content from content.json ---
    const ct = {
      activeType: null,
      activeTag: "all",
      q: "",
      data: null
    };

    function norm(s){
      return (s??"").toString().trim().toLowerCase().replace(/\s+/g," ");
    }
    function esc(s){
      return String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m]));
    }

    function enhanceRow(row){
      if(!row) return;
      // wheel -> horizontal
      row.addEventListener("wheel", (e)=>{
        if(Math.abs(e.deltaY) > Math.abs(e.deltaX)){
          row.scrollLeft += e.deltaY;
          e.preventDefault();
        }
      }, {passive:false});
      // drag
      let isDown=false, startX=0, startLeft=0;
      row.addEventListener("mousedown", (e)=>{
        isDown=true;
        startX = e.pageX;
        startLeft = row.scrollLeft;
      });
      window.addEventListener("mouseup", ()=>isDown=false);
      window.addEventListener("mousemove", (e)=>{
        if(!isDown) return;
        const dx = e.pageX - startX;
        row.scrollLeft = startLeft - dx;
      });
    }

    function ctItemsByType(){
      const items = ct.data?.items || [];
      return items.filter(it => norm(it.type) === ct.activeType);
    }

    function ctPickTags(items){
      const set = new Set();
      items.forEach(it => (it.tags||[]).forEach(t => set.add(norm(t))));
      return [...set].filter(Boolean).sort((a,b)=>a.localeCompare(b));
    }

    function ctCountType(typeId){
      const items = ct.data?.items || [];
      return items.filter(it => norm(it.type)===typeId).length;
    }

    function ctCountTag(tag){
      const items = ctItemsByType();
      if(tag==="all") return items.length;
      return items.filter(it => (it.tags||[]).map(norm).includes(tag)).length;
    }

    function ctSetActive(container, id){
      [...container.querySelectorAll(".ctChip")].forEach(c=>c.classList.toggle("active", c.dataset.id===id));
    }

    function ctRenderBig(){
      const row = $("ctBigRow");
      const big = (ct.data?.bigChips || []).map(c=>({ ...c, id: norm(c.id) }));
      if(!ct.activeType && big.length) ct.activeType = big[0].id; // BARCHASI YO‚ÄòQ

      row.innerHTML = big.map(c=>`
        <div class="ctChip ${c.id===ct.activeType?"active":""}" data-id="${c.id}">
          <span class="ctDot"></span>
          <span>${esc(c.icon||"")} ${esc(c.title||"")}</span>
          <span class="ctCount">${ctCountType(c.id)}</span>
        </div>
      `).join("");

      row.querySelectorAll(".ctChip").forEach(ch=>{
        ch.addEventListener("click", ()=>{
          ct.activeType = ch.dataset.id;
          ct.activeTag = "all";
          ctSetActive(row, ct.activeType);
          ctRenderTags();
          ctRenderCards();
        });
      });

      enhanceRow(row);
    }

    function ctRenderTags(){
      const row = $("ctTagRow");
      const tags = ctPickTags(ctItemsByType());
      const list = ["all", ...tags];
      row.innerHTML = list.map(t=>`
        <div class="ctChip small ${t===ct.activeTag?"active":""}" data-id="${t}">
          <span>${esc(t==="all"?"Hammasi":t)}</span>
          <span class="ctCount">${ctCountTag(t)}</span>
        </div>
      `).join("");

      row.querySelectorAll(".ctChip").forEach(ch=>{
        ch.addEventListener("click", ()=>{
          ct.activeTag = ch.dataset.id;
          ctSetActive(row, ct.activeTag);
          ctRenderCards();
        });
      });

      enhanceRow(row);
    }

    function ctFiltered(){
      const q = norm(ct.q);
      return ctItemsByType()
        .filter(it=>{
          if(ct.activeTag!=="all"){
            const tags = (it.tags||[]).map(norm);
            if(!tags.includes(ct.activeTag)) return false;
          }
          if(q){
            const hay = [it.title, it.desc, it.type, (it.tags||[]).join(" ")].map(norm).join(" | ");
            if(!hay.includes(q)) return false;
          }
          return true;
        })
        .sort((a,b)=>(b.order||0)-(a.order||0));
    }

    function ctRenderCards(){
      const grid = $("ctGrid");
      const info = $("ctInfo");
      const empty = $("ctEmpty");
      const items = ctFiltered();

      info.textContent = `Natija: ${items.length} ta`;
      if(!items.length){
        grid.innerHTML = "";
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";

      grid.innerHTML = items.map(it=>{
        const status = norm(it.status)||"available";
        const disabled = status==="soon";
        const badge = it.badge || (disabled?"SOON":"");
        return `
          <div class="card" style="min-height: 124px;">
            <div class="cardTop">
              <div>
                <div class="cardTitle">${esc(it.title||"")}</div>
                <div class="cardDesc">${esc(it.desc||"")}</div>
              </div>
              ${badge?`<div class="pill" style="margin-left:auto;">${esc(badge)}</div>`:""}
            </div>
            <div class="cardTags" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
              ${(it.tags||[]).slice(0,6).map(t=>`<span class="pill" style="opacity:.92">${esc(t)}</span>`).join("")}
              <a class="btn ${disabled?"":"btnPrimary"}" href="${esc(it.href||"#")}" style="margin-left:auto; padding:10px 12px; ${disabled?"pointer-events:none; opacity:.7;":""}">
                ${disabled?"Tez kunda":"Ochish"}
              </a>
            </div>
          </div>
        `;
      }).join("");
    }

    async function ctInit(){
      try{
        const r = await fetch("./content.json", {cache:"no-store"});
        if(!r.ok) throw new Error("content.json topilmadi");
        ct.data = await r.json();
        ctRenderBig();
        ctRenderTags();
        ctRenderCards();

        const q = $("ctQ");
        let t=null;
        q.addEventListener("input", ()=>{
          clearTimeout(t);
          t=setTimeout(()=>{ ct.q=q.value; ctRenderCards(); }, 120);
        });

        $("ctClear").addEventListener("click", ()=>{
          ct.activeTag = "all";
          ct.q = "";
          q.value = "";
          ctRenderTags();
          ctRenderCards();
        });

      }catch(e){
        $("ctInfo").textContent = "Xatolik: kontent yuklanmadi";
        toast(e?.message || "Xatolik");
      }
    }

    // boot
    await loadMe();
    setupStoryControls();
    await loadStories();
    await ctInit();

  </script>
</body>
</html>
