<!DOCTYPE html>

<html lang="uz">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" name="viewport"/>
<meta content="#0ea5e9" name="theme-color"/>
<link href="logo.png" rel="icon" sizes="192x192"/>
<link href="logo.png" rel="apple-touch-icon"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
<link href="assets/css/style.css" rel="stylesheet"/>
<link href="assets/css/ui.css" rel="stylesheet"/>
<link href="assets/css/app.css" rel="stylesheet"/>
<link href="assets/css/bridge.css" rel="stylesheet"/>
<link rel="manifest" href="manifest.webmanifest"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="mobile-web-app-capable" content="yes"/>
<link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180x180.png"/>
<link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png"/>
<link rel="stylesheet" href="assets/css/pwa.css"/>

<title>LeaderMath.UZ ‚Äî App</title>
<style>

/* ===== Rating: Neo-Compact Glass (2026) ===== */
.rtOverlay{
  position:fixed; inset:0;
  display:none; align-items:flex-end; justify-content:center;
  padding: 10px;
  background:
    radial-gradient(900px 520px at 18% 10%, rgba(46,139,87,.20), transparent 62%),
    radial-gradient(820px 520px at 82% 18%, rgba(59,130,246,.18), transparent 60%),
    rgba(10,18,30,.34);
  backdrop-filter: blur(12px);
  z-index: 10050;
}
.rtOverlay.open{ display:flex; }

.rtSheet{
  width:min(640px, 96vw);
  max-height:min(88vh, 760px);
  border-radius: 24px;
  background: linear-gradient(135deg, rgba(255,255,255,.92), rgba(234,252,245,.82));
  border: 1px solid rgba(46,139,87,.16);
  box-shadow: 0 30px 90px rgba(15,23,42,.22), 0 18px 46px rgba(46,139,87,.12);
  overflow:hidden;
  transform: translateY(14px) scale(.985);
  opacity:0;
  animation: rtIn .18s ease-out forwards;
}
@keyframes rtIn{ to{ transform: translateY(0) scale(1); opacity:1; } }

.rtTopbar{
  padding: 10px 14px 8px;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.rtLeftTitle{ min-width:0; }
.rtTitle{ font-weight:950; font-size:18px; color:rgba(15,23,42,.90); letter-spacing:.2px; }
.rtSub{ font-size:12px; color:rgba(15,23,42,.58); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

.rtBtn{
  height:36px; min-width:36px;
  border-radius: 999px;
  border: 1px solid rgba(46,139,87,.18);
  background: rgba(255,255,255,.72);
  box-shadow: 0 10px 22px rgba(46,139,87,.10);
  display:inline-flex; align-items:center; justify-content:center;
  padding: 0 12px;
  font-size: 12px; font-weight: 850;
  color: rgba(15,23,42,.74);
  user-select:none;
}
.rtBtn:active{ transform: scale(.985); }
.rtBtnIcon{ padding:0; width:36px; }

.rtControls{
  padding: 0 14px 10px;
  display:flex; align-items:center; gap:10px; flex-wrap:wrap;
}
.rtSeg{
  display:flex; align-items:center; gap:8px;
  padding:6px;
  border-radius: 999px;
  background: rgba(255,255,255,.62);
  border: 1px solid rgba(15,23,42,.08);
  box-shadow: 0 12px 26px rgba(15,23,42,.06);
  overflow-x:auto; scrollbar-width:none; -webkit-overflow-scrolling: touch;
}
.rtSeg::-webkit-scrollbar{ height:0px; }
.rtChip{
  flex:0 0 auto;
  height:32px; min-width:46px;
  padding: 0 12px;
  border-radius: 999px;
  border: 1px solid rgba(46,139,87,.14);
  background: rgba(255,255,255,.66);
  font-size:12px; font-weight:900;
  color: rgba(15,23,42,.74);
}
.rtChip.active{
  background: linear-gradient(135deg, rgba(46,139,87,.26), rgba(59,130,246,.20));
  border-color: rgba(46,139,87,.30);
  color: rgba(15,23,42,.92);
}

.rtBody{
  padding: 0 14px 14px;
  overflow:auto;
  max-height: calc(min(88vh, 760px) - 120px);
}

.rtState{
  display:flex; align-items:center; gap:10px;
  padding: 12px;
  border-radius: 16px;
  background: rgba(255,255,255,.62);
  border: 1px solid rgba(15,23,42,.07);
  box-shadow: 0 12px 26px rgba(15,23,42,.06);
  margin-bottom: 10px;
  color: rgba(15,23,42,.72);
  font-weight: 750;
}
.rtSpin{
  width:18px;height:18px;border-radius:999px;
  border:2px solid rgba(15,23,42,.18);
  border-top-color: rgba(46,139,87,.68);
  animation: rtSpin 1s linear infinite;
}
@keyframes rtSpin{ to{ transform: rotate(360deg); } }

.rtSectionTitle{
  font-size:12px;
  font-weight:950;
  color: rgba(15,23,42,.60);
  margin: 12px 2px 8px;
  display:flex; align-items:center; justify-content:space-between;
}
.rtHint{ font-weight:850; opacity:.55; }

.rtMeCard{
  padding: 12px;
  border-radius: 18px;
  background: linear-gradient(135deg, rgba(255,255,255,.86), rgba(233,247,240,.72));
  border: 1px solid rgba(46,139,87,.16);
  box-shadow: 0 16px 34px rgba(46,139,87,.12);
  margin-bottom: 10px;
  position: relative;
  overflow: hidden;
}
.rtMeGlow{
  position:absolute; inset:-50px -70px auto auto;
  width:160px; height:160px; border-radius:999px;
  background: radial-gradient(circle, rgba(46,139,87,.28), transparent 62%);
  filter: blur(2px);
}

.rtRow{ display:flex; align-items:center; gap:12px; min-width:0; }
.rtAv{
  width:46px;height:46px;border-radius: 16px;
  border: 1px solid rgba(46,139,87,.16);
  box-shadow: 0 10px 22px rgba(46,139,87,.14);
  background: rgba(255,255,255,.86);
  object-fit: cover;
}
.rtInfo{ flex:1; min-width:0; }
.rtName{ font-weight:950; font-size:13px; color: rgba(15,23,42,.90); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.rtMeta{ font-size:12px; opacity:.72; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

.rtRankTag{
  margin-left:auto;
  padding:6px 10px;
  border-radius: 999px;
  background: rgba(46,139,87,.10);
  border:1px solid rgba(46,139,87,.18);
  font-weight: 950;
  color: rgba(15,23,42,.72);
}

.rtXPbig{ margin-top: 10px; font-weight: 950; }

.rtPodium{
  display:flex; gap:10px;
  overflow-x:auto; -webkit-overflow-scrolling: touch;
  scrollbar-width:none;
  padding: 2px 0 4px;
}
.rtPodium::-webkit-scrollbar{ height:0px; }
.rtPodCard{
  flex:0 0 auto;
  width: 228px;
  padding: 10px;
  border-radius: 18px;
  background: linear-gradient(135deg, rgba(255,255,255,.86), rgba(233,247,240,.72));
  border: 1px solid rgba(46,139,87,.14);
  box-shadow: 0 16px 34px rgba(46,139,87,.12);
  position:relative;
  overflow:hidden;
}
.rtBadge{
  position:absolute; top:10px; right:12px;
  font-weight:950; opacity:.58;
}

.rtList{ display:flex; flex-direction:column; gap:10px; }
.rtItem{
  display:flex; align-items:center; gap:12px;
  padding: 10px 12px;
  border-radius: 16px;
  background: rgba(255,255,255,.64);
  border: 1px solid rgba(15,23,42,.07);
  box-shadow: 0 12px 26px rgba(15,23,42,.06);
  transition: transform .12s ease, box-shadow .12s ease;
}
.rtItem:hover{ transform: translateY(-1px); box-shadow: 0 16px 34px rgba(15,23,42,.08); }
.rtIdx{ width:34px; text-align:center; font-weight:950; color: rgba(15,23,42,.42); }
.rtRight{ text-align:right; }
.rtXP{ font-weight:950; }

.rtMeRow{
  outline: 2px solid rgba(46,139,87,.28);
  background: linear-gradient(135deg, rgba(46,139,87,.10), rgba(59,130,246,.08));
}
.rtPulse{ animation: rtPulse 1.2s ease-in-out 1; }
@keyframes rtPulse{
  0%{ box-shadow: 0 0 0 0 rgba(46,139,87,.35); }
  100%{ box-shadow: 0 0 0 14px rgba(46,139,87,0); }
}

@media (min-width: 768px){
  .rtOverlay{ align-items:center; padding: 18px; }
  .rtBody{ max-height: min(74vh, 760px); }
  .rtSub{ max-width: 420px; }
}
</style>
</head>
<body data-page="app">
<div class="scroll-progress"><div class="scroll-progress-bar" id="scrollProgress"></div></div>
<button aria-label="Yuqoriga" class="scroll-to-top" id="scrollToTop"><i class="fa-solid fa-arrow-up"></i></button>
<canvas id="three-canvas"></canvas>
<!-- old seasonal particles (kept for logic) -->
<canvas class="seasonCanvas" id="seasonCanvas"></canvas>
<div class="app">
<header>
<div class="header-card">
<div aria-label="LeaderMath" class="brandBox">
<img alt="LeaderMath.UZ" class="logo-img" src="logo.png"/>
</div>
<!-- Desktop subtitle / time (mobile'da yashiriladi) -->
<div class="header-text">
<div class="header-title">LeaderMath.UZ ‚Äî App</div>
<div class="header-sub" id="dt">...</div>
</div>
<!-- Mobile layout: logo chapda, profil o'rtada (to'liq), ikonlar o'ngda -->
<div class="user-chip" id="profileMini" title="Profil / Medalyon">
<img alt="avatar" id="userAvatar" src="logo.png" style="width:36px;height:36px;border-radius:999px;border:2px solid rgba(56,189,248,.65)">
<div class="user-meta">
<div class="name"><span id="userName">‚Äî</span> ¬∑ <span id="userId">‚Äî</span></div>
<div class="mini">üèÜ <span id="userPoints">0</span> ‚Ä¢ üí∞ <span id="userBalance">0</span> ‚Ä¢ üéÇ <span id="userAge">‚Äî</span></div>
</div>
</img></div>
<div aria-label="Header actions" class="header-actions">
<button aria-label="Bildirishnoma" class="icon-btn" id="btnBell"><i class="fa-solid fa-bell"></i></button>
<button aria-label="Chiqish" class="icon-btn" id="btnLogout"><i class="fa-solid fa-right-from-bracket"></i></button>
</div>
</div>
</header>
<main style="display:flex;flex-direction:column;gap:18px;">
<!-- ‚òÖ Medalyon / Level progress (100 bosqich) -->
<section class="glass section levelSection" id="medalSection">
  <div class="levelHead">
    <div>
      <h2 class="levelH2">Sizning darajangiz</h2>
      <div class="hint">Ball ‚Üí bosqich ‚Ä¢ medals</div>
    </div>
    <button class="rank-btn-mini" id="openRating" type="button" title="Reytingni ko'rish">
      <img src="icon.png" alt="Reyting"/>
      <span>Reyting</span>
    </button>
  </div>

  <div class="levelCardX">
    <div class="levelMedalWrap">
      <img alt="Medalyon" id="medalLarge" src="logo.png" class="levelMedalImg"/>
      <div class="levelGlow"></div>
    </div>

    <div class="levelMain">
      <div class="levelTopRow">
        <div class="levelText" id="levelText">Daraja: 1 / 9999</div>
        <div class="levelRange" id="levelRange">0 ‚Üí 100</div>
      </div>

      <div class="levelBarsRow">
        <div id="levelBars" class="levelBars"></div>
      </div>

      <div class="levelProgressRow">
        <div class="levelBar">
          <div class="levelFill" id="levelProgress" style="width:0%"></div>
        </div>
        <div class="levelPct" id="levelPct">0%</div>
      </div>

      <div class="levelHint" id="nextHint">Keyingi darajagacha: 0 ball</div>
    </div>
  </div>
</section>
<!-- 1) Video Banner (public/hero.mp4) -->
<section class="glass section" id="bannerSection">
  <div class="sectionTitle">
    <h2>Yangiliklar</h2>
    <div class="hint">Videoni tomosha qiling ‚Äî pauza va ovoz boshqaruvi bor.</div>
  </div>

  <div class="videoHero" aria-label="Video banner">
    <video
      id="heroVideo"
      class="heroVideo"
      src="videos/banner.mp4"
      autoplay
      muted
      loop
      playsinline
      preload="metadata"
    ></video>

    <div class="videoControls" aria-label="Video boshqaruvlari">
      <button class="vBtn" id="playPauseBtn" type="button" aria-label="Pause / Play" title="Pause / Play">‚è∏</button>
      <button class="vBtn" id="muteBtn" type="button" aria-label="Mute / Unmute" title="Mute / Unmute">üîá</button>
    </div>
  </div>
</section>

<!-- 2) Challenge container (code + start) -->
 (code + start) -->
<section class="glass section" id="challengeSection">
<div class="sectionTitle">
<h2>Challenge</h2>
<div class="hint" id="challengeHint">Bellashing! Bilimingizni sinab ko'ring!</div>
</div>
<div class="challengeList" id="challengeList">
<div class="muted">Yuklanmoqda...</div>
</div>
</section>
<section class="glass section" id="contentSection">
<div class="sectionTitle">
<h2>Kontent</h2>
<div class="hint">Bo‚Äòlim ‚Üí tag ‚Üí qidiruv</div>
</div>
<div class="contentBox">
<div class="bigRow" id="bigChipsRow"></div>
<div class="tagRow" id="tagChipsRow"></div>
<div class="searchRow">
<button class="searchToggle" id="searchToggle" type="button" aria-label="Qidiruv" title="Qidiruv">üîé</button>
<div class="searchWrap isHidden" id="searchWrap">
<input autocapitalize="off" autocomplete="new-password" autocorrect="off" id="q" inputmode="search" placeholder="Test, simulyator yoki mavzu qidiring..." spellcheck="false" type="search"/>
</div>
<button aria-label="Tozalash" class="iconClear" id="clearBtn" title="Tozalash"><i class="fa-solid fa-broom"></i></button>
<div class="resultInfo" id="resultInfo">Natija: ‚Äî</div>
</div>
<div class="cardGrid" id="grid"></div>
<div class="muted" id="empty" style="display:none;padding:10px 2px;">Hech narsa topilmadi.</div>
</div>
</section>
<!-- 3) Tests container (chips + search) -->
<!-- 4) Simulators container (same style) -->
<!-- Reyting/Izohlar endi suzuvchi "touch" tugma orqali premium modalda ochiladi -->
<!-- Floating Touch Button (expand: üèÜ Reyting / üí¨ Izoh) -->
<!-- Reyting Modal (Top-20 + podium + qidiruv) -->

<!-- Comment Modal -->
<div aria-hidden="true" class="modalOverlay modalApp" id="commentModal">
<div aria-label="Izohlar" aria-modal="true" class="modal glass" role="dialog">
<div class="modalHead">
<div>
<div class="modalTitle">Izohlar</div>
<div class="small">Barcha izohlar</div>
</div>
<div style="display:flex; align-items:center; gap:10px;">
<span class="pill" id="commentCount">0</span>
<button aria-label="Yopish" class="iconBtn" id="commentClose" type="button">‚úï</button>
</div>
</div>
<div class="hr"></div>
<div class="modalBody">
<div class="commentBox" style="margin-top:0;">
<input id="commentInput" maxlength="140" placeholder="Izoh yozing‚Ä¶ (140 ta belgi)"/>
<button class="btn btnPrimary" id="commentSend">Yuborish</button>
</div>
<div class="hr"></div>
<ul class="commentList" id="commentList"></ul>
<div style="height:10px;"></div>
<button class="btn" id="cmLoadMoreInline" type="button">Yana yuklash</button>
</div>
</div>
</div>
<!-- Leaderboard Modal -->
<div aria-hidden="true" class="modalOverlay modalApp" id="lbModal">
<div aria-label="Reyting" aria-modal="true" class="modal glass" role="dialog">
<div class="modalHead">
<div>
<div class="modalTitle">Reyting ‚Äî barcha o‚Äòrinlar</div>
<div class="small" id="lbModalHint">Ball bo‚Äòyicha saralangan</div>
</div>
<button aria-label="Yopish" class="iconBtn" id="lbModalClose" type="button">‚úï</button>
</div>
<div class="hr"></div>
<div class="modalBody">
<table aria-label="Leaderboard all" class="table">
<thead>
<tr>
<th style="width:60px;">#</th>
<th>Foydalanuvchi</th>
<th style="width:90px;">Ball</th>
</tr>
</thead>
<tbody id="lbAllBody">
<tr><td class="small" colspan="3">Yuklanmoqda‚Ä¶</td></tr>
</tbody>
</table>
<div style="height:10px;"></div>
<button class="btn" id="lbLoadMore" type="button">Yana yuklash</button>
</div>
</div>
</div>
<!-- Notifications Modal -->
<div aria-hidden="true" class="modalOverlay modalApp" id="notifModal">
<div aria-label="Bildirishnomalar" aria-modal="true" class="modal glass" role="dialog">
<div class="modalHead">
<div>
<div class="modalTitle">Bildirishnomalar</div>
<div class="small" id="notifHint">Yangi xabarlar shu yerda chiqadi</div>
</div>
<div style="display:flex; align-items:center; gap:10px;">
<button class="chipBtn" id="notifMarkAll" type="button">‚úÖ Hammasini o‚Äòqildi</button>
<button aria-label="Yopish" class="iconBtn" id="notifClose" type="button">‚úï</button>
</div>
</div>
<div class="hr"></div>
<div class="modalBody">
<ul class="notifList" id="notifList"></ul>
<div style="height:10px;"></div>
<button class="btn" id="notifLoadMore" type="button">Yana yuklash</button>
</div>
</div>
</div>
<!-- Level Up Modal (Medalyon) -->
<div aria-hidden="true" class="modalOverlay modalApp" id="levelUpModal" style="display:none;">
<div aria-label="Yangi bosqich" aria-modal="true" class="modal glass" role="dialog">
<div class="modalHead">
<div>
<div class="modalTitle">Tabriklaymiz! üéâ</div>
<div class="small" id="levelUpSub">Siz yangi darajaga ko'tarildingiz!</div>
</div>
<button aria-label="Yopish" class="iconBtn" id="levelUpClose" type="button">‚úï</button>
</div>
<div class="hr"></div>
<div class="modalBody" style="display:flex;flex-direction:column;align-items:center;gap:10px;text-align:center;">
<img alt="Medalyon" id="levelUpImg" src="logo.png" style="width:120px;height:120px;border-radius:24px;border:1px solid rgba(20,40,60,.12);background:rgba(255,255,255,.55);object-fit:contain;"/>
<div id="levelUpTitle" style="font-weight:900;font-size:16px;">Daraja: 1</div>
<div class="small muted" id="levelUpHint">Keyingi bosqichga yaqinlashishda davom eting!</div>
<button class="btn btnPrimary" id="levelUpOk" style="width:min(320px,100%);" type="button">Zo'r! Davom etaman</button>
</div>
</div>
</div>
<!-- Embedded viewer (single-page feel) -->
<div aria-hidden="true" class="modalOverlay modalApp" id="embedModal">
<div aria-label="Oyna" aria-modal="true" class="modal glass" role="dialog">
<div class="modalHead">
<div>
<div class="modalTitle" id="embedTitle">Oyna</div>
<div class="small muted" id="embedSub">LeaderMath.UZ</div>
</div>
<div style="display:flex; align-items:center; gap:10px;">
<button aria-label="Yopish" class="iconBtn" id="embedClose" type="button">‚úï</button>
</div>
</div>
<div class="hr"></div>
<div class="modalBody" style="padding:0;">
<iframe id="embedFrame" style="width:100%; height:70vh; border:0; border-radius: 0 0 var(--r) var(--r); background:transparent;" title="Embed"></iframe>
</div>
</div>
</div>
<!-- Onboarding overlay (original flow preserved) -->
<div id="onboardOverlay" style="display:none; position:fixed; inset:0; background: rgba(2,6,23,.55); backdrop-filter: blur(10px); z-index: 9998;">
<div class="container" style="display:flex; align-items:center; justify-content:center; min-height: 100%;">
<div class="glass section" style="max-width: 520px; width: 100%;">
<div class="sectionTitle">
<h2>Profilni to‚Äòldiring</h2>
<div class="hint">Birinchi kirishda</div>
</div>
<p class="p">Ism, familiya, tug‚Äòilgan sana va yangi parolni kiriting.</p>
<div class="hr"></div>
<div class="row">
<input class="input" id="obFirst" placeholder="Ism"/>
<input class="input" id="obLast" placeholder="Familiya"/>
</div>
<div style="height:10px;"></div>
<div class="row">
<input class="input" id="obBirth" placeholder="Tug‚Äòilgan sana (YYYY-MM-DD)" type="date"/>
<input class="input" id="obPass1" placeholder="Yangi parol" type="password"/>
</div>
<div style="height:10px;"></div>
<div class="row">
<input class="input" id="obPass2" placeholder="Yangi parolni takrorlang" type="password"/>
<div></div>
</div>
<div style="height:12px;"></div>
<button class="btn btnPrimary" id="obSave" style="width:100%;">Saqlash va davom etish</button>
<div class="small" style="margin-top:10px;">‚ö†Ô∏è Parolni eslab qoling. Keyingi kirishda shu parol ishlaydi.</div>
</div>
</div>
</div>
<script type="module">
    import { initSeasons } from "./assets/js/seasons.js";
    initSeasons("seasonCanvas");
  </script>
</main>
<footer>
<div class="footer-card">
<div class="footer-left">
<div class="footer-name">LeaderMath.UZ</div>
<div class="small-note">Matematikadan super interaktiv sayt!</div>
</div>
<div class="footer-right">
<a class="footer-link" href="index.html"><i class="fa-solid fa-house"></i> Home</a>

<div class="storeBar" id="lmStoreBar" style="margin-top:10px;">
<a class="storeBtn" id="btnPlayStore" href="#" title="Android (Play Market)"><img class="osIcon" src="icon.png" alt=""> <span>Play Market</span></a>
    <a class="storeBtn" id="btnAppStore" href="#" title="iPhone/iPad (App Store)"><img class="osIcon" src="icon.png" alt=""> <span>App Store</span></a>
<a class="storeBtn" id="btnMsStore" href="#" title="Windows (Microsoft Store)"><img class="osIcon" src="icon.png" alt=""> <span>Microsoft Store</span></a>
    <a class="storeBtn install" id="btnInstallPWA" href="#" title="PWA o‚Äòrnatish"><img class="osIcon" src="icon.png" alt=""> <span>O‚Äòrnatish</span></a>
</div>
</div>
</div>
</footer>
</div>
<div class="toast" id="toast">...</div>
<script src="assets/js/core.js"></script>
<script src="assets/js/pwa.js" defer></script>
<script type="module">
    import { me, logout, updateProfile, changePassword, getToken } from "./assets/js/auth.js";
    import { api } from "./assets/js/api.js";
window.api = api;

    const $ = (id)=>document.getElementById(id);

    // UZ date formatter
    const months = ["yanvar","fevral","mart","aprel","may","iyun","iyul","avgust","sentabr","oktabr","noyabr","dekabr"];
    const days = ["yakshanba","dushanba","seshanba","chorshanba","payshanba","juma","shanba"];
    function setDate(){
      const d = new Date();
      const s = `${days[d.getDay()]}, ${d.getDate()}-${months[d.getMonth()]} ${d.getFullYear()} ‚Ä¢ ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      $("dt").textContent = s;
      const mini = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
      const dtMini = $("dtMini");
      if(dtMini) dtMini.textContent = mini;
    }
    setDate(); setInterval(setDate, 15000);

    // Toast
    const toastEl = $("toast");
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(window.__t);
      window.__t = setTimeout(()=>toastEl.classList.remove("show"), 1800);
    }

    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
    }

    // Simple modal helpers
    function openModal(el){
      if(!el) return;
      // bridge.css modalApp animatsiyasi .open orqali ishlaydi
      el.classList.add("open");
      el.style.display = "flex";
      el.setAttribute("aria-hidden","false");
      document.body.classList.add("noScroll");
    }
    function closeModal(el){
      if(!el) return;
      el.classList.remove("open");
      el.style.display = "none";
      el.setAttribute("aria-hidden","true");
      document.body.classList.remove("noScroll");
    }

    function calcAgePrecise(iso){
      if(!iso) return "‚Äî";
      const b = new Date(iso);
      if(Number.isNaN(b.getTime())) return "‚Äî";
      const n = new Date();
      let y=n.getFullYear()-b.getFullYear();
      let m=n.getMonth()-b.getMonth();
      let d=n.getDate()-b.getDate();
      if(d<0){ m--; d += new Date(n.getFullYear(), n.getMonth(), 0).getDate(); }
      if(m<0){ y--; m+=12; }
      return `${y} yosh ${m} oy ${d} kun`;
    }

    // ===============================
    // Medalyon (9999 gacha) tizimi
    //  - medals/1.webp ... medals/9999.webp (ixtiyoriy: .png fallback)
    //  - Bosqich threshold: T(L) = BASE * (L-1)*L/2
    //    misol: 1‚Üí0, 2‚Üí100, 3‚Üí300, 4‚Üí600 ...
    //  - manifest.json kerak emas
    // ===============================
    var MEDAL_DIR = "medals";
    var LEVEL_MAX = 9999;
    var BASE_STEP = 100; // 100 ball = bazaviy qadam

    function clamp(n, a, b){ n = Number(n)||0; return Math.max(a, Math.min(b, n)); }

    function thresholdForLevel(L){
      L = clamp(L, 1, LEVEL_MAX);
      return Math.round(BASE_STEP * (L-1) * L / 2);
    }

    function levelFromPoints(points){
      var p = Math.max(0, Number(points)||0);
      // L = floor((1 + sqrt(1 + 8*(p/BASE_STEP))) / 2)
      var L = Math.floor((1 + Math.sqrt(1 + 8*(p/BASE_STEP))) / 2);
      return clamp(L, 1, LEVEL_MAX);
    }

    function medalUrl(level){
      var L = clamp(level, 1, LEVEL_MAX);
      return MEDAL_DIR + "/" + L + ".webp";
    }

    // Robust medal loader (low 404):
    // 1) Try current level (webp/png)
    // 2) If missing, try last known working medal level from localStorage (webp/png)
    // 3) Then try 1 (webp/png)
    // 4) Finally logo.png
    function setMedalImg(imgEl, level){
      if(!imgEl) return;

      var L = clamp(level, 1, LEVEL_MAX);
      var bust = "?v=" + Date.now();

      var KEY = "lm_last_medal_ok_level";
      var lastOk = 1;
      try{
        lastOk = clamp(parseInt(localStorage.getItem(KEY), 10) || 1, 1, LEVEL_MAX);
      }catch(_){ lastOk = 1; }

      // Build attempt list (max 6 tries)
      var tries = [
        {l:L, ext:"webp"}, {l:L, ext:"png"},
        {l:lastOk, ext:"webp"}, {l:lastOk, ext:"png"},
        {l:1, ext:"webp"}, {l:1, ext:"png"}
      ];

      var i = 0;

      function doneToLogo(){
        imgEl.onerror = null;
        imgEl.onload = null;
        imgEl.src = "logo.png";
      }

      function tryNext(){
        if(i >= tries.length){ doneToLogo(); return; }

        var t = tries[i++];
        var url = MEDAL_DIR + "/" + t.l + "." + t.ext + bust;

        imgEl.onload = function(){
          imgEl.onload = null;
          imgEl.onerror = null;
          // save last ok medal level
          try{ localStorage.setItem(KEY, String(t.l)); }catch(_){}
        };

        imgEl.onerror = function(){
          imgEl.onerror = null;
          imgEl.onload = null;
          tryNext();
        };

        imgEl.src = url;
      }

      tryNext();
    }

    function renderLevelBars(progress01){
      var wrap = $("levelBars");
      if(!wrap) return;
      var p = Math.max(0, Math.min(1, Number(progress01)||0));
      var N = 12;
      var bars = [];
      for(var i=1;i<=N;i++){
        var wave = 0.45 + 0.55*Math.sin((i/N)*Math.PI);
        var fill = Math.max(0, Math.min(1, (p*N - (i-1))));
        var h = Math.round(10 + 34*wave);
        bars.push(
          '<div style="width:8px;height:'+h+'px;border-radius:10px;background:rgba(15,23,42,.10);border:1px solid rgba(20,40,60,.10);overflow:hidden;">' +
            '<div style="width:100%;height:'+Math.round(h*fill)+'px;margin-top:'+Math.round(h*(1-fill))+'px;background:linear-gradient(180deg, rgba(46,139,87,.85), rgba(59,130,246,.65));border-radius:10px;"></div>' +
          '</div>'
        );
      }
      wrap.innerHTML = bars.join("");
    }

    function openLevelUp(level){
      var modal = $("levelUpModal");
      if(!modal) return;

      var img = $("levelUpImg");
      var ttl = $("levelUpTitle");
      var sub = $("levelUpSub");
      var hint = $("levelUpHint");

      var L = clamp(level, 1, LEVEL_MAX);

      if(img) setMedalImg(img, L);
      if(ttl) ttl.textContent = "Daraja: " + L + " ‚Ä¢ Yangi daraja!";
      if(sub) sub.textContent = "Siz " + L + "-bosqichga o‚Äòtdingiz";

      if(hint){
        if(L < LEVEL_MAX){
          var next = thresholdForLevel(L+1);
          hint.textContent = "Keyingi bosqich uchun: " + next + " ball";
        }else{
          hint.textContent = "Siz maksimal darajadasiz!";
        }
      }

      openModal(modal);
    }

    function setupLevelUpModal(){
      var modal = $("levelUpModal");
      var closeBtn = $("levelUpClose");
      var okBtn = $("levelUpOk");
      if(closeBtn) closeBtn.addEventListener("click", function(){ closeModal(modal); });
      if(okBtn) okBtn.addEventListener("click", function(){ closeModal(modal); });
      if(modal){
        modal.addEventListener("click", function(e){
          if(e.target === modal) closeModal(modal);
        });
      }
    }

    function updateMedalUI(points){
      var p = Math.max(0, Number(points)||0);
      var L = levelFromPoints(p);

      // Header avatar: medal kabi ko‚Äòrsatish
      var headImg = $("userAvatar");
      if(headImg){
        setMedalImg(headImg, L);
        headImg.alt = "medalyon";
        headImg.dataset.level = String(L);
      }

      // Big medal section
      var big = $("medalLarge");
      if(big){
        setMedalImg(big, L);
      }

      var curStart = thresholdForLevel(L);
      var nextStart = (L < LEVEL_MAX) ? thresholdForLevel(L+1) : thresholdForLevel(LEVEL_MAX);
      var span = Math.max(1, nextStart - curStart);
      var pct = (L >= LEVEL_MAX) ? 1 : Math.max(0, Math.min(1, (p - curStart)/span));

      if($("levelText")) $("levelText").textContent = "Daraja: " + L + " / " + LEVEL_MAX;
      if($("levelRange")) $("levelRange").textContent = (L < LEVEL_MAX) ? (curStart + " ‚Üí " + nextStart) : (nextStart + " (MAX)");
      if($("levelProgress")) $("levelProgress").style.width = Math.round(pct*100) + "%";
      if($("levelPct")) $("levelPct").textContent = Math.round(pct*100) + "%";
      if($("nextHint")) $("nextHint").textContent = (L < LEVEL_MAX) ? ("Keyingi darajagacha: " + Math.max(0, nextStart - p) + " ball") : "Siz maksimal darajaga yetdingiz!";

      renderLevelBars(pct);

      // Level-up detect (local only)
      var KEY = "lm_medal_level";
      var prev = 0;
      try{ prev = Number(localStorage.getItem(KEY) || 0) || 0; }catch(_){ prev = 0; }

      if(L > prev){
        try{ localStorage.setItem(KEY, String(L)); }catch(_){}
        if(prev > 0) openLevelUp(L);
      }else if(prev === 0){
        try{ localStorage.setItem(KEY, String(L)); }catch(_){}
      }
    }


// ===============================
    // Single-page home (Video Hero + Challenge + Tests + Simulators)
    // ===============================

    function setupHeroVideo(){
      const v = $("heroVideo");
      const playBtn = $("playPauseBtn");
      const muteBtn = $("muteBtn");
      if(!v) return;

      // Autoplay policy: start muted (default)
      v.muted = true;

      // Try to play (some browsers may block until user gesture ‚Äî that's OK)
      const tryPlay = ()=>{ try{ const p=v.play(); if(p&&p.catch) p.catch(()=>{}); }catch(_){ } };
      tryPlay();

      // Play/Pause toggle
      playBtn?.addEventListener("click", ()=>{
        if(v.paused){
          tryPlay();
          if(playBtn) playBtn.textContent = "‚è∏";
        }else{
          v.pause();
          if(playBtn) playBtn.textContent = "‚ñ∂Ô∏è";
        }
      });

      // Mute/Unmute toggle
      muteBtn?.addEventListener("click", ()=>{
        v.muted = !v.muted;
        if(muteBtn) muteBtn.textContent = v.muted ? "üîá" : "üîä";
      });

      // If video ends unexpectedly (shouldn't with loop), keep it running
      v.addEventListener("ended", tryPlay);

      // Optional: tap video to toggle play/pause (mobile friendly)
      v.addEventListener("click", ()=>{
        if(v.paused){ tryPlay(); if(playBtn) playBtn.textContent="‚è∏"; }
        else { v.pause(); if(playBtn) playBtn.textContent="‚ñ∂Ô∏è"; }
      }, {passive:true});
    }

    // ---- Challenge (code + start) ----
    function setupChallenge(){
      const input = $("challengeCode");
      const btn = $("challengeStart");
      btn?.addEventListener("click", ()=>{
        const code = (input?.value||"").trim();
        if(!code){ toast("Challenge kodi kiriting"); input?.focus(); return; }
        sessionStorage.setItem("lm_challenge_code", code);
        // Single-page: open embedded test.html (challenge kod bilan)
        openEmbed(`test.html#challenge`, `Challenge: ${code}`);
        // Also prefill for test.html if it wants
        localStorage.setItem("lm_lastChallengeCode", code);
      });
    }

    
    // ---- Tests & Simulators removed (unused on home) ----
// ---- Embedded viewer modal ----
    function openEmbed(url, title){
      const modal = $("embedModal");
      const frame = $("embedFrame");
      const ttl = $("embedTitle");
      if(!modal || !frame) { location.href = url; return; }
      ttl.textContent = title || "";
      frame.src = url;
      modal.style.display = "flex";
      document.body.style.overflow = "hidden";
    }
    function closeEmbed(){
      const modal = $("embedModal");
      const frame = $("embedFrame");
      if(!modal) return;
      modal.style.display = "none";
      if(frame) frame.src = "about:blank";
      document.body.style.overflow = "";
    }

    async function runOnboarding(){
      return new Promise((resolve)=>{
        const overlay=$("onboardOverlay");
        const bSave=$("obSave");
        overlay.style.display="flex";
        bSave.onclick = async ()=>{
          bSave.disabled=true;
          try{
            const first=$("obFirst").value.trim();
            const last=$("obLast").value.trim();
            const birth=$("obBirth").value.trim();
            const p1=$("obPass1").value, p2=$("obPass2").value;
            if(first.length<2) throw new Error("Ism kamida 2 ta harf bo‚Äòlsin");
            if(last.length<2) throw new Error("Familiya kamida 2 ta harf bo‚Äòlsin");
            if(!birth) throw new Error("Tug‚Äòilgan sanani kiriting");
            if(p1.length<6) throw new Error("Yangi parol kamida 6 belgidan iborat bo‚Äòlsin");
            if(p1!==p2) throw new Error("Parollar mos emas");
            await changePassword(p1);
            await updateProfile(first,last,birth);
            overlay.style.display="none";
            resolve(true);
          }catch(e){ toast(e.message||"Xatolik"); }
          finally{ bSave.disabled=false; }
        };
      });
    }

    // Leaderboard (interactive)
    let lbAll = [];
    let lbMeOnly = false;
    let lbQuery = "";
    let myLoginId = null;

    function medal(i){
      return i===0 ? "ü•á" : i===1 ? "ü•à" : i===2 ? "ü•â" : "";
    }

    

function calcAgeFromBirth(b){
      if(!b) return null;
      try{
        // accept "YYYY-MM-DD" or timestamp or Date-like
        const d = (typeof b === "number") ? new Date(b) : new Date(String(b));
        if(!isFinite(d.getTime())) return null;
        const now = new Date();
        let a = now.getFullYear() - d.getFullYear();
        const m = now.getMonth() - d.getMonth();
        if(m < 0 || (m===0 && now.getDate() < d.getDate())) a--;
        return (a>=0 && a<=120) ? a : null;
      }catch(_){ return null; }
    }

    function exportLbToRating(items){
      try{
        const arr = (items||[]).map((u, idx)=>({
          name: u.name || u.fullName || u.displayName || u.loginId || "‚Äî",
          numericId: u.loginId || u.numericId || u.id || u.userId || "",
          points: Number(u.points||u.xp||u.totalXP||0)||0,
          xp: Number(u.points||u.xp||u.totalXP||0)||0,
          age: (u.age!=null? parseInt(u.age,10): null) ?? calcAgeFromBirth(u.birth || u.birthdate || u.birthDate),
          avatar: u.avatar || u.photoURL || u.photo || u.avatarUrl || "icon.png",
          medal: medal(idx),
          uid: u.uid || u.userUid || ""
        }));
        window.leaderboardData = arr;
        if(window.renderRatingMobile) window.renderRatingMobile();
      }catch(_){}
    }

function renderLeaderboard(){
      const body = $("lbBody");
      const podium = $("lbPodium");
      if(!body || !podium) return;

      // Keep query in a local variable to avoid ReferenceError (q)
      const q = (lbQuery||"").toLowerCase();

      let items = lbAll.slice();
      if(lbMeOnly && myLoginId){
        items = items.filter(u=>String(u.loginId||"")===String(myLoginId));
      }
      if(q){
        items = items.filter(u=>
          String(u.loginId||"").toLowerCase().includes(q) ||
          String(u.name||"").toLowerCase().includes(q)
        );
      }

      const top = items.slice(0,3);
      const topPts = Number(top?.[0]?.points || 0) || 1;

      // Podium (Top-3)
      podium.innerHTML = top.map((u,i)=>{
        const pts = Number(u.points||0);
        const pct = Math.max(8, Math.round((pts/topPts)*100));
        const me = myLoginId && String(u.loginId||"")===String(myLoginId);
        return `
          <button class="podCard ${me?"me":""}" type="button" data-pick="${escapeHtml(u.loginId||"")}" title="${escapeHtml(u.name||u.loginId||"")}">
            <div class="podTop">
              <div class="podMedal">${medal(i)}</div>
              <div class="podRank">#${i+1}</div>
            </div>
            <div class="podName">${escapeHtml(u.name || u.loginId || "‚Äî")}</div>
            <div class="podId">${escapeHtml(u.loginId || "")}</div>
            <div class="podBar"><span style="width:${pct}%"></span></div>
            <div class="podPts">${pts} ball</div>
          </button>
        `;
      }).join("") || `<div class="small">Hozircha reyting yo‚Äòq</div>`;

      // Table (Top-20 of filtered)
      const show = items.slice(0,20);
      body.innerHTML = show.map((u,i)=>{
        const pts = Number(u.points||0);
        const me = myLoginId && String(u.loginId||"")===String(myLoginId);
        const pct = Math.max(6, Math.round((pts/topPts)*100));
        return `
          <tr class="lbRow ${me?"me":""}" data-pick="${escapeHtml(u.loginId||"")}">
            <td><span class="rankBadge">${i+1}</span></td>
            <td>
              <div class="nameLine">${escapeHtml(u.name || u.loginId || "‚Äî")}</div>
              <div class="small">${escapeHtml(u.loginId || "")}</div>
              <div class="miniBar"><span style="width:${pct}%"></span></div>
            </td>
            <td><b>${pts}</b></td>
          </tr>
        `;
      }).join("") || `<tr><td colspan="3" class="small">Mos natija topilmadi</td></tr>`;
    }

    async function loadLeaderboard(){
      const body = $("lbBody");
      if(!body) return;
      body.innerHTML = `<tr><td colspan="3" class="small">Yuklanmoqda‚Ä¶</td></tr>`;
      try{
        const data = await api("leaderboard", { query: { limit: 120 } });
        lbAll = (data?.items || []);
        exportLbToRating(lbAll);
        renderLeaderboard();
      }catch(_){
        body.innerHTML = `<tr><td colspan="3" class="small">Reytingni yuklab bo‚Äòlmadi</td></tr>`;
      }
    }

    // ===== Leaderboard modal (all with paging) =====
    let lbCursor = null;
    let lbRankBase = 0;
    async function loadLeaderboardMore(reset=false){
      const body = $("lbAllBody");
      const btn = $("lbLoadMore");
      try{
        btn.disabled = true;
        if(reset){
          lbCursor = null;
          lbRankBase = 0;
          body.innerHTML = `<tr><td colspan="3" class="small">Yuklanmoqda‚Ä¶</td></tr>`;
        }
        const data = await api("leaderboard", { query: { limit: 60, cursor: lbCursor } });
        const items = data?.items || [];
        if(reset) body.innerHTML = "";
        body.insertAdjacentHTML("beforeend", items.map((u,i)=>`
          <tr>
            <td><span class="rankBadge">${lbRankBase + i + 1}</span></td>
            <td>
              <div class="nameLine">${escapeHtml(u.name || u.loginId || "‚Äî")}</div>
              <div class="small">${escapeHtml(u.loginId || "")}</div>
            </td>
            <td><b>${Number(u.points||0)}</b></td>
          </tr>
        `).join(""));
        lbRankBase += items.length;
        lbCursor = data?.nextCursor || null;
        btn.style.display = lbCursor ? "inline-flex" : "none";
        if(!items.length && reset){
          body.innerHTML = `<tr><td colspan="3" class="small">Hozircha reyting yo‚Äòq</td></tr>`;
          btn.style.display = "none";
        }
      }catch(_){
        if(reset) body.innerHTML = `<tr><td colspan="3" class="small">Reytingni yuklab bo‚Äòlmadi</td></tr>`;
      }finally{
        btn.disabled = false;
      }
    }

    // Comments
    function fmtTime(ts){
      const d = ts ? new Date(ts) : new Date();
      return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }
    let likedSet = new Set();

    function renderReplies(replies){
      const items = (replies||[]).map(r=>`
        <li class="replyItem">
          <div class="top">
            <div class="nameLine">${escapeHtml(r.name || r.loginId || "‚Äî")}</div>
            <div class="small">${escapeHtml(fmtTime(r.createdAt))}</div>
          </div>
          <div class="replyText">${escapeHtml(r.text || "")}</div>
        </li>
      `).join("");
      return items || `<li class="small">Hozircha javob yo‚Äòq</li>`;
    }

    function renderCommentItem(c){
      const liked = likedSet.has(String(c.id));
      const isOwner = myLoginId && String(c.loginId||"") === String(myLoginId);
      const edited = c.edited === true;
      return `
        <li class="commentItem" data-id="${escapeHtml(c.id)}">
          <div class="top">
            <div class="nameLine">${escapeHtml(c.name || c.loginId || "‚Äî")}</div>
            <div class="small">${escapeHtml(fmtTime(c.createdAt))}</div>
          </div>
          <div class="commentText" data-role="text">${escapeHtml(c.text || "")}</div>
          ${edited ? `<div class="small editedTag">tahrirlangan</div>` : ``}

          ${isOwner ? `
            <div class="ownerActions">
              <button class="miniBtn" data-act="edit" type="button" title="Tahrirlash">‚úé</button>
              <button class="miniBtn danger" data-act="delete" type="button" title="O‚Äòchirish">üóë</button>
            </div>
          ` : ``}

          <div class="commentActions compact">
            <button class="actBtn ${liked?"liked":""}" data-act="like" type="button" aria-label="Like">
              <span class="ic">‚ù§</span>
              <span class="lbl">Like</span>
              <span class="cnt" data-k="likeCount">${Number(c.likeCount||0)}</span>
            </button>
            <button class="actBtn" data-act="toggleReplies" type="button" aria-label="Javoblar">
              <span class="ic">‚Ü©</span>
              <span class="lbl">Reply</span>
              <span class="cnt" data-k="replyCount">${Number(c.replyCount||0)}</span>
            </button>
          </div>

          <div class="repliesWrap" data-open="0">
            <ul class="replyList" data-loaded="0"></ul>
            <div class="replyBox">
              <input class="replyInput" maxlength="160" placeholder="Javob yozing‚Ä¶ (160)" />
              <button class="btn btnPrimary replySend" data-act="sendReply" type="button">Yuborish</button>
            </div>
          </div>
        </li>
      `;
    }

    async function loadLiked(){
      likedSet = new Set();
      try{
        const token = await getToken();
        const data = await api("comments/liked", { token });
        for(const id of (data?.ids || [])) likedSet.add(String(id));
      }catch(_){ /* ignore */ }
    }

    // ===== Comments (always show all, paging in the panel) =====
    let cmCursor = null;
    let latestCommentMs = 0;
    const COMMENTS_SEEN_KEY = "lm_comments_seen_ms";

    function toMillis(v){
      if(v==null) return 0;
      if(typeof v === "number") return v;
      const t = Date.parse(v);
      return Number.isFinite(t) ? t : 0;
    }

    function updateCommentBadge(){
      const b = $("cmBadge");
      if(!b) return;
      const seen = Number(localStorage.getItem(COMMENTS_SEEN_KEY) || 0);
      const hasNew = seen > 0 && latestCommentMs > seen;
      b.textContent = hasNew ? "NEW" : "";
      b.style.display = hasNew ? "inline-flex" : "none";
    }

    function markCommentsSeen(){
      if(latestCommentMs > 0){
        localStorage.setItem(COMMENTS_SEEN_KEY, String(latestCommentMs));
      }else{
        localStorage.setItem(COMMENTS_SEEN_KEY, String(Date.now()));
      }
      updateCommentBadge();
    }
    async function loadComments(reset=false){
      const list = $("commentList");
      const btn = $("cmLoadMoreInline");
      const count = $("commentCount");
      try{
        btn.disabled = true;
        if(reset){
          cmCursor = null;
          list.innerHTML = `<li class="small">Yuklanmoqda‚Ä¶</li>`;
        }
        await loadLiked();
        const data = await api("comments", { query: { limit: 30, cursor: cmCursor } });
        const items = data?.items || [];
        // Track newest comment time to show a tiny "NEW" badge on the touch button
        for(const it of items){
          const ms = toMillis(it.createdAt || it.time || it.ts);
          if(ms > latestCommentMs) latestCommentMs = ms;
        }
        if(reset) list.innerHTML = "";
        list.insertAdjacentHTML("beforeend", items.map(renderCommentItem).join(""));
        cmCursor = data?.nextCursor || null;
        btn.style.display = cmCursor ? "inline-flex" : "none";
        // total (if server returns it), else show loaded count
        const total = Number(data?.total || 0);
        const loaded = list.querySelectorAll(".commentItem").length;
        count.textContent = total ? String(total) : String(loaded);
        if(!items.length && reset){
          list.innerHTML = `<li class="small">Hozircha izoh yo‚Äòq. Birinchi bo‚Äòling üôÇ</li>`;
          btn.style.display = "none";
          count.textContent = "0";
        }

        updateCommentBadge();
      }catch(_){
        if(reset) list.innerHTML = `<li class="small">Izohlarni yuklab bo‚Äòlmadi</li>`;
      }finally{
        btn.disabled = false;
      }
    }

    async function loadReplies(commentId, li){
      const wrap = li.querySelector(".repliesWrap");
      const ul = li.querySelector(".replyList");
      if(!wrap || !ul) return;
      try{
        const data = await api("comments/replies", { method:"POST", body:{ commentId, limit: 30 } });
        ul.innerHTML = renderReplies(data?.items || []);
        ul.setAttribute("data-loaded","1");
      }catch(_){
        ul.innerHTML = `<li class="small">Javoblarni yuklab bo‚Äòlmadi</li>`;
      }
    }

    function setRepliesOpen(li, open){
      const wrap = li.querySelector(".repliesWrap");
      if(!wrap) return;
      wrap.setAttribute("data-open", open?"1":"0");
    }

    // Delegated actions on comment lists (preview + modal)
    async function handleCommentActions(e){
      const btn = e.target.closest("button[data-act]");
      if(!btn) return;
      const li = e.target.closest(".commentItem");
      if(!li) return;
      const id = li.getAttribute("data-id");
      const act = btn.getAttribute("data-act");

      if(act === "like"){
        try{
          const token = await getToken();
          const out = await api("comments/like", { method:"POST", token, body:{ commentId: id } });
          const liked = !!out.liked;
          if(liked) likedSet.add(String(id)); else likedSet.delete(String(id));
          btn.classList.toggle("liked", liked);
          const cnt = li.querySelector('[data-k="likeCount"]');
          if(cnt) cnt.textContent = String(out.likeCount ?? 0);
        }catch(_){ toast("Like uchun kirish kerak"); }
        return;
      }

      if(act === "toggleReplies"){
        const wrap = li.querySelector(".repliesWrap");
        const isOpen = wrap?.getAttribute("data-open") === "1";
        setRepliesOpen(li, !isOpen);
        const ul = li.querySelector(".replyList");
        if(!isOpen && ul && ul.getAttribute("data-loaded") !== "1"){
          await loadReplies(id, li);
        }
        return;
      }

      if(act === "sendReply"){
        const input = li.querySelector(".replyInput");
        const text = (input?.value || "").trim();
        if(!text) return toast("Javob bo‚Äòsh");
        try{
          const token = await getToken();
          btn.disabled = true;
          await api("comments/reply", { method:"POST", token, body:{ commentId: id, text } });
          if(input) input.value = "";
          toast("Javob yuborildi ‚úÖ");
          // update reply count UI
          const rc = li.querySelector('[data-k="replyCount"]');
          if(rc) rc.textContent = String(Number(rc.textContent||0) + 1);
          await loadReplies(id, li);
          setRepliesOpen(li, true);
        }catch(_){ toast("Reply uchun kirish kerak"); }
        finally{ btn.disabled = false; }
        return;
      }

      if(act === "edit"){
        const textEl = li.querySelector('[data-role="text"]');
        const cur = textEl ? (textEl.textContent || "") : "";
        // swap to editor
        li.classList.add("editing");
        if(textEl){
          textEl.innerHTML = `
            <textarea class="editArea" maxlength="140">${escapeHtml(cur)}</textarea>
            <div class="editBar">
              <button class="btn btnPrimary btnSm" data-act="saveEdit" type="button">Saqlash</button>
              <button class="btn btnSm" data-act="cancelEdit" type="button">Bekor</button>
            </div>
          `;
        }
        return;
      }

      if(act === "cancelEdit"){
        // easiest: reload comments to restore template
        await loadComments(true);
        return;
      }

      if(act === "saveEdit"){
        const area = li.querySelector(".editArea");
        const text = (area?.value || "").trim();
        if(!text) return toast("Izoh bo‚Äòsh");
        try{
          const token = await getToken();
          btn.disabled = true;
          await api("comments/update", { method:"POST", token, body:{ commentId: id, text } });
          toast("Tahrirlandi ‚úÖ");
          await loadComments(true);
        }catch(_){ toast("Tahrirlash uchun ruxsat yo‚Äòq"); }
        finally{ btn.disabled = false; }
        return;
      }

      if(act === "delete"){
        if(!confirm("Izoh o‚Äòchirilsinmi?")) return;
        try{
          const token = await getToken();
          btn.disabled = true;
          await api("comments/delete", { method:"POST", token, body:{ commentId: id } });
          toast("O‚Äòchirildi ‚úÖ");
          await loadComments(true);
        }catch(_){ toast("O‚Äòchirish uchun ruxsat yo‚Äòq"); }
        finally{ btn.disabled = false; }
        return;
      }
    }

    $("commentList").addEventListener("click", handleCommentActions, { passive:false });
    async function sendComment(){
      const input = $("commentInput");
      const text = (input.value||"").trim();
      if(!text) return toast("Izoh bo‚Äòsh");
      input.value = "";
      try{
        const token = await getToken();
        await api("comments", { method:"POST", token, body: { text } });
        toast("Yuborildi ‚úÖ");
        await loadComments(true);
      }catch(e){
        toast("Xato: yuborilmadi");
      }
    }

    // Modal wiring (leaderboard only)
    const lbModal = $("lbModal");
    const btnLbAll = $("btnLbAll");
    const lbClose = $("lbModalClose");
    const lbMore = $("lbLoadMore");
    if(btnLbAll && lbModal){ btnLbAll.onclick = async ()=>{ openModal(lbModal); await loadLeaderboardMore(true); }; }
    if(lbClose && lbModal){ lbClose.onclick = ()=>closeModal(lbModal); }
    if(lbMore){ lbMore.onclick = ()=>loadLeaderboardMore(false); }

    // close on backdrop click
    if(lbModal){ lbModal.addEventListener("click", (e)=>{ if(e.target === lbModal) closeModal(lbModal); }); }

    // ===== Notifications =====
    const notifModal = $("notifModal");
    let notifCursor = null;
    async function refreshUnread(){
      try{
        const token = await getToken();
        const d = await api("notifications/unread-count", { token });
        const n = Number(d?.unreadCount||0);
        const b = $("notifBadge");
        const bell = $("btnBell");
        if(b){
          b.textContent = String(n);
          b.style.display = n>0 ? "inline-flex" : "none";
        }
        if(bell) bell.classList.toggle("hasUnread", n>0);
      }catch(_){
        const b = $("notifBadge");
        if(b) b.style.display = "none";
        const bell = $("btnBell");
        if(bell) bell.classList.remove("hasUnread");
      }
    }

    function renderNotifItem(n){
      const read = !!n.read;
      return `
        <li class="notifItem ${read?"read":"unread"}" data-id="${escapeHtml(n.id)}">
          <div class="top">
            <div class="nameLine">${escapeHtml(n.title||"Xabar")}</div>
            <div class="small">${escapeHtml(fmtTime(n.createdAt))}</div>
          </div>
          <div class="notifBody">${escapeHtml(n.body||"")}</div>
          <div class="notifActions">
            <button class="miniBtn ghost" data-act="delNotif" type="button" aria-label="O‚Äòchirish">üóë</button>
            ${read?"":"<button class=\"miniBtn\" data-act=\"readNotif\" type=\"button\">O‚Äòqildi</button>"}
          </div>
        </li>
      `;
    }

    async function loadNotifs(reset=false){
      const list = $("notifList");
      const btn = $("notifLoadMore");
      try{
        btn.disabled = true;
        if(reset){
          notifCursor = null;
          list.innerHTML = `<li class="small">Yuklanmoqda‚Ä¶</li>`;
        }
        const token = await getToken();
        const data = await api("notifications", { token, query:{ limit: 20, cursor: notifCursor } });
        const items = data?.items || [];
        if(reset) list.innerHTML = "";
        list.insertAdjacentHTML("beforeend", items.map(renderNotifItem).join(""));
        notifCursor = data?.nextCursor || null;
        btn.style.display = notifCursor ? "inline-flex" : "none";
        const unreadCount = Number(data?.unreadCount||0);
        const b = $("notifBadge");
        if(b){
          b.textContent = String(unreadCount);
          b.style.display = unreadCount>0 ? "inline-flex" : "none";
        }
        if(!items.length && reset){
          list.innerHTML = `<li class="small">Hozircha bildirishnoma yo‚Äòq üôÇ</li>`;
          btn.style.display = "none";
        }
      }catch(_){
        if(reset) $("notifList").innerHTML = `<li class="small">Yuklab bo‚Äòlmadi</li>`;
      }finally{ btn.disabled = false; }
    }

    async function markNotifRead(id){
      const token = await getToken();
      await api("notifications/read", { method:"POST", token, body:{ id } });
    }
    async function deleteNotif(id){
      const token = await getToken();
      await api("notifications/delete", { method:"POST", token, body:{ id } });
    }
    async function markAllRead(){
      const token = await getToken();
      await api("notifications/read", { method:"POST", token, body:{ all:true } });
    }

    $("btnBell")?.addEventListener("click", async ()=>{ openModal(notifModal); await loadNotifs(true); });
    $("notifClose")?.addEventListener("click", ()=>closeModal(notifModal));
    $("notifLoadMore")?.addEventListener("click", ()=>loadNotifs(false));
    $("notifMarkAll")?.addEventListener("click", async ()=>{ try{ await markAllRead(); await loadNotifs(true); await refreshUnread(); }catch(_){ toast("Xato"); } });
    notifModal.addEventListener("click", (e)=>{ if(e.target===notifModal) closeModal(notifModal); });
    $("notifList")?.addEventListener("click", async (e)=>{
      const li = e.target.closest(".notifItem");
      const id = li?.getAttribute("data-id");
      if(!id) return;

      const del = e.target.closest("button[data-act='delNotif']");
      if(del){
        try{ del.disabled = true; await deleteNotif(id); li.remove(); await refreshUnread(); }
        catch(_){ toast("Xato"); }
        finally{ del.disabled = false; }
        return;
      }

      const b = e.target.closest("button[data-act='readNotif']");
      if(!b) return;
      try{ b.disabled = true; await markNotifRead(id); li.classList.add("read"); li.classList.remove("unread"); await refreshUnread(); }
      catch(_){ toast("Xato"); }
      finally{ b.disabled=false; }
    });

    $("btnLogout").onclick = ()=>{ logout(); location.href="./"; };
    $("commentSend").onclick = sendComment;
    $("commentInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendComment(); });
    $("cmLoadMoreInline").onclick = ()=>loadComments(false);

    // Leaderboard interactivity
    $("lbSearch")?.addEventListener("input", (e)=>{
      lbQuery = e.target.value || "";
      renderLeaderboard();
    });
    $("lbOnlyMe")?.addEventListener("click", (e)=>{
      lbMeOnly = !lbMeOnly;
      e.currentTarget.setAttribute("aria-pressed", String(lbMeOnly));
      e.currentTarget.classList.toggle("active", lbMeOnly);
      renderLeaderboard();
    });
    // Click to spotlight a user in the table/podium
    function pickUser(loginId){
      if(!loginId) return;
      lbQuery = String(loginId);
      const inp = $("lbSearch");
      if(inp) inp.value = lbQuery;
      renderLeaderboard();
    }
    $("lbPodium")?.addEventListener("click", (e)=>{
      const b = e.target.closest("[data-pick]");
      if(b) pickUser(b.getAttribute("data-pick"));
    });
    $("lbBody")?.addEventListener("click", (e)=>{
      const r = e.target.closest("[data-pick]");
      if(r) pickUser(r.getAttribute("data-pick"));
    });

    async function boot(){
      setupTouchFab();
      setupLevelUpModal();

      try{
        const r = await me();
        const u = r.user;
        $("userId").textContent = u.loginId;
        $("userName").textContent = (u.name||u.loginId||"").trim().split(/\s+/)[0] || "";
        $("userPoints").textContent = String(u.points ?? 0);
        updateMedalUI(u.points ?? 0);
        $("userBalance").textContent = String(u.balance ?? 0);
        $("userAge").textContent = calcAgePrecise(u.birthdate);

        myLoginId = u.loginId;
        await refreshUnread();

        // Single-page sections
        setupHeroVideo();
        setupChallenge();
        if (typeof setupTestSearch === "function") setupTestSearch();
        if (typeof setupSimSearch === "function") setupSimSearch();
/* tests removed */
        if (typeof renderSims === "function") renderSims();

        // Embedded viewer modal
        $("embedClose")?.addEventListener("click", closeEmbed);
        $("embedModal")?.addEventListener("click", (e)=>{ if(e.target===$("embedModal")) closeEmbed(); });

        loadLeaderboard();
        loadComments(true);

        if(!u.profileComplete){
          await runOnboarding();
          const r2 = await me();
          $("userName").textContent = r2.user.name || r2.user.loginId;
          $("userAge").textContent = calcAgePrecise(r2.user.birthdate);
          updateMedalUI(r2.user.points ?? 0);
        }
      }catch(e){
        toast(e.message||"Kirish yo‚Äòq");
        setTimeout(()=>location.href="./", 600);
      }
    }
    
    function setupTouchFab(){
      
      // --- Reyting & Izohlar (bottom dock) ---
      const ratingModal = $("ratingModal");
      const commentModal = $("commentModal");

      function openModal(overlayEl, focusId){
        if(!overlayEl) return;
        overlayEl.setAttribute("aria-hidden","false");
        overlayEl.classList.add("open");
        document.body.classList.add("noScroll");
        if(focusId) setTimeout(()=>$(focusId)?.focus(), 50);
      }
      function closeModal(overlayEl){
        if(!overlayEl) return;
        overlayEl.setAttribute("aria-hidden","true");
        overlayEl.classList.remove("open");
        document.body.classList.remove("noScroll");
      }

      // Open buttons
      $("openRating")?.addEventListener("click", ()=> openModal(ratingModal, "ratingClose"));
      $("openRatingInline")?.addEventListener("click", ()=> openModal(ratingModal, "ratingClose"));

      const openCommentsAny = ()=>{
        openModal(commentModal, "commentClose");
        try{ markCommentsSeen(); }catch(_){ }
      };
      $("openCommentsDock")?.addEventListener("click", openCommentsAny);
      $("openComments")?.addEventListener("click", openCommentsAny);

      // Close buttons
      $("ratingClose")?.addEventListener("click", ()=>closeModal(ratingModal));
      $("commentClose")?.addEventListener("click", ()=>closeModal(commentModal));

      // Click outside to close
      ratingModal?.addEventListener("click", (e)=>{ if(e.target===ratingModal) closeModal(ratingModal); });
      commentModal?.addEventListener("click", (e)=>{ if(e.target===commentModal) closeModal(commentModal); });

      // Esc
      document.addEventListener("keydown", (e)=>{
        if(e.key!=="Escape") return;
        if(ratingModal?.classList.contains("open")) closeModal(ratingModal);
        if(commentModal?.classList.contains("open")) closeModal(commentModal);
      });
    }

    boot();

  </script>








<!-- ===== RATING (NEO COMPACT) ===== -->
<div id="ratingModal" class="rtOverlay" aria-hidden="true">
  <div class="rtSheet" role="dialog" aria-modal="true" aria-label="Reyting">
    <div class="rtTopbar">
      <div class="rtLeftTitle">
        <div class="rtTitle">Reyting</div>
        <div class="rtSub">Tengdoshlar orasida natijangizni tahlil qiling</div>
      </div>
      <button id="rtClose" class="rtBtn rtBtnIcon" type="button" title="Yopish">‚úï</button>
    </div>

    <div class="rtControls">
      <button id="rtOnlyMe" class="rtBtn" type="button" aria-pressed="false">‚≠ê Meni</button>

      <div id="rtAgeChips" class="rtSeg" aria-label="Yosh filter">
        <button class="rtChip active" data-age="all" type="button">Hammasi</button>
        <button class="rtChip" data-age="11" type="button">11</button>
        <button class="rtChip" data-age="12" type="button">12</button>
        <button class="rtChip" data-age="13" type="button">13</button>
        <button class="rtChip" data-age="14" type="button">14</button>
        <button class="rtChip" data-age="15" type="button">15</button>
        <button class="rtChip" data-age="16" type="button">16</button>
        <button class="rtChip" data-age="17" type="button">17</button>
        <button class="rtChip" data-age="18+" type="button">18+</button>
      </div>
    </div>

    <div class="rtBody">
      <div id="rtState" class="rtState">
        <div class="rtSpin"></div>
        <div>Reyting yuklanmoqda‚Ä¶</div>
      </div>

      <div id="rtMeCard" class="rtMeCard" hidden></div>

      <div class="rtSectionTitle">
        <span>üèÜ Top 3</span>
        <span class="rtHint">eng yuqori XP</span>
      </div>
      <div id="rtPodium" class="rtPodium" aria-label="Top 3"></div>

      <div class="rtSectionTitle">
        <span>üìã Barchasi</span>
        <span class="rtHint">ro‚Äòyxat</span>
      </div>
      <div id="rtList" class="rtList" aria-label="Reyting ro‚Äòyxati"></div>

      <div style="height:10px"></div>
    </div>
  </div>
</div>

<script>
/* ===== Rating System: from scratch ===== */
(function(){
  const $ = (id)=>document.getElementById(id);
  const esc = (s)=>String(s??"").replace(/[&<>"']/g,(c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));

  function openRating(){
    const m = $("ratingModal");
    if(!m) return;
    m.classList.add("open");
    m.setAttribute("aria-hidden","false");
    document.documentElement.classList.add("noScroll");
    loadAndRender();
  }
  function closeRating(){
    const m = $("ratingModal");
    if(!m) return;
    m.classList.remove("open");
    m.setAttribute("aria-hidden","true");
    document.documentElement.classList.remove("noScroll");
  }

  function medalByRank(i){
    if(i===0) return "ü•á";
    if(i===1) return "ü•à";
    if(i===2) return "ü•â";
    return "üèÖ";
  }
  function calcAge(b){
    if(!b) return null;
    try{
      const d = (typeof b==="number") ? new Date(b) : new Date(String(b));
      if(!isFinite(d.getTime())) return null;
      const now = new Date();
      let a = now.getFullYear() - d.getFullYear();
      const m = now.getMonth() - d.getMonth();
      if(m<0 || (m===0 && now.getDate()<d.getDate())) a--;
      return (a>=0 && a<=120) ? a : null;
    }catch(_){ return null; }
  }
  function pick(u, keys, fallback=null){
    for(const k of keys){
      if(u && u[k]!=null && u[k]!== "") return u[k];
    }
    return fallback;
  }

  function getAge(u){
    const direct = pick(u, ["age","userAge"]);
    if(direct!=null){
      const n = parseInt(direct,10);
      if(Number.isFinite(n)) return n;
    }
    const b = pick(u, ["birth","birthdate","birthDate","bday","dob"]);
    const a = calcAge(b);
    return a;
  }

  function normalize(items){
    const arr = (items||[]).map((u)=>({
      uid: pick(u, ["uid","userUid"], ""),
      numericId: String(pick(u, ["loginId","numericId","id","userId"], "")),
      name: String(pick(u, ["name","fullName","displayName"], "‚Äî")),
      avatar: String(pick(u, ["avatar","photoURL","photo","avatarUrl","avatarURL"], "icon.png")),
      points: Number(pick(u, ["points","xp","totalXP","totalPoints"], 0)) || 0,
      level: (typeof levelFromPoints==="function") ? levelFromPoints(Number(pick(u, ["points","xp","totalXP","totalPoints"], 0))||0) : 1,
      age: getAge(u),
      raw: u
    }));
    arr.sort((a,b)=>b.points-a.points);
    // attach rank + medal
    arr.forEach((x,i)=>{ x.rank=i+1; x.medal=medalByRank(i); });
    return arr;
  }

  function agePass(age, sel){
    if(sel==="all") return true;
    if(age==null) return false;
    if(sel==="18+") return age>=18;
    const n = parseInt(sel,10);
    return Number.isFinite(n) ? age===n : true;
  }

  function getSelAge(){
    const wrap = $("rtAgeChips");
    const act = wrap ? wrap.querySelector(".rtChip.active") : null;
    return act ? act.getAttribute("data-age") : "all";
  }

  function onlyMeOn(){
    const b = $("rtOnlyMe");
    return b && b.getAttribute("aria-pressed")==="true";
  }

  function matchMe(u){
    const myLoginId = window.currentUserNumericId || window.myLoginId || "";
    const myUid = window.currentUserUid || window.myUid || "";
    if(myLoginId && String(u.numericId)===String(myLoginId)) return true;
    if(myUid && String(u.uid)===String(myUid)) return true;
    return false;
  }

  async function loadAllLeaderboard(){
    // cache
    if(Array.isArray(window.__rtCache) && window.__rtCache.length) return window.__rtCache;

    // Use existing api() helper from assets/js/api.js
    if(typeof window.api !== "function"){
      throw new Error("api() not found");
    }
    // Pull a bigger limit so rating isn't empty
    const data = await window.api("leaderboard", { query: { limit: 500 } });
    const items = data?.items || [];
    window.__rtCache = normalize(items);
    return window.__rtCache;
  }

  function render(state, rows, meRow){
    rows = Array.isArray(rows) ? rows : [];
    const st = $("rtState");
    const pod = $("rtPodium");
    const list = $("rtList");
    const me = $("rtMeCard");

    if(st){
      st.style.display = state ? "flex":"none";
      if(state){
        st.innerHTML = `<div class="rtSpin"></div><div>${esc(state)}</div>`;
      }
    }
    if(!pod || !list) return;

    // Me card
    if(me){
      if(meRow){
        me.hidden = false;
        me.innerHTML = `
          <div class="rtMeGlow"></div>
          <div class="rtRow">
            <img class="rtAv rtMedalImg" data-level="${meRow.level}" src="logo.png" alt="medal">
            <div style="min-width:0">
              <div class="rtName">${esc(meRow.name)}</div>
              <div class="rtMeta">${esc(meRow.medal)} ‚Ä¢ LM-${esc(meRow.numericId||"‚Äî")} ‚Ä¢ ${meRow.age!=null ? esc(meRow.age+" yosh") : "‚Äî"}</div>
            </div>
            <div class="rtRankTag">#${meRow.rank}</div>
          </div>
          <div class="rtXPbig">${meRow.points} XP</div>
        `;
      }else{
        me.hidden = true;
        me.innerHTML = "";
      }
    }

    // Podium
    pod.innerHTML = "";
    rows.slice(0,3).forEach((r)=>{
      const card = document.createElement("div");
      card.className = "rtPodCard";
      card.innerHTML = `
        <div class="rtBadge">#${r.rank}</div>
        <div class="rtRow">
          <img class="rtAv rtMedalImg" data-level="${r.level}" src="logo.png" alt="medal">
          <div class="rtInfo">
            <div class="rtName">${esc(r.name)}</div>
            <div class="rtMeta"><span class="rtMedal">${esc(r.medal)}</span> LM-${esc(r.numericId||"‚Äî")} ‚Ä¢ ${r.age!=null ? esc(r.age+" yosh") : "‚Äî"}</div>
          </div>
        </div>
        <div class="rtPodXP">${r.points} XP</div>
      `;
      pod.appendChild(card);
    });

    // List
    list.innerHTML = "";
    if(!rows.length){
      list.innerHTML = `<div class="rtState" style="margin-top:0"><div>Natija topilmadi</div></div>`;
      return;
    }
    rows.forEach((r)=>{
      const it = document.createElement("div");
      const isMe = matchMe(r);
      it.className = "rtItem" + (isMe ? " rtMeRow" : "");
      if(isMe) it.setAttribute("data-me","1");
      it.innerHTML = `
        <div class="rtIdx">${r.rank}</div>
        <img class="rtAv rtMedalImg" data-level="${r.level}" src="logo.png" alt="medal">
        <div class="rtInfo">
          <div class="rtName">${esc(r.name)}</div>
          <div class="rtMeta">${esc(r.medal)} ‚Ä¢ LM-${esc(r.numericId||"‚Äî")} ‚Ä¢ ${r.age!=null ? esc(r.age+" yosh") : "‚Äî"}</div>
        </div>
        <div class="rtRight">
          <div class="rtXP">${r.points}</div>
          <div class="rtAgeTxt">${r.age!=null ? esc(r.age+" yosh") : ""}</div>
        </div>
      `;
      list.appendChild(it);
    });

    // pulse my row (for quick finding)
    try{
      const meEl = list.querySelector('[data-me="1"]');
      if(meEl && !onlyMeOn()){
        meEl.classList.remove("rtPulse");
        void meEl.offsetWidth;
        meEl.classList.add("rtPulse");
      }
    }catch(_){ }

    // hydrate medal images
    try{
      document.querySelectorAll(".rtMedalImg").forEach(img=>{
        const L = parseInt(img.getAttribute("data-level")||"1",10) || 1;
        if(typeof setMedalImg === "function") setMedalImg(img, L);
      });
    }catch(_){}

  }

  async function loadAndRender(){
    try{
      render("Reyting yuklanmoqda‚Ä¶");
      const all = await loadAllLeaderboard();
      const sel = getSelAge();
      const onlyMe = onlyMeOn();

      let rows = all.slice();
      if(onlyMe){
        rows = rows.filter(matchMe);
      }
      rows = rows.filter(r => agePass(r.age, sel));

      // find my row in unfiltered all (for analysis among peers)
      let meRow = null;
      if(window.currentUserNumericId || window.currentUserUid){
        meRow = all.find(matchMe) || null;
      }

      render(null, rows, meRow);
    }catch(err){
      console.error(err);
      render("Reytingni yuklab bo‚Äòlmadi");
      const pod = $("rtPodium"); const list = $("rtList");
      if(pod) pod.innerHTML = "";
      if(list) list.innerHTML = `<div class="rtState"><div>‚ùå Xatolik: reyting ma ºlumoti kelmadi</div></div>`;
    }
  }

  function wire(){
    // open button in page
    const openBtn = $("openRating");
    if(openBtn) openBtn.addEventListener("click", openRating);

    const closeBtn = $("rtClose");
    if(closeBtn) closeBtn.addEventListener("click", closeRating);

    const overlay = $("ratingModal");
    if(overlay){
      overlay.addEventListener("click", (e)=>{ if(e.target===overlay) closeRating(); });
    }

    const ages = $("rtAgeChips");
    if(ages){
      ages.addEventListener("click", (e)=>{
        const b = e.target.closest(".rtChip");
        if(!b) return;
        ages.querySelectorAll(".rtChip").forEach(x=>x.classList.remove("active"));
        b.classList.add("active");
        loadAndRender();
      });
    }

    const me = $("rtOnlyMe");
    if(me){
      me.addEventListener("click", ()=>{
        const on = me.getAttribute("aria-pressed")==="true";
        me.setAttribute("aria-pressed", on ? "false":"true");
        loadAndRender();
      });
    }
  }

  document.addEventListener("DOMContentLoaded", wire);
})();
</script>

</body>
</html>