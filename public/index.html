<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LeaderMath.UZ â€” Kirish</title>
  <link rel="stylesheet" href="./assets/css/app.css"/>
</head>
<body class="login">
<div class="wrap"><div class="phone">
  <div class="glass header" style="border-radius:24px">
    <div class="brand">
      <div class="logoWrap">
        <img class="logoImg" src="./logo.png" alt="LeaderMath logo" loading="eager" decoding="async" />
      </div>
      <div>
        <div class="brandTitle">LeaderMath.UZ</div>
        <div class="brandSub" id="dt"></div>
      </div>
    </div>
    <div class="pill">âš¡ Premium</div>
  </div>

  <div class="glass card loginCard">
    <div class="loginHero">
      <div class="heroArt" aria-hidden="true">
        <div class="orb"></div>
        <div class="ring"></div>
        <div class="pi">Ï€</div>
      </div>
      <div class="heroText">
        <div class="badge">ğŸš€ Bir bosishda</div>
        <h1 class="h1">Kirish</h1>
        <p class="p">Yangi boâ€˜lsangiz â€” <b>Bir bosishda kirish</b> ni bosing. ID+Parol sizga alohida oynada koâ€˜rsatiladi.</p>
      </div>
    </div>

    <div class="loginActions">
      <button class="btn primary" id="btnStart">â–¶ï¸ Bir bosishda kirish</button>

      <div class="miniDivider">yoki</div>

      <div class="row">
        <input class="input" id="inId" inputmode="numeric" autocomplete="username" placeholder="ID"/>
        <input class="input" id="inPw" type="password" autocomplete="current-password" placeholder="Parol"/>
      </div>
      <button class="btn ghost" id="btnLogin" style="margin-top:10px">ğŸ”’ Kirish</button>
      <small class="hint">Eslatma: birinchi kirishda profil toâ€˜ldirish oynasi chiqadi.</small>
    </div>
  </div>
</div></div>

<!-- Credentials modal (shown after one-click register) -->
<div class="modalBackdrop" id="credModal" aria-hidden="true">
  <div class="modalOverlay" data-close></div>
  <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="credTitle">
    <div class="modalTop">
      <div>
        <div class="modalBadge">ğŸ§¾ ID + Parol</div>
        <div class="modalTitle" id="credTitle">Saqlab oling</div>
        <div class="modalSub">Bu maâ€™lumotlar keyingi kirishlarda kerak boâ€˜ladi.</div>
      </div>
      <button class="iconBtn" id="credClose" aria-label="Yopish">âœ•</button>
    </div>

    <div class="credGrid">
      <div class="credBox">
        <div class="credLabel">ID</div>
        <div class="credRow">
          <div class="credValue" id="credId">â€”</div>
          <button class="copyBtn" id="copyId" aria-label="ID nusxalash" title="Nusxalash">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 1H6a2 2 0 0 0-2 2v12h2V3h10V1Zm3 4H10a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm0 16H10V7h9v14Z"/></svg>
          </button>
        </div>
        <div class="tinyNote">ID ni yozib oling yoki nusxalang.</div>
      </div>

      <div class="credBox">
        <div class="credLabel">Parol</div>
        <div class="credRow">
          <div class="credValue" id="credPw">â€”</div>
          <button class="copyBtn" id="copyPw" aria-label="Parol nusxalash" title="Nusxalash">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M16 1H6a2 2 0 0 0-2 2v12h2V3h10V1Zm3 4H10a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm0 16H10V7h9v14Z"/></svg>
          </button>
        </div>
        <div class="tinyNote">Parolni hech kimga bermang.</div>
      </div>
    </div>

    <div class="modalActions">
      <button class="btn ghost" id="copyBoth">ID + Parol nusxalash</button>
      <button class="btn primary" id="goApp">Davom etish</button>
    </div>

    <div class="modalFoot" id="autoGoHint">Avto kirish: <b><span id="autoGo">10</span>s</b> (xohlasangiz darhol <b>Davom etish</b> ni bosing)</div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
  import { registerAuto, login } from "./assets/js/auth.js";
  const $=id=>document.getElementById(id);
  const toast=(t)=>{ const el=$("toast"); el.textContent=t; el.style.display="block";
    clearTimeout(window.__t); window.__t=setTimeout(()=>el.style.display="none", 2600); };

  function fmtUZ(){
    const d=new Date();
    return d.toLocaleDateString("uz-UZ",{weekday:"long", year:"numeric", month:"long", day:"numeric"})+
      " â€¢ " + d.toLocaleTimeString("uz-UZ",{hour:"2-digit",minute:"2-digit"});
  }
  $("dt").textContent=fmtUZ(); setInterval(()=>$("dt").textContent=fmtUZ(), 1000*30);

  $("btnStart").onclick = async ()=>{
    try{
      $("btnStart").disabled=true;
      const r = await registerAuto();
      // Login token is set by registerAuto(); show credentials in a small modal for saving.
      $("inId").value = r.loginId;
      $("inPw").value = r.password;
      showCredModal(r.loginId, r.password);
    }catch(e){ toast(e.message||"Xatolik"); }
    finally{ $("btnStart").disabled=false; }
  };

  $("btnLogin").onclick = async ()=>{
    try{
      const id=$("inId").value.trim();
      const pw=$("inPw").value;
      if(!id||!pw) return toast("ID va Parolni kiriting");
      $("btnLogin").disabled=true;
      await login(id,pw);
      location.href="./app.html";
    }catch(e){ toast("Kirish xato: "+(e.message||"")); }
    finally{ $("btnLogin").disabled=false; }
  };

  // --- Credentials modal helpers ---
  let autoTimer=null;
  function openModal(){
    const m=$("credModal");
    m.classList.add("open");
    m.setAttribute("aria-hidden","false");
  }
  function closeModal(){
    const m=$("credModal");
    m.classList.remove("open");
    m.setAttribute("aria-hidden","true");
    if(autoTimer) { clearInterval(autoTimer); autoTimer=null; }
  }
  async function copyText(t){
    try{ await navigator.clipboard.writeText(t); toast("âœ… Nusxalandi"); }
    catch{ toast("âš ï¸ Nusxalab boâ€˜lmadi"); }
  }
  function prettyId(raw){
    const s = String(raw||"").trim();
    if(!s) return "â€”";
    // Show users a clean numeric ID, hide LM- prefix.
    if(/^LM-\d+/i.test(s)) return s.replace(/^LM-0*/i, "");
    return s;
  }
  function showCredModal(id,pw){
    $("credId").textContent = prettyId(id);
    $("credPw").textContent = String(pw||"â€”");
    openModal();

    // countdown
    let s=10;
    $("autoGo").textContent=String(s);
    autoTimer=setInterval(()=>{
      s--; $("autoGo").textContent=String(Math.max(s,0));
      if(s<=0){ clearInterval(autoTimer); autoTimer=null; location.href="./app.html"; }
    },1000);
  }

  $("credClose").onclick = closeModal;
  $("goApp").onclick = ()=> location.href="./app.html";
  $("copyId").onclick = ()=> copyText($("credId").textContent.trim());
  $("copyPw").onclick = ()=> copyText($("credPw").textContent.trim());
  $("copyBoth").onclick = ()=> copyText(`ID: ${$("credId").textContent.trim()}\nParol: ${$("credPw").textContent.trim()}`);
  $("credModal").addEventListener("click", (e)=>{ if(e.target && e.target.hasAttribute("data-close")) closeModal(); });
</script>
</body>
</html>
