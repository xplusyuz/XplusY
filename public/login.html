<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#2E8B57" />
  <title>Kirish — OrzuMall</title>

  <!-- Font Awesome (NO emoji) -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer" />

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --primary:#2E8B57;
      --primary2:#1f6e44;
      --border: rgba(15,23,42,.10);
      --ring: rgba(46,139,87,.22);
      --shadow: 0 18px 50px rgba(15,23,42,.14);
      --r: 22px;
      --safe: env(safe-area-inset-bottom,0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
      color:var(--text);
      background:
        radial-gradient(900px 700px at 18% 0%, rgba(46,139,87,.14), transparent 60%),
        radial-gradient(900px 700px at 85% 15%, rgba(99,102,241,.10), transparent 60%),
        var(--bg);
      -webkit-tap-highlight-color: transparent;
    }
    .wrap{
      min-height:100%;
      display:grid;
      place-items:center;
      padding: 22px 16px calc(22px + var(--safe));
    }
    .card{
      width:min(460px, 100%);
      background: rgba(255,255,255,.92);
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .top{
      padding: 18px 18px 10px;
      text-align:center;
    }
    .logo{
      width:76px; height:76px;
      border-radius: 24px;
      margin: 0 auto 10px;
      display:grid; place-items:center;
      color:#fff;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      box-shadow: 0 18px 36px rgba(46,139,87,.25);
      font-size: 28px;
    }
    h1{margin:0; font-size:20px}
    p{margin:6px 0 0; font-size:13px; color:var(--muted)}
    .tabs{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      padding: 10px 14px 0;
    }
    .tab{
      border:1px solid var(--border);
      background: rgba(255,255,255,.82);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 800;
      color: #111; /* important: readable */
    }
    .tab:not(.active){ color:#334155; }
    .tab.active{
      background: rgba(46,139,87,.14);
      border-color: rgba(46,139,87,.30);
      color: var(--primary);
    }
    .body{padding: 12px 16px 18px}
    .field{display:flex; flex-direction:column; gap:8px; margin: 10px 0}
    .field label{font-size:12px; color:var(--muted)}
    .input{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.86);
      border-radius: 16px;
      padding: 12px 12px;
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
    }
    .input i{color: var(--muted)}
    .input input{
      border:none; outline:none; background:transparent;
      width:100%;
      font-size: 14px;
      color: var(--text);
    }
    .input:focus-within{
      border-color: rgba(46,139,87,.45);
      box-shadow: 0 0 0 6px var(--ring);
    }
    .row{display:flex; gap:10px; align-items:center}
    .iconbtn{
      height:44px; width:44px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.84);
      cursor:pointer;
      display:grid; place-items:center;
      color:#334155;
    }
    .iconbtn:active{transform: translateY(1px)}
    .cta{
      width:100%;
      border:none;
      border-radius: 16px;
      padding: 12px 14px;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      color:#fff;
      font-weight:900;
      box-shadow: 0 14px 28px rgba(46,139,87,.26);
      cursor:pointer;
      margin-top: 8px;
    }
    .cta:active{transform: translateY(1px)}
    .hint{margin-top:10px; font-size:12px; color: var(--muted)}
    .footer{padding: 0 16px 16px; text-align:center; color: rgba(100,116,139,.9); font-size:12px}
    .toast{
      position:fixed; left:50%; bottom: 18px;
      transform: translateX(-50%);
      background: rgba(15,23,42,.90);
      color:#fff;
      border-radius: 999px;
      padding: 10px 14px;
      font-size:13px;
      display:none;
      z-index:999;
      max-width: calc(100vw - 24px);
      text-align:center;
    }
    .toast.show{display:block; animation: pop .16s ease-out}
    @keyframes pop{
      from{transform: translateX(-50%) translateY(6px); opacity:.7}
      to{transform: translateX(-50%) translateY(0); opacity:1}
    }
    .cfg{
      margin-top:10px;
      padding:10px 12px;
      border:1px dashed rgba(15,23,42,.18);
      border-radius: 14px;
      background: rgba(255,255,255,.60);
      color: rgba(100,116,139,.95);
      font-size: 12px;
      line-height: 1.35;
    }
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 11px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="logo"><i class="fa-solid fa-bag-shopping"></i></div>
        <h1>OrzuMall</h1>
        <p>Telefon raqam + parol orqali kirish yoki ro‘yxatdan o‘tish.</p>

        <div class="cfg" id="cfgNote" style="display:none">
          <b>Diqqat:</b> Firebase config to‘ldirilmagan. <br/>
          <span>login.html ichidagi <code>FIREBASE_CONFIG</code> ni o‘zingiznikiga almashtiring.</span>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" id="tabLogin">Kirish</button>
        <button class="tab" id="tabReg">Ro‘yxatdan o‘tish</button>
      </div>

      <div class="body">
        <form id="form">
          <div class="field">
            <label>Telefon raqam</label>
            <div class="input">
              <i class="fa-solid fa-phone"></i>
              <input id="phone" inputmode="tel" placeholder="+998901234567" autocomplete="tel" required />
            </div>
          </div>

          <div class="field" id="nameWrap" style="display:none">
            <label>Ism</label>
            <div class="input">
              <i class="fa-solid fa-user"></i>
              <input id="name" placeholder="Ismingiz" autocomplete="name" />
            </div>
          </div>

          <div class="field">
            <label>Parol</label>
            <div class="row">
              <div class="input" style="flex:1">
                <i class="fa-solid fa-lock"></i>
                <input id="pass" type="password" placeholder="Parol" autocomplete="current-password" required />
              </div>
              <button type="button" class="iconbtn" id="togglePass" title="Ko‘rsatish/Yashirish">
                <i class="fa-solid fa-eye"></i>
              </button>
            </div>
          </div>

          <div class="field" id="pass2Wrap" style="display:none">
            <label>Parolni qayta kiriting</label>
            <div class="input">
              <i class="fa-solid fa-lock"></i>
              <input id="pass2" type="password" placeholder="Qayta parol" autocomplete="new-password" />
            </div>
          </div>

          <button class="cta" type="submit" id="submitBtn">
            <i class="fa-solid fa-right-to-bracket" style="margin-right:8px"></i>
            <span id="submitText">Kirish</span>
          </button>

          <div class="hint" id="hintText">Parol esdan chiqdimi? Hozircha tiklash yo‘q (keyin qo‘shamiz).</div>
        </form>
      </div>

      <div class="footer">© OrzuMall</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    // =========================
    // 1) Firebase Config
    // =========================
    // !!! Shu joyni o'zingizning Firebase config bilan almashtiring !!!
    // Project: xplusy-760fa (auth/firestore ishlatadigan config bo'lishi kerak)
    const FIREBASE_CONFIG = {
      apiKey: "",                 // <-- to'ldiring
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.appspot.com",
      messagingSenderId: "",
      appId: ""
    };

    const cfgOk = !!(FIREBASE_CONFIG && FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.appId);
    if(!cfgOk) document.getElementById("cfgNote").style.display = "block";

    // Firebase v9 (modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, runTransaction
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const app = initializeApp(FIREBASE_CONFIG);
    const db = getFirestore(app);

    // =========================
    // 2) UI helpers
    // =========================
    const $ = (s) => document.querySelector(s);
    const toastEl = $("#toast");
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), 1800);
    }
    function normPhone(raw){
      let p = (raw||"").replace(/[^\d+]/g,"").trim();
      if(!p.startsWith("+")) p = "+" + p.replace(/^\+*/,"");
      return p;
    }
    async function sha256(text){
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    // =========================
    // 3) OMXXXXXX generator (no duplicates)
    //    meta/counters.omCounter -> +1 (transaction)
    // =========================
    async function generateOMId(){
      const ref = doc(db, "meta", "counters");
      const omId = await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        const cur = snap.exists() ? Number(snap.data().omCounter || 0) : 0;
        const next = cur + 1;
        tx.set(ref, { omCounter: next }, { merge: true });
        return "OM" + String(next).padStart(6, "0");
      });
      return omId;
    }

    // =========================
    // 4) Tabs
    // =========================
    let mode = "login"; // login | reg
    function setMode(m){
      mode = m;
      $("#tabLogin").classList.toggle("active", m==="login");
      $("#tabReg").classList.toggle("active", m==="reg");
      $("#nameWrap").style.display = (m==="reg") ? "block" : "none";
      $("#pass2Wrap").style.display = (m==="reg") ? "block" : "none";
      $("#submitText").textContent = (m==="reg") ? "Ro‘yxatdan o‘tish" : "Kirish";
      $("#submitBtn i").className = (m==="reg") ? "fa-solid fa-user-plus" : "fa-solid fa-right-to-bracket";
      $("#hintText").textContent = (m==="reg")
        ? "Ro‘yxatdan o‘tganda sizga avtomatik OMXXXXXX ID beriladi."
        : "Parol esdan chiqdimi? Hozircha tiklash yo‘q (keyin qo‘shamiz).";
    }
    $("#tabLogin").addEventListener("click", ()=>setMode("login"));
    $("#tabReg").addEventListener("click", ()=>setMode("reg"));

    // password toggle
    $("#togglePass").addEventListener("click", ()=>{
      const i = $("#pass");
      const show = i.type === "password";
      i.type = show ? "text" : "password";
      $("#togglePass i").className = show ? "fa-solid fa-eye-slash" : "fa-solid fa-eye";
    });

    // =========================
    // 5) Submit
    //    users/{phone} doc:
    //      { phone, name, passHash, omId, createdAt }
    // =========================
    $("#form").addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(!cfgOk) return toast("Firebase config to‘ldirilmagan");

      const phone = normPhone($("#phone").value);
      const pass = $("#pass").value || "";
      const name = ($("#name").value || "").trim();
      const pass2 = $("#pass2").value || "";

      if(!phone || phone.length < 10) return toast("Telefon raqamni to‘g‘ri kiriting");
      if(pass.length < 4) return toast("Parol kamida 4 ta belgidan iborat bo‘lsin");

      try{
        const userRef = doc(db, "users", phone);
        const snap = await getDoc(userRef);

        if(mode === "login"){
          if(!snap.exists()) return toast("Bunday raqam topilmadi. Ro‘yxatdan o‘ting.");
          const u = snap.data();
          const hash = await sha256(pass);
          if(u.passHash !== hash) return toast("Parol noto‘g‘ri");

          // ensure OM ID exists
          let omId = u.omId;
          if(!omId){
            omId = await generateOMId();
            await updateDoc(userRef, { omId });
          }

          localStorage.setItem("om_user", JSON.stringify({ phone, name: u.name || "", omId }));
          location.href = "profile.html";
          return;
        }

        // register
        if(!name) return toast("Ismni kiriting");
        if(pass !== pass2) return toast("Parollar mos emas");
        if(snap.exists()) return toast("Bu raqam allaqachon ro‘yxatdan o‘tgan");

        const omId = await generateOMId();
        const passHash = await sha256(pass);

        await setDoc(userRef, {
          phone,
          name,
          passHash,
          omId,
          createdAt: serverTimestamp()
        });

        localStorage.setItem("om_user", JSON.stringify({ phone, name, omId }));
        toast("Ro‘yxatdan o‘tildi");
        setTimeout(()=> location.href = "profile.html", 300);

      }catch(err){
        console.error(err);
        toast("Xatolik. Firestore rules/config ni tekshiring");
      }
    });

    // default
    setMode("login");
  </script>
</body>
</html>
