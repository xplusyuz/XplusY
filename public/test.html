
<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LeaderMath Premium Test</title>
<script src="authUtils.js"></script>
<style>
:root{
  --brand:#2E8B57;
  --bg:#f4f7fb;
  --card:#ffffff;
  --danger:#e74c3c;
}
body{font-family:Inter,Arial;background:var(--bg);margin:0}
header{
  position:sticky;top:0;z-index:10;
  background:linear-gradient(90deg,#2E8B57,#3cb371);
  color:#fff;padding:12px 16px;
  display:flex;justify-content:space-between;align-items:center;
}
#title{font-size:18px;font-weight:600}
.timer{font-weight:700;font-size:16px}
.progress{
  height:6px;background:#ddd;border-radius:6px;overflow:hidden;margin:8px 16px
}
.progress>div{
  height:100%;background:var(--brand);width:0%;transition:.3s
}
#app{max-width:900px;margin:auto;padding:16px}
.q{background:var(--card);border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
.q img{max-width:100%;border-radius:10px;margin:8px 0}
.opt{padding:8px 10px;border:1px solid #ddd;border-radius:8px;margin:6px 0;cursor:pointer}
.opt.active{border-color:var(--brand);background:#ecf9f2}
input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc}
.footer{
  position:sticky;bottom:0;background:#fff;padding:12px 16px;
  box-shadow:0 -6px 18px rgba(0,0,0,.08);
  display:flex;justify-content:space-between;align-items:center
}
.btn{
  background:var(--brand);color:#fff;border:none;border-radius:10px;
  padding:12px 18px;font-size:16px;font-weight:600
}
.btn:disabled{opacity:.6}
.warn{color:var(--danger);font-size:13px}
</style>
</head>
<body>
<header>
  <div id="title">Test...</div>
  <div>⏳ <span class="timer" id="timer">--:--</span></div>
</header>
<div class="progress"><div id="bar"></div></div>
<div id="app"></div>
<div class="footer">
  <div id="warn" class="warn"></div>
  <button class="btn" id="submitBtn">Yakunlash</button>
</div>

<script>
(async function(){
  const user = await authUtils.requireUser({returnTo:location.pathname+location.search});
  const params = new URLSearchParams(location.search);
  const testId = params.get("id");
  const code = params.get("code")||"";
  if(!testId){ alert("Test ID yo‘q"); return; }

  const url = authUtils.apiUrl("tests/get") + "&id=" + testId + "&code=" + code;
  const res = await fetch(url);
  const data = await res.json();
  if(!res.ok){ alert(data.error||"Test ochilmadi"); return; }

  const test = data.test;
  document.getElementById("title").innerText = test.title;
  const app = document.getElementById("app");
  const bar = document.getElementById("bar");

  let answers = new Array(test.questions.length).fill("");
  let answeredCount = 0;

  test.questions.forEach((q,i)=>{
    const d = document.createElement("div");
    d.className="q";
    d.innerHTML = `<h4>${i+1})</h4>`;
    if(q.img) d.innerHTML += `<img src="/tests/${test.folder}/${q.img}">`;

    if(q.type==="mcq"){
      q.options.forEach((opt,idx)=>{
        const o = document.createElement("div");
        o.className="opt";
        o.innerText = opt;
        o.onclick=()=>{
          d.querySelectorAll(".opt").forEach(x=>x.classList.remove("active"));
          o.classList.add("active");
          if(!answers[i]) answeredCount++;
          answers[i]=String(idx);
          updateProgress();
        };
        d.appendChild(o);
      });
    }else{
      const inp = document.createElement("input");
      inp.type="text";
      inp.oninput=()=>{
        if(!answers[i] && inp.value.trim()) answeredCount++;
        answers[i]=inp.value;
        updateProgress();
      };
      d.appendChild(inp);
    }
    app.appendChild(d);
  });

  function updateProgress(){
    const pct = Math.floor((answeredCount/test.questions.length)*100);
    bar.style.width = pct + "%";
  }

  // ===== TIMER =====
  let remain = test.durationSec;
  const timerEl = document.getElementById("timer");
  const tick = ()=>{
    if(remain<=0){ submit(); return; }
    const m = String(Math.floor(remain/60)).padStart(2,"0");
    const s = String(remain%60).padStart(2,"0");
    timerEl.innerText = m+":"+s;
    remain--;
  };
  if(test.durationSec>0){ tick(); setInterval(tick,1000); }

  // ===== ANTI-CHEAT =====
  let violations = 0;
  const warnEl = document.getElementById("warn");

  function flag(reason){
    violations++;
    warnEl.innerText = "⚠️ Qoidabuzarlik: " + reason + " ("+violations+")";
    if(violations>=3){
      alert("Test bekor qilindi (anti-cheat)");
      submit(true);
    }
  }

  document.addEventListener("visibilitychange",()=>{
    if(document.hidden && test.mode==="challenge"){
      flag("Sahifadan chiqildi");
    }
  });

  window.addEventListener("blur",()=>{
    if(test.mode==="challenge"){
      flag("Boshqa oynaga o‘tildi");
    }
  });

  document.addEventListener("copy",()=> flag("Copy"));
  document.addEventListener("paste",()=> flag("Paste"));
  document.addEventListener("contextmenu",(e)=>{
    e.preventDefault();
    flag("Right-click");
  });

  // ===== SUBMIT =====
  document.getElementById("submitBtn").onclick = ()=>submit(false);

  async function submit(cancelled){
    document.getElementById("submitBtn").disabled=true;
    const res = await authUtils.fetchApi("tests/submit",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        id:testId,
        answers,
        timeSpentSec:test.durationSec-remain,
        cancelled:!!cancelled
      })
    });
    const out = await res.json();
    if(!res.ok){
      alert(out.error||"Xatolik");
      location.href="/app.html";
      return;
    }
    alert(`Natija: ${out.result.score} ball
To‘g‘ri: ${out.result.correct}/${out.result.total}
${test.mode==="challenge" ? "Ball hisobga qo‘shildi" : "Open test — ball qo‘shilmadi"}`);
    location.href="/app.html";
  }
})();
</script>
</body>
</html>
