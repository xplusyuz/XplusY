<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Test ‚Äî LeaderMath.UZ</title>
  <link rel="stylesheet" href="assets/css/app.css"/>
  <link rel="stylesheet" href="assets/css/ui.css"/>
  <style>
    /* Image-only question tweaks */
    .qImageWrap{display:flex; justify-content:center; margin:10px 0 12px;}
    .qImage{max-width:100%; max-height:48vh; border-radius:18px; border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
      background: rgba(255,255,255,.06);
    }
    .filters{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 560px){ .filters{grid-template-columns:1fr;} }
    .miniRow{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;}
    .tagPill{display:inline-flex; align-items:center; gap:8px; padding:7px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.16); background: rgba(255,255,255,.08);
      font-weight:800; font-size:12px; color: rgba(255,255,255,.92);
    }
    .testList{display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:12px;}
    @media (max-width: 860px){ .testList{grid-template-columns:1fr;} }
    .testCard{position:relative; overflow:hidden; cursor:pointer;}
    .testCard:hover{transform: translateY(-1px);}
    .testCard .meta{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
    .testCard .meta .chip{padding:6px 10px; border-radius:999px; font-size:12px; font-weight:900;
      background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14);
    }
    .codeRow{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 560px){ .codeRow{grid-template-columns:1fr;} }
  </style>
</head>

<body>
  <canvas class="seasonCanvas" id="seasonCanvas"></canvas>
  <div class="toast" id="toast"></div>

  <div class="container">
    <div class="glass topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"><span>œÄ</span></div>
        <div class="titleWrap">
          <div class="title">Test</div>
          <div class="subtitle" id="subtitle">Oddiy test (JSON) va Challenge (API+Firestore)</div>
        </div>
      </div>
      <div class="miniRow" style="gap:10px;">
        <div class="tagPill" id="mePill">‚Ä¶</div>
        <a class="btn" href="app.html">‚Üê Orqaga</a>
      </div>
    </div>

    <div class="glass section">
      <div class="sectionTitle">
        <h2>Oddiy testlar (ochiq)</h2>
        <div class="hint">JSON‚Äôdan ¬∑ ball/balansga ta‚Äôsir qilmaydi</div>
      </div>

      <div class="filters">
        <div>
          <div class="nameLine">Sinf (filter)</div>
          <select class="input" id="openGrade"></select>
        </div>
        <div>
          <div class="nameLine">Tur (filter)</div>
          <select class="input" id="openExamType"></select>
        </div>
      </div>

      <div class="hr"></div>
      <div class="testList" id="openList"></div>
      <div class="small" id="openStatus" style="margin-top:10px;opacity:.9"></div>
    </div>

    <div class="glass section">
      <div class="sectionTitle">
        <h2>Challenge (yopiq)</h2>
        <div class="hint">API orqali Firestore‚Äôdan ¬∑ kod bilan kirish</div>
      </div>

      <div class="codeRow">
        <div>
          <div class="nameLine">Challenge ID (masalan: 5-sinf-hafta1)</div>
          <input class="input" id="chId" placeholder="challenge1"/>
        </div>
        <div>
          <div class="nameLine">Kirish kodi</div>
          <input class="input" id="chCode" placeholder="LM2026"/>
        </div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
        <button class="btn" id="btnEnter">üîê Kirish</button>
        <button class="btn" id="btnList">üìö Ro‚Äòyxat</button>
      </div>
      <div class="hr"></div>
      <div class="testList" id="chList"></div>
      <div class="small" id="chStatus" style="margin-top:10px;opacity:.9"></div>
    </div>
  </div>

  <!-- Runner modal (simple, image based) -->
  <div class="modal" id="runner" style="display:none;">
    <div class="modalBox" style="width:min(980px,94vw);">
      <div class="modalHead">
        <div>
          <div class="nameLine" id="runTitle">Test</div>
          <div class="small" id="runMeta">‚Äî</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <div class="badge" id="timer" style="font-weight:1000;">00:00</div>
          <button class="btn" id="btnClose">‚úñ</button>
        </div>
      </div>
      <div class="hr"></div>

      <div style="display:grid; grid-template-columns: 1fr 260px; gap:12px;" class="runnerGrid">
        <div class="glass" style="padding:14px;border-radius:26px;">
          <div class="miniRow">
            <div class="badge" id="qIndex">#1</div>
            <div class="badge" id="qPts">1 ball</div>
          </div>
          <div class="qImageWrap"><img class="qImage" id="qImg" alt="savol"/></div>
          <div id="mcq" style="display:flex; flex-direction:column; gap:10px;"></div>
          <div id="openWrap" style="display:none;">
            <div class="nameLine">Javob</div>
            <input class="input" id="openAns" placeholder="Javobni kiriting‚Ä¶"/>
            <div class="small">(Bo‚Äòsh joylar e‚Äôtiborga olinmaydi)</div>
          </div>
        </div>

        <div class="glass" style="padding:14px;border-radius:26px;">
          <div class="nameLine">Savollar</div>
          <div id="dots" style="display:grid; grid-template-columns: repeat(6,1fr); gap:8px; margin-top:10px;"></div>
          <div class="hr"></div>
          <div class="small" id="stat">‚Äî</div>
          <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;">
            <button class="btn" id="btnPrev">‚¨Ö</button>
            <button class="btn" id="btnNext">‚û°</button>
            <button class="btn" id="btnFinish">‚úÖ Yakunlash</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initSeasons } from "./assets/js/seasons.js";
    initSeasons("seasonCanvas");
  </script>

  <script type="module">
    import { api } from "./assets/js/api.js";
    import { me } from "./assets/js/auth.js";

    const $ = (id)=>document.getElementById(id);
    const toast = (msg)=>{ const t=$("toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 2400); };

    // ===== auth/me =====
    let ME = null;
    try{
      const r = await me();
      ME = r.user || r;
      const name = (ME.firstName || ME.name || ME.loginId || "").trim();
      $("mePill").textContent = `ID: ${ME.loginId} ¬∑ ${name||"User"} ¬∑ Ball: ${ME.points??0} ¬∑ Balans: ${ME.balance??0}`;
    }catch(e){
      location.href = "./";
    }

    // ===== utils =====
    const OPEN_INDEX = "open-tests/index.json";
    const norm = (s)=>String(s??"").trim().toLowerCase().replace(/\s+/g,"");
    const fmtTime = (sec)=>{
      sec=Math.max(0,Math.floor(sec));
      const m=Math.floor(sec/60), s=sec%60;
      return String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");
    };
    const shuffle = (arr)=>{
      const a=[...arr];
      for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
      return a;
    };

    // =====================
    // OPEN TESTS (JSON index)
    // =====================
    let openIndex=null;
    let openTests=[];

    async function loadOpenIndex(){
      $("openStatus").textContent = "Yuklanmoqda‚Ä¶";
      try{
        const r = await fetch(OPEN_INDEX, {cache:"no-store"});
        if(!r.ok) throw new Error();
        openIndex = await r.json();
        openTests = Array.isArray(openIndex.tests) ? openIndex.tests : [];
        buildOpenFilters();
        renderOpenList();
        $("openStatus").textContent = `Topildi: ${openTests.length} ta test`;
      }catch(_){
        $("openStatus").textContent = "open-tests/index.json topilmadi";
      }
    }

    function buildOpenFilters(){
      const grades = ["Hammasi", ...new Set(openTests.map(t=>t.grade||"" ).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
      const types  = ["Hammasi", ...new Set(openTests.map(t=>t.examType||"" ).filter(Boolean))].sort((a,b)=>a.localeCompare(b));

      $("openGrade").innerHTML = grades.map(g=>`<option value="${g==="Hammasi"?"":g}">${g}</option>`).join("");
      $("openExamType").innerHTML = types.map(x=>`<option value="${x==="Hammasi"?"":x}">${x}</option>`).join("");
      $("openGrade").onchange = renderOpenList;
      $("openExamType").onchange = renderOpenList;
    }

    function renderOpenList(){
      const g = $("openGrade").value;
      const t = $("openExamType").value;
      const list = openTests.filter(x => (!g || x.grade===g) && (!t || x.examType===t));

      const el = $("openList");
      el.innerHTML = "";
      if(list.length===0){
        el.innerHTML = `<div class="glass" style="padding:14px;border-radius:26px;">Test topilmadi</div>`;
        return;
      }
      list.forEach(item=>{
        const card = document.createElement("div");
        card.className = "glass featureCard testCard";
        card.style.padding = "14px";
        card.style.borderRadius = "26px";
        card.innerHTML = `
          <div class="nameLine" style="font-size:16px;">${item.title || item.id}</div>
          <div class="small" style="margin-top:6px;">${item.description||"Oddiy test"}</div>
          <div class="meta">
            <span class="chip">${item.grade || "‚Äî"}</span>
            <span class="chip">${item.examType || "‚Äî"}</span>
            <span class="chip">‚è± ${Math.round((item.durationSec||900)/60)} min</span>
          </div>
        `;
        card.onclick = ()=> startOpen(item);
        el.appendChild(card);
      });
    }

    async function startOpen(item){
      try{
        const r = await fetch(item.file, {cache:"no-store"});
        if(!r.ok) throw new Error();
        const test = await r.json();
        test._mode = "open";
        test._id = item.id;
        test._folder = item.folder || item.id;
        runStart(test);
      }catch(_){
        toast("Test JSON yuklanmadi");
      }
    }

    // =====================
    // CHALLENGES via API
    // =====================
    async function listChallenges(){
      $("chStatus").textContent = "Yuklanmoqda‚Ä¶";
      try{
        const r = await api("tests/list", { query:{ mode:"challenge", limit: 30 }});
        const items = r.items || [];
        const el = $("chList");
        el.innerHTML = "";
        if(items.length===0){
          el.innerHTML = `<div class="glass" style="padding:14px;border-radius:26px;">Challenge yo‚Äòq</div>`;
          $("chStatus").textContent = "";
          return;
        }
        items.forEach(c=>{
          const card = document.createElement("div");
          card.className = "glass featureCard testCard";
          card.style.padding = "14px";
          card.style.borderRadius = "26px";
          const st = c.status === 'active' ? 'üî• Faol' : (c.status==='not_started' ? '‚è≥ Kutilmoqda' : 'üõë Yakunlangan');
          card.innerHTML = `
            <div class="nameLine" style="font-size:16px;">${c.title || c.id}</div>
            <div class="small" style="margin-top:6px;">ID: <b>${c.id}</b> ¬∑ ${st}</div>
            <div class="meta">
              <span class="chip">${c.grade || "‚Äî"}</span>
              <span class="chip">${c.examType || "‚Äî"}</span>
              <span class="chip">üìå ${c.questionCount||0} savol</span>
            </div>
          `;
          card.onclick = ()=>{ $("chId").value = c.id; toast("Tanlandi: "+c.id); };
          el.appendChild(card);
        });
        $("chStatus").textContent = `Topildi: ${items.length} ta challenge`;
      }catch(e){
        $("chStatus").textContent = e.message || "Challenge ro‚Äòyxati xato";
      }
    }

    async function enterChallenge(){
      const id = $("chId").value.trim();
      const code = $("chCode").value.trim();
      if(!id || !code){ toast("ID va kod kiriting"); return; }
      try{
        const r = await api("tests/get", { query:{ id, code }});
        const test = r.test;
        test._mode = "challenge";
        test._id = id;
        test._folder = test.folder || test.code || id;
        runStart(test);
      }catch(e){
        toast(e.message || "Kirish xato");
      }
    }

    $("btnList").onclick = listChallenges;
    $("btnEnter").onclick = enterChallenge;

    // =====================
    // RUNNER (image-only)
    // =====================
    const RUN = { test:null, qs:[], ans:[], i:0, left:0, t:null, started:0 };

    function runStart(test){
      const qs = Array.isArray(test.questions) ? test.questions : [];
      const base = test.shuffleQuestions ? shuffle(qs) : [...qs];
      const cooked = base.map((q, idx)=>{
        const qq = {...q};
        qq.type = qq.type || 'mcq';
        qq.points = Number(qq.points||1)||1;
        qq.img = qq.img || qq.image || `${idx+1}.png`;
        if(test.shuffleOptions && Array.isArray(qq.options)) qq.options = shuffle(qq.options);
        return qq;
      });

      RUN.test = test;
      RUN.qs = cooked;
      RUN.ans = new Array(cooked.length).fill("");
      RUN.i = 0;
      RUN.left = Number(test.durationSec||900)||900;
      RUN.started = Date.now();

      $("runTitle").textContent = test.title || (test._mode==="challenge" ? "Challenge" : "Test");
      $("runMeta").textContent = test._mode==="challenge" ? `Challenge ¬∑ ID: ${test._id}` : `Oddiy test ¬∑ JSON`;
      $("runner").style.display = "flex";
      buildDots();
      renderQ();
      tick();
      clearInterval(RUN.t);
      RUN.t = setInterval(tick, 1000);
    }

    function runClose(){
      clearInterval(RUN.t);
      RUN.t = null;
      $("runner").style.display = "none";
    }

    function tick(){
      $("timer").textContent = fmtTime(RUN.left);
      RUN.left -= 1;
      if(RUN.left < 0){ finish(); }
    }

    function buildDots(){
      const el = $("dots");
      el.innerHTML = "";
      RUN.qs.forEach((_,i)=>{
        const b=document.createElement('button');
        b.className='btn';
        b.style.padding='10px 0';
        b.textContent = i+1;
        b.onclick = ()=>{ RUN.i=i; renderQ(); };
        el.appendChild(b);
      });
      updateStat();
    }

    function updateStat(){
      const answered = RUN.ans.filter(x=>String(x||"").trim().length>0).length;
      $("stat").textContent = `‚úÖ ${answered}/${RUN.qs.length} ¬∑ ‚è± ${fmtTime(Math.max(0, Number(RUN.test.durationSec||900)-RUN.left))}`;
    }

    function renderQ(){
      const q = RUN.qs[RUN.i];
      $("qIndex").textContent = `#${RUN.i+1}`;
      $("qPts").textContent = `${q.points} ball`;

      // image src
      const folder = RUN.test._folder || RUN.test.folder || RUN.test.code || RUN.test._id || "";
      const imgName = q.img || `${RUN.i+1}.png`;
      $("qImg").src = `tests/${folder}/${imgName}`;

      $("mcq").innerHTML = "";
      $("openWrap").style.display = "none";

      if((q.type||'mcq') === 'open'){
        $("openWrap").style.display = "block";
        $("openAns").value = RUN.ans[RUN.i] || "";
        $("openAns").oninput = ()=>{ RUN.ans[RUN.i] = $("openAns").value; updateStat(); };
      }else{
        const cur = RUN.ans[RUN.i];
        (q.options||[]).forEach(opt=>{
          const row=document.createElement('button');
          row.className='btn';
          row.style.textAlign='left';
          row.style.padding='12px 14px';
          row.style.borderRadius='18px';
          row.style.background = (cur===opt) ? 'rgba(255,255,255,.18)' : '';
          row.textContent = opt;
          row.onclick = ()=>{ RUN.ans[RUN.i]=opt; renderQ(); updateStat(); };
          $("mcq").appendChild(row);
        });
      }
      updateStat();
    }

    function calcLocalOpenScore(){
      // only for OPEN JSON (we have correct/answers in json)
      const qs = RUN.qs;
      let score=0, correct=0, wrong=0;
      for(let i=0;i<qs.length;i++){
        const q=qs[i];
        const a=RUN.ans[i];
        const pts=Number(q.points||1)||1;
        let ok=false;
        if((q.type||'mcq')==='open'){
          const list = Array.isArray(q.answers)?q.answers:[];
          const na = norm(a);
          ok = list.some(x=>norm(x)===na);
        }else{
          ok = String(a)===String(q.correct||"");
        }
        if(ok){ score+=pts; correct++; } else wrong++;
      }
      return {score, correct, wrong, total: qs.length};
    }

    async function finish(){
      clearInterval(RUN.t);
      RUN.t = null;

      // open test: local result (no points)
      if(RUN.test._mode === 'open'){
        const r = calcLocalOpenScore();
        toast(`Natija: ${r.score} ball ¬∑ ‚úÖ${r.correct} ¬∑ ‚ùå${r.wrong}`);
        setTimeout(runClose, 800);
        return;
      }

      // challenge: submit to server for scoring + points
      try{
        const timeSpentSec = Math.max(0, Math.floor((Date.now()-RUN.started)/1000));
        const res = await api("tests/submit", { method:"POST", body:{ id: RUN.test._id, answers: RUN.ans, timeSpentSec }});
        const r = res.result;
        toast(`Challenge natija: ${r.score} ball ¬∑ ‚úÖ${r.correct} ¬∑ ‚ùå${r.wrong}`);
      }catch(e){
        toast(e.message || "Submission xato");
      }
      setTimeout(runClose, 900);
    }

    // buttons
    $("btnClose").onclick = ()=>{ if(confirm("Testdan chiqasizmi?")) runClose(); };
    $("btnPrev").onclick = ()=>{ if(RUN.i>0){ RUN.i--; renderQ(); } };
    $("btnNext").onclick = ()=>{ if(RUN.i<RUN.qs.length-1){ RUN.i++; renderQ(); } };
    $("btnFinish").onclick = ()=>{ if(confirm("Testni yakunlaysizmi?")) finish(); };

    // init
    await loadOpenIndex();
    await listChallenges();
  </script>
</body>
</html>
