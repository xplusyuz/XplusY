<!DOCTYPE html>

<html lang="uz">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1.0" name="viewport"/>
<title>Test Builder ‚Äî LeaderMath.UZ</title>
<link href="assets/css/app.css" rel="stylesheet"/>
<link href="assets/css/ui.css" rel="stylesheet"/>
<style>
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    @media(max-width: 860px){ .grid2{grid-template-columns:1fr;} }
    .qRow{display:grid; grid-template-columns: 90px 1fr; gap:12px; align-items:start;}
    .qThumb{width:90px; height:90px; border-radius:18px; border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06); display:grid; place-items:center; overflow:hidden;}
    .qThumb img{width:100%; height:100%; object-fit:cover;}
    .qBox{padding:14px; border-radius:26px;}
    .btnRow{display:flex; gap:10px; flex-wrap:wrap;}
    .mini{font-size:12px; opacity:.85}
    textarea.input{min-height: 84px; resize:vertical;}
  </style>
<meta content="#0ea5e9" name="theme-color"/><link href="logo.png" rel="icon" sizes="192x192"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/><script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script><link href="assets/css/skin-index1.css" rel="stylesheet"/></head>
<body class="lm-skin"><div class="scroll-progress"><div class="scroll-progress-bar" id="scrollProgress"></div></div><button class="scroll-to-top" id="scrollToTop"><i class="fa-solid fa-arrow-up"></i></button><canvas id="three-canvas"></canvas><div class="app"><header><div class="header-card"><img alt="LeaderMath" class="logo-img" src="logo.png"/><div class="header-text"><div class="header-title">LeaderMath.UZ ‚Äî Test Builder</div><div class="header-sub">index1.html dizayni ‚Äî yagona premium skin</div></div><div class="header-tag"><i class="fa-solid fa-wand-magic-sparkles"></i> Premium UI</div></div></header><main><div class="section-shell">
<canvas class="seasonCanvas" id="seasonCanvas"></canvas>
<div class="toast" id="toast"></div>
<div class="container">
<div class="glass topbar">
<div class="brand">
<div aria-hidden="true" class="logo"><span>œÄ</span></div>
<div class="titleWrap">
<div class="title">Test Builder</div>
<div class="subtitle">Bitta tizim: Firestore‚Äôga saqlash + JSON eksport</div>
</div>
</div>
<div style="display:flex; gap:10px; align-items:center;">
<a class="btn" href="app.html">‚Üê Orqaga</a>
</div>
</div>
<div class="glass section">
<div class="sectionTitle">
<h2>1) Test ma‚Äôlumotlari</h2>
<div class="hint">Savol matni yo‚Äòq ‚Äî faqat rasm (papka ichida 1.png,2.png...)</div>
</div>
<div class="grid2">
<div>
<div class="nameLine">Test ID (Firestore doc id)</div>
<input class="input" id="tId" placeholder="5-sinf-hafta1"/>
<div class="mini">Maslahat: kichik harf, bo‚Äòsh joysiz. Papka ham shu nomda bo‚Äòlsin.</div>
</div>
<div>
<div class="nameLine">Sarlavha</div>
<input class="input" id="tTitle" placeholder="5-sinf Challenge #1"/>
</div>
</div>
<div class="grid2" style="margin-top:12px;">
<div>
<div class="nameLine">Sinf (filter)</div>
<select class="input" id="tGrade">
<option value="">‚Äî</option>
<option>5-sinf</option><option>6-sinf</option><option>7-sinf</option><option>8-sinf</option>
<option>9-sinf</option><option>10-sinf</option><option>11-sinf</option>
</select>
</div>
<div>
<div class="nameLine">Tur (filter)</div>
<select class="input" id="tExam">
<option value="">‚Äî</option>
<option value="chsb">chsb</option>
<option value="dtm">dtm</option>
<option value="milliy">milliy</option>
<option value="boshqa">boshqa</option>
</select>
</div>
</div>
<div class="grid2" style="margin-top:12px;">
<div>
<div class="nameLine">Rejim</div>
<select class="input" id="tMode">
<option value="challenge">challenge (yopiq)</option>
<option value="open">open (oddiy)</option>
</select>
</div>
<div>
<div class="nameLine">Vaqt (sekund)</div>
<input class="input" id="tDur" min="30" type="number" value="1200"/>
</div>
</div>
<div class="grid2" style="margin-top:12px;">
<div>
<div class="nameLine">Kirish kodi (faqat challenge)</div>
<input class="input" id="tCode" placeholder="LM2026"/>
</div>
<div>
<div class="nameLine">Rasm papkasi (public/tests/...) </div>
<input class="input" id="tFolder" placeholder="5-sinf-hafta1"/>
</div>
</div>
<div class="grid2" style="margin-top:12px;">
<div>
<div class="nameLine">Boshlanish (challenge)</div>
<input class="input" id="tStart" type="datetime-local"/>
</div>
<div>
<div class="nameLine">Tugash (challenge)</div>
<input class="input" id="tEnd" type="datetime-local"/>
</div>
</div>
<div class="hr"></div>
<div class="sectionTitle">
<h2>2) Savollar</h2>
<div class="hint">Har savol uchun: rasm fayl (1.png...), javob varianti yoki open javoblar</div>
</div>
<div class="btnRow" style="margin-bottom:10px;">
<button class="btn" id="btnAdd">‚ûï Savol qo‚Äòshish</button>
<button class="btn" id="btnFill">‚ú® 10 ta default (1.png..10.png)</button>
</div>
<div id="qList"></div>
<div class="hr"></div>
<div class="btnRow">
<button class="btn" id="btnSave">‚òÅ Firestore‚Äôga saqlash (admin)</button>
<button class="btn" id="btnJson">‚¨á JSON (oddiy test) yuklab olish</button>
<button class="btn" id="btnIndex">‚¨á index.json entry (copy)</button>
</div>
<div class="small" id="status" style="margin-top:10px;opacity:.9"></div>
</div>
</div>
<script type="module">
    import { initSeasons } from "./assets/js/seasons.js";
    import { me } from "./assets/js/auth.js";
    import { api } from "./assets/js/api.js";
    initSeasons("seasonCanvas");

    const $ = (id)=>document.getElementById(id);
    const toast = (m)=>{ const t=$("toast"); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2200); };

    try{ await me(); }catch(e){ location.href = "./"; }

    let QS = [];

    function qTemplate(i){
      return {
        img: String(i+1)+'.png',
        type: 'mcq',
        points: 1,
        options: ['A','B','C','D'],
        correct: 'A',
        answers: []
      };
    }

    function render(){
      const host = $("qList");
      host.innerHTML='';
      QS.forEach((q, idx)=>{
        const box = document.createElement('div');
        box.className = 'glass qBox';
        box.style.marginTop = '12px';

        const imgSrc = `tests/${encodeURIComponent($('tFolder').value || $('tId').value || '')}/${encodeURIComponent(q.img||'')}`;

        box.innerHTML = `
          <div class="miniRow" style="margin-bottom:10px;">
            <div class="nameLine" style="margin:0">Savol #${idx+1}</div>
            <div class="btnRow">
              <button class="btn" data-act="up">‚Üë</button>
              <button class="btn" data-act="down">‚Üì</button>
              <button class="btn" data-act="del">üóë</button>
            </div>
          </div>
          <div class="qRow">
            <div class="qThumb">
              <img alt="${q.img||''}" src="${imgSrc}" onerror="this.style.display='none'"/>
              <div class="mini" style="padding:6px 8px;">${q.img||''}</div>
            </div>
            <div>
              <div class="grid2">
                <div>
                  <div class="nameLine">Rasm fayl (1.png)</div>
                  <input class="input" data-k="img" value="${q.img||''}"/>
                </div>
                <div>
                  <div class="nameLine">Ball</div>
                  <input class="input" data-k="points" type="number" min="1" value="${Number(q.points||1)}"/>
                </div>
              </div>
              <div class="grid2" style="margin-top:10px;">
                <div>
                  <div class="nameLine">Tur</div>
                  <select class="input" data-k="type">
                    <option value="mcq" ${q.type==='mcq'?'selected':''}>mcq</option>
                    <option value="open" ${q.type==='open'?'selected':''}>open</option>
                  </select>
                </div>
                <div>
                  <div class="nameLine">To‚Äòg‚Äòri (mcq)</div>
                  <input class="input" data-k="correct" value="${q.correct||''}"/>
                </div>
              </div>
              <div style="margin-top:10px;">
                <div class="nameLine">Variantlar (mcq) ‚Äî har qatorda bittadan</div>
                <textarea class="input" data-k="options">${(q.options||[]).join('\n')}</textarea>
              </div>
              <div style="margin-top:10px;">
                <div class="nameLine">Open javoblar (open) ‚Äî har qatorda bittadan</div>
                <textarea class="input" data-k="answers">${(q.answers||[]).join('\n')}</textarea>
              </div>
            </div>
          </div>
        `;

        // actions
        box.querySelectorAll('button[data-act]').forEach(b=>{
          b.onclick = ()=>{
            const act=b.dataset.act;
            if(act==='del'){ QS.splice(idx,1); render(); return; }
            if(act==='up' && idx>0){ const t=QS[idx-1]; QS[idx-1]=QS[idx]; QS[idx]=t; render(); return; }
            if(act==='down' && idx<QS.length-1){ const t=QS[idx+1]; QS[idx+1]=QS[idx]; QS[idx]=t; render(); return; }
          };
        });

        box.querySelectorAll('[data-k]').forEach(inp=>{
          inp.oninput = ()=>{
            const k = inp.dataset.k;
            if(k==='points') QS[idx][k] = Number(inp.value||1);
            else if(k==='options' || k==='answers') QS[idx][k] = String(inp.value||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
            else QS[idx][k] = inp.value;
          };
          inp.onchange = inp.oninput;
        });

        host.appendChild(box);
      });
    }

    function buildTestObject(){
      const id = String($('tId').value||'').trim();
      const code = id;
      const folder = String($('tFolder').value||id).trim();
      const mode = $('tMode').value;
      const start = $('tStart').value ? new Date($('tStart').value).getTime() : null;
      const end = $('tEnd').value ? new Date($('tEnd').value).getTime() : null;
      return {
        id,
        code,
        title: $('tTitle').value||id,
        grade: $('tGrade').value||'',
        examType: $('tExam').value||'',
        mode,
        folder,
        accessCode: $('tCode').value||'',
        durationSec: Number($('tDur').value||0)||0,
        startAtMs: (mode==='challenge') ? start : null,
        endAtMs: (mode==='challenge') ? end : null,
        shuffleQuestions: true,
        shuffleOptions: false,
        questions: QS.map(q=>({
          img: q.img,
          type: q.type,
          points: Number(q.points||1)||1,
          options: q.options||[],
          correct: q.correct||'',
          answers: q.answers||[]
        }))
      };
    }

    function downloadJSON(filename, obj){
      const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    // buttons
    $('btnAdd').onclick = ()=>{ QS.push(qTemplate(QS.length)); render(); };
    $('btnFill').onclick = ()=>{ QS = []; for(let i=0;i<10;i++) QS.push(qTemplate(i)); render(); };

    $('tFolder').oninput = ()=>render();
    $('tId').oninput = ()=>{ if(!$('tFolder').value) $('tFolder').value = $('tId').value; render(); };

    $('btnSave').onclick = async ()=>{
      try{
        const t = buildTestObject();
        if(!t.id) return toast('Test ID kerak');
        if(!t.questions.length) return toast('Kamida 1 ta savol');
        const res = await api('admin/tests/upsert', { method:'POST', body:{ test:t } });
        $('status').textContent = 'Saqlandi: ' + res.id;
        toast('Firestore‚Äôga saqlandi ‚úÖ');
      }catch(e){
        toast(e.message || 'Saqlashda xato');
        $('status').textContent = 'Xato: ' + (e.message||'');
      }
    };

    $('btnJson').onclick = ()=>{
      const t = buildTestObject();
      if(!t.id) return toast('Test ID kerak');
      // Open test JSON uchun (local scoring bo‚Äòlsin deb correct/answers qoldiramiz)
      const openJson = {
        id: t.id,
        code: t.code,
        title: t.title,
        grade: t.grade,
        examType: t.examType,
        durationSec: t.durationSec,
        folder: t.folder,
        shuffleQuestions: t.shuffleQuestions,
        shuffleOptions: t.shuffleOptions,
        questions: t.questions.map(q=>({
          img: q.img,
          type: q.type,
          points: q.points,
          options: q.options,
          correct: q.correct,
          answers: q.answers
        }))
      };
      downloadJSON(`${t.id}.json`, openJson);
      toast('JSON yuklandi');
    };

    $('btnIndex').onclick = ()=>{
      const t = buildTestObject();
      if(!t.id) return toast('Test ID kerak');
      const entry = {
        id: t.id,
        code: t.code,
        title: t.title,
        grade: t.grade,
        examType: t.examType,
        file: `open-tests/${t.id}.json`
      };
      navigator.clipboard?.writeText(JSON.stringify(entry,null,2));
      toast('index.json entry clipboard‚Äôga nusxalandi');
      $('status').textContent = 'index.json entry: ' + JSON.stringify(entry);
    };

    // default
    QS = [qTemplate(0), qTemplate(1)];
    render();
  </script>
</div></main><footer><div class="footer-card"><div class="footer-left"><div class="footer-name">LeaderMath.UZ</div><div>¬© 2025 ‚Äî yagona dizayn: index1</div></div><div class="footer-right"><a class="footer-link" href="#"><i class="fa-brands fa-telegram"></i> Telegram</a><a class="footer-link" href="#"><i class="fa-solid fa-headset"></i> Yordam</a></div></div></footer></div><script src="assets/js/skin-bg.js"></script></body>
</html>
