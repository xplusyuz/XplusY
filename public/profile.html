<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#2E8B57" />
  <title>Profil — OrzuMall</title>

  <!-- Font Awesome (NO emoji) -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" referrerpolicy="no-referrer" />

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --primary:#2E8B57;
      --primary2:#1f6e44;
      --border: rgba(15,23,42,.10);
      --ring: rgba(46,139,87,.22);
      --shadow: 0 18px 50px rgba(15,23,42,.14);
      --r: 22px;
      --safe: env(safe-area-inset-bottom,0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
      color:var(--text);
      background:
        radial-gradient(900px 700px at 18% 0%, rgba(46,139,87,.14), transparent 60%),
        radial-gradient(900px 700px at 85% 15%, rgba(99,102,241,.10), transparent 60%),
        var(--bg);
      -webkit-tap-highlight-color: transparent;
    }
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(12px);
      background: rgba(246,247,251,.78);
      border-bottom: 1px solid var(--border);
    }
    .topbar .row{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 12px 16px;
      max-width: 760px;
      margin: 0 auto;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:42px; height:42px;
      border-radius: 14px;
      display:grid; place-items:center;
      color:#fff;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      box-shadow: 0 16px 34px rgba(46,139,87,.22);
    }
    .brand b{font-size:15px}
    .brand span{display:block; font-size:12px; color:var(--muted); margin-top:2px}
    .iconbtn{
      height:40px; width:40px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.84);
      cursor:pointer;
      display:grid; place-items:center;
      color:#334155;
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
    }
    .iconbtn:active{transform: translateY(1px)}
    .wrap{
      max-width: 760px;
      margin: 0 auto;
      padding: 16px 16px calc(18px + var(--safe));
    }
    .card{
      background: rgba(255,255,255,.92);
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .header{
      padding: 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .userrow{display:flex; align-items:center; gap:12px}
    .avatar{
      width:46px; height:46px;
      border-radius: 16px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.75);
      display:grid; place-items:center;
      font-weight:900;
      color:#111;
    }
    .name{font-weight:900; font-size:16px}
    .sub{color:var(--muted); font-size:12px; margin-top:2px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(46,139,87,.22);
      background: rgba(46,139,87,.10);
      color: var(--primary);
      font-weight: 900;
      font-size: 12px;
      margin-top: 6px;
    }
    .body{padding: 0 16px 16px}
    .grid{
      display:grid;
      grid-template-columns:1fr;
      gap: 10px;
    }
    .field{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.86);
      border-radius: 16px;
      padding: 12px 12px;
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
    }
    .field i{color: var(--muted)}
    .field .k{color: var(--muted); font-size:12px; min-width: 88px}
    .field .v{font-weight:800}
    .cta{
      width:100%;
      border:none;
      border-radius: 16px;
      padding: 12px 14px;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      color:#fff;
      font-weight:900;
      box-shadow: 0 14px 28px rgba(46,139,87,.26);
      cursor:pointer;
      margin-top: 12px;
    }
    .cta:active{transform: translateY(1px)}
    .toast{
      position:fixed; left:50%; bottom: 18px;
      transform: translateX(-50%);
      background: rgba(15,23,42,.90);
      color:#fff;
      border-radius: 999px;
      padding: 10px 14px;
      font-size:13px;
      display:none;
      z-index:999;
      max-width: calc(100vw - 24px);
      text-align:center;
    }
    .toast.show{display:block; animation: pop .16s ease-out}
    @keyframes pop{
      from{transform: translateX(-50%) translateY(6px); opacity:.7}
      to{transform: translateX(-50%) translateY(0); opacity:1}
    }
    .cfg{
      margin-top:10px;
      padding:10px 12px;
      border:1px dashed rgba(15,23,42,.18);
      border-radius: 14px;
      background: rgba(255,255,255,.60);
      color: rgba(100,116,139,.95);
      font-size: 12px;
      line-height: 1.35;
    }
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 11px;}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="row">
      <div class="brand">
        <div class="logo"><i class="fa-solid fa-user"></i></div>
        <div>
          <b>Profil</b>
          <span>OrzuMall</span>
        </div>
      </div>
      <button class="iconbtn" id="logoutBtn" title="Chiqish"><i class="fa-solid fa-right-from-bracket"></i></button>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="userrow">
          <div class="avatar" id="avatar">U</div>
          <div>
            <div class="name" id="name">User</div>
            <div class="pill" id="omPill"><i class="fa-solid fa-id-card"></i> <span id="omId">ID: OM000000</span></div>
            <div class="cfg" id="cfgNote" style="display:none">
              <b>Diqqat:</b> Firebase config to‘ldirilmagan. <br/>
              <span>profile.html ichidagi <code>FIREBASE_CONFIG</code> ni o‘zingiznikiga almashtiring.</span>
            </div>
          </div>
        </div>
      </div>
      <div class="body">
        <div class="grid">
          <div class="field">
            <i class="fa-solid fa-phone"></i>
            <div class="k">Telefon</div>
            <div class="v" id="phone">—</div>
          </div>
          <div class="field">
            <i class="fa-solid fa-calendar-plus"></i>
            <div class="k">Ro‘yxat</div>
            <div class="v" id="createdAt">—</div>
          </div>
        </div>

        <button class="cta" id="goHome">
          <i class="fa-solid fa-house" style="margin-right:8px"></i> Bosh sahifa
        </button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    // =========================
    // Firebase Config
    // =========================
    const FIREBASE_CONFIG = {
      apiKey: "",                 // <-- to'ldiring
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.appspot.com",
      messagingSenderId: "",
      appId: ""
    };
    const cfgOk = !!(FIREBASE_CONFIG && FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.appId);
    if(!cfgOk) document.getElementById("cfgNote").style.display = "block";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, updateDoc, runTransaction, Timestamp
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const app = initializeApp(FIREBASE_CONFIG);
    const db = getFirestore(app);

    const $ = (s) => document.querySelector(s);
    const toastEl = $("#toast");
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), 1800);
    }

    function fmtDate(ts){
      try{
        if(!ts) return "—";
        const d = ts.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
        if(!d) return "—";
        return new Intl.DateTimeFormat("uz-UZ", { dateStyle:"medium", timeStyle:"short" }).format(d);
      }catch{ return "—"; }
    }

    async function generateOMId(){
      const ref = doc(db, "meta", "counters");
      const omId = await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        const cur = snap.exists() ? Number(snap.data().omCounter || 0) : 0;
        const next = cur + 1;
        tx.set(ref, { omCounter: next }, { merge: true });
        return "OM" + String(next).padStart(6, "0");
      });
      return omId;
    }

    // Auth from localStorage (simple demo)
    const local = localStorage.getItem("om_user");
    if(!local){
      location.href = "login.html";
      throw new Error("not logged in");
    }
    const session = JSON.parse(local);
    $("#phone").textContent = session.phone || "—";

    // Load user from Firestore
    async function load(){
      if(!cfgOk) return;

      try{
        const phone = session.phone;
        const userRef = doc(db, "users", phone);
        const snap = await getDoc(userRef);
        if(!snap.exists()){
          localStorage.removeItem("om_user");
          location.href = "login.html";
          return;
        }
        const u = snap.data();

        // Ensure OM ID exists
        let omId = u.omId;
        if(!omId){
          omId = await generateOMId();
          await updateDoc(userRef, { omId });
        }

        // Update session cache
        const name = u.name || "User";
        localStorage.setItem("om_user", JSON.stringify({ phone, name, omId }));

        // Render
        $("#name").textContent = name;
        $("#avatar").textContent = (name || "U").trim().slice(0,1).toUpperCase();
        $("#omId").textContent = "ID: " + omId;
        $("#createdAt").textContent = fmtDate(u.createdAt);

      }catch(err){
        console.error(err);
        toast("Profilni yuklashda xatolik");
      }
    }
    await load();

    // Buttons
    $("#logoutBtn").addEventListener("click", ()=>{
      localStorage.removeItem("om_user");
      location.href = "login.html";
    });
    $("#goHome").addEventListener("click", ()=>{
      // Agar sizda asosiy sahifa index.html bo'lsa:
      location.href = "index.html";
    });
  </script>
</body>
</html>
