<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#0ea5e9"/>
  <link rel="icon" sizes="192x192" href="logo.png"/>
  <link rel="apple-touch-icon" href="logo.png"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
  <link rel="stylesheet" href="assets/css/style.css"/>
  <link rel="stylesheet" href="assets/css/bridge.css"/>
  <title>Challenge ‚Äî LeaderMath.UZ</title>
</head>
<body data-page="challenge">
  <div class="scroll-progress"><div class="scroll-progress-bar" id="scrollProgress"></div></div>
  <button class="scroll-to-top" id="scrollToTop" aria-label="Yuqoriga"><i class="fa-solid fa-arrow-up"></i></button>
  <canvas id="three-canvas"></canvas>

  <div class="app">
    <div class="container">
      <div class="glass topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"><span>œÄ</span></div>
          <div class="titleWrap">
            <div class="title">Online Challenge</div>
            <div class="subtitle">Faqat 4 xonali kod bilan kirish</div>
          </div>
        </div>
        <a class="btn" href="app.html">üè† Bosh sahifa</a>
      </div>

      <div class="glass section">
        <div class="sectionTitle">
          <h2>Challenge kodini kiriting</h2>
          <div class="hint">Boshlash va tugash vaqti avtomatik tekshiriladi</div>
        </div>

        <div class="codeRow" style="grid-template-columns: 1fr auto; align-items:end;">
          <div>
            <div class="nameLine">4 xonali kod</div>
            <input class="input" id="code" inputmode="numeric" maxlength="4" placeholder="1234"/>
            <div class="small" id="info" style="margin-top:8px; opacity:.9"></div>
          </div>
          <button class="btn" id="startBtn" style="min-width:180px;">üöÄ Boshlash</button>
        </div>

        <div class="hr"></div>

        <div id="countBox" class="glass" style="display:none; padding:14px; border-radius:26px;">
          <div class="nameLine">Boshlanishigacha</div>
          <div id="timer" style="font-size:30px; font-weight:900; letter-spacing:1px; margin-top:8px;">00:00:00</div>
          <div class="small" id="hint" style="margin-top:6px; opacity:.9"></div>
        </div>

        <div class="small" id="status" style="margin-top:10px; opacity:.9"></div>
      </div>

      <div id="toast" class="toast"></div>
      <canvas id="seasonCanvas" style="display:none;"></canvas>
    </div>
  </div>

  <script type="module">
    import { initSeasons } from "./assets/js/seasons.js";
    initSeasons("seasonCanvas");
  </script>

  <script type="module">
    import { api } from "./assets/js/api.js";
    import { me, registerAuto, getToken } from "./assets/js/auth.js";

    const $ = (id)=>document.getElementById(id);
    const toast = (msg)=>{ const t=$("toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 2400); };
    const fmt2 = (n)=>String(Math.max(0, Math.floor(n))).padStart(2,"0");
    const formatHMS = (ms)=>{ const s=Math.max(0, Math.floor(ms/1000)); const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); const ss=s%60; return `${fmt2(h)}:${fmt2(m)}:${fmt2(ss)}`; };

    // auto-auth: if no token, register silently (simple)
    try{
      const token = getToken();
      if(!token){
        await registerAuto();
      }
      await me();
    }catch(e){
      // fallback: go login
      location.href="./";
    }

    let interval=null;
    function showCountdown(startAt, endAt, code){
      $("countBox").style.display="block";
      const sa=new Date(Number(startAt||0));
      const ea=new Date(Number(endAt||0));
      $("hint").textContent = `Boshlanish: ${sa.toLocaleString()} ¬∑ Tugash: ${ea.toLocaleString()}`;
      if(interval) clearInterval(interval);
      interval=setInterval(async ()=>{
        const left = Number(startAt||0) - Date.now();
        $("timer").textContent = formatHMS(left);
        if(left<=0){
          clearInterval(interval); interval=null;
          await start(true, code);
        }
      }, 250);
    }

    async function start(isAuto=false, forcedCode=null){
      const code = forcedCode || String($("code").value||"").trim();
      if(!/^[0-9]{4}$/.test(code)){ toast("4 xonali kod kiriting"); return; }
      $("status").textContent = isAuto ? "Boshlanish tekshirilmoqda‚Ä¶" : "Tekshirilmoqda‚Ä¶";
      $("info").textContent="";
      $("countBox").style.display="none";

      try{
        const r = await api("tests/resolve", { query:{ code }});
        const t = r.test;
        if(!t || !t.id){ $("status").textContent="Test topilmadi"; return; }
        const u = new URL("test.html", location.href);
        u.searchParams.set("mode","challenge");
        u.searchParams.set("id", t.id);
        u.searchParams.set("code", code);
        location.href=u.toString();
      }catch(e){
        const data = e?.data || {};
        const msg = e.message || "Kirish xato";
        $("status").textContent = msg;
        if(data.startAt && msg.toLowerCase().includes("boshlanmagan")){
          $("info").textContent = "Vaqti kelganda avtomatik boshlanadi.";
          showCountdown(data.startAt, data.endAt, code);
        }
      }
    }

    $("startBtn").onclick = ()=>start(false);
  </script>

  <script src="assets/js/core.js"></script>
</body>
</html>
