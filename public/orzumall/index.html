<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OrzuMall.uz ‚Äî Marketplace</title>
  <style>
    :root{
      --bg:#0b1220; --card:rgba(255,255,255,.06); --card2:rgba(255,255,255,.09);
      --text:#eaf1ff; --muted:rgba(234,241,255,.7);
      --pri:#2E8B57; --line:rgba(255,255,255,.12);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto; background:radial-gradient(1200px 600px at 20% 0%, rgba(46,139,87,.28), transparent 60%),
      radial-gradient(900px 500px at 90% 10%, rgba(60,120,255,.22), transparent 55%),
      var(--bg); color:var(--text);}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .topbar{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(14px);
      background:linear-gradient(to bottom, rgba(11,18,32,.78), rgba(11,18,32,.35));
      border-bottom:1px solid var(--line);
    }
    .bar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:38px;height:38px;border-radius:14px;
      background:linear-gradient(135deg, rgba(46,139,87,.95), rgba(46,139,87,.45));
      box-shadow:0 10px 30px rgba(46,139,87,.25);
      display:grid;place-items:center;font-weight:800;
    }
    .brand h1{font-size:16px;margin:0;line-height:1.1}
    .brand .sub{font-size:12px;color:var(--muted)}
    .search{flex:1;max-width:620px;display:flex;gap:8px;align-items:center}
    .inp{
      flex:1;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      color:var(--text);
      padding:12px 14px;border-radius:16px;outline:none;
    }
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:11px 13px;border-radius:16px;
      cursor:pointer;
      transition:.15s transform,.15s background;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.09)}
    .btn.pri{background:rgba(46,139,87,.22);border-color:rgba(46,139,87,.35)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.05)}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;margin-top:16px}
    .left{grid-column:span 3}
    .main{grid-column:span 9}
    @media (max-width:980px){ .left{grid-column:span 12} .main{grid-column:span 12} .bar{flex-wrap:wrap} .search{order:3;max-width:none;width:100%} }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:0 20px 70px rgba(0,0,0,.35);
    }
    .sec{padding:14px}
    .sec h2{margin:0 0 8px;font-size:14px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      padding:9px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.05);cursor:pointer;font-size:13px;color:var(--muted)
    }
    .chip.active{background:rgba(46,139,87,.22);border-color:rgba(46,139,87,.35);color:var(--text)}
    .products{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    @media (max-width:980px){ .products{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:520px){ .products{grid-template-columns:1fr} }
    .p{
      overflow:hidden;border-radius:var(--r);
      background:rgba(255,255,255,.05);
      border:1px solid var(--line);
      display:flex;flex-direction:column;
    }
    .pimg{height:170px;background:linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.02));display:grid;place-items:center}
    .pimg img{width:100%;height:100%;object-fit:cover;display:block}
    .pbody{padding:12px;display:flex;flex-direction:column;gap:8px}
    .pt{font-weight:700}
    .pm{color:var(--muted);font-size:12px}
    .prow{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .price{font-weight:900}
    .small{font-size:12px;color:var(--muted)}
    .modal{
      position:fixed; inset:0; background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:50;
    }
    .modal.open{display:flex}
    .box{width:min(920px,100%); max-height:92vh; overflow:auto}
    .box .head{display:flex;align-items:center;justify-content:space-between;padding:14px 14px;border-bottom:1px solid var(--line)}
    .box .body{padding:14px}
    .row{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px dashed rgba(255,255,255,.12)}
    .row:last-child{border-bottom:0}
    .qty{display:flex;gap:8px;align-items:center}
    .qty button{width:34px;height:34px;border-radius:12px}
    .two{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media (max-width:900px){ .two{grid-template-columns:1fr} }
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    .field label{font-size:12px;color:var(--muted)}
    .field input,.field textarea, .field select{
      background:rgba(255,255,255,.06); border:1px solid var(--line); color:var(--text);
      padding:11px 12px;border-radius:14px; outline:none;
    }
    .hint{font-size:12px;color:var(--muted);line-height:1.35}
  </style>
</head>
<body>

<div class="topbar">
  <div class="bar wrap">
    <div class="brand">
      <div class="logo">OZ</div>
      <div>
        <h1>OrzuMall.uz</h1>
        <div class="sub">Universal Marketplace</div>
      </div>
    </div>

    <div class="search">
      <input id="q" class="inp" placeholder="Mahsulot qidiring: telefon, kiyim, uy jihozlari..." />
      <button class="btn" id="btnSearch">Qidirish</button>
    </div>

    <div style="display:flex;gap:10px;align-items:center">
      <span class="pill" id="rolePill">üë§ Guest</span>
      <button class="btn pri" id="btnCart">üõç Savat <span id="cartCount" class="small">(0)</span></button>
      <button class="btn" id="btnSeller">üè™ Sotuvchi</button>
    </div>
  </div>
</div>

<div class="wrap grid">
  <aside class="left card">
    <div class="sec">
      <h2>Kategoriyalar</h2>
      <div class="chips" id="cats"></div>
      <div style="height:10px"></div>
      <div class="hint">
        Marketplace rejim: har xil yo‚Äònalishdagi tovarlar. Sotuvchilar o‚Äòz do‚Äòkonidan mahsulot qo‚Äòshadi.
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="card">
      <div class="sec" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div>
          <div style="font-weight:900;font-size:18px">Tovarlar</div>
          <div class="small" id="meta">Yuklanmoqda...</div>
        </div>
        <button class="btn" id="btnSeed">‚ö° Demo mahsulotlar qo‚Äòshish</button>
      </div>
    </div>

    <div style="height:14px"></div>

    <div class="products" id="products"></div>
  </main>
</div>

<!-- CART MODAL -->
<div class="modal" id="mCart">
  <div class="card box">
    <div class="head">
      <div style="font-weight:900">üõç Savat</div>
      <button class="btn" data-close="mCart">‚úï</button>
    </div>
    <div class="body two">
      <div>
        <div id="cartItems"></div>
        <div style="height:10px"></div>
        <button class="btn" id="btnClearCart">Savatni tozalash</button>
      </div>
      <div class="card" style="padding:14px">
        <div style="font-weight:900;font-size:16px;margin-bottom:8px">Checkout</div>
        <div class="field"><label>Ism</label><input id="cName" placeholder="Ismingiz"></div>
        <div class="field"><label>Telefon</label><input id="cPhone" placeholder="+998..."></div>
        <div class="field"><label>Manzil</label><textarea id="cAddr" rows="3" placeholder="Viloyat, tuman, ko‚Äòcha, uy..."></textarea></div>
        <div class="row"><div>Jami</div><div class="price" id="cartTotal">0 so‚Äòm</div></div>
        <button class="btn pri" id="btnCheckout" style="width:100%;margin-top:10px">Buyurtma berish</button>
        <div class="hint" style="margin-top:10px">
          Keyin to‚Äòlov integratsiyasi: Click/Payme. Hozir buyurtma Firestore‚Äôga yoziladi.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SELLER MODAL -->
<div class="modal" id="mSeller">
  <div class="card box">
    <div class="head">
      <div style="font-weight:900">üè™ Sotuvchi panel (MVP)</div>
      <button class="btn" data-close="mSeller">‚úï</button>
    </div>
    <div class="body two">
      <div class="card" style="padding:14px">
        <div style="font-weight:900;margin-bottom:10px">Mahsulot qo‚Äòshish</div>
        <div class="field"><label>Nomi</label><input id="pTitle" placeholder="Masalan: AirPods Pro"></div>
        <div class="field"><label>Narx (so‚Äòm)</label><input id="pPrice" type="number" placeholder="1200000"></div>
        <div class="field"><label>Kategoriya</label><select id="pCat"></select></div>
        <div class="field"><label>Rasm URL (hozircha)</label><input id="pImg" placeholder="https://.../image.webp"></div>
        <div class="field"><label>Do‚Äòkon nomi</label><input id="pShop" placeholder="Sotuvchi do‚Äòkoni"></div>
        <button class="btn pri" id="btnAddProduct">Qo‚Äòshish</button>
        <div class="hint" style="margin-top:10px">
          Keyingi bosqich: rasmni Firebase Storage‚Äôga yuklash + shop tasdiqlash (moderation).
        </div>
      </div>
      <div class="card" style="padding:14px">
        <div style="font-weight:900;margin-bottom:10px">Sotuvchi buyurtmalari</div>
        <div class="hint">MVP‚Äôda demo: buyurtmalar `order_items` orqali sotuvchiga ajratiladi.</div>
        <div style="height:10px"></div>
        <div id="sellerOrders"></div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  // ---------------- Firebase ----------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getFirestore, collection, doc, getDoc, setDoc, addDoc, getDocs, query, where, orderBy, limit, Timestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyADOv69HBuAJkaYs2Ukgab-VgqkJIv1Cro",
    authDomain: "orzumall.firebaseapp.com",
    projectId: "orzumall",
    storageBucket: "orzumall.firebasestorage.app",
    messagingSenderId: "873732887270",
    appId: "1:873732887270:web:15b73dbb37f4fdabe8a127",
    measurementId: "G-2LEH8YWPLF"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ---------------- State ----------------
  const CATEGORIES = [
    { id:"all", title:"Hammasi" },
    { id:"electronics", title:"Elektronika" },
    { id:"phones", title:"Telefonlar" },
    { id:"home", title:"Uy-ro‚Äòzg‚Äòor" },
    { id:"clothes", title:"Kiyim-kechak" },
    { id:"kids", title:"Bolalar" },
    { id:"beauty", title:"Go‚Äòzallik" },
    { id:"auto", title:"Avto" },
    { id:"books", title:"Kitoblar" },
  ];

  let activeCat = "all";
  let searchQ = "";
  let cart = loadCart();

  // ---------------- UI helpers ----------------
  const $ = (id)=>document.getElementById(id);
  const money = (n)=> (Number(n||0)).toLocaleString("uz-UZ") + " so‚Äòm";

  function openModal(id){ $(id).classList.add("open"); }
  function closeModal(id){ $(id).classList.remove("open"); }

  document.querySelectorAll("[data-close]").forEach(b=>{
    b.addEventListener("click", ()=> closeModal(b.dataset.close));
  });

  $("btnCart").addEventListener("click", ()=> { renderCart(); openModal("mCart"); });
  $("btnSeller").addEventListener("click", ()=> { renderSellerOrders(); openModal("mSeller"); });
  $("btnSearch").addEventListener("click", ()=> { searchQ = $("q").value.trim(); loadProducts(); });
  $("q").addEventListener("keydown",(e)=>{ if(e.key==="Enter"){ searchQ = $("q").value.trim(); loadProducts(); } });

  $("btnClearCart").addEventListener("click", ()=>{ cart=[]; saveCart(); renderCartBadge(); renderCart(); });
  $("btnCheckout").addEventListener("click", checkout);

  // seller add
  $("btnAddProduct").addEventListener("click", addProduct);

  // seed demo
  $("btnSeed").addEventListener("click", seedDemoProducts);

  // categories UI
  function renderCats(){
    const box = $("cats");
    box.innerHTML = "";
    CATEGORIES.forEach(c=>{
      const b = document.createElement("button");
      b.className = "chip" + (c.id===activeCat ? " active":"");
      b.textContent = c.title;
      b.onclick = ()=>{ activeCat = c.id; renderCats(); loadProducts(); };
      box.appendChild(b);
    });
    // seller select
    const sel = $("pCat");
    sel.innerHTML = "";
    CATEGORIES.filter(x=>x.id!=="all").forEach(c=>{
      const o = document.createElement("option");
      o.value = c.id; o.textContent = c.title;
      sel.appendChild(o);
    });
  }

  // ---------------- Cart persistence ----------------
  function loadCart(){
    try{ return JSON.parse(localStorage.getItem("orzumall_cart")||"[]"); }catch{ return []; }
  }
  function saveCart(){ localStorage.setItem("orzumall_cart", JSON.stringify(cart)); }
  function renderCartBadge(){ $("cartCount").textContent = `(${cart.reduce((a,b)=>a+(b.qty||1),0)})`; }

  // ---------------- Products ----------------
  async function loadProducts(){
    $("meta").textContent = "Yuklanmoqda...";
    const ref = collection(db, "products");

    // Simple MVP query: we fetch latest, then filter client-side for search+category
    // (Keyingi bosqich: search index + server-side query)
    const qy = query(ref, orderBy("createdAt","desc"), limit(60));
    const snap = await getDocs(qy);

    let items = [];
    snap.forEach(d => items.push({ id:d.id, ...d.data() }));

    if(activeCat !== "all") items = items.filter(p=>p.category===activeCat);
    if(searchQ) {
      const s = searchQ.toLowerCase();
      items = items.filter(p => (p.title||"").toLowerCase().includes(s) || (p.shopName||"").toLowerCase().includes(s));
    }

    $("meta").textContent = `${items.length} ta mahsulot ¬∑ kategoriya: ${CATEGORIES.find(x=>x.id===activeCat)?.title || "Hammasi"}`;
    renderProducts(items);
  }

  function renderProducts(items){
    const box = $("products");
    box.innerHTML = "";
    if(items.length===0){
      box.innerHTML = `<div class="card" style="padding:14px;color:rgba(234,241,255,.8)">Hech narsa topilmadi.</div>`;
      return;
    }
    items.forEach(p=>{
      const el = document.createElement("div");
      el.className = "p";
      el.innerHTML = `
        <div class="pimg">
          ${p.imageUrl ? `<img src="${escapeHtml(p.imageUrl)}" alt="">` : `<div class="small">Rasm yo‚Äòq</div>`}
        </div>
        <div class="pbody">
          <div class="pt">${escapeHtml(p.title||"Mahsulot")}</div>
          <div class="pm">üè™ ${escapeHtml(p.shopName||"Do‚Äòkon")}</div>
          <div class="prow">
            <div class="price">${money(p.price)}</div>
            <button class="btn pri">Savatga</button>
          </div>
          <div class="small">Kategoriyasi: ${escapeHtml(p.category||"-")}</div>
        </div>
      `;
      el.querySelector("button").onclick = ()=> addToCart(p);
      box.appendChild(el);
    });
  }

  function addToCart(p){
    const idx = cart.findIndex(x=>x.productId===p.id);
    if(idx>=0) cart[idx].qty = (cart[idx].qty||1)+1;
    else cart.push({ productId:p.id, title:p.title, price:Number(p.price||0), qty:1, shopName:p.shopName||"", sellerUid:p.sellerUid||"" });
    saveCart();
    renderCartBadge();
  }

  function renderCart(){
    const box = $("cartItems");
    if(cart.length===0){
      box.innerHTML = `<div class="hint">Savat bo‚Äòsh.</div>`;
      $("cartTotal").textContent = money(0);
      return;
    }
    box.innerHTML = "";
    let total = 0;

    cart.forEach((it, i)=>{
      total += (it.price||0) * (it.qty||1);
      const row = document.createElement("div");
      row.className="row";
      row.innerHTML = `
        <div>
          <div style="font-weight:800">${escapeHtml(it.title||"")}</div>
          <div class="small">üè™ ${escapeHtml(it.shopName||"")}</div>
          <div class="small">${money(it.price)} ¬∑ ${it.qty||1} dona</div>
        </div>
        <div class="qty">
          <button class="btn">‚àí</button>
          <div style="min-width:24px;text-align:center;font-weight:800">${it.qty||1}</div>
          <button class="btn">+</button>
          <button class="btn">üóë</button>
        </div>
      `;
      const [bMinus, bPlus, bDel] = row.querySelectorAll("button");
      bMinus.onclick = ()=>{
        it.qty = Math.max(1,(it.qty||1)-1);
        saveCart(); renderCartBadge(); renderCart();
      };
      bPlus.onclick = ()=>{
        it.qty = (it.qty||1)+1;
        saveCart(); renderCartBadge(); renderCart();
      };
      bDel.onclick = ()=>{
        cart.splice(i,1);
        saveCart(); renderCartBadge(); renderCart();
      };

      box.appendChild(row);
    });

    $("cartTotal").textContent = money(total);
  }

  async function checkout(){
    if(cart.length===0) return alert("Savat bo‚Äòsh.");
    const name = $("cName").value.trim();
    const phone = $("cPhone").value.trim();
    const addr = $("cAddr").value.trim();
    if(!name || !phone || !addr) return alert("Ism, telefon va manzilni kiriting.");

    // MVP buyerUid: guest id
    const buyerUid = getOrCreateGuestUid();

    const total = cart.reduce((a,b)=>a+(b.price||0)*(b.qty||1),0);

    // 1) create order
    const orderRef = await addDoc(collection(db,"orders"),{
      buyerUid,
      customer:{ name, phone, addr },
      total,
      status:"pending",
      createdAt: Timestamp.now(),
      updatedAt: Timestamp.now()
    });

    // 2) create order_items (each item includes seller/shop info)
    // Marketplace uchun juda muhim: sotuvchiga itemlar ajraladi
    const itemsCol = collection(db,"order_items");
    for(const it of cart){
      await addDoc(itemsCol,{
        orderId: orderRef.id,
        productId: it.productId,
        title: it.title,
        price: it.price,
        qty: it.qty,
        shopName: it.shopName,
        sellerUid: it.sellerUid || null,
        status: "pending",
        createdAt: Timestamp.now()
      });
    }

    alert("‚úÖ Buyurtma yuborildi! Tez orada sotuvchi bog‚Äòlanadi.");
    cart = []; saveCart(); renderCartBadge(); closeModal("mCart");
    $("cName").value=""; $("cPhone").value=""; $("cAddr").value="";
  }

  // ---------------- Seller (MVP) ----------------
  function getOrCreateGuestUid(){
    let id = localStorage.getItem("orzumall_guest_uid");
    if(!id){
      id = "guest_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
      localStorage.setItem("orzumall_guest_uid", id);
    }
    return id;
  }

  async function addProduct(){
    const sellerUid = getOrCreateGuestUid(); // MVP: guest = seller ham bo‚Äòlishi mumkin (keyin Auth)
    const title = $("pTitle").value.trim();
    const price = Number($("pPrice").value || 0);
    const category = $("pCat").value;
    const imageUrl = $("pImg").value.trim();
    const shopName = $("pShop").value.trim() || "Orzu Seller";

    if(!title || price<=0) return alert("Nomi va narxni to‚Äòg‚Äòri kiriting.");

    await addDoc(collection(db,"products"),{
      title,
      price,
      category,
      imageUrl,
      shopName,
      sellerUid,
      active: true,        // moderation uchun: keyin admin tasdiqlaydi
      createdAt: Timestamp.now(),
      updatedAt: Timestamp.now()
    });

    $("pTitle").value=""; $("pPrice").value=""; $("pImg").value="";
    alert("‚úÖ Mahsulot qo‚Äòshildi!");
    loadProducts();
  }

  async function renderSellerOrders(){
    const sellerUid = getOrCreateGuestUid();
    const box = $("sellerOrders");
    box.innerHTML = "Yuklanmoqda...";

    // seller o‚Äòz order_items‚Äôlarini ko‚Äòradi (MVP)
    const ref = collection(db,"order_items");
    const qy = query(ref, where("sellerUid","==", sellerUid), orderBy("createdAt","desc"), limit(30));
    const snap = await getDocs(qy);

    const items = [];
    snap.forEach(d=>items.push({id:d.id, ...d.data()}));

    if(items.length===0){
      box.innerHTML = `<div class="hint">Hozircha sizga buyurtma tushmagan.</div>`;
      return;
    }

    box.innerHTML = items.map(it=>`
      <div class="row">
        <div>
          <div style="font-weight:800">${escapeHtml(it.title||"")}</div>
          <div class="small">Order: ${escapeHtml(it.orderId||"-")}</div>
          <div class="small">${money(it.price)} ¬∑ ${it.qty} dona ¬∑ ${escapeHtml(it.status||"")}</div>
        </div>
      </div>
    `).join("");
  }

  // ---------------- Demo seed ----------------
  async function seedDemoProducts(){
    const sellerUid = getOrCreateGuestUid();
    const demo = [
      { title:"Bluetooth quloqchin", price:199000, category:"electronics", imageUrl:"", shopName:"Orzu Tech" },
      { title:"Krossovka (unisex)", price:289000, category:"clothes", imageUrl:"", shopName:"Orzu Fashion" },
      { title:"Kichik blender", price:349000, category:"home", imageUrl:"", shopName:"Orzu Home" },
      { title:"Bolalar lego set", price:159000, category:"kids", imageUrl:"", shopName:"Orzu Kids" },
      { title:"Avto registrator", price:499000, category:"auto", imageUrl:"", shopName:"Orzu Auto" },
      { title:"Bestseller kitob", price:69000, category:"books", imageUrl:"", shopName:"Orzu Books" },
    ];
    for(const p of demo){
      await addDoc(collection(db,"products"),{
        ...p,
        sellerUid,
        active:true,
        createdAt: Timestamp.now(),
        updatedAt: Timestamp.now()
      });
    }
    alert("‚úÖ Demo mahsulotlar qo‚Äòshildi!");
    loadProducts();
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // init
  renderCats();
  renderCartBadge();
  loadProducts();
</script>

</body>
</html>
