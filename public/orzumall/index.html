<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#6A0DAD" />
  <title>OrzuMall ‚Äî Katalog</title>
  <meta name="description" content="OrzuMall ‚Äî faqat katalog: yopishqoq header, Telegram login, kategoriya chiplar, mahsulotlar." />

  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#5b6476;
      --line:rgba(18, 25, 38, .10);

      --brand:#6A0DAD;
      --brand2:#7C2AE8;
      --accent:#FF3D00;
      --ok:#12B76A;
      --danger:#F43F5E;

      --shadow:0 18px 45px rgba(10, 15, 25, .10);
      --shadow2:0 10px 25px rgba(10, 15, 25, .08);

      --r16:16px;
      --r20:20px;
      --r24:24px;
      --max:1240px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% -10%, rgba(106,13,173,.20), transparent 55%),
        radial-gradient(1000px 650px at 110% 5%, rgba(124,42,232,.16), transparent 55%),
        radial-gradient(900px 650px at 50% 110%, rgba(255,61,0,.10), transparent 55%),
        linear-gradient(135deg, #f6f7fb, #ffffff);
      background-attachment: fixed;
      overflow-x:hidden;
    }
    a{color:inherit;text-decoration:none}
    button,input{font:inherit}
    .container{max-width:var(--max); margin:0 auto; padding:0 18px}
    .hidden{display:none !important}

    /* ===== Sticky Header ===== */
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(200%) blur(18px);
      background:rgba(246,247,251,0.80);
      border-bottom:1px solid rgba(18,25,38,.06);
    }
    .topbar-inner{
      display:flex; align-items:center; gap:12px;
      padding:12px 0;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:38px;height:38px;border-radius:14px;
      background:
        radial-gradient(16px 16px at 30% 30%, rgba(255,255,255,.75), transparent 60%),
        linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 14px 30px rgba(106,13,173,.22);
      position:relative;
      flex:0 0 auto;
    }
    .logo:after{
      content:"";
      position:absolute; inset:9px;
      border-radius:10px;
      background:rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.28);
    }
    .brand-title{display:flex; flex-direction:column; line-height:1.05}
    .brand-title b{
      font-size:15px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip:text;
    }
    .brand-title span{font-size:12px; color:var(--muted)}

    .spacer{flex:1}

    .pillbar{display:flex; align-items:center; gap:10px}
    .iconbtn{
      height:40px; min-width:40px;
      border-radius:999px;
      backdrop-filter: blur(10px);
      background: rgba(255,255,255,0.82);
      border:1px solid rgba(18,25,38,.08);
      display:inline-flex; align-items:center; justify-content:center;
      box-shadow: 0 8px 25px rgba(10,15,25,.06), 0 3px 10px rgba(10,15,25,.03);
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
      position:relative;
      user-select:none;
    }
    .iconbtn:hover{transform:translateY(-1px); box-shadow: 0 12px 35px rgba(10,15,25,.10)}
    .iconbtn:active{transform:translateY(0)}
    .badge{
      position:absolute; top:-6px; right:-6px;
      background:linear-gradient(135deg, var(--accent), #ff6a3d);
      color:#fff;
      border-radius:999px;
      padding:3px 7px;
      font-size:11px;
      font-weight:900;
      border:2px solid rgba(246,247,251,1);
      box-shadow: 0 12px 30px rgba(255,61,0,0.25), 0 6px 18px rgba(255,61,0,0.18);
    }

    .userchip{
      display:flex; align-items:center; gap:10px;
      height:40px;
      border-radius:999px;
      padding:6px 10px 6px 6px;
      border:1px solid rgba(18,25,38,.10);
      background:rgba(255,255,255,.72);
      box-shadow: 0 6px 18px rgba(10,15,25,.05);
      cursor:pointer;
      user-select:none;
    }
    .avatar{
      width:28px;height:28px;border-radius:999px;
      background:linear-gradient(135deg, var(--brand), var(--brand2));
      display:grid; place-items:center;
      color:#fff; font-weight:900; font-size:12px;
      box-shadow: 0 15px 35px rgba(106,13,173,.20), 0 8px 20px rgba(106,13,173,.12);
      border: 2px solid rgba(255,255,255,0.9);
      overflow:hidden;
    }
    .avatar img{width:100%;height:100%;object-fit:cover; display:block}
    .userchip .meta{display:flex; flex-direction:column; line-height:1.05}
    .userchip .meta b{font-size:12px}
    .userchip .meta span{font-size:11px; color:var(--muted)}

    /* ===== Chips (under header) ===== */
    .chipsbar-wrap{
      padding:0 0 10px;
    }
    .chipbar{
      display:flex; gap:10px;
      overflow:auto;
      padding:8px 0 2px;
      scrollbar-width:none;
    }
    .chipbar::-webkit-scrollbar{display:none}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 16px;
      border-radius:999px;
      background: rgba(255,255,255,0.86);
      border:1px solid rgba(18,25,38,.08);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 25px rgba(10,15,25,.05), 0 4px 10px rgba(10,15,25,.02);
      cursor:pointer;
      user-select:none;
      transition:transform .12s ease, background .12s ease;
      white-space:nowrap;
      font-weight:800;
      font-size:13px;
    }
    .chip:hover{transform:translateY(-2px)}
    .chip.active{
      background: linear-gradient(135deg, rgba(106,13,173,0.18), rgba(124,42,232,0.12));
      border-color: rgba(106,13,173,0.25);
      box-shadow: 0 10px 30px rgba(106,13,173,0.14), 0 4px 12px rgba(106,13,173,0.08);
      color:#2b0f44;
    }

    /* ===== Products ===== */
    main{padding:10px 0 34px}
    .grid{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:14px;
    }
    .p{
      border-radius:var(--r20);
      background: rgba(255,255,255,0.85);
      border:1px solid rgba(18,25,38,.06);
      box-shadow: 0 15px 35px rgba(10,15,25,0.08), 0 5px 15px rgba(10,15,25,0.03);
      overflow:hidden;
      transition: all .22s cubic-bezier(0.4, 0, 0.2, 1);
      position:relative;
    }
    .p:hover{
      transform: translateY(-6px);
      box-shadow: 0 28px 60px rgba(10,15,25,0.14), 0 10px 25px rgba(10,15,25,0.05);
      border-color: rgba(106,13,173,0.14);
    }
    .p .img{
      height:190px;
      background: linear-gradient(135deg, rgba(106,13,173,.10), rgba(124,42,232,.08));
      display:grid; place-items:center;
      position:relative;
      overflow:hidden;
    }
    .p img{width:100%; height:100%; object-fit:cover; display:block; background:#fff}
    .p .img .ph{width:64px;height:64px;border-radius:22px;background: linear-gradient(135deg, var(--brand), var(--brand2));opacity:.18}
    .heart{
      position:absolute; top:10px; right:10px;
      width:38px; height:38px; border-radius:999px;
      border:1px solid rgba(18,25,38,.10);
      backdrop-filter: blur(5px);
      background: rgba(255,255,255,.82);
      display:grid; place-items:center;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(10,15,25,.08);
      transition:transform .12s ease, background .12s ease;
      user-select:none;
    }
    .heart:hover{transform:translateY(-1px)}
    .heart.active{background: linear-gradient(135deg, rgba(244,63,94,.12), rgba(255,61,0,.10)); border-color: rgba(244,63,94,.25)}
    .p .body{padding:12px}
    .p .title{
      font-weight:950;
      letter-spacing:-.01em;
      font-size:13px;
      line-height:1.25;
      margin:0 0 6px;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height:32px;
    }
    .p .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .price{font-weight:950; font-size:14px; letter-spacing:-.01em}
    .cta{
      height:40px;
      border-radius:14px;
      border:1px solid rgba(18,25,38,.10);
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      border-color: rgba(106,13,173,.3);
      color:#fff;
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      width:44px;
      box-shadow: 0 16px 34px rgba(106,13,173,0.20);
      user-select:none;
    }
    .cta:hover{transform:translateY(-1px)}

    /* ===== Overlay + Drawers ===== */
    .overlay{
      position:fixed; inset:0;
      background: rgba(10,15,25,.38);
      backdrop-filter: blur(10px);
      display:none;
      z-index:80;
    }
    .overlay.show{display:block}
    .drawer{
      position:fixed; top:0; right:0; height:100%;
      width:min(420px, 92vw);
      backdrop-filter: blur(30px);
      background: rgba(255,255,255,0.90);
      border-left: 1px solid rgba(255,255,255,0.2);
      box-shadow: -30px 0 70px rgba(10,15,25,.18);
      transform: translateX(110%);
      transition: transform .18s ease;
      z-index:90;
      display:flex; flex-direction:column;
    }
    .drawer.show{transform: translateX(0)}
    .dhead{
      padding:14px 14px 12px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(18,25,38,.08);
    }
    .dhead b{font-size:14px}
    .xbtn{
      width:40px;height:40px;border-radius:999px;
      border:1px solid rgba(18,25,38,.10);
      background: rgba(255,255,255,.75);
      cursor:pointer;
      display:grid; place-items:center;
      user-select:none;
    }
    .dbody{padding:14px; overflow:auto; flex:1}
    .desc{
      padding:12px;
      border-radius:18px;
      background: rgba(255,255,255,.72);
      border:1px solid rgba(18,25,38,.08);
      color:#2c3342;
      font-size:13px;
      line-height:1.6;
      white-space:pre-wrap;
    }

    /* Telegram widget layout */
    .tgwrap{
      display:grid;
      gap:12px;
      padding:6px 0;
    }
    .tip{
      font-size:12px;
      color:var(--muted);
      line-height:1.6;
    }
    .btnlite{
      height:44px;
      border-radius:14px;
      border:1px solid rgba(18,25,38,.10);
      background: rgba(255,255,255,.92);
      cursor:pointer;
      font-weight:950;
      padding:0 12px;
      display:flex; align-items:center; justify-content:center;
      gap:10px;
      user-select:none;
    }
    .btnlite.danger{
      background: linear-gradient(135deg, rgba(244,63,94,.12), rgba(255,61,0,.10));
      border-color: rgba(244,63,94,.22);
      color:#7a0d22;
    }

    /* Responsive */
    @media (max-width: 1060px){ .grid{grid-template-columns: repeat(3, 1fr)} }
    @media (max-width: 760px){
      .topbar-inner{gap:10px}
      .brand-title span{display:none}
      .grid{grid-template-columns: repeat(2, 1fr)}
    }
    @media (max-width: 420px){ .grid{grid-template-columns: 1fr} }
  </style>
</head>

<body>
  <!-- Sticky header -->
  <header class="topbar">
    <div class="container">
      <div class="topbar-inner">
        <a class="brand" href="#" aria-label="OrzuMall">
          <div class="logo" aria-hidden="true"></div>
          <div class="brand-title">
            <b id="storeNameTop">OrzuMall</b>
            <span>Marketplace</span>
          </div>
        </a>

        <div class="spacer"></div>

        <div class="pillbar">
          <button class="iconbtn" id="btnWishlist" title="Sevimlilar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 21s-7-4.4-9.2-8.6C1 9 3 6.5 6 6.2c1.7-.2 3.1.5 4 1.7.9-1.2 2.3-1.9 4-1.7 3 .3 5 2.8 3.2 6.2C19 16.6 12 21 12 21Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
            <span class="badge" id="wishCount">0</span>
          </button>

          <button class="iconbtn" id="btnCart" title="Savatcha">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M6 6h15l-1.5 8.5H8L6 6Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
              <path d="M6 6 5 3H2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M9 20a1 1 0 1 0 0-2 1 1 0 0 0 0 2ZM18 20a1 1 0 1 0 0-2 1 1 0 0 0 0 2Z" fill="currentColor"/>
            </svg>
            <span class="badge" id="cartCount">0</span>
          </button>

          <button class="userchip" id="btnUser" title="Telegram orqali kirish">
            <div class="avatar" id="ava">O</div>
            <div class="meta">
              <b id="uname">Mehmon</b>
              <span id="uemail">Telegram login</span>
            </div>
          </button>
        </div>
      </div>

      <div class="chipsbar-wrap">
        <div class="chipbar" id="catChips" aria-label="Kategoriyalar">
          <!-- chips -->
        </div>
      </div>
    </div>
  </header>

  <!-- Body: only products -->
  <main class="container">
    <div class="grid" id="grid" aria-live="polite"></div>
  </main>

  <!-- Overlay -->
  <div class="overlay" id="overlay" aria-hidden="true"></div>

  <!-- Cart drawer -->
  <aside class="drawer" id="cartDrawer" aria-hidden="true">
    <div class="dhead">
      <b>üõí Savatcha</b>
      <button class="xbtn" data-close aria-label="Yopish">‚úï</button>
    </div>
    <div class="dbody" id="cartBody"></div>
  </aside>

  <!-- Wishlist drawer -->
  <aside class="drawer" id="wishDrawer" aria-hidden="true">
    <div class="dhead">
      <b>‚ù§ Sevimlilar</b>
      <button class="xbtn" data-close aria-label="Yopish">‚úï</button>
    </div>
    <div class="dbody" id="wishBody"></div>
  </aside>

  <!-- User drawer -->
  <aside class="drawer" id="userDrawer" aria-hidden="true">
    <div class="dhead">
      <b>üë§ Telegram login</b>
      <button class="xbtn" data-close aria-label="Yopish">‚úï</button>
    </div>
    <div class="dbody">
      <div class="tgwrap">
        <div class="tip">
          Telegram orqali kirish <b>login widget</b> bilan ishlaydi.
          <br><br>
          <b>Muhim:</b> pastdagi <code>TG_BOT_USERNAME</code> ni o'zingizning bot username'ga almashtiring (masalan: <code>OrzuMallLoginBot</code>).
        </div>

        <div id="tgWidget"></div>

        <button class="btnlite danger hidden" id="btnLogout">üö™ Chiqish</button>
      </div>
    </div>
  </aside>

  <!-- Firebase (Firestore) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    // =========================
    // CONFIG
    // =========================
    const TG_BOT_USERNAME = "YOUR_BOT_USERNAME"; // <-- shu yerga bot username
    const LS = {
      cart: 'orzumall_cart_v1',
      wish: 'orzumall_wish_v1',
      lastCat: 'orzumall_last_cat_v1',
      tgUser: 'orzumall_tg_user_v1'
    };

    const firebaseConfig = {
      apiKey: "AIzaSyADOv69HBuAJkaYs2Ukgab-VgqkJIv1Cro",
      authDomain: "orzumall.firebaseapp.com",
      projectId: "orzumall",
      storageBucket: "orzumall.firebasestorage.app",
      messagingSenderId: "873732887270",
      appId: "1:873732887270:web:15b73dbb37f4fdabe8a127",
      measurementId: "G-2LEH8YWPLF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const state = {
      user: null,            // Telegram user object
      categories: [],
      products: [],
      view: [],
      activeCat: '',
      cart: {}, // id -> {id, qty, snap}
      wish: {}  // id -> true
    };

    const $ = (id)=>document.getElementById(id);

    // =========================
    // Local storage
    // =========================
    function loadLocal(){
      try{ state.cart = JSON.parse(localStorage.getItem(LS.cart) || "{}") || {}; }catch(e){ state.cart = {}; }
      try{ state.wish = JSON.parse(localStorage.getItem(LS.wish) || "{}") || {}; }catch(e){ state.wish = {}; }
      const c = localStorage.getItem(LS.lastCat);
      if(c) state.activeCat = c;

      try{
        const u = JSON.parse(localStorage.getItem(LS.tgUser) || "null");
        if(u && u.id) state.user = u;
      }catch(e){}
    }
    function saveLocal(){
      localStorage.setItem(LS.cart, JSON.stringify(state.cart || {}));
      localStorage.setItem(LS.wish, JSON.stringify(state.wish || {}));
      localStorage.setItem(LS.lastCat, state.activeCat || '');
      syncBadges();
    }

    function cartCount(){ return Object.values(state.cart).reduce((a,it)=>a + (Number(it.qty)||0), 0); }
    function wishCount(){ return Object.keys(state.wish||{}).length; }
    function syncBadges(){
      $('cartCount').textContent = String(cartCount());
      $('wishCount').textContent = String(wishCount());
    }

    // =========================
    // Overlay / drawers
    // =========================
    function openDrawer(id){
      $('overlay').classList.add('show');
      $('overlay').setAttribute('aria-hidden','false');
      $(id).classList.add('show');
      $(id).setAttribute('aria-hidden','false');
    }
    function closeAll(){
      $('overlay').classList.remove('show');
      $('overlay').setAttribute('aria-hidden','true');
      ['cartDrawer','wishDrawer','userDrawer'].forEach(id=>{
        $(id).classList.remove('show');
        $(id).setAttribute('aria-hidden','true');
      });
    }

    // =========================
    // Helpers
    // =========================
    function escapeHtml(s) {
      return String(s||'').replace(/[&<>"']/g, (m)=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }
    function fmtMoney(v){
      const n = Number(v||0);
      return n.toLocaleString('uz-UZ') + " so'm";
    }

    // =========================
    // Chips
    // =========================
    function renderChips(){
      const el = $('catChips');
      el.innerHTML = '';

      const all = document.createElement('div');
      all.className = 'chip' + (!state.activeCat ? ' active' : '');
      all.textContent = 'üåê Barchasi';
      all.onclick = ()=>{ state.activeCat=''; localStorage.setItem(LS.lastCat,''); applyAll(); };
      el.appendChild(all);

      state.categories.forEach(c=>{
        const chip = document.createElement('div');
        chip.className = 'chip' + (state.activeCat===c.id ? ' active' : '');
        chip.textContent = (c.emoji ? (c.emoji+' ') : 'üè∑Ô∏è ') + (c.name || c.id);
        chip.onclick = ()=>{
          state.activeCat = c.id;
          localStorage.setItem(LS.lastCat, c.id);
          applyAll();
        };
        el.appendChild(chip);
      });
    }

    // =========================
    // Products
    // =========================
    function renderSkeletons(n=10){
      const g = $('grid');
      g.innerHTML = '';
      for(let i=0;i<n;i++) {
        const d = document.createElement('div');
        d.className = 'p';
        d.innerHTML = `
          <div class="img"><div class="ph" aria-hidden="true"></div></div>
          <div class="body">
            <div class="title" style="opacity:.35">Yuklanmoqda‚Ä¶</div>
            <div class="row">
              <div class="price" style="opacity:.3">‚Äî</div>
              <div class="cta" style="opacity:.25">üõí</div>
            </div>
          </div>
        `;
        g.appendChild(d);
      }
    }

    function applyAll(){
      let arr = (state.products || []).slice();

      if(state.activeCat){
        arr = arr.filter(p => (p.categoryId === state.activeCat) || (p.categoryName === state.activeCat));
      }

      // Default: faqat faol + omborda bor (agar status/stock field bo'lsa)
      arr = arr.filter(p => {
        const status = String(p.status || 'active');
        return status === 'active';
      });

      state.view = arr;
      renderProducts();
      renderChips();
    }

    function renderProducts(){
      const g = $('grid');
      const arr = state.view || [];
      if(!arr.length){
        g.innerHTML = `
          <div class="p" style="grid-column: 1 / -1;">
            <div class="body">
              <div class="title">Hech narsa topilmadi</div>
              <div style="color:var(--muted); font-size:12px; line-height:1.6">Boshqa kategoriya tanlang.</div>
            </div>
          </div>
        `;
        return;
      }

      g.innerHTML = '';
      arr.forEach(p=>{
        const id = p.id;
        const img = p.image || p.imageUrl || '';
        const isW = !!state.wish[id];

        const card = document.createElement('div');
        card.className = 'p';

        card.innerHTML = `
          <div class="img">
            ${img ? `<img loading="lazy" src="${img}" alt="">` : `<div class="ph" aria-hidden="true"></div>`}
            <button class="heart ${isW?'active':''}" title="Sevimlilar" data-heart="${id}">${isW?'‚ù§':'‚ô°'}</button>
          </div>
          <div class="body">
            <div class="title">${escapeHtml(p.name||'‚Äî')}</div>
            <div class="row">
              <div class="price">${fmtMoney(p.price||0)}</div>
              <button class="cta" data-add="${id}" title="Savatchaga">üõí</button>
            </div>
          </div>
        `;
        g.appendChild(card);
      });
    }

    // =========================
    // Cart / Wish
    // =========================
    function addToCart(id, qty=1){
      const p = state.products.find(x=>x.id===id);
      if(!p) return;
      const cur = state.cart[id]?.qty || 0;
      state.cart[id] = { id, qty: Math.max(1, cur + qty), snap: { name: p.name||id, price: Number(p.price||0), image: p.image||'' } };
      saveLocal();
      renderCart();
    }
    function setQty(id, qty){
      qty = Number(qty||0);
      if(qty <= 0){ delete state.cart[id]; saveLocal(); renderCart(); return; }
      if(!state.cart[id]) return;
      state.cart[id].qty = qty;
      saveLocal();
      renderCart();
    }
    function toggleWish(id){
      if(state.wish[id]) delete state.wish[id];
      else state.wish[id] = true;
      saveLocal();
      renderWish();
      applyAll(); // refresh hearts
    }

    function renderCart(){
      const body = $('cartBody');
      const ids = Object.keys(state.cart||{});
      if(!ids.length){
        body.innerHTML = `<div class="desc"><b>Savatcha bo'sh</b><br><span style="color:var(--muted)">Mahsulot qo'shing.</span></div>`;
        return;
      }
      let total = 0;
      body.innerHTML = ids.map(id=>{
        const it = state.cart[id];
        const p = it.snap || {};
        const qty = Number(it.qty||0);
        const price = Number(p.price||0);
        total += qty * price;
        const img = p.image || '';
        return `
          <div class="desc" style="display:flex; gap:12px; align-items:flex-start; margin-bottom:10px">
            <div style="width:56px;height:56px;border-radius:16px;overflow:hidden;border:1px solid rgba(18,25,38,.10);background:#fff;flex:0 0 auto;display:grid;place-items:center">
              ${img ? `<img src="${img}" style="width:100%;height:100%;object-fit:cover" alt="">` : `<div style="width:30px;height:30px;border-radius:12px;background:rgba(106,13,173,.14)"></div>`}
            </div>
            <div style="flex:1">
              <b>${escapeHtml(p.name||id)}</b>
              <div style="margin-top:6px; color:var(--muted); font-size:12px">${fmtMoney(price)} √ó <b>${qty}</b></div>
              <div style="margin-top:10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap">
                <button class="iconbtn" data-dec="${id}" title="-">‚àí</button>
                <input value="${qty}" data-qty="${id}" inputmode="numeric" style="width:84px;height:40px;border-radius:14px;border:1px solid rgba(18,25,38,.10);padding:0 10px;background:rgba(255,255,255,.86)">
                <button class="iconbtn" data-inc="${id}" title="+">+</button>
                <button class="iconbtn" data-del="${id}" title="O'chirish">üóëÔ∏è</button>
              </div>
            </div>
            <div style="text-align:right">
              <div style="font-size:12px; color:var(--muted)">Jami</div>
              <div style="margin-top:6px; font-weight:950">${fmtMoney(qty*price)}</div>
            </div>
          </div>
        `;
      }).join('') + `
        <div class="desc"><b>Umumiy:</b> ${fmtMoney(total)}</div>
      `;
    }

    function renderWish(){
      const body = $('wishBody');
      const ids = Object.keys(state.wish||{});
      if(!ids.length){
        body.innerHTML = `<div class="desc"><b>Sevimlilar bo'sh</b><br><span style="color:var(--muted)">Mahsulotdagi ‚ù§ ni bosing.</span></div>`;
        return;
      }
      body.innerHTML = ids.map(id=>{
        const p = state.products.find(x=>x.id===id);
        if(!p) return '';
        const img = p.image || '';
        return `
          <div class="desc" style="display:flex; gap:12px; align-items:center; margin-bottom:10px">
            <div style="width:56px;height:56px;border-radius:16px;overflow:hidden;border:1px solid rgba(18,25,38,.10);background:#fff;flex:0 0 auto;display:grid;place-items:center">
              ${img ? `<img src="${img}" style="width:100%;height:100%;object-fit:cover" alt="">` : `<div style="width:30px;height:30px;border-radius:12px;background:rgba(106,13,173,.14)"></div>`}
            </div>
            <div style="flex:1">
              <b>${escapeHtml(p.name||id)}</b>
              <div style="margin-top:6px; color:var(--muted); font-size:12px">${fmtMoney(p.price||0)}</div>
            </div>
            <button class="iconbtn" data-w2c="${id}" title="Savatchaga">üõí</button>
            <button class="iconbtn" data-wdel="${id}" title="O'chirish">üóëÔ∏è</button>
          </div>
        `;
      }).join('');
    }

    // =========================
    // Telegram login widget
    // =========================
    function setUserChipTG(user){
      if(!user){
        $('uname').textContent = 'Mehmon';
        $('uemail').textContent = 'Telegram login';
        $('ava').innerHTML = 'O';
        $('btnLogout').classList.add('hidden');
        return;
      }
      const name = (user.first_name || '') + (user.last_name ? (' ' + user.last_name) : '');
      $('uname').textContent = (name || user.username || 'User').trim();
      $('uemail').textContent = user.username ? '@' + user.username : ('id: ' + user.id);
      if(user.photo_url){
        $('ava').innerHTML = `<img src="${user.photo_url}" alt="">`;
      } else {
        const letter = (name || user.username || 'U').trim()[0].toUpperCase();
        $('ava').textContent = letter;
      }
      $('btnLogout').classList.remove('hidden');
    }

    // Telegram widget callback (called by widget)
    window.onTelegramAuth = function(user){
      try{
        state.user = user;
        localStorage.setItem(LS.tgUser, JSON.stringify(user));
        setUserChipTG(user);
        closeAll();
      }catch(e){ console.error(e); }
    }

    function renderTelegramWidget(){
      const host = $('tgWidget');
      host.innerHTML = '';
      if(!TG_BOT_USERNAME || TG_BOT_USERNAME === '@OrzuMallUZ_bot'){
        host.innerHTML = `<div class="desc"><b>Bot username kerak</b><br><span style="color:var(--muted)">Kodda <code>TG_BOT_USERNAME</code> ni bot username'ga almashtiring.</span></div>`;
        return;
      }
      const s = document.createElement('script');
      s.async = true;
      s.src = "https://telegram.org/js/telegram-widget.js?22";
      s.setAttribute('data-telegram-login', TG_BOT_USERNAME);
      s.setAttribute('data-size', 'large');
      s.setAttribute('data-radius', '12');
      s.setAttribute('data-userpic', 'false');
      s.setAttribute('data-request-access', 'write');
      s.setAttribute('data-onauth', 'onTelegramAuth(user)');
      host.appendChild(s);
    }

    function logoutTG(){
      state.user = null;
      localStorage.removeItem(LS.tgUser);
      setUserChipTG(null);
      closeAll();
    }

    // =========================
    // Firestore attach
    // =========================
    function attachStore(){
      db.collection('configs').doc('store').onSnapshot(s=>{
        if(!s.exists) return;
        const d = s.data() || {};
        $('storeNameTop').textContent = d.name || 'OrzuMall';
      });
    }
    function attachCategories(){
      db.collection('categories').orderBy('name').onSnapshot(s=>{
        const arr = [];
        s.forEach(doc=> arr.push({ id: doc.id, ...(doc.data()||{}) }));
        state.categories = arr;
        renderChips();
      });
    }
    function attachProducts(){
      renderSkeletons(10);
      db.collection('products').orderBy('updatedAt','desc').limit(200).onSnapshot(s=>{
        const arr = [];
        s.forEach(doc=> arr.push({ id: doc.id, ...(doc.data()||{}) }));
        state.products = arr;
        applyAll();
      }, (err)=>{
        console.error(err);
        $('grid').innerHTML = `
          <div class="p" style="grid-column:1/-1;">
            <div class="body">
              <div class="title">Xatolik</div>
              <div style="color:var(--muted); font-size:12px; line-height:1.6">
                Mahsulotlar yuklanmadi. Firestore rules yoki internetni tekshiring.
              </div>
            </div>
          </div>
        `;
      });
    }

    // =========================
    // Bindings
    // =========================
    function bindUI(){
      $('overlay').onclick = closeAll;
      document.body.addEventListener('click', (e)=>{
        const close = e.target.closest('[data-close]');
        if(close) closeAll();

        const add = e.target.closest('[data-add]');
        if(add){ e.preventDefault(); addToCart(add.getAttribute('data-add'), 1); }

        const heart = e.target.closest('[data-heart]');
        if(heart){ e.preventDefault(); toggleWish(heart.getAttribute('data-heart')); }

        const dec = e.target.closest('[data-dec]');
        if(dec) setQty(dec.getAttribute('data-dec'), (state.cart[dec.getAttribute('data-dec')]?.qty||0)-1);

        const inc = e.target.closest('[data-inc]');
        if(inc) setQty(inc.getAttribute('data-inc'), (state.cart[inc.getAttribute('data-inc')]?.qty||0)+1);

        const del = e.target.closest('[data-del]');
        if(del){ delete state.cart[del.getAttribute('data-del')]; saveLocal(); renderCart(); }

        const w2c = e.target.closest('[data-w2c]');
        if(w2c) addToCart(w2c.getAttribute('data-w2c'), 1);

        const wdel = e.target.closest('[data-wdel]');
        if(wdel){ delete state.wish[wdel.getAttribute('data-wdel')]; saveLocal(); renderWish(); applyAll(); }
      });

      $('btnCart').onclick = ()=>{ renderCart(); openDrawer('cartDrawer'); };
      $('btnWishlist').onclick = ()=>{ renderWish(); openDrawer('wishDrawer'); };
      $('btnUser').onclick = ()=>{ renderTelegramWidget(); openDrawer('userDrawer'); };
      $('btnLogout').onclick = logoutTG;

      // qty inputs
      document.body.addEventListener('input', (e)=>{
        const q = e.target.closest('[data-qty]');
        if(!q) return;
        const id = q.getAttribute('data-qty');
        const v = Number(String(q.value||'').replace(/\D/g,''));
        if(!Number.isFinite(v)) return;
        setQty(id, v);
      });
    }

    // =========================
    // Init
    // =========================
    (function init(){
      loadLocal();
      bindUI();
      syncBadges();
      setUserChipTG(state.user);
      attachStore();
      attachCategories();
      attachProducts();
    })();
  </script>
</body>
</html>
