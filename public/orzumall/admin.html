<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OrzuMall Admin ‚Äî Products</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1b33; --muted:#9db0d0; --text:#eaf1ff;
      --accent:#2E8B57; --danger:#ff4d4d; --line:rgba(255,255,255,.08);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;
      color:var(--text); background:
        radial-gradient(900px 400px at 10% -10%, rgba(46,139,87,.35), transparent 60%),
        radial-gradient(800px 500px at 110% 0%, rgba(0,122,255,.22), transparent 55%),
        linear-gradient(180deg, #050a14, #0b1220 45%, #070d18);
      min-height:100vh;
    }
    .wrap{max-width:1200px; margin:0 auto; padding:22px 16px 40px;}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 16px; background:rgba(255,255,255,.06);
      border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      position:sticky; top:10px; z-index:10;
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, rgba(46,139,87,.9), rgba(0,122,255,.55));
      display:grid; place-items:center; box-shadow:0 10px 22px rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.14);
      font-weight:900;
    }
    .title{line-height:1.1}
    .title b{display:block; font-size:14px; letter-spacing:.3px}
    .title small{color:var(--muted); font-size:12px}
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .chip{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px; border-radius:999px;
      background:rgba(0,0,0,.25); border:1px solid var(--line);
      color:var(--text);
    }
    .btn{
      border:none; cursor:pointer;
      padding:10px 12px; border-radius:12px;
      background:rgba(255,255,255,.10); color:var(--text);
      border:1px solid var(--line);
      box-shadow:0 10px 18px rgba(0,0,0,.25);
      transition:.18s transform ease, .18s background ease;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.14)}
    .btn.primary{background:rgba(46,139,87,.28); border-color:rgba(46,139,87,.55)}
    .btn.primary:hover{background:rgba(46,139,87,.35)}
    .btn.danger{background:rgba(255,77,77,.12); border-color:rgba(255,77,77,.35)}
    .grid{
      display:grid; grid-template-columns: 1.05fr .95fr;
      gap:14px; margin-top:14px;
    }
    @media(max-width: 980px){ .grid{grid-template-columns:1fr} .top{position:static} }
    .card{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .card h3{
      margin:0; padding:14px 16px;
      border-bottom:1px solid var(--line);
      font-size:14px; letter-spacing:.2px;
      display:flex; justify-content:space-between; align-items:center;
    }
    .card h3 span{color:var(--muted); font-weight:600; font-size:12px}
    .card .body{padding:14px 16px;}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, textarea, select{
      width:100%;
      padding:11px 12px; border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:100px; resize:vertical}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media(max-width:560px){ .row{grid-template-columns:1fr} }
    .help{color:var(--muted); font-size:12px; margin-top:6px}
    .imgRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .thumb{
      width:84px; height:84px; border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      overflow:hidden; position:relative;
    }
    .thumb img{width:100%; height:100%; object-fit:cover; display:block}
    .thumb button{
      position:absolute; top:6px; right:6px;
      width:26px; height:26px; border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.45); color:#fff; cursor:pointer;
    }
    .list{display:flex; flex-direction:column; gap:10px;}
    .item{
      padding:12px; border-radius:16px;
      background:rgba(0,0,0,.20);
      border:1px solid var(--line);
      display:grid;
      grid-template-columns: 64px 1fr auto;
      gap:12px; align-items:center;
    }
    .item .cover{
      width:64px; height:64px; border-radius:16px;
      background:rgba(255,255,255,.07);
      border:1px solid var(--line);
      overflow:hidden;
    }
    .item .cover img{width:100%; height:100%; object-fit:cover}
    .meta b{display:block; font-size:13px}
    .meta small{color:var(--muted); font-size:12px}
    .pill{
      display:inline-flex; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.08);
      font-size:12px; color:var(--muted);
      margin-top:6px;
    }
    .item .right{display:flex; gap:8px; align-items:center}
    .muted{color:var(--muted)}
    .notice{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.18);
      background:rgba(0,0,0,.18);
      color:var(--muted);
      font-size:12px;
    }
    .bar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">OM</div>
        <div class="title">
          <b>OrzuMall Admin</b>
          <small>Products (Firestore + Storage)</small>
        </div>
      </div>
      <div class="actions">
        <div class="chip" id="userChip">üîí Not logged</div>
        <button class="btn primary" id="btnLogin">Google bilan kirish</button>
        <button class="btn" id="btnLogout" style="display:none">Chiqish</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>üß© Mahsulot formasi <span id="editHint">Yangi mahsulot</span></h3>
        <div class="body">
          <div class="row">
            <div>
              <label>Nomi</label>
              <input id="title" placeholder="Masalan: AirPods Pro 2" />
            </div>
            <div>
              <label>Status</label>
              <select id="status">
                <option value="active">active (ko‚Äòrinadi)</option>
                <option value="hidden">hidden (yashirin)</option>
                <option value="draft">draft (qoralama)</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Narx</label>
              <input id="price" type="number" min="0" step="0.01" placeholder="799" />
            </div>
            <div>
              <label>Eski narx (ixtiyoriy)</label>
              <input id="oldPrice" type="number" min="0" step="0.01" placeholder="899" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>Valyuta</label>
              <select id="currency">
                <option value="UZS">UZS</option>
                <option value="USD">USD</option>
              </select>
            </div>
            <div>
              <label>Kategoriya</label>
              <select id="categoryId"></select>
              <div class="help">Kategoriyalar ‚ÄúKatalog sozlamalari‚Äùdan boshqariladi.</div>
            </div>
          </div>

          <label>Taglar (vergul bilan)</label>
          <input id="tags" placeholder="apple, iphone, pro" />

          <label>Tavsif</label>
          <textarea id="desc" placeholder="Qisqa tavsif..."></textarea>

          <label>Rasmlar (Storage)</label>
          <div class="bar">
            <input id="images" type="file" accept="image/*" multiple />
            <button class="btn" id="btnUpload">üì§ Upload</button>
            <span class="muted" id="uploadInfo"></span>
          </div>
          <div class="imgRow" id="imgRow"></div>

          <div class="bar" style="margin-top:14px">
            <button class="btn primary" id="btnSave">üíæ Saqlash</button>
            <button class="btn" id="btnNew">‚ûï Yangi</button>
            <button class="btn danger" id="btnDelete" style="display:none">üóë O‚Äòchirish</button>
            <span class="muted" id="saveInfo"></span>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>üì¶ Mahsulotlar <span id="countHint">0 ta</span></h3>
        <div class="body">
          <div class="bar" style="margin-bottom:10px">
            <input id="q" placeholder="Qidirish (nom/tag)..." />
            <select id="filterStatus" style="max-width:200px">
              <option value="all">Hammasi</option>
              <option value="active">active</option>
              <option value="hidden">hidden</option>
              <option value="draft">draft</option>
            </select>
          </div>
          <div class="list" id="list"></div>

          <div class="card" style="margin-top:14px">
            <h3>‚öôÔ∏è Katalog sozlamalari <span>meta/config</span></h3>
            <div class="body">
              <label>Kategoriyalar (JSON array)</label>
              <textarea id="categoriesJson" placeholder='[{"id":"phones","title":"Telefonlar"}]'></textarea>
              <div class="bar" style="margin-top:10px">
                <button class="btn primary" id="btnSaveMeta">üíæ Saqlash</button>
                <span class="muted" id="metaInfo"></span>
              </div>
              <div class="help">Index sahifada filter chips shundan chiqadi.</div>
            </div>
          </div>

          <div class="notice">
            Agar upload xato bersa: Storage bucket nomini Firebase Console ‚Üí Storage‚Äôda tekshiring.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ========= Firebase config (SIZNIKI) =========
    const firebaseConfig = {
      apiKey: "AIzaSyCR70LukxyWkPJb7ax-Y-GPmX8xRqSKbEM",
      authDomain: "orzumall-cc4b1.firebaseapp.com",
      projectId: "orzumall-cc4b1",
      storageBucket: "orzumall-cc4b1.firebasestorage.app",
      messagingSenderId: "850677820319",
      appId: "1:850677820319:web:6d7b8150b459f28d6a6baa",
      measurementId: "G-FFN26SDTMS"
    };

    // ========= Admin emails =========
    const ADMIN_EMAILS = new Set([
      "sohibjonmath@gmail.com"
    ]);

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, collection, addDoc, updateDoc, deleteDoc,
      onSnapshot, query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const $ = (id) => document.getElementById(id);
    const userChip = $("userChip");
    const btnLogin = $("btnLogin");
    const btnLogout = $("btnLogout");

    const titleEl = $("title");
    const statusEl = $("status");
    const priceEl = $("price");
    const oldPriceEl = $("oldPrice");
    const currencyEl = $("currency");
    const categoryEl = $("categoryId");
    const tagsEl = $("tags");
    const descEl = $("desc");
    const imagesEl = $("images");
    const imgRow = $("imgRow");

    const btnUpload = $("btnUpload");
    const uploadInfo = $("uploadInfo");

    const btnSave = $("btnSave");
    const btnNew = $("btnNew");
    const btnDelete = $("btnDelete");
    const saveInfo = $("saveInfo");
    const editHint = $("editHint");

    const listEl = $("list");
    const qEl = $("q");
    const filterStatusEl = $("filterStatus");
    const countHint = $("countHint");

    const categoriesJsonEl = $("categoriesJson");
    const btnSaveMeta = $("btnSaveMeta");
    const metaInfo = $("metaInfo");

    let currentUser = null;
    let editingId = null;
    let imageUrls = [];
    let coverUrl = "";

    function normalizeTokens(str){
      return (str || "")
        .toLowerCase()
        .replace(/['"`]/g,"")
        .replace(/[^a-z0-9\u0400-\u04FF\u0600-\u06FF\u0590-\u05FF\u0100-\u017F\s-]/g, " ")
        .split(/\s+/)
        .filter(Boolean)
        .slice(0, 30);
    }
    function tagsFromInput(val){
      return (val||"")
        .split(",")
        .map(s=>s.trim().toLowerCase())
        .filter(Boolean)
        .slice(0, 20);
    }
    function money(v){
      if(v === null || v === undefined || v === "") return "";
      const n = Number(v);
      if(Number.isNaN(n)) return "";
      return n.toLocaleString("uz-UZ");
    }
    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function renderThumbs(){
      imgRow.innerHTML = "";
      imageUrls.forEach((url, idx)=>{
        const d = document.createElement("div");
        d.className = "thumb";
        d.innerHTML = `
          <img src="${url}" alt="img"/>
          <button title="O‚Äòchirish">‚úï</button>
        `;
        d.querySelector("button").onclick = ()=>{
          imageUrls.splice(idx,1);
          if(coverUrl === url) coverUrl = imageUrls[0] || "";
          renderThumbs();
        };
        imgRow.appendChild(d);
      });
    }
    function resetForm(){
      editingId = null;
      titleEl.value = "";
      statusEl.value = "active";
      priceEl.value = "";
      oldPriceEl.value = "";
      currencyEl.value = "UZS";
      tagsEl.value = "";
      descEl.value = "";
      imageUrls = [];
      coverUrl = "";
      renderThumbs();
      btnDelete.style.display = "none";
      editHint.textContent = "Yangi mahsulot";
      saveInfo.textContent = "";
    }
    async function ensureAdmin(){
      if(!currentUser) throw new Error("Login qiling.");
      const email = (currentUser.email || "").toLowerCase();
      if(!ADMIN_EMAILS.has(email)) throw new Error("Siz admin emassiz.");
    }

    btnLogin.onclick = async ()=>{
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    };
    btnLogout.onclick = async ()=>{ await signOut(auth); };

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user || null;
      const isAdmin = !!(user && ADMIN_EMAILS.has((user.email||"").toLowerCase()));
      if(user){
        userChip.textContent = `${isAdmin ? "‚úÖ Admin" : "‚ö†Ô∏è Not admin"} ‚Äî ${user.email}`;
        btnLogin.style.display = "none";
        btnLogout.style.display = "";
      }else{
        userChip.textContent = "üîí Not logged";
        btnLogin.style.display = "";
        btnLogout.style.display = "none";
      }
      await loadMetaConfig();
      subscribeProducts();
    });

    async function loadMetaConfig(){
      const refDoc = doc(db, "meta", "config");
      const snap = await getDoc(refDoc);
      let cats = [];
      if(snap.exists()){
        const d = snap.data();
        cats = Array.isArray(d.categories) ? d.categories : [];
        categoriesJsonEl.value = JSON.stringify(cats, null, 2);
      } else {
        cats = [{id:"phones", title:"Telefonlar"}];
        categoriesJsonEl.value = JSON.stringify(cats, null, 2);
      }
      categoryEl.innerHTML = "";
      cats.forEach(c=>{
        const opt = document.createElement("option");
        opt.value = String(c.id||"");
        opt.textContent = String(c.title||c.id||"");
        categoryEl.appendChild(opt);
      });
    }

    btnSaveMeta.onclick = async ()=>{
      try{
        await ensureAdmin();
        const arr = JSON.parse(categoriesJsonEl.value || "[]");
        if(!Array.isArray(arr)) throw new Error("JSON array bo‚Äòlishi kerak.");
        const categories = arr
          .map(x=>({ id:String(x.id||"").trim(), title:String(x.title||"").trim() }))
          .filter(x=>x.id && x.title)
          .slice(0, 100);

        await setDoc(doc(db, "meta", "config"), {
          categories,
          updatedAt: serverTimestamp()
        }, { merge:true });

        metaInfo.textContent = "‚úÖ Saqlandi";
        await loadMetaConfig();
        setTimeout(()=>metaInfo.textContent="", 1500);
      }catch(e){
        metaInfo.textContent = "‚ùå " + (e.message || e);
      }
    };

    btnUpload.onclick = async ()=>{
      try{
        await ensureAdmin();
        const files = Array.from(imagesEl.files || []);
        if(!files.length) throw new Error("Rasm tanlang.");
        uploadInfo.textContent = "Yuklanmoqda...";

        for(const f of files){
          const safeName = f.name.replace(/[^a-zA-Z0-9._-]/g,"_");
          const path = `products/${Date.now()}_${Math.random().toString(16).slice(2)}_${safeName}`;
          const r = ref(storage, path);
          await uploadBytes(r, f, { contentType: f.type || "image/*" });
          const url = await getDownloadURL(r);
          imageUrls.push(url);
        }
        if(!coverUrl) coverUrl = imageUrls[0] || "";
        renderThumbs();
        uploadInfo.textContent = "‚úÖ Upload tayyor";
        imagesEl.value = "";
        setTimeout(()=>uploadInfo.textContent="", 1500);
      }catch(e){
        uploadInfo.textContent = "‚ùå " + (e.message || e);
      }
    };

    btnSave.onclick = async ()=>{
      try{
        await ensureAdmin();
        const title = titleEl.value.trim();
        if(!title) throw new Error("Nomi kerak.");
        const price = Number(priceEl.value);
        if(!Number.isFinite(price) || price < 0) throw new Error("Narx noto‚Äòg‚Äòri.");
        const oldPriceRaw = oldPriceEl.value.trim();
        const oldPrice = oldPriceRaw ? Number(oldPriceRaw) : null;
        if(oldPriceRaw && (!Number.isFinite(oldPrice) || oldPrice < 0)) throw new Error("Eski narx noto‚Äòg‚Äòri.");

        const categoryId = categoryEl.value || "";
        const status = statusEl.value || "active";
        const currency = currencyEl.value || "UZS";
        const tags = tagsFromInput(tagsEl.value);
        const desc = descEl.value.trim();

        const tokens = Array.from(new Set([
          ...normalizeTokens(title),
          ...normalizeTokens(tags.join(" ")),
          ...normalizeTokens(categoryId),
        ])).slice(0, 40);

        const payload = {
          title, price,
          oldPrice: oldPrice ?? null,
          currency, categoryId, tags, desc, status,
          coverUrl: coverUrl || imageUrls[0] || "",
          imageUrls: imageUrls.slice(0, 12),
          searchTokens: tokens,
          updatedAt: serverTimestamp()
        };

        if(!payload.coverUrl) throw new Error("Kamida 1 ta rasm yuklang (cover).");

        if(editingId){
          await updateDoc(doc(db, "products", editingId), payload);
          saveInfo.textContent = "‚úÖ Yangilandi";
        }else{
          payload.createdAt = serverTimestamp();
          const refDoc = await addDoc(collection(db, "products"), payload);
          editingId = refDoc.id;
          btnDelete.style.display = "";
          editHint.textContent = "Tahrirlash: " + editingId.slice(0,8) + "‚Ä¶";
          saveInfo.textContent = "‚úÖ Saqlandi";
        }
        setTimeout(()=>saveInfo.textContent="", 1500);
      }catch(e){
        saveInfo.textContent = "‚ùå " + (e.message || e);
      }
    };

    btnNew.onclick = ()=> resetForm();

    btnDelete.onclick = async ()=>{
      try{
        await ensureAdmin();
        if(!editingId) return;
        await deleteDoc(doc(db, "products", editingId));
        resetForm();
        saveInfo.textContent = "‚úÖ O‚Äòchirildi";
        setTimeout(()=>saveInfo.textContent="", 1500);
      }catch(e){
        saveInfo.textContent = "‚ùå " + (e.message || e);
      }
    };

    let unsubscribe = null;
    let allProducts = [];

    function subscribeProducts(){
      if(unsubscribe) unsubscribe();
      const qy = query(collection(db, "products"), orderBy("updatedAt", "desc"));
      unsubscribe = onSnapshot(qy, (snap)=>{
        allProducts = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        renderList();
      });
    }

    function matches(p, q){
      if(!q) return true;
      const s = q.toLowerCase();
      return (
        (p.title||"").toLowerCase().includes(s) ||
        (p.tags||[]).some(t=>String(t).toLowerCase().includes(s)) ||
        (p.categoryId||"").toLowerCase().includes(s)
      );
    }

    function loadToForm(p){
      editingId = p.id;
      titleEl.value = p.title || "";
      statusEl.value = p.status || "active";
      priceEl.value = p.price ?? "";
      oldPriceEl.value = p.oldPrice ?? "";
      currencyEl.value = p.currency || "UZS";
      categoryEl.value = p.categoryId || (categoryEl.options[0]?.value || "");
      tagsEl.value = (p.tags || []).join(", ");
      descEl.value = p.desc || "";
      imageUrls = Array.isArray(p.imageUrls) ? [...p.imageUrls] : [];
      coverUrl = p.coverUrl || imageUrls[0] || "";
      btnDelete.style.display = "";
      editHint.textContent = "Tahrirlash: " + p.id.slice(0,8) + "‚Ä¶";
      renderThumbs();
      window.scrollTo({top:0, behavior:"smooth"});
    }

    function renderList(){
      const qv = (qEl.value||"").trim();
      const st = filterStatusEl.value;
      const rows = allProducts
        .filter(p => st==="all" ? true : (p.status===st))
        .filter(p => matches(p, qv));

      countHint.textContent = rows.length + " ta";
      listEl.innerHTML = "";

      rows.slice(0, 200).forEach(p=>{
        const div = document.createElement("div");
        div.className = "item";
        const cover = p.coverUrl || (p.imageUrls && p.imageUrls[0]) || "";
        div.innerHTML = `
          <div class="cover">${cover ? `<img src="${cover}" />` : ""}</div>
          <div class="meta">
            <b>${escapeHtml(p.title || "")}</b>
            <small>${escapeHtml(p.categoryId || "")} ‚Ä¢ ${escapeHtml(p.status || "")}</small>
            <div class="pill">${money(p.price)} ${escapeHtml(p.currency || "UZS")}${p.oldPrice ? `  ¬∑  <span style="text-decoration:line-through; opacity:.7">${money(p.oldPrice)}</span>` : ""}</div>
          </div>
          <div class="right">
            <button class="btn" data-act="edit">‚úèÔ∏è</button>
          </div>
        `;
        div.querySelector('[data-act="edit"]').onclick = ()=> loadToForm(p);
        listEl.appendChild(div);
      });
    }

    qEl.addEventListener("input", renderList);
    filterStatusEl.addEventListener("change", renderList);

    resetForm();
  </script>
</body>
</html>
