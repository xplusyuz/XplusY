<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OrzuMall ‚Äî Admin Panel (Real)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#4361ee; --secondary:#3a0ca3; --success:#4cc9f0; --danger:#f72585;
      --warning:#ffbe0b; --info:#7209b7; --light:#f8f9fa; --dark:#212529;
      --sidebar:#2d3748; --sidebar-hover:#4a5568;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif;}
    body{display:flex;background:#f5f7fb;color:var(--dark);min-height:100vh;overflow-x:hidden;}
    .sidebar{width:250px;background:var(--sidebar);color:#fff;height:100vh;position:fixed;padding:20px 0;transition:.3s;}
    .sidebar-header{padding:0 20px 30px;text-align:center;border-bottom:1px solid rgba(255,255,255,.1);}
    .sidebar-header h2{font-size:1.5rem;color:var(--success);}
    .sidebar-menu{list-style:none;padding:20px 0;}
    .sidebar-menu li{margin-bottom:5px;}
    .sidebar-menu a{display:flex;align-items:center;padding:15px 20px;color:#b0b7c3;text-decoration:none;transition:.3s;}
    .sidebar-menu a:hover,.sidebar-menu a.active{background:var(--sidebar-hover);color:#fff;border-left:4px solid var(--primary);}
    .sidebar-menu i{margin-right:10px;width:20px;text-align:center;}
    .main-content{flex:1;margin-left:250px;padding:20px;transition:.3s;}
    .top-nav{display:flex;justify-content:space-between;align-items:center;background:#fff;padding:15px 25px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.05);margin-bottom:30px;}
    .top-nav h1{font-size:1.8rem;color:var(--primary);}
    .user-info{display:flex;align-items:center;gap:15px;}
    .user-avatar{width:40px;height:40px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;}
    .logout-btn{background:var(--danger);color:#fff;border:none;padding:8px 15px;border-radius:5px;cursor:pointer;font-weight:500;}
    .dashboard-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-bottom:30px;}
    .card{background:#fff;border-radius:10px;padding:25px;box-shadow:0 2px 10px rgba(0,0,0,.05);transition:transform .3s;}
    .card:hover{transform:translateY(-5px);}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;}
    .card-icon{width:50px;height:50px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:#fff;}
    .card-icon.products{background:var(--primary);}
    .card-icon.orders{background:var(--success);}
    .card-icon.users{background:var(--warning);color:#222;}
    .card-icon.revenue{background:var(--danger);}
    .card h3{font-size:2rem;margin-bottom:5px;}
    .card p{color:#6c757d;font-size:.9rem;}
    .section{background:#fff;border-radius:10px;padding:25px;box-shadow:0 2px 10px rgba(0,0,0,.05);margin-bottom:30px;}
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:12px;}
    .section-title{font-size:1.5rem;color:var(--dark);}
    .btn{padding:10px 20px;border:none;border-radius:5px;cursor:pointer;font-weight:500;transition:.3s;}
    .btn-primary{background:var(--primary);color:#fff;}
    .btn-success{background:var(--success);color:#0b2230;}
    .btn-danger{background:var(--danger);color:#fff;}
    .btn-warning{background:var(--warning);color:#222;}
    .btn-sm{padding:5px 10px;font-size:.8rem;}
    .btn:hover{opacity:.92;}
    table{width:100%;border-collapse:collapse;}
    thead{background:#f8f9fa;}
    th,td{padding:15px;text-align:left;border-bottom:1px solid #eaeaea;vertical-align:middle;}
    th{font-weight:600;color:var(--dark);}
    .status{padding:5px 10px;border-radius:20px;font-size:.8rem;font-weight:500;display:inline-flex;align-items:center;gap:6px;}
    .status.active{background:rgba(76,201,240,.2);color:#1f8aa5;}
    .status.pending{background:rgba(255,190,11,.2);color:#a87400;}
    .status.completed{background:rgba(67,97,238,.2);color:#2b44b8;}
    .status.cancelled{background:rgba(247,37,133,.12);color:#c11d67;}
    .status.out_of_stock{background:rgba(108,117,125,.2);color:#6c757d;}
    .status.archived{background:rgba(33,37,41,.2);color:#495057;}
    .form-group{margin-bottom:20px;}
    label{display:block;margin-bottom:8px;font-weight:500;}
    input,select,textarea{width:100%;padding:12px 15px;border:1px solid #ddd;border-radius:5px;font-size:1rem;}
    textarea{min-height:120px;resize:vertical;}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:20px;}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center;}
    .modal.active{display:flex;}
    .modal-content{background:#fff;border-radius:10px;width:92%;max-width:700px;max-height:90vh;overflow:auto;}
    .modal-header{padding:20px 25px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;}
    .modal-body{padding:25px;}
    .modal-footer{padding:20px 25px;border-top:1px solid #eee;display:flex;justify-content:flex-end;gap:10px;}
    .close-modal{background:none;border:none;font-size:1.5rem;cursor:pointer;color:#6c757d;}
    .tabs{display:flex;border-bottom:1px solid #eaeaea;margin-bottom:20px;overflow:auto;}
    .tab{padding:15px 25px;cursor:pointer;border-bottom:3px solid transparent;transition:.3s;white-space:nowrap;}
    .tab.active{border-bottom-color:var(--primary);color:var(--primary);font-weight:500;}
    .tab-content{display:none;}
    .tab-content.active{display:block;}
    .auth-container{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;width:100vw;height:100vh;background:#f5f7fb;z-index:2000;padding:24px;}
    .auth-box{background:#fff;border-radius:10px;padding:36px;width:100%;max-width:420px;box-shadow:0 10px 30px rgba(0,0,0,.1);}
    .auth-box h2{text-align:center;margin-bottom:18px;color:var(--primary);}
    .auth-sub{margin:0 0 18px;text-align:center;color:#6c757d;font-size:.95rem;line-height:1.4;}
    .auth-row{display:flex;gap:10px;}
    .hint{margin-top:12px;color:#6c757d;font-size:.85rem;line-height:1.4;}
    .danger-text{color:var(--danger);}
    .tag{display:inline-block;background:#eef2ff;color:#4361ee;padding:2px 8px;border-radius:12px;font-size:.8rem;margin:2px;}
    
    /* Yangi: fayl tanlash uslublari */
    .file-input-container{display:flex;align-items:center;gap:10px;margin-top:5px;}
    .file-input{flex:1;}
    .file-input-btn{padding:8px 15px;background:var(--primary);color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:.9rem;}
    .file-preview{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
    .file-preview img{width:60px;height:60px;object-fit:cover;border-radius:6px;border:1px solid #ddd;}
    .path-hint{font-size:.85rem;color:#6c757d;margin-top:5px;}
    
    @media (max-width:992px){
      .sidebar{width:70px;}
      .sidebar-header h2,.sidebar-header p,.sidebar-menu span{display:none;}
      .sidebar-menu a{justify-content:center;padding:15px;}
      .sidebar-menu i{margin-right:0;font-size:1.2rem;}
      .main-content{margin-left:70px;}
    }
    @media (max-width:768px){
      .dashboard-cards{grid-template-columns:1fr;}
      .form-row{grid-template-columns:1fr;}
      .section-header{flex-direction:column;align-items:flex-start;}
    }
  </style>
</head>
<body>

  <!-- AUTH -->
  <div id="authScreen" class="auth-container">
    <div class="auth-box">
      <h2><i class="fas fa-shield-halved"></i> Admin Kirish</h2>
      <p class="auth-sub">
        Bu sahifa <b>faqat adminlar</b> uchun. Google orqali kiring yoki email/parol bilan kiring.
      </p>

      <button id="googleBtn" class="btn btn-primary" style="width:100%;padding:12px;">
        <i class="fa-brands fa-google"></i> Google bilan kirish
      </button>

      <div style="height:14px;"></div>

      <div class="form-group">
        <label for="loginEmail">Email</label>
        <input type="email" id="loginEmail" placeholder="admin@gmail.com">
      </div>
      <div class="form-group">
        <label for="loginPassword">Parol</label>
        <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>

      <div class="auth-row">
        <button id="loginBtn" class="btn btn-primary" style="flex:1;padding:12px;">Kirish</button>
        <button id="signupBtn" class="btn btn-warning" style="flex:1;padding:12px;">Ro'yxatdan o'tish</button>
      </div>

      <p id="loginError" class="danger-text" style="margin-top:14px;text-align:center;display:none;">
        Xatolik: kirish amalga oshmadi.
      </p>
      <p id="adminError" class="danger-text" style="margin-top:10px;text-align:center;display:none;">
        Siz admin emassiz. Ruxsat yo'q.
      </p>
      <p class="hint">
        ‚ö†Ô∏è Admin ro'yxati JS'da emas, Firestore'dagi <code>admins/{uid}</code> orqali tekshiriladi (xavfsiz).
      </p>
    </div>
  </div>

  <!-- PANEL -->
  <div id="adminPanel" style="display:none;width:100%;">
    <nav class="sidebar">
      <div class="sidebar-header">
        <h2><i class="fas fa-store"></i> OrzuMall</h2>
        <p>Admin Panel</p>
      </div>
      <ul class="sidebar-menu">
        <li><a href="#" class="active" data-tab="dashboard"><i class="fas fa-home"></i> <span>Boshqaruv paneli</span></a></li>
        <li><a href="#" data-tab="products"><i class="fas fa-box"></i> <span>Mahsulotlar</span></a></li>
        <li><a href="#" data-tab="categories"><i class="fas fa-list"></i> <span>Kategoriyalar</span></a></li>
        <li><a href="#" data-tab="orders"><i class="fas fa-shopping-cart"></i> <span>Buyurtmalar</span></a></li>
        <li><a href="#" data-tab="users"><i class="fas fa-users"></i> <span>Foydalanuvchilar</span></a></li>
        <li><a href="#" data-tab="settings"><i class="fas fa-cog"></i> <span>Sozlamalar</span></a></li>
      </ul>
    </nav>

    <main class="main-content">
      <div class="top-nav">
        <h1 id="pageTitle">Boshqaruv paneli</h1>
        <div class="user-info">
          <div id="userAvatar" class="user-avatar">A</div>
          <div>
            <p id="userName" style="font-weight:500;">Admin</p>
            <p id="userEmail" style="font-size:.8rem;color:#6c757d;">‚Äî</p>
          </div>
          <button id="logoutBtn" class="logout-btn"><i class="fas fa-right-from-bracket"></i> Chiqish</button>
        </div>
      </div>

      <!-- DASHBOARD -->
      <div id="dashboard" class="tab-content active">
        <div class="dashboard-cards">
          <div class="card">
            <div class="card-header">
              <div>
                <h3 id="totalProducts">0</h3>
                <p>Mahsulotlar</p>
              </div>
              <div class="card-icon products"><i class="fas fa-box"></i></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <div>
                <h3 id="totalOrders">0</h3>
                <p>Buyurtmalar</p>
              </div>
              <div class="card-icon orders"><i class="fas fa-shopping-cart"></i></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <div>
                <h3 id="totalUsers">0</h3>
                <p>Foydalanuvchilar</p>
              </div>
              <div class="card-icon users"><i class="fas fa-users"></i></div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <div>
                <h3 id="totalRevenue">0 so'm</h3>
                <p>Yakunlangan buyurtmalar (jami)</p>
              </div>
              <div class="card-icon revenue"><i class="fas fa-money-bill-wave"></i></div>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2 class="section-title">So'nggi buyurtmalar</h2>
            <button class="btn btn-primary" data-tab="orders">Barchasini ko'rish</button>
          </div>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Mijoz</th>
                <th>Vaqt</th>
                <th>Miqdor</th>
                <th>Holat</th>
                <th>Amallar</th>
              </tr>
            </thead>
            <tbody id="recentOrdersBody"></tbody>
          </table>
        </div>
      </div>

      <!-- PRODUCTS -->
      <div id="products" class="tab-content">
        <div class="section">
          <div class="section-header">
            <h2 class="section-title">Mahsulotlar boshqaruvi</h2>
            <button id="addProductBtn" class="btn btn-primary">Yangi mahsulot</button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Rasm</th>
                <th>Nomi & Filterlar</th>
                <th>Kategoriya</th>
                <th>Narx</th>
                <th>Soni</th>
                <th>Holat</th>
                <th>Amallar</th>
              </tr>
            </thead>
            <tbody id="productsTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- CATEGORIES -->
      <div id="categories" class="tab-content">
        <div class="section">
          <div class="section-header">
            <h2 class="section-title">Kategoriyalar boshqaruvi</h2>
            <button id="addCategoryBtn" class="btn btn-primary">Yangi kategoriya</button>
          </div>
          <div id="categoriesList"></div>
        </div>
      </div>

      <!-- ORDERS -->
      <div id="orders" class="tab-content">
        <div class="section">
          <div class="section-header">
            <h2 class="section-title">Buyurtmalar boshqaruvi</h2>
            <div>
              <select id="orderFilter" style="padding:8px 15px;border-radius:5px;border:1px solid #ddd;">
                <option value="all">Barcha buyurtmalar</option>
                <option value="pending">Kutilayotgan</option>
                <option value="processing">Jarayonda</option>
                <option value="completed">Yakunlangan</option>
                <option value="cancelled">Bekor qilingan</option>
              </select>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Mijoz</th>
                <th>Mahsulotlar</th>
                <th>Vaqt</th>
                <th>Miqdor</th>
                <th>Holat</th>
                <th>Amallar</th>
              </tr>
            </thead>
            <tbody id="ordersTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- USERS -->
      <div id="users" class="tab-content">
        <div class="section">
          <div class="section-header">
            <h2 class="section-title">Foydalanuvchilar</h2>
          </div>
          <table>
            <thead>
              <tr>
                <th>UID</th>
                <th>Ism</th>
                <th>Email</th>
                <th>Telefon</th>
                <th>Ro'yxatdan o'tgan</th>
                <th>Holat</th>
              </tr>
            </thead>
            <tbody id="usersTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- SETTINGS -->
      <div id="settings" class="tab-content">
        <div class="section">
          <h2 class="section-title">Admin sozlamalari</h2>
          <div class="tabs">
            <div class="tab active" data-settings-tab="general">Umumiy</div>
            <div class="tab" data-settings-tab="security">Xavfsizlik</div>
          </div>

          <div id="generalSettings" class="tab-content active">
            <div class="form-group">
              <label for="storeName">Do'kon nomi</label>
              <input type="text" id="storeName" value="OrzuMall">
            </div>
            <div class="form-group">
              <label for="storeEmail">Do'kon emaili</label>
              <input type="email" id="storeEmail" value="info@orzumall.uz">
            </div>
            <div class="form-group">
              <label for="storePhone">Do'kon telefoni</label>
              <input type="text" id="storePhone" value="+998 90 123 45 67">
            </div>
            <div class="form-group">
              <label for="storeAddress">Do'kon manzili</label>
              <textarea id="storeAddress">Toshkent shahar, Yunusobod tumani</textarea>
            </div>
            <button id="saveSettingsBtn" class="btn btn-primary">Saqlash</button>
            <p id="settingsSaved" style="display:none;margin-top:10px;color:#1f8aa5;">‚úÖ Saqlandi</p>
          </div>

          <div id="securitySettings" class="tab-content">
            <p class="hint">
              Bu loyiha Firestore rules orqali himoyalangan. Admin bo'lish uchun: <code>admins/{uid}</code> doc bo'lishi kerak.
            </p>
            <div class="form-group">
              <label for="newAdminUid">Yangi admin UID</label>
              <input type="text" id="newAdminUid" placeholder="Firebase Auth -> uid">
            </div>
            <div class="form-group">
              <label for="newAdminEmail">Yangi admin email</label>
              <input type="email" id="newAdminEmail" placeholder="admin@gmail.com">
            </div>
            <button id="addAdminBtn" class="btn btn-warning">Admin qo'shish</button>
            <p id="adminAdded" style="display:none;margin-top:10px;color:#1f8aa5;">‚úÖ Admin qo'shildi</p>
            <p class="hint">
              Eslatma: Birinchi adminni (bootstrap) Firebase Console'da qo'lda kiriting.
            </p>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- ADD PRODUCT MODAL -->
  <div id="addProductModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Yangi mahsulot</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="productName">Mahsulot nomi</label>
          <input type="text" id="productName" placeholder="Masalan: Redmi Note 13">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="productPrice">Narxi (so'm)</label>
            <input type="number" id="productPrice" placeholder="100000">
          </div>
          <div class="form-group">
            <label for="productStock">Ombordagi soni</label>
            <input type="number" id="productStock" placeholder="50">
          </div>
        </div>
        <div class="form-group">
          <label for="productCategory">Kategoriya</label>
          <select id="productCategory"></select>
          <p class="hint">Kategoriyalar <code>categories</code> kolleksiyasidan keladi.</p>
        </div>
        
        <!-- YANGI: Filter maydonlari -->
        <div class="form-row">
          <div class="form-group">
            <label for="productColor">Rang</label>
            <input type="text" id="productColor" placeholder="Masalan: Qora, Oq, Ko'k" list="colorSuggestions">
            <datalist id="colorSuggestions">
              <option>Qora</option>
              <option>Oq</option>
              <option>Kumush</option>
              <option>Ko'k</option>
              <option>Qizil</option>
              <option>Yashil</option>
              <option>Sariq</option>
              <option>Jigarrang</option>
              <option>Binafsha</option>
              <option>Pushti</option>
            </datalist>
          </div>
          <div class="form-group">
            <label for="productSize">O'lcham/Razmer</label>
            <input type="text" id="productSize" placeholder="Masalan: M, L, XL, 42, 10.5" list="sizeSuggestions">
            <datalist id="sizeSuggestions">
              <option>XS</option>
              <option>S</option>
              <option>M</option>
              <option>L</option>
              <option>XL</option>
              <option>XXL</option>
              <option>28</option>
              <option>30</option>
              <option>32</option>
              <option>34</option>
              <option>36</option>
              <option>38</option>
              <option>40</option>
              <option>42</option>
              <option>44</option>
            </datalist>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="productBrand">Brend</label>
            <input type="text" id="productBrand" placeholder="Masalan: Samsung, Nike, Apple">
          </div>
          <div class="form-group">
            <label for="productMaterial">Material</label>
            <input type="text" id="productMaterial" placeholder="Masalan: Paxta, Charm, Plastik">
          </div>
        </div>
        
        <div class="form-group">
          <label for="productWeight">Og'irlik (kg)</label>
          <input type="number" id="productWeight" placeholder="Masalan: 0.5" step="0.01">
        </div>
        
        <div class="form-group">
          <label for="productDescription">Tavsif</label>
          <textarea id="productDescription" placeholder="Mahsulot haqida batafsil"></textarea>
        </div>
        
        <!-- Yangi: Fayl tanlash qismi -->
        <div class="form-group">
          <label>Asosiy rasm (papka yo'li)</label>
          <div class="file-input-container">
            <input type="text" id="productImage" class="file-input" placeholder="/images/products/iphone.png">
            <button type="button" class="file-input-btn" onclick="selectImagePath('productImage', 'products')">
              <i class="fas fa-folder-open"></i> Tanlash
            </button>
          </div>
          <div class="file-preview" id="productImagePreview"></div>
          <p class="path-hint">
            üí° Misollar: <code>/images/products/iphone.png</code>, <code>/images/products/samsung-galaxy.jpg</code><br>
            Faylni tanlash orqali papka yo'lini o'zingiz kiritishingiz mumkin
          </p>
        </div>
        
        <!-- YANGI: Qo'shimcha rasm URL'lar -->
        <div class="form-group">
          <label for="productAdditionalImages">Qo'shimcha rasm URL'lar (ixtiyoriy)</label>
          <input type="text" id="productAdditionalImages" placeholder="/images/products/iphone1.jpg, /images/products/iphone2.jpg">
          <p class="hint">Vergul bilan ajratilgan bir nechta papka yo'llari</p>
        </div>
        
        <!-- YANGI: Filter xususiyatlari -->
        <div class="form-group">
          <label for="productFilters">Filter xususiyatlari (JSON formatida)</label>
          <textarea id="productFilters" placeholder='{"rang": "qora", "hajm": "1 litr", "kuch": "100W"}' rows="3"></textarea>
          <p class="hint">Qo'shimcha filterlar uchun JSON obyekti. Masalan: {"energiyaKlassi": "A++", "operativXotira": "8GB"}</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn close-modal">Bekor qilish</button>
        <button id="saveProductBtn" class="btn btn-primary">Saqlash</button>
      </div>
    </div>
  </div>

  <!-- EDIT PRODUCT MODAL (YANGI) -->
  <div id="editProductModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Mahsulotni tahrirlash</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body" id="editProductBody">
        <!-- Dynamic content from JS -->
      </div>
      <div class="modal-footer">
        <button class="btn close-modal">Bekor qilish</button>
        <button id="updateProductBtn" class="btn btn-primary">Yangilash</button>
      </div>
    </div>
  </div>

  <!-- ADD CATEGORY MODAL -->
  <div id="addCategoryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Yangi kategoriya</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="categoryName">Kategoriya nomi</label>
          <input type="text" id="categoryName" placeholder="Masalan: Elektronika">
        </div>
        <div class="form-group">
          <label for="categoryDescription">Kategoriya tavsifi</label>
          <textarea id="categoryDescription" placeholder="Qisqacha ma'lumot"></textarea>
        </div>
        <div class="form-group">
          <label>Kategoriya rasmi (papka yo'li)</label>
          <div class="file-input-container">
            <input type="text" id="categoryImage" class="file-input" placeholder="/images/categories/electronics.png">
            <button type="button" class="file-input-btn" onclick="selectImagePath('categoryImage', 'categories')">
              <i class="fas fa-folder-open"></i> Tanlash
            </button>
          </div>
          <div class="file-preview" id="categoryImagePreview"></div>
          <p class="path-hint">
            üí° Misol: <code>/images/categories/electronics.png</code><br>
            Faylni tanlash orqali papka yo'lini o'zingiz kiritishingiz mumkin
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn close-modal">Bekor qilish</button>
        <button id="saveCategoryBtn" class="btn btn-primary">Saqlash</button>
      </div>
    </div>
  </div>

  <!-- EDIT CATEGORY MODAL (YANGI) -->
  <div id="editCategoryModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Kategoriyani tahrirlash</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body" id="editCategoryBody">
        <!-- Dynamic content from JS -->
      </div>
      <div class="modal-footer">
        <button class="btn close-modal">Bekor qilish</button>
        <button id="updateCategoryBtn" class="btn btn-primary">Yangilash</button>
      </div>
    </div>
  </div>

  <!-- ORDER DETAILS MODAL -->
  <div id="orderDetailsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Buyurtma tafsilotlari</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="orderDetailsContent"></div>
      </div>
      <div class="modal-footer">
        <button class="btn close-modal">Yopish</button>
      </div>
    </div>
  </div>

  <!-- Firebase (v8 compat) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    // ===== Firebase config (siz bergan) =====
    const firebaseConfig = {
      apiKey: "AIzaSyADOv69HBuAJkaYs2Ukgab-VgqkJIv1Cro",
      authDomain: "orzumall.firebaseapp.com",
      projectId: "orzumall",
      storageBucket: "orzumall.firebasestorage.app",
      messagingSenderId: "873732887270",
      appId: "1:873732887270:web:15b73dbb37f4fdabe8a127",
      measurementId: "G-2LEH8YWPLF"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ===== DOM =====
    const authScreen = document.getElementById('authScreen');
    const adminPanel = document.getElementById('adminPanel');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const googleBtn = document.getElementById('googleBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const loginError = document.getElementById('loginError');
    const adminError = document.getElementById('adminError');

    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const userEmail = document.getElementById('userEmail');

    const pageTitle = document.getElementById('pageTitle');
    const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
    const tabContents = document.querySelectorAll('main .tab-content');

    const modals = document.querySelectorAll('.modal');
    const closeModalBtns = document.querySelectorAll('.close-modal');

    const addProductBtn = document.getElementById('addProductBtn');
    const addProductModal = document.getElementById('addProductModal');
    const saveProductBtn = document.getElementById('saveProductBtn');

    // category
    const addCategoryBtn = document.getElementById('addCategoryBtn');
    const addCategoryModal = document.getElementById('addCategoryModal');
    const saveCategoryBtn = document.getElementById('saveCategoryBtn');
    const editCategoryModal = document.getElementById('editCategoryModal');
    const updateCategoryBtn = document.getElementById('updateCategoryBtn');

    const orderDetailsModal = document.getElementById('orderDetailsModal');
    const orderDetailsContent = document.getElementById('orderDetailsContent');

    const productsTableBody = document.getElementById('productsTableBody');
    const recentOrdersBody = document.getElementById('recentOrdersBody');
    const ordersTableBody = document.getElementById('ordersTableBody');
    const usersTableBody = document.getElementById('usersTableBody');
    const categoriesList = document.getElementById('categoriesList');

    const totalProductsEl = document.getElementById('totalProducts');
    const totalOrdersEl = document.getElementById('totalOrders');
    const totalUsersEl = document.getElementById('totalUsers');
    const totalRevenueEl = document.getElementById('totalRevenue');

    const productCategorySelect = document.getElementById('productCategory');

    // Settings
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const settingsSaved = document.getElementById('settingsSaved');
    const addAdminBtn = document.getElementById('addAdminBtn');
    const adminAdded = document.getElementById('adminAdded');
    const newAdminUid = document.getElementById('newAdminUid');
    const newAdminEmail = document.getElementById('newAdminEmail');

    // ===== STATE =====
    let currentUser = null;
    let unsub = []; // unsubscribe functions
    let currentEditingCategoryId = null; // kategoriya tahrirlash uchun

    // ===== UTILS =====
    const fmtMoney = (n) => {
      try{
        const x = Number(n || 0);
        return x.toLocaleString('uz-UZ') + " so'm";
      }catch(e){ return "0 so'm"; }
    };

    const tsToText = (ts) => {
      if(!ts) return '‚Äî';
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString('uz-UZ');
    };

    const statusBadge = (status) => {
      const map = {
        pending: ['pending','Kutilayotgan','‚è≥'],
        processing: ['active','Jarayonda','‚öôÔ∏è'],
        completed: ['completed','Yakunlangan','‚úÖ'],
        cancelled: ['cancelled','Bekor qilingan','‚úñÔ∏è'],
        active: ['active','Faol','‚úÖ'],
        inactive: ['pending','Nofaol','‚õî'],
        out_of_stock: ['out_of_stock','Qolmagan','üì≠'],
        archived: ['archived','Arxivlangan','üóÑÔ∏è']
      };
      const [cls, label, icon] = map[status] || ['pending', String(status||'‚Äî'), '‚Ä¢'];
      return `<span class="status ${cls}">${icon} ${label}</span>`;
    };

    function clearSubs(){
      while(unsub.length){
        try{ unsub.pop()(); }catch(e){}
      }
    }

    function showAuth(){
      clearSubs();
      authScreen.style.display = 'flex';
      adminPanel.style.display = 'none';
      loginError.style.display = 'none';
      adminError.style.display = 'none';
    }

    function showPanel(){
      authScreen.style.display = 'none';
      adminPanel.style.display = 'block';
    }

    async function isAdmin(user){
      // Xavfsiz tekshiruv: Firestore'da admins/{uid} mavjud bo'lsa admin.
      const ref = db.collection('admins').doc(user.uid);
      const snap = await ref.get();
      return snap.exists;
    }

    function setTopUser(user){
      const letter = (user.displayName || user.email || 'A').trim()[0].toUpperCase();
      userAvatar.textContent = letter;
      userName.textContent = user.displayName || 'Admin';
      userEmail.textContent = user.email || '‚Äî';
    }

    // ===== FAYL TANLASH FUNKSIYASI =====
    function selectImagePath(inputId, folderType) {
      // Create a file input element
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      fileInput.style.display = 'none';
      
      fileInput.onchange = (e) => {
        if (e.target.files.length === 0) return;
        
        const file = e.target.files[0];
        const fileName = file.name.toLowerCase()
          .replace(/[^a-z0-9.]/g, '_')
          .replace(/_+/g, '_');
        
        // Determine folder based on type
        let folder = 'products';
        if (folderType === 'categories') folder = 'categories';
        
        // Construct the path
        const imagePath = `/images/${folder}/${fileName}`;
        
        // Set the value in the input field
        document.getElementById(inputId).value = imagePath;
        
        // Show preview
        const previewContainer = document.getElementById(inputId + 'Preview');
        if (previewContainer) {
          // Create a preview using FileReader
          const reader = new FileReader();
          reader.onload = (e) => {
            previewContainer.innerHTML = `
              <img src="${e.target.result}" alt="Preview" style="max-width:100px;max-height:100px;">
              <div style="font-size:0.8rem;color:#666;">${fileName}</div>
            `;
          };
          reader.readAsDataURL(file);
        }
        
        // Clean up
        document.body.removeChild(fileInput);
      };
      
      document.body.appendChild(fileInput);
      fileInput.click();
    }

    // ===== AUTH ACTIONS =====
    async function loginEmailPass(){
      const email = loginEmail.value.trim();
      const password = loginPassword.value;
      loginError.style.display = 'none';
      adminError.style.display = 'none';
      try{
        const cred = await auth.signInWithEmailAndPassword(email, password);
        currentUser = cred.user;
      }catch(err){
        console.error(err);
        loginError.textContent = 'Xatolik: email yoki parol noto\'g\'ri (yoki user yo\'q).';
        loginError.style.display = 'block';
      }
    }

    async function signupEmailPass(){
      const email = loginEmail.value.trim();
      const password = loginPassword.value;
      loginError.style.display = 'none';
      adminError.style.display = 'none';
      if(password.length < 6){
        loginError.textContent = 'Parol kamida 6 ta belgidan iborat bo\'lsin.';
        loginError.style.display = 'block';
        return;
      }
      try{
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        currentUser = cred.user;
      }catch(err){
        console.error(err);
        loginError.textContent = 'Xatolik: ro\'yxatdan o\'tib bo\'lmadi.';
        loginError.style.display = 'block';
      }
    }

    async function loginGoogle(){
      loginError.style.display = 'none';
      adminError.style.display = 'none';
      try{
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });
        const cred = await auth.signInWithPopup(provider);
        currentUser = cred.user;
      }catch(err){
        console.error(err);
        loginError.textContent = 'Xatolik: Google kirish ishlamadi.';
        loginError.style.display = 'block';
      }
    }

    async function logout(){
      await auth.signOut();
      currentUser = null;
      showAuth();
    }

    // ===== DATA LOADERS (REAL) =====
    function attachDashboard(){
      // Products count
      unsub.push(
        db.collection('products').onSnapshot(s => {
          totalProductsEl.textContent = String(s.size || 0);
        })
      );

      // Users count
      unsub.push(
        db.collection('users').onSnapshot(s => {
          totalUsersEl.textContent = String(s.size || 0);
        })
      );

      // Orders count + revenue
      unsub.push(
        db.collection('orders').onSnapshot(s => {
          totalOrdersEl.textContent = String(s.size || 0);
          let revenue = 0;
          s.forEach(doc => {
            const o = doc.data() || {};
            if(o.status === 'completed'){
              revenue += Number(o.totalAmount || o.amount || 0);
            }
          });
          totalRevenueEl.textContent = fmtMoney(revenue);
        })
      );

      // Recent orders (last 10)
      unsub.push(
        db.collection('orders').orderBy('createdAt','desc').limit(10).onSnapshot(s => {
          recentOrdersBody.innerHTML = '';
          if(s.empty){
            recentOrdersBody.innerHTML = `<tr><td colspan="6" style="color:#6c757d;">Hozircha buyurtma yo'q.</td></tr>`;
            return;
          }
          s.forEach(doc => {
            const o = doc.data() || {};
            const id = doc.id;
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${id}</td>
              <td>${(o.customerName || o.customer?.name || '‚Äî')}</td>
              <td>${tsToText(o.createdAt)}</td>
              <td>${fmtMoney(o.totalAmount || o.amount || 0)}</td>
              <td>${statusBadge(o.status || 'pending')}</td>
              <td>
                <button class="btn btn-sm btn-primary" data-view-order="${id}">Ko'rish</button>
              </td>
            `;
            recentOrdersBody.appendChild(tr);
          });
        })
      );
    }

    function attachCategories(){
      unsub.push(
        db.collection('categories').orderBy('name').onSnapshot(s => {
          categoriesList.innerHTML = '';
          productCategorySelect.innerHTML = '';
          if(s.empty){
            categoriesList.innerHTML = `<p style="color:#6c757d;">Kategoriyalar yo'q. Yangi kategoriya qo'shing.</p>`;
            productCategorySelect.innerHTML = `<option value="">(avval kategoriya qo'shing)</option>`;
            return;
          }
          s.forEach(doc => {
            const c = doc.data() || {};
            const id = doc.id;

            // list cards
            const card = document.createElement('div');
            card.className = 'card';
            card.style.marginBottom = '15px';
            card.innerHTML = `
              <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
                <div>
                  <h3 style="margin-bottom:5px;">${c.name || id}</h3>
                  <p style="color:#6c757d;margin-bottom:10px;">${c.description || ''}</p>
                  <p style="font-size:.9rem;color:#6c757d;">ID: <b>${id}</b></p>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
                  <button class="btn btn-sm btn-primary" data-edit-category="${id}">Tahrirlash</button>
                  <button class="btn btn-sm btn-danger" data-del-category="${id}">O'chirish</button>
                </div>
              </div>
            `;
            categoriesList.appendChild(card);

            // select options
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = c.name || id;
            productCategorySelect.appendChild(opt);
          });
        })
      );
    }

    function attachProducts(){
      unsub.push(
        db.collection('products').orderBy('createdAt','desc').limit(200).onSnapshot(s => {
          productsTableBody.innerHTML = '';
          if(s.empty){
            productsTableBody.innerHTML = `<tr><td colspan="7" style="color:#6c757d;">Mahsulot yo'q. "Yangi mahsulot" bosib qo'shing.</td></tr>`;
            return;
          }
          s.forEach(doc => {
            const p = doc.data() || {};
            const id = doc.id;
            const tr = document.createElement('tr');
            const img = p.image || p.imageUrl || '';
            
            // Filter xususiyatlari
            const filterTags = [];
            if(p.color) filterTags.push(`üé® ${p.color}`);
            if(p.size) filterTags.push(`üìè ${p.size}`);
            if(p.brand) filterTags.push(`üè∑Ô∏è ${p.brand}`);
            if(p.material) filterTags.push(`üßµ ${p.material}`);
            
            tr.innerHTML = `
              <td>${img ? `<img src="${img}" style="width:50px;height:50px;object-fit:cover;border-radius:6px;" title="Asosiy rasm">` : `<div style="width:50px;height:50px;border-radius:6px;background:#eef2ff;display:flex;align-items:center;justify-content:center;color:#6c757d;">üñºÔ∏è</div>`}</td>
              <td>
                <b>${p.name || '‚Äî'}</b>
                <div style="color:#6c757d;font-size:.85rem;">ID: ${id}</div>
                <div style="margin-top:4px;font-size:.8rem;display:flex;flex-wrap:wrap;gap:4px;">
                  ${filterTags.map(tag => `<span style="background:#eef2ff;padding:2px 6px;border-radius:10px;color:#4361ee;">${tag}</span>`).join('')}
                </div>
              </td>
              <td>${p.categoryName || p.categoryId || '‚Äî'}</td>
              <td>${fmtMoney(p.price)}</td>
              <td>${Number(p.stock || 0)}</td>
              <td>${statusBadge(p.status || (Number(p.stock||0)>0?'active':'inactive'))}</td>
              <td style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn btn-sm btn-primary" data-edit-product="${id}">Tahrirlash</button>
                <button class="btn btn-sm btn-danger" data-del-product="${id}">O'chirish</button>
              </td>
            `;
            productsTableBody.appendChild(tr);
          });
        })
      );
    }

    function attachOrders(filter){
      const ref = db.collection('orders').orderBy('createdAt','desc').limit(300);
      unsub.push(
        ref.onSnapshot(s => {
          const rows = [];
          s.forEach(doc => {
            const o = doc.data() || {};
            const id = doc.id;
            if(filter && filter !== 'all' && (o.status || 'pending') !== filter) return;
            const productsText = Array.isArray(o.items)
              ? o.items.map(it => `${it.title || it.name || 'item'} (${it.qty || 1})`).join(', ')
              : (o.productsText || '‚Äî');

            rows.push(`
              <tr>
                <td>${id}</td>
                <td>${(o.customerName || o.customer?.name || '‚Äî')}</td>
                <td>${productsText}</td>
                <td>${tsToText(o.createdAt)}</td>
                <td>${fmtMoney(o.totalAmount || o.amount || 0)}</td>
                <td>${statusBadge(o.status || 'pending')}</td>
                <td style="display:flex;gap:8px;flex-wrap:wrap;">
                  <button class="btn btn-sm btn-primary" data-view-order="${id}">Ko'rish</button>
                  <button class="btn btn-sm btn-success" data-set-order="${id}:processing">Qabul qilish</button>
                  <button class="btn btn-sm btn-warning" data-set-order="${id}:completed">Yakunlash</button>
                  <button class="btn btn-sm btn-danger" data-set-order="${id}:cancelled">Bekor qilish</button>
                </td>
              </tr>
            `);
          });

          ordersTableBody.innerHTML = rows.length
            ? rows.join('')
            : `<tr><td colspan="7" style="color:#6c757d;">Mos buyurtma topilmadi.</td></tr>`;
        })
      );
    }

    function attachUsers(){
      unsub.push(
        db.collection('users').orderBy('createdAt','desc').limit(200).onSnapshot(s => {
          usersTableBody.innerHTML = '';
          if(s.empty){
            usersTableBody.innerHTML = `<tr><td colspan="6" style="color:#6c757d;">Foydalanuvchilar yo'q.</td></tr>`;
            return;
          }
          s.forEach(doc => {
            const u = doc.data() || {};
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${doc.id}</td>
              <td>${u.name || u.displayName || '‚Äî'}</td>
              <td>${u.email || '‚Äî'}</td>
              <td>${u.phone || '‚Äî'}</td>
              <td>${tsToText(u.createdAt)}</td>
              <td>${statusBadge(u.status || 'active')}</td>
            `;
            usersTableBody.appendChild(tr);
          });
        })
      );
    }

    // ===== MAHSULOT TAFSILOTLARI =====
    async function saveProduct(){
      const name = document.getElementById('productName').value.trim();
      const price = Number(document.getElementById('productPrice').value || 0);
      const stock = Number(document.getElementById('productStock').value || 0);
      const categoryId = document.getElementById('productCategory').value;
      const description = document.getElementById('productDescription').value.trim();
      const image = document.getElementById('productImage').value.trim();
      const color = document.getElementById('productColor').value.trim();
      const size = document.getElementById('productSize').value.trim();
      const brand = document.getElementById('productBrand').value.trim();
      const material = document.getElementById('productMaterial').value.trim();
      const weight = parseFloat(document.getElementById('productWeight').value) || 0;
      const additionalImages = document.getElementById('productAdditionalImages').value.trim();
      const filtersJson = document.getElementById('productFilters').value.trim();

      if(!name || !price){
        alert("Iltimos, nomi va narxini kiriting.");
        return;
      }
      if(!categoryId){
        alert("Iltimos, kategoriyani tanlang (yoki avval kategoriya qo'shing).");
        return;
      }

      // category name
      const catSnap = await db.collection('categories').doc(categoryId).get();
      const categoryName = (catSnap.exists && (catSnap.data().name)) ? catSnap.data().name : categoryId;

      // Parse additional images
      let imagesArray = [];
      if(additionalImages){
        imagesArray = additionalImages.split(',').map(img => img.trim()).filter(img => img);
      }

      // Parse filters
      let filters = {};
      if(filtersJson){
        try{
          filters = JSON.parse(filtersJson);
        }catch(e){
          console.error("JSON parse error:", e);
          filters = {};
        }
      }

      const productData = {
        name,
        price,
        stock,
        categoryId,
        categoryName,
        description,
        image,
        color,
        size,
        brand,
        material,
        weight,
        additionalImages: imagesArray,
        filters,
        status: stock > 0 ? 'active' : 'inactive',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      await db.collection('products').add(productData);

      // Clear form
      addProductModal.classList.remove('active');
      document.querySelectorAll('#addProductModal input, #addProductModal textarea').forEach(el => {
        if(el.type !== 'button') el.value = '';
      });
      alert("‚úÖ Mahsulot saqlandi.");
    }

    // ===== MAHSULOTNI TAHRIRLASH =====
    async function editProduct(id){
      const snap = await db.collection('products').doc(id).get();
      if(!snap.exists){
        alert("Mahsulot topilmadi.");
        return;
      }
      
      const product = snap.data();
      const editModal = document.getElementById('editProductModal');
      const editBody = document.getElementById('editProductBody');
      
      // Yuklash kategoriyalar
      const categoriesSnap = await db.collection('categories').get();
      let categoryOptions = '';
      categoriesSnap.forEach(catDoc => {
        const cat = catDoc.data();
        const selected = product.categoryId === catDoc.id ? 'selected' : '';
        categoryOptions += `<option value="${catDoc.id}" ${selected}>${cat.name}</option>`;
      });
      
      // Parse filters to JSON string
      const filtersJson = product.filters ? JSON.stringify(product.filters, null, 2) : '';
      
      editBody.innerHTML = `
        <input type="hidden" id="editProductId" value="${id}">
        <div class="form-group">
          <label for="editProductName">Mahsulot nomi</label>
          <input type="text" id="editProductName" value="${product.name || ''}">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="editProductPrice">Narxi (so'm)</label>
            <input type="number" id="editProductPrice" value="${product.price || 0}">
          </div>
          <div class="form-group">
            <label for="editProductStock">Ombordagi soni</label>
            <input type="number" id="editProductStock" value="${product.stock || 0}">
          </div>
        </div>
        <div class="form-group">
          <label for="editProductCategory">Kategoriya</label>
          <select id="editProductCategory">${categoryOptions}</select>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="editProductColor">Rang</label>
            <input type="text" id="editProductColor" value="${product.color || ''}" list="colorSuggestions">
          </div>
          <div class="form-group">
            <label for="editProductSize">O'lcham/Razmer</label>
            <input type="text" id="editProductSize" value="${product.size || ''}" list="sizeSuggestions">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="editProductBrand">Brend</label>
            <input type="text" id="editProductBrand" value="${product.brand || ''}">
          </div>
          <div class="form-group">
            <label for="editProductMaterial">Material</label>
            <input type="text" id="editProductMaterial" value="${product.material || ''}">
          </div>
        </div>
        
        <div class="form-group">
          <label for="editProductWeight">Og'irlik (kg)</label>
          <input type="number" id="editProductWeight" value="${product.weight || 0}" step="0.01">
        </div>
        
        <div class="form-group">
          <label for="editProductDescription">Tavsif</label>
          <textarea id="editProductDescription" rows="4">${product.description || ''}</textarea>
        </div>
        
        <div class="form-group">
          <label>Asosiy rasm (papka yo'li)</label>
          <div class="file-input-container">
            <input type="text" id="editProductImage" class="file-input" value="${product.image || ''}" placeholder="/images/products/iphone.png">
            <button type="button" class="file-input-btn" onclick="selectImagePath('editProductImage', 'products')">
              <i class="fas fa-folder-open"></i> Tanlash
            </button>
          </div>
          <div class="file-preview" id="editProductImagePreview">
            ${product.image ? `<img src="${product.image}" alt="Preview" style="max-width:100px;max-height:100px;"><div style="font-size:0.8rem;color:#666;">Joriy rasm</div>` : ''}
          </div>
        </div>
        
        <div class="form-group">
          <label for="editProductAdditionalImages">Qo'shimcha rasm URL'lar</label>
          <input type="text" id="editProductAdditionalImages" value="${product.additionalImages ? product.additionalImages.join(', ') : ''}">
          <p class="hint">Vergul bilan ajratilgan bir nechta papka yo'llari</p>
        </div>
        
        <div class="form-group">
          <label for="editProductFilters">Filter xususiyatlari (JSON)</label>
          <textarea id="editProductFilters" rows="3">${filtersJson}</textarea>
          <p class="hint">Qo'shimcha filterlar uchun JSON obyekti</p>
        </div>
        
        <div class="form-group">
          <label for="editProductStatus">Holat</label>
          <select id="editProductStatus">
            <option value="active" ${product.status === 'active' ? 'selected' : ''}>Faol</option>
            <option value="inactive" ${product.status === 'inactive' ? 'selected' : ''}>Nofaol</option>
            <option value="out_of_stock" ${product.status === 'out_of_stock' ? 'selected' : ''}>Qolmagan</option>
            <option value="archived" ${product.status === 'archived' ? 'selected' : ''}>Arxivlangan</option>
          </select>
        </div>
      `;
      
      editModal.classList.add('active');
    }

    async function updateProduct(){
      const id = document.getElementById('editProductId').value;
      const name = document.getElementById('editProductName').value.trim();
      const price = Number(document.getElementById('editProductPrice').value || 0);
      const stock = Number(document.getElementById('editProductStock').value || 0);
      const categoryId = document.getElementById('editProductCategory').value;
      const description = document.getElementById('editProductDescription').value.trim();
      const image = document.getElementById('editProductImage').value.trim();
      const color = document.getElementById('editProductColor').value.trim();
      const size = document.getElementById('editProductSize').value.trim();
      const brand = document.getElementById('editProductBrand').value.trim();
      const material = document.getElementById('editProductMaterial').value.trim();
      const weight = parseFloat(document.getElementById('editProductWeight').value) || 0;
      const additionalImagesInput = document.getElementById('editProductAdditionalImages').value.trim();
      const filtersJson = document.getElementById('editProductFilters').value.trim();
      const status = document.getElementById('editProductStatus').value;

      if(!name || !price){
        alert("Iltimos, nomi va narxini kiriting.");
        return;
      }
      if(!categoryId){
        alert("Iltimos, kategoriyani tanlang.");
        return;
      }

      // category name
      const catSnap = await db.collection('categories').doc(categoryId).get();
      const categoryName = (catSnap.exists && (catSnap.data().name)) ? catSnap.data().name : categoryId;

      // Parse additional images
      let imagesArray = [];
      if(additionalImagesInput){
        imagesArray = additionalImagesInput.split(',').map(img => img.trim()).filter(img => img);
      }

      // Parse filters
      let filters = {};
      if(filtersJson){
        try{
          filters = JSON.parse(filtersJson);
        }catch(e){
          console.error("JSON parse error:", e);
          filters = {};
        }
      }

      const updateData = {
        name,
        price,
        stock,
        categoryId,
        categoryName,
        description,
        image,
        color,
        size,
        brand,
        material,
        weight,
        additionalImages: imagesArray,
        filters,
        status,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      await db.collection('products').doc(id).update(updateData);
      document.getElementById('editProductModal').classList.remove('active');
      alert("‚úÖ Mahsulot yangilandi.");
    }

    // ===== KATEGORIYANI TAHRIRLASH =====
    async function editCategory(id){
      currentEditingCategoryId = id;
      const snap = await db.collection('categories').doc(id).get();
      if(!snap.exists){
        alert("Kategoriya topilmadi.");
        return;
      }
      
      const category = snap.data();
      const editBody = document.getElementById('editCategoryBody');
      
      editBody.innerHTML = `
        <input type="hidden" id="editCategoryId" value="${id}">
        <div class="form-group">
          <label for="editCategoryName">Kategoriya nomi</label>
          <input type="text" id="editCategoryName" value="${category.name || ''}">
        </div>
        <div class="form-group">
          <label for="editCategoryDescription">Kategoriya tavsifi</label>
          <textarea id="editCategoryDescription" rows="3">${category.description || ''}</textarea>
        </div>
        <div class="form-group">
          <label>Kategoriya rasmi (papka yo'li)</label>
          <div class="file-input-container">
            <input type="text" id="editCategoryImage" class="file-input" value="${category.image || ''}" placeholder="/images/categories/electronics.png">
            <button type="button" class="file-input-btn" onclick="selectImagePath('editCategoryImage', 'categories')">
              <i class="fas fa-folder-open"></i> Tanlash
            </button>
          </div>
          <div class="file-preview" id="editCategoryImagePreview">
            ${category.image ? `<img src="${category.image}" alt="Preview" style="max-width:100px;max-height:100px;"><div style="font-size:0.8rem;color:#666;">Joriy rasm</div>` : ''}
          </div>
        </div>
      `;
      
      editCategoryModal.classList.add('active');
    }

    async function updateCategory(){
      const id = currentEditingCategoryId;
      const name = document.getElementById('editCategoryName').value.trim();
      const description = document.getElementById('editCategoryDescription').value.trim();
      const image = document.getElementById('editCategoryImage').value.trim();
      
      if(!name){
        alert("Kategoriya nomini kiriting.");
        return;
      }
      
      const updateData = {
        name,
        description,
        image: image || '',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      await db.collection('categories').doc(id).update(updateData);
      editCategoryModal.classList.remove('active');
      alert("‚úÖ Kategoriya yangilandi.");
    }

    async function saveCategory(){
      const name = document.getElementById('categoryName').value.trim();
      const description = document.getElementById('categoryDescription').value.trim();
      const image = document.getElementById('categoryImage').value.trim();
      if(!name){
        alert("Kategoriya nomini kiriting.");
        return;
      }
      // id = slug
      const id = name.toLowerCase()
        .replace(/[‚Äô'`"]/g,'')
        .replace(/[^a-z0-9\u0400-\u04FF\u0600-\u06FF]+/gi,'-')
        .replace(/^-+|-+$/g,'')
        .slice(0,60) || ('cat-' + Date.now());

      await db.collection('categories').doc(id).set({
        name, description, image,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });

      addCategoryModal.classList.remove('active');
      document.getElementById('categoryName').value = '';
      document.getElementById('categoryDescription').value = '';
      document.getElementById('categoryImage').value = '';
      alert("‚úÖ Kategoriya saqlandi.");
    }

    async function deleteDoc(col, id){
      if(!confirm("Haqiqatan o'chirasizmi?")) return;
      await db.collection(col).doc(id).delete();
    }

    async function setOrderStatus(id, status){
      await db.collection('orders').doc(id).set({
        status,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });
    }

    async function viewOrder(id){
      const snap = await db.collection('orders').doc(id).get();
      if(!snap.exists){
        alert("Buyurtma topilmadi.");
        return;
      }
      const o = snap.data() || {};
      const items = Array.isArray(o.items) ? o.items : [];
      const itemsHtml = items.length ? `
        <table style="width:100%;margin-top:10px;">
          <thead>
            <tr><th>Mahsulot</th><th>Soni</th><th>Narxi</th><th>Jami</th></tr>
          </thead>
          <tbody>
            ${items.map(it => {
              const qty = Number(it.qty || 1);
              const price = Number(it.price || 0);
              return `<tr>
                <td>${it.title || it.name || 'item'}</td>
                <td>${qty}</td>
                <td>${fmtMoney(price)}</td>
                <td>${fmtMoney(qty*price)}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      ` : `<p style="color:#6c757d;">items yo'q (order schema'da items[] tavsiya qilinadi).</p>`;

      orderDetailsContent.innerHTML = `
        <div>
          <h4>Buyurtma ID: ${id}</h4>
          <p><strong>Mijoz:</strong> ${o.customerName || o.customer?.name || '‚Äî'}</p>
          <p><strong>Telefon:</strong> ${o.customerPhone || o.customer?.phone || '‚Äî'}</p>
          <p><strong>Manzil:</strong> ${o.address || o.customer?.address || '‚Äî'}</p>
          <p><strong>Buyurtma vaqti:</strong> ${tsToText(o.createdAt)}</p>
          <p><strong>Holat:</strong> ${statusBadge(o.status || 'pending')}</p>
          <hr style="margin: 18px 0;">
          <p><strong>Umumiy:</strong> ${fmtMoney(o.totalAmount || o.amount || 0)}</p>
          ${itemsHtml}
        </div>
      `;
      orderDetailsModal.classList.add('active');
    }

    // SETTINGS save (configs/store)
    async function saveSettings(){
      const payload = {
        name: document.getElementById('storeName').value.trim(),
        email: document.getElementById('storeEmail').value.trim(),
        phone: document.getElementById('storePhone').value.trim(),
        address: document.getElementById('storeAddress').value.trim(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      await db.collection('configs').doc('store').set(payload, { merge:true });
      settingsSaved.style.display = 'block';
      setTimeout(()=> settingsSaved.style.display='none', 1500);
    }

    async function loadSettings(){
      const snap = await db.collection('configs').doc('store').get();
      if(!snap.exists) return;
      const s = snap.data() || {};
      if(s.name) document.getElementById('storeName').value = s.name;
      if(s.email) document.getElementById('storeEmail').value = s.email;
      if(s.phone) document.getElementById('storePhone').value = s.phone;
      if(s.address) document.getElementById('storeAddress').value = s.address;
    }

    async function addAdmin(){
      const uid = newAdminUid.value.trim();
      const email = newAdminEmail.value.trim();
      if(!uid){
        alert("UID kiriting.");
        return;
      }
      await db.collection('admins').doc(uid).set({
        email: email || null,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: currentUser.uid
      }, { merge:true });
      adminAdded.style.display = 'block';
      setTimeout(()=> adminAdded.style.display='none', 1500);
      newAdminUid.value = '';
      newAdminEmail.value = '';
    }

    // ===== NAV / MODALS =====
    function switchTab(tabId){
      tabContents.forEach(t => t.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
    }

    function bindUI(){
      // sidebar
      sidebarLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          sidebarLinks.forEach(l => l.classList.remove('active'));
          link.classList.add('active');
          const tabId = link.getAttribute('data-tab');
          pageTitle.textContent = link.querySelector('span')?.textContent || 'Admin';
          switchTab(tabId);

          // lazy attach
          if(tabId === 'products') attachProducts();
          if(tabId === 'categories') attachCategories();
          if(tabId === 'orders') attachOrders(document.getElementById('orderFilter').value);
          if(tabId === 'users') attachUsers();
          if(tabId === 'settings') loadSettings();
        });
      });

      // settings tabs
      const settingsTabs = document.querySelectorAll('.tab[data-settings-tab]');
      settingsTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const id = tab.getAttribute('data-settings-tab');
          settingsTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          const settingsContents = document.querySelectorAll('#settings .tab-content');
          settingsContents.forEach(c => c.classList.remove('active'));
          document.getElementById(id + 'Settings').classList.add('active');
        });
      });

      // modals close
      closeModalBtns.forEach(btn => btn.addEventListener('click', () => btn.closest('.modal').classList.remove('active')));
      modals.forEach(modal => modal.addEventListener('click', (e) => { if(e.target === modal) modal.classList.remove('active'); }));

      addProductBtn.addEventListener('click', () => addProductModal.classList.add('active'));
      saveProductBtn.addEventListener('click', saveProduct);

      addCategoryBtn.addEventListener('click', () => addCategoryModal.classList.add('active'));
      saveCategoryBtn.addEventListener('click', saveCategory);

      // Tahrirlash modalini ulash
      document.getElementById('updateProductBtn').addEventListener('click', updateProduct);
      document.getElementById('updateCategoryBtn').addEventListener('click', updateCategory);

      // filter orders
      document.getElementById('orderFilter').addEventListener('change', (e) => {
        attachOrders(e.target.value);
      });

      // auth buttons
      loginBtn.addEventListener('click', loginEmailPass);
      signupBtn.addEventListener('click', signupEmailPass);
      googleBtn.addEventListener('click', loginGoogle);
      logoutBtn.addEventListener('click', logout);

      // enter -> login
      loginPassword.addEventListener('keypress', (e) => { if(e.key === 'Enter') loginEmailPass(); });

      // dashboard / orders actions delegation
      document.body.addEventListener('click', async (e) => {
        const view = e.target.closest('[data-view-order]');
        if(view){
          const id = view.getAttribute('data-view-order');
          await viewOrder(id);
        }
        const setBtn = e.target.closest('[data-set-order]');
        if(setBtn){
          const raw = setBtn.getAttribute('data-set-order');
          const [id, status] = raw.split(':');
          await setOrderStatus(id, status);
        }
        const delProd = e.target.closest('[data-del-product]');
        if(delProd){
          await deleteDoc('products', delProd.getAttribute('data-del-product'));
        }
        const editProd = e.target.closest('[data-edit-product]');
        if(editProd){
          const id = editProd.getAttribute('data-edit-product');
          await editProduct(id);
        }
        const delCat = e.target.closest('[data-del-category]');
        if(delCat){
          await deleteDoc('categories', delCat.getAttribute('data-del-category'));
        }
        const editCat = e.target.closest('[data-edit-category]');
        if(editCat){
          const id = editCat.getAttribute('data-edit-category');
          await editCategory(id);
        }
      });

      saveSettingsBtn.addEventListener('click', saveSettings);
      addAdminBtn.addEventListener('click', addAdmin);
    }

    // ===== BOOT =====
    document.addEventListener('DOMContentLoaded', () => {
      bindUI();

      auth.onAuthStateChanged(async (user) => {
        if(!user){
          currentUser = null;
          showAuth();
          return;
        }

        // check admin
        try{
          const ok = await isAdmin(user);
          if(!ok){
            // Not admin -> sign out
            adminError.style.display = 'block';
            await auth.signOut();
            return;
          }

          currentUser = user;
          setTopUser(user);
          showPanel();

          // Attach only once (dashboard + categories select used in product modal)
          attachDashboard();
          attachCategories(); // so product modal has categories
          loadSettings();

        }catch(err){
          console.error(err);
          loginError.textContent = 'Xatolik: admin tekshiruvi ishlamadi.';
          loginError.style.display = 'block';
          await auth.signOut();
        }
      });
    });
  </script>
</body>
</html>