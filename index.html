<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MathCenter.uz — Xush kelibsiz</title>
  <meta name="theme-color" content="#0ecb63"/>
  <!-- Favicon: yashil, yoritilgan kvadrat ichida π (SVG data) -->
  <link rel="icon" type="image/svg+xml" href='data:image/svg+xml;utf8,
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 256">
    <defs>
      <radialGradient id="g" cx="50%" cy="35%" r="75%">
        <stop offset="0%" stop-color="#9fffd2"/>
        <stop offset="50%" stop-color="#2de38d"/>
        <stop offset="100%" stop-color="#0ea55a"/>
      </radialGradient>
      <filter id="glow"><feGaussianBlur stdDeviation="6" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
    </defs>
    <rect x="16" y="16" width="224" height="224" rx="32" fill="url(%23g)"/>
    <g filter="url(%23glow)">
      <path d="M76 92h104c9 0 16-7 16-16s-7-16-16-16H60c-9 0-16 7-16 16s7 16 16 16h4c8 41 4 77-8 97-5 8 5 17 13 12 24-14 35-53 29-109zm57 0c7 39 3 74-8 94-5 9 6 18 14 12 24-16 35-56 28-106h-34z" fill="white"/>
    </g>
  </svg>'/>

  <style>
    :root{
      --mc-green-1:#e9fff4;/* very light */
      --mc-green-2:#c8ffe6;
      --mc-green-3:#40e19a;/* accent */
      --mc-green-4:#14ba6e;/* brand */
      --mc-green-5:#0a8f52;/* deep */
      --mc-white:#ffffff;
      --mc-dark:#061b12;
      --radius:20px;
      --shadow-sm:0 4px 16px rgba(20,186,110,.15);
      --shadow:0 10px 30px rgba(20,186,110,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 600px at 20% -10%, var(--mc-green-2), transparent),
                  radial-gradient(1000px 500px at 120% 10%, #d9fff0, transparent),
                  linear-gradient(180deg, var(--mc-white), #f7fff9 60%);
      color:#0c2b1b;
      -webkit-font-smoothing: antialiased;
    }
    a{color:inherit; text-decoration:none}

    /* Splash */
    #splash{
      position:fixed; inset:0; display:grid; place-items:center; background:#fff; z-index:9999;
    }
    .logo-wrap{ display:flex; gap:16px; align-items:center; }
    .logo{
      width:72px; height:72px; border-radius:18px; background:radial-gradient(60% 60% at 50% 35%, #b9ffd9, #2de38d 55%, #0ea55a 100%);
      box-shadow:0 0 40px rgba(13,200,113,.55), inset 0 0 26px rgba(255,255,255,.6);
      display:grid; place-items:center; position:relative;
    }
    .logo:before{ content:""; position:absolute; inset:-10px; border-radius:22px; filter:blur(22px); background:linear-gradient(45deg, #2de38d33, #00ff8833); }
    .logo svg{ width:44px; height:44px; fill:#fff; filter:drop-shadow(0 6px 10px rgba(0,0,0,.15)); }
    .brand{ font-weight:800; font-size:28px; letter-spacing:.3px; text-transform:none; background:linear-gradient(180deg, #0aa95e, #0b7e49); -webkit-background-clip:text; color:transparent; }
    .tag{ font-size:14px; opacity:.75; margin-top:6px; }

    /* App shell */
    .shell{ display:flex; flex-direction:column; min-height:100vh; opacity:0; transition:opacity .4s ease; }
    header{
      position:sticky; top:0; z-index:50; backdrop-filter:saturate(160%) blur(8px);
      background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.65));
      border-bottom:1px solid #e9f8f0; box-shadow:var(--shadow-sm);
    }
    .header-inner{ max-width:1200px; margin:0 auto; padding:10px 16px; display:grid; gap:12px; align-items:center; }

    /* Desktop ≥ 900px: logo left, cards right */
    @media(min-width:900px){
      .header-inner{ grid-template-columns: 1fr auto; }
    }

    .brand-pack{ display:flex; align-items:center; gap:14px; }
    .title3d{
      padding:10px 14px; border-radius:16px; background:linear-gradient(145deg, #f7fffb, #dfffea);
      box-shadow: 0 12px 24px #b0f5d6, inset 0 -4px 10px rgba(255,255,255,.8);
      display:flex; align-items:center; gap:10px;
    }
    .title3d h1{ font-size:20px; margin:0; background:linear-gradient(180deg,#0dbb6f,#0a8f52); -webkit-background-clip:text; color:transparent; font-weight:900; letter-spacing:.4px; }

    /* Header cards */
    .stats{ display:grid; grid-auto-flow:column; gap:12px; }
    .card{
      background:linear-gradient(180deg,#ffffff,#f2fff9); border:1px solid #e8fbf1; border-radius:16px; padding:10px 12px; box-shadow:var(--shadow-sm);
      display:flex; align-items:center; gap:10px; min-height:52px;
    }
    .card .label{ font-size:12px; opacity:.6; }
    .card .value{ font-weight:800; font-size:14px; }

    /* Mobile layout: stack & ensure readability */
    @media(max-width:899px){
      .header-inner{ grid-template-columns: 1fr; }
      .stats{ grid-auto-flow:row; grid-template-columns:1fr; }
      .brand-pack{ justify-content:flex-start; }
      .title3d h1{ font-size:18px; }
    }

    main{ flex:1; max-width:1200px; margin:16px auto 100px; padding:0 16px; }
    #app{ min-height:300px; }

    /* Floating Touch Menu (only nav) */
    .fab{ position:fixed; right:16px; bottom:16px; z-index:60; }
    .fab-drag{ position:absolute; inset:0; cursor:grab; }
    .fab-btn{
      width:64px; height:64px; border-radius:22px; border:none; outline:none; display:grid; place-items:center; background:linear-gradient(180deg,#22e08f,#0faf64); box-shadow:0 14px 28px rgba(14,175,100,.35), inset 0 -6px 10px rgba(0,0,0,.1);
      color:#fff; font-weight:900; font-size:22px;
    }
    .fab-menu{
      position:absolute; right:76px; bottom:0; display:none; gap:8px; flex-wrap:wrap; width:min(78vw, 520px);
    }
    .fab.open .fab-menu{ display:flex; }
    .chip{
      padding:10px 14px; border-radius:16px; background:linear-gradient(145deg,#ffffff,#eafff5); border:1px solid #e4fbef; box-shadow:var(--shadow-sm);
      font-weight:700; font-size:14px; white-space:nowrap; user-select:none;
    }
    .chip:active{ transform:translateY(1px); }

    /* Modal */
    dialog{ border:none; padding:0; border-radius:20px; box-shadow:var(--shadow); width:min(560px, 92vw); }
    .modal{
      background:#fff; border-radius:20px; overflow:hidden; border:1px solid #e8fbf1;
    }
    .modal-head{ padding:16px 18px; background:linear-gradient(180deg,#f6fffb,#e8fff4); border-bottom:1px solid #e8fbf1; display:flex; align-items:center; gap:10px; }
    .modal-body{ padding:18px; }
    .modal h3{ margin:0; font-size:18px; }
    .row{ display:grid; gap:12px; grid-template-columns: 1fr 1fr; }
    .row-1{ display:grid; gap:12px; grid-template-columns: 1fr; }
    @media(max-width:600px){ .row{ grid-template-columns:1fr; } }
    label{ font-size:12px; opacity:.7; display:block; margin-bottom:6px; }
    input, select{ width:100%; padding:12px 12px; border-radius:14px; border:1px solid #dff7ea; background:#fbfffd; outline:none; box-shadow:inset 0 1px 2px rgba(0,0,0,.02); font-size:14px; }
    button.primary{ background:linear-gradient(180deg,#22e08f,#11b36a); color:#fff; border:none; padding:12px 16px; border-radius:14px; font-weight:800; box-shadow:0 10px 24px rgba(18,182,108,.3); }
    .hint{ font-size:12px; opacity:.7; }

    /* Cards in content */
    .content-card{ background:#fff; border:1px solid #e8fbf1; border-radius:20px; padding:16px; box-shadow:var(--shadow-sm); margin-bottom:16px; }
    .grid{ display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }

    /* Ghost link buttons (no underline) */
    .linkbtn{ border:none; background:transparent; font-weight:800; }

  </style>
</head>
<body>
  <!-- Splash (3s) -->
  <div id="splash">
    <div>
      <div class="logo-wrap">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg"><path d="M76 92h104c9 0 16-7 16-16s-7-16-16-16H60c-9 0-16 7-16 16s7 16 16 16h4c8 41 4 77-8 97-5 8 5 17 13 12 24-14 35-53 29-109zm57 0c7 39 3 74-8 94-5 9 6 18 14 12 24-16 35-56 28-106h-34z"/></svg>
        </div>
        <div>
          <div class="brand">MathCenter.uz</div>
          <div class="tag">Xush kelibsiz!</div>
        </div>
      </div>
    </div>
  </div>

  <div class="shell" id="shell" aria-hidden="true">
    <header>
      <div class="header-inner">
        <!-- Chap: 3D logo + 3D MathCenter.uz -->
        <div class="brand-pack">
          <div class="logo" style="width:56px;height:56px;border-radius:16px;">
            <svg viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg"><path d="M76 92h104c9 0 16-7 16-16s-7-16-16-16H60c-9 0-16 7-16 16s7 16 16 16h4c8 41 4 77-8 97-5 8 5 17 13 12 24-14 35-53 29-109zm57 0c7 39 3 74-8 94-5 9 6 18 14 12 24-16 35-56 28-106h-34z"/></svg>
          </div>
          <div class="title3d">
            <h1>MathCenter.uz</h1>
          </div>
        </div>

        <!-- O'ng: Salom, Name+Yosh + ID/Balans/Ball kartalari (desktopda bir qatorda, mobilda tagma-tag) -->
        <div class="stats" id="headerStats">
          <div class="card"><div>
            <div class="label">Salom</div>
            <div class="value" id="helloName">—</div>
            <div class="hint" id="helloAge">Yosh: —</div>
          </div></div>
          <div class="card"><div>
            <div class="label">ID</div>
            <div class="value" id="headerID">—</div>
          </div></div>
          <div class="card"><div>
            <div class="label">Balans</div>
            <div class="value" id="headerBalans">0</div>
          </div></div>
          <div class="card"><div>
            <div class="label">Ball</div>
            <div class="value" id="headerBall">0</div>
          </div></div>
        </div>
      </div>
    </header>

    <main>
      <div id="app"></div>
    </main>

    <!-- Floating Touch Menu (faqat nav) -->
    <div class="fab" id="fab">
      <button class="fab-btn" id="fabBtn" aria-label="Menyu">≡</button>
      <div class="fab-menu" id="fabMenu">
        <button class="chip" data-route="home">Bosh sahifa</button>
        <button class="chip" data-route="tests">Testlar</button>
        <button class="chip" data-route="live">Live</button>
        <button class="chip" data-route="profile">Profil</button>
        <button class="chip" data-route="settings">Sozlamalar</button>
        <button class="chip" id="logoutBtn">Chiqish</button>
      </div>
      <div class="fab-drag" title="Tortib joylashtiring"></div>
    </div>
  </div>

  <!-- Auth: Kirish (ID+Parol) -->
  <dialog id="loginDlg">
    <div class="modal">
      <div class="modal-head"><h3>Kirish</h3></div>
      <div class="modal-body">
        <div class="row-1">
          <div>
            <label>ID</label>
            <input id="loginId" type="number" placeholder="1001" inputmode="numeric"/>
          </div>
          <div>
            <label>Parol</label>
            <input id="loginPass" type="password" placeholder="••••••"/>
          </div>
          <button class="primary" id="doLogin">Kirish</button>
          <div class="hint">Hisob yo'qmi? <button class="linkbtn" id="openSignup">Ro'yxatdan o'tish</button></div>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Auth: Ro'yxatdan o'tish (email / Google / telefon), hammasida parol belgilash -->
  <dialog id="signupDlg">
    <div class="modal">
      <div class="modal-head"><h3>Ro'yxatdan o'tish</h3></div>
      <div class="modal-body">
        <div class="content-card">
          <div class="row">
            <div>
              <label>Email</label>
              <input id="suEmail" type="email" placeholder="email@namuna.uz"/>
            </div>
            <div>
              <label>Parol</label>
              <input id="suPass" type="password" placeholder="••••••"/>
            </div>
          </div>
          <div style="display:flex; gap:8px; margin-top:10px;">
            <button class="primary" id="signupEmail">Email bilan</button>
            <button class="primary" id="signupGoogle">Google</button>
            <button class="primary" id="signupPhone">Telefon</button>
          </div>
          <div class="hint">Barcha usullarda hisobingiz uchun parol ham o'rnatiladi.</div>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Profil majburiy to'ldirish -->
  <dialog id="profileDlg">
    <div class="modal">
      <div class="modal-head"><h3>Profil ma'lumotlari</h3></div>
      <div class="modal-body">
        <div class="row">
          <div>
            <label>Ism</label>
            <input id="pIsm" type="text" />
          </div>
          <div>
            <label>Familiya</label>
            <input id="pFam" type="text" />
          </div>
          <div>
            <label>Sharif</label>
            <input id="pSharif" type="text" />
          </div>
          <div>
            <label>Tug'ilgan sana</label>
            <input id="pTugilgan" type="date" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Telefon</label>
            <input id="pTelefon" type="tel" placeholder="+998..." />
          </div>
          <div>
            <label>Telegram link</label>
            <input id="pTelegram" type="url" placeholder="https://t.me/foydalanuvchi" />
          </div>
          <div>
            <label>Email</label>
            <input id="pEmail" type="email" />
          </div>
          <div>
            <label>Roli</label>
            <select id="pRol">
              <option value="oquvchi">O'quvchi</option>
              <option value="oqituvchi">O'qituvchi</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Viloyat</label>
            <select id="pViloyat"></select>
          </div>
          <div>
            <label>Tuman/Shahar</label>
            <select id="pTuman"></select>
          </div>
          <div class="row-1">
            <label>Maktab</label>
            <input id="pMaktab" type="text" placeholder="(ixtiyoriy) 54-maktab" />
          </div>
        </div>
        <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
          <button class="primary" id="saveProfile">Saqlash</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Templates (fallback for partials) -->
  <template id="tpl-home">
    <div class="content-card">
      <h2>Bosh sahifa</h2>
      <p>Bu sahifa <strong>partials/home.html</strong> dan yuklanadi (yoki fallback andoza).</p>
    </div>
    <div class="grid">
      <div class="content-card"><h3>Yangi testlar</h3><p>Algebra, Geometriya...</p></div>
      <div class="content-card"><h3>Reyting</h3><p>Top 10 o'quvchi</p></div>
      <div class="content-card"><h3>E'lonlar</h3><p>Yangiliklar...</p></div>
    </div>
  </template>
  <template id="tpl-tests">
    <div class="content-card">
      <h2>Testlar</h2>
      <p>Namuna testlar ro'yxati. (partials/tests.html)</p>
    </div>
  </template>
  <template id="tpl-live">
    <div class="content-card">
      <h2>Live</h2>
      <p>Jonli darslar va efirlar. (partials/live.html)</p>
    </div>
  </template>
  <template id="tpl-settings">
    <div class="content-card">
      <h2>Sozlamalar</h2>
      <p>Profil ko'rinishini sozlash, til: <strong>O'zbek</strong>.</p>
    </div>
  </template>
  <template id="tpl-profile-view">
    <div class="content-card" id="profileViewCard">
      <h2>Profil</h2>
      <div id="profileView"></div>
      <div class="hint">Profil ma'lumotlari tahrirlanmaydi.</div>
    </div>
  </template>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, updatePassword, signOut, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.appspot.com",
      messagingSenderId: "992512966017",
      appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId: "G-459PLJ7P7L"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ======= Regionlar va tumanlar (UZ) =======
    const UZ = {
      "Qoraqalpog'iston Respublikasi": ["Amudaryo", "Beruniy", "Chimboy", "Ellikqal'a", "Kegeyli", "Mo'ynoq", "Nukus sh.", "Nukus t.", "Qanliko'l", "Qo'ng'irot", "Qorao'zak", "Shumanay", "Taxtako'pir", "To'rtko'l", "Xo'jayli"],
      "Andijon": ["Andijon sh.","Andijon t.","Asaka","Baliqchi","Bo'z","Buloqboshi","Izboskan","Jalaquduq","Marhamat","Oltinko'l","Paxtaobod","Qo'rg'ontepa","Shahrixon","Ulug'nor","Xo'jaobod"] ,
      "Buxoro": ["Buxoro sh.","Buxoro t.","G'ijduvon","Jondor","Kogon sh.","Kogon t.","Olot","Peshku","Qorako'l","Qorovulbozor","Romitan","Shofirkon","Vobkent"],
      "Farg'ona": ["Farg'ona sh.","Farg'ona t.","Bag'dod","Beshariq","Bog'dod","Buvayda","Dang'ara","Furqat","Oltiariq","Qo'qon","Quva","Quvasoy","Rishton","So'x","Toshloq","Uchko'prik","Yozyovon"],
      "Jizzax": ["Jizzax sh.","Arnasoy","Baxmal","Do'stlik","Forish","G'allaorol","Mirzacho'l","Paxtakor","Yangiobod","Zafarobod","Zarbdor","Zomin"],
      "Namangan": ["Namangan sh.","Namangan t.","Chortoq","Chust","Kosonsoy","Mingbuloq","Norin","Pop","To'raqo'rg'on","Uchqo'rg'on","Uychi","Yangiqo'rg'on"],
      "Navoiy": ["Navoiy sh.","Karmana","Konimex","Navbahor","Nurota","Qiziltepa","Tomdi","Uchquduq","Xatirchi","Zarafshon"],
      "Qashqadaryo": ["Qarshi sh.","Qarshi t.","Chiroqchi","Dehqonobod","G'uzor","Kasbi","Kitob","Koson","Mirishkor","Muborak","Nishon","Shahrisabz","Yakkabog'"],
      "Samarqand": ["Samarqand sh.","Bulung'ur","Ishtixon","Jomboy","Kattaqo'rg'on sh.","Kattaqo'rg'on t.","Narpay","Nurobod","Oqdaryo","Paxtachi","Payariq","Pastdarg'om","Qo'shrabot","Samarqand t.","Tayloq","Urgut"],
      "Sirdaryo": ["Guliston sh.","Guliston t.","Boyovut","Hovos","Mirzaobod","Oqoltin","Sardoba","Sayxunobod","Sirdaryo","Shirin","Yangiyer"],
      "Surxondaryo": ["Termiz sh.","Termiz t.","Angor","Bandixon","Boysun","Denov","Jarqo'rg'on","Muzrabot","Oltinsoy","Qiziriq","Qo'mqo'rg'on","Sariosiyo","Sherobod","Shurchi"],
      "Toshkent": ["Toshkent sh.","Bekobod sh.","Bekobod t.","Bo'ka","Bo'stonliq","Chinoz","Ohangaron sh.","Ohangaron t.","Oqqo'rg'on","Parkent","Piskent","Quyichirchiq","Yangiyo'l","Yuqorichirchiq","Zangiota"],
      "Toshkent shahri": ["Bektemir","Chilonzor","Mirzo Ulug'bek","Mirobod","Olmazor","Sergeli","Shayxontohur","Uchtepa","Yakkasaroy","Yashnobod","Yunusobod"],
      "Xorazm": ["Urganch sh.","Urganch t.","Bog'ot","Gurlan","Hazorasp","Xiva sh.","Xiva t.","Qo'shko'pir","Shovot","Tuproqqal'a","Xonqa","Yangiariq","Yangibozor"]
    };

    // ======= Router: partials/ dan yuklab #app ga qo'yish =======
    const routes = ["home","tests","live","settings","profile"];
    async function loadRoute(route){
      const appEl = document.getElementById('app');
      const url = `/partials/${route}.html?v=${Date.now()}`;
      try{
        const res = await fetch(url);
        if(!res.ok) throw new Error('fallback');
        appEl.innerHTML = await res.text();
      }catch(e){
        // Fallback andozalar
        const tpl = document.getElementById(`tpl-${route}`) || document.getElementById('tpl-home');
        appEl.innerHTML = tpl.innerHTML;
        if(route==="profile") renderProfileView();
      }
      window.scrollTo({top:0, behavior:'smooth'});
      history.replaceState({}, '', `#${route}`);
    }

    // ======= Header ma'lumotlarini yangilash =======
    function updateHeader(userDoc){
      const name = userDoc?.ism || 'Foydalanuvchi';
      const age = userDoc?.yosh || (userDoc?.tugilgan ? calcAge(userDoc.tugilgan) : '—');
      document.getElementById('helloName').textContent = name;
      document.getElementById('helloAge').textContent = `Yosh: ${age}`;
      document.getElementById('headerID').textContent = userDoc?.numericId ?? '—';
      document.getElementById('headerBalans').textContent = (userDoc?.balans ?? 0).toLocaleString('uz-UZ');
      document.getElementById('headerBall').textContent = (userDoc?.ball ?? 0).toLocaleString('uz-UZ');
    }

    function calcAge(dateStr){
      const d = new Date(dateStr);
      if(Number.isNaN(d)) return '—';
      const diff = Date.now() - d.getTime();
      const ageDate = new Date(diff);
      return Math.abs(ageDate.getUTCFullYear() - 1970);
    }

    // ======= Profil form viloyat/tuman dinamik =======
    function fillViloyatlar(){
      const v = document.getElementById('pViloyat');
      v.innerHTML = '';
      Object.keys(UZ).forEach(k=>{
        const o = document.createElement('option'); o.value = k; o.textContent = k; v.appendChild(o);
      });
      v.addEventListener('change', ()=>fillTumanlar());
      fillTumanlar();
    }
    function fillTumanlar(){
      const v = document.getElementById('pViloyat');
      const t = document.getElementById('pTuman');
      const list = UZ[v.value] || [];
      t.innerHTML = '';
      list.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; t.appendChild(o); });
    }

    // ======= Auth oqimlari =======
    const loginDlg = document.getElementById('loginDlg');
    const signupDlg = document.getElementById('signupDlg');
    const profileDlg = document.getElementById('profileDlg');

    document.getElementById('openSignup').onclick = ()=>{ loginDlg.close(); signupDlg.showModal(); };

    document.getElementById('doLogin').onclick = async()=>{
      // ID+Parol: bu demo uchun email formatida ID ishlatamiz: id@mathcenter.uz
      const id = (document.getElementById('loginId').value||'').trim();
      const pw = document.getElementById('loginPass').value;
      if(!id || !pw){ alert('ID va parolni kiriting'); return; }
      const emailAlias = `${id}@mathcenter.uz`; // auth uchun alias
      try{
        await signInWithEmailAndPassword(auth, emailAlias, pw);
      }catch(err){ alert('Kirishda xatolik: '+err.message); }
    };

    document.getElementById('signupEmail').onclick = async()=>{
      const email = document.getElementById('suEmail').value;
      const pw = document.getElementById('suPass').value;
      if(!email||!pw){ alert('Email va parol kiriting'); return; }
      try{
        const cr = await createUserWithEmailAndPassword(auth, email, pw);
        await ensureUserDoc(cr.user);
      }catch(err){ alert('Ro\'yxatdan o\'tishda xatolik: '+err.message); }
    };

    document.getElementById('signupGoogle').onclick = async()=>{
      try{
        const provider = new GoogleAuthProvider();
        const cr = await signInWithPopup(auth, provider);
        // Parol o'rnatish ixtiyoriy: foydalanuvchi keyinroq profil orqali o'rnatishi mumkin.
        await ensureUserDoc(cr.user);
      }catch(err){ alert('Google: '+err.message); }
    };

    // Telefon uchun recaptcha konteynerini dinamik yaratamiz
    let recaptchaVerifier;
    function ensureRecaptcha(){
      if(document.getElementById('mc-recaptcha')) return;
      const div = document.createElement('div');
      div.id = 'mc-recaptcha';
      document.querySelector('#signupDlg .modal-body').appendChild(div);
      recaptchaVerifier = new RecaptchaVerifier(auth, 'mc-recaptcha', {size:'invisible'});
    }

    document.getElementById('signupPhone').onclick = async()=>{
      ensureRecaptcha();
      const phone = prompt('Telefon raqamni kiriting: +998...');
      if(!phone) return;
      try{
        const conf = await signInWithPhoneNumber(auth, phone, recaptchaVerifier);
        const code = prompt('SMS kodni kiriting');
        if(!code) return;
        const cr = await conf.confirm(code);
        // Telefon foydalanuvchisi uchun parolni keyinroq / sozlamalarda o'rnatish mumkin.
        await ensureUserDoc(cr.user);
      }catch(err){ alert('Telefon: '+err.message); }
    };

    // ======= Firestore: user doc, numericId generator =======
    async function ensureUserDoc(user){
      const ref = doc(db, 'users', user.uid);
      const snap = await getDoc(ref);
      if(snap.exists()) return snap.data();
      // numericId transaction
      const data = await runTransaction(db, async(tx)=>{
        const cRef = doc(db, 'meta', 'counters');
        const cSnap = await tx.get(cRef);
        let next = 1001;
        if(cSnap.exists()){
          next = (cSnap.data().usersNextId||1001);
          tx.update(cRef, { usersNextId: next + 1, updatedAt: serverTimestamp() });
        } else {
          tx.set(cRef, { usersNextId: 1002, createdAt: serverTimestamp() });
        }
        const userDoc = {
          uid: user.uid,
          numericId: next,
          ism: '', familiya:'', sharif:'',
          tugilgan: '', yosh: '',
          telefon:'', telegram:'', email: user.email || '',
          rol:'oquvchi', viloyat:'', tuman:'', maktab:'',
          balans:0, ball:0,
          createdAt: serverTimestamp(),
        };
        tx.set(ref, userDoc);
        return userDoc;
      });
      return data;
    }

    async function loadUserDoc(){
      const u = auth.currentUser; if(!u) return null;
      const ref = doc(db, 'users', u.uid); const s = await getDoc(ref); return s.exists()? s.data(): null;
    }

    async function saveProfileFromModal(){
      const u = auth.currentUser; if(!u){ alert('Avval kirish kerak'); return; }
      const ref = doc(db, 'users', u.uid);
      const ism = document.getElementById('pIsm').value.trim();
      const familiya = document.getElementById('pFam').value.trim();
      const sharif = document.getElementById('pSharif').value.trim();
      const tugilgan = document.getElementById('pTugilgan').value;
      const telefon = document.getElementById('pTelefon').value.trim();
      const telegram = document.getElementById('pTelegram').value.trim();
      const email = document.getElementById('pEmail').value.trim();
      const rol = document.getElementById('pRol').value;
      const viloyat = document.getElementById('pViloyat').value;
      const tuman = document.getElementById('pTuman').value;
      const maktab = document.getElementById('pMaktab').value.trim();
      const yosh = calcAge(tugilgan);
      if(!ism||!familiya||!tugilgan||!telefon||!rol||!viloyat||!tuman){ alert('Majburiy maydonlar to\'liq emas'); return; }
      await updateDoc(ref, { ism, familiya, sharif, tugilgan, yosh, telefon, telegram, email, rol, viloyat, tuman, maktab });
      profileDlg.close();
      const docData = await loadUserDoc();
      updateHeader(docData);
      await loadRoute('profile');
    }

    document.getElementById('saveProfile').onclick = saveProfileFromModal;

    // Profil ko'rinishi
    async function renderProfileView(){
      const d = await loadUserDoc();
      if(!d){ document.getElementById('profileView').innerHTML = '<p>Kirish talab etiladi.</p>'; return; }
      const fields = [
        ['Ism', d.ism],
        ['Familiya', d.familiya],
        ['Sharif', d.sharif],
        ["Tug'ilgan sana", d.tugilgan],
        ['Yosh', d.yosh],
        ['Telefon', d.telefon],
        ['Telegram', d.telegram],
        ['Email', d.email],
        ['Roli', d.rol==='oqituvchi'?"O'qituvchi":"O'quvchi"],
        ['Viloyat', d.viloyat],
        ['Tuman/Shahar', d.tuman],
        ['Maktab', d.maktab],
        ['ID', d.numericId],
        ['Balans', d.balans],
        ['Ball', d.ball],
      ];
      const html = fields.map(([k,v])=>`<div class="content-card"><strong>${k}:</strong> ${v?String(v):'—'}</div>`).join('');
      document.getElementById('profileView').innerHTML = `<div class="grid">${html}</div>`;
    }

    // ======= FAB (open/drag) =======
    const fab = document.getElementById('fab');
    const fabBtn = document.getElementById('fabBtn');
    const fabMenu = document.getElementById('fabMenu');
    fabBtn.onclick = ()=>{ fab.classList.toggle('open'); };
    fab.addEventListener('click', (e)=>{
      const btn = e.target.closest('.chip'); if(!btn) return;
      const r = btn.getAttribute('data-route'); if(!r){ if(btn.id==='logoutBtn') doLogout(); return; }
      loadRoute(r);
      fab.classList.remove('open');
    });

    // Drag
    (function(){
      const drag = fab.querySelector('.fab-drag');
      let sx=0, sy=0, startRight=16, startBottom=16, dragging=false;
      const getRB = ()=>{
        const s = getComputedStyle(fab);
        return {r: parseFloat(s.right), b: parseFloat(s.bottom)};
      };
      const pointerDown = (e)=>{ dragging=true; fabBtn.style.cursor='grabbing'; sx=e.clientX; sy=e.clientY; const {r,b}=getRB(); startRight=r; startBottom=b; };
      const pointerMove = (e)=>{ if(!dragging) return; const dx=e.clientX-sx; const dy=e.clientY-sy; fab.style.right = Math.max(8, startRight-dx)+"px"; fab.style.bottom = Math.max(8, startBottom-dy)+"px"; };
      const pointerUp = ()=>{ dragging=false; fabBtn.style.cursor=''; };
      drag.addEventListener('pointerdown', pointerDown);
      window.addEventListener('pointermove', pointerMove);
      window.addEventListener('pointerup', pointerUp);
    })();

    // ======= Logout =======
    async function doLogout(){ await signOut(auth); location.hash = '#home'; await loadRoute('home'); }

    // ======= Auth state =======
    onAuthStateChanged(auth, async(user)=>{
      if(user){
        const data = await ensureUserDoc(user);
        updateHeader(data);
        // Profil majburiy: agar ism, tug'ilgan yo'q bo'lsa ochiladi
        if(!data.ism || !data.tugilgan){ fillViloyatlar(); profileDlg.showModal(); }
        document.getElementById('loginDlg').close(); document.getElementById('signupDlg').close();
      }else{
        updateHeader(null);
        // Kirish majburiy → login ochamiz
        document.getElementById('loginDlg').showModal();
      }
    });

    // ======= Splash → App =======
    function showApp(){
      const splash = document.getElementById('splash');
      const shell = document.getElementById('shell');
      splash.style.display='none';
      shell.style.opacity='1';
      shell.removeAttribute('aria-hidden');
    }
    setTimeout(showApp, 3000);

    // ======= Router start =======
    window.addEventListener('hashchange', ()=>{
      const r = location.hash.replace('#','');
      if(routes.includes(r)) loadRoute(r);
    });
    // initial route
    const start = location.hash.replace('#','') || 'home';
    loadRoute(routes.includes(start)? start: 'home');

  </script>
</body>
</html>
