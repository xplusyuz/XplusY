<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LeaderMath ‚Äî Portal</title>
  <meta name="theme-color" content="#070B14" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#070B14;
      --panel:rgba(255,255,255,.08);
      --panel2:rgba(255,255,255,.05);
      --stroke:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.66);
      --accent:#2E8B57;
      --accent2:#5856D6;
      --danger:#ff3b30;
      --shadow:0 28px 90px rgba(0,0,0,.55);
      --r:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      color:var(--text);
      min-height:100vh;
      padding-bottom:92px;
      background:linear-gradient(180deg,#070B14,#0B1220);
      overflow-x:hidden;
    }
    /* canvas bg injected */
    header{
      position:sticky; top:0; z-index:20;
      background:linear-gradient(180deg, rgba(7,11,20,.84), rgba(7,11,20,.62));
      backdrop-filter: blur(16px);
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .bar{
      width:min(1180px,100%);
      margin:0 auto;
      padding:14px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      position:relative; z-index:2;
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:44px; height:44px;
      border-radius:16px;
      background:linear-gradient(135deg, rgba(46,139,87,.92), rgba(88,86,214,.70));
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 16px 40px rgba(0,0,0,.35);
      display:flex; align-items:center; justify-content:center;
      font-weight:1000;
      letter-spacing:-.5px;
    }
    .title{display:flex; flex-direction:column; gap:2px; line-height:1.1;}
    .title b{font-size:14px;}
    .title span{font-size:12px; color:var(--muted);}
    .actions{display:flex; gap:10px; align-items:center;}
    .iconbtn{
      width:42px; height:42px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.88);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
      transition:transform .12s ease, background .12s ease;
    }
    .iconbtn:active{transform:scale(.98)}
    .userchip{
      display:flex; align-items:center; gap:10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      transition:transform .12s ease;
    }
    .userchip:hover{transform:translateY(-1px)}
    .avatar{
      width:34px; height:34px; border-radius:50%;
      border:1px solid rgba(255,255,255,.20);
      background:rgba(0,0,0,.22);
      display:flex; align-items:center; justify-content:center;
      font-weight:1000;
    }
    .chipmeta{display:flex; flex-direction:column; line-height:1.15;}
    .chipmeta b{font-size:12px;}
    .chipmeta span{font-size:11px; color:var(--muted);}

    main{
      width:min(1180px,100%);
      margin:0 auto;
      padding:14px;
      position:relative; z-index:2;
    }

    .hero{
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border-radius:26px;
      box-shadow:var(--shadow);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 280px at 15% 20%, rgba(46,139,87,.24), transparent 60%),
        radial-gradient(640px 300px at 85% 30%, rgba(88,86,214,.18), transparent 60%);
      pointer-events:none;
    }
    .hero *{position:relative; z-index:1;}
    .heroTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .heroTop h1{
      margin:0;
      font-size:18px;
      letter-spacing:-.4px;
    }
    .pill{
      border:1px solid rgba(46,139,87,.35);
      background:rgba(46,139,87,.12);
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:1000;
      color:#d7ffe8;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .pulsedot{
      width:8px;height:8px;border-radius:50%;
      background:#57ffa1;
      box-shadow:0 0 0 0 rgba(87,255,161,.0);
      animation:pulse 1.4s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{box-shadow:0 0 0 0 rgba(87,255,161,.0)}
      50%{box-shadow:0 0 0 10px rgba(87,255,161,.14)}
    }
    .sub{margin:8px 0 0; color:var(--muted); font-size:12px; line-height:1.55; max-width:70ch;}
    .stats{
      margin-top:14px;
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:10px;
    }
    @media(max-width:900px){.stats{grid-template-columns:repeat(2,1fr);}}
    .stat{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      border-radius:18px;
      padding:12px;
      transition:transform .14s ease, border-color .14s ease;
    }
    .stat:hover{transform:translateY(-2px); border-color:rgba(46,139,87,.35);}
    .stat b{display:block; font-size:18px; letter-spacing:-.4px;}
    .stat span{display:block; margin-top:4px; font-size:12px; color:var(--muted);}

    .grid{
      margin-top:12px;
      display:grid;
      grid-template-columns:1.4fr .6fr;
      gap:12px;
    }
    @media(max-width:980px){.grid{grid-template-columns:1fr;}}
    .card{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      border-radius:24px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding:14px 14px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .cardHead h2{margin:0;font-size:14px;}
    .cardHead p{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.45;}
    .cardBody{padding:14px;}
    .ctaRow{display:flex; gap:10px; flex-wrap:wrap;}
    .btn{
      border:1px solid rgba(46,139,87,.55);
      background:linear-gradient(180deg,rgba(46,139,87,.95),rgba(46,139,87,.70));
      color:white;
      padding:12px 14px;
      border-radius:16px;
      font-weight:1000;
      cursor:pointer;
      transition:transform .12s ease, filter .12s ease;
    }
    .btn:hover{filter:brightness(1.04)}
    .btn:active{transform:scale(.99)}
    .btn.secondary{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.92);
    }

    .banner{
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(135deg, rgba(46,139,87,.16), rgba(88,86,214,.10));
      border-radius:20px;
      padding:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      overflow:hidden;
      position:relative;
    }
    .banner:after{
      content:"";
      position:absolute;
      width:240px;height:240px;border-radius:50%;
      background:radial-gradient(circle, rgba(255,255,255,.12), transparent 60%);
      right:-120px; top:-120px;
      opacity:.6;
    }
    .banner b{display:block; font-size:13px;}
    .banner span{display:block; margin-top:4px; color:var(--muted); font-size:12px; line-height:1.45;}

    .rankingList{display:grid; gap:10px;}
    .li{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      transition:transform .14s ease, border-color .14s ease;
    }
    .li:hover{transform:translateY(-1px); border-color:rgba(88,86,214,.35);}
    .left{display:flex; align-items:center; gap:10px;}
    .ranknum{
      width:34px;height:34px;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.14);
      font-weight:1000;
    }
    .nm{font-weight:1000; font-size:13px;}
    .sm{color:var(--muted); font-size:12px; margin-top:2px;}
    .pts{font-weight:1000;}
    .muted{color:var(--muted); font-size:12px;}

    /* bottom nav */
    .bottom{
      position:fixed; left:0; right:0; bottom:0; z-index:30;
      background:linear-gradient(180deg, rgba(11,18,32,.55), rgba(11,18,32,.92));
      backdrop-filter: blur(16px);
      border-top:1px solid rgba(255,255,255,.10);
    }
    .nav{
      width:min(1180px,100%);
      margin:0 auto;
      padding:10px 10px 12px;
      display:flex; gap:10px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:none;
    }
    .nav::-webkit-scrollbar{display:none;}
    .navbtn{
      flex:0 0 auto;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.88);
      padding:10px 12px;
      border-radius:999px;
      font-weight:1000;
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;
      transition:transform .12s ease, background .12s ease, border-color .12s ease;
      display:flex; align-items:center; gap:8px;
    }
    .navbtn:active{transform:scale(.98)}
    .navbtn.active{border-color:rgba(46,139,87,.55); background:rgba(46,139,87,.16); color:#eafff3;}

    /* modal sheet */
    .modal{
      position:fixed; inset:0; z-index:60;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
    }
    .modal.open{display:flex;}
    .sheet{
      width:min(820px,100%);
      border-radius:26px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(15,22,38,.92);
      box-shadow:var(--shadow);
      backdrop-filter: blur(16px);
      overflow:hidden;
      transform:translateY(10px);
      opacity:.98;
      animation:sheetIn .18s ease-out both;
    }
    @keyframes sheetIn{from{transform:translateY(22px);opacity:.85}to{transform:translateY(0);opacity:1}}
    .sheetHead{
      padding:14px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .sheetHead b{font-size:14px; font-weight:1000;}
    .xbtn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.9);
      width:42px;height:42px;border-radius:16px;
      cursor:pointer;font-weight:1000;
      transition:transform .12s ease;
    }
    .xbtn:active{transform:scale(.98)}
    .sheetBody{padding:14px;}
    .fields{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    @media(max-width:560px){.fields{grid-template-columns:1fr;}}
    label{font-size:12px; color:rgba(255,255,255,.75); font-weight:800;}
    input,select{
      width:100%;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
      font-size:14px;
      transition:border-color .12s ease, box-shadow .12s ease;
    }
    input:focus,select:focus{border-color:rgba(46,139,87,.65); box-shadow:0 0 0 4px rgba(46,139,87,.18);}
    .toast{
      position:fixed; left:50%; bottom:104px; transform:translateX(-50%);
      background:rgba(0,0,0,.78);
      border:1px solid rgba(255,255,255,.18);
      color:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius:999px;
      display:none;
      z-index:80;
      font-size:12px;
    }
    .toast.show{display:block;}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <div class="logo">œÄ</div>
        <div class="title">
          <b>LeaderMath</b>
          <span id="subline">Yuklanmoqda‚Ä¶</span>
        </div>
      </div>

      <div class="actions">
        <button class="iconbtn" id="btnRefresh" title="Yangilash">‚ü≥</button>
        <div class="userchip" id="userChip" title="Profil">
          <div class="avatar" id="avatar">U</div>
          <div class="chipmeta">
            <b id="chipName">‚Äî</b>
            <span id="chipId">ID: ‚Äî ‚Ä¢ 0 pts</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="heroTop">
        <div>
          <h1>Portal</h1>
          <p class="sub">Premium glass UI, neon math animatsiya, tez session guard. Pastda sticky nav ‚Äî gorizontal scroll bilan.</p>
        </div>
        <div class="pill" id="pill"><span class="pulsedot"></span> Session OK</div>
      </div>

      <div class="stats">
        <div class="stat"><b id="pts">0</b><span>Points</span></div>
        <div class="stat"><b id="region">‚Äî</b><span>Viloyat</span></div>
        <div class="stat"><b id="district">‚Äî</b><span>Tuman</span></div>
        <div class="stat"><b id="birth">‚Äî</b><span>Tug‚Äòilgan sana</span></div>
      </div>
    </section>

    <div class="grid">
      <section class="card">
        <div class="cardHead">
          <div>
            <h2>Tez amallar</h2>
            <p>Profilni to‚Äòldiring, parolni yangilang, keyin test/simulyatorlar qo‚Äòshiladi.</p>
          </div>
        </div>
        <div class="cardBody">
          <div class="banner" style="margin-bottom:12px;">
            <div>
              <b>Profilni to‚Äòldiring</b>
              <span>Viloyat/tuman/tug‚Äòilgan sana kiritilsa reyting to‚Äòliq ko‚Äòrinadi.</span>
            </div>
            <button class="btn secondary" id="btnEdit">Tahrirlash</button>
          </div>

          <div class="ctaRow">
            <button class="btn" id="btnProfile">üë§ Profil</button>
            <button class="btn secondary" id="btnLogout">üö™ Chiqish</button>
          </div>

          <div style="margin-top:12px" class="muted">
            Keyingi bosqich: ‚Äúhome banners/cards‚Äù, testlar va simulyatorlarni API-only qilib ulash.
          </div>
        </div>
      </section>

      <aside class="card">
        <div class="cardHead">
          <div>
            <h2>Top reyting</h2>
            <p class="muted">Points bo‚Äòyicha (Top-20)</p>
          </div>
        </div>
        <div class="cardBody">
          <div class="rankingList" id="ranking"><div class="muted">Yuklanmoqda‚Ä¶</div></div>
        </div>
      </aside>
    </div>

    <section class="card" style="margin-top:12px;">
      <div class="cardHead">
        <div>
          <h2>Sahifalar</h2>
          <p class="muted">Nav tugmasini bosing ‚Äî kontent o‚Äòzgaradi.</p>
        </div>
      </div>
      <div class="cardBody">
        <div id="page-home" class="page active"><div class="banner"><div><b>üè† Home</b><span>Keyin: admin bilan boshqariladigan banner/cardlar.</span></div><button class="btn secondary" id="goProfile2">Profil</button></div></div>
        <div id="page-tests" class="page"><div class="banner"><div><b>üìù Testlar</b><span>Keyin: test katalog + test yechish UI (API-only).</span></div></div></div>
        <div id="page-sim" class="page"><div class="banner"><div><b>ü§ñ Simulyatorlar</b><span>Keyin: kvadrat tenglama, kasr soddalashtirish va h.k.</span></div></div></div>
        <div id="page-ranking" class="page"><div class="banner"><div><b>üìä Reyting</b><span>O‚Äòngdagi reyting ro‚Äòyxati shu bo‚Äòlimda ham ko‚Äòrinadi.</span></div></div></div>
      </div>
    </section>
  </main>

  <div class="bottom">
    <div class="nav" id="nav">
      <button class="navbtn active" data-page="home">üè† Home</button>
      <button class="navbtn" data-page="tests">üìù Testlar</button>
      <button class="navbtn" data-page="sim">ü§ñ Simulyatorlar</button>
      <button class="navbtn" data-page="ranking">üìä Reyting</button>
      <button class="navbtn" data-page="profile">üë§ Profil</button>
    </div>
  </div>

  <!-- Profile modal -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="sheetHead">
        <b>Profilni tahrirlash</b>
        <button class="xbtn" id="x">‚úï</button>
      </div>
      <div class="sheetBody">
        <div class="fields">
          <div><label>Ism</label><input id="firstName" placeholder="Ismingiz" /></div>
          <div><label>Familiya</label><input id="lastName" placeholder="Familiyangiz" /></div>
          <div><label>Viloyat</label><select id="regionSel"><option value="">Tanlang‚Ä¶</option></select></div>
          <div><label>Tuman</label><select id="districtSel" disabled><option value="">Avval viloyat tanlang‚Ä¶</option></select></div>
          <div><label>Tug‚Äòilgan sana</label><input id="birthdate" type="date" /></div>
        </div>

        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="save">Saqlash</button>
          <button class="btn secondary" id="close">Yopish</button>
        </div>

        <div style="margin-top:12px;">
          <button class="btn secondary" id="pw">üîë Parolni almashtirish</button>
        </div>

        <div id="pwBox" style="display:none;margin-top:12px;">
          <div class="fields">
            <div><label>Joriy parol</label><input id="pwCur" type="password" /></div>
            <div><label>Yangi parol (>=6)</label><input id="pwNew" type="password" /></div>
          </div>
          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn" id="pwSave">Yangilash</button>
            <button class="btn secondary" id="pwCancel">Bekor</button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="assets/anim-bg.js"></script>
  <script src="assets/api-client.js"></script>
  <script src="assets/auth-client.js"></script>
  <script>
    const $ = (id)=>document.getElementById(id);
    const toast = (m)=>{ const t=$('toast'); t.textContent=m; t.classList.add('show'); clearTimeout(t.__t); t.__t=setTimeout(()=>t.classList.remove('show'), 2200); };

    let regionData=null;
    let ME=null;

    (async ()=>{
      ME = await lmAuth.require();
      if (!ME) return;
      await init();
    })();

    async function init(){
      paintUser(ME);

      // region list
      try{
        const r = await fetch('region.json', {cache:'no-store'});
        regionData = await r.json();
        fillRegions(regionData);
      }catch(e){ console.warn('region.json yuklanmadi', e); }

      // ranking
      await loadRanking();

      // events
      $('btnRefresh').onclick = async ()=>{
        $('pill').innerHTML = '<span class="pulsedot"></span> Yangilanmoqda‚Ä¶';
        try{
          await refreshMe();
          await loadRanking();
          toast('Yangilandi ‚úÖ');
        }finally{
          $('pill').innerHTML = '<span class="pulsedot"></span> Session OK';
        }
      };

      $('nav').addEventListener('click',(e)=>{
        const btn = e.target.closest('.navbtn');
        if(!btn) return;
        const page = btn.dataset.page;
        if(page==='profile'){ openModal(); return; }
        showPage(page);
      });

      $('userChip').onclick = openModal;
      $('btnEdit').onclick = openModal;
      $('btnProfile').onclick = openModal;
      $('goProfile2').onclick = openModal;
      $('btnLogout').onclick = ()=>lmAuth.logout();

      $('x').onclick = closeModal;
      $('close').onclick = closeModal;
      $('modal').addEventListener('click',(e)=>{ if(e.target===$('modal')) closeModal(); });

      $('regionSel').addEventListener('change',(e)=>updateDistricts(e.target.value));
      $('save').onclick = saveProfile;

      $('pw').onclick = ()=>{ $('pwBox').style.display='block'; };
      $('pwCancel').onclick = ()=>{ $('pwBox').style.display='none'; };
      $('pwSave').onclick = changePassword;
    }

    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.querySelectorAll('.navbtn').forEach(b=>b.classList.remove('active'));
      const p=document.getElementById('page-'+id);
      if(p) p.classList.add('active');
      const b=document.querySelector('.navbtn[data-page="'+id+'"]');
      if(b) b.classList.add('active');
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function paintUser(u){
      const fn=(u.firstName||'').trim(), ln=(u.lastName||'').trim();
      const name=(fn+' '+ln).trim() || 'Foydalanuvchi';
      $('chipName').textContent=name;
      $('chipId').textContent=`ID: ${u.loginId || u.id || '‚Äî'} ‚Ä¢ ${u.points||0} pts`;
      $('avatar').textContent=(fn?fn[0]:'U').toUpperCase();
      $('subline').textContent=`Xush kelibsiz, ${name}!`;

      $('pts').textContent=u.points||0;
      $('region').textContent=u.region||'‚Äî';
      $('district').textContent=u.district||'‚Äî';
      $('birth').textContent=u.birthdate||'‚Äî';
    }

    async function refreshMe(){
      const out = await lmApi.me();
      ME = out.user;
      paintUser(ME);
      return ME;
    }

    function openModal(){
      const u = ME || {};
      $('firstName').value = u.firstName || '';
      $('lastName').value = u.lastName || '';
      $('birthdate').value = u.birthdate || '';
      if(u.region) $('regionSel').value = u.region;
      updateDistricts(u.region || '', true);
      if(u.district) $('districtSel').value = u.district;

      $('pwBox').style.display='none';
      $('pwCur').value='';
      $('pwNew').value='';
      $('modal').classList.add('open');
    }
    function closeModal(){ $('modal').classList.remove('open'); }

    function fillRegions(data){
      const sel=$('regionSel');
      if(!data||!data.regions) return;
      sel.innerHTML='<option value="">Tanlang‚Ä¶</option>';
      data.regions.forEach(r=>{ const o=document.createElement('option'); o.value=r.name; o.textContent=r.name; sel.appendChild(o); });
    }
    function updateDistricts(region, keep=false){
      const ds=$('districtSel');
      ds.innerHTML='<option value="">Tanlang‚Ä¶</option>';
      ds.disabled=!region;
      if(!regionData||!region) return;
      const r=regionData.regions.find(x=>x.name===region);
      if(!r) return;
      r.districts.forEach(d=>{ const o=document.createElement('option'); o.value=d; o.textContent=d; ds.appendChild(o); });
      if(!keep) ds.value='';
    }

    async function saveProfile(){
      const firstName=$('firstName').value.trim();
      const lastName=$('lastName').value.trim();
      const region=$('regionSel').value.trim();
      const district=$('districtSel').value.trim();
      const birthdate=$('birthdate').value.trim();

      if(!firstName) return toast('Ism kiriting.');
      if(!region) return toast('Viloyat tanlang.');
      if(!district) return toast('Tuman tanlang.');
      if(!birthdate) return toast('Tug‚Äòilgan sana kiriting.');

      try{
        await lmApi.userPatch({ firstName, lastName, region, district, birthdate });
        toast('Saqlandi ‚úÖ');
        await refreshMe();
        closeModal();
      }catch(e){ toast(e?.message || 'Xatolik'); }
    }

    async function changePassword(){
      const currentPassword=$('pwCur').value.trim();
      const newPassword=$('pwNew').value.trim();
      if(!currentPassword) return toast('Joriy parolni kiriting.');
      if(!newPassword || newPassword.length<6) return toast('Yangi parol kamida 6 belgi.');

      try{
        await lmApi.changePassword(currentPassword, newPassword);
        toast('Parol yangilandi ‚úÖ');
        $('pwBox').style.display='none';
        $('pwCur').value=''; $('pwNew').value='';
      }catch(e){ toast(e?.message || 'Xatolik'); }
    }

    async function loadRanking(){
      try{
        const out=await lmApi.ranking();
        const users=out.users||[];
        const box=$('ranking');
        if(!users.length){ box.innerHTML='<div class="muted">Hozircha foydalanuvchi yo‚Äòq.</div>'; return; }
        box.innerHTML='';
        users.slice(0,20).forEach((u,i)=>{
          const fn=(u.firstName||'').trim(), ln=(u.lastName||'').trim();
          const name=(fn+' '+ln).trim() || ('ID '+(u.loginId||u.id||'‚Äî'));
          const item=document.createElement('div');
          item.className='li';
          item.innerHTML = `<div class="left"><div class="ranknum">${i+1}</div><div><div class="nm">${escapeHtml(name)}</div><div class="sm">${escapeHtml((u.region||'') + (u.district?(' ‚Ä¢ '+u.district):''))}</div></div></div><div class="pts">${u.points||0}</div>`;
          box.appendChild(item);
        });
      }catch(e){
        $('ranking').innerHTML='<div class="muted">Reyting yuklanmadi.</div>';
      }
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,(c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
  </script>
</body>
</html>
