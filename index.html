<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>LeaderMath ‚Äî PWA (Perfect Userpanel + Decile Stars)</title>
  <meta name="theme-color" content="#2E8B57" id="meta-theme-color"/>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./favicon.ico">
  <style>
    :root{
      --brand:#2E8B57;--brand2:#1F6B45;--accent:#39B6FF;
      --bg:#f4f8f6;--text:#0e1a14;--muted:#3f5f52;--card:#ffffff;
      --frame:#d9e7de;--frame-strong:#c5e0d3;--chip:#ecf7f2;--chip-b:#cfe7db;
      --ring:#72d4a8;--warn:#f59e0b;--radius:16px;
    }
    :root.dark{
      --bg:#0e1512;--text:#eaf7ee;--muted:#a4c6b6;--card:#142018;
      --frame:#244b39;--frame-strong:#2f6b52;--chip:#122a20;--chip-b:#2a5742;--ring:#2fbf7d;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .appbar{position:sticky;top:0;z-index:90;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:10px 12px;display:flex;align-items:center;gap:10px;box-shadow:0 10px 28px rgba(0,0,0,.18)}
    .logo{width:40px;height:40px;border-radius:14px;background:#fff2;display:grid;place-items:center;font-weight:900}
    .title{font-weight:900;font-size:18px}
    .sp{flex:1}
    .iconbtn{background:#ffffff22;border:1px solid #ffffff33;color:#fff;border-radius:12px;padding:8px 10px;font-weight:700;cursor:pointer}

    /* ======= PERFECT USERPANEL ======= */
    .userpanel{
      margin:12px; border-radius:22px; position:relative; overflow:hidden;
      background:var(--card); border:1px solid var(--frame);
      box-shadow:0 18px 50px rgba(0,0,0,.08);
    }
    .userpanel::before{
      content:""; position:absolute; inset:-1px; border-radius:22px; padding:1px;
      background:linear-gradient(135deg,#aef1cf 0%, #2E8B57 40%, #39B6FF 100%);
      -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
      -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none; opacity:.7;
    }
    .up-wrap{
      display:grid; gap:12px; padding:14px;
      grid-template-columns:84px 1fr auto;
      grid-template-areas:
        "ava name score"
        "ava meta score"
        "stats stats score";
    }
    @media(max-width:640px){
      .up-wrap{
        grid-template-columns:72px 1fr; grid-template-areas:
          "ava name"
          "ava meta"
          "stats stats";
      }
    }

    /* Avatar with gradient ring */
    .avaRing{ grid-area:ava; width:84px; height:84px; border-radius:50%;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.25), transparent 45%),
        conic-gradient(from 220deg, #9fe8c9, #2E8B57, #39B6FF, #9fe8c9);
      display:grid; place-items:center; padding:3px;
      box-shadow:0 10px 28px rgba(46,139,87,.25);
    }
    .ava{ width:78px; height:78px; border-radius:50%;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      display:grid; place-items:center; color:#fff; font-weight:900; overflow:hidden;
    }
    .ava img{width:100%;height:100%;object-fit:cover}

    /* Name + stars row */
    .up-name{ grid-area:name }
    .up-name .line1{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    .uname{ font-size:18px; font-weight:900 }
    .ustars{ display:inline-flex; gap:3px; vertical-align:middle }
    .badge-soft{font-size:12px; padding:6px 8px; border-radius:999px; background:var(--chip); border:1px solid var(--chip-b)}

    /* meta row: small chips */
    .up-meta{ grid-area:meta; display:flex; flex-wrap:wrap; gap:8px }
    .chip{ display:inline-flex; align-items:center; gap:6px; padding:7px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--chip-b); font-size:12px }

    /* Right score card */
    .up-score{ grid-area:score; align-self:center; text-align:right }
    .scoreCard{
      min-width:160px; background:linear-gradient(135deg,var(--brand),var(--brand2)); color:#fff;
      border-radius:16px; padding:10px 12px; box-shadow:0 14px 36px rgba(46,139,87,.35);
      border:1px solid #ffffff22;
    }
    .scoreVal{ font-size:22px; font-weight:900; line-height:1 }
    .scoreSub{ font-size:12px; opacity:.9; display:flex; align-items:center; justify-content:flex-end; gap:6px; margin-top:4px }
    .links{ margin-top:8px; font-size:12px }
    .links a{ color:#fff; opacity:.92; text-decoration:underline dotted }

    /* Stats pills row */
    .up-stats{ grid-area:stats; display:flex; flex-wrap:wrap; gap:8px }
    .stat{
      display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px;
      background:#fff; border:1px solid var(--frame); box-shadow:0 6px 16px rgba(0,0,0,.06);
      font-weight:800; font-size:13px;
    }
    .stat .sub{ font-weight:600; color:var(--muted); font-size:11px }

    /* Stars / Diamonds ‚Äî sizes tuned */
    .stars{display:inline-flex;gap:3px;vertical-align:middle}
    .tier-diamond .stars svg{width:22px;height:22px}
    .stars svg{width:18px;height:18px}

    /* Buttons */
    .btn-primary{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border-radius:12px;font-weight:800;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;border:1px solid #0000;box-shadow:0 6px 16px rgba(46,139,87,.25)}
    .btn-primary:active{transform:translateY(1px)}

    /* Sections & board (qisqartirilgan) */
    .board{background:var(--card);border:1px solid var(--frame);border-radius:16px;margin:12px;padding:12px}
    .banner{margin:12px;border-radius:18px;overflow:hidden;border:1px solid var(--frame);box-shadow:0 10px 24px rgba(0,0,0,.06);background:linear-gradient(135deg,#f0fff6,#e7f6ee)}
    .modal-mask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:999}
    .modal{width:min(840px,94%);max-height:90vh;overflow:auto;background:var(--card);border-radius:18px;border:1px solid var(--frame-strong);box-shadow:0 24px 64px rgba(0,0,0,.35);padding:18px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .ctl label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    .ctl input{width:100%;padding:11px;border:1px solid var(--frame);border-radius:12px;background:var(--card);color:var(--text);outline:none}
    @media(max-width:560px){.grid2,.grid3{grid-template-columns:1fr}}

    /* Tier headers / rows (oldingidek) */
    .group{border:none;border-radius:14px;overflow:hidden;margin:10px 0;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .groupHead{padding:12px 14px;font-weight:900;display:flex;justify-content:space-between}
    .tier-badge{padding:6px 10px;border-radius:999px;border:1px solid var(--frame);background:rgba(255,255,255,.5)}
    .rank{display:grid;grid-template-columns:54px 1fr auto;gap:12px;align-items:center;padding:10px;border-radius:12px;border:1px solid var(--frame);margin:8px 0;background:var(--card)}
    .rnk{font-weight:900;background:var(--chip);border:1px solid var(--frame);padding:6px 10px;border-radius:10px}
  </style>
</head>
<body>
  <!-- Appbar -->
  <header class="appbar">
    <div class="logo">L</div>
    <div><div class="title">LeaderMath</div><div style="opacity:.9;font-size:12px">BSB / CHSB dars resurslari</div></div>
    <div class="sp"></div>
    <button id="themeBtn" class="iconbtn" title="Dark/Light">üåô</button>
  </header>

  <!-- ======= USERPANEL ======= -->
  <section class="userpanel" id="userpanel">
    <div class="up-wrap">
      <div class="avaRing"><div class="ava" id="ava">LM</div></div>

      <div class="up-name">
        <div class="line1">
          <span class="uname" id="uname">Mehmon</span>
          <span id="userTierStars" class="ustars"></span>
          <span class="badge-soft" id="uid">ID: ‚Äî</span>
        </div>
        <div class="up-meta">
          <span class="chip" id="uregion">Viloyat: ‚Äî</span>
          <span class="chip" id="udistrict">Tuman: ‚Äî</span>
          <span class="chip" id="uschool">Maktab: ‚Äî</span>
          <span class="chip" id="uclass">Sinf: ‚Äî</span>
          <span class="chip" id="urank">O‚Äòrin: ‚Äî</span>
          <span class="chip" id="utier">Daraja: ‚Äî</span>
        </div>
      </div>

      <div class="up-score">
        <div class="scoreCard">
          <div>Ball</div>
          <div class="scoreVal" id="scoreVal">‚Äî</div>
          <div class="scoreSub">
            <span id="userStarsPts" class="ustars"></span>
          </div>
          <div class="links">
            <a href="#" id="signin">Kirish</a> ¬∑
            <a href="#" id="editProfile" style="display:none">Profil</a> ¬∑
            <a href="#" id="signout" style="display:none">Chiqish</a>
          </div>
        </div>
      </div>

      <div class="up-stats">
        <div class="stat">üìò <div><div>Profil</div><div class="sub">to‚Äòldirish majburiy</div></div></div>
        <div class="stat">‚≠ê <div><div>Reyting</div><div class="sub">0.5‚Äì5 yulduz</div></div></div>
        <div class="stat">üèÜ <div><div>Top 50</div><div class="sub">o‚Äòntalik pager</div></div></div>
      </div>
    </div>
  </section>

  <!-- Banner (demo) -->
  <section id="banners"></section>

  <!-- Leaderboard (short; qolgan kod ishlaydi) -->
  <section class="board" id="board">
    <h3>Top 50 ‚Äî Ball bo‚Äòyicha</h3>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <button id="decilePrev" class="btn-primary" style="background:#fff;color:#1F6B45;border:1px solid var(--frame)">‚¨ÖÔ∏è Oldingi</button>
      <div id="decileInfo" style="font-size:12px;color:var(--muted)">10‚Äì1 (Diamond)</div>
      <button id="decileNext" class="btn-primary">Keyingi ‚û°Ô∏è</button>
    </div>
    <div id="boardList"></div>
  </section>

  <!-- Profile modal -->
  <div id="profileModal" class="modal-mask" aria-modal="true" role="dialog">
    <div class="modal">
      <h3>Profil ma‚Äôlumotlari (majburiy)</h3>
      <div class="grid2">
        <div class="ctl"><label>Ism *</label><input id="pFirst"></div>
        <div class="ctl"><label>Familiya *</label><input id="pLast"></div>
      </div>
      <div class="grid3" style="margin-top:8px">
        <div class="ctl"><label>Viloyat *</label><input id="pRegion" placeholder="Namangan"></div>
        <div class="ctl"><label>Tuman/Shahar *</label><input id="pDistrict" placeholder="Yangiqo‚Äòrg‚Äòon"></div>
        <div class="ctl"><label>Maktab *</label><input id="pSchool" placeholder="1-maktab"></div>
      </div>
      <div class="grid2" style="margin-top:8px">
        <div class="ctl"><label>Sinf *</label><input id="pClass" placeholder="9-A"></div>
        <div class="ctl"><label>Telefon *</label><input id="pPhone" placeholder="+998 XX XXX XX XX"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <div id="pError" style="color:#c62828; margin-right:auto; font-size:12px"></div>
        <button id="pSave" class="btn-primary">Saqlash</button>
        <button id="pClose" class="btn-primary" style="background:#fff;color:#1F6B45;border:1px solid var(--frame)">Yopish</button>
      </div>
    </div>
  </div>

<script type="module">
  // ===== Theme
  const root=document.documentElement, themeBtn=document.getElementById('themeBtn'), THEME_KEY='lm-theme';
  const setTheme=m=>{root.classList.toggle('dark',m==='dark');localStorage.setItem(THEME_KEY,m);themeBtn.textContent=m==='dark'?'‚òÄÔ∏è':'üåô'};
  setTheme(localStorage.getItem(THEME_KEY)||(matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
  themeBtn.onclick=()=>setTheme(root.classList.contains('dark')?'light':'dark');
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./service-worker.js'); }

  // ===== Firebase
  import { auth, db, signOut } from './lib/firebase.client.js';
  import { watchAuth } from './lib/auth-guard.js';
  import { doc, getDoc, setDoc, runTransaction, collection, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // ===== Elements
  const el={
    uname:document.getElementById('uname'), uid:document.getElementById('uid'),
    uregion:document.getElementById('uregion'), udistrict:document.getElementById('udistrict'),
    uschool:document.getElementById('uschool'), uclass:document.getElementById('uclass'),
    urank:document.getElementById('urank'), utier:document.getElementById('utier'),
    scoreVal:document.getElementById('scoreVal'),
    ava:document.getElementById('ava'), signin:document.getElementById('signin'),
    signout:document.getElementById('signout'), editProfile:document.getElementById('editProfile'),
    banners:document.getElementById('banners'),
    boardList:document.getElementById('boardList'), decilePrev:document.getElementById('decilePrev'),
    decileNext:document.getElementById('decileNext'), decileInfo:document.getElementById('decileInfo'),
    userTierStars:document.getElementById('userTierStars'), userStarsPts:document.getElementById('userStarsPts')
  };

  // ===== Modal
  const PM={
    mask:document.getElementById('profileModal'),
    first:document.getElementById('pFirst'), last:document.getElementById('pLast'),
    region:document.getElementById('pRegion'), district:document.getElementById('pDistrict'),
    school:document.getElementById('pSchool'), klass:document.getElementById('pClass'),
    phone:document.getElementById('pPhone'), err:document.getElementById('pError'),
    save:document.getElementById('pSave'), close:document.getElementById('pClose'),
  };
  const showModal=()=>{PM.err.textContent='';PM.mask.style.display='flex';document.body.style.overflow='hidden'};
  const hideModal=()=>{PM.mask.style.display='none';document.body.style.overflow='auto'};
  PM.close.onclick=hideModal; window.addEventListener('keydown',e=>{if(e.key==='Escape')hideModal()});

  // ===== Utils
  function initials(n){ if(!n) return 'LM'; const p=n.trim().split(/\s+/); return (p[0]?.[0]||'L')+(p[1]?.[0]||'M'); }
  function profileIsComplete(u){ return !!(u && u.name && /\s/.test(u.name) && u.region && u.district && u.school && u.class && u.phone); }
  const esc=s=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const fmtPts=v=>(Number(v)||0).toLocaleString('uz-UZ',{maximumFractionDigits:1});

  // ===== Stars / Diamonds
  const GROUPS=[
    {label:'10‚Äì1 (Diamond)',start:1,end:10,tier:'diamond',grad:['#9FE3FF','#39B6FF','#0077FF']},
    {label:'20‚Äì11 (Emerald)',start:11,end:20,tier:'emerald',grad:['#8FE3B0','#2E8B57','#1F6B45']},
    {label:'30‚Äì21 (Gold)',start:21,end:30,tier:'gold',grad:['#FFE082','#FFC107','#FF8F00']},
    {label:'40‚Äì31 (Silver)',start:31,end:40,tier:'silver',grad:['#DDE3EC','#BFC6D4','#9AA6B2']},
    {label:'50‚Äì41 (Bronze)',start:41,end:50,tier:'bronze',grad:['#C69462','#9A6B3F','#7C4F2E']}
  ];
  function iconSVG(shape,fillPct,colors){
    const [c1,c2,c3]=colors, gid='g'+Math.random().toString(36).slice(2,7), cid='c'+Math.random().toString(36).slice(2,7);
    if(shape!=='diamond'){ const p='M12 2.3l2.9 5.9 6.5.9-4.7 4.5 1.1 6.4L12 17.8l-5.8 3.1 1.1-6.4L2.6 9.1l6.5-.9L12 2.3z';
      return `<svg viewBox="0 0 24 24"><defs><linearGradient id="${gid}" x1="0" x2="1"><stop offset="0%" stop-color="${c1}"/><stop offset="50%" stop-color="${c2}"/><stop offset="100%" stop-color="${c3}"/></linearGradient><clipPath id="${cid}"><rect x="0" y="0" width="${fillPct}%" height="100%"/></clipPath></defs><path d="${p}" fill="#d0dbd5"/><path d="${p}" fill="url(#${gid})" clip-path="url(#${cid})"/></svg>`; }
    return `<svg viewBox="0 0 24 24"><defs><linearGradient id="${gid}" x1="0" x2="1"><stop offset="0%" stop-color="${c1}"/><stop offset="50%" stop-color="${c2}"/><stop offset="100%" stop-color="${c3}"/></linearGradient><clipPath id="${cid}"><rect x="0" y="0" width="${fillPct}%" height="100%"/></clipPath></defs><path d="M12 2 L20.5 8.5 L12 22 L3.5 8.5 Z" fill="#cfe8ff"/><path d="M12 2 L20.5 8.5 L12 22 L3.5 8.5 Z" fill="url(#${gid})" clip-path="url(#${cid})"/></svg>`;
  }
  function renderStars(count,tier){
    const g=GROUPS.find(x=>x.tier===tier)||GROUPS[0], shape=(tier==='diamond')?'diamond':'star';
    const full=Math.floor(count), half=(count-full>=.5)?1:0, empty=5-full-half;
    const fullI=iconSVG(shape,100,g.grad), halfI=iconSVG(shape,50,g.grad), emptyI=iconSVG(shape,0,g.grad);
    return `<span class="stars">${Array.from({length:full}).map(()=>fullI).join('')}${half?halfI:''}${Array.from({length:empty}).map(()=>emptyI).join('')}</span>`;
  }

  // ===== Board (short)
  let CURRENT_DECILE=0, latestUsers=[], currentUserId=null, CURRENT_PROFILE=null;
  function drawDecile(users,ix){
    const g=GROUPS[ix]; if(!g){document.getElementById('boardList').innerHTML='';return}
    const arr=users.slice(0,50), pos=rank=>g.end-rank+1, starsFor=rank=>0.5*pos(rank);
    const rows=[];
    for(let r=g.start;r<=g.end;r++){
      const u=arr[r-1]; if(!u) continue;
      rows.push(`<div class="rank tier-${g.tier}">
        <div><span class="rnk">#${r}</span></div>
        <div><b>${esc(u.name||'Foydalanuvchi')}</b><div style="font-size:12px;color:var(--muted)">${esc(u.region||'‚Äî')} ¬∑ ${esc(u.district||'‚Äî')} ¬∑ ${esc(u.school||'‚Äî')}</div></div>
        <div style="text-align:right"><b>${fmtPts(u.points)}</b><div>${renderStars(starsFor(r),g.tier)}</div></div>
      </div>`);
    }
    document.getElementById('boardList').innerHTML=
      `<div class="group"><div class="groupHead"><span class="tier-badge">${g.label}</span><span style="opacity:.85">${renderStars(3,g.tier)}</span></div><div style="padding:10px">${rows.join('')}</div></div>`;
    document.getElementById('decileInfo').textContent=g.label;
  }

  const TIER_NAME={diamond:'Olmos',emerald:'Zumrad',gold:'Oltin',silver:'Kumush',bronze:'Bronza'};
  function updateUserbarRank(sorted,uid){
    const idx=sorted.findIndex(u=>(u.uid||u.id)===uid);
    if(idx===-1){ el.userTierStars.innerHTML=''; el.userStarsPts.innerHTML=''; el.urank.textContent='O‚Äòrin: ‚Äî'; el.utier.textContent='Daraja: ‚Äî'; return; }
    const rank=idx+1; let g=null; for(const gr of GROUPS){ if(rank>=gr.start&&rank<=gr.end){ g=gr; break; } }
    const stars=0.5*(g.end-rank+1); const html=renderStars(stars,g.tier);
    el.userTierStars.innerHTML=html; el.userStarsPts.innerHTML=html;
    el.urank.textContent=`O‚Äòrin: #${rank}`;
    el.utier.textContent=`Daraja: ${TIER_NAME[g.tier]} ${stars.toFixed(1)}/5`;
  }

  // ===== Profile modal open/save
  function openProfileModal(pref={}){ PM.first.value=pref.first||''; PM.last.value=pref.last||''; PM.region.value=pref.region||''; PM.district.value=pref.district||''; PM.school.value=pref.school||''; PM.klass.value=pref.klass||''; PM.phone.value=pref.phone||''; showModal(); }
  PM.save.onclick=async()=>{
    const first=PM.first.value.trim(), last=PM.last.value.trim(),
      region=PM.region.value.trim(), district=PM.district.value.trim(),
      school=PM.school.value.trim(), klass=PM.klass.value.trim(), phone=PM.phone.value.trim();
    if(!first||!last||!region||!district||!school||!klass||!phone){PM.err.textContent='Barcha maydonlar majburiy.';return}
    const name=`${first} ${last}`;
    try{
      const ref=doc(db,'users',currentUserId);
      await setDoc(ref,{name,region,district,school,class:klass,phone},{merge:true});
      el.uname.textContent=name; el.uregion.textContent='Viloyat: '+region; el.udistrict.textContent='Tuman: '+district; el.uschool.textContent='Maktab: '+school; el.uclass.textContent='Sinf: '+klass;
      el.uname.insertAdjacentHTML('beforeend',''); // keep structure
      CURRENT_PROFILE={...(CURRENT_PROFILE||{}),name,region,district,school,class:klass,phone};
      hideModal();
    }catch(e){PM.err.textContent='Saqlashda xatolik.';console.error(e)}
  };

  // ===== Auth
  el.signin.onclick=(e)=>{e.preventDefault(); const ret=encodeURIComponent(location.pathname+location.search+location.hash); location.href=`./login.html?return=${ret}`;}
  el.signout.onclick=async (e)=>{e.preventDefault(); await signOut(auth); location.href='./login.html?return='+encodeURIComponent('./index.html');}
  el.editProfile.onclick=(e)=>{e.preventDefault(); const u=CURRENT_PROFILE||{}; const nm=(u.name||el.uname.textContent).trim().split(/\s+/,2); openProfileModal({first:nm[0]||'', last:nm[1]||'', region:u.region||'', district:u.district||'', school:u.school||'', klass:u.class||'', phone:u.phone||''}); }

  async function ensureUser(user){
    const ref=doc(db,'users',user.uid);
    await runTransaction(db, async(tx)=>{
      const snap=await tx.get(ref);
      if(!snap.exists()){
        tx.set(ref,{name:user.displayName||(user.email?user.email.split('@')[0]:'Foydalanuvchi'),email:user.email||null,photoURL:user.photoURL||null,role:'user',numericId:Math.floor(1000+Math.random()*9000),points:0,region:null,district:null,school:null,class:null,phone:null,createdAt:Date.now()});
      }
    });
    return (await getDoc(ref)).data();
  }

  watchAuth(async(user)=>{
    if(!user){
      el.uname.textContent='Mehmon'; el.uid.textContent='ID: ‚Äî'; el.uregion.textContent='Viloyat: ‚Äî'; el.udistrict.textContent='Tuman: ‚Äî'; el.uschool.textContent='Maktab: ‚Äî'; el.uclass.textContent='Sinf: ‚Äî'; el.urank.textContent='O‚Äòrin: ‚Äî'; el.utier.textContent='Daraja: ‚Äî';
      el.scoreVal.textContent='‚Äî'; el.signin.style.display='inline'; el.signout.style.display='none'; el.editProfile.style.display='none'; el.userTierStars.innerHTML=''; el.userStarsPts.innerHTML=''; el.ava.textContent='LM'; return;
    }
    el.signin.style.display='none'; el.signout.style.display='inline'; currentUserId=user.uid;

    const u=await ensureUser(user); CURRENT_PROFILE=u;
    el.uname.textContent=(u.name || user.displayName || (user.email?.split('@')[0]??'Foydalanuvchi'));
    el.uid.textContent='ID: '+(u.numericId||'‚Äî'); el.uregion.textContent='Viloyat: '+(u.region||'‚Äî'); el.udistrict.textContent='Tuman: '+(u.district||'‚Äî'); el.uschool.textContent='Maktab: '+(u.school||'‚Äî'); el.uclass.textContent='Sinf: '+(u.class||'‚Äî');
    el.scoreVal.textContent=fmtPts(u.points); if(user.photoURL){ el.ava.innerHTML='<img src="'+user.photoURL+'" alt="ava">'; } else { el.ava.textContent=initials(el.uname.textContent); }
    el.editProfile.style.display='inline';

    // Live board
    onSnapshot(query(collection(db,'users'), orderBy('points','desc'), limit(100)), (snap)=>{
      latestUsers=snap.docs.map(d=>({id:d.id,uid:d.id,...d.data()}))
        .sort((a,b)=> (Number(b.points)||0)-(Number(a.points)||0) || (a.numericId??0)-(b.numericId??0));
      drawDecile(latestUsers,CURRENT_DECILE);
      updateUserbarRank(latestUsers,currentUserId);
    });
  });

  // Pager
  document.getElementById('decilePrev').onclick=()=>{ if(CURRENT_DECILE>0){ CURRENT_DECILE--; drawDecile(latestUsers,CURRENT_DECILE); } };
  document.getElementById('decileNext').onclick=()=>{ if(CURRENT_DECILE<GROUPS.length-1){ CURRENT_DECILE++; drawDecile(latestUsers,CURRENT_DECILE); } };

  // Banners (demo)
  (async()=>{ try{ const r=await fetch('./index.json',{cache:'no-store'}); const data=await r.json(); document.getElementById('banners').innerHTML=(data.banners||[]).map(b=>`<div class="banner">${b.html||''}</div>`).join(''); }catch(e){ console.error(e) } })();
</script>
</body>
</html>
