<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"/>
  <title>LeaderMath.UZ ‚Äî Home + Profil (Pro + PWA)</title>

  <meta name="theme-color" content="#2E8B57" id="meta-theme-color"/>
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="icon" href="/logo.png" sizes="192x192">
  <link rel="apple-touch-icon" href="/logo.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

  <style>
  :root{
    --brand:#2E8B57; --brand-2:#1F6B45; --accent:#6B8E23;
    --bg:#F6FAF7; --bg-2:#ECF4EF; --card:#FFFFFF; --card-2:#F9FCFA;
    --text:#0f1b15; --muted:#5f7469; --line:#E3EBE6; --ring:#9dd8ba;
    --shadow:0 30px 80px rgba(18,40,28,.14), 0 6px 20px rgba(18,40,28,.06);
    --shadow-sm:0 10px 30px rgba(18,40,28,.08);
    --radius:18px; --radius-lg:22px; --pill:999px; --speed:.22s;
    --wrap: clamp(1200px, 96vw, 1760px);
    --vh: 1vh; --top-gap: 118px;
  }
  :root.dark{
    --bg:#0f1512; --bg-2:#0b110e; --card:#0f1a15; --card-2:#122019;
    --text:#EAF7EE; --muted:#A7C4B3; --line:#254234; --ring:#3aa177;
    --shadow:0 26px 70px rgba(0,0,0,.45), 0 6px 14px rgba(0,0,0,.35);
    --shadow-sm:0 10px 22px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font:16px/1.55 system-ui,Segoe UI,Inter,Arial;
    background:
      radial-gradient(1100px 540px at 15% -10%, color-mix(in srgb, var(--brand) 10%, transparent) 0, #0000 60%),
      radial-gradient(1200px 580px at 115% 10%, color-mix(in srgb, var(--accent) 10%, transparent) 0, #0000 60%),
      linear-gradient(180deg,var(--bg),var(--bg-2));
    -webkit-tap-highlight-color:transparent;
  }
  body.no-scroll{ overflow:hidden }

  /* eni qirqilmasin */
  body, main, #app { overflow-x: hidden; }
  .row, .chipbar, .section, .inner, .ratio, .page-full { min-width: 0; }

  /* ===== HEADER ===== */
  .hdr{position:sticky; top:0; z-index:100;
    border-bottom:1px solid color-mix(in srgb,var(--line) 72%, transparent);
    backdrop-filter:saturate(1.1) blur(10px);
    background:linear-gradient(180deg, color-mix(in srgb, var(--card) 88%, transparent), transparent)}
  .row{max-width:var(--wrap); margin:0 auto; padding:10px 16px; display:flex; gap:14px; align-items:center}
  .brand{display:flex;align-items:center;gap:12px;font-weight:900;letter-spacing:.2px}
  .brand .logo{width:50px;height:50px;border-radius:14px;display:grid;place-items:center;overflow:hidden;box-shadow:0 10px 30px rgba(46,139,87,.25);background:#fff}
  :root.dark .brand .logo{background:#fff}
  .brand img{width:40px;height:40px;display:block}
  .brand .t{display:grid;line-height:1.05}
  .brand .t .n{font-size:18px}
  .brand .t .n b{color:var(--brand)}
  .brand .t small{color:var(--muted)}
  .grow{flex:1}

  .chipbar-wrap{ position:sticky; top:62px; z-index:90;
    border-bottom:1px solid color-mix(in srgb,var(--line) 58%, transparent);
    backdrop-filter:saturate(1.06) blur(6px);
    background:linear-gradient(180deg, color-mix(in srgb, var(--card) 74%, transparent), transparent);
  }
  .chipbar{ max-width:var(--wrap); margin:0 auto; padding:8px 16px 12px; display:flex; gap:10px; overflow:auto hidden; -webkit-overflow-scrolling:touch; scroll-behavior:smooth }
  .chipbar::-webkit-scrollbar{display:none} .chipbar{scrollbar-width:none}
  .chip{appearance:none;border:1px solid var(--line);background:linear-gradient(180deg,var(--card-2),var(--card));
    border-radius:999px;padding:10px 15px;font-weight:800;cursor:pointer;white-space:nowrap;
    box-shadow:var(--shadow-sm);transition:transform var(--speed), box-shadow var(--speed), background var(--speed)}
  .chip:hover{transform:translateY(-1px)}
  .chip.active{color:#fff;border-color:transparent;background:linear-gradient(180deg, color-mix(in srgb, var(--brand) 90%, #fff), var(--brand-2)); box-shadow:0 12px 30px color-mix(in srgb, var(--brand) 35%, transparent)}

  /* ===== HERO ===== */
  .hero{position:fixed; left:0; right:0; top:calc(var(--top-gap) - 12px); height:calc(var(--vh) * 42); z-index:40; overflow:hidden}
  @media (max-width:900px){ .hero{height:calc(var(--vh) * 50)} }
  .hero .rail{position:absolute; inset:0; display:flex; transition:transform .6s ease}
  .hero .slide{flex:0 0 100%; position:relative}
  .hero iframe{position:absolute; inset:0; width:100%; height:100%; border:0; display:block; background:transparent}
  .hero .nav{position:absolute; top:50%; transform:translateY(-50%); border:0; width:38px; height:38px; border-radius:50%;
    background:color-mix(in srgb, var(--card) 82%, transparent); box-shadow:var(--shadow-sm); cursor:pointer; z-index:10}
  .hero .nav.prev{left:10px} .hero .nav.next{right:10px}
  .hero .dots{position:absolute; bottom:10px; left:0; right:0; display:flex; justify-content:center; gap:10px}
  .hero .dot{width:10px;height:10px;border-radius:50%;background:color-mix(in srgb,#fff 60%, var(--brand)); opacity:.6; cursor:pointer}
  .hero .dot.active{opacity:1; background:var(--brand)}

  /* ===== MAIN ===== */
  main{max-width:var(--wrap); margin:0 auto; padding:calc(var(--vh) * 42 + 12px) 16px 64px}
  .section{ background:linear-gradient(180deg,var(--card),var(--card-2)); border:1px solid var(--line); border-radius:var(--radius-lg);
    box-shadow:var(--shadow); overflow:hidden; margin-bottom:14px; transition:transform var(--speed)}
  .section:hover{transform:translateY(-2px)}
  .section-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
  .section-hdr h3{margin:0;font-size:18px}
  .inner{padding:12px}

  .section.fullbleed{ margin-left:calc(50% - 50vw); margin-right:calc(50% - 50vw); border-radius:0; border-left:0; border-right:0 }
  .section.wide{ max-width:var(--wrap); margin-left:auto; margin-right:auto }

  .ratio{position:relative;border:1px solid var(--line);border-radius:16px;overflow:hidden;background:#fff}
  .ratio[data-r="16-9"]::before{content:"";display:block;padding-top:56.25%}
  @media (max-width:640px){ .ratio[data-r="16-9"]::before{ padding-top:177.78% } }
  .ratio>iframe,.ratio>img{position:absolute;inset:0;width:100%;height:100%;border:0;object-fit:cover}

  /* ===== PAGE (standart va takeover) ===== */
  .page-full{position:relative;height:calc(var(--vh) * 80); border:1px solid var(--line); border-radius:16px; overflow:hidden; background:#fff}
  .page-full > iframe{position:absolute; inset:0; width:100%; height:100%; border:0}

  /* TO'LIQ TANANI EGA LLASH (takeover) */
  body.takeover .hdr,
  body.takeover #hero,
  body.takeover .chipbar-wrap{ display:none !important; }
  body.takeover main{ max-width:100vw; padding:0 !important; }

  .takeover-host{
    position:fixed; inset:0;
    width:100vw; height:100dvh;
    background:#fff; z-index:50;   /* header/hero dan yuqori */
  }
  .takeover-host > iframe{
    position:absolute; inset:0; width:100%; height:100%; border:0;
  }

  /* GRID */
  .grid{ --cols:1; display:grid; gap:16px; grid-template-columns:repeat(var(--cols), minmax(0,1fr)) }
  @media (min-width:560px){ .grid{ --cols:2 } }
  @media (min-width:900px){ .grid{ --cols:3 } }
  @media (min-width:1200px){ .grid{ --cols:4 } }
  @media (min-width:1440px){ .grid{ --cols:5 } }
  @media (min-width:1680px){ .grid{ --cols:6 } }

  .cardX{ border:1px solid var(--line); background:linear-gradient(180deg,var(--card),var(--card-2));
    border-radius:16px; padding:14px; display:flex; flex-direction:column; gap:12px; box-shadow:var(--shadow-sm);
    transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease; min-width:220px }
  .cardX:hover{ transform:translateY(-2px); border-color:color-mix(in srgb, var(--brand) 35%, var(--line)); box-shadow:0 18px 40px rgba(46,139,87,.12) }
  .cardX h4{margin:0;font-size:16px}
  .rowflex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .thumb{width:100%;border-radius:12px;border:1px solid var(--line);object-fit:cover;aspect-ratio:16/9;background:#f6faf7}

  .badge{padding:4px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#f0f7f3}
  .badge.soon{background:#fff8e5;border-color:#f2d48a}
  .badge.active{background:#eaf6ef;border-color:#84d1a8}
  .badge.ended{background:#f5f5f5}

  .filters{display:flex;gap:8px;flex-wrap:wrap;padding:12px}
  .fchip{appearance:none;border:1px solid var(--line);background:var(--card);border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:800}
  .fchip.active{background:var(--brand);color:#fff;border-color:transparent}

  .userchip{border:1px solid var(--line);background:linear-gradient(180deg,var(--card),var(--card-2));
    padding:6px 10px;border-radius:999px;box-shadow:var(--shadow-sm);display:flex;align-items:center;gap:10px;cursor:pointer}
  .avatar{width:34px;height:34px;border-radius:50%;overflow:hidden;background:linear-gradient(135deg,#dcefe5,#f1faf5)}
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .menu{ position:fixed; min-width:280px; background:linear-gradient(180deg,var(--card),var(--card-2));
    border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow); display:none; overflow:hidden; z-index:1000 }
  .menu.open{display:block}
  .menu a{ display:flex;align-items:center;gap:10px;padding:12px 14px;text-decoration:none;color:inherit;
    border-bottom:1px solid color-mix(in srgb,var(--line) 80%, transparent);
    transition: transform .18s ease, background .18s ease, box-shadow .18s ease; will-change: transform; }
  .menu a:last-child{border-bottom:none}
  .menu a:hover{ background:color-mix(in srgb, var(--brand) 12%, transparent); transform:translateX(3px);
    box-shadow:inset 0 0 0 1px color-mix(in srgb, var(--brand) 40%, transparent); }
  .menu .label{padding:8px 14px;font-size:12px;color:var(--muted);border-bottom:1px solid var(--line);
    background:color-mix(in srgb,var(--card) 60%, transparent)}

  .overlay{ position:fixed; inset:0; display:none; place-items:center; z-index:110;
    background:color-mix(in srgb, #000 18%, transparent); backdrop-filter:saturate(1.1) blur(8px); opacity:0; transition:opacity .2s ease }
  .overlay.show{ display:grid; opacity:1 }
  .panel{ width:min(920px,96vw); max-height:92vh; overflow:auto; background:linear-gradient(180deg, color-mix(in srgb, var(--card) 92%, #fff), var(--card));
    border:1px solid color-mix(in srgb, var(--line) 80%, transparent); border-radius:22px; box-shadow:var(--shadow); padding:22px; animation:pop .18s ease }
  @keyframes pop{ from{ transform:scale(.98); opacity:.6 } to{ transform:scale(1); opacity:1 } }

  .btn{appearance:none;border:1px solid var(--line);background:linear-gradient(180deg,var(--card),var(--card-2));
    padding:12px 16px;border-radius:14px;cursor:pointer;font-weight:900}
  .btn.primary{background:linear-gradient(180deg, #7fd1a5, var(--brand));color:#fff;border-color:transparent}
  .btn[disabled]{opacity:.6;cursor:not-allowed}

  .fld{display:grid;gap:8px;margin:10px 0}
  .fld input,.fld select{width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--line);
    background:linear-gradient(180deg,var(--card),color-mix(in srgb,var(--card) 92%,#000)); color:inherit}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  @media (max-width:900px){.grid2{grid-template-columns:1fr}}
  .mini{font-size:12px;color:var(--muted)}
  .divider{height:1px;background:var(--line);margin:12px 0}
  .toasts{position:fixed;right:16px;bottom:16px;display:grid;gap:10px;z-index:1200;max-width:min(360px,90vw)}
  .toast{display:flex;align-items:flex-start;gap:10px;padding:12px 14px;border-radius:14px;border:1px solid var(--line);
         box-shadow:var(--shadow-sm);background:linear-gradient(180deg,var(--card),var(--card-2));animation:slideIn .2s ease}
  .toast.success{border-color:#9edfae} .toast.error{border-color:#f2b4ac} .toast.info{border-color:#b9d9ff}
  .toast .t{font-weight:700} .toast .x{margin-left:auto;border:0;background:transparent;cursor:pointer;font-weight:900}
  @keyframes slideIn{from{transform:translateY(8px);opacity:.001}to{transform:translateY(0);opacity:1}}

  .install-wrap{position:sticky;top:0;z-index:9999;display:none}
  .install-banner{margin:0; padding:10px 14px; display:flex; gap:10px; align-items:center; justify-content:space-between;
    background:linear-gradient(180deg, color-mix(in srgb, var(--card, #fff) 94%, #fff), var(--card, #fff));
    border-bottom:1px solid color-mix(in srgb, var(--line, #dfe7e2) 80%, transparent);
    box-shadow:0 10px 30px rgba(0,0,0,.06)}
  .install-banner .txt{display:flex; gap:10px; align-items:center; font-weight:700}
  .install-banner .txt .ico{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;background:var(--brand, #2E8B57); color:#fff; font-size:16px}
  .install-actions{display:flex; gap:8px; align-items:center}
  .install-btn{padding:8px 12px;border:1px solid var(--line, #dfe7e2);border-radius:10px;background:#fff;cursor:pointer;font-weight:800}
  .install-btn.primary{background:var(--brand, #2E8B57);color:#fff;border-color:var(--brand, #2E8B57)}
  .install-x{appearance:none;background:transparent;border:0;font-size:18px;line-height:1;cursor:pointer;color:#777}
  @media (max-width:560px){ .install-banner{padding:8px 10px} .install-banner .txt b{font-size:14px} }

  .fullheight { position: relative; width: 100%; height: calc(100vh - var(--top-gap)); min-height: 480px;
    border: 1px solid var(--line); border-radius: 16px; overflow: hidden; background: #fff; }
  .fullheight > iframe { position:absolute; inset:0; width:100%; height:100%; border:0; }
  @supports (height: 100dvh){ .fullheight { height: calc(100dvh - var(--top-gap)); } }
  </style>
</head>
<body>

<div id="installWrap" class="install-wrap" role="region" aria-label="O‚Äòrnatish taklifi">
  <div class="install-banner">
    <div class="txt"><span class="ico">‚¨áÔ∏è</span><div><b>LeaderMath‚Äôni o‚Äòrnatib oling</b><div class="mini" style="color:var(--muted,#5f7469)">Offline, tez kirish va to‚Äòliq ekran</div></div></div>
    <div class="install-actions">
      <button id="btnInstallNow" class="install-btn primary">O‚Äòrnatish</button>
      <button id="btnInstallLater" class="install-btn">Keyinroq</button>
      <button id="btnInstallClose" class="install-x" aria-label="Yopish">‚úï</button>
    </div>
  </div>
</div>

<header class="hdr" id="hdr">
  <div class="row">
    <div class="brand">
      <span class="logo"><img src="/logo.png" alt="LM"></span>
      <span class="t"><span class="n">LeaderMath.<b>UZ</b></span><small>Matematika platformasi</small></span>
    </div>
    <div class="grow"></div>
    <div id="user-slot"></div>
  </div>
  <div class="chipbar-wrap" id="chipwrap"><nav id="chipbar" class="chipbar" aria-label="Bo'limlar"></nav></div>
</header>

<section id="hero" class="hero" aria-label="Bannerlar">
  <div class="rail" id="heroRail"></div>
  <button class="nav prev" id="heroPrev" aria-label="Oldingi">‚Äπ</button>
  <button class="nav next" id="heroNext" aria-label="Keyingi">‚Ä∫</button>
  <div class="dots" id="heroDots"></div>
</section>

<main id="app"><div id="sections"></div></main>

<!-- takeover joyi -->
<div id="takeover" class="takeover-host" style="display:none"></div>

<div id="overlay" class="overlay" aria-modal="true"></div>
<div id="portal-root"></div>
<div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>

<script>
(() => {
  const wrap = document.getElementById('installWrap');
  const btnNow = document.getElementById('btnInstallNow');
  const btnLater = document.getElementById('btnInstallLater');
  const btnClose = document.getElementById('btnInstallClose');
  const DISMISS_KEY = 'lm_install_dismiss_until';
  let deferredPrompt = null;
  const isStandalone = () =>
    window.matchMedia('(display-mode: standalone)').matches ||
    window.navigator.standalone === true;
  const show = () => (wrap.style.display = 'block');
  const hide = () => (wrap.style.display = 'none');
  const snooze = (days=7)=>localStorage.setItem(DISMISS_KEY, Date.now()+days*864e5);
  const snoozed = ()=>Number(localStorage.getItem(DISMISS_KEY)||0)>Date.now();
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);

  if (isStandalone()) hide();
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault(); deferredPrompt = e;
    if (isStandalone() || snoozed()) return;
    btnNow.onclick = async () => {
      hide(); deferredPrompt?.prompt();
      const choice = await deferredPrompt?.userChoice; deferredPrompt = null;
      if (!choice || choice.outcome !== 'accepted') snooze(7);
    };
    btnLater.onclick = ()=>{ hide(); snooze(3); };
    btnClose.onclick = ()=>{ hide(); snooze(14); };
    show();
  });
  if (!('BeforeInstallPromptEvent' in window) && isIOS && !isStandalone() && !snoozed()){
    document.querySelector('.install-banner .txt div').innerHTML =
      '<b>Home Screen‚Äôga qo‚Äòshing</b><div class="mini" style="color:var(--muted,#5f7469)">Safari‚Äôda <b>Share</b> ‚Üí <b>Add to Home Screen</b></div>';
    btnNow.textContent='Tushunarli';
    btnNow.onclick = ()=>{ hide(); snooze(7); };
    btnLater.onclick = ()=>{ hide(); snooze(3); };
    btnClose.onclick = ()=>{ hide(); snooze(14); };
    show();
  }
  window.addEventListener('appinstalled', ()=>{ hide(); localStorage.removeItem(DISMISS_KEY); });
})();
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, setPersistence, browserLocalPersistence, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getStorage, ref as sRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
    authDomain: "xplusy-760fa.firebaseapp.com",
    projectId: "xplusy-760fa",
    storageBucket: "xplusy-760fa.appspot.com",
    messagingSenderId: "992512966017",
    appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
    measurementId: "G-459PLJ7P7L"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const st   = getStorage(app);
  try{ await setPersistence(auth, browserLocalPersistence); }catch{}

  const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>[...r.querySelectorAll(s)];
  function toast(msg,type='info',timeout=3500){ const host=$('#toasts'); if(!host) return; const el=document.createElement('div'); el.className='toast '+type; el.innerHTML=`<span class="t">${type==='error'?'‚ùå':type==='success'?'‚úÖ':'‚ÑπÔ∏è'}</span><div>${msg}</div><button class="x" aria-label="Yopish">√ó</button>`; const remove=()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(),200); }; el.querySelector('.x').onclick=remove; host.appendChild(el); setTimeout(remove, timeout); }
  const NEED=["firstName","lastName","birthDate","region","district","role"]; let REGIONS=[]; let CURRENT_USER=null; let PROFILE=null; let USER_POINTS=0;

  const setVH=()=>document.documentElement.style.setProperty('--vh', `${innerHeight*0.01}px`);
  const updateGaps=()=>document.documentElement.style.setProperty('--top-gap', (($('#hdr')?.getBoundingClientRect().height||0)+($('#chipwrap')?.getBoundingClientRect().height||0))+"px");
  setVH(); updateGaps();
  addEventListener('resize', ()=>{ setVH(); updateGaps(); });
  addEventListener('orientationchange', ()=>{ setVH(); updateGaps(); });
  addEventListener('load', updateGaps);
  document.fonts?.ready?.then?.(updateGaps);

  const calcAge=iso=>{ try{ const b=new Date(iso), t=new Date(); let a=t.getFullYear()-b.getFullYear(); const m=t.getMonth()-b.getMonth(); if(m<0||(m==0&&t.getDate()<b.getDate())) a--; return a; }catch{return ''} };

  async function getProfile(uid){ const s=await getDoc(doc(db,'profiles',uid)); return s.exists()?s.data():null; }
  async function saveProfile(uid,data){ data.updatedAt=serverTimestamp(); if(!PROFILE) data.createdAt=serverTimestamp(); await setDoc(doc(db,'profiles',uid),data,{merge:false}); PROFILE=data; }
  async function getUserPoints(uid){ try{ const s=await getDoc(doc(db,'users',uid)); return s.exists()?(s.data().points||0):0; }catch{return 0;} }

  async function loadRegions(){
    try{ const r=await fetch('./region.json',{cache:'no-store'}); if(!r.ok) throw 0; const j=await r.json(); return j?.regions||[]; }
    catch{ return [{name:"Toshkent",districts:[{name:"Chilonzor",schools:["1-maktab","12-maktab"]},{name:"Olmazor",schools:["5-maktab","14-maktab"]}]},{name:"Samarqand",districts:[{name:"Urgut",schools:["3-maktab","28-maktab"]}]}]; }
  }

  const parseLocal=(s)=>{ if(!s) return null; const m=s.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/); if(!m) return null; const [,Y,M,D,h,mn]=m; return new Date(+Y,+M-1,+D,+h,+mn,0,0); };
  const activeByTime=(b)=>{ const now=new Date(); const s=parseLocal(b.startAt), e=parseLocal(b.endAt); if(s&&now<s) return false; if(e&&now>e) return false; return true; };

  function frameFrom(bLike, baseHref=null, opts={}){
    const isPage = !!opts.isPage;
    const f=document.createElement('iframe');
    f.setAttribute('sandbox', bLike.sandbox || 'allow-scripts allow-forms allow-same-origin');
    if (isPage) f.removeAttribute('scrolling'); else f.setAttribute('scrolling','no');
    f.style.border='0'; f.style.width='100%'; f.style.height='100%';
    if(bLike.mode==='url'){ f.src=bLike.src||''; }
    else{
      const base=bLike.baseHref||baseHref||'';
      const containCSS = `<style>html,body{height:100%;margin:0;overflow:auto;background:transparent}</style>`;
      const html = `<!doctype html><html><head>${base?`<base href="${base}">`:''}<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">${containCSS}</head><body>${String(bLike.contentHtml||'')}</body></html>`;
      f.srcdoc=html;
    }
    return f;
  }

  /* ===== HERO ===== */
  const HERO={ list:[], i:0, t:null };
  function heroRender(list){ const rail=$('#heroRail'), dots=$('#heroDots'); rail.innerHTML=''; dots.innerHTML=''; if(!list.length){ $('#hero').style.display='none'; return; } $('#hero').style.display='block'; HERO.list=list; HERO.i=0;
    list.forEach((b,idx)=>{ const s=document.createElement('div'); s.className='slide'; s.appendChild(frameFrom(b)); rail.appendChild(s);
      const d=document.createElement('div'); d.className='dot'+(idx===0?' active':''); d.onclick=()=>heroGo(idx); dots.appendChild(d);
    });
    $('#heroPrev').onclick=()=>heroGo(HERO.i-1); $('#heroNext').onclick=()=>heroGo(HERO.i+1);
    heroPlay(); rail.addEventListener('mouseenter', heroStop); rail.addEventListener('mouseleave', heroPlay);
  }
  function heroGo(n){ if(!HERO.list.length) return; const L=HERO.list.length; HERO.i=(n%L+L)%L; $('#heroRail').style.transform=`translateX(-${HERO.i*100}%)`; $$('.dot').forEach((d,k)=>d.classList.toggle('active',k===HERO.i)); heroStop(); heroPlay(); }
  function heroPlay(){ heroStop(); if(HERO.list.length>1) HERO.t=setInterval(()=>heroGo(HERO.i+1), 5000); }
  function heroStop(){ if(HERO.t){ clearInterval(HERO.t); HERO.t=null; } }

  async function fetchHome(){
    try{ const s=await getDoc(doc(db,'configs','home')); if(s.exists()){ const d=s.data(); if(Array.isArray(d.sections)) return d; }
    }catch{} return {sections:[]};
  }

  const HSTATE={ sections:[], activeId:null };
  const ORDER={active:0, soon:1, available:2, ended:3};
  const fmt=(d)=>!d?'-':`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  const parseLocal2=(s)=>parseLocal(s);
  const cardState=(it)=>{ if(it.cardStyle==='soon') return 'soon'; if(it.cardStyle==='timed'){ const now=new Date(), s=parseLocal2(it.startAt), e=parseLocal2(it.endAt); if(s&&now<s) return 'soon'; if(s&&e&&now>=s&&now<=e) return 'active'; if(e&&now>e) return 'ended'; return 'active'; } return 'available'; };

  function renderFilters(){ const w=document.createElement('div'); w.className='filters'; const opts=[["all","Barchasi"],["active","Faol"],["soon","Yaqinda"],["available","Mavjud"],["ended","Tugagan"]]; const chips=opts.map(([k,l])=>{ const b=document.createElement('button'); b.className='fchip'+(k==='all'?' active':''); b.dataset.f=k; b.textContent=l; b.onclick=()=>{ chips.forEach(x=>x.classList.toggle('active',x===b)); w.onChange && w.onChange(k); }; w.appendChild(b); return b; }); w.onChange=null; return w; }
  const applyFilter=(grid,key)=>$$('.cardX',grid).forEach(c=>{ const st=c.dataset.state||'available'; c.style.display=(key==='all'||st===key)?'flex':'none'; });
  const sortCards=(arr)=>[...arr].sort((a,b)=>{ const sa=cardState(a), sb=cardState(b); const oa=(ORDER[sa]??9), ob=(ORDER[sb]??9); if(oa!==ob) return oa-ob; const as=parseLocal2(a.startAt)?.getTime()||0, bs=parseLocal2(b.startAt)?.getTime()||0; return as-bs; });

  function renderBannerUnit(b, baseHref=null){ const r=document.createElement('div'); r.className='ratio'; r.dataset.r='16-9'; r.appendChild(frameFrom(b, baseHref)); return r; }
  function renderCarousel(banners, baseHref=null, interval=4500){
    const vp=document.createElement('div'); vp.className='ratio'; vp.dataset.r='16-9';
    const rail=document.createElement('div'); rail.style.cssText='position:absolute;inset:0;display:grid;grid-auto-flow:column;grid-auto-columns:100%;transition:transform .6s ease;'; vp.appendChild(rail);
    const frames=banners.map(b=>{ const h=document.createElement('div'); h.style.cssText='position:relative;width:100%;height:100%'; const fr=frameFrom(b, baseHref); fr.style.cssText='position:absolute;inset:0;width:100%;height:100%'; h.appendChild(fr); rail.appendChild(h); return h; });
    let i=0, t=null; const go=n=>{ i=(n+frames.length)%frames.length; rail.style.transform=`translateX(-${i*100}%)`; };
    const play=()=>{ stop(); if(frames.length>1) t=setInterval(()=>go(i+1), interval); };
    const stop=()=>{ if(t){ clearInterval(t); t=null; } };
    vp.addEventListener('pointerenter', stop); vp.addEventListener('pointerleave', play); play(); return vp;
  }

  /* ====== PAGE ====== */
  function renderPageUnit(page, baseHref=null){
    const like={ mode:page.mode||'url', src:page.src||'', contentHtml:page.contentHtml||'', baseHref:page.baseHref||baseHref||'', sandbox:page.sandbox||'allow-scripts allow-forms allow-same-origin', fit:page.fit||'cover' };
    if(page.takeover){   // <<<< to'liq tanani egallash
      const host = $('#takeover'); host.innerHTML='';
      host.appendChild(frameFrom(like, null, {isPage:true}));
      return host;
    }
    if(page.fullHeight){
      const box=document.createElement('div'); box.className='page-full';
      box.appendChild(frameFrom(like, null, {isPage:true})); return box;
    }
    const r=document.createElement('div'); r.className='ratio'; r.dataset.r='16-9';
    r.appendChild(frameFrom(like, null, {isPage:true})); return r;
  }

  function cardView(it){
    const c=document.createElement('div'); c.className='cardX';
    const st=cardState(it); c.dataset.state=st;

    const row=document.createElement('div'); row.className='rowflex';
    const h=document.createElement('h4'); h.textContent=it.title||'Card'; row.appendChild(h);
    const bd=document.createElement('span'); bd.className='badge '+(st==='soon'?'soon':st==='active'?'active':st==='ended'?'ended':''); bd.textContent=(st==='soon'?'Yaqinda':st==='active'?'Faol':st==='ended'?'Tugagan':'Mavjud'); row.appendChild(bd);
    c.appendChild(row);

    if(it.imageUrl){ const img=document.createElement('img'); img.className='thumb'; img.loading='lazy'; img.src=it.imageUrl; c.appendChild(img); }
    if(it.cardStyle==='timed'){ const s=parseLocal2(it.startAt), e=parseLocal2(it.endAt); const t=document.createElement('div'); t.className='mini'; t.textContent=`Vaqt: ${fmt(s)} ‚Äî ${fmt(e)}`; c.appendChild(t); }

    const act=document.createElement('div'); act.className='rowflex';
    const info=document.createElement('button'); info.className='btn'; info.textContent='‚ÑπÔ∏è Info';
    info.onclick=()=> showOverlay(`<div class="panel"><div style="display:flex;justify-content:space-between;align-items:center"><b>${it.title||'Ma ºlumot'}</b><button class="btn" onclick="closeOverlay()">Yopish</button></div><div class="divider"></div>${it.infoHtml||'<p class=mini>Ma ºlumot yo ªq.</p>'}</div>`);
    act.appendChild(info);

    const go=document.createElement('a'); go.className='btn primary'; go.textContent=it.ctaLabel||'Boshlash';
    if(st==='active' && it.ctaHref){ go.href=it.ctaHref; go.target='_blank'; }
    else { go.classList.remove('primary'); go.setAttribute('disabled',''); }
    act.appendChild(go);

    c.appendChild(act);
    return c;
  }

  function renderSection(sec){
    const id = sec.id || (crypto.randomUUID ? crypto.randomUUID() : 'sec');
    const outer=document.createElement('section');
    outer.className='section';
    if (sec.fullBleed === true) outer.classList.add('fullbleed');
    if (sec.fullBleed === 'wide') outer.classList.add('wide');
    outer.dataset.section=id;

    const sh=document.createElement('div'); sh.className='section-hdr'; sh.innerHTML=`<h3>${sec.title||id}</h3>`; outer.appendChild(sh);
    const inner=document.createElement('div'); inner.className='inner';

    if(sec.page && sec.page.enabled){
      const view = renderPageUnit(sec.page, sec.baseHref);
      if(sec.page.takeover){
        // Takeover hostni DOMga yuqorida bor ‚Äî bu yerda faqat placeholder
        inner.appendChild(document.createComment('takeover mode'));
      }else{
        inner.appendChild(view);
      }
    }

    const banners=Array.isArray(sec.banners)?sec.banners:[];
    const cards=Array.isArray(sec.cards)?sec.cards:[];
    if(!sec.page?.takeover){
      if(banners.length>1) inner.appendChild(renderCarousel(banners, sec.baseHref));
      else if(banners.length===1) inner.appendChild(renderBannerUnit(banners[0], sec.baseHref));
      if(cards.length){
        const f=renderFilters(); inner.appendChild(f);
        const grid=document.createElement('div'); grid.className='grid'; sortCards(cards).forEach(x=>grid.appendChild(cardView(x)));
        inner.appendChild(grid); f.onChange=k=>applyFilter(grid,k);
      }
    }

    outer.appendChild(inner); return outer;
  }

  function renderChips(){ const bar=$('#chipbar'); bar.innerHTML=''; HSTATE.sections.forEach((s,i)=>{ const b=document.createElement('button'); b.className='chip'+(i===0?' active':''); b.textContent=s.title||s.id||('Bo\'lim '+(i+1)); b.dataset.target=s.id||('sec'+i); b.onclick=()=>{ activate(b.dataset.target); b.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'}); }; bar.appendChild(b); }); }
  function renderSections(){ const host=$('#sections'); host.innerHTML=''; HSTATE.sections.forEach(s=> host.appendChild(renderSection(s))); }

  function setTakeoverMode(on, sec){
    const body=document.body, host=$('#takeover');
    if(on){
      body.classList.add('takeover');
      host.style.display='block';
      // Agar section.page bo‚Äòlsa ‚Äî qayta qur:
      host.innerHTML='';
      const like = sec.page;
      const iframe = frameFrom({mode:like.mode||'url', src:like.src||'', contentHtml:like.contentHtml||'', baseHref:like.baseHref||'', sandbox:like.sandbox||'allow-scripts allow-forms allow-same-origin'}, null, {isPage:true});
      host.appendChild(iframe);
    }else{
      body.classList.remove('takeover');
      host.style.display='none';
      host.innerHTML='';
    }
  }

  function activate(id){
    HSTATE.activeId=id;
    const cur = HSTATE.sections.find(s=> (s.id||'')===id) || {};
    const takeover = !!(cur.page && cur.page.enabled && cur.page.takeover);

    $$('.chip').forEach(c=>c.classList.toggle('active', c.dataset.target===id));
    $$('[data-section]').forEach(s=> s.style.display=(s.dataset.section===id)?(takeover?'none':'block'):'none');

    setTakeoverMode(takeover, cur);
    updateGaps();
  }

  async function loadHome(){
    const d=await fetchHome();
    HSTATE.sections=(Array.isArray(d.sections)?d.sections:[]).map((s,i)=>({id:(s.id||`sec${i+1}`), ...s}));
    renderChips();
    renderSections();
    if(HSTATE.sections.length) activate(HSTATE.sections[0].id);
  }

  /* ===== overlay / user menu / profile (qisqa) ===== */
  const showOverlay=(html)=>{ const o=$('#overlay'); o.innerHTML=html; o.classList.add('show'); document.body.classList.add('no-scroll'); };
  const closeOverlay=()=>{ const o=$('#overlay'); o.classList.remove('show'); o.innerHTML=''; document.body.classList.remove('no-scroll'); };
  window.closeOverlay = closeOverlay; window.$ = $; window.$$ = $$;

  function openUserMenu(){ const chip=$('#userchip'), menu=$('#usermenu'); if(!chip||!menu) return; ($('#portal-root')||document.body).appendChild(menu); menu.style.visibility='hidden'; menu.style.display='block'; const r=chip.getBoundingClientRect(); const mw=menu.offsetWidth, mh=menu.offsetHeight, gap=8; let L=Math.min(Math.max(r.right-mw,8), innerWidth-mw-8), T=r.bottom+gap; if(T+mh>innerHeight-8) T=Math.max(8,r.top-gap-mh); menu.style.left=L+'px'; menu.style.top=Math.max(8,T)+'px'; menu.classList.add('open'); menu.style.visibility='visible'; const closeOutside=(e)=>{ if(!menu.contains(e.target) && !chip.contains(e.target)) closeUserMenu(); }; const onRelayout=()=>{ const r2=chip.getBoundingClientRect(); let L2=Math.min(Math.max(r2.right-mw,8), innerWidth-mw-8), T2=r2.bottom+gap; if(T2+mh>innerHeight-8) T2=Math.max(8,r2.top-gap-mh); menu.style.left=L2+'px'; menu.style.top=Math.max(8,T2)+'px'; }; menu._closers={closeOutside,onRelayout}; addEventListener('click', closeOutside, {capture:true}); addEventListener('scroll', onRelayout, {passive:true}); addEventListener('resize', onRelayout, {passive:true}); }
  function closeUserMenu(){ const menu=$('#usermenu'); if(!menu) return; menu.classList.remove('open'); menu.style.display='none'; if(menu._closers){ removeEventListener('click', menu._closers.closeOutside, {capture:true}); removeEventListener('scroll', menu._closers.onRelayout); removeEventListener('resize', menu._closers.onRelayout); menu._closers=null; } const chip=$('#userchip'); if(chip){ chip.appendChild(menu); chip.setAttribute('aria-expanded','false'); } }

  function renderUserChip(u, p){
    const slot=$('#user-slot'); const age=p?.birthDate?calcAge(p.birthDate):''; const name=p?.firstName?(p.firstName+(p.lastName?(' '+p.lastName):'')):(u.displayName||u.email||'Foydalanuvchi'); const avatar=p?.avatarUrl||u.photoURL||''; const role=p?.role||'‚Äî';
    slot.innerHTML=`
      <div class="userchip" id="userchip" aria-haspopup="menu" aria-expanded="false">
        <div class="avatar">${avatar?`<img src="${avatar}" alt="">`:''}</div>
        <div style="display:grid;line-height:1"><b style="font-size:14px">${name}</b><small class="mini">${role} ‚Ä¢ ${age?age+' yosh ‚Ä¢ ':''}${USER_POINTS} points</small></div>
        <div class="menu" id="usermenu" role="menu">
          <a href="#" id="mTheme">üåó Kun/Tun</a>
          <a href="#" id="mProfile">üë§ Profil</a>
          <a href="#" id="mEdit">‚úèÔ∏è Profilni tahrirlash</a>
          <a href="#" id="mLogout">üö™ Chiqish</a>
        </div>
      </div>`;
  }

  document.addEventListener('click',(e)=>{
    const t=e.target;
    if(t.closest('#userchip')){ const open=$('#usermenu')?.classList.contains('open'); open?closeUserMenu():openUserMenu(); }
    if(t.closest('#mLogout')){ e.preventDefault(); closeUserMenu(); signOut(auth); }
    if(t.closest('#mTheme')){ e.preventDefault(); const cur=document.documentElement.classList.contains('dark')?'dark':'light'; setTheme(cur==='dark'?'light':'dark'); }
  });

  function setTheme(mode){
    const root=document.documentElement; const tc=document.getElementById('meta-theme-color');
    if(mode==='dark'){ root.classList.add('dark'); root.setAttribute('data-theme','dark'); localStorage.setItem('lm_theme','dark'); tc && (tc.content='#0f1512'); }
    else { root.classList.remove('dark'); root.setAttribute('data-theme','light'); localStorage.setItem('lm_theme','light'); tc && (tc.content='#2E8B57'); }
  }
  (function initTheme(){ const saved=localStorage.getItem('lm_theme'); if(saved) setTheme(saved); })();

  onAuthStateChanged(auth, async(u)=>{
    CURRENT_USER=u||null;
    if(!u){ $('#app').hidden=true; authLock(); $('#user-slot').innerHTML=''; return; }
    $$('#auth-lock').forEach(x=>x.remove()); $('#app').hidden=false;
    if(!REGIONS.length) REGIONS=await loadRegions();
    [PROFILE, USER_POINTS] = await Promise.all([ getProfile(u.uid), getUserPoints(u.uid) ]);
    renderUserChip(u, PROFILE||{});
  });

  function authLock(){
    if($('#auth-lock')) return $('#auth-lock');
    const wrap=document.createElement('div');
    wrap.id='auth-lock'; wrap.className='overlay show';
    wrap.innerHTML=`<div class="panel"><b>Kirish</b><div class="divider"></div>
      <div class="fld"><label>Email</label><input id="eml" type="email" placeholder="email@example.com"></div>
      <div class="fld"><label>Parol</label><input id="pwd" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      <div id="err" style="color:#c62828"></div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button id="login" class="btn primary">Kirish</button>
        <button id="signup" class="btn">Ro'yxatdan o'tish</button>
        <button id="google" class="btn">Google</button></div></div>`;
    document.body.appendChild(wrap);
    wrap.addEventListener('click', async(e)=>{
      const id=e.target.id, err=$('#err',wrap);
      const busy=b=>$$('button',wrap).forEach(x=>x.disabled=b);
      try{
        busy(true);
        if(id==='google') await signInWithPopup(auth,new GoogleAuthProvider());
        if(id==='login'){ const em=$('#eml',wrap).value.trim(), pw=$('#pwd',wrap).value; await signInWithEmailAndPassword(auth,em,pw); }
        if(id==='signup'){ const em=$('#eml',wrap).value.trim(), pw=$('#pwd',wrap).value; await createUserWithEmailAndPassword(auth,em,pw); }
      }catch(er){ if(err) err.textContent=er?.message||String(er); } finally{ busy(false); }
    });
    return wrap;
  }

  // Boot
  async function boot(){
    const d=await fetchHome();
    HSTATE.sections=(Array.isArray(d.sections)?d.sections:[]).map((s,i)=>({id:(s.id||`sec${i+1}`), ...s}));
    renderChips();
    renderSections();
    heroRender([]); // agar fullscreen bannerlar bo'lmasa
    if(HSTATE.sections.length) activate(HSTATE.sections[0].id);
  }
  await boot();

  // SW
  if('serviceWorker' in navigator){
    try{
      const reg = await navigator.serviceWorker.register('/sw.js');
      if(!localStorage.getItem('sw_installed')){ toast('Offline rejim yoqildi ‚úÖ','success'); localStorage.setItem('sw_installed','1'); }
      reg.addEventListener('updatefound',()=>{ const nw=reg.installing; nw?.addEventListener('statechange',()=>{ if(nw.state==='installed' && navigator.serviceWorker.controller){ toast('Yangi versiya tayyor. Iltimos sahifani yangilang.','info'); } }); });
    }catch(e){ console.warn(e); }
  }
</script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-459PLJ7P7L"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-459PLJ7P7L');</script>
</body>
</html>
