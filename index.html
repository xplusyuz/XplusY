<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"/>
  <title>LeaderMath.UZ — Matematika Platformasi</title>

  <meta name="theme-color" content="#2E8B57" id="meta-theme-color"/>
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="icon" href="/logo.png" sizes="192x192">
  <link rel="apple-touch-icon" href="/logo.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

  <style>
  :root{
    --brand: #2E8B57; --brand-2: #1F6B45; --accent: #6B8E23;
    --brand-gradient: linear-gradient(135deg, #2E8B57, #3AA177);
    --accent-gradient: linear-gradient(135deg, #6B8E23, #8FBC8F);
    --bg: #F6FAF7; --bg-2: #ECF4EF; --card: #FFFFFF; --card-2: #F9FCFA;
    --text: #0f1b15; --muted: #5f7469; --line: #E3EBE6; --ring: #9dd8ba;
    --shadow: 0 30px 80px rgba(18,40,28,.14), 0 6px 20px rgba(18,40,28,.06);
    --shadow-sm: 0 10px 30px rgba(18,40,28,.08);
    --shadow-lg: 0 40px 120px rgba(18,40,28,.18);
    --radius: 18px; --radius-lg: 22px; --pill: 999px; --speed: .22s;
    --wrap: clamp(1200px, 96vw, 1760px);
    --vh: 1vh; --top-gap: 118px;
    --glass: rgba(255, 255, 255, 0.7);
    --glass-dark: rgba(15, 26, 21, 0.7);
    --glass-border: rgba(255, 255, 255, 0.2);
    --glass-shadow: 0 8px 32px rgba(31, 107, 69, 0.1);
  }
  :root.dark{
    --bg: #0f1512; --bg-2: #0b110e; --card: #0f1a15; --card-2: #122019;
    --text: #EAF7EE; --muted: #A7C4B3; --line: #254234; --ring: #3aa177;
    --shadow: 0 26px 70px rgba(0,0,0,.45), 0 6px 14px rgba(0,0,0,.35);
    --shadow-sm: 0 10px 22px rgba(0,0,0,.35);
    --shadow-lg: 0 40px 120px rgba(0,0,0,.55);
    --glass: rgba(15, 26, 21, 0.7);
    --glass-dark: rgba(0, 0, 0, 0.7);
    --glass-border: rgba(255, 255, 255, 0.05);
    --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font:16px/1.55 system-ui,Segoe UI,Inter,Arial;
    background:
      radial-gradient(1100px 540px at 15% -10%, color-mix(in srgb, var(--brand) 10%, transparent) 0, #0000 60%),
      radial-gradient(1200px 580px at 115% 10%, color-mix(in srgb, var(--accent) 10%, transparent) 0, #0000 60%),
      linear-gradient(180deg,var(--bg),var(--bg-2));
    -webkit-tap-highlight-color:transparent;
    overflow-x: hidden;
  }
  body.no-scroll{ overflow:hidden }

  .hdr{
    position:sticky; top:0; z-index:100;
    border-bottom:1px solid color-mix(in srgb,var(--line) 72%, transparent);
    backdrop-filter:saturate(1.1) blur(10px);
    background: var(--glass);
    box-shadow: var(--glass-shadow);
    transition: all var(--speed) ease;
  }
  .row{
    max-width:var(--wrap); margin:0 auto; padding:10px 16px;
    display:flex; gap:14px; align-items:center;
  }
  .brand{
    display:flex; align-items:center; gap:12px;
    font-weight:900; letter-spacing:.2px;
    transition: transform var(--speed) ease;
  }
  .brand:hover{ transform: translateY(-2px); }
  .brand .logo{
    width:50px; height:50px; border-radius:14px;
    display:grid; place-items:center; overflow:hidden;
    box-shadow:0 10px 30px rgba(46,139,87,.25);
    background: var(--brand-gradient);
    position: relative;
    transition: all var(--speed) ease;
  }
  .brand .logo::after{
    content:''; position:absolute; inset:0; border-radius:14px;
    background:linear-gradient(135deg, rgba(255,255,255,0.2), transparent);
  }
  .brand:hover .logo{
    transform: rotate(5deg) scale(1.05);
    box-shadow: 0 15px 40px rgba(46,139,87,.35);
  }
  .brand img{ width:40px; height:40px; display:block; filter:brightness(0) invert(1); }
  .brand .t{ display:grid; line-height:1.05; }
  .brand .t .n{ font-size:18px; }
  .brand .t .n b{
    color:var(--brand);
    background: var(--brand-gradient);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
  }
  .brand .t small{ color:var(--muted); }
  .grow{ flex:1; }

  .chipbar-wrap{
    position:sticky; top:62px; z-index:90;
    border-bottom:1px solid color-mix(in srgb,var(--line) 58%, transparent);
    backdrop-filter:saturate(1.06) blur(6px);
    background: var(--glass);
    box-shadow: var(--glass-shadow);
  }
  .chipbar{
    max-width:var(--wrap); margin:0 auto; padding:8px 16px 12px;
    display:flex; gap:10px; overflow:auto hidden;
    -webkit-overflow-scrolling:touch; scroll-behavior:smooth;
  }
  .chipbar::-webkit-scrollbar{ display:none; }
  .chipbar{ scrollbar-width:none; }

  .chip{
    appearance:none; border:1px solid var(--line);
    background: var(--glass);
    border-radius:999px; padding:10px 15px;
    font-weight:800; cursor:pointer; white-space:nowrap;
    box-shadow: var(--shadow-sm);
    transition: all var(--speed) ease;
    position:relative; overflow:hidden;
  }
  .chip::before{
    content:''; position:absolute; top:0; left:-100%; width:100%; height:100%;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition:left .5s ease;
  }
  .chip:hover::before{ left:100%; }
  .chip:hover{
    transform:translateY(-2px);
    box-shadow:0 12px 30px rgba(46,139,87,.15);
  }
  .chip.active{
    color:#fff; border-color:transparent;
    background: var(--brand-gradient);
    box-shadow:0 12px 30px color-mix(in srgb, var(--brand) 35%, transparent);
  }

  .hero{
    position:relative;
    margin:20px auto;
    max-width:var(--wrap);
    border-radius:var(--radius-lg);
    overflow:hidden;
    box-shadow:var(--shadow-lg);
    height:400px;
  }
  @media (max-width:900px){ .hero{ height:300px; } }
  .hero .rail{
    position:absolute; inset:0;
    display:flex; transition:transform .6s ease;
  }
  .hero .slide{ flex:0 0 100%; position:relative; }
  .hero iframe{
    position:absolute; inset:0; width:100%; height:100%;
    border:0; display:block; background:transparent;
  }
  .hero .nav{
    position:absolute; top:50%; transform:translateY(-50%);
    border:0; width:48px; height:48px; border-radius:50%;
    background: var(--glass);
    box-shadow: var(--shadow-sm);
    cursor:pointer; z-index:10;
    display:grid; place-items:center;
    font-size:20px; font-weight:bold;
    transition:all var(--speed) ease;
    backdrop-filter: blur(10px);
  }
  .hero .nav:hover{
    background:var(--brand); color:#fff;
    transform:translateY(-50%) scale(1.1);
  }
  .hero .nav.prev{ left:20px; }
  .hero .nav.next{ right:20px; }
  .hero .dots{
    position:absolute; bottom:20px; left:0; right:0;
    display:flex; justify-content:center; gap:10px;
  }
  .hero .dot{
    width:12px; height:12px; border-radius:50%;
    background:color-mix(in srgb,#fff 60%, var(--brand));
    opacity:.6; cursor:pointer;
    transition:all var(--speed) ease;
  }
  .hero .dot.active{
    opacity:1; background:var(--brand); transform:scale(1.2);
  }

  main{
    max-width:var(--wrap); margin:0 auto;
    padding:20px 16px 64px;
  }
  .section{
    background:var(--glass);
    border:1px solid var(--glass-border);
    border-radius:var(--radius-lg);
    box-shadow:var(--shadow);
    overflow:hidden;
    margin-bottom:24px;
    transition:all var(--speed) ease;
    backdrop-filter: blur(10px);
  }
  .section:hover{ transform:translateY(-5px); box-shadow:var(--shadow-lg); }
  .section-hdr{
    display:flex; align-items:center; justify-content:space-between;
    padding:20px 24px;
    border-bottom:1px solid var(--glass-border);
    background:var(--glass);
  }
  .section-hdr h3{
    margin:0; font-size:20px; font-weight:800;
    background:var(--brand-gradient);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
  }
  .inner{ padding:20px; }
  .section.fullbleed{
    margin-left:calc(50% - 50vw);
    margin-right:calc(50% - 50vw);
    border-radius:0; border-left:0; border-right:0;
    backdrop-filter:none;
  }
  .section.wide{
    max-width:var(--wrap);
    margin-left:auto; margin-right:auto;
  }

  .grid{
    --cols:1;
    display:grid; gap:20px;
    grid-template-columns:repeat(var(--cols), minmax(0,1fr));
  }
  @media (min-width:560px){ .grid{ --cols:2 } }
  @media (min-width:900px){ .grid{ --cols:3 } }
  @media (min-width:1200px){ .grid{ --cols:4 } }
  @media (min-width:1440px){ .grid{ --cols:5 } }
  @media (min-width:1680px){ .grid{ --cols:6 } }

  .cardX{
    border:1px solid var(--glass-border);
    background:var(--glass);
    border-radius:20px;
    padding:20px;
    display:flex; flex-direction:column; gap:16px;
    box-shadow:var(--shadow-sm);
    transition:all var(--speed) ease;
    min-width:220px;
    position:relative;
    overflow:hidden;
  }
  .cardX::before{
    content:''; position:absolute; top:0; left:0; right:0; height:4px;
    background:var(--brand-gradient);
    transform:scaleX(0); transform-origin:left;
    transition:transform var(--speed) ease;
  }
  .cardX:hover::before{ transform:scaleX(1); }
  .cardX:hover{
    transform:translateY(-8px);
    border-color:color-mix(in srgb, var(--brand) 35%, var(--line));
    box-shadow:0 18px 40px rgba(46,139,87,.15);
  }
  .cardX h4{ margin:0; font-size:18px; font-weight:800; }
  .thumb{
    width:100%; border-radius:12px;
    border:1px solid var(--line); object-fit:cover;
    aspect-ratio:16/9; background:#f6faf7;
    transition:all var(--speed) ease;
  }
  .cardX:hover .thumb{ transform:scale(1.03); }

  .badge{
    padding:6px 12px; border:1px solid var(--line);
    border-radius:999px; font-size:12px; font-weight:700;
    background:#f0f7f3;
    transition:all var(--speed) ease;
  }
  .badge.soon{ background:#fff8e5; border-color:#f2d48a; }
  .badge.active{
    background:var(--brand-gradient);
    color:#fff; border-color:transparent;
  }
  .badge.ended{ background:#f5f5f5; }

  .userchip{
    border:1px solid var(--glass-border);
    background:var(--glass);
    padding:8px 12px; border-radius:999px;
    box-shadow:var(--shadow-sm);
    display:flex; align-items:center; gap:10px;
    cursor:pointer;
    transition:all var(--speed) ease;
    backdrop-filter: blur(10px);
  }
  .userchip:hover{
    transform:translateY(-2px);
    box-shadow:0 10px 25px rgba(0,0,0,.1);
  }
  .avatar{
    width:38px; height:38px; border-radius:50%;
    overflow:hidden;
    background:var(--brand-gradient);
    display:grid; place-items:center;
    color:#fff; font-weight:bold;
  }
  .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }

  .menu{
    position:fixed; min-width:280px;
    background:var(--glass);
    border:1px solid var(--glass-border);
    border-radius:20px;
    box-shadow:var(--shadow-lg);
    display:none; overflow:hidden; z-index:1000;
    backdrop-filter: blur(20px);
  }
  .menu.open{ display:block; }
  .menu a{
    display:flex; align-items:center; gap:10px;
    padding:14px 16px; text-decoration:none; color:inherit;
    border-bottom:1px solid var(--glass-border);
    transition:all var(--speed) ease;
  }
  .menu a:last-child{ border-bottom:none; }
  .menu a:hover{
    background:color-mix(in srgb, var(--brand) 12%, transparent);
    transform:translateX(5px);
    box-shadow:inset 0 0 0 1px color-mix(in srgb, var(--brand) 40%, transparent);
  }
  .menu .label{
    padding:10px 16px; font-size:12px; color:var(--muted);
    border-bottom:1px solid var(--line);
    background:color-mix(in srgb,var(--card) 60%, transparent);
  }

  .btn{
    appearance:none; border:1px solid var(--line);
    background:var(--glass);
    padding:12px 20px; border-radius:14px;
    cursor:pointer; font-weight:900;
    transition:all var(--speed) ease;
    position:relative; overflow:hidden;
  }
  .btn::before{
    content:''; position:absolute; top:0; left:-100%; width:100%; height:100%;
    background:linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
    transition:left .5s ease;
  }
  .btn:hover::before{ left:100%; }
  .btn.primary{
    background:var(--brand-gradient);
    color:#fff; border-color:transparent;
    box-shadow:0 8px 20px rgba(46,139,87,.3);
  }
  .btn.primary:hover{
    transform:translateY(-3px);
    box-shadow:0 12px 25px rgba(46,139,87,.4);
  }
  .btn[disabled]{ opacity:.6; cursor:not-allowed; }

  .overlay{
    position:fixed; inset:0; display:none; place-items:center; z-index:110;
    background:color-mix(in srgb,#000 18%, transparent);
    backdrop-filter:saturate(1.1) blur(8px);
    opacity:0; transition:opacity .2s ease;
  }
  .overlay.show{ display:grid; opacity:1; }
  .panel{
    width:min(920px,96vw); max-height:92vh; overflow:auto;
    background:var(--glass);
    border:1px solid var(--glass-border);
    border-radius:24px;
    box-shadow:var(--shadow-lg);
    padding:28px;
    animation:pop .18s ease;
    backdrop-filter: blur(20px);
  }
  @keyframes pop{
    from{ transform:scale(.98); opacity:.6 }
    to{ transform:scale(1); opacity:1 }
  }

  .toasts{
    position:fixed; right:16px; bottom:16px;
    display:grid; gap:10px; z-index:1200;
    max-width:min(360px,90vw);
  }
  .toast{
    display:flex; align-items:flex-start; gap:10px;
    padding:14px 16px; border-radius:16px;
    border:1px solid var(--line); box-shadow:var(--shadow-sm);
    background:var(--glass);
    animation:slideIn .2s ease;
    backdrop-filter: blur(10px);
  }
  .toast.success{ border-color:#9edfae; }
  .toast.error{ border-color:#f2b4ac; }
  .toast.info{ border-color:#b9d9ff; }
  .toast .t{ font-weight:700; }
  .toast .x{ margin-left:auto; border:0; background:transparent; cursor:pointer; font-weight:900; }
  @keyframes slideIn{
    from{ transform:translateY(8px); opacity:.001; }
    to{ transform:translateY(0); opacity:1; }
  }

  .install-wrap{ position:sticky; top:0; z-index:9999; display:none; }
  .install-banner{
    margin:0; padding:14px 18px;
    display:flex; gap:10px; align-items:center; justify-content:space-between;
    background:var(--glass);
    border-bottom:1px solid var(--glass-border);
    box-shadow:var(--glass-shadow);
    backdrop-filter: blur(10px);
  }
  .install-banner .txt{
    display:flex; gap:10px; align-items:center; font-weight:700;
  }
  .install-banner .txt .ico{
    width:32px; height:32px; border-radius:10px;
    display:grid; place-items:center;
    background:var(--brand-gradient);
    color:#fff; font-size:16px;
  }
  .install-actions{ display:flex; gap:10px; align-items:center; }
  .install-btn{
    padding:10px 16px; border:1px solid var(--line);
    border-radius:12px; background:#fff; cursor:pointer; font-weight:800;
    transition:all var(--speed) ease;
  }
  .install-btn.primary{
    background:var(--brand-gradient);
    color:#fff; border-color:transparent;
  }
  .install-btn.primary:hover{
    transform:translateY(-2px);
    box-shadow:0 8px 20px rgba(46,139,87,.3);
  }
  .install-x{
    appearance:none; background:transparent; border:0;
    font-size:18px; line-height:1; cursor:pointer; color:#777;
  }
  @media (max-width:560px){
    .install-banner{ padding:12px 14px; }
    .install-banner .txt b{ font-size:14px; }
  }

  @keyframes float{
    0%,100%{ transform:translateY(0); }
    50%{ transform:translateY(-10px); }
  }
  .floating{ animation:float 3s ease-in-out infinite; }

  @media (max-width:768px){
    .hero{ height:250px; }
    .brand .t .n{ font-size:16px; }
    .section-hdr{ padding:16px 20px; }
    .section-hdr h3{ font-size:18px; }
    .inner{ padding:16px; }
    .cardX{ padding:16px; }
    .grid{ gap:16px; }
  }
  @media (max-width:480px){
    .hero{ height:200px; }
    .brand .logo{ width:40px; height:40px; }
    .brand img{ width:30px; height:30px; }
    .chip{ padding:8px 12px; font-size:14px; }
    .section-hdr{ flex-direction:column; align-items:flex-start; gap:10px; }
  }
  </style>
</head>
<body>

<div id="installWrap" class="install-wrap" role="region" aria-label="O‘rnatish taklifi">
  <div class="install-banner">
    <div class="txt">
      <span class="ico">⬇️</span>
      <div>
        <b>LeaderMath’ni o‘rnatib oling</b>
        <div class="mini" style="color:var(--muted,#5f7469)">Offline, tez kirish va to‘liq ekran</div>
      </div>
    </div>
    <div class="install-actions">
      <button id="btnInstallNow" class="install-btn primary">O‘rnatish</button>
      <button id="btnInstallLater" class="install-btn">Keyinroq</button>
      <button id="btnInstallClose" class="install-x" aria-label="Yopish">✕</button>
    </div>
  </div>
</div>

<header class="hdr" id="hdr">
  <div class="row">
    <div class="brand">
      <span class="logo"><img src="/logo.png" alt="LM"></span>
      <span class="t">
        <span class="n">LeaderMath.<b>UZ</b></span>
        <small>Matematika platformasi</small>
      </span>
    </div>
    <div class="grow"></div>
    <div id="user-slot"></div>
  </div>
  <div class="chipbar-wrap" id="chipwrap">
    <nav id="chipbar" class="chipbar" aria-label="Bo'limlar"></nav>
  </div>
</header>

<section id="hero" class="hero" aria-label="Bannerlar">
  <div class="rail" id="heroRail"></div>
  <button class="nav prev" id="heroPrev" aria-label="Oldingi">‹</button>
  <button class="nav next" id="heroNext" aria-label="Keyingi">›</button>
  <div class="dots" id="heroDots"></div>
</section>

<main id="app"><div id="sections"></div></main>

<div id="takeover" class="takeover-host" style="display:none"></div>
<div id="overlay" class="overlay" aria-modal="true"></div>
<div id="portal-root"></div>
<div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>

<script>
// INSTALL BANNER
(() => {
  const wrap = document.getElementById('installWrap');
  const btnNow = document.getElementById('btnInstallNow');
  const btnLater = document.getElementById('btnInstallLater');
  const btnClose = document.getElementById('btnInstallClose');
  const DISMISS_KEY = 'lm_install_dismiss_until';
  let deferredPrompt = null;
  const isStandalone = () =>
    window.matchMedia('(display-mode: standalone)').matches ||
    window.navigator.standalone === true;
  const show = () => (wrap.style.display = 'block');
  const hide = () => (wrap.style.display = 'none');
  const snooze = (days=7)=>localStorage.setItem(DISMISS_KEY, Date.now()+days*864e5);
  const snoozed = ()=>Number(localStorage.getItem(DISMISS_KEY)||0)>Date.now();
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);

  if (isStandalone()) hide();
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault(); deferredPrompt = e;
    if (isStandalone() || snoozed()) return;
    btnNow.onclick = async () => {
      hide(); deferredPrompt?.prompt();
      const choice = await deferredPrompt?.userChoice; deferredPrompt = null;
      if (!choice || choice.outcome !== 'accepted') snooze(7);
    };
    btnLater.onclick = ()=>{ hide(); snooze(3); };
    btnClose.onclick = ()=>{ hide(); snooze(14); };
    show();
  });
  if (!('BeforeInstallPromptEvent' in window) && isIOS && !isStandalone() && !snoozed()){
    document.querySelector('.install-banner .txt div').innerHTML =
      '<b>Home Screen’ga qo‘shing</b><div class="mini" style="color:var(--muted,#5f7469)">Safari’da <b>Share</b> → <b>Add to Home Screen</b></div>';
    btnNow.textContent='Tushunarli';
    btnNow.onclick = ()=>{ hide(); snooze(7); };
    btnLater.onclick = ()=>{ hide(); snooze(3); };
    btnClose.onclick = ()=>{ hide(); snooze(14); };
    show();
  }
  window.addEventListener('appinstalled', ()=>{ hide(); localStorage.removeItem(DISMISS_KEY); });
})();
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider,
  setPersistence, browserLocalPersistence, signOut
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  authDomain: "xplusy-760fa.firebaseapp.com",
  projectId: "xplusy-760fa",
  storageBucket: "xplusy-760fa.appspot.com",
  messagingSenderId: "992512966017",
  appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
  measurementId: "G-459PLJ7P7L"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
try{ await setPersistence(auth, browserLocalPersistence); }catch(e){ console.warn(e); }

const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));

function toast(msg,type='info',timeout=3500){
  const host=$('#toasts'); if(!host) return;
  const el=document.createElement('div');
  el.className='toast '+type;
  el.innerHTML=`<span class="t">${type==='error'?'❌':type==='success'?'✅':'ℹ️'}</span>
                <div>${msg}</div>
                <button class="x" aria-label="Yopish">×</button>`;
  const remove=()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(),200); };
  el.querySelector('.x').onclick=remove;
  host.appendChild(el);
  setTimeout(remove, timeout);
}

const setVH=()=>document.documentElement.style.setProperty('--vh', `${innerHeight*0.01}px`);
const updateGaps=()=>document.documentElement.style.setProperty('--top-gap',
  (($('#hdr')?.getBoundingClientRect().height||0)+($('#chipwrap')?.getBoundingClientRect().height||0))+"px");
setVH(); updateGaps();
addEventListener('resize', ()=>{ setVH(); updateGaps(); });
addEventListener('orientationchange', ()=>{ setVH(); updateGaps(); });
addEventListener('load', updateGaps);
document.fonts?.ready?.then?.(updateGaps);

// ====== STATE ======
const HSTATE = {
  sections: [],
  activeSectionId: null,
  heroSlides: [],
  heroIndex: 0,
  heroTimer: null
};

// ====== HOME LOAD ======
async function fetchHome(){
  // 1) Firestore configs/home
  try{
    const snap = await getDoc(doc(db,'configs','home'));
    if(snap.exists()){
      return snap.data();
    }
  }catch(e){
    console.warn('Firestore home doc error', e);
  }

  // 2) local /home.json
  try{
    const res = await fetch('/home.json',{cache:'no-store'});
    if(res.ok){
      return await res.json();
    }
  }catch(e){
    console.warn('home.json load error', e);
  }

  // 3) default
  return {
    sections: [
      {
        id: 'welcome',
        title: 'Boshlash',
        subsections: [
          {
            id:'intro',
            title:'LeaderMath.UZ ga xush kelibsiz',
            banners:[],
            cards:[
              {
                title:'Demo testlar',
                cardStyle:'available',
                ctaLabel:'Boshlash',
                ctaHref:'#',
                infoHtml:'Tezkor demo testlar orqali platforma bilan tanishing.'
              }
            ]
          }
        ]
      }
    ]
  };
}

// ====== HERO ======
function heroRender(banners){
  const hero = $('#hero');
  const rail = $('#heroRail');
  const dots = $('#heroDots');

  HSTATE.heroSlides = Array.isArray(banners) ? banners : [];

  if(!HSTATE.heroSlides.length){
    hero.style.display='none';
    hero.classList.add('hidden-hero');
    rail.innerHTML=''; dots.innerHTML='';
    return;
  }

  hero.style.display='';
  rail.innerHTML='';
  dots.innerHTML='';
  HSTATE.heroIndex=0;

  HSTATE.heroSlides.forEach((b,idx)=>{
    const slide=document.createElement('div');
    slide.className='slide';
    const iframe=document.createElement('iframe');

    if(b.mode==='html' && b.contentHtml){
      const blob=new Blob([b.contentHtml],{type:'text/html'});
      iframe.src=URL.createObjectURL(blob);
    }else if(b.mode==='url' && b.src){
      iframe.src=b.src;
    }else if(b.src){
      iframe.src=b.src;
    }else{
      iframe.srcdoc=`<!doctype html><html><body style="margin:0;display:flex;align-items:center;justify-content:center;font-family:system-ui;background:#f6faf7;color:#0f1b15">
        Banner mavjud emas
      </body></html>`;
    }

    slide.appendChild(iframe);
    rail.appendChild(slide);

    const dot=document.createElement('button');
    dot.type='button';
    dot.className='dot'+(idx===0?' active':'');
    dot.addEventListener('click',()=>heroGo(idx));
    dots.appendChild(dot);
  });

  rail.style.transform='translateX(0)';
  heroStartAuto();
}

function heroGo(index){
  const rail = $('#heroRail');
  const dots = $$('.dot',$('#heroDots'));
  const n = HSTATE.heroSlides.length;
  if(!n) return;
  HSTATE.heroIndex = (index + n) % n;
  rail.style.transform=`translateX(-${HSTATE.heroIndex*100}%)`;
  dots.forEach((d,i)=>d.classList.toggle('active', i===HSTATE.heroIndex));
}

function heroStartAuto(){
  heroStopAuto();
  if(HSTATE.heroSlides.length<=1) return;
  HSTATE.heroTimer=setInterval(()=>heroGo(HSTATE.heroIndex+1),8000);
}
function heroStopAuto(){
  if(HSTATE.heroTimer){ clearInterval(HSTATE.heroTimer); HSTATE.heroTimer=null; }
}

$('#heroPrev').addEventListener('click',()=>{
  heroStopAuto(); heroGo(HSTATE.heroIndex-1); heroStartAuto();
});
$('#heroNext').addEventListener('click',()=>{
  heroStopAuto(); heroGo(HSTATE.heroIndex+1); heroStartAuto();
});

// ====== SECTIONS & CHIPS ======
function renderChips(){
  const bar = $('#chipbar');
  bar.innerHTML='';
  HSTATE.sections.forEach(sec=>{
    const btn=document.createElement('button');
    btn.className='chip';
    btn.textContent=sec.title || 'Bo‘lim';
    btn.dataset.id=sec.id;
    btn.addEventListener('click',()=>activate(sec.id));
    bar.appendChild(btn);
  });
}

function renderSections(){
  const host = $('#sections');
  host.innerHTML='';

  HSTATE.sections.forEach(sec=>{
    const wrap=document.createElement('section');
    wrap.className='section wide';
    wrap.dataset.id=sec.id;

    const hdr=document.createElement('div');
    hdr.className='section-hdr';
    hdr.innerHTML=`<h3>${sec.title || 'Bo‘lim'}</h3>`;
    wrap.appendChild(hdr);

    const inner=document.createElement('div');
    inner.className='inner';

    const cards=[];
    if(Array.isArray(sec.subsections)){
      sec.subsections.forEach(sub=>{
        if(Array.isArray(sub.cards)){
          sub.cards.forEach(c=>cards.push({...c,_subTitle:sub.title}));
        }
      });
    }
    if(Array.isArray(sec.cards)){
      sec.cards.forEach(c=>cards.push(c));
    }

    if(cards.length){
      const grid=document.createElement('div');
      grid.className='grid';
      cards.forEach(card=>{
        const el=document.createElement('article');
        el.className='cardX';
        el.innerHTML = `
          ${card.thumb ? `<img class="thumb" src="${card.thumb}" alt="">` : ''}
          <div>
            <h4>${card.title || ''}</h4>
            ${card._subTitle ? `<div style="color:var(--muted);font-size:13px;margin-top:4px">${card._subTitle}</div>` : ''}
            ${card.infoHtml ? `<div style="color:var(--muted);font-size:14px;margin-top:8px">${card.infoHtml}</div>` : ''}
          </div>
          ${card.ctaHref ? `<button class="btn primary" type="button">${card.ctaLabel || 'Boshlash'}</button>` : ''}
        `;
        if(card.ctaHref){
          el.querySelector('.btn')?.addEventListener('click',()=>{
            const href = card.ctaHref;
            if(href.startsWith('http')) location.href = href;
            else location.href = href;
          });
        }
        grid.appendChild(el);
      });
      inner.appendChild(grid);
    }else{
      inner.innerHTML='<p style="margin:0;color:var(--muted)">Bu bo‘lim hozircha bo‘sh.</p>';
    }

    wrap.appendChild(inner);
    host.appendChild(wrap);
  });
}

function activate(id){
  HSTATE.activeSectionId=id;
  $$('.chip').forEach(ch=>ch.classList.toggle('active', ch.dataset.id===id));
  $$('.section').forEach(sec=>{
    sec.style.display = (!id || sec.dataset.id===id) ? 'block' : 'none';
  });

  const sec = HSTATE.sections.find(s=>s.id===id);
  if(!sec){ heroRender([]); return; }
  let banners=[];
  if(Array.isArray(sec.subsections)){
    for(const sub of sec.subsections){
      if(Array.isArray(sub.banners) && sub.banners.length){
        banners=sub.banners; break;
      }
    }
  }
  heroRender(banners);
}

// ====== USER CHIP (soddalashtirilgan) ======
function renderUserChip(user){
  const slot = $('#user-slot');
  if(!user){
    slot.innerHTML = `<button id="btnLogin" class="btn primary" type="button">Kirish</button>`;
    $('#btnLogin').onclick = async()=>{
      try{
        const provider=new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      }catch(e){
        console.error(e);
        toast('Kirishda xatolik yuz berdi','error');
      }
    };
    return;
  }

  const name = user.displayName || user.email || 'Foydalanuvchi';
  const initial = (name[0]||'L').toUpperCase();
  slot.innerHTML = `
    <div class="userchip" id="userChip">
      <div class="avatar"><span>${initial}</span></div>
      <div style="display:flex;flex-direction:column;gap:2px">
        <span style="font-size:14px;font-weight:700">${name}</span>
        <span style="font-size:11px;color:var(--muted)">LeaderMath foydalanuvchisi</span>
      </div>
    </div>
    <div class="menu" id="userMenu">
      <div class="label">Profil</div>
      <a href="#" id="menuLogout">Chiqish</a>
    </div>
  `;

  const chip=$('#userChip');
  const menu=$('#userMenu');

  const toggleMenu=(ev)=>{
    ev.stopPropagation();
    const r=chip.getBoundingClientRect();
    menu.style.top=(r.bottom+6)+'px';
    menu.style.right=(window.innerWidth-r.right+16)+'px';
    menu.classList.toggle('open');
  };
  chip.onclick=toggleMenu;
  document.addEventListener('click', (e)=>{
    if(!menu.contains(e.target) && !chip.contains(e.target)){
      menu.classList.remove('open');
    }
  });
  $('#menuLogout').onclick=async(e)=>{
    e.preventDefault();
    try{
      await signOut(auth);
      toast('Akkauntdan chiqildi','success');
    }catch(err){
      console.error(err);
      toast('Chiqishda xatolik','error');
    }
  };
}

onAuthStateChanged(auth, user=>{
  renderUserChip(user);
});

// ====== BOOT ======
async function boot(){
  try{
    const d = await fetchHome();
    HSTATE.sections = (Array.isArray(d.sections)?d.sections:[])
      .map((s,i)=>({ id: s.id || `sec${i+1}`, ...s }));

    renderChips();
    renderSections();

    if(HSTATE.sections.length){
      activate(HSTATE.sections[0].id);
    }else{
      heroRender([]);
    }
  }catch(e){
    console.error('Boot error', e);
    toast('Maʼlumotlarni yuklashda xatolik','error');
    heroRender([]);
  }
}

await boot();

// SERVICE WORKER
if('serviceWorker' in navigator){
  try{
    const reg = await navigator.serviceWorker.register('/sw.js');
    if(!localStorage.getItem('sw_installed')){
      toast('Offline rejim yoqildi ✅','success');
      localStorage.setItem('sw_installed','1');
    }
    reg.addEventListener('updatefound',()=>{
      const nw=reg.installing;
      nw?.addEventListener('statechange',()=>{
        if(nw.state==='installed' && navigator.serviceWorker.controller){
          toast('Yangi versiya tayyor. Iltimos sahifani yangilang.','info');
        }
      });
    });
  }catch(e){
    console.warn(e);
  }
}
</script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-459PLJ7P7L"></script>
<script>
window.dataLayer=window.dataLayer||[];
function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());
gtag('config','G-459PLJ7P7L');
</script>

</body>
</html>
