<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LeaderMath ‚Äî Portal</title>
  <meta name="theme-color" content="#0B1220" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0B1220;--panel:rgba(255,255,255,.07);--stroke:rgba(255,255,255,.14);--text:rgba(255,255,255,.92);--muted:rgba(255,255,255,.68);--accent:#2E8B57;--shadow:0 20px 70px rgba(0,0,0,.45);--r:20px;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--text);min-height:100vh;padding-bottom:84px;background:radial-gradient(900px 520px at 15% 0%, rgba(46,139,87,.35), transparent 60%),radial-gradient(900px 520px at 85% 0%, rgba(88,86,214,.22), transparent 60%),linear-gradient(180deg,#0B1220,#121B2F);}
    header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg, rgba(11,18,32,.92), rgba(11,18,32,.72));backdrop-filter: blur(14px);border-bottom:1px solid rgba(255,255,255,.10);}
    .bar{width:min(1100px,100%);margin:0 auto;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .brand{display:flex;gap:12px;align-items:center;}
    .logo{width:42px;height:42px;border-radius:14px;background:linear-gradient(135deg, rgba(46,139,87,.9), rgba(88,86,214,.65));border:1px solid rgba(255,255,255,.18);box-shadow:0 16px 40px rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;font-weight:900;}
    .title{display:flex;flex-direction:column;gap:2px;}
    .title b{font-size:14px;}
    .title span{font-size:12px;color:var(--muted);}
    .userchip{display:flex;align-items:center;gap:10px;border:1px solid var(--stroke);background:rgba(255,255,255,.06);padding:8px 10px;border-radius:999px;cursor:pointer;}
    .avatar{width:34px;height:34px;border-radius:50%;border:1px solid rgba(255,255,255,.20);background:rgba(0,0,0,.22);display:flex;align-items:center;justify-content:center;font-weight:900;}
    .chipmeta{display:flex;flex-direction:column;line-height:1.15;}
    .chipmeta b{font-size:12px;}
    .chipmeta span{font-size:11px;color:var(--muted);}
    main{width:min(1100px,100%);margin:0 auto;padding:16px;}
    .grid{display:grid;gap:14px;grid-template-columns:1.35fr .65fr;}
    @media(max-width:960px){.grid{grid-template-columns:1fr;}}
    .card{border:1px solid var(--stroke);background:rgba(255,255,255,.06);border-radius:var(--r);box-shadow:var(--shadow);padding:16px;}
    .h{display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:10px;}
    .h h2{margin:0;font-size:16px;}
    .h p{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.45;}
    .pill{border:1px solid rgba(46,139,87,.35);background:rgba(46,139,87,.12);padding:7px 10px;border-radius:999px;font-size:12px;font-weight:900;color:#d7ffe8;}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;}
    .btn{border:1px solid rgba(46,139,87,.55);background:linear-gradient(180deg,rgba(46,139,87,.95),rgba(46,139,87,.70));color:white;padding:12px 14px;border-radius:14px;font-weight:900;cursor:pointer;}
    .btn.secondary{border:1px solid var(--stroke);background:rgba(255,255,255,.06);color:rgba(255,255,255,.9);}
    .stat{display:flex;flex-direction:column;gap:4px;padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);}
    .stat b{font-size:16px;}
    .stat span{font-size:12px;color:var(--muted);}
    .list{display:grid;gap:10px;margin-top:10px;}
    .li{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);}
    .left{display:flex;align-items:center;gap:10px;}
    .ranknum{width:34px;height:34px;border-radius:12px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);font-weight:900;}
    .muted{color:var(--muted);font-size:12px;}
    .bottom{position:fixed;left:0;right:0;bottom:0;z-index:30;background:linear-gradient(180deg, rgba(18,27,47,.55), rgba(18,27,47,.92));backdrop-filter: blur(14px);border-top:1px solid rgba(255,255,255,.10);}
    .nav{width:min(1100px,100%);margin:0 auto;padding:10px 10px 12px;display:flex;gap:10px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
    .nav::-webkit-scrollbar{display:none;}
    .navbtn{flex:0 0 auto;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:rgba(255,255,255,.88);padding:10px 12px;border-radius:999px;font-weight:900;font-size:12px;cursor:pointer;white-space:nowrap;}
    .navbtn.active{border-color:rgba(46,139,87,.55);background:rgba(46,139,87,.16);color:#eafff3;}
    .page{display:none;}
    .page.active{display:block;}
    .modal{position:fixed;inset:0;z-index:50;background:rgba(0,0,0,.55);display:none;align-items:flex-end;justify-content:center;padding:16px;}
    .modal.open{display:flex;}
    .sheet{width:min(760px,100%);border-radius:24px;border:1px solid rgba(255,255,255,.14);background:rgba(15,22,38,.92);box-shadow:var(--shadow);backdrop-filter: blur(16px);overflow:hidden;}
    .sheetHead{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.10);display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .sheetHead b{font-size:14px;}
    .xbtn{border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:rgba(255,255,255,.9);width:40px;height:40px;border-radius:14px;cursor:pointer;font-weight:900;}
    .sheetBody{padding:16px;}
    .fields{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media(max-width:560px){.fields{grid-template-columns:1fr;}}
    label{font-size:12px;color:rgba(255,255,255,.75);}
    input,select{width:100%;padding:12px;border-radius:14px;border:1px solid var(--stroke);background:rgba(0,0,0,.20);color:var(--text);outline:none;font-size:14px;}
    input:focus,select:focus{border-color:rgba(46,139,87,.65);box-shadow:0 0 0 4px rgba(46,139,87,.18);}
    .toast{position:fixed;left:50%;bottom:96px;transform:translateX(-50%);background:rgba(0,0,0,.75);border:1px solid rgba(255,255,255,.18);color:rgba(255,255,255,.92);padding:10px 12px;border-radius:999px;display:none;z-index:80;font-size:12px;}
    .toast.show{display:block;}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <div class="logo">œÄ</div>
        <div class="title">
          <b>LeaderMath</b>
          <span id="subline">Yuklanmoqda‚Ä¶</span>
        </div>
      </div>
      <div class="userchip" id="userChip" title="Profil">
        <div class="avatar" id="avatar">U</div>
        <div class="chipmeta">
          <b id="chipName">‚Äî</b>
          <span id="chipId">ID: ‚Äî ‚Ä¢ 0 pts</span>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="grid">
      <section class="card">
        <div class="h">
          <div>
            <h2>Asosiy</h2>
            <p>API-only portal. Ma‚Äôlumotlar yagona <b>users</b> collection‚Äôda.</p>
          </div>
          <div class="pill" id="pill">Session OK</div>
        </div>

        <div class="row">
          <div class="stat"><b id="pts">0</b><span>Points</span></div>
          <div class="stat"><b id="region">‚Äî</b><span>Viloyat</span></div>
          <div class="stat"><b id="district">‚Äî</b><span>Tuman</span></div>
          <div class="stat"><b id="birth">‚Äî</b><span>Tug‚Äòilgan sana</span></div>
        </div>

        <div class="row" style="margin-top:14px;">
          <button class="btn" id="btnEdit">Profilni to‚Äòldirish / tahrirlash</button>
          <button class="btn secondary" id="btnLogout">Chiqish</button>
        </div>
      </section>

      <aside class="card">
        <div class="h">
          <div><h2>Top reyting</h2><p class="muted">Points bo‚Äòyicha (Top-20).</p></div>
        </div>
        <div class="list" id="ranking"><div class="muted">Yuklanmoqda‚Ä¶</div></div>
      </aside>
    </div>

    <section class="card" style="margin-top:14px;">
      <div class="h"><div><h2>Sahifalar</h2><p class="muted">Pastki nav gorizontal scroll bilan.</p></div></div>
      <div id="page-home" class="page active"><div class="muted">üè† Home: keyin banner/card tizimi.</div></div>
      <div id="page-tests" class="page"><div class="muted">üìù Testlar: keyin API bilan.</div></div>
      <div id="page-sim" class="page"><div class="muted">ü§ñ Simulyatorlar: keyin.</div></div>
      <div id="page-ranking" class="page"><div class="muted">üìä Reyting: o‚Äòngdagi ro‚Äòyxat.</div></div>
    </section>
  </main>

  <div class="bottom">
    <div class="nav" id="nav">
      <button class="navbtn active" data-page="home">üè† Home</button>
      <button class="navbtn" data-page="tests">üìù Testlar</button>
      <button class="navbtn" data-page="sim">ü§ñ Simulyatorlar</button>
      <button class="navbtn" data-page="ranking">üìä Reyting</button>
      <button class="navbtn" data-page="profile">üë§ Profil</button>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="sheet">
      <div class="sheetHead">
        <b>Profilni tahrirlash</b>
        <button class="xbtn" id="x">‚úï</button>
      </div>
      <div class="sheetBody">
        <div class="fields">
          <div><label>Ism</label><input id="firstName" placeholder="Ismingiz" /></div>
          <div><label>Familiya</label><input id="lastName" placeholder="Familiyangiz" /></div>
          <div><label>Viloyat</label><select id="regionSel"><option value="">Tanlang‚Ä¶</option></select></div>
          <div><label>Tuman</label><select id="districtSel" disabled><option value="">Avval viloyat tanlang‚Ä¶</option></select></div>
          <div><label>Tug‚Äòilgan sana</label><input id="birthdate" type="date" /></div>
        </div>

        <div class="row" style="margin-top:14px;">
          <button class="btn" id="save">Saqlash</button>
          <button class="btn secondary" id="close">Yopish</button>
        </div>

        <div class="row" style="margin-top:10px;">
          <button class="btn secondary" id="pw">Parolni almashtirish</button>
        </div>

        <div id="pwBox" style="display:none;margin-top:12px;">
          <div class="fields">
            <div><label>Joriy parol</label><input id="pwCur" type="password" /></div>
            <div><label>Yangi parol (>=6)</label><input id="pwNew" type="password" /></div>
          </div>
          <div class="row" style="margin-top:12px;">
            <button class="btn" id="pwSave">Yangilash</button>
            <button class="btn secondary" id="pwCancel">Bekor</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="assets/api-client.js"></script>
  <script src="assets/auth-client.js"></script>
  <script>
    const $ = (id)=>document.getElementById(id);
    const toast = (m)=>{ const t=$('toast'); t.textContent=m; t.classList.add('show'); clearTimeout(t.__t); t.__t=setTimeout(()=>t.classList.remove('show'), 2200); };

    let regionData = null;
    let ME = null;

    (async ()=>{ ME = await lmAuth.require(); if (!ME) return; await init(); })();

    async function init(){
      paintUser(ME);

      try{
        const r = await fetch('region.json', {cache:'no-store'});
        regionData = await r.json();
        fillRegions(regionData);
      }catch(e){ console.warn('region.json yuklanmadi', e); }

      loadRanking();

      $('nav').addEventListener('click', (e)=>{
        const btn = e.target.closest('.navbtn');
        if (!btn) return;
        const page = btn.dataset.page;
        if (page === 'profile'){ openModal(); return; }
        showPage(page);
      });

      $('userChip').onclick = openModal;
      $('btnEdit').onclick = openModal;
      $('btnLogout').onclick = ()=>lmAuth.logout();

      $('x').onclick = closeModal;
      $('close').onclick = closeModal;
      $('modal').addEventListener('click',(e)=>{ if(e.target===$('modal')) closeModal(); });

      $('regionSel').addEventListener('change', (e)=>updateDistricts(e.target.value));

      $('save').onclick = saveProfile;

      $('pw').onclick = ()=>{ $('pwBox').style.display='block'; };
      $('pwCancel').onclick = ()=>{ $('pwBox').style.display='none'; };
      $('pwSave').onclick = changePassword;
    }

    function showPage(id){
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.querySelectorAll('.navbtn').forEach(b=>b.classList.remove('active'));
      const p = document.getElementById('page-'+id);
      if (p) p.classList.add('active');
      const b = document.querySelector('.navbtn[data-page="'+id+'"]');
      if (b) b.classList.add('active');
      window.scrollTo(0,0);
    }

    function paintUser(u){
      const fn = (u.firstName||'').trim(), ln=(u.lastName||'').trim();
      const name = (fn+' '+ln).trim() || 'Foydalanuvchi';
      $('chipName').textContent = name;
      $('chipId').textContent = `ID: ${u.loginId || u.id || '‚Äî'} ‚Ä¢ ${u.points||0} pts`;
      $('avatar').textContent = (fn ? fn[0] : 'U').toUpperCase();
      $('subline').textContent = `Xush kelibsiz, ${name}!`;
      $('pts').textContent = u.points || 0;
      $('region').textContent = u.region || '‚Äî';
      $('district').textContent = u.district || '‚Äî';
      $('birth').textContent = u.birthdate || '‚Äî';
      $('pill').textContent = 'Session OK';
    }

    async function refreshMe(){
      const out = await lmApi.me();
      ME = out.user;
      paintUser(ME);
      return ME;
    }

    function openModal(){
      const u = ME || {};
      $('firstName').value = u.firstName || '';
      $('lastName').value = u.lastName || '';
      $('birthdate').value = u.birthdate || '';
      if (u.region) $('regionSel').value = u.region;
      updateDistricts(u.region || '', true);
      if (u.district) $('districtSel').value = u.district;
      $('pwBox').style.display='none'; $('pwCur').value=''; $('pwNew').value='';
      $('modal').classList.add('open');
    }
    function closeModal(){ $('modal').classList.remove('open'); }

    function fillRegions(data){
      const sel = $('regionSel');
      if (!data || !data.regions) return;
      sel.innerHTML = '<option value="">Tanlang‚Ä¶</option>';
      data.regions.forEach(r=>{ const o=document.createElement('option'); o.value=r.name; o.textContent=r.name; sel.appendChild(o); });
    }
    function updateDistricts(region, keep=false){
      const ds = $('districtSel');
      ds.innerHTML = '<option value="">Tanlang‚Ä¶</option>';
      ds.disabled = !region;
      if (!regionData || !region) return;
      const r = regionData.regions.find(x=>x.name===region);
      if (!r) return;
      r.districts.forEach(d=>{ const o=document.createElement('option'); o.value=d; o.textContent=d; ds.appendChild(o); });
      if (!keep) ds.value='';
    }

    async function saveProfile(){
      const firstName = $('firstName').value.trim();
      const lastName = $('lastName').value.trim();
      const region = $('regionSel').value.trim();
      const district = $('districtSel').value.trim();
      const birthdate = $('birthdate').value.trim();
      if (!firstName) return toast("Ism kiriting.");
      if (!region) return toast("Viloyat tanlang.");
      if (!district) return toast("Tuman tanlang.");
      if (!birthdate) return toast("Tug‚Äòilgan sana kiriting.");
      try{
        await lmApi.userPatch({ firstName, lastName, region, district, birthdate });
        toast("Saqlandi ‚úÖ");
        await refreshMe();
        closeModal();
      }catch(e){ toast(e?.message || "Xatolik"); }
    }

    async function changePassword(){
      const currentPassword = $('pwCur').value.trim();
      const newPassword = $('pwNew').value.trim();
      if (!currentPassword) return toast("Joriy parolni kiriting.");
      if (!newPassword || newPassword.length < 6) return toast("Yangi parol kamida 6 belgi.");
      try{
        await lmApi.changePassword(currentPassword, newPassword);
        toast("Parol yangilandi ‚úÖ");
        $('pwBox').style.display='none'; $('pwCur').value=''; $('pwNew').value='';
      }catch(e){ toast(e?.message || "Xatolik"); }
    }

    async function loadRanking(){
      try{
        const out = await lmApi.ranking();
        const users = out.users || [];
        const box = $('ranking');
        if (!users.length){ box.innerHTML = '<div class="muted">Hozircha foydalanuvchi yo‚Äòq.</div>'; return; }
        box.innerHTML = '';
        users.slice(0,20).forEach((u,i)=>{
          const fn=(u.firstName||'').trim(), ln=(u.lastName||'').trim();
          const name=(fn+' '+ln).trim()||('ID '+(u.loginId||u.id||'‚Äî'));
          const item=document.createElement('div');
          item.className='li';
          item.innerHTML = `<div class="left"><div class="ranknum">${i+1}</div><div><div style="font-weight:900;font-size:13px;">${escapeHtml(name)}</div><div class="muted">${escapeHtml((u.region||'') + (u.district?(' ‚Ä¢ '+u.district):''))}</div></div></div><div style="font-weight:900;">${u.points||0}</div>`;
          box.appendChild(item);
        });
      }catch(e){ $('ranking').innerHTML = '<div class="muted">Reyting yuklanmadi.</div>'; }
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,(c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
  </script>
</body>
</html>
