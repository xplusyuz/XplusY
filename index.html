<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0B0D12" />
  <title>OrzuMall ‚Äî Premium Shop</title>
  <meta name="description" content="OrzuMall ‚Äî premium online savdo. Katalog, sevimlilar, savatcha." />
  <link rel="icon" href="/logo.png" />

  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0B0D12;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.085);
      --stroke:rgba(255,255,255,.10);
      --stroke2:rgba(255,255,255,.16);
      --text:#EAF0FF;
      --muted:rgba(234,240,255,.70);
      --muted2:rgba(234,240,255,.55);
      --shadow: 0 18px 70px rgba(0,0,0,.55);
      --shadow2: 0 12px 40px rgba(0,0,0,.45);
      --r16:16px;
      --r20:20px;
      --r24:24px;
      --accent:#7C2AE8;     /* premium purple */
      --accent2:#36D6FF;    /* cyan glow */
      --ok:#12B76A;
      --warn:#F79009;
      --danger:#FF4D4D;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(124,42,232,.28), transparent 55%),
        radial-gradient(900px 600px at 110% 10%, rgba(54,214,255,.18), transparent 50%),
        radial-gradient(900px 700px at 40% 120%, rgba(18,183,106,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }

    /* Subtle animated grain */
    .grain{
      position:fixed; inset:-40%;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.25'/%3E%3C/svg%3E");
      mix-blend-mode:overlay; opacity:.12; pointer-events:none;
      transform:translateZ(0);
      animation:grain 10s steps(10) infinite;
    }
    @keyframes grain{
      0%{transform:translate(-2%, -2%)}
      25%{transform:translate(2%, -1%)}
      50%{transform:translate(1%, 2%)}
      75%{transform:translate(-1%, 1%)}
      100%{transform:translate(-2%, -2%)}
    }

    .wrap{ max-width:1180px; margin:0 auto; padding:20px 14px 60px; }

    /* Header */
    .topbar{
      position:sticky; top:0; z-index:50;
      padding:12px 0;
      backdrop-filter: blur(14px);
      background: linear-gradient(to bottom, rgba(11,13,18,.70), rgba(11,13,18,.25));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .toprow{
      display:flex; align-items:center; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      white-space:nowrap;
      user-select:none;
    }
    .brand .logo{
      width:28px; height:28px; border-radius:10px;
      background:
        radial-gradient(12px 12px at 30% 30%, rgba(54,214,255,.9), transparent 55%),
        radial-gradient(12px 12px at 70% 70%, rgba(124,42,232,.95), transparent 60%),
        rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      display:grid; place-items:center;
      overflow:hidden;
    }
    .brand .logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .brand .t1{ font-weight:900; letter-spacing:.2px; }
    .brand .t2{ font-size:12px; color:var(--muted2); margin-top:1px; }

    .search{
      flex:1;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 10px 25px rgba(0,0,0,.18);
      min-width:160px;
    }
    .search .ico{ opacity:.85; }
    .search input{
      flex:1;
      border:0; outline:0;
      background:transparent;
      color:var(--text);
      font-weight:600;
      font-size:14px;
    }
    .search input::placeholder{ color:rgba(234,240,255,.45); font-weight:600; }
    .chipbtn{
      width:40px; height:40px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:var(--text);
      display:grid; place-items:center;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
      box-shadow:0 10px 25px rgba(0,0,0,.18);
    }
    .chipbtn:active{ transform:scale(.98); }
    .chipbtn:hover{ background:rgba(255,255,255,.09); }

    .actions{ display:flex; align-items:center; gap:10px; }
    .pill{
      display:flex; align-items:center; gap:10px;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 10px 25px rgba(0,0,0,.18);
    }
    .counter{
      min-width:18px; height:18px;
      padding:0 6px;
      border-radius:999px;
      font-size:12px; font-weight:900;
      display:grid; place-items:center;
      background:linear-gradient(135deg, rgba(124,42,232,.95), rgba(54,214,255,.75));
      color:#0b0d12;
    }
    .userchip{
      display:flex; align-items:center; gap:10px;
      padding:8px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 10px 25px rgba(0,0,0,.18);
      cursor:pointer;
      user-select:none;
      max-width:240px;
    }
    .avatar{
      width:32px; height:32px; border-radius:12px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      display:grid; place-items:center;
      font-weight:900;
      overflow:hidden;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .uname{
      display:flex; flex-direction:column; gap:1px;
      min-width:0;
    }
    .uname .n1{
      font-weight:800; font-size:13px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .uname .n2{
      font-size:12px; color:var(--muted2);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    /* Category chips row */
    .catrow{
      margin-top:12px;
      display:flex; gap:10px;
      overflow:auto;
      padding:6px 2px 2px;
      scrollbar-width:none;
    }
    .catrow::-webkit-scrollbar{ display:none; }
    .cat{
      flex:0 0 auto;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .cat:hover{ background:rgba(255,255,255,.09); }
    .cat.active{
      background:linear-gradient(135deg, rgba(124,42,232,.32), rgba(54,214,255,.16));
      border-color:rgba(124,42,232,.45);
      box-shadow:0 14px 40px rgba(124,42,232,.16);
    }

    /* Content */
    .hero{
      margin-top:18px;
      display:flex; align-items:flex-end; justify-content:space-between;
      gap:14px;
    }
    .hero h1{
      margin:0;
      font-size:22px;
      letter-spacing:-.2px;
    }
    .sub{
      color:var(--muted2);
      font-weight:600;
      font-size:13px;
      margin-top:6px;
    }
    .status{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    .badge{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:var(--muted);
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }

    .grid{
      margin-top:16px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .card{
      grid-column: span 3;
      border-radius:var(--r24);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.10);
      box-shadow:var(--shadow2);
      overflow:hidden;
      position:relative;
      min-height:290px;
      display:flex; flex-direction:column;
      transform:translateZ(0);
    }
    .card:hover{
      border-color:rgba(255,255,255,.16);
    }
    .img{
      height:168px;
      background:rgba(255,255,255,.06);
      position:relative;
      overflow:hidden;
    }
    .img img{ width:100%; height:100%; object-fit:cover; display:block; }
    .img::after{
      content:"";
      position:absolute; inset:0;
      background:linear-gradient(to bottom, transparent 55%, rgba(11,13,18,.55));
      pointer-events:none;
    }
    .favbtn{
      position:absolute;
      top:10px; right:10px;
      width:42px; height:42px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(11,13,18,.45);
      backdrop-filter: blur(10px);
      display:grid; place-items:center;
      cursor:pointer;
      box-shadow:0 12px 30px rgba(0,0,0,.30);
      transition: transform .12s ease;
      user-select:none;
    }
    .favbtn:active{ transform:scale(.98); }
    .favbtn .h{ font-size:18px; }
    .favbtn.on{
      border-color:rgba(255,77,77,.35);
      background:rgba(255,77,77,.18);
    }

    .body{
      padding:12px 12px 12px;
      display:flex; flex-direction:column;
      gap:10px;
      flex:1;
    }
    .title{
      font-weight:900;
      letter-spacing:-.1px;
      line-height:1.25;
      font-size:14px;
      margin:0;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
      min-height:36px;
    }
    .meta{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .price{
      font-weight:900;
      font-size:16px;
      letter-spacing:-.2px;
    }
    .mini{
      font-size:12px; color:var(--muted2); font-weight:700;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:160px;
    }
    .btnrow{
      margin-top:auto;
      display:flex; gap:10px;
    }
    .btn{
      flex:1;
      border:0;
      outline:0;
      cursor:pointer;
      font-weight:900;
      border-radius:14px;
      padding:12px 12px;
      background:linear-gradient(135deg, rgba(124,42,232,.95), rgba(54,214,255,.65));
      color:#0b0d12;
      box-shadow:0 14px 35px rgba(124,42,232,.18);
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:hover{ filter:saturate(1.1); }
    .btn:active{ transform:scale(.99); }
    .btn2{
      width:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      display:grid; place-items:center;
      font-weight:900;
    }

    /* Empty / loading */
    .empty{
      margin-top:18px;
      padding:18px;
      border-radius:var(--r24);
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:var(--muted);
      font-weight:700;
    }

    /* Modal / Drawer */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.50);
      backdrop-filter: blur(10px);
      display:none;
      z-index:100;
      padding:18px;
    }
    .overlay.show{ display:grid; place-items:center; }
    .modal{
      width:min(640px, 96vw);
      border-radius:28px;
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.12);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .mhead{
      padding:16px 16px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .mhead h3{ margin:0; font-size:15px; letter-spacing:-.1px; }
    .x{
      width:40px; height:40px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      display:grid; place-items:center;
      font-weight:900;
    }
    .mbody{ padding:14px 16px 16px; }
    .row{ display:grid; gap:10px; margin-top:10px; }
    .label{ font-size:12px; color:var(--muted); font-weight:800; }
    .inp{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:12px 12px;
      outline:0;
      font-weight:800;
    }
    .help{ color:var(--muted2); font-size:12px; font-weight:650; }
    .mfoot{
      padding:14px 16px 16px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex; gap:10px;
    }
    .primary{
      flex:1;
      padding:13px 14px;
      border-radius:16px;
      border:0; outline:0;
      font-weight:900;
      cursor:pointer;
      background:linear-gradient(135deg, rgba(124,42,232,.95), rgba(54,214,255,.65));
      color:#0b0d12;
    }
    .ghost{
      padding:13px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
    }

    /* Drawer */
    .drawerWrap{
      position:fixed; inset:0;
      display:none;
      z-index:120;
    }
    .drawerWrap.show{ display:block; }
    .drawerShade{
      position:absolute; inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
    }
    .drawer{
      position:absolute;
      right:0; top:0; height:100%;
      width:min(420px, 92vw);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border-left:1px solid rgba(255,255,255,.12);
      box-shadow:var(--shadow);
      display:flex; flex-direction:column;
    }
    .dhead{
      padding:14px 14px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .dhead h3{ margin:0; font-size:15px; letter-spacing:-.1px; }
    .dlist{ padding:12px 14px 14px; overflow:auto; flex:1; }
    .item{
      display:flex; gap:10px;
      padding:10px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      margin-bottom:10px;
    }
    .thumb{
      width:56px; height:56px;
      border-radius:16px;
      overflow:hidden;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      flex:0 0 auto;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .itBody{ flex:1; min-width:0; }
    .itTitle{
      font-weight:900;
      font-size:13px;
      margin:0;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .itSub{
      margin-top:4px;
      font-size:12px; color:var(--muted2); font-weight:750;
      display:flex; justify-content:space-between; gap:10px;
    }
    .qtyRow{
      margin-top:8px;
      display:flex; align-items:center; gap:8px; justify-content:space-between;
    }
    .qbtn{
      width:38px; height:38px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
    }
    .qval{
      font-weight:900;
      min-width:34px;
      text-align:center;
    }
    .danger{
      border-color:rgba(255,77,77,.25);
      color:#ffd7d7;
      background:rgba(255,77,77,.10);
    }
    .dfoot{
      padding:12px 14px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      display:grid; gap:10px;
    }
    .total{
      display:flex; justify-content:space-between; align-items:center;
      font-weight:900;
    }
    .muted{ color:var(--muted2); font-weight:800; }

    /* Responsive */
    @media (max-width: 980px){
      .card{ grid-column: span 4; }
    }
    @media (max-width: 720px){
      .wrap{ padding:16px 12px 54px; }
      .hero{ align-items:flex-start; flex-direction:column; }
      .card{ grid-column: span 6; }
      .userchip{ max-width:160px; }
      .search{ display:none; } /* mobile: keep clean */
    }
    @media (max-width: 420px){
      .card{ grid-column: span 12; }
    }
  </style>
</head>

<body>
  <div class="grain" aria-hidden="true"></div>

  <div class="topbar">
    <div class="wrap">
      <div class="toprow">
        <div class="brand" id="brandBtn" title="OrzuMall">
          <div class="logo" aria-hidden="true">
            <!-- agar logo.png mavjud bo'lsa, ko'rsatadi -->
            <img src="/logo.png" alt="" onerror="this.style.display='none'">
          </div>
          <div style="display:flex;flex-direction:column;gap:0;line-height:1.05">
            <div class="t1">OrzuMall</div>
            <div class="t2">Premium shop</div>
          </div>
        </div>

        <div class="search" title="Qidiruv" id="searchWrap">
          <div class="ico">üîé</div>
          <input id="q" type="search" placeholder="Mahsulot qidirish..." autocomplete="off" />
          <button class="chipbtn" id="clearQ" title="Tozalash">‚Ü∫</button>
        </div>

        <div class="actions">
          <div class="pill" title="Sevimlilar">
            <button class="chipbtn" id="openFav">‚ù§</button>
            <div class="counter" id="favCount">0</div>
          </div>
          <div class="pill" title="Savatcha">
            <button class="chipbtn" id="openCart">üõí</button>
            <div class="counter" id="cartCount">0</div>
          </div>

          <div class="userchip" id="userChip" title="Kirish / Profil">
            <div class="avatar" id="avatar">OM</div>
            <div class="uname">
              <div class="n1" id="uname">Kirish</div>
              <div class="n2" id="uinfo">Google bilan</div>
            </div>
          </div>
        </div>
      </div>

      <div class="catrow" id="cats"></div>
    </div>
  </div>

  <div class="wrap">
    <div class="hero">
      <div>
        <h1 id="hTitle">Premium katalog</h1>
        <div class="sub" id="hSub">Kategoriyani tanlang yoki qidiruvdan foydalaning.</div>
      </div>
      <div class="status">
        <div class="badge" id="statusAuth">‚è≥ Tekshirilmoqda...</div>
        <div class="badge" id="statusItems">Mahsulotlar: 0</div>
      </div>
    </div>

    <div class="grid" id="grid"></div>
    <div class="empty" id="empty" style="display:none"></div>
  </div>

  <!-- PROFILE MODAL -->
  <div class="overlay" id="profileOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="profileTitle">
      <div class="mhead">
        <h3 id="profileTitle">Profilni to‚Äòldiring (majburiy)</h3>
        <button class="x" id="profileX" title="Yopish">‚úï</button>
      </div>
      <div class="mbody">
        <div class="help">Davom etish uchun ism-familiya va telefon raqam kerak.</div>

        <div class="row">
          <div class="label">Ism-familiya</div>
          <input class="inp" id="pName" placeholder="Masalan: Sohibjon Sattorov" />
        </div>

        <div class="row">
          <div class="label">Telefon raqam</div>
          <input class="inp" id="pPhone" placeholder="+998901234567" />
          <div class="help">Telefon: <code>+998901234567</code> yoki 9 ta raqam.</div>
        </div>
      </div>
      <div class="mfoot">
        <button class="ghost" id="logoutBtn">Chiqish</button>
        <button class="primary" id="saveProfileBtn">Saqlash</button>
      </div>
    </div>
  </div>

  <!-- CART DRAWER -->
  <div class="drawerWrap" id="cartDrawer">
    <div class="drawerShade" data-close="cart"></div>
    <div class="drawer">
      <div class="dhead">
        <h3>üõí Savatcha</h3>
        <button class="x" data-close="cart">‚úï</button>
      </div>
      <div class="dlist" id="cartList"></div>
      <div class="dfoot">
        <div class="total">
          <div class="muted">Jami</div>
          <div id="cartTotal">0 so‚Äòm</div>
        </div>
        <button class="primary" id="checkoutBtn">Buyurtma qilish</button>
      </div>
    </div>
  </div>

  <!-- FAV DRAWER -->
  <div class="drawerWrap" id="favDrawer">
    <div class="drawerShade" data-close="fav"></div>
    <div class="drawer">
      <div class="dhead">
        <h3>‚ù§ Sevimlilar</h3>
        <button class="x" data-close="fav">‚úï</button>
      </div>
      <div class="dlist" id="favList"></div>
      <div class="dfoot">
        <button class="ghost" id="clearFavBtn">Tozalash</button>
        <button class="primary" id="goShopBtn">Katalogga</button>
      </div>
    </div>
  </div>

  <!-- FIREBASE (Modular SDK) -->
  <script type="module">
    // =========================
    // 1) Firebase imports
    // =========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, collection, query, where, orderBy, onSnapshot,
      deleteDoc, getDocs, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // =========================
    // 2) CONFIG (<<< to'ldiring >>>)
    // =========================
    // !!! O'ZINGIZNING firebaseConfig'ni shu yerga qo'ying !!!
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // =========================
    // 3) UI helpers
    // =========================
    const $ = (s)=>document.querySelector(s);

    function toast(msg){
      let el = $(".toast");
      if(!el){
        el = document.createElement("div");
        el.className="toast";
        el.style.cssText = `
          position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
          background:rgba(10,10,12,.92);color:#fff;padding:12px 14px;border-radius:14px;
          font:800 14px/1.2 Inter,system-ui; box-shadow:0 20px 60px rgba(0,0,0,.35);
          z-index:99999;max-width:92vw; opacity:0; transition:opacity .15s ease;
        `;
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.style.opacity = "1";
      clearTimeout(el._t);
      el._t = setTimeout(()=>{ el.style.opacity="0"; }, 2200);
    }

    function money(n){
      const x = Number(n||0);
      return x.toLocaleString("uz-UZ") + " so‚Äòm";
    }

    function initials(name){
      const s = String(name||"OM").trim();
      const parts = s.split(/\s+/).filter(Boolean);
      const a = (parts[0]?.[0]||"O") + (parts[1]?.[0]||"M");
      return a.toUpperCase();
    }

    // =========================
    // 4) State
    // =========================
    let me = null;
    let meProfile = null;

    let categories = [];
    let products = [];
    let activeCat = "all";
    let qText = "";

    let favSet = new Set();
    let cartMap = new Map(); // productId -> qty

    let unsubCats = null;
    let unsubProducts = null;
    let unsubFav = null;
    let unsubCart = null;

    // =========================
    // 5) Firestore paths (UID-based)
    // =========================
    function requireUser(){
      if(!auth.currentUser) throw new Error("Login qiling.");
      return auth.currentUser;
    }
    function uid(){
      return requireUser().uid;
    }

    async function saveProfileFix({name, phone}){
      const u = requireUser();
      const payload = {
        name: String(name||"").trim(),
        phone: String(phone||"").trim(),
        email: u.email || null,
        updatedAt: serverTimestamp(),
        createdAt: serverTimestamp()
      };
      // merge: true => createdAt avvaldan bo'lsa saqlanadi
      await setDoc(doc(db, "users", u.uid), payload, { merge:true });
      return u.uid;
    }

    async function toggleFavorite(productId, isOn){
      const u = requireUser();
      const ref = doc(db, "users", u.uid, "favorites", String(productId));
      if(isOn){
        await setDoc(ref, { createdAt: serverTimestamp() }, { merge:true });
      }else{
        await deleteDoc(ref);
      }
    }

    async function setCartQty(productId, qty){
      const u = requireUser();
      const q = Math.max(1, Math.min(99, parseInt(qty,10) || 1));
      const ref = doc(db, "users", u.uid, "cart", String(productId));
      await setDoc(ref, { qty:q, updatedAt: serverTimestamp() }, { merge:true });
    }

    async function removeFromCart(productId){
      const u = requireUser();
      await deleteDoc(doc(db, "users", u.uid, "cart", String(productId)));
    }

    // =========================
    // 6) Render
    // =========================
    function renderCats(){
      const wrap = $("#cats");
      wrap.innerHTML = "";

      const all = [{ id:"all", title:"Barchasi" }, ...categories];
      for(const c of all){
        const b = document.createElement("button");
        b.className = "cat" + (activeCat===c.id ? " active":"");
        b.textContent = c.title;
        b.onclick = ()=>{ activeCat = c.id; renderCats(); renderProducts(); };
        wrap.appendChild(b);
      }
    }

    function filteredProducts(){
      let list = products.slice();

      if(activeCat !== "all"){
        list = list.filter(p => (p.categoryId || "") === activeCat);
      }
      const t = qText.trim().toLowerCase();
      if(t){
        list = list.filter(p =>
          String(p.title||"").toLowerCase().includes(t)
        );
      }
      // active only
      list = list.filter(p => p.active !== false);
      return list;
    }

    function renderProducts(){
      const grid = $("#grid");
      const empty = $("#empty");
      const list = filteredProducts();

      $("#statusItems").textContent = "Mahsulotlar: " + list.length;

      if(!list.length){
        grid.innerHTML = "";
        empty.style.display = "block";
        empty.textContent = products.length
          ? "Hech narsa topilmadi. Kategoriyani o‚Äòzgartiring yoki qidiruvni tozalang."
          : "Mahsulotlar yo‚Äòq. Admin paneldan products qo‚Äòshing.";
        return;
      }
      empty.style.display = "none";

      grid.innerHTML = "";
      for(const p of list){
        const id = p.id;
        const isFav = favSet.has(id);

        const card = document.createElement("div");
        card.className = "card";

        const img = document.createElement("div");
        img.className = "img";

        const imageUrl = p.image || "";
        img.innerHTML = `
          <img alt="" src="${escapeHtml(imageUrl)}" onerror="this.style.display='none'">
          <div class="favbtn ${isFav ? "on":""}" title="Sevimlilar" data-favid="${escapeAttr(id)}">
            <span class="h">${isFav ? "‚ù§" : "‚ô°"}</span>
          </div>
        `;

        const body = document.createElement("div");
        body.className = "body";

        const catTitle = categories.find(x=>x.id===p.categoryId)?.title || "‚Äî";
        body.innerHTML = `
          <p class="title">${escapeHtml(p.title || "Mahsulot")}</p>
          <div class="meta">
            <div class="price">${money(p.price || 0)}</div>
            <div class="mini">${escapeHtml(catTitle)}</div>
          </div>
          <div class="btnrow">
            <button class="btn" data-add="${escapeAttr(id)}">Savatga</button>
            <button class="btn2" data-view="${escapeAttr(id)}" title="Ko‚Äòrish">‚ãØ</button>
          </div>
        `;

        card.appendChild(img);
        card.appendChild(body);
        grid.appendChild(card);
      }

      // bind actions (event delegation)
      grid.onclick = async (e)=>{
        const favBtn = e.target.closest(".favbtn");
        if(favBtn){
          if(!me){ toast("Kirish qiling"); await loginGoogle(); return; }
          const pid = favBtn.getAttribute("data-favid");
          const isOn = !favSet.has(pid);
          try{
            await toggleFavorite(pid, isOn);
          }catch(err){
            console.error(err);
            toast("Xato: " + (err?.message || err));
          }
          return;
        }

        const addBtn = e.target.closest("[data-add]");
        if(addBtn){
          if(!me){ toast("Kirish qiling"); await loginGoogle(); return; }
          const pid = addBtn.getAttribute("data-add");
          const cur = cartMap.get(pid) || 0;
          try{
            await setCartQty(pid, cur + 1);
            toast("üõí Savatga qo‚Äòshildi");
          }catch(err){
            console.error(err);
            toast("Xato: " + (err?.message || err));
          }
          return;
        }

        const viewBtn = e.target.closest("[data-view]");
        if(viewBtn){
          const pid = viewBtn.getAttribute("data-view");
          const p = products.find(x=>x.id===pid);
          if(!p) return;
          toast((p.title||"Mahsulot") + " ‚Ä¢ " + money(p.price||0));
          return;
        }
      };
    }

    function renderFavDrawer(){
      const list = $("#favList");
      const arr = Array.from(favSet);
      if(!arr.length){
        list.innerHTML = `<div class="empty">Sevimlilar bo‚Äòsh.</div>`;
        return;
      }
      const favProducts = arr.map(id => products.find(p=>p.id===id)).filter(Boolean);

      list.innerHTML = "";
      for(const p of favProducts){
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="thumb"><img src="${escapeHtml(p.image||"")}" onerror="this.style.display='none'"></div>
          <div class="itBody">
            <p class="itTitle">${escapeHtml(p.title||"Mahsulot")}</p>
            <div class="itSub">
              <span>${money(p.price||0)}</span>
              <button class="qbtn danger" data-unfav="${escapeAttr(p.id)}" title="O‚Äòchirish">‚úï</button>
            </div>
          </div>
        `;
        list.appendChild(el);
      }

      list.onclick = async (e)=>{
        const b = e.target.closest("[data-unfav]");
        if(!b) return;
        const pid = b.getAttribute("data-unfav");
        try{
          await toggleFavorite(pid, false);
          toast("‚ù§ O‚Äòchirildi");
        }catch(err){
          console.error(err);
          toast("Xato: " + (err?.message || err));
        }
      };
    }

    function renderCartDrawer(){
      const list = $("#cartList");
      const ids = Array.from(cartMap.keys());
      if(!ids.length){
        list.innerHTML = `<div class="empty">Savatcha bo‚Äòsh.</div>`;
        $("#cartTotal").textContent = money(0);
        return;
      }

      let total = 0;
      list.innerHTML = "";
      for(const pid of ids){
        const qty = cartMap.get(pid) || 0;
        const p = products.find(x=>x.id===pid);
        if(!p) continue;
        const line = (p.price||0) * qty;
        total += line;

        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="thumb"><img src="${escapeHtml(p.image||"")}" onerror="this.style.display='none'"></div>
          <div class="itBody">
            <p class="itTitle">${escapeHtml(p.title||"Mahsulot")}</p>
            <div class="itSub"><span>${money(p.price||0)}</span><span>${money(line)}</span></div>
            <div class="qtyRow">
              <div style="display:flex;gap:8px;align-items:center">
                <button class="qbtn" data-dec="${escapeAttr(pid)}">‚àí</button>
                <div class="qval">${qty}</div>
                <button class="qbtn" data-inc="${escapeAttr(pid)}">+</button>
              </div>
              <button class="qbtn danger" data-del="${escapeAttr(pid)}" title="O‚Äòchirish">‚úï</button>
            </div>
          </div>
        `;
        list.appendChild(el);
      }

      $("#cartTotal").textContent = money(total);

      list.onclick = async (e)=>{
        const inc = e.target.closest("[data-inc]");
        const dec = e.target.closest("[data-dec]");
        const del = e.target.closest("[data-del]");
        try{
          if(inc){
            const pid = inc.getAttribute("data-inc");
            await setCartQty(pid, (cartMap.get(pid)||0) + 1);
          }else if(dec){
            const pid = dec.getAttribute("data-dec");
            const cur = (cartMap.get(pid)||0);
            if(cur <= 1) await removeFromCart(pid);
            else await setCartQty(pid, cur - 1);
          }else if(del){
            const pid = del.getAttribute("data-del");
            await removeFromCart(pid);
          }
        }catch(err){
          console.error(err);
          toast("Xato: " + (err?.message || err));
        }
      };
    }

    // =========================
    // 7) Auth + Profile gate
    // =========================
    async function loginGoogle(){
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    }

    async function logout(){
      await signOut(auth);
    }

    function setUserChip(){
      if(!me){
        $("#uname").textContent = "Kirish";
        $("#uinfo").textContent = "Google bilan";
        $("#avatar").textContent = "OM";
        $("#avatar").innerHTML = "OM";
        $("#statusAuth").textContent = "üîí Kirilmagan";
        $("#statusAuth").style.opacity = "1";
        return;
      }
      const n = (meProfile?.name || me.displayName || "Foydalanuvchi");
      $("#uname").textContent = n;
      $("#uinfo").textContent = me.email || "‚Äî";
      $("#statusAuth").textContent = "‚úÖ Kirgan";
      $("#statusAuth").style.opacity = "1";

      const av = $("#avatar");
      if(me.photoURL){
        av.innerHTML = `<img src="${escapeHtml(me.photoURL)}" alt="">`;
      }else{
        av.textContent = initials(n);
      }
    }

    function openProfileModal(force=false){
      const o = $("#profileOverlay");
      o.classList.add("show");
      o.setAttribute("aria-hidden","false");
      $("#pName").value = (meProfile?.name || me?.displayName || "");
      $("#pPhone").value = (meProfile?.phone || "");
      // force => X ni yashiramiz (majburiy)
      $("#profileX").style.display = force ? "none" : "grid";
    }
    function closeProfileModal(){
      const o = $("#profileOverlay");
      o.classList.remove("show");
      o.setAttribute("aria-hidden","true");
    }

    async function ensureProfile(){
      if(!me) return;
      const snap = await getDoc(doc(db,"users", me.uid));
      meProfile = snap.exists() ? snap.data() : null;

      const okName = String(meProfile?.name||"").trim().length >= 2;
      const okPhone = String(meProfile?.phone||"").trim().length >= 7;

      setUserChip();
      if(!okName || !okPhone){
        openProfileModal(true);
      }
    }

    // =========================
    // 8) Live watchers (cats/products/fav/cart)
    // =========================
    function stopAll(){
      try{ unsubCats?.(); }catch{}
      try{ unsubProducts?.(); }catch{}
      try{ unsubFav?.(); }catch{}
      try{ unsubCart?.(); }catch{}
      unsubCats = unsubProducts = unsubFav = unsubCart = null;
    }

    function watchPublic(){
      // categories
      const qc = query(collection(db,"categories"), orderBy("order","asc"));
      unsubCats = onSnapshot(qc, (snap)=>{
        categories = snap.docs.map(d=>({ id:d.id, ...d.data() }))
          .filter(x => x.active !== false);
        renderCats();
        renderProducts();
      }, (err)=>{
        console.error(err);
        $("#empty").style.display="block";
        $("#empty").textContent="Categories o‚Äòqishda xato: " + (err?.message||err);
      });

      // products
      const qp = query(collection(db,"products"), orderBy("createdAt","desc"));
      unsubProducts = onSnapshot(qp, (snap)=>{
        products = snap.docs.map(d=>({ id:d.id, ...d.data() }));
        renderProducts();
        // drawerlar ham yangilansin
        renderFavDrawer();
        renderCartDrawer();
      }, (err)=>{
        console.error(err);
        $("#empty").style.display="block";
        $("#empty").textContent="Products o‚Äòqishda xato: " + (err?.message||err);
      });
    }

    function watchPrivate(){
      if(!me) return;

      // favorites counter + set
      unsubFav = onSnapshot(collection(db,"users", me.uid, "favorites"), (snap)=>{
        favSet = new Set(snap.docs.map(d=>d.id));
        $("#favCount").textContent = String(favSet.size);
        renderProducts();
        renderFavDrawer();
      }, (err)=>{
        console.error(err);
        toast("Favorites xato: " + (err?.message||err));
      });

      // cart counter + map
      unsubCart = onSnapshot(collection(db,"users", me.uid, "cart"), (snap)=>{
        const m = new Map();
        let totalQty = 0;
        for(const d of snap.docs){
          const qty = d.data()?.qty || 0;
          m.set(d.id, qty);
          totalQty += qty;
        }
        cartMap = m;
        $("#cartCount").textContent = String(totalQty);
        renderCartDrawer();
      }, (err)=>{
        console.error(err);
        toast("Cart xato: " + (err?.message||err));
      });
    }

    // =========================
    // 9) Drawer controls
    // =========================
    function showDrawer(which){
      if(which==="cart") $("#cartDrawer").classList.add("show");
      if(which==="fav") $("#favDrawer").classList.add("show");
      if(which==="cart") renderCartDrawer();
      if(which==="fav") renderFavDrawer();
    }
    function hideDrawer(which){
      if(which==="cart") $("#cartDrawer").classList.remove("show");
      if(which==="fav") $("#favDrawer").classList.remove("show");
    }

    document.addEventListener("click", (e)=>{
      const c = e.target.closest("[data-close]");
      if(c){
        const which = c.getAttribute("data-close");
        hideDrawer(which);
      }
    });

    $("#openCart").onclick = async ()=>{
      if(!me){ toast("Kirish qiling"); await loginGoogle(); return; }
      showDrawer("cart");
    };
    $("#openFav").onclick = async ()=>{
      if(!me){ toast("Kirish qiling"); await loginGoogle(); return; }
      showDrawer("fav");
    };

    $("#goShopBtn").onclick = ()=> hideDrawer("fav");

    $("#clearFavBtn").onclick = async ()=>{
      if(!me) return;
      if(!favSet.size){ toast("Bo‚Äòsh"); return; }
      try{
        const qs = await getDocs(collection(db,"users", me.uid, "favorites"));
        await Promise.all(qs.docs.map(d=>deleteDoc(d.ref)));
        toast("Tozalandi");
      }catch(err){
        console.error(err);
        toast("Xato: " + (err?.message||err));
      }
    };

    $("#checkoutBtn").onclick = ()=>{
      if(!cartMap.size){ toast("Savatcha bo‚Äòsh"); return; }
      toast("‚úÖ Buyurtma: keyingi bosqich (Telegram / Checkout) qo‚Äòshamiz.");
    };

    // =========================
    // 10) Search controls
    // =========================
    $("#q")?.addEventListener("input", (e)=>{
      qText = e.target.value || "";
      renderProducts();
    });

    $("#clearQ")?.addEventListener("click", ()=>{
      qText = "";
      $("#q").value = "";
      renderProducts();
    });

    // Mobile: brand click => focus search if visible
    $("#brandBtn").onclick = ()=>{
      const q = $("#q");
      if(q) q.focus();
    };

    // =========================
    // 11) User chip click
    // =========================
    $("#userChip").onclick = async ()=>{
      if(!me){
        try{
          await loginGoogle();
        }catch(err){
          console.error(err);
          toast("Login xato: " + (err?.message||err));
        }
        return;
      }
      // kirgan bo'lsa: profil modal (edit)
      openProfileModal(false);
    };

    // Profile modal actions
    $("#profileX").onclick = ()=> closeProfileModal();

    $("#logoutBtn").onclick = async ()=>{
      try{ await logout(); }catch(e){ console.error(e); }
    };

    $("#saveProfileBtn").onclick = async ()=>{
      const btn = $("#saveProfileBtn");
      try{
        btn.disabled = true;
        const name = $("#pName").value || "";
        const phone = $("#pPhone").value || "";

        // simple normalize: 9 digits -> +998...
        let ph = String(phone).trim();
        const digits = ph.replace(/[^\d]/g,"");
        if(digits.length === 9) ph = "+998" + digits;
        if(digits.length === 12 && digits.startsWith("998")) ph = "+" + digits;

        if(String(name).trim().length < 2){
          toast("Ism-familiya kiriting");
          return;
        }
        if(String(ph).trim().length < 7){
          toast("Telefon raqam kiriting");
          return;
        }

        await saveProfileFix({ name, phone: ph });

        // refresh profile
        const snap = await getDoc(doc(db,"users", uid()));
        meProfile = snap.exists() ? snap.data() : meProfile;

        setUserChip();
        closeProfileModal();
        toast("‚úÖ Profil saqlandi");
      }catch(err){
        console.error(err);
        toast("Saqlash xato: " + (err?.message||err));
      }finally{
        btn.disabled = false;
      }
    };

    // =========================
    // 12) Auth state
    // =========================
    watchPublic();

    onAuthStateChanged(auth, async (user)=>{
      stopPrivate();
      me = user || null;
      meProfile = null;
      favSet = new Set();
      cartMap = new Map();
      $("#favCount").textContent = "0";
      $("#cartCount").textContent = "0";

      setUserChip();

      if(me){
        await ensureProfile();
        watchPrivate();
      }else{
        $("#statusAuth").textContent = "üîí Kirilmagan";
      }
      renderProducts();
      renderFavDrawer();
      renderCartDrawer();
    });

    function stopPrivate(){
      try{ unsubFav?.(); }catch{}
      try{ unsubCart?.(); }catch{}
      unsubFav = unsubCart = null;
    }

    // =========================
    // 13) Safe HTML helpers
    // =========================
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){
      return escapeHtml(s).replaceAll("`","&#096;");
    }

    // =========================
    // 14) Hide any "demo" / tag texts (extra safety)
    // =========================
    // Siz so‚Äòragan: ‚Äútagidagi yozuvlarni berkit‚Äù
    // Bu faylda demo tekst YO‚ÄòQ, lekin baribir xavfsiz qoladi.
    // (Hech narsa qilmaydi, faqat future uchun.)
  </script>
</body>
</html>