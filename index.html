<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OrzuMall ‚Äî Minimal (Telegram Login + Mini Header)</title>
  <meta name="theme-color" content="#6A0DAD" />
  <style>
    :root{--bg:#ffffff;--card:#fff;--border:#e5e7eb;--text:#111827;--muted:#6b7280;--brand:#6A0DAD}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text)}
    .wrap{max-width:980px;margin:0 auto;padding:14px}
    h1{font-size:18px;margin:0}
    .muted{color:var(--muted);font-size:13px}
    .card{border:1px solid var(--border);border-radius:16px;background:var(--card);padding:16px;margin:12px 0}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button{border:1px solid var(--border);background:#111;color:#fff;border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:700}
    button.secondary{background:#fff;color:#111}
    button:disabled{opacity:.55;cursor:not-allowed}
    pre{white-space:pre-wrap;word-break:break-word;background:#f6f7f9;border:1px solid var(--border);padding:12px;border-radius:12px;margin:10px 0 0}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:10px}
    @media (min-width:720px){ .grid{grid-template-columns:repeat(3,minmax(0,1fr));} }
    .p{border:1px solid var(--border);border-radius:14px;padding:12px}
    .price{font-weight:900}
    code{background:#f3f4f6;border:1px solid var(--border);border-radius:8px;padding:2px 6px}

    /* ===== MINI HEADER ===== */
    .mini-header{
      position:sticky; top:0; z-index:1000;
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px;
      backdrop-filter: blur(12px);
      background:rgba(255,255,255,.86);
      border-bottom:1px solid var(--border);
    }
    .h-left{display:flex; align-items:center; gap:10px; min-width:120px}
    .logo{
      font-weight:900; letter-spacing:.2px;
      color:var(--brand); font-size:18px;
    }
    .h-right{display:flex; align-items:center; gap:10px}
    .h-btn{
      position:relative;
      border:none; background:#111; color:#fff;
      border-radius:12px; padding:8px 10px;
      cursor:pointer; font-size:16px; line-height:1;
      min-width:42px; height:38px;
      display:inline-flex; align-items:center; justify-content:center;
    }
    .badge{
      position:absolute; top:-6px; right:-6px;
      background:#ef4444; color:#fff;
      font-size:10px; font-weight:800;
      padding:2px 6px; border-radius:999px;
      border:2px solid #fff;
    }
    .balance-box{
      display:flex; align-items:center; gap:6px;
      background:#f3f4f6; border:1px solid var(--border);
      padding:8px 10px; border-radius:12px;
      font-size:13px;
    }
    .balance-box b{font-size:13px}
    .avatar{
      width:36px; height:36px; border-radius:50%;
      overflow:hidden; border:2px solid #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,.06);
      background:#f3f4f6;
      cursor:pointer;
    }
    .avatar img{width:100%; height:100%; object-fit:cover; display:block}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px; font-weight:700;
      background:#f3f4f6; border:1px solid var(--border);
      padding:6px 10px; border-radius:999px;
    }
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px; z-index:2000;
      background:#111; color:#fff;
      padding:10px 12px; border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.22);
      font-size:13px; display:none;
      max-width:min(92vw,520px);
    }
  </style>
</head>
<body>

  <!-- MINI HEADER -->
  <header class="mini-header">
    <div class="h-left">
      <div class="logo">OrzuMall</div>
      <span class="chip" id="authChip">‚õî Guest</span>
    </div>

    <div class="h-right">
      <button class="h-btn" id="favBtn" title="Sevimlilar">
        ‚ù§Ô∏è <span class="badge" id="favCount">0</span>
      </button>

      <button class="h-btn" id="cartBtn" title="Savatcha">
        üõí <span class="badge" id="cartCount">0</span>
      </button>

      <div class="balance-box" title="Balans">
        <span>üí∞</span> <b id="balance">0</b>
      </div>

      <div class="avatar" id="avatarBox" title="Profil">
        <img id="avatarImg" alt="avatar" src=""/>
      </div>
    </div>
  </header>

  <div class="wrap">

    <div class="card">
      <h1>Telegram Login (Minimal)</h1>
      <div class="muted" style="margin-top:6px">
        Telegram Login Widget ‚Üí Netlify Function (<code>/.netlify/functions/tg-auth</code>) ‚Üí Firebase Custom Token ‚Üí Firestore <code>users/{uid}</code>.
        <br/>Agar <b>Bot domain invalid</b> chiqsa: BotFather ‚Üí <code>/setdomain</code> ‚Üí shu domenni kiriting: <code id="domainText"></code>
      </div>
      <div style="margin-top:12px" id="tgLogin"></div>
    </div>

    <div class="card">
      <div class="row">
        <button id="btnLogout" disabled>Logout</button>
        <button id="btnLoad" class="secondary" disabled>JSON productlarni o‚Äòqish</button>
      </div>
      <pre id="out">Kutilmoqda...</pre>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <span class="chip">üì¶ Products</span>
        <span class="muted">/products.json</span>
      </div>
      <div id="grid" class="grid muted" style="margin-top:10px">Hali yuklanmadi.</div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    // ====== 0) Firebase config ======
    // Firebase Console ‚Üí Project settings ‚Üí Your apps ‚Üí Web app ‚Üí firebaseConfig
    const firebaseConfig = {
      apiKey: "PASTE_API_KEY",
      authDomain: "PASTE.firebaseapp.com",
      projectId: "PASTE_PROJECT_ID",
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithCustomToken, signOut }
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, doc, getDoc }
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const out = document.getElementById("out");
    const btnLogout = document.getElementById("btnLogout");
    const btnLoad = document.getElementById("btnLoad");
    const grid = document.getElementById("grid");
    const toast = document.getElementById("toast");

    // header nodes
    const authChip = document.getElementById("authChip");
    const avatarImg = document.getElementById("avatarImg");
    const balanceEl = document.getElementById("balance");
    const favCountEl = document.getElementById("favCount");
    const cartCountEl = document.getElementById("cartCount");

    document.getElementById("domainText").textContent = location.host;

    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.style.display="none", 2200);
    }

    function log(v){
      out.textContent = typeof v === "string" ? v : JSON.stringify(v, null, 2);
    }

    btnLogout.onclick = async () => { await signOut(auth); };

    btnLoad.onclick = async () => {
      const res = await fetch("/products.json", { cache: "no-store" });
      const json = await res.json();
      const items = json.products || [];
      grid.classList.remove("muted");
      grid.innerHTML = items.map(p => `
        <div class="p">
          <div style="font-weight:900">${p.title ?? "No title"}</div>
          <div class="muted" style="margin-top:6px">${p.category ?? ""}</div>
          <div class="price" style="margin-top:10px">${Number(p.price||0).toLocaleString("uz-UZ")} so‚Äòm</div>
        </div>
      `).join("") || "<div class='muted'>Bo‚Äòsh.</div>";
    };

    // Header actions (placeholder)
    document.getElementById("favBtn").onclick = () => showToast("Sevimlilar (demo) ‚Äî keyin Firestore favorites ulanadi");
    document.getElementById("cartBtn").onclick = () => showToast("Savatcha (demo) ‚Äî keyin Firestore cart ulanadi");
    document.getElementById("avatarBox").onclick = () => showToast("Profil (demo) ‚Äî keyin profil modal qo‚Äòshamiz");

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        log("Login qilinmagan.");
        btnLogout.disabled = true;
        btnLoad.disabled = true;
        grid.textContent = "Hali yuklanmadi.";
        grid.classList.add("muted");

        // header reset
        authChip.textContent = "‚õî Guest";
        balanceEl.textContent = "0";
        favCountEl.textContent = "0";
        cartCountEl.textContent = "0";
        avatarImg.src = "https://ui-avatars.com/api/?name=Guest&background=F3F4F6&color=111";
        return;
      }

      btnLogout.disabled = false;
      btnLoad.disabled = false;

      // read Firestore user doc that server creates: users/{uid}
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);

      const docData = snap.exists() ? snap.data() : null;

      const name =
        docData?.profile?.name ||
        docData?.tg?.username ||
        user.displayName ||
        "User";

      authChip.textContent = "‚úÖ " + name;

      const avatar =
        docData?.profile?.avatar ||
        docData?.tg?.photo_url ||
        user.photoURL ||
        ("https://ui-avatars.com/api/?name=" + encodeURIComponent(name) + "&background=F3F4F6&color=111");

      avatarImg.src = avatar;

      balanceEl.textContent = (docData?.balance ?? 0).toLocaleString("uz-UZ");
      favCountEl.textContent = String(docData?.favoritesCount ?? 0);
      cartCountEl.textContent = String(docData?.cartCount ?? 0);

      log({ ok:true, uid: user.uid, hasUserDoc: snap.exists(), userDoc: docData });
    });

    // ====== 1) Telegram Login ======
    const BOT_USERNAME = "OrzuMallUZ_bot"; // @ ni yozmang

    window.onTelegramAuth = async (tgUser) => {
      try {
        log({ step:"telegram_callback", tgUser });

        const r = await fetch("/.netlify/functions/tg-auth", {
          method: "POST",
          headers: { "content-type":"application/json" },
          body: JSON.stringify({ tg: tgUser })
        });

        const j = await r.json();
        if (!j.ok) throw new Error(j.error || "Auth failed");
        log({ step:"got_customToken", uid: j.uid });

        await signInWithCustomToken(auth, j.customToken);
        showToast("Login OK ‚úÖ");

      } catch (e) {
        log({ ok:false, error: e.message });
        showToast("Xato: " + e.message);
      }
    };

    const s = document.createElement("script");
    s.async = true;
    s.src = "https://telegram.org/js/telegram-widget.js?22";
    s.setAttribute("data-telegram-login", BOT_USERNAME);
    s.setAttribute("data-size", "large");
    s.setAttribute("data-userpic", "true");
    s.setAttribute("data-request-access", "write");
    s.setAttribute("data-onauth", "onTelegramAuth(user)");
    document.getElementById("tgLogin").appendChild(s);
  </script>
</body>
</html>
