<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MathCenter.uz — SPA</title>
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <style>
    :root{ --green:#0faf64; --edge:#e0f3eb; --bg:#f6fffb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg)}

    header{position:sticky;top:0;z-index:10;padding:10px 16px;background:#ffffffd9;border-bottom:1px solid #eaf7f1;backdrop-filter:saturate(150%) blur(6px);}
    .header-inner{max-width:1200px;margin:0 auto;display:grid;gap:12px;align-items:center;}
    @media(min-width:900px){ .header-inner{ grid-template-columns: 1fr auto; } }

    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:48px;height:48px;border-radius:14px;background:radial-gradient(60% 60% at 50% 35%, #b9ffd9, #2de38d 55%, #0ea55a 100%);display:grid;place-items:center;box-shadow:0 0 36px rgba(14,175,100,.35), inset 0 0 20px rgba(255,255,255,.7)}
    .logo svg{width:28px;height:28px;fill:#fff}
    .brand-title{padding:8px 12px;border-radius:14px;background:linear-gradient(145deg,#f7fffb,#eafff5);box-shadow:0 10px 18px #b0f5d633,inset 0 -3px 8px rgba(255,255,255,.8)}
    .brand-title h1{margin:0;font-size:20px;background:linear-gradient(180deg,#0dbb6f,#0a8f52);-webkit-background-clip:text;color:transparent;font-weight:900;letter-spacing:.3px}

    .stats{display:grid; grid-auto-flow:column; gap:10px;}
    .card{background:#fff;border:1px solid var(--edge);border-radius:14px;padding:10px 12px;box-shadow:0 12px 28px rgba(10,143,82,.12), 0 2px 6px rgba(0,0,0,.05);display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;min-height:52px;min-width:90px}
    .card .label{font-size:12px;opacity:.7}
    .card .value{font-size:14px;font-weight:800}
    @media(max-width:899px){ .header-inner{ grid-template-columns:1fr; } }
    .stats-compact{display:none}
    @media(max-width:540px){ .stats{display:none} .stats-compact{display:block} }

    main{max-width:1200px;margin:16px auto 96px;padding:0 16px}
    .content{background:#fff;border:1px solid var(--edge);border-radius:16px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.06)}

    .fab{position:fixed;right:16px;bottom:16px;z-index:50}
    .fab-btn{width:56px;height:56px;border-radius:20px;background:var(--green);color:#fff;border:none;font-size:24px;font-weight:900;box-shadow:0 10px 24px rgba(0,0,0,.2)}
    .fab-menu{display:none;position:absolute;right:0;bottom:70px;flex-direction:column;gap:8px}
    .fab.open .fab-menu{display:flex}
    .chip{background:#fff;border:1px solid var(--edge);padding:10px 14px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);font-weight:800;transition:transform .18s ease, box-shadow .18s ease, background-color .18s ease, color .18s ease}
    .chip:hover{transform:scale(1.05); box-shadow:0 6px 16px rgba(0,0,0,.14)}
    .chip.active{background:#0faf64;color:#fff;border-color:#0faf64;box-shadow:0 8px 22px rgba(15,175,100,.35)}

    /* Cards grid */
    .cards{display:grid;gap:16px}
    .cards.fixed-3-2-1{grid-template-columns:1fr}
    @media(min-width:640px){ .cards.fixed-3-2-1{grid-template-columns:repeat(2,1fr)} }
    @media(min-width:1024px){ .cards.fixed-3-2-1{grid-template-columns:repeat(3,1fr)} }
    .cards.auto-fill{grid-template-columns:repeat(auto-fill,minmax(250px,1fr))}

    .card3d{background:#fff;border:1px solid var(--edge);border-radius:16px;box-shadow:0 12px 28px rgba(10,143,82,.12), 0 2px 6px rgba(0,0,0,.05);overflow:hidden;display:flex;flex-direction:column;transition:transform .15s ease, box-shadow .15s ease}
    .card3d:hover{transform:translateY(-3px);box-shadow:0 16px 36px rgba(10,143,82,.18)}
    .card3d .media{width:100%;height:180px;object-fit:cover;background:#f1f5f4}
    .card3d .body{padding:14px}
    .ctitle{margin:0 0 6px 0;font-size:18px;display:flex;flex-wrap:wrap;gap:6px;align-items:center}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#f3fbf7;border:1px solid #cfeee0;color:#087454;font-size:11px}
    .desc{margin:8px 0;color:#5d776f;font-size:14px;line-height:1.5}
    .foot{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
    .pill{appearance:none;display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;border:1px solid #cfeee0;background:#fff;color:#064e3b;text-decoration:none;font-weight:700;transition:.15s}
    .pill:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(16,185,129,.15)}
    .price{font-weight:800;color:#0a3a2d}
    .price.free{color:#047857}

    /* Filters + pager */
    .controls{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0;align-items:center}
    select,input[type="text"]{padding:10px 12px;border-radius:14px;border:1px solid #cfeee0;background:#fff;outline:none}
    .btn{padding:10px 14px;border-radius:999px;border:1px solid #cfeee0;background:#fff;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-weight:700}
    .btn:hover{box-shadow:0 8px 16px rgba(16,185,129,.12);transform:translateY(-1px)}
    .counter{color:#0b2a21;font-weight:700}
    .pager{display:flex;gap:10px;align-items:center;justify-content:center;margin:18px 0}

    /* Hero banner */
    .hero{position:relative;border-radius:22px;overflow:hidden;border:1px solid #e0f3eb;background:#dff7ee;min-height:260px;display:grid;place-items:center;box-shadow:0 12px 28px rgba(10,143,82,.12)}
    .hero .bg{position:absolute;inset:0;background-size:cover;background-position:center;filter:saturate(1.05) contrast(1.05)}
    .hero .veil{position:absolute;inset:0;background:linear-gradient(180deg,#00000030,#00000020)}
    .hero .inner{position:relative;z-index:2;color:#fff;text-align:center;padding:32px}
    .hero .inner h2{margin:0 0 10px 0;font-size:28px}
    .hero .inner p{margin:0 0 14px 0;font-size:16px;opacity:.95}
    .hero .actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
    .hero .badge{position:absolute;top:12px;left:12px}
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg"><path d="M76 92h104c9 0 16-7 16-16s-7-16-16-16H60c-9 0-16 7-16 16s7 16 16 16h4c8 41 4 77-8 97-5 8 5 17 13 12 24-14 35-53 29-109zm57 0c7 39 3 74-8 94-5 9 6 18 14 12 24-16 35-56 28-106h-34z"/></svg>
        </div>
        <div class="brand-title"><h1>MathCenter.uz</h1></div>
      </div>
      <div class="stats" id="headerStats">
        <div class="card"><div class="label">Salom</div><div class="value" id="helloName">-</div><div class="label" id="helloAge">Yosh: -</div></div>
        <div class="card"><div class="label">ID</div><div class="value" id="headerID">-</div></div>
        <div class="card"><div class="label">Balans</div><div class="value" id="headerBalans">-</div></div>
        <div class="card"><div class="label">Ball</div><div class="value" id="headerBall">-</div></div>
      </div>
      <div class="stats-compact" id="headerCompact"></div>
    </div>
  </header>

  <main>
    <div class="content" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px">
      <span class="mc-badge">Grid:</span>
      <button class="mc-btn" id="btnFixed321">3/2/1</button>
      <button class="mc-btn" id="btnAutoFill">Auto</button>
      <span class="mc-badge" id="gridModeTag">—</span>
    </div>
    <div id="app"><div class="content"><h2>Bosh sahifa</h2><p>Xush kelibsiz!</p></div></div>
  </main>

  <div class="fab" id="fab">
    <button class="fab-btn" id="fabBtn">≡</button>
    <div class="fab-menu" id="fabMenu">
      <button class="chip" data-route="home">Bosh sahifa</button>
      <button class="chip" data-route="courses">Kurslar</button>
      <button class="chip" data-route="tests">Testlar</button>
      <button class="chip" data-route="simulators">Simulyatorlar</button>
      <button class="chip" data-route="results">Natijalar</button>
      <button class="chip" data-route="profile">Profil</button>
    </div>
  </div>

  <!-- (Modals omitted for brevity in this snippet) -->
  <div class="mc-modal" id="authModal" aria-hidden="true">
    <div class="mc-card" role="dialog" aria-modal="true" style="max-width:640px">
      <div class="mc-head"><div class="mc-title">Kirish / Ro‘yxatdan o‘tish</div><button class="mc-close" data-x="authModal">✕</button></div>
      <div style="display:flex;gap:8px;margin-bottom:12px"><button id="tabLogin" class="mc-btn mc-tab active">Kirish (ID)</button><button id="tabSignup" class="mc-btn mc-tab">Ro‘yxatdan (Email / Google)</button></div>
      <div id="authLogin"><div class="mc-grid"><div class="mc-row"><label>Numeric ID</label><input id="login_id" placeholder="38864 yoki 12500" autocomplete="username"></div><div class="mc-row"><label>Parol</label><input type="password" id="login_pass" placeholder="Parol" autocomplete="current-password"></div></div><div class="mc-actions"><button class="mc-btn mc-btn--pri" id="btnLoginId">Kirish</button></div></div>
      <div id="authSignup" style="display:none"><div class="mc-grid"><div class="mc-row"><label>Email</label><input id="signup_email" type="email" placeholder="email@misol.uz" autocomplete="email"></div><div class="mc-row"><label>Parol (ixtiyoriy)</label><input id="signup_pass" type="password" placeholder="Agar hozir kiritmoqchi bo‘lsangiz" autocomplete="new-password"></div></div><div class="mc-actions"><button class="mc-btn" id="btnSignupEmail">Email bilan ro‘yxatdan</button><button class="mc-btn mc-btn--pri" id="btnSignupGoogle">Google bilan</button></div></div>
    </div>
  </div>

  <script>
    const routes=["home","courses","tests","simulators","results","profile"];
    const fab=document.getElementById('fab'); const fabBtn=document.getElementById('fabBtn'); const fabMenu=document.getElementById('fabMenu');
    function closeFab(){ if(fab.classList.contains('open')){ fab.classList.add('closing'); setTimeout(()=>{ fab.classList.remove('open'); fab.classList.remove('closing');},180);}}
    fabBtn.onclick=(e)=>{ e.stopPropagation(); if(fab.classList.contains('open')) closeFab(); else fab.classList.add('open'); };
    fabMenu.addEventListener('click',(e)=>{ const btn=e.target.closest('.chip'); if(!btn) return; const r=btn.getAttribute('data-route'); if(!r) return; loadRoute(r); closeFab(); });
    document.addEventListener('click',(e)=>{ if(fab.classList.contains('open') && !fab.contains(e.target)) closeFab(); });
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeFab(); });
    function setActive(route){ document.querySelectorAll('.fab-menu .chip').forEach(b=>b.classList.toggle('active', b.getAttribute('data-route')===route)); }

    // Grid mode
    const modeTag = document.getElementById('gridModeTag');
    function getGridMode(){ return localStorage.getItem('gridmode') || 'fixed321'; }
    function applyGridMode(grid){ const m=getGridMode(); if(modeTag) modeTag.textContent = (m==='auto'?'Auto-fill':'3/2/1'); if(grid){ grid.classList.toggle('fixed-3-2-1', m==='fixed321'); grid.classList.toggle('auto-fill', m==='auto'); } document.getElementById('btnFixed321').classList.toggle('mc-btn--pri', m==='fixed321'); document.getElementById('btnAutoFill').classList.toggle('mc-btn--pri', m==='auto'); }
    document.getElementById('btnFixed321').onclick=()=>{ localStorage.setItem('gridmode','fixed321'); applyGridMode(document.getElementById('cards')); };
    document.getElementById('btnAutoFill').onclick=()=>{ localStorage.setItem('gridmode','auto'); applyGridMode(document.getElementById('cards')); };

    async function loadRoute(route){
      const app=document.getElementById('app');
      if(route==='home'){
        app.innerHTML = `
          <div class="content">
            <div class="hero">
              <div id="hero-bg" class="bg"></div><div class="veil"></div>
              <span id="homeTag" class="mc-badge badge" style="display:none"></span>
              <div class="inner">
                <h2 id="homeTitle">Yuklanmoqda…</h2>
                <p id="homeDesc"></p>
                <div class="actions"><a id="homeBtn" class="pill" href="#courses">Boshlash</a></div>
              </div>
            </div>
          </div>`;
        await renderHome();
      } else if(['courses','tests','simulators'].includes(route)){
        app.innerHTML = `
          <div class="content">
            <div class="controls">
              <select id="f1"><option value="">Bo'lim</option></select>
              <select id="f2"><option value="">Bo'lim 2</option></select>
              <select id="f3"><option value="">Bo'lim 3</option></select>
              <select id="ft"><option value="">Tag</option><option value="free">FREE</option><option value="pro">PRO</option><option value="new">NEW</option></select>
              <input id="fq" type="text" placeholder="Qidiruv...">
              <button id="clear-q" class="btn">Tozalash</button>
              <button id="reset" class="btn">Reset</button>
              <span class="counter"><span id="badge">0</span> element</span>
            </div>
            <div id="chips" class="controls"></div>
            <div id="cards" class="cards"></div>
            <div class="pager">
              <button id="prev" class="btn" title="Oldingi">◀ Oldingi</button>
              <span class="counter" id="pi">1 / 1</span>
              <button id="next" class="btn" title="Keyingi">Keyingi ▶</button>
            </div>
          </div>`;
        applyGridMode(document.getElementById('cards'));
        await renderCatalog(route);
      } else if(route==='profile'){
        app.innerHTML = `<div class="content"><h2>Profil</h2><p>Tez orada…</p></div>`;
      } else if(route==='results'){
        app.innerHTML = `<div class="content"><h2>Natijalar</h2><p>Tez orada…</p></div>`;
      } else {
        app.innerHTML = `<div class="content"><h2>${route}</h2><p>Namuna sahifa.</p></div>`;
      }
      setActive(route); history.replaceState({},'', '#'+route); window.scrollTo({top:0,behavior:'smooth'});
    }

    window.addEventListener('hashchange',()=>{ const r=location.hash.replace('#',''); if(routes.includes(r)) loadRoute(r); });
    document.addEventListener('DOMContentLoaded',()=>{ const start=location.hash.replace('#','')||'home'; setActive(start); loadRoute(start); });

  </script>

  <!-- Firebase + logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      query, collection, where, getDocs, serverTimestamp,
      orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.appspot.com",
      messagingSenderId: "992512966017",
      appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId: "G-459PLJ7P7L"
    };

    const appFB = initializeApp(firebaseConfig);
    const db   = getFirestore(appFB);

    const $  = (s, r=document)=>r.querySelector(s);
    function el(html){ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild; }
    const PAGE_SIZE = 12;
    function price(v){ v=+v||0; return v<=0?'<span class="price free">FREE</span>':`<span class="price">${v.toLocaleString('uz-UZ')} so'm</span>`; }
    function card(c){ return `<article class="card3d">${c.image?`<img class="media" src="${c.image}" alt="cover">`:''}<div class="body"><h3 class="ctitle">${c.title||'—'} ${c.tag?`<span class="tag">${String(c.tag).toUpperCase()}</span>`:''} ${c.cat?`<span class="tag">${c.cat}</span>`:''} ${c.cat2?`<span class="tag">${c.cat2}</span>`:''} ${c.cat3?`<span class="tag">${c.cat3}</span>`:''}</h3>${c.desc?`<p class="desc">${c.desc}</p>`:''}<div class="foot">${price(c.price)} ${c.link?`<a class="pill" href="${c.link}" target="${c.link?.startsWith('http')?'_blank':'_self'}">${c.button||'Boshlash'}</a>`:''}</div></div></article>`; }

    async function renderHome(){
      try{
        const qy = query(collection(db,'catalog'), where('type','==','home'), orderBy('updatedAt','desc'), limit(1));
        const snap = await getDocs(qy);
        let banner = null; snap.forEach(d=> banner = d.data());
        if(!banner){
          banner = { title:'Matematika bo‘yicha super kurslar!', desc:'Algebra, Geometriya va Online Testlar — barchasi bitta joyda.', image:'https://picsum.photos/seed/promo/1200/600', link:'#courses', button:'Boshlash', promotag:'PROMO' };
        }
        document.getElementById('hero-bg').style.backgroundImage = `url("${banner.image||''}")`;
        document.getElementById('homeTitle').textContent = banner.title||'';
        document.getElementById('homeDesc').textContent  = banner.desc||'';
        const btn = document.getElementById('homeBtn');
        btn.textContent = banner.button||'Boshlash';
        btn.href = banner.link || '#courses';
        const tg = document.getElementById('homeTag');
        if(banner.promotag||banner.tag){ tg.textContent=(banner.promotag||banner.tag); tg.style.display='inline-block'; }
      }catch(e){ console.warn('Home banner read error', e); }
    }

    async function fetchCatalog(kind){
      const want = {courses:'course', simulators:'sim', tests:'test'}[kind];
      let arr = [];
      try{
        const qy = query(collection(db,'catalog'), where('type','==', want), orderBy('updatedAt','desc'));
        const snap = await getDocs(qy);
        snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
      }catch{
        const qy = query(collection(db,'catalog'), where('type','==', want));
        const snap = await getDocs(qy);
        snap.forEach(d=>arr.push({id:d.id, ...d.data()}));
      }
      arr.sort((a,b)=>{ const ta=a.updatedAt?.toMillis? a.updatedAt.toMillis():0; const tb=b.updatedAt?.toMillis? b.updatedAt.toMillis():0; return tb-ta; });
      if(arr.length>0) return arr;

      // Fallback
      const coll = {courses:'courses', simulators:'simulators', tests:'tests'}[kind];
      const snap = await getDocs(collection(db, coll)); const alt=[];
      snap.forEach(d=>{ const x=d.data(); alt.push({
        id:d.id, type:want, title:x.title||x.name||'', desc:x.desc||x.description||'', image:x.image||x.cover||'',
        link:x.link||x.url||'', button:x.button||'Boshlash', price:Number(x.price||0), tag:x.tag||'', cat:x.cat||'', cat2:x.cat2||'',
        cat3:x.cat3||'', mode:x.mode||'', start:x.start||null, end:x.end||null, updatedAt:x.updatedAt||null
      }); });
      return alt;
    }

    async function renderCatalog(kind){
      const items = await fetchCatalog(kind);
      const $cards = document.getElementById('cards'); const $pi=document.getElementById('pi'); const $badge=document.getElementById('badge');
      let cat='',cat2='',cat3='',tg='',q=''; let page=1;
      const uniq = (list,k)=> Array.from(new Set(list.map(c=>(c[k]||'').trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
      const addOptions=(sel,arr)=>{const el=$(sel); if(!el) return; arr.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; el.appendChild(o); }); }
      addOptions('#f1',uniq(items,'cat')); addOptions('#f2',uniq(items,'cat2')); addOptions('#f3',uniq(items,'cat3'));
      function match(c){ if(cat && String(c.cat||'')!==cat) return false; if(cat2 && String(c.cat2||'')!==cat2) return false; if(cat3 && String(c.cat3||'')!==cat3) return false; if(tg && String(c.tag||'').toLowerCase()!==tg) return false; if(q){ const s=((c.title||'')+' '+(c.desc||'')).toLowerCase(); if(!s.includes(q.toLowerCase())) return false; } return true; }
      function filtered(){ return items.filter(match) }
      function totalPages(){ return Math.max(1, Math.ceil(filtered().length/PAGE_SIZE)) }
      function clamp(){ const t=totalPages(); if(page>t) page=t; if(page<1) page=1; }
      function drawChips(){ const root=document.getElementById('chips'); if(!root) return; root.innerHTML=''; function chip(label, onclear){ const d=document.createElement('button'); d.className='btn'; d.style.borderRadius='999px'; d.style.background='#ffffff'; d.style.borderColor='#cdeee2'; d.innerHTML=label+' ✕'; d.onclick=onclear; return d; } if(cat) root.appendChild(chip("Bo'lim: "+cat, ()=>{cat=''; document.getElementById('f1').value=''; page=1; grid();})); if(cat2) root.appendChild(chip("Bo'lim 2: "+cat2, ()=>{cat2=''; document.getElementById('f2').value=''; page=1; grid();})); if(cat3) root.appendChild(chip("Bo'lim 3: "+cat3, ()=>{cat3=''; document.getElementById('f3').value=''; page=1; grid();})); if(tg) root.appendChild(chip('Tag: '+tg.toUpperCase(), ()=>{tg=''; document.getElementById('ft').value=''; page=1; grid();})); if(q) root.appendChild(chip('Qidiruv: '+q, ()=>{q=''; document.getElementById('fq').value=''; page=1; grid();})); }
      function grid(){ clamp(); $cards.innerHTML=''; const arr=filtered(); const start=(page-1)*PAGE_SIZE; arr.slice(start,start+PAGE_SIZE).forEach(c=>{ $cards.appendChild(el(card(c))); }); $pi.textContent = page+' / '+totalPages(); $badge.textContent = arr.length + ' ta'; drawChips(); const prev=document.getElementById('prev'), next=document.getElementById('next'); prev.disabled=page<=1; next.disabled=page>=totalPages(); prev.onclick=()=>{ if(page>1){page--;grid();} }; next.onclick=()=>{ if(page<totalPages()){page++;grid();} }; }
      document.getElementById('f1')?.addEventListener('change', e=>{cat=e.target.value; page=1; grid();}); document.getElementById('f2')?.addEventListener('change', e=>{cat2=e.target.value; page=1; grid();}); document.getElementById('f3')?.addEventListener('change', e=>{cat3=e.target.value; page=1; grid();}); document.getElementById('ft')?.addEventListener('change', e=>{tg=e.target.value; page=1; grid();}); document.getElementById('fq')?.addEventListener('input', e=>{q=e.target.value; page=1; grid();}); document.getElementById('clear-q')?.addEventListener('click', ()=>{q=''; document.getElementById('fq').value=''; page=1; grid();}); document.getElementById('reset')?.addEventListener('click', ()=>{cat=cat2=cat3=tg=q=''; ['f1','f2','f3','ft','fq'].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';}); page=1; grid();}); grid(); }
  </script>
</body>
</html>
