<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LeaderMath.UZ ‚Äî SPA</title>

  <!-- Firebase Auth (faqat Google login uchun) -->

<style>
    :root{
      --bg1:#ecfff4; --bg2:#fff7e6; --bg3:#eef7ff;
      --ink:#0b1220; --muted:#6b7280;
      --brand:#2E8B57; --brand2:#38bdf8; --brand3:#f59e0b;
      --card:rgba(255,255,255,.70);
      --stroke:rgba(15,23,42,.10);
      --shadow: 0 20px 60px rgba(2,6,23,.12);
      --radius:22px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink); font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(900px 700px at 12% 10%, var(--bg2), transparent 55%),
        radial-gradient(900px 700px at 88% 18%, var(--bg3), transparent 55%),
        radial-gradient(900px 700px at 45% 95%, var(--bg1), transparent 55%),
        linear-gradient(180deg,#ffffff 0%, #f7fff9 100%);
      overflow:hidden;
    }
    .blobs{position:fixed; inset:-40px; pointer-events:none; opacity:.65; filter: blur(24px); z-index:0;}
    .blob{position:absolute; width:320px; height:320px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, rgba(46,139,87,.55), rgba(56,189,248,.25) 55%, transparent 70%);
      animation: drift 12s ease-in-out infinite;
    }
    .blob.b2{width:420px;height:420px; left:65%; top:6%; background: radial-gradient(circle at 30% 30%, rgba(245,158,11,.40), rgba(46,139,87,.22) 55%, transparent 70%); animation-duration: 15s;}
    .blob.b3{width:380px;height:380px; left:10%; top:62%; background: radial-gradient(circle at 30% 30%, rgba(56,189,248,.40), rgba(46,139,87,.20) 55%, transparent 70%); animation-duration: 18s;}
    @keyframes drift{
      0%{transform: translate(0,0) scale(1)}
      50%{transform: translate(40px,-20px) scale(1.06)}
      100%{transform: translate(0,0) scale(1)}
    }

    .app{
      position:relative; z-index:1;
      height:100%; display:flex; flex-direction:column;
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px;
      gap:12px;
    }

    .header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 12px;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.78), rgba(255,255,255,.60));
      backdrop-filter: blur(14px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:0;}
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, rgba(46,139,87,.18), rgba(56,189,248,.16));
      border:1px solid var(--stroke);
      display:grid; place-items:center;
      overflow:hidden;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .site{display:flex; flex-direction:column; line-height:1.05; min-width:0;}
    .site b{font-size:15px; letter-spacing:.2px}
    .site small{color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .userchip{
      display:flex; align-items:center; gap:10px;
      padding:8px 10px;
      border:1px solid var(--stroke);
      border-radius: 18px;
      background: rgba(255,255,255,.62);
      min-width:0;
    }
    .avatar{
      width:36px; height:36px; border-radius:14px;
      background: linear-gradient(135deg, rgba(46,139,87,.18), rgba(245,158,11,.12));
      border:1px solid var(--stroke);
      display:grid; place-items:center; overflow:hidden; flex:0 0 auto;
      cursor:pointer;
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
    .uinfo{min-width:0}
    .uinfo .hello{font-size:12px; color:var(--muted)}
    .uinfo .name{font-size:14px; font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:42vw;}
    .stats{display:flex; gap:6px; flex-wrap:wrap; margin-top:3px;}
    .pill{
      font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.65);
      color:rgba(2,6,23,.8);
    }
    .btn{
      appearance:none; border:0; cursor:pointer;
      padding:10px 12px; border-radius:14px;
      background: linear-gradient(135deg, rgba(46,139,87,.92), rgba(56,189,248,.72));
      color:white; font-weight:900; letter-spacing:.2px;
      box-shadow: 0 14px 28px rgba(46,139,87,.18);
      transition: transform .12s ease, filter .12s ease;
      white-space:nowrap;
    }
    .btn:active{transform: translateY(1px) scale(.99); filter:brightness(.98)}
    .btn.ghost{
      background: rgba(255,255,255,.65);
      color: var(--ink);
      border:1px solid var(--stroke);
      box-shadow:none;
    }

    .main{flex:1; display:flex; flex-direction:column; gap:12px; min-height:0;}
.bottombar{display:none}
@media (max-width:720px){
  .topbar{display:none}
  .bottombar{display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--stroke); border-radius: 22px; background: rgba(255,255,255,.70); backdrop-filter: blur(14px); box-shadow: 0 18px 50px rgba(2,6,23,.10);}
  .bchips{display:flex; gap:8px; overflow:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none; flex:1;}
  .bchips::-webkit-scrollbar{display:none}
  .bchip{flex:0 0 auto; padding:12px 14px; border-radius: 18px; border:1px solid var(--stroke); background: rgba(255,255,255,.72); font-weight:900; font-size:12px; cursor:pointer; display:flex; align-items:center; gap:8px;}
  .bchip[aria-current="page"]{background: linear-gradient(135deg, rgba(46,139,87,.16), rgba(56,189,248,.12)); border-color: rgba(46,139,87,.30)}
}

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px;
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      background: rgba(255,255,255,.62);
      backdrop-filter: blur(14px);
      box-shadow: 0 18px 50px rgba(2,6,23,.10);
    }
    .chips{
      display:flex; gap:8px; overflow:auto; padding-bottom:2px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width:none;
      flex:1; min-width:0;
    }
    .chips::-webkit-scrollbar{display:none}
    .chip{
      flex:0 0 auto;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.70);
      font-weight:900; font-size:12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
      display:flex; align-items:center; gap:8px;
    }
    .chip[aria-current="page"]{
      background: linear-gradient(135deg, rgba(46,139,87,.15), rgba(56,189,248,.12));
      border-color: rgba(46,139,87,.28);
      transform: translateY(-1px);
    }
    .chip .dot{width:8px;height:8px;border-radius:50%; background: rgba(46,139,87,.85)}
    .chip .tag{opacity:.7; font-weight:800}

    .viewport{
      flex:1; min-height:0;
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      overflow:hidden;
      background: rgba(255,255,255,.55);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      position:relative;
    }
    iframe#pageFrame{width:100%; height:100%; border:0; display:block; background:white;}
    .empty{
      position:absolute; inset:0;
      display:grid; place-items:center; padding:18px;
      color: var(--muted);
      text-align:center;
    }
    .empty .card{
      max-width:520px;
      padding:18px; border-radius: 22px;
      background: rgba(255,255,255,.70);
      border:1px solid var(--stroke);
    }
    .empty h2{margin:0 0 8px; color:var(--ink)}
    .empty p{margin:0 0 10px}

    .backdrop{
      position:fixed; inset:0; z-index:50;
      background: rgba(2,6,23,.35);
      backdrop-filter: blur(10px);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 16px;
    }
    .backdrop.show{display:flex}
    .sheet{
      width:min(820px, 100%);
      border-radius: 26px;
      background: rgba(255,255,255,.85);
      border:1px solid var(--stroke);
      box-shadow: 0 30px 90px rgba(2,6,23,.25);
      overflow:hidden;
    }
    .sheetHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:14px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.80));
      border-bottom:1px solid var(--stroke);
    }
    .sheetHeader b{font-size:15px}
    .sheetBody{padding:14px; display:grid; gap:10px}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width:640px){ .row{grid-template-columns:1fr} .uinfo .name{max-width:40vw;} }
    .field{display:grid; gap:6px;}
    .field label{font-size:12px; color:rgba(2,6,23,.72); font-weight:900}
    input,select{
      width:100%;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.8);
      font-size:14px;
      outline:none;
    }
    input:focus,select:focus{border-color: rgba(46,139,87,.45); box-shadow: 0 0 0 4px rgba(46,139,87,.12)}
    .hint{font-size:12px; color:var(--muted)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; padding-top:4px}
    .avatarPick{
      display:flex; gap:10px; align-items:center; padding:10px;
      border:1px dashed rgba(46,139,87,.35);
      border-radius: 18px;
      background: rgba(46,139,87,.06);
    }
    .avatarPick small{color:var(--muted)}
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom: calc(env(safe-area-inset-bottom) + 18px);
      z-index:80;
      background: rgba(2,6,23,.85);
      color:white; padding:10px 12px; border-radius: 14px;
      display:none; max-width:min(700px, 92vw);
      box-shadow: 0 18px 50px rgba(2,6,23,.25);
      font-weight:800; font-size:13px;
    }
    .toast.show{display:block}
  
/* Compact mobile appbar */
@media (max-width:720px){
  .shell{padding:10px 10px 12px;}
  .topbar{padding:10px 10px; border-radius:18px;}
  .brand{gap:10px;}
  .brand img{width:34px;height:34px;border-radius:12px;}
  .brand .meta .title{font-size:14px;}
  .brand .meta .sub{display:none;}
  .usercard{padding:10px 10px; border-radius:18px; min-width:unset;}
  .usercard .left{gap:10px;}
  .avatar{width:34px;height:34px;border-radius:12px;}
  .hello{font-size:11px;}
  .name{font-size:14px;}
  .pills{gap:6px; flex-wrap:nowrap; overflow:auto; scrollbar-width:none;}
  .pills::-webkit-scrollbar{display:none;}
  .pill{padding:6px 10px; font-size:11px;}
  .btn{padding:10px 12px; border-radius:16px;}
}

</style>
</head>

<body>
  <div class="blobs">
    <div class="blob" style="left:6%; top:8%"></div>
    <div class="blob b2"></div>
    <div class="blob b3"></div>
  </div>

  <div class="app">
    <header class="header">
      <div class="brand">
        <div class="logo" title="Logo">
          <img src="logo.png" alt="Logo" onerror="this.style.display='none'; this.parentElement.textContent='œÄ'; this.parentElement.style.fontWeight='900';">
        </div>
        <div class="site">
          <b id="siteName">LeaderMath.UZ</b>
          <small id="siteTag">Premium Spring UI ‚Ä¢ SPA ‚Ä¢ Isolated Pages</small>
        </div>
      </div>

      <div style="display:flex; gap:10px; align-items:center;">
        <button class="btn ghost" id="btnAdmin" style="display:none;">Admin</button>
        <div class="userchip" id="userChip">
          <div class="avatar" id="avatarBox" title="Profil">
            <img id="avatarImg" alt="Avatar" style="display:none;">
            <span id="avatarFallback" style="font-weight:900;">üôÇ</span>
          </div>
          <div class="uinfo">
            <div class="hello" id="hello">Kirish kerak</div>
            <div class="name" id="displayName">Mehmon</div>
            <div class="stats">
              <span class="pill" id="pillId">ID: ‚Äî</span>
              <span class="pill" id="pillPts">Ball: ‚Äî</span>
              <span class="pill" id="pillAge">Yosh: ‚Äî</span>
            </div>
          </div>
          <button class="btn" id="btnLogin">Kirish</button>
        </div>
      </div>
    </header>

    <main class="main">
      <div class="topbar">
        <div class="chips" id="menuChips"></div>
        <button class="btn ghost" id="btnLogout" style="display:none;">Chiqish</button>
      </div>

      <section class="viewport">
        <div class="empty" id="emptyState">
          <div class="card">
            <h2>SPA tayyor ‚úÖ</h2>
            <p>Menyu Firestore‚Äôdan keladi. Sahifalar <b>iframe</b> ichida ‚Äî CSS/JS saytni <b>buzmaydi</b>.</p>
            <p class="hint">Kirish qiling yoki admin bo‚Äòlsangiz menyu + banner/card yarating.</p>
          </div>
        </div>
        <iframe id="pageFrame" sandbox="allow-scripts allow-forms" referrerpolicy="no-referrer"></iframe>
      </section>
    
      <div class="bottombar" id="bottomBar">
        <div class="bchips" id="bottomChips"></div>
        <button class="btn ghost" id="btnLogout2" style="display:none;">Chiqish</button>
      </div>
</main>
  </div>

  <!-- AUTH MODAL -->
  <div class="backdrop" id="authModal">
    <div class="sheet">
      <div class="sheetHeader">
        <b>Kirish / Ro‚Äòyxatdan o‚Äòtish</b>
        <button class="btn ghost" id="authClose">Yopish</button>
      </div>
      <div class="sheetBody">
        <div class="row">
          <div class="field">
            <label>ID</label>
            <input id="loginId" placeholder="Masalan: 123456" autocomplete="username">
            <div class="hint">ID+Parol bilan kirish uchun.</div>
          </div>
          <div class="field">
            <label>Parol</label>
            <input id="loginPass" type="password" placeholder="******" autocomplete="current-password">
            <div class="hint">Agar parolni unutgan bo‚Äòlsangiz, admin orqali tiklash mumkin (keyin qo‚Äòshamiz).</div>
          </div>
        </div>
</div>

        <div class="actions">
          <button class="btn ghost" id="btnOneClick">Bir bosishda ro‚Äòyxatdan o‚Äòtish</button>
                    <button class="btn" id="btnIdLogin">ID+Parol Kirish</button>
        </div>
        <div class="hint" id="authHint"></div>
      </div>
    </div>
  </div>

  <!-- PROFILE MODAL -->
  <div class="backdrop" id="profileModal">
    <div class="sheet">
      <div class="sheetHeader">
        <b>Profilni to‚Äòldiring (majburiy)</b>
        <button class="btn ghost" id="profileClose">Yopish</button>
      </div>
      <div class="sheetBody">
        <div class="avatarPick">
          <div class="avatar" style="width:56px;height:56px;border-radius:20px;cursor:default" aria-hidden="true">
            <img id="pfAvatarImg" alt="Avatar" style="display:none;">
            <span id="pfAvatarFallback" style="font-weight:900;">üôÇ</span>
          </div>
          <div style="flex:1; min-width:0;">
            <b style="font-size:13px;">Avatar</b>
            <div><small>Rasm tanlang ‚Üí server orqali Storage‚Äôga yuklanadi (saytni buzmaydi).</small></div>
          </div>
          <input type="file" id="pfAvatarFile" accept="image/*" style="display:none">
          <button class="btn ghost" id="btnPickAvatar">Rasm tanlash</button>
        </div>

        <div class="row">
          <div class="field">
            <label>Ism</label>
            <input id="pfFirst" placeholder="Ism">
          </div>
          <div class="field">
            <label>Familiya</label>
            <input id="pfLast" placeholder="Familiya">
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Tug‚Äòilgan sana</label>
            <input id="pfBirth" type="date">
            <div class="hint">Headerda ‚ÄúYosh‚Äù avtomatik chiqadi.</div>
          </div>
          <div class="field" id="pfNewPassBox" style="display:none;">
            <label>Yangi parol</label>
            <input id="pfNewPass" type="password" placeholder="Kamida 6 ta belgi">
            <div class="hint">ID+Parol foydalanuvchilari uchun.</div>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Viloyat</label>
            <select id="pfRegion"></select>
          </div>
          <div class="field">
            <label>Tuman / Shahar</label>
            <select id="pfDistrict"></select>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="btnSaveProfile">Saqlash</button>
        </div>
        <div class="hint" id="profileHint"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
const API_BASE = "/.netlify/functions/api";

    const $ = (id)=>document.getElementById(id);
    const toast = (msg)=>{
      const t=$("toast");
      t.textContent=msg;
      t.classList.add("show");
      clearTimeout(window.__toastTimer);
      window.__toastTimer=setTimeout(()=>t.classList.remove("show"), 2600);
    };
    const openModal=(el)=>el.classList.add("show");
    const closeModal=(el)=>el.classList.remove("show");

    function calcAge(birthISO){
      if(!birthISO) return null;
      const d = new Date(birthISO);
      if(isNaN(d.getTime())) return null;
      const now = new Date();
      let age = now.getFullYear() - d.getFullYear();
      const m = now.getMonth() - d.getMonth();
      if(m < 0 || (m===0 && now.getDate() < d.getDate())) age--;
      return age;
    }

    let pendingAvatarDataUrl = null;

const Session = {
      get token(){ return localStorage.getItem("lm_token") || ""; },
      set token(v){ v ? localStorage.setItem("lm_token", v) : localStorage.removeItem("lm_token"); },
      get me(){ try{ return JSON.parse(localStorage.getItem("lm_me")||"null"); }catch(e){return null} },
      set me(v){ v ? localStorage.setItem("lm_me", JSON.stringify(v)) : localStorage.removeItem("lm_me"); },
      clear(){ this.token=""; this.me=null; }
    };

    async function api(path, opts={}){
      const headers = Object.assign({"Content-Type":"application/json"}, opts.headers||{});
      if(Session.token) headers.Authorization = "Bearer " + Session.token;
      const res = await fetch(API_BASE + path, {...opts, headers});
      let data=null;
      try{ data = await res.json(); }catch(e){}
      if(!res.ok){
        const msg = (data && (data.error || data.message)) || (res.status+" "+res.statusText);
        throw new Error(msg);
      }
      return data;
    }

    // ===== Region ‚Üí District from region.json
    let REGION_MAP = null;

    async function loadRegions(){
      if(REGION_MAP) return REGION_MAP;
      const r = await fetch("region.json", {cache:"no-store"});
      REGION_MAP = await r.json();
      return REGION_MAP;
    }

    function fillRegionSelect(map, regionVal="", districtVal=""){
      const regionSel = $("pfRegion");
      const distSel = $("pfDistrict");

      regionSel.innerHTML = `<option value="">Tanlang‚Ä¶</option>` + Object.keys(map)
        .map(r=>`<option value="${r}">${r}</option>`).join("");

      regionSel.value = regionVal || "";
      const districts = map[regionSel.value] || [];
      distSel.innerHTML = `<option value="">Tanlang‚Ä¶</option>` + districts.map(d=>`<option value="${d}">${d}</option>`).join("");
      distSel.value = districtVal || "";
    }

    function bindRegionHandlers(map){
      $("pfRegion").addEventListener("change", ()=>{
        const districts = map[$("pfRegion").value] || [];
        $("pfDistrict").innerHTML = `<option value="">Tanlang‚Ä¶</option>` + districts.map(d=>`<option value="${d}">${d}</option>`).join("");
      });
    }

    // ===== Isolated page loader (iframe srcdoc) + Builder mode
    function buildSrcDoc({title, html="", css="", js="", baseHref=""}){
      const safeTitle = (title||"Page").replace(/</g,"&lt;");
      const baseTag = baseHref ? `<base href="${baseHref}">` : "";
      return `<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
${baseTag}
<title>${safeTitle}</title>
<style>html,body{margin:0;padding:0;font-family:system-ui}</style>
<style>${css||""}</style>
</head>
<body>
${html||""}
<script>${js||""}<\/script>
</body>
</html>`;
    }

    function builderTemplate(item){
      const b = item.builder || {};
      const banners = Array.isArray(b.banners) ? b.banners : [];
      const cards = Array.isArray(b.cards) ? b.cards : [];

      const html = `
<div class="wrap">
  <header class="hero">
    <div class="heroTop">
      <h1>${(item.title||"Sahifa")}</h1>
      <p>Banner + Card builder (admin‚Äôdan boshqariladi)</p>
    </div>

    <div class="carousel" id="car">
      ${banners.map((bn,i)=>{
        if(bn.mode==="html"){
          return `<div class="slide" data-i="${i}"><div class="slideInner">${bn.html||""}</div></div>`;
        }
        return `<div class="slide" data-i="${i}"><img alt="banner" src="${bn.src||""}"></div>`;
      }).join("")}
      <div class="dots" id="dots"></div>
    </div>
  </header>

  <section class="cards">
    ${cards.map(c=>{
      const style = c.cardStyle || "available";
      const active = (c.active !== false);
      const badge = style==="soon" ? "Tez kunda" : (style==="timed" ? "Muddatli" : "Mavjud");
      return `
      <article class="card ${style} ${active? "" : "inactive"}">
        <div class="cardHead">
          <b>${c.title||"Card"}</b>
          <span class="badge">${badge}</span>
        </div>
        <div class="info">${c.infoHtml||""}</div>
        <div class="ctaRow">
          <a class="cta" href="${c.ctaHref||"#"}" target="_blank" rel="noreferrer">${c.ctaLabel||"Ochish"}</a>
        </div>
      </article>`;
    }).join("")}
  </section>
</div>`;

      const css = `
:root{--ink:#0b1220;--muted:#6b7280;--brand:#2E8B57;--stroke:rgba(15,23,42,.12);--shadow:0 18px 60px rgba(2,6,23,.12);--r:22px;}
body{background:linear-gradient(180deg,#ffffff,#f3fff7);color:var(--ink)}
.wrap{padding:14px;max-width:1100px;margin:0 auto;display:grid;gap:14px}
.hero{border:1px solid var(--stroke);border-radius:var(--r);background:rgba(255,255,255,.78);box-shadow:var(--shadow);overflow:hidden}
.heroTop{padding:14px 14px 6px}
.heroTop h1{margin:0;font-size:20px}
.heroTop p{margin:6px 0 0;color:var(--muted);font-weight:700}
.carousel{position:relative;padding:10px 12px 12px}
.slide{border-radius:18px;overflow:hidden;border:1px solid var(--stroke);background:#fff}
.slide img{width:100%;height:220px;object-fit:cover;display:block}
.slideInner{padding:16px}
.dots{display:flex;gap:6px;justify-content:center;margin-top:10px}
.dot{width:8px;height:8px;border-radius:50%;background:rgba(2,6,23,.18)}
.dot.on{background:rgba(46,139,87,.85)}
.cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media(max-width:920px){.cards{grid-template-columns:repeat(2,1fr)}}
@media(max-width:560px){.cards{grid-template-columns:1fr}}
.card{border:1px solid var(--stroke);border-radius:22px;background:rgba(255,255,255,.80);box-shadow:0 14px 40px rgba(2,6,23,.08);padding:14px;display:grid;gap:10px}
.card.inactive{opacity:.55;filter:grayscale(.2)}
.cardHead{display:flex;align-items:center;justify-content:space-between;gap:10px}
.cardHead b{font-size:14px}
.badge{font-size:11px;font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.8)}
.card.available .badge{border-color:rgba(46,139,87,.25);background:rgba(46,139,87,.08)}
.card.soon .badge{border-color:rgba(245,158,11,.25);background:rgba(245,158,11,.10)}
.card.timed .badge{border-color:rgba(56,189,248,.25);background:rgba(56,189,248,.10)}
.info{color:rgba(2,6,23,.86);line-height:1.35}
.ctaRow{display:flex;justify-content:flex-end}
.cta{display:inline-flex;align-items:center;justify-content:center;
  padding:10px 12px;border-radius:14px;font-weight:900;text-decoration:none;color:white;
  background:linear-gradient(135deg, rgba(46,139,87,.92), rgba(56,189,248,.72));}
`;

      const js = `
(function(){
  const slides=[...document.querySelectorAll('.slide')];
  const dots=document.getElementById('dots');
  if(!slides.length) return;
  let i=0;
  function renderDots(){
    dots.innerHTML = slides.map((_,k)=>'<span class="dot '+(k===i?'on':'')+'" data-k="'+k+'"></span>').join('');
    dots.querySelectorAll('.dot').forEach(d=>d.onclick=()=>{i=+d.dataset.k; show();});
  }
  function show(){
    slides.forEach((s,k)=>s.style.display=(k===i?'block':'none'));
    renderDots();
  }
  show();
  setInterval(()=>{ i=(i+1)%slides.length; show(); }, 4500);
})();`;
      return { html, css, js };
    }

    async function loadPage(page){
      const frame = $("pageFrame");
      $("emptyState").style.display = "none";

      // builder mode
      if(page.builder && (page.builder.banners || page.builder.cards)){
        const tpl = builderTemplate(page);
        frame.srcdoc = buildSrcDoc({title: page.title, html: tpl.html, css: tpl.css, js: tpl.js, baseHref: page.baseHref||""});
        return;
      }

      let html = page.inlineHtml || "";
      let css  = page.inlineCss  || "";
      let js   = page.inlineJs   || "";

      async function fetchText(url){
        const r = await fetch(url, {cache:"no-store"});
        if(!r.ok) throw new Error("Yuklab bo‚Äòlmadi: " + url);
        return await r.text();
      }
      if(page.htmlUrl) html = await fetchText(page.htmlUrl);
      if(page.cssUrl)  css  = await fetchText(page.cssUrl);
      if(page.jsUrl)   js   = await fetchText(page.jsUrl);

      frame.srcdoc = buildSrcDoc({title:page.title, html, css, js, baseHref: page.baseHref || ""});
    }

    function setActiveChip(id){
      document.querySelectorAll(".chip").forEach(c=>c.removeAttribute("aria-current"));
      document.querySelectorAll(".bchip").forEach(c=>c.removeAttribute("aria-current"));
      const chip = [...document.querySelectorAll(".chip")].find(x=>x.dataset.id===id);
      if(chip) chip.setAttribute("aria-current","page");
    }

    function renderBottomMenu(menu, activeId){
      const wrap = $("bottomChips");
      if(!wrap) return;
      wrap.innerHTML = "";
      menu.forEach(item=>{
        const b = document.createElement("button");
        b.className = "bchip";
        b.type="button";
        b.dataset.id = item.id;
        b.innerHTML = `<span class="dot"></span> <span>${item.title}</span>`;
        if(item.id === activeId) b.setAttribute("aria-current","page");
        b.addEventListener("click", async ()=>{
          setActiveChip(item.id);
          try{ await loadPage(item); }catch(e){ toast(e.message || "Avatar yuklash ishlamadi. FIREBASE_STORAGE_BUCKET ni tekshiring."); }
        });
        wrap.appendChild(b);
      });
      renderBottomMenu(menu, activeId);
    }

    function renderMenu(menu, activeId){
      const wrap = $("menuChips");
      wrap.innerHTML = "";
      menu.forEach(item=>{
        const b = document.createElement("button");
        b.className = "chip";
        b.type="button";
        b.dataset.id = item.id;
        b.innerHTML = `<span class="dot"></span> <span>${item.title}</span> <span class="tag">#${item.id}</span>`;
        if(item.id === activeId) b.setAttribute("aria-current","page");
        b.addEventListener("click", async ()=>{
          setActiveChip(item.id);
          try{ await loadPage(item); }catch(e){ toast(e.message || "Avatar yuklash ishlamadi. FIREBASE_STORAGE_BUCKET ni tekshiring."); }
        });
        wrap.appendChild(b);
      });
      renderBottomMenu(menu, activeId);
    }

    // ===== Header
    function setHeader(me){
      if(!me){
        $("btnLogout").style.display = "none";
        $("btnLogin").textContent = "Kirish";
        $("hello").textContent = "Kirish kerak";
        $("displayName").textContent = "Mehmon";
        $("pillId").textContent = "ID: ‚Äî";
        $("pillPts").textContent = "Ball: ‚Äî";
        $("pillAge").textContent = "Yosh: ‚Äî";
        $("avatarImg").style.display = "none";
        $("avatarFallback").style.display = "block";
        $("avatarFallback").textContent = "üôÇ";
        $("btnAdmin").style.display = "none";
        const bl=$("btnLogout2"); if(bl) bl.style.display="none";
        return;
      }

      const logged = !!me;
      $("btnLogout").style.display = logged ? "inline-flex" : "none";
      $("btnLogin").textContent = logged ? "Profil" : "Kirish";
      $("hello").textContent = logged ? "Salom üëã" : "Kirish kerak";
      $("displayName").textContent = logged ? (me.profile?.firstName ? (me.profile.firstName + " " + (me.profile.lastName||"")) : (me.email || me.loginId || "Foydalanuvchi")) : "Mehmon";
      $("pillId").textContent = "ID: " + (me.loginId || "‚Äî");
      $("pillPts").textContent = "Ball: " + (me.points ?? 0);
      const age = calcAge(me.profile?.birthdate);
      $("pillAge").textContent = "Yosh: " + (age ?? "‚Äî");

      const photo = me.photoURL || me.avatarSmall || "";
      if(photo){
        $("avatarImg").src = photo;
        $("avatarImg").style.display = "block";
        $("avatarFallback").style.display = "none";

        $("pfAvatarImg").src = photo;
        $("pfAvatarImg").style.display = "block";
        $("pfAvatarFallback").style.display = "none";
      }else{
        $("avatarImg").style.display = "none";
        $("avatarFallback").style.display = "block";
        $("avatarFallback").textContent = (me.profile?.firstName || "üôÇ").slice(0,1).toUpperCase();

        $("pfAvatarImg").style.display = "none";
        $("pfAvatarFallback").style.display = "block";
        $("pfAvatarFallback").textContent = (me.profile?.firstName || "üôÇ").slice(0,1).toUpperCase();
      }

      const isAdmin = (me && ((me.provider==="admin") || (me.isAdmin===true) || (me.email && me.email.toLowerCase() === ADMIN_EMAIL.toLowerCase())));
      
    }

    function requireProfileIfNeeded(me){
      if(!me) return;
      const p = me.profile || {};
      const ok = !!(p.firstName && p.lastName && p.birthdate && p.region && p.district);
      if(!ok){
        openProfileModal(me, true);
      }
    }

    function openProfileModal(me, forced){
      const p = me.profile || {};
      $("pfFirst").value = p.firstName || "";
      $("pfLast").value = p.lastName || "";
      $("pfBirth").value = p.birthdate || "";

      // region/district selects
      fillRegionSelect(REGION_MAP || {}, p.region || "", p.district || "");

      const needsNewPass = (me.provider === "password");
      $("pfNewPassBox").style.display = needsNewPass ? "block" : "none";
      $("pfNewPass").value = "";
      $("profileHint").textContent = forced ? "Davom etish uchun profilni to‚Äòldiring." : "";
      openModal($("profileModal"));
    }
    async function refreshMe(){
      if(!Session.token) { Session.me=null; setHeader(null); return null; }
      const me = await api("/me", {method:"GET"});
      Session.me = me;
      setHeader(me);
      return me;
    }

    
    async function doIdLogin(){
      const id = $("loginId").value.trim();
      const password = $("loginPass").value;
      if(!id || !password) return toast("ID va parol kiriting.");
      $("authHint").textContent = "Tekshirilmoqda‚Ä¶";
      const out = Session.token = out.token;
      await refreshMe();
      closeModal($("authModal"));
      toast("Kirish muvaffaqiyatli ‚úÖ");
      requireProfileIfNeeded(Session.me);
      await loadMenuAndAutoOpen();
    }

    async function doOneClickRegister(){
      $("authHint").textContent = "ID+Parol yaratilmoqda‚Ä¶";
      const out = await api("/auth/register", { method:"POST" });
      $("authHint").innerHTML =
        `‚úÖ ID: <b>${out.loginId}</b> | Parol: <b>${out.password}</b><br><span class="hint">Buni saqlab qo‚Äòying.</span>`;
      Session.token = out.token;
      await refreshMe();
      toast("Ro‚Äòyxatdan o‚Äòtildi ‚úÖ");
      requireProfileIfNeeded(Session.me);
      await loadMenuAndAutoOpen();
    }

    async function saveProfile(){
      const firstName = $("pfFirst").value.trim();
      const lastName = $("pfLast").value.trim();
      const birthdate = $("pfBirth").value;
      const region = $("pfRegion").value;
      const district = $("pfDistrict").value;
      const newPassword = $("pfNewPass").value;

      if(!firstName || !lastName || !birthdate || !region || !district){
        $("profileHint").textContent = "Hamma maydonlarni to‚Äòldiring.";
        return;
      }
      if(Session.me?.provider === "password"){
        if(!newPassword || newPassword.length < 6){
          $("profileHint").textContent = "Yangi parol kamida 6 ta belgi bo‚Äòlsin.";
          return;
        }
      }

      $("profileHint").textContent = "Saqlanmoqda‚Ä¶";
      const out = await api("/me/profile", {
        method:"PUT",
        body: JSON.stringify({profile:{firstName,lastName,birthdate,region,district}, newPassword: (Session.me?.provider==="password") ? newPassword : null })
      });
      Session.me = out;
      setHeader(out);
      closeModal($("profileModal"));
      toast("Profil saqlandi ‚úÖ");
    }

    async function uploadAvatar(file){
      if(!file) return;
      if(!Session.token) return toast("Avval kirish qiling.");
      const maxMB = 2.5;
      if(file.size > maxMB*1024*1024) return toast("Rasm juda katta (‚â§2.5MB).");
      toast("Avatar yuklanmoqda‚Ä¶");

      // 1) get signed upload URL
      const up = await api("/me/avatarUploadDisabled", {method:"POST", body: JSON.stringify({
        contentType: file.type || "image/png",
        ext: (file.name.split(".").pop() || "png").toLowerCase()
      })});

      // 2) PUT to signed url
      const putRes = await fetch(up.uploadUrl, {
        method:"PUT",
        headers: {"Content-Type": up.contentType},
        body: file
      });
      if(!putRes.ok) throw new Error("Upload xato: " + putRes.status);

      // 3) finalize (set token metadata + photoURL)
      const fin = await api("/me/avatarFinalize", {method:"POST", body: JSON.stringify({path: up.path})});
      Session.me = fin;
      setHeader(fin);
      toast("Avatar yangilandi ‚úÖ");
    }

    async function logout(){
      Session.clear();
setHeader(null);
      $("menuChips").innerHTML = "";
      $("emptyState").style.display = "grid";
      $("pageFrame").srcdoc = "";
      toast("Chiqildi");
    }

    async function loadMenu(){
      const data = await api("/menu", {method:"GET"});
      return data.items || [];
    }

    async function loadMenuAndAutoOpen(){
      try{
        const menu = await loadMenu();
        if(!menu.length){
          renderMenu([], "");
          $("emptyState").style.display = "grid";
          return;
        }
        renderMenu(menu, menu[0].id);
        await loadPage(menu[0]);
      }catch(e){ toast(e.message || "Avatar yuklash ishlamadi. FIREBASE_STORAGE_BUCKET ni tekshiring."); }
    }

    // ===== Boot
    window.addEventListener("DOMContentLoaded", async ()=>{

      setHeader(Session.me);

      // Regions
      try{
        const map = await loadRegions();
        fillRegionSelect(map);
        bindRegionHandlers(map);
      }catch(e){
        toast("region.json yuklanmadi");
      }

      $("btnLogin").addEventListener("click", ()=>{
        if(Session.me) openProfileModal(Session.me, false);
        else { $("authHint").textContent=""; openModal($("authModal")); }
      });

      $("avatarBox").addEventListener("click", ()=>{
        if(Session.me) openProfileModal(Session.me, false);
        else openModal($("authModal"));
      });

      $("btnPickAvatar").addEventListener("click", ()=> $("pfAvatarFile").click());
      $("pfAvatarFile").addEventListener("change", async (e)=>{
        try{ await uploadAvatar(e.target.files[0]); }
        catch(err){ toast(err.message); }
        e.target.value = "";
      });

            $("authClose").addEventListener("click", ()=>closeModal($("authModal")));
      $("profileClose").addEventListener("click", ()=>closeModal($("profileModal")));

      $("btnIdLogin").addEventListener("click", async ()=>{
        try{ await doIdLogin(); }
        catch(e){ $("authHint").textContent = e.message; toast(e.message || "Avatar yuklash ishlamadi. FIREBASE_STORAGE_BUCKET ni tekshiring."); }
      });

      $("btnOneClick").addEventListener("click", async ()=>{
        try{ await doOneClickRegister(); }
        catch(e){ $("authHint").textContent = e.message; toast(e.message || "Avatar yuklash ishlamadi. FIREBASE_STORAGE_BUCKET ni tekshiring."); }
      });

      $("btnSaveProfile").addEventListener("click", async ()=>{
        try{ await saveProfile(); }
        catch(e){ $("profileHint").textContent = e.message; toast(e.message || "Avatar yuklash ishlamadi. FIREBASE_STORAGE_BUCKET ni tekshiring."); }
      });
      $("btnLogout").addEventListener("click", logout);
      const bl=$("btnLogout2"); if(bl) bl.addEventListener("click", logout);
// Session restore
      try{
        if(Session.token){
          await refreshMe();
          requireProfileIfNeeded(Session.me);
          await loadMenuAndAutoOpen();
        }else{
          $("emptyState").style.display = "grid";
        }
      }catch(e){
        Session.clear();
        setHeader(null);
      }
    });
  </script>
</body>
</html>