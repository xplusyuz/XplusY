<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>LeaderMath — Mobil (PWA)</title>
  <meta name="theme-color" content="#2E8B57" id="meta-theme-color"/>
  <meta name="color-scheme" content="dark light"/>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./favicon.ico">
  <style>
    :root{--brand:#2E8B57;--brand2:#1F6B45;--bg:#f6faf8;--text:#0f172a;--muted:#6b7c75;--card:#ffffff;--frame:#e3efe8;--chip:#e9f5ef;--chip-b:#cfe9dc}
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .appbar{position:sticky;top:0;z-index:90;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:10px 12px;display:flex;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
    .logo{width:40px;height:40px;border-radius:14px;background:#fff2;display:grid;place-items:center;font-weight:800}
    .title{font-weight:800;font-size:18px}.sub{font-size:11px;color:#dfeee8}.spacer{flex:1}
    .iconbtn{background:#ffffff22;border:1px solid #ffffff33;color:#fff;border-radius:12px;padding:8px 10px;font-weight:700;cursor:pointer}
    .userbar{background:var(--card);border:1px dashed var(--frame);border-radius:14px;margin:10px 12px;padding:10px;display:flex;align-items:center;gap:10px;box-shadow:0 8px 20px #0001}
    .ava{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand2));display:grid;place-items:center;color:#fff;font-weight:800}
    .uinfo{line-height:1.2}.uinfo b{display:block}.uvals{margin-left:auto;text-align:right;font-size:12px}
    .board{background:var(--card);border:1px dashed var(--frame);border-radius:16px;margin:10px 12px;padding:12px}
    .board h3{margin:0 0 8px;font-size:16px}
    .rank{display:grid;grid-template-columns:32px 1fr auto;gap:8px;align-items:center;padding:8px;border-radius:10px;border:1px dashed var(--frame);margin-bottom:6px;background:linear-gradient(180deg,#ffffff,#ffffff00)}
  </style>
</head>
<body>
  <header class="appbar">
    <div class="logo">L</div>
    <div><div class="title">LeaderMath</div><div class="sub">BSB / CHSB dars resurslari</div></div>
    <div class="spacer"></div>
    <button id="themeBtn" class="iconbtn" title="Dark/Light">🌙</button>
    <button id="installBtn" style="display:none">📲 PWA ni o‘rnatish</button>
  </header>

  <section class="userbar" id="userbar">
    <div class="ava" id="ava">LM</div>
    <div class="uinfo">
      <b id="uname">Mehmon</b>
      <span class="sub" id="uid">ID: —</span>
      <div class="sub" id="uschool" style="margin-top:2px">—</div>
      <div class="sub" id="uclass">—</div>
    </div>
    <div class="uvals">
      <div><b id="points">Ball: —</b></div>
      <div style="margin-top:4px">
        <a href="#" id="signin" class="sub">Kirish</a> ·
        <a href="#" id="signout" class="sub" style="display:none">Chiqish</a> ·
        <a class="sub" href="./test.html">Test</a>
      </div>
    </div>
  </section>

  <section class="board">
    <h3>Top 50 — Ball bo‘yicha</h3>
    <div id="boardList" class="sub">Demo holat</div>
  </section>

  <script type="module">
  // Theme + SW
  const themeBtn=document.getElementById('themeBtn'); const key='lm-theme';
  const setTheme=m=>{document.documentElement.classList.toggle('dark',m==='dark');localStorage.setItem(key,m);themeBtn.textContent=m==='dark'?'☀️':'🌙'};
  setTheme(localStorage.getItem(key)||(matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
  themeBtn.onclick=()=>setTheme(document.documentElement.classList.contains('dark')?'light':'dark');
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./service-worker.js'); }

  // ===== Auth (centralized)
  import { auth, db, signOut } from "./lib/firebase.client.js";
  import { watchAuth } from "./lib/auth-guard.js";
  import {
    doc, getDoc, setDoc, runTransaction,
    collection, query, orderBy, limit, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const el = {
    uname: document.getElementById('uname'),
    uid: document.getElementById('uid'),
    points: document.getElementById('points'),
    uschool: document.getElementById('uschool'),
    uclass: document.getElementById('uclass'),
    ava: document.getElementById('ava'),
    signin: document.getElementById('signin'),
    signout: document.getElementById('signout'),
    boardList: document.getElementById('boardList')
  };
  const initials = n => { if(!n) return 'LM'; const p=n.trim().split(/\s+/); return (p[0]?.[0]||'L')+(p[1]?.[0]||'M'); };

  // Login/Logout tugmalari
  el.signin.addEventListener('click',(e)=>{
    e.preventDefault();
    const ret = encodeURIComponent(location.pathname + location.search + location.hash);
    location.href = `./login.html?return=${ret}`;
  });
  el.signout.addEventListener('click', async (e)=>{
    e.preventDefault();
    await signOut(auth);
    const ret = encodeURIComponent('./index.html');
    location.href = `./login.html?return=${ret}`;
  });

  // Foydalanuvchi hujjatini mavjud qilamiz (birinchi kirishda)
  async function ensureUserDoc(user) {
    const ref = doc(db, 'users', user.uid);
    await runTransaction(db, async tx => {
      const snap = await tx.get(ref);
      if (!snap.exists()) {
        tx.set(ref, {
          name: user.displayName || (user.email ? user.email.split('@')[0] : 'Foydalanuvchi'),
          email: user.email || null,
          photoURL: user.photoURL || null,
          role: 'user',
          numericId: Math.floor(1000 + Math.random() * 9000),
          points: 0,
          school: null, class: null,
          createdAt: Date.now()
        });
      }
    });
    return (await getDoc(ref)).data();
  }

  // Leaderboard render
  function renderBoard(users) {
    if (!users?.length) {
      el.boardList.innerHTML = `<div class="sub">Hali ma'lumot yo‘q</div>`;
      return;
    }
    el.boardList.innerHTML = users.map((u,i)=>`
      <div class="rank">
        <div>${i+1}</div>
        <div>
          <b>${u.name || 'Foydalanuvchi'}</b>
          <div class="sub">ID: ${u.numericId || '—'}</div>
          <div class="sub">${u.school ? 'Maktab: '+u.school : 'Maktab: —'} · ${u.class ? 'Sinf: '+u.class : 'Sinf: —'}</div>
        </div>
        <div><b>${Number(u.points)||0}</b></div>
      </div>
    `).join('');
  }

  // Auth holatini kuzatish + leaderboard o‘qish
  let unsubBoard = null;
  watchAuth(async (user)=>{
    if (!user) {
      // mehmon UI
      el.uname.textContent='Mehmon'; el.uid.textContent='ID: —'; el.points.textContent='Ball: —';
      el.uschool.textContent='—'; el.uclass.textContent='—'; el.ava.textContent='LM';
      el.signin.style.display='inline'; el.signout.style.display='none';
      if (unsubBoard) { unsubBoard(); unsubBoard = null; }
      // leaderboard hammaga ochiq bo‘lsa ham, xohlasangiz mehmon holatida ham tinglab turishingiz mumkin
      // bu misolda faqat kirilganida tinglaymiz
      el.boardList.innerHTML = `<div class="sub">Kirishdan so‘ng ko‘rinadi</div>`;
      return;
    }

    el.signin.style.display='none'; el.signout.style.display='inline';

    const uDoc = await ensureUserDoc(user);
    el.uname.textContent = uDoc.name || user.displayName || (user.email?.split('@')[0] ?? 'Foydalanuvchi');
    el.uid.textContent = 'ID: ' + (uDoc.numericId || '—');
    el.points.textContent = 'Ball: ' + (Number(uDoc.points) || 0);
    el.uschool.textContent = uDoc.school ? ('Maktab: '+uDoc.school) : 'Maktab: —';
    el.uclass.textContent  = uDoc.class  ? ('Sinf: '+uDoc.class)   : 'Sinf: —';
    if (user.photoURL) { el.ava.style.backgroundImage=`url(${user.photoURL})`; el.ava.style.backgroundSize='cover'; el.ava.textContent=''; }
    else { el.ava.textContent = initials(el.uname.textContent); }

    // Leaderboard tinglash (Top 50)
    if (unsubBoard) unsubBoard();
    const qUsers = query(collection(db,'users'), orderBy('points','desc'), limit(50));
    unsubBoard = onSnapshot(qUsers, (snap)=>{
      const arr = snap.docs.map(d=>d.data()).sort((a,b)=> (Number(b.points)||0)-(Number(a.points)||0) || (a.numericId??0)-(b.numericId??0));
      renderBoard(arr);
    }, (err)=>{
      console.error('Leaderboard read error:', err);
      el.boardList.innerHTML = '<div class="sub">Leaderboard hozircha yopiq</div>';
    });
  });
</script>

</body>
</html>
