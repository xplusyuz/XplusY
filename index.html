<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OrzuMall ‚Äî Premium Shop</title>
  <meta name="theme-color" content="#6A0DAD" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/logo.png" />
  <link rel="apple-touch-icon" href="/logo.png" />

  <style>
    :root{
      --bg1:#f7f7ff;
      --bg2:#f3f4ff;
      --card:#ffffff;
      --border:rgba(17,24,39,.10);
      --text:#0b1020;
      --muted:#6b7280;
      --brand:#6A0DAD;
      --brand2:#7C2AE8;
      --danger:#ef4444;
      --ok:#12B76A;
      --shadow:0 18px 55px rgba(17,24,39,.14);
      --softShadow:0 10px 28px rgba(0,0,0,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(124,42,232,.20), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(106,13,173,.16), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }
    a{color:inherit;text-decoration:none}
    button{font-family:inherit}
    /* ===== Header (premium glass) ===== */
    .mini-header{
      position:sticky; top:0; z-index:1000;
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 12px;
      backdrop-filter: blur(16px);
      background:rgba(255,255,255,.76);
      border-bottom:1px solid var(--border);
    }
    .h-left{display:flex; align-items:center; gap:10px; min-width:180px}
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:6px 10px; border-radius:16px;
      background:rgba(106,13,173,.07);
      border:1px solid rgba(106,13,173,.16);
      box-shadow:0 10px 25px rgba(106,13,173,.08);
    }
    .brand img{width:30px;height:30px;border-radius:12px}
    .brand .name{font-weight:950;letter-spacing:.2px;color:var(--brand);font-size:16px;line-height:1}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      font-size:12px;font-weight:900;
      background:rgba(255,255,255,.9);
      border:1px solid var(--border);
      padding:7px 10px;border-radius:999px;
      box-shadow:0 8px 18px rgba(0,0,0,.04);
      max-width:42vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .h-right{display:flex;align-items:center;gap:10px}
    .h-btn{
      position:relative;border:1px solid rgba(17,24,39,.10);
      background:#111;color:#fff;border-radius:16px;
      padding:8px 10px;cursor:pointer;font-size:16px;line-height:1;
      min-width:44px;height:40px;
      display:inline-flex;align-items:center;justify-content:center;
      box-shadow:var(--softShadow);
      transition:transform .15s ease, filter .15s ease;
    }
    .h-btn:hover{transform:translateY(-1px);filter:brightness(1.05)}
    .badge{
      position:absolute;top:-6px;right:-6px;
      background:var(--danger);color:#fff;font-size:10px;font-weight:950;
      padding:2px 6px;border-radius:999px;border:2px solid rgba(255,255,255,.95);
    }
    .balance-box{
      display:flex;align-items:center;gap:8px;
      background:rgba(255,255,255,.9);
      border:1px solid var(--border);
      padding:8px 10px;border-radius:16px;
      font-size:13px; box-shadow:0 10px 25px rgba(0,0,0,.06);
    }
    .balance-box b{font-size:13px}
    .avatar{
      width:40px;height:40px;border-radius:16px;overflow:hidden;
      border:1px solid rgba(17,24,39,.10);
      box-shadow:var(--softShadow);
      background:#fff;cursor:pointer;
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}

    /* ===== Layout ===== */
    .wrap{max-width:1180px;margin:0 auto;padding:14px}
    .center{
      min-height:calc(100vh - 66px);
      display:grid;place-items:center;
      padding:28px 14px;
    }
    .panel{
      width:min(560px, 92vw);
      border:1px solid var(--border);
      border-radius:22px;background:rgba(255,255,255,.92);
      box-shadow:var(--shadow);
      padding:18px;
      position:relative;
      overflow:hidden;
    }
    .panel:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(600px 240px at 10% 0%, rgba(106,13,173,.18), transparent 60%),
                  radial-gradient(600px 240px at 90% 0%, rgba(124,42,232,.14), transparent 60%);
      pointer-events:none;
    }
    .panel > *{position:relative}
    h1{font-size:18px;margin:0 0 6px}
    .muted{color:var(--muted);font-size:13px}
    code{background:#f3f4f6;border:1px solid var(--border);border-radius:8px;padding:2px 6px}
    .danger{color:var(--danger);font-weight:900}

    /* Shop top bar */
    .shopTop{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin:10px 0 10px;
    }
    .search{
      flex:1;
      display:flex; align-items:center; gap:10px;
      background:rgba(255,255,255,.92);
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px 12px;
      box-shadow:0 10px 25px rgba(0,0,0,.05);
    }
    .search input{
      border:0; outline:none; background:transparent; width:100%;
      font-size:14px;
    }
    .pillBtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.92);
      border-radius:16px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      box-shadow:0 10px 25px rgba(0,0,0,.05);
      transition:transform .15s ease, filter .15s ease;
    }
    .pillBtn:hover{transform:translateY(-1px);filter:brightness(1.03)}
    .catBar{
      display:flex; gap:8px; overflow:auto; padding:8px 2px 10px;
      scrollbar-width:none;
    }
    .catBar::-webkit-scrollbar{display:none}
    .catChip{
      flex:0 0 auto;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(106,13,173,.18);
      background:rgba(255,255,255,.92);
      font-weight:950;
      font-size:12px;
      box-shadow:0 10px 25px rgba(106,13,173,.06);
      cursor:pointer;
      user-select:none;
      transition:transform .15s ease, background .15s ease;
    }
    .catChip:hover{transform:translateY(-1px)}
    .catChip.active{
      color:#fff;
      border-color:transparent;
      background:linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow:0 18px 40px rgba(106,13,173,.22);
    }

    /* Products */
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:12px}
    @media (min-width:720px){ .grid{grid-template-columns:repeat(4,minmax(0,1fr));} }
    .card{
      border:1px solid var(--border);
      border-radius:22px;
      background:rgba(255,255,255,.92);
      box-shadow:0 16px 40px rgba(0,0,0,.06);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:260px;
    }
    .thumb{
      height:148px;
      background:linear-gradient(135deg, rgba(106,13,173,.20), rgba(124,42,232,.10));
      position:relative;
      display:grid;
      place-items:center;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .thumb .ph{
      width:56px;height:56px;border-radius:18px;
      background:rgba(255,255,255,.65);
      border:1px solid rgba(255,255,255,.75);
      display:grid;place-items:center;
      font-weight:950;color:rgba(17,24,39,.75);
      box-shadow:0 18px 40px rgba(0,0,0,.10);
      backdrop-filter: blur(10px);
    }
    .cardBody{padding:12px 12px 12px; display:flex; flex-direction:column; gap:8px; flex:1}
    .p-title{font-weight:950; font-size:14px; line-height:1.2}
    .p-meta{color:var(--muted);font-size:12px; display:flex; justify-content:space-between; gap:10px}
    .p-price{margin-top:auto; font-weight:950; font-size:15px}
    .p-cta{margin-top:10px;display:flex;gap:10px}
    .btn{
      border:1px solid var(--border);
      background:#111;color:#fff;border-radius:14px;padding:10px 12px;
      cursor:pointer;font-weight:950; flex:1;
      transition:transform .15s ease, filter .15s ease;
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(1.05)}
    .btn.secondary{background:rgba(255,255,255,.92);color:#111}
    .btn.secondary.active{
      background:rgba(239,68,68,.10);
      border-color:rgba(239,68,68,.25);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}

    /* Modal */
    .modal-overlay{
      position:fixed;inset:0;background:rgba(17,24,39,.55);
      display:none;align-items:center;justify-content:center;z-index:2000;padding:16px;
    }
    .modal{
      width:min(720px, 96vw);
      background:rgba(255,255,255,.96);
      border:1px solid var(--border);border-radius:22px;
      box-shadow:0 20px 70px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modal-h{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(106,13,173,.12), rgba(255,255,255,1));
      gap:10px;
    }
    .modal-h b{font-size:14px}
    .modal-b{padding:14px 16px}
    .modal-f{
      padding:12px 16px;border-top:1px solid var(--border);
      display:flex;gap:10px;justify-content:flex-end;align-items:center;
    }
    .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    .field label{font-size:12px;color:var(--muted);font-weight:900}
    .field input{
      border:1px solid var(--border);border-radius:14px;padding:12px 12px;font-size:14px;outline:none;
      background:rgba(255,255,255,.9);
    }
    .field input:focus{border-color:rgba(106,13,173,.55);box-shadow:0 0 0 4px rgba(106,13,173,.12)}
    .list{display:flex;flex-direction:column;gap:10px}
    .row{
      display:flex;gap:12px;align-items:center;
      border:1px solid var(--border); border-radius:18px;
      padding:10px; background:rgba(255,255,255,.92);
      box-shadow:0 10px 25px rgba(0,0,0,.04);
    }
    .row .miniThumb{
      width:54px;height:54px;border-radius:16px;
      overflow:hidden;border:1px solid rgba(17,24,39,.10);
      background:linear-gradient(135deg, rgba(106,13,173,.16), rgba(124,42,232,.10));
      display:grid;place-items:center;
      flex:0 0 auto;
    }
    .row .miniThumb img{width:100%;height:100%;object-fit:cover;display:block}
    .row .t{font-weight:950}
    .row .m{color:var(--muted);font-size:12px;margin-top:2px}
    .row .right{margin-left:auto; display:flex; gap:8px; align-items:center}
    .qty{
      display:flex; align-items:center; gap:8px;
      border:1px solid var(--border); border-radius:14px;
      padding:6px 8px; background:rgba(255,255,255,.92);
    }
    .qty button{
      width:30px;height:30px;border-radius:12px;
      border:1px solid var(--border);
      background:#111;color:#fff; cursor:pointer; font-weight:950;
    }
    .qty span{min-width:22px;text-align:center;font-weight:950}
    .ghostBtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.92);
      border-radius:14px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:950;
    }

    .toast{
      position:fixed;left:50%;transform:translateX(-50%);
      bottom:18px;z-index:3000;background:#111;color:#fff;
      padding:10px 12px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.22);
      font-size:13px;display:none;max-width:min(92vw,520px)
    }
    .hint{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>

  <header class="mini-header">
    <div class="h-left">
      <a class="brand" href="#" onclick="return false">
        <img src="/logo.png" alt="logo"/>
        <div class="name">OrzuMall</div>
      </a>
      <span class="chip" id="authChip">‚õî Guest</span>
    </div>

    <div class="h-right">
      <button class="h-btn" id="favBtn" title="Sevimlilar">
        ‚ù§Ô∏è <span class="badge" id="favCount">0</span>
      </button>
      <button class="h-btn" id="cartBtn" title="Savatcha">
        üõí <span class="badge" id="cartCount">0</span>
      </button>
      <div class="balance-box" title="Balans">
        <span>üí∞</span> <b id="balance">0</b>
      </div>
      <div class="avatar" id="avatarBox" title="Profil">
        <img id="avatarImg" alt="avatar" src=""/>
      </div>
    </div>
  </header>

  <!-- LOGIN SCREEN -->
  <main class="center" id="loginScreen">
    <div class="panel">
      <h1>Telegram orqali kirish</h1>
      <div class="muted">
        Telegram Login Widget ‚Üí Netlify Function (<code>/.netlify/functions/tg-auth</code>) ‚Üí Firebase Custom Token ‚Üí Firestore <code>users/{uid}</code>
        <div style="margin-top:10px" class="hint">
          Agar <span class="danger">Bot domain invalid</span> chiqsa: BotFather ‚Üí <code>/setdomain</code> ‚Üí domen: <code id="domainText"></code>
        </div>
      </div>
      <div style="margin-top:14px" id="tgLogin"></div>
      <div class="hint" id="loginHint" style="margin-top:12px">Kutilmoqda‚Ä¶</div>
      <pre id="out" style="display:none"></pre>
    </div>
  </main>

  <!-- SHOP SCREEN -->
  <main id="shopScreen" style="display:none">
    <div class="wrap">

      <div class="shopTop">
        <div class="search">
          <span>üîé</span>
          <input id="q" placeholder="Mahsulot qidiring‚Ä¶" />
        </div>
        <button class="pillBtn" id="reloadProducts" title="Yangilash">‚Üª</button>
      </div>

      <div class="catBar" id="catBar"></div>

      <div id="grid" class="grid"></div>

      <div id="debugBox" style="display:none;margin-top:14px">
        <pre id="out2">...</pre>
      </div>
    </div>
  </main>

  <!-- REQUIRED PROFILE MODAL -->
  <div class="modal-overlay" id="profileReqOverlay">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="prTitle">
      <div class="modal-h">
        <b id="prTitle">Profilni to‚Äòldiring (majburiy)</b>
        <span class="chip">1 marta</span>
      </div>
      <div class="modal-b">
        <div class="muted">Davom etish uchun ism-familiya va telefon raqam kerak.</div>

        <div class="field">
          <label>Ism-familiya</label>
          <input id="prName" placeholder="Masalan: Sohibjon Sattorov" autocomplete="name" />
        </div>

        <div class="field">
          <label>Telefon raqam</label>
          <input id="prPhone" placeholder="+998 90 123 45 67" inputmode="tel" autocomplete="tel" />
        </div>

        <div class="hint" style="margin-top:10px">Telefon: <code>+998901234567</code> yoki 9 ta raqam.</div>
      </div>
      <div class="modal-f">
        <button class="btn" id="prSaveBtn">Saqlash</button>
      </div>
    </div>
  </div>

  <!-- PROFILE VIEW MODAL (avatar click) -->
  <div class="modal-overlay" id="profileViewOverlay">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pvTitle">
      <div class="modal-h">
        <b id="pvTitle">Profil</b>
        <div style="display:flex;gap:10px;align-items:center">
          <button class="ghostBtn" id="pvLogoutBtn">Logout</button>
          <button class="ghostBtn" id="pvCloseBtn">Yopish</button>
        </div>
      </div>
      <div class="modal-b">
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px">
          <div class="avatar" style="width:56px;height:56px;border-radius:18px">
            <img id="pvAvatar" alt="avatar" />
          </div>
          <div>
            <div style="font-weight:950" id="pvName">‚Äî</div>
            <div class="muted" id="pvPhone">‚Äî</div>
          </div>
        </div>

        <div class="field">
          <label>Telegram username</label>
          <input id="pvUsername" disabled />
        </div>
        <div class="field">
          <label>Telegram ID</label>
          <input id="pvTgId" disabled />
        </div>
        <div class="field">
          <label>Firebase UID</label>
          <input id="pvUid" disabled />
        </div>
      </div>
    </div>
  </div>

  <!-- FAVORITES MODAL -->
  <div class="modal-overlay" id="favOverlay">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="favTitle">
      <div class="modal-h">
        <b id="favTitle">Sevimlilar</b>
        <div style="display:flex;gap:10px;align-items:center">
          <button class="ghostBtn" id="favClose">Yopish</button>
        </div>
      </div>
      <div class="modal-b">
        <div class="list" id="favList"></div>
        <div class="hint" id="favEmpty" style="display:none">Hali sevimlilar yo‚Äòq.</div>
      </div>
      <div class="modal-f">
        <button class="ghostBtn" id="favToCartAll">Hammasini savatga</button>
      </div>
    </div>
  </div>

  <!-- CART MODAL -->
  <div class="modal-overlay" id="cartOverlay">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="cartTitle">
      <div class="modal-h">
        <b id="cartTitle">Savatcha</b>
        <div style="display:flex;gap:10px;align-items:center">
          <button class="ghostBtn" id="cartClose">Yopish</button>
        </div>
      </div>
      <div class="modal-b">
        <div class="list" id="cartList"></div>
        <div class="hint" id="cartEmpty" style="display:none">Savatcha bo‚Äòsh.</div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
          <div class="hint">Jami</div>
          <div style="font-weight:950;font-size:16px" id="cartTotal">0 so‚Äòm</div>
        </div>
      </div>
      <div class="modal-f">
        <button class="ghostBtn" id="cartClear">Tozalash</button>
        <button class="btn" id="checkoutBtn">Buyurtma</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    // ===== Firebase config =====
    // Firebase Console ‚Üí Project settings ‚Üí Your apps ‚Üí Web app ‚Üí firebaseConfig
    const firebaseConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithCustomToken, signOut }
      from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      doc, getDoc, setDoc, updateDoc, deleteDoc,
      collection, onSnapshot, serverTimestamp, increment
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // UI refs
    const toast = document.getElementById("toast");
    const loginHint = document.getElementById("loginHint");
    const out = document.getElementById("out");
    const out2 = document.getElementById("out2");
    const debugBox = document.getElementById("debugBox");

    const loginScreen = document.getElementById("loginScreen");
    const shopScreen = document.getElementById("shopScreen");
    const grid = document.getElementById("grid");
    const catBar = document.getElementById("catBar");
    const q = document.getElementById("q");

    // Header
    const authChip = document.getElementById("authChip");
    const avatarImg = document.getElementById("avatarImg");
    const balanceEl = document.getElementById("balance");
    const favCountEl = document.getElementById("favCount");
    const cartCountEl = document.getElementById("cartCount");

    document.getElementById("domainText").textContent = location.host;

    const DEBUG = new URLSearchParams(location.search).get("debug") === "1";
    if (DEBUG) { debugBox.style.display = "block"; out.style.display = "block"; }

    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>toast.style.display="none", 2200);
    }
    function logTo(el, v){
      if (!DEBUG) return;
      el.textContent = typeof v === "string" ? v : JSON.stringify(v, null, 2);
    }

    // Firebase init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Modals
    const profileReqOverlay = document.getElementById("profileReqOverlay");
    const prName = document.getElementById("prName");
    const prPhone = document.getElementById("prPhone");
    const prSaveBtn = document.getElementById("prSaveBtn");

    const profileViewOverlay = document.getElementById("profileViewOverlay");
    const pvCloseBtn = document.getElementById("pvCloseBtn");
    const pvLogoutBtn = document.getElementById("pvLogoutBtn");
    const pvAvatar = document.getElementById("pvAvatar");
    const pvName = document.getElementById("pvName");
    const pvPhone = document.getElementById("pvPhone");
    const pvUsername = document.getElementById("pvUsername");
    const pvTgId = document.getElementById("pvTgId");
    const pvUid = document.getElementById("pvUid");

    pvCloseBtn.onclick = () => profileViewOverlay.style.display = "none";
    pvLogoutBtn.onclick = async () => { await signOut(auth); profileViewOverlay.style.display="none"; showToast("Logout"); };

    profileReqOverlay.addEventListener("click", (e) => {
      if (e.target === profileReqOverlay) showToast("Profilni to‚Äòldirish majburiy.");
    });

    // Favorites / Cart overlays
    const favOverlay = document.getElementById("favOverlay");
    const favList = document.getElementById("favList");
    const favEmpty = document.getElementById("favEmpty");
    document.getElementById("favClose").onclick = ()=> favOverlay.style.display="none";
    favOverlay.addEventListener("click", (e)=>{ if(e.target===favOverlay) favOverlay.style.display="none"; });

    const cartOverlay = document.getElementById("cartOverlay");
    const cartList = document.getElementById("cartList");
    const cartEmpty = document.getElementById("cartEmpty");
    const cartTotal = document.getElementById("cartTotal");
    document.getElementById("cartClose").onclick = ()=> cartOverlay.style.display="none";
    cartOverlay.addEventListener("click", (e)=>{ if(e.target===cartOverlay) cartOverlay.style.display="none"; });

    // State
    let PRODUCTS = [];
    let PRODUCTS_BY_ID = new Map();
    let currentCategory = "Barchasi";
    let favSet = new Set();
    let cartMap = new Map(); // productId -> qty
    let unsubFav = null;
    let unsubCart = null;

    function money(n){
      return Number(n||0).toLocaleString("uz-UZ") + " so‚Äòm";
    }

    function normalizePhone(s){
      const raw = String(s||"").trim();
      const digits = raw.replace(/\D+/g,"");
      if (digits.startsWith("998") && digits.length === 12) return "+"+digits;
      if (digits.length === 9) return "+998"+digits;
      return null;
    }

    async function openProfileView(user, docData){
      const name = docData?.profile?.name || docData?.tg?.username || user.displayName || "User";
      const phone = docData?.profile?.phone || "‚Äî";
      const avatar =
        docData?.profile?.avatar ||
        docData?.tg?.photo_url ||
        user.photoURL ||
        ("https://ui-avatars.com/api/?name=" + encodeURIComponent(name) + "&background=F3F4F6&color=111");

      pvAvatar.src = avatar;
      pvName.textContent = name;
      pvPhone.textContent = phone;

      pvUsername.value = docData?.tg?.username ? ("@" + docData.tg.username) : "‚Äî";
      pvTgId.value = docData?.tg?.id ? String(docData.tg.id) : "‚Äî";
      pvUid.value = user.uid;

      profileViewOverlay.style.display = "flex";
    }

    document.getElementById("avatarBox").onclick = async () => {
      const user = auth.currentUser;
      if (!user) return showToast("Avval login qiling");
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) return showToast("User doc topilmadi");
      await openProfileView(user, snap.data());
    };

    async function ensureRequiredProfile(user, docData){
      const nameOk = !!(docData?.profile?.name && String(docData.profile.name).trim().length >= 3);
      const phoneOk = !!normalizePhone(docData?.profile?.phone);
      if (nameOk && phoneOk) {
        profileReqOverlay.style.display = "none";
        return true;
      }
      prName.value = (docData?.profile?.name || user.displayName || "").trim();
      prPhone.value = (docData?.profile?.phone || "").trim();
      profileReqOverlay.style.display = "flex";
      return false;
    }

    prSaveBtn.onclick = async () => {
      const user = auth.currentUser;
      if (!user) return;

      const name = String(prName.value||"").trim();
      const phone = normalizePhone(prPhone.value);

      if (name.length < 3) return showToast("Ism-familiya noto‚Äòg‚Äòri");
      if (!phone) return showToast("Telefon noto‚Äòg‚Äòri. Masalan: +998901234567");

      try {
        const ref = doc(db, "users", user.uid);
        await updateDoc(ref, {
          "profile.name": name,
          "profile.phone": phone,
          updatedAt: serverTimestamp(),
        });
        showToast("Saqlandi ‚úÖ");
        profileReqOverlay.style.display = "none";
        authChip.textContent = "‚úÖ " + name;
        await loadProducts();
        setupRealtime(user);
      } catch (e) {
        showToast("Saqlash xato: " + (e?.message || e));
        logTo(out2, { ok:false, error: e?.message || String(e) });
      }
    };

    async function fetchProducts(){
      // Hozircha: /products.json dan. Keyin admin panel orqali Firestore products ga o‚Äòtasiz.
      const res = await fetch("/products.json", { cache: "no-store" });
      const json = await res.json();
      const items = (json.products || []).map(p => ({
        id: String(p.id),
        title: p.title ?? "No title",
        price: Number(p.price||0),
        category: p.category ?? "Boshqa",
        image: p.image || ""
      }));
      PRODUCTS = items;
      PRODUCTS_BY_ID = new Map(items.map(p => [p.id, p]));

      // Categories
      const cats = Array.from(new Set(items.map(p=>p.category))).sort((a,b)=>a.localeCompare(b));
      renderCategories(["Barchasi", ...cats]);

      // Keep current category valid
      if (currentCategory !== "Barchasi" && !cats.includes(currentCategory)) currentCategory = "Barchasi";

      renderGrid();
    }

    function renderCategories(list){
      catBar.innerHTML = list.map(c => `
        <div class="catChip ${c===currentCategory ? "active":""}" data-cat="${encodeURIComponent(c)}">${c}</div>
      `).join("");
      catBar.querySelectorAll("[data-cat]").forEach(el=>{
        el.onclick = ()=>{
          currentCategory = decodeURIComponent(el.getAttribute("data-cat"));
          renderCategories(list);
          renderGrid();
        };
      });
    }

    function productPlaceholderLetter(title){
      const t = String(title||"").trim();
      if (!t) return "OM";
      const first = t[0].toUpperCase();
      return first;
    }

    function renderGrid(){
      const needle = String(q.value||"").trim().toLowerCase();

      const filtered = PRODUCTS.filter(p=>{
        if (currentCategory !== "Barchasi" && p.category !== currentCategory) return false;
        if (!needle) return true;
        return (p.title||"").toLowerCase().includes(needle) || (p.category||"").toLowerCase().includes(needle);
      });

      if (!filtered.length){
        grid.innerHTML = "<div class='muted'>Hech narsa topilmadi.</div>";
        return;
      }

      grid.innerHTML = filtered.map(p => {
        const liked = favSet.has(p.id);
        return `
          <div class="card">
            <div class="thumb">
              ${p.image ? `<img src="${p.image}" alt="${escapeHtml(p.title)}" />` : `<div class="ph">${escapeHtml(productPlaceholderLetter(p.title))}</div>`}
            </div>
            <div class="cardBody">
              <div class="p-title">${escapeHtml(p.title)}</div>
              <div class="p-meta">
                <span>${escapeHtml(p.category)}</span>
                <span class="hint">${cartMap.has(p.id) ? ("Savat: " + cartMap.get(p.id)) : ""}</span>
              </div>
              <div class="p-price">${money(p.price)}</div>
              <div class="p-cta">
                <button class="btn" data-add="${p.id}">Savatga</button>
                <button class="btn secondary ${liked ? "active":""}" data-like="${p.id}" title="Sevimli">
                  ‚ù§Ô∏è
                </button>
              </div>
            </div>
          </div>
        `;
      }).join("");

      grid.querySelectorAll("[data-add]").forEach(btn=>{
        btn.onclick = async ()=>{
          const user = auth.currentUser;
          if (!user) return showToast("Avval login qiling");
          const id = btn.getAttribute("data-add");
          await addToCart(user.uid, id, 1);
          showToast("Savatga qo‚Äòshildi ‚úÖ");
        };
      });

      grid.querySelectorAll("[data-like]").forEach(btn=>{
        btn.onclick = async ()=>{
          const user = auth.currentUser;
          if (!user) return showToast("Avval login qiling");
          const id = btn.getAttribute("data-like");
          await toggleFavorite(user.uid, id);
        };
      });
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function toggleFavorite(uid, productId){
      const ref = doc(db, "users", uid, "favorites", productId);
      if (favSet.has(productId)) {
        await deleteDoc(ref);
        showToast("Sevimlidan olib tashlandi");
      } else {
        await setDoc(ref, { createdAt: serverTimestamp() }, { merge: true });
        showToast("Sevimlilarga qo‚Äòshildi ‚úÖ");
      }
    }

    async function addToCart(uid, productId, delta){
      const ref = doc(db, "users", uid, "cart", productId);
      await setDoc(ref, { qty: increment(delta), updatedAt: serverTimestamp() }, { merge: true });
    }

    async function setCartQty(uid, productId, qty){
      const ref = doc(db, "users", uid, "cart", productId);
      if (qty <= 0) await deleteDoc(ref);
      else await setDoc(ref, { qty, updatedAt: serverTimestamp() }, { merge: true });
    }

    async function clearCart(uid){
      // Small cart: delete one by one
      const snapUnsub = null; // placeholder
      // We'll render from cartMap and delete sequentially
      for (const [pid] of Array.from(cartMap.entries())) {
        await deleteDoc(doc(db, "users", uid, "cart", pid));
      }
    }

    function renderFavoritesModal(){
      const user = auth.currentUser;
      if (!user) return;

      const favIds = Array.from(favSet.values());
      favEmpty.style.display = favIds.length ? "none" : "block";
      favList.innerHTML = favIds.map(pid=>{
        const p = PRODUCTS_BY_ID.get(pid) || { id: pid, title: "Mahsulot", price: 0, category: "‚Äî", image:"" };
        return `
          <div class="row">
            <div class="miniThumb">${p.image ? `<img src="${p.image}" alt="${escapeHtml(p.title)}" />` : `<span style="font-weight:950;color:rgba(17,24,39,.75)">${escapeHtml(productPlaceholderLetter(p.title))}</span>`}</div>
            <div>
              <div class="t">${escapeHtml(p.title)}</div>
              <div class="m">${escapeHtml(p.category)} ‚Ä¢ ${money(p.price)}</div>
            </div>
            <div class="right">
              <button class="ghostBtn" data-fav-add="${pid}">Savatga</button>
              <button class="ghostBtn" data-fav-del="${pid}">O‚Äòchirish</button>
            </div>
          </div>
        `;
      }).join("");

      favList.querySelectorAll("[data-fav-del]").forEach(b=>{
        b.onclick = async ()=>{
          const pid = b.getAttribute("data-fav-del");
          await toggleFavorite(user.uid, pid);
          renderFavoritesModal();
          renderGrid();
        };
      });
      favList.querySelectorAll("[data-fav-add]").forEach(b=>{
        b.onclick = async ()=>{
          const pid = b.getAttribute("data-fav-add");
          await addToCart(user.uid, pid, 1);
          showToast("Savatga qo‚Äòshildi ‚úÖ");
        };
      });
    }

    function renderCartModal(){
      const user = auth.currentUser;
      if (!user) return;

      const items = Array.from(cartMap.entries()).map(([pid, qty])=>{
        const p = PRODUCTS_BY_ID.get(pid) || { id: pid, title: "Mahsulot", price: 0, category: "‚Äî", image:"" };
        return { ...p, qty };
      });

      cartEmpty.style.display = items.length ? "none" : "block";

      let total = 0;
      for (const it of items) total += (Number(it.price||0) * Number(it.qty||0));
      cartTotal.textContent = money(total);

      cartList.innerHTML = items.map(it => `
        <div class="row">
          <div class="miniThumb">${it.image ? `<img src="${it.image}" alt="${escapeHtml(it.title)}" />` : `<span style="font-weight:950;color:rgba(17,24,39,.75)">${escapeHtml(productPlaceholderLetter(it.title))}</span>`}</div>
          <div>
            <div class="t">${escapeHtml(it.title)}</div>
            <div class="m">${escapeHtml(it.category)} ‚Ä¢ ${money(it.price)}</div>
          </div>
          <div class="right">
            <div class="qty">
              <button data-dec="${it.id}">‚àí</button>
              <span>${it.qty}</span>
              <button data-inc="${it.id}">+</button>
            </div>
            <button class="ghostBtn" data-rm="${it.id}">O‚Äòchirish</button>
          </div>
        </div>
      `).join("");

      cartList.querySelectorAll("[data-inc]").forEach(b=>{
        b.onclick = async ()=>{
          const pid = b.getAttribute("data-inc");
          await addToCart(user.uid, pid, 1);
        };
      });
      cartList.querySelectorAll("[data-dec]").forEach(b=>{
        b.onclick = async ()=>{
          const pid = b.getAttribute("data-dec");
          const current = cartMap.get(pid) || 0;
          await setCartQty(user.uid, pid, current - 1);
        };
      });
      cartList.querySelectorAll("[data-rm]").forEach(b=>{
        b.onclick = async ()=>{
          const pid = b.getAttribute("data-rm");
          await setCartQty(user.uid, pid, 0);
        };
      });
    }

    function setupRealtime(user){
      // Clean old listeners
      if (unsubFav) { unsubFav(); unsubFav = null; }
      if (unsubCart) { unsubCart(); unsubCart = null; }

      const favCol = collection(db, "users", user.uid, "favorites");
      const cartCol = collection(db, "users", user.uid, "cart");

      unsubFav = onSnapshot(favCol, (snap)=>{
        favSet = new Set(snap.docs.map(d=>d.id));
        favCountEl.textContent = String(favSet.size);
        renderGrid();
        if (favOverlay.style.display === "flex") renderFavoritesModal();
      });

      unsubCart = onSnapshot(cartCol, (snap)=>{
        const m = new Map();
        snap.docs.forEach(d=>{
          const data = d.data();
          const qty = Number(data?.qty || 0);
          if (qty > 0) m.set(d.id, qty);
        });
        cartMap = m;
        let count = 0;
        for (const v of cartMap.values()) count += v;
        cartCountEl.textContent = String(count);
        renderGrid();
        if (cartOverlay.style.display === "flex") renderCartModal();
      });
    }

    document.getElementById("favBtn").onclick = () => {
      const user = auth.currentUser;
      if (!user) return showToast("Avval login qiling");
      favOverlay.style.display = "flex";
      renderFavoritesModal();
    };

    document.getElementById("cartBtn").onclick = () => {
      const user = auth.currentUser;
      if (!user) return showToast("Avval login qiling");
      cartOverlay.style.display = "flex";
      renderCartModal();
    };

    document.getElementById("favToCartAll").onclick = async ()=>{
      const user = auth.currentUser;
      if (!user) return;
      const ids = Array.from(favSet.values());
      if (!ids.length) return showToast("Sevimlilar bo‚Äòsh");
      for (const pid of ids) await addToCart(user.uid, pid, 1);
      showToast("Hammasi savatga ‚úÖ");
    };

    document.getElementById("cartClear").onclick = async ()=>{
      const user = auth.currentUser;
      if (!user) return;
      if (!cartMap.size) return showToast("Savatcha bo‚Äòsh");
      await clearCart(user.uid);
      showToast("Tozalandi");
    };

    document.getElementById("checkoutBtn").onclick = ()=>{
      if (!cartMap.size) return showToast("Savatcha bo‚Äòsh");
      showToast("Buyurtma bosqichi (keyingi bosqichda) ‚úÖ");
      // Next step: /order page or Telegram order send
    };

    document.getElementById("reloadProducts").onclick = fetchProducts;
    q.addEventListener("input", ()=> renderGrid());

    async function loadProducts(){
      await fetchProducts();
    }

    function setGuestHeader(){
      authChip.textContent = "‚õî Guest";
      balanceEl.textContent = "0";
      favCountEl.textContent = "0";
      cartCountEl.textContent = "0";
      avatarImg.src = "https://ui-avatars.com/api/?name=Guest&background=F3F4F6&color=111";
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        loginScreen.style.display = "grid";
        shopScreen.style.display = "none";
        setGuestHeader();
        loginHint.textContent = "Login qilinmagan.";
        logTo(out, "Login qilinmagan.");
        if (unsubFav) unsubFav();
        if (unsubCart) unsubCart();
        unsubFav = null; unsubCart = null;
        favSet = new Set();
        cartMap = new Map();
        return;
      }

      loginScreen.style.display = "none";
      shopScreen.style.display = "block";
      loginHint.textContent = "";

      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      const docData = snap.exists() ? snap.data() : null;

      const name =
        docData?.profile?.name ||
        docData?.tg?.username ||
        user.displayName ||
        "User";

      const avatar =
        docData?.profile?.avatar ||
        docData?.tg?.photo_url ||
        user.photoURL ||
        ("https://ui-avatars.com/api/?name=" + encodeURIComponent(name) + "&background=F3F4F6&color=111");

      authChip.textContent = "‚úÖ " + name;
      avatarImg.src = avatar;

      balanceEl.textContent = (docData?.balance ?? 0).toLocaleString("uz-UZ");

      logTo(out2, { ok:true, uid: user.uid, hasUserDoc: snap.exists(), userDoc: docData });

      const ok = await ensureRequiredProfile(user, docData);
      if (ok) {
        setupRealtime(user);
        await loadProducts();
      } else {
        grid.innerHTML = "";
      }
    });

    // ===== Telegram Login =====
    const BOT_USERNAME = "OrzuMallUZ_bot"; // @ ni yozmang

    window.onTelegramAuth = async (tgUser) => {
      try {
        loginHint.textContent = "Tekshirilmoqda‚Ä¶";
        logTo(out, { step:"telegram_callback", tgUser });

        const r = await fetch("/.netlify/functions/tg-auth", {
          method: "POST",
          headers: { "content-type":"application/json" },
          body: JSON.stringify({ tg: tgUser })
        });

        const j = await r.json();
        if (!j.ok) throw new Error(j.error || "Auth failed");
        logTo(out, { step:"got_customToken", uid: j.uid });

        await signInWithCustomToken(auth, j.customToken);
        showToast("Login OK ‚úÖ");
      } catch (e) {
        logTo(out, { ok:false, error: e.message });
        loginHint.textContent = "Xato: " + e.message;
        showToast("Xato: " + e.message);
      }
    };

    const s = document.createElement("script");
    s.async = true;
    s.src = "https://telegram.org/js/telegram-widget.js?22";
    s.setAttribute("data-telegram-login", BOT_USERNAME);
    s.setAttribute("data-size", "large");
    s.setAttribute("data-userpic", "true");
    s.setAttribute("data-request-access", "write");
    s.setAttribute("data-onauth", "onTelegramAuth(user)");
    document.getElementById("tgLogin").appendChild(s);
  </script>
</body>
</html>
