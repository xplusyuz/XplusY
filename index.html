<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>LeaderMath — PWA (Premium)</title>
  <meta name="theme-color" content="#2E8B57" id="meta-theme-color"/>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./favicon.ico">
  <style>
    :root{
      --brand:#2E8B57;--brand2:#1F6B45;
      --bg:#f4f8f6;--text:#0d1b14;--muted:#375c4c;--card:#ffffff;
      --frame:#d8e7dd;--frame-strong:#b7d6c5;--chip:#eaf6f0;--chip-b:#cfe7db;
      --radius:16px;
    }
    :root.dark{
      --bg:#0e1512; --text:#EAF7EE; --muted:#A5C7B4; --card:#142018;
      --frame:#244b39; --frame-strong:#2f6b52; --chip:#132a20; --chip-b:#2a5742;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    /* Appbar */
    .appbar{position:sticky;top:0;z-index:90;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:10px 12px;display:flex;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
    .logo{width:40px;height:40px;border-radius:14px;background:#fff2;display:grid;place-items:center;font-weight:800}
    .title{font-weight:800;font-size:18px}
    .spacer{flex:1}
    .iconbtn{background:#ffffff22;border:1px solid #ffffff33;color:#fff;border-radius:12px;padding:8px 10px;font-weight:700;cursor:pointer}

    /* User bar */
    .userbar{background:var(--card);border:1px solid var(--frame);border-radius:14px;margin:10px 12px;padding:12px;display:flex;align-items:center;gap:12px;box-shadow:0 8px 20px #0001}
    .ava{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand2));display:grid;place-items:center;color:#fff;font-weight:900;overflow:hidden}
    .ava img{width:100%;height:100%;object-fit:cover}
    .uinfo b{display:block;font-size:16px}
    .uinfo .meta{color:var(--muted);font-size:12px}
    .uvals{margin-left:auto;text-align:right}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-b);font-size:12px}
    .link{color:inherit;text-decoration:underline dotted}

    /* Banners */
    .banner{margin:10px 12px;border-radius:18px;overflow:hidden;border:1px solid var(--frame);box-shadow:0 8px 22px rgba(0,0,0,.08);background:linear-gradient(135deg,#f0fff6,#e7f6ee)}
    .dark .banner{background:linear-gradient(135deg,#11231b,#0d1914)}

    /* === Premium look: glass + gradient borders === */
    .glass{background:rgba(255,255,255,.6);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)}
    .dark .glass{background:rgba(20,32,24,.55)}
    .grad-border{position:relative}
    .grad-border::before{
      content:""; position:absolute; inset:0; padding:1px; border-radius:14px;
      background:linear-gradient(135deg, #9ce8c0, #2E8B57 40%, #39B6FF);
      -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
      -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none;
    }

    /* Leaderboard (Gruppali) */
    .board{background:var(--card);border:1px solid var(--frame);border-radius:16px;margin:10px 12px;padding:12px; border:none}
    .board h3{margin:0 0 8px;font-size:16px}
    .group{border:none; border-radius:14px; overflow:hidden; margin:10px 0; box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .board .group + .group{margin-top:14px}
    .groupBody{padding:12px}
    .groupHead{
      position:relative; border:none; border-radius:14px;
      padding:14px 16px; color:#063a27; font-weight:900;
    }
    .dark .groupHead{color:#c7ffe7}
    .groupHead.tier-bronze{background:linear-gradient(135deg,#fff1e6,#ffd9c2)}
    .groupHead.tier-silver{background:linear-gradient(135deg,#f4f7fb,#dfe7f4)}
    .groupHead.tier-gold{background:linear-gradient(135deg,#fff4cc,#ffe48a)}
    .groupHead.tier-emerald{background:linear-gradient(135deg,#e3f8ee,#c9f1df)}
    .groupHead.tier-diamond{background:linear-gradient(135deg,#e8f8ff,#d8f1ff)}
    .groupHead::after{
      content:""; position:absolute; right:12px; top:-10px; width:16px; height:24px;
      background:currentColor; opacity:.12; border-radius:4px 4px 0 0; transform:skewX(-12deg);
    }
    .tier-badge{font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--frame); background:rgba(255,255,255,.4)}
    .legend{display:flex; align-items:center; gap:8px; font-size:12px; opacity:.9}

    .rank{display:grid;grid-template-columns:54px 1fr auto;gap:12px;align-items:center;padding:10px;border-radius:12px;border:1px solid var(--frame);margin-bottom:8px;background:var(--card);box-shadow:0 2px 6px rgba(0,0,0,.04);transition:.2s; border:none; position:relative}
    .rank:hover{transform:scale(1.02);box-shadow:0 10px 28px rgba(46,139,87,.28)}
    .rnk{font-weight:900;background:var(--chip);border:1px solid var(--frame);padding:6px 10px;border-radius:10px}
    .medal{font-size:22px;line-height:1}
    .m1,.m2,.m3{display:inline-block;width:40px;text-align:center}
    @keyframes pulse-glow{0%{filter:drop-shadow(0 0 0 rgba(255,200,0,.0))}100%{filter:drop-shadow(0 0 8px rgba(255,200,0,.55))}}
    .m1,.m2,.m3{animation:pulse-glow 1.6s ease-in-out infinite alternate}
    .rank .medal.m1{position:relative}
    .rank .medal.m1::before{
      content:""; position:absolute; inset:-6px;
      background:radial-gradient(closest-side, rgba(255,214,0,.35), transparent 70%);
      border-radius:50%; filter:blur(6px);
    }

    /* Stars (SVG, yarim yulduz mask) */
    .stars{display:inline-flex; gap:3px; vertical-align:middle}
    .tier-bronze .stars{--s:16}
    .tier-silver .stars{--s:17}
    .tier-gold .stars{--s:18}
    .tier-emerald .stars{--s:20}
    .tier-diamond .stars{--s:22}
    .stars svg{width:calc(var(--s)*1px); height:calc(var(--s)*1px)}

    /* Cards grid */
    .container{padding:6px 12px 90px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:560px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card);border:1px solid var(--frame);border-radius:14px;overflow:hidden;box-shadow:0 10px 24px rgba(0,0,0,.06);position:relative; transition:transform .18s ease, box-shadow .18s ease}
    .card:hover{transform:translateY(-3px); box-shadow:0 14px 36px rgba(0,0,0,.12)}
    .thumb{aspect-ratio:16/9;background:linear-gradient(135deg,#e9f5ef,#f6fbf8);display:grid;place-items:center}
    .dark .thumb{background:linear-gradient(135deg,#122019,#0f1714)}
    .badge{
      position:absolute; top:10px; left:10px; border-radius:999px; padding:6px 10px;
      background:linear-gradient(135deg,#2E8B57,#1F6B45); color:#fff; font-weight:800
    }
    .badge::after{
      content:""; position:absolute; inset:-1px; border-radius:999px;
      background:conic-gradient(from 0deg,#7fffd4 0%, transparent 20%, transparent 60%, #7fffd4 80%, #7fffd4 100%);
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite:xor; mask-composite:exclude; animation:shimmer 2.6s linear infinite;
    }
    @keyframes shimmer{to{transform:rotate(360deg)}}
    .body{padding:12px}
    .name{font-size:16px;font-weight:900;margin:0 0 6px}
    .desc{font-size:13px;color:var(--muted);margin:0 0 10px}
    .actions{display:flex;gap:8px}
    .btn{flex:1;display:inline-flex;align-items:center;justify-content:center;gap:8px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;text-decoration:none}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn.ghost{background:#fff;color:#1F6B45;border:1px solid var(--frame)}
    .meta{font-size:12px;color:var(--muted);margin-top:6px;display:flex;gap:10px;align-items:center}
    .countdown{font-weight:800}

    /* Modal */
    .modal-mask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:999}
    .modal{width:min(840px,94%);max-height:90vh;overflow:auto;background:var(--card);border-radius:14px;border:1px solid var(--frame-strong);box-shadow:0 24px 64px rgba(0,0,0,.35);padding:16px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .ctl label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
    .ctl input,.ctl textarea, .ctl select{width:100%;padding:10px;border:1px solid var(--frame);border-radius:10px;font:inherit;background:var(--card);color:var(--text)}
    .row{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
    .danger{color:#c62828;font-size:12px}
  </style>
</head>
<body>
  <!-- Appbar -->
  <header class="appbar">
    <div class="logo">L</div>
    <div><div class="title">LeaderMath</div><div class="sub">BSB / CHSB dars resurslari</div></div>
    <div class="spacer"></div>
    <button id="themeBtn" class="iconbtn" title="Dark/Light">🌙</button>
  </header>

  <!-- User bar -->
  <section class="userbar" id="userbar">
    <div class="ava" id="ava">LM</div>
    <div class="uinfo">
      <b id="uname">Mehmon</b>
      <div class="meta">
        <span id="uid">ID: —</span> ·
        <span id="uregion">Viloyat: —</span> ·
        <span id="udistrict">Tuman: —</span> ·
        <span id="uschool">Maktab: —</span>
      </div>
    </div>
    <div class="uvals">
      <div class="chip"><b id="points">Ball: —</b></div>
      <div style="margin-top:6px;font-size:12px">
        <a href="#" id="signin" class="link">Kirish</a> ·
        <a href="#" id="editProfile" class="link" style="display:none">Profil</a> ·
        <a href="#" id="signout" class="link" style="display:none">Chiqish</a>
      </div>
    </div>
  </section>

  <!-- Banners -->
  <section id="banners"></section>

  <!-- Leaderboard (BANNER va CARDS orasida) -->
  <section class="board grad-border glass" id="board">
    <h3>Top 50 — Ball bo‘yicha (10 talik guruhlar)</h3>
    <div id="boardList"></div>
  </section>

  <!-- Sections (cards) -->
  <div class="container">
    <div id="sections"></div>
  </div>

  <!-- Profile modal -->
  <div id="profileModal" class="modal-mask" aria-modal="true" role="dialog">
    <div class="modal">
      <h3>Profil ma’lumotlari (majburiy)</h3>
      <div class="grid2">
        <div class="ctl"><label>Ism *</label><input id="pFirst"></div>
        <div class="ctl"><label>Familiya *</label><input id="pLast"></div>
      </div>
      <div class="grid3">
        <div class="ctl"><label>Viloyat *</label><input id="pRegion" placeholder="Namangan"></div>
        <div class="ctl"><label>Tuman/Shahar *</label><input id="pDistrict" placeholder="Yangiqo‘rg‘on"></div>
        <div class="ctl"><label>Maktab nomi *</label><input id="pSchool" placeholder="1-maktab"></div>
      </div>
      <div class="grid2">
        <div class="ctl"><label>Sinf *</label><input id="pClass" placeholder="9-A"></div>
        <div class="ctl"><label>Telefon *</label><input id="pPhone" placeholder="+998 XX XXX XX XX"></div>
      </div>
      <div class="row">
        <div class="danger" id="pError"></div>
        <div style="display:flex;gap:8px">
          <button id="pSave" class="iconbtn" style="background:linear-gradient(135deg,var(--brand),var(--brand2));border:none">Saqlash</button>
          <button id="pClose" class="iconbtn">Yopish</button>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  // Theme
  const root=document.documentElement, themeBtn=document.getElementById('themeBtn'), THEME_KEY='lm-theme';
  const setTheme=m=>{root.classList.toggle('dark',m==='dark');localStorage.setItem(THEME_KEY,m);themeBtn.textContent=m==='dark'?'☀️':'🌙'};
  setTheme(localStorage.getItem(THEME_KEY)||(matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
  themeBtn.onclick=()=>setTheme(root.classList.contains('dark')?'light':'dark');
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./service-worker.js'); }

  // Firebase
  import { auth, db, signOut } from './lib/firebase.client.js';
  import { watchAuth } from './lib/auth-guard.js';
  import { doc, getDoc, setDoc, runTransaction, collection, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // Elements
  const el = {
    uname: document.getElementById('uname'), uid: document.getElementById('uid'),
    uregion: document.getElementById('uregion'), udistrict: document.getElementById('udistrict'),
    uschool: document.getElementById('uschool'), points: document.getElementById('points'),
    ava: document.getElementById('ava'), signin: document.getElementById('signin'),
    signout: document.getElementById('signout'), editProfile: document.getElementById('editProfile'),
    banners: document.getElementById('banners'), sections: document.getElementById('sections'),
    boardList: document.getElementById('boardList')
  };

  // Profile modal els
  const PM = {
    mask: document.getElementById('profileModal'),
    first: document.getElementById('pFirst'),
    last: document.getElementById('pLast'),
    region: document.getElementById('pRegion'),
    district: document.getElementById('pDistrict'),
    school: document.getElementById('pSchool'),
    klass: document.getElementById('pClass'),
    phone: document.getElementById('pPhone'),
    err: document.getElementById('pError'),
    save: document.getElementById('pSave'),
    close: document.getElementById('pClose'),
  };
  function openProfileModal(pref={}){
    PM.first.value=pref.first||''; PM.last.value=pref.last||''; PM.region.value=pref.region||''; PM.district.value=pref.district||''; PM.school.value=pref.school||''; PM.klass.value=pref.klass||''; PM.phone.value=pref.phone||''; PM.err.textContent='';
    PM.mask.style.display='flex';
  }
  function closeProfileModal(){ PM.mask.style.display='none'; }
  PM.close.onclick = closeProfileModal;

  function initials(n){ if(!n) return 'LM'; const p=n.trim().split(/\s+/); return (p[0]?.[0]||'L')+(p[1]?.[0]||'M'); }
  function profileIsComplete(u){ return !!(u && u.name && /\s/.test(u.name) && u.region && u.district && u.school && u.class && u.phone); }

  el.signin.onclick=(e)=>{ e.preventDefault(); const ret = encodeURIComponent(location.pathname + location.search + location.hash); location.href = `./login.html?return=${ret}`; };
  el.signout.onclick=async (e)=>{ e.preventDefault(); await signOut(auth); const ret=encodeURIComponent('./index.html'); location.href=`./login.html?return=${ret}`; };
  el.editProfile.onclick=(e)=>{
    e.preventDefault();
    const nm = el.uname.textContent.trim().split(/\s+/,2);
    openProfileModal({ first:nm[0]||'', last:nm[1]||'', region:el.uregion.textContent.replace(/^Viloyat:\s*/,'')||'', district:el.udistrict.textContent.replace(/^Tuman:\s*/,'')||'', school:el.uschool.textContent.replace(/^Maktab:\s*/,'')||'', klass:'', phone:'' });
  };

  async function ensureUser(user){
    const ref=doc(db,'users',user.uid);
    await runTransaction(db, async(tx)=>{
      const snap=await tx.get(ref);
      if(!snap.exists()){
        tx.set(ref,{ name:user.displayName|| (user.email?user.email.split('@')[0]:'Foydalanuvchi'), email:user.email||null, photoURL:user.photoURL||null, role:'user', numericId:Math.floor(1000+Math.random()*9000), points:0, region:null, district:null, school:null, class:null, phone:null, createdAt:Date.now() });
      }
    });
    return (await getDoc(ref)).data();
  }
  async function saveProfile(){
    const user = auth.currentUser; if(!user) return;
    const first = PM.first.value.trim(), last=PM.last.value.trim(), region=PM.region.value.trim(), district=PM.district.value.trim(), school=PM.school.value.trim(), klass=PM.klass.value.trim(), phone=PM.phone.value.trim();
    if(!first||!last||!region||!district||!school||!klass||!phone){ PM.err.textContent='Barcha maydonlar majburiy.'; return; }
    try{
      const ref=doc(db,'users',user.uid);
      await setDoc(ref,{ name:`${first} ${last}`.trim(), region, district, school, class:klass, phone },{ merge:true });
      el.uname.textContent=`${first} ${last}`; el.uregion.textContent='Viloyat: '+region; el.udistrict.textContent='Tuman: '+district; el.uschool.textContent='Maktab: '+school;
      closeProfileModal();
    }catch(e){ PM.err.textContent='Saqlashda xatolik: '+(e?.message||e); }
  }
  PM.save.onclick = saveProfile;

  // Utils
  const toMs=v=> v? (new Date(v)).getTime():null;
  const fmt=(ms)=>{
    if(ms<=0) return '00:00:00';
    const s=Math.floor(ms/1000); const h=String(Math.floor(s/3600)).padStart(2,'0'); const m=String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0');
    return `${h}:${m}:${ss}`;
  };
  const escapeHtml=(s)=>String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

  // Cards (12 talik limit/bo‘limlik)
  function computeState(it, now){
    const t=it.type||'open';
    const start=toMs(it.startAt), end=toMs(it.endAt);
    if(t==='open') return { status:'open' };
    if(t==='coming_soon') return { status:'soon' };
    if(t==='window'){
      if(!start||!end) return { status:'open' };
      if(now<start) return { status:'locked_until', left:start-now };
      if(now>=start && now<=end) return { status:'open' };
      if(now>end) return { status:'closed' };
    }
    return { status:'open' };
  }
  function renderCards(data){
    const wrap=el.sections; wrap.innerHTML='';
    (data.sections||[]).forEach(sec=>{
      const title = document.createElement('h3'); title.textContent = sec.title || 'Bo‘lim';
      title.style.margin = '10px 6px'; title.style.fontSize = '15px'; title.style.opacity = '.8';
      wrap.appendChild(title);

      const grid=document.createElement('div'); grid.className='grid';
      (sec.items||[]).slice(0,12).forEach(it=>{
        const card=document.createElement('article'); card.className='card grad-border glass';
        const best=it.best?'<div class="badge">BEST</div>':'';
        const slug = (it.name||'').replace(/\W+/g,'-');
        card.innerHTML=`
          <div class="thumb"><div style="font-weight:900;opacity:.75">${escapeHtml(it.name||'')}</div>${best}</div>
          <div class="body">
            <h3 class="name">${escapeHtml(it.name||'')}</h3>
            ${it.description?`<p class="desc">${escapeHtml(it.description)}</p>`:''}
            <div class="actions">
              <a class="btn" id="start-${slug}">Boshlash</a>
              <button class="btn ghost" disabled id="info-${slug}">Info</button>
            </div>
            <div class="meta"><span class="countdown" data-id="${slug}"></span></div>
          </div>`;
        // state & timer
        const startBtn = card.querySelector(`#start-${slug}`);
        const cdEl = card.querySelector(`[data-id="${slug}"]`);
        const tick=()=>{
          const st=computeState(it, Date.now());
          if(st.status==='open'){
            startBtn.removeAttribute('disabled');
            startBtn.setAttribute('href', it.link || '#');
            cdEl.textContent='';
          } else if(st.status==='soon'){
            startBtn.setAttribute('disabled','1'); startBtn.removeAttribute('href'); cdEl.textContent='Tez orada';
          } else if(st.status==='locked_until'){
            startBtn.setAttribute('disabled','1'); startBtn.removeAttribute('href'); cdEl.textContent='Qolgan vaqt: '+fmt(st.left);
          } else if(st.status==='closed'){
            startBtn.setAttribute('disabled','1'); startBtn.removeAttribute('href'); cdEl.textContent='Tugadi';
          }
        };
        tick(); setInterval(tick,1000);
        grid.appendChild(card);
      });
      wrap.appendChild(grid);
    });
  }

  // Load banners + cards
  async function initContent(){
    try{
      const r=await fetch('./index.json',{cache:'no-store'});
      const data=await r.json();
      el.banners.innerHTML=(data.banners||[]).map(b=>`<div class="banner grad-border glass">${b.html||''}</div>`).join('');
      renderCards(data);
    }catch(e){ console.error(e); }
  }
  initContent();

  // ==== Leaderboard (10 talik guruhlar, SVG yulduzlar) ====
  const GROUPS = [
    {label:'50–41', start:41, end:50, tier:'bronze',  base:0.5},
    {label:'40–31', start:31, end:40, tier:'silver',  base:1.5},
    {label:'30–21', start:21, end:30, tier:'gold',    base:2.5},
    {label:'20–11', start:11, end:20, tier:'emerald', base:3.5},
    {label:'10–1',  start:1,  end:10, tier:'diamond', base:4.5}
  ];

  function renderStars(count){
    const full = Math.floor(count);
    const half = (count - full >= 0.5) ? 1 : 0;
    const empty = 5 - full - half;
    const starSVG = (fillPct)=>`
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <defs>
        <linearGradient id="gStar" x1="0" x2="1">
          <stop offset="0%" stop-color="#FFD060"/>
          <stop offset="50%" stop-color="#FFC107"/>
          <stop offset="100%" stop-color="#FF8A00"/>
        </linearGradient>
        <clipPath id="clipHalf">
          <rect x="0" y="0" width="${fillPct}%" height="100%"></rect>
        </clipPath>
      </defs>
      <path d="M12 2.3l2.9 5.9 6.5.9-4.7 4.5 1.1 6.4L12 17.8l-5.8 3.1 1.1-6.4L2.6 9.1l6.5-.9L12 2.3z"
        fill="#d0dbd5"></path>
      <path d="M12 2.3l2.9 5.9 6.5.9-4.7 4.5 1.1 6.4L12 17.8l-5.8 3.1 1.1-6.4L2.6 9.1l6.5-.9L12 2.3z"
        fill="url(#gStar)" clip-path="url(#clipHalf)"></path>
    </svg>`;
    const fullStar = starSVG(100), halfStar = starSVG(50), emptyStar = starSVG(0);
    return `<span class="stars">${Array.from({length: full}).map(()=>fullStar).join('')}${half ? halfStar : ''}${Array.from({length: empty}).map(()=>emptyStar).join('')}</span>`;
  }

  function drawBoardGrouped(users){
    const arr = users.slice(0,50); // top-50
    let html = '';
    GROUPS.forEach((g)=>{
      const rows = [];
      for(let r=g.start; r<=g.end; r++){
        const u = arr[r-1]; if(!u) continue;
        const rank=r;
        const isTop3 = rank<=3;
        const leftBadge = isTop3
          ? `<span class="medal ${rank===1?'m1':rank===2?'m2':'m3'}">${rank===1?'🏆':rank===2?'🥈':'🥉'}</span>`
          : `<span class="rnk">#${rank}</span>`;
        const bonus = (r===g.start)?0.5:0;                // har 10 talikda birinchi +½
        const stars = (rank===1)?5 : g.base + bonus;      // 1-o‘rin 5 yulduz

        rows.push(`
          <div class="rank grad-border glass">
            <div>${leftBadge}</div>
            <div>
              <b>${escapeHtml(u.name||'Foydalanuvchi')}</b>
              <div class="desc">${escapeHtml(u.region||'—')} · ${escapeHtml(u.district||'—')} · ${escapeHtml(u.school||'—')}</div>
            </div>
            <div class="right tier-${g.tier}">
              <div><b>${Number(u.points)||0}</b></div>
              ${renderStars(stars)}
            </div>
          </div>
        `);
      }
      if(rows.length){
        html += `
          <div class="group grad-border glass">
            <div class="groupHead tier-${g.tier}">
              <span class="tier-badge">${g.label}</span>
              <span class="legend">${renderStars(g.base + 0.5)}</span>
            </div>
            <div class="groupBody">
              ${rows.join('')}
            </div>
          </div>
        `;
      }
    });
    el.boardList.innerHTML = html || '<div class="desc">Hali ma’lumot yo‘q</div>';
  }

  // Auth + profil + leaderboard
  watchAuth(async (user)=>{
    if(!user){
      el.uname.textContent='Mehmon'; el.uid.textContent='ID: —'; el.uregion.textContent='Viloyat: —'; el.udistrict.textContent='Tuman: —'; el.uschool.textContent='Maktab: —'; el.points.textContent='Ball: —';
      el.ava.textContent='LM'; el.ava.style.backgroundImage=''; el.signin.style.display='inline'; el.signout.style.display='none'; el.editProfile.style.display='none';
      return;
    }
    el.signin.style.display='none'; el.signout.style.display='inline';
    const u = await ensureUser(user);
    el.uname.textContent = u.name || user.displayName || (user.email?.split('@')[0] ?? 'Foydalanuvchi');
    el.uid.textContent = 'ID: '+(u.numericId || '—');
    el.uregion.textContent = 'Viloyat: '+(u.region || '—');
    el.udistrict.textContent = 'Tuman: '+(u.district || '—');
    el.uschool.textContent = 'Maktab: '+(u.school || '—');
    el.points.textContent = 'Ball: '+(Number(u.points)||0);
    if(user.photoURL){ el.ava.innerHTML='<img src="'+user.photoURL+'" alt="ava">'; }
    else { el.ava.textContent = initials(el.uname.textContent); }
    el.editProfile.style.display='inline';

    onSnapshot(query(collection(db,'users'), orderBy('points','desc'), limit(100)), (snap)=>{
      const list = snap.docs.map(d=>d.data()).sort((a,b)=> (Number(b.points)||0) - (Number(a.points)||0) || (a.numericId??0)-(b.numericId??0));
      drawBoardGrouped(list);
    }, (err)=>{
      console.error('board error',err);
      el.boardList.innerHTML='<div class="desc">Leaderboard hozircha yopiq</div>';
    });
  });

</script>
</body>
</html>
