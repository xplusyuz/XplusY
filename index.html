<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XplusY · MathCenter — Premium SPA</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='0' y2='1'%3E%3Cstop stop-color='%2310b981'/%3E%3Cstop stop-color='%23059a6a' offset='1'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='128' height='128' rx='26' fill='url(%23g)'/%3E%3Ctext x='64' y='86' text-anchor='middle' font-size='92' font-family='Georgia, serif' fill='white'%3E%CF%80%3C/text%3E%3C/svg%3E">
  <style>
    :root{
      --pri:#10b981; --pri2:#059669; --ink:#0b1f17; --muted:#5b6e6a; --edge:#dff5ec; --bg:#f6fffb;
      --card:#fff; --ring:rgba(16,185,129,.35); --shadow:0 12px 30px rgba(16,185,129,.18);
      --radius:18px; --gap:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
    a{color:inherit;text-decoration:none}

    /* Sticky header */
    header{position:sticky;top:0;z-index:30;background:rgba(255,255,255,.9);backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid var(--edge)}
    .container{max-width:1180px;margin:0 auto;padding:0 16px}
    .h-inner{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px;padding:10px 0}
    .logo{display:flex;align-items:center;gap:10px}
    .pi{width:44px;height:44px;display:grid;place-items:center;border-radius:12px;background:radial-gradient(90% 150% at 0% 0%,#fff, #ecfbf4 40%, #def6ed 80%);box-shadow:inset 0 1px 0 #fff, 0 6px 16px rgba(16,185,129,.25)}
    .pi span{font-size:30px;color:var(--pri);text-shadow:0 0 12px rgba(16,185,129,.35)}
    .brand{font-weight:800;letter-spacing:.4px}
    .brand small{display:block;font-weight:600;color:var(--muted);margin-top:-2px}

    /* Quick nav (touch floating) */
    .quick{overflow:auto hidden;display:flex;gap:10px;padding:6px 0}
    .chip{flex:0 0 auto;border:1px solid var(--edge);padding:10px 14px;border-radius:999px;background:linear-gradient(#fff, #f7fdfa);box-shadow:0 4px 12px rgba(16,185,129,.06)}
    .chip.active{border-color:var(--pri);box-shadow:0 0 0 3px var(--ring)}

    /* User mini card */
    .user-badge{display:flex;align-items:center;gap:10px;border:1px solid var(--edge);padding:8px 12px;border-radius:999px;background:#fff}
    .coin{width:24px;height:24px;border-radius:50%;display:grid;place-items:center;background:linear-gradient(#fff,#f3fff9);border:1px solid var(--edge);box-shadow:inset 0 0 0 2px #fff, 0 6px 14px rgba(16,185,129,.15)}
    .user-balance{font-weight:700;color:var(--pri)}

    main{padding:16px 0 96px}

    /* Banner 16:9 */
    .banner-wrap{display:grid;gap:16px}
    .banner{position:relative;border-radius:var(--radius);overflow:hidden;border:1px solid var(--edge);box-shadow:var(--shadow);aspect-ratio:16/9;background:#eef9f3}
    .banner img{width:100%;height:100%;object-fit:cover}
    .banner a{position:absolute;inset:0}

    /* Cards grid */
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 14px}
    .toolbar .search{flex:1;min-width:220px}
    input,select,button,textarea{font:inherit}
    .field{display:flex;align-items:center;gap:10px;border:1px solid var(--edge);background:#fff;border-radius:12px;padding:10px 12px}
    .field input{border:0;outline:none;width:100%;background:transparent}
    .sel{padding:10px 12px;border:1px solid var(--edge);background:#fff;border-radius:12px}
    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:16px}
    @media(min-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(min-width:1200px){.grid{grid-template-columns:repeat(4,1fr)}}

    .card{position:relative;border-radius:18px;border:1px solid var(--edge);background:linear-gradient(180deg,#ffffff, #f8fffb);overflow:hidden;box-shadow:var(--shadow);transition:transform .18s ease, box-shadow .18s ease}
    .card:hover{transform:translateY(-4px);box-shadow:0 18px 40px rgba(16,185,129,.22)}
    .thumb{aspect-ratio:16/10;background:#eef7f3}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .card-body{padding:12px 14px}
    .title{font-weight:800}
    .muted{color:var(--muted)}
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tag{font-size:12px;border:1px solid var(--edge);padding:4px 8px;border-radius:999px;background:#fff}
    .badge{position:absolute;top:10px;left:10px;background:#fff;border:1px solid var(--edge);padding:6px 10px;border-radius:999px;font-weight:700}
    .badge.free{color:#0ea5e9}
    .badge.pro{color:var(--pri)}

    .cta{display:flex;gap:10px;margin-top:12px}
    .btn{border:0;border-radius:12px;padding:10px 14px;background:var(--pri);color:#fff;font-weight:700;box-shadow:0 8px 18px rgba(16,185,129,.25);cursor:pointer}
    .btn.ghost{background:#fff;color:var(--pri);border:1px solid var(--pri)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    /* Pagination */
    .pager{display:flex;gap:8px;justify-content:center;margin:18px 0}
    .pager button{border:1px solid var(--edge);background:#fff;border-radius:10px;padding:8px 12px}

    /* Footer floating nav */
    .dock{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);display:flex;gap:10px;padding:10px;border-radius:999px;background:#fff;border:1px solid var(--edge);box-shadow:0 12px 34px rgba(0,0,0,.08);z-index:40}
    .dock a{padding:10px 14px;border-radius:999px}
    .dock a.active{outline:3px solid var(--ring)}

    /* Sections */
    section{display:none}
    section.active{display:block}

    /* Admin panel */
    .admin-bar{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0}
    .card-admin{border:1px dashed var(--pri2);background:linear-gradient(#fff, #f6fffb);padding:14px;border-radius:16px}
    .admin-note{font-size:13px;color:var(--muted)}
    .form{display:grid;gap:10px}
    .form .row{display:grid;gap:10px}
    @media(min-width:700px){ .form .row{ grid-template-columns:1fr 1fr } }

    dialog{border:0;border-radius:18px;box-shadow:0 30px 60px rgba(16,185,129,.35);width:min(720px,92vw)}
    dialog::backdrop{background:rgba(0,0,0,.25)}

  </style>
</head>
<body>
<header>
  <div class="container h-inner">
    <div class="logo">
      <div class="pi"><span>π</span></div>
      <div class="brand">MathCenter <small>XplusY</small></div>
    </div>
    <nav class="quick" id="quickNav">
      <a class="chip" data-go="#/home">Bosh sahifa</a>
      <a class="chip" data-go="#/courses">Kurslar</a>
      <a class="chip" data-go="#/tests">Testlar</a>
      <a class="chip" data-go="#/simulators">Simulyatorlar</a>
      <a class="chip" data-go="#/profile">Profil</a>
      <a class="chip" data-go="#/admin">Admin</a>
    </nav>
    <div class="user-badge" id="userBadge">
      <div class="coin">💎</div>
      <div>
        <div id="hello">Salom!</div>
        <div class="muted" style="font-size:12px">Balans: <span class="user-balance" id="balance">0</span> so'm · Ball: <span id="points">0</span></div>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <!-- HOME: faqat 16:9 bannerlar -->
  <section id="page-home" class="active">
    <h2>Reklama bannerlari</h2>
    <div class="banner-wrap" id="homeBanners"></div>
  </section>

  <!-- COURSES -->
  <section id="page-courses">
    <h2>Kurslar</h2>
    <div class="toolbar">
      <label class="field search"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-3.9-3.9" stroke="#86b3a6" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="#86b3a6" stroke-width="2"/></svg>
        <input id="q-courses" placeholder="Qidiruv... nom, izoh..."/>
      </label>
      <select class="sel" id="region-courses"><option value="">Region</option></select>
      <select class="sel" id="district-courses"><option value="">Tuman</option></select>
      <select class="sel" id="f1-courses"><option value="">Filter-1
      </option></select>
      <select class="sel" id="f2-courses"><option value="">Filter-2</option></select>
      <select class="sel" id="f3-courses"><option value="">Filter-3</option></select>
    </div>
    <div class="grid" id="grid-courses"></div>
    <div class="pager" id="pager-courses"></div>
  </section>

  <!-- TESTS: online & oddiy -->
  <section id="page-tests">
    <h2>Testlar</h2>
    <div class="toolbar">
      <label class="field search"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-3.9-3.9" stroke="#86b3a6" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="#86b3a6" stroke-width="2"/></svg>
        <input id="q-tests" placeholder="Qidiruv..."/>
      </label>
      <select class="sel" id="region-tests"><option value="">Region</option></select>
      <select class="sel" id="district-tests"><option value="">Tuman</option></select>
      <select class="sel" id="f1-tests"><option value="">Filter-1</option></select>
      <select class="sel" id="f2-tests"><option value="">Filter-2</option></select>
      <select class="sel" id="f3-tests"><option value="">Filter-3</option></select>
    </div>
    <div class="grid" id="grid-tests"></div>
    <div class="pager" id="pager-tests"></div>
  </section>

  <!-- SIMULATORS -->
  <section id="page-simulators">
    <h2>Simulyatorlar</h2>
    <div class="toolbar">
      <label class="field search"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-3.9-3.9" stroke="#86b3a6" stroke-width="2" stroke-linecap="round"/><circle cx="11" cy="11" r="7" stroke="#86b3a6" stroke-width="2"/></svg>
        <input id="q-sim" placeholder="Qidiruv..."/>
      </label>
      <select class="sel" id="region-sim"><option value="">Region</option></select>
      <select class="sel" id="district-sim"><option value="">Tuman</option></select>
      <select class="sel" id="f1-sim"><option value="">Filter-1</option></select>
      <select class="sel" id="f2-sim"><option value="">Filter-2</option></select>
      <select class="sel" id="f3-sim"><option value="">Filter-3</option></select>
    </div>
    <div class="grid" id="grid-sim"></div>
    <div class="pager" id="pager-sim"></div>
  </section>

  <!-- PROFILE -->
  <section id="page-profile">
    <h2>Profil</h2>
    <div class="card" style="padding:16px">
      <div class="title" id="p-name">Ism: -</div>
      <div id="p-id">ID: -</div>
      <div id="p-age">Yosh: -</div>
      <div>Balans: <span id="p-balance">0</span> so'm · Ball: <span id="p-points">0</span></div>
      <div class="cta"><button class="btn" id="btn-edit-profile">Tahrirlash</button><button class="btn ghost" id="btn-logout" style="display:none">Chiqish</button></div>
    </div>

    <div class="card" style="padding:16px;margin-top:14px">
      <h3>Balansni to'ldirish</h3>
      <div class="cta">
        <a class="btn" href="https://indoor.click.uz/pay?id=0081656&t=0" target="_blank">Click</a>
        <a class="btn ghost" href="https://pay.xazna.uz/p2p/f5edea87-06a5-4d48-a01d-885cf843eb8f" target="_blank">Xazna</a>
      </div>
      <div class="muted" style="margin-top:8px">* To'lovdan so'ng promo-kod yoki chek orqali tasdiqlash mumkin.</div>
    </div>

    <div class="card" style="padding:16px;margin-top:14px">
      <h3>Promo-kod qo'llash</h3>
      <div class="toolbar">
        <input class="field" id="promoInput" placeholder="Promo kod" style="min-width:220px"/>
        <button class="btn" id="btn-apply-promo">Qo'llash</button>
      </div>
      <div class="muted" id="promo-msg"></div>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="page-admin">
    <h2>Admin panel</h2>
    <div class="admin-bar">
      <button class="btn" id="btn-google">Google bilan kirish</button>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input class="field" id="email" placeholder="Email" style="min-width:220px"/>
        <input class="field" id="password" type="password" placeholder="Parol" style="min-width:160px"/>
        <button class="btn" id="btn-email-login">Email bilan kirish</button>
        <button class="btn ghost" id="btn-email-register">Ro'yxatdan o'tkazish</button>
      </div>
      <button class="btn ghost" id="btn-admin-logout" style="display:none">Chiqish</button>
      <span class="admin-note">Admin huquqi: ruxsatli email <b>yoki</b> profil_numericID (local) orqali.</span>
    </div>

    <div class="card-admin">
      <h3>Home banner qo'shish (16:9)</h3>
      <form class="form" id="form-banner">
        <div class="row">
          <input class="field" name="title" placeholder="Sarlavha"/>
          <input class="field" name="link" placeholder="Banner havolasi (https:// yoki /courses/...)"/>
        </div>
        <div class="row">
          <input class="field" name="img" placeholder="Rasm URL (masalan img/rasm.jpg)"/>
          <input class="field" name="order" type="number" placeholder="Tartib (ixtiyoriy)"/>
        </div>
        <button class="btn">Saqlash</button>
      </form>
    </div>

    <div class="card-admin" style="margin-top:14px">
      <h3>Kurs/Test/Sim qo'shish</h3>
      <form class="form" id="form-item">
        <div class="row">
          <select class="sel" name="kind">
            <option value="courses">Kurs</option>
            <option value="tests">Test</option>
            <option value="simulators">Simulyator</option>
          </select>
          <input class="field" name="title" placeholder="Sarlavha"/>
        </div>
        <div class="row">
          <input class="field" name="info" placeholder="Izoh"/>
          <input class="field" name="img" placeholder="Rasm URL (img/rasm.jpg)"/>
        </div>
        <div class="row">
          <input class="field" name="price" type="number" placeholder="Narx (0 = FREE)"/>
          <input class="field" name="link" placeholder="Link (boshlash/ko'rish)"/>
        </div>
        <div class="row">
          <select class="sel" name="region" id="admin-region"><option value="">Region</option></select>
          <select class="sel" name="district" id="admin-district"><option value="">Tuman</option></select>
        </div>
        <div class="row">
          <input class="field" name="f1" placeholder="Filter-1 (mas: Yo'nalish)"/>
          <input class="field" name="f2" placeholder="Filter-2 (mas: Sinf)"/>
        </div>
        <div class="row">
          <input class="field" name="f3" placeholder="Filter-3 (mas: Chorak)"/>
          <select class="sel" name="tier">
            <option value="">Yorliq (yo'q)</option>
            <option value="free">free</option>
            <option value="pro">pro</option>
            <option value="new">new</option>
          </select>
        </div>
        <div class="row">
          <select class="sel" name="mode">
            <option value="oddiy">Oddiy</option>
            <option value="online">Online (test)	</option>
          </select>
          <input class="field" name="start" type="datetime-local" placeholder="Boshlanish (faqat online test)"/>
        </div>
        <div class="row">
          <input class="field" name="end" type="datetime-local" placeholder="Tugash (faqat online test)"/>
        </div>
        <button class="btn">Saqlash</button>
      </form>
    </div>

    <div class="card-admin" style="margin-top:14px">
      <h3>Promo-kod boshqaruvi</h3>
      <form class="form" id="form-promo">
        <div class="row">
          <input class="field" name="code" placeholder="Kodni kiriting (mas: X100K)"/>
          <input class="field" name="amount" type="number" placeholder="Miqdor (so'm yoki %)"/>
        </div>
        <div class="row">
          <select class="sel" name="kind">
            <option value="flat">So'm (flat)</option>
            <option value="percent">Foiz (%)</option>
          </select>
          <input class="field" name="expires" type="datetime-local" placeholder="Tugash vaqti"/>
        </div>
        <div class="row">
          <input class="field" name="usageLimit" type="number" placeholder="Umumiy limit (mas: 100)"/>
          <select class="sel" name="perUser">
            <option value="true">Har foydalanuvchiga 1 marta</option>
            <option value="false">Cheklanmagan (foydalanuvchi bo'yicha)</option>
          </select>
        </div>
        <div class="row">
          <input class="field" name="minBalance" type="number" placeholder="Minimal balans sharti (ixtiyoriy)"/>
          <input class="field" name="maxBenefit" type="number" placeholder="Maks. foyda (so'm, ixtiyoriy)"/>
        </div>
        <button class="btn">Promo saqlash</button>
      </form>
      <div id="promo-list" class="muted" style="margin-top:8px"></div>
    </div>

    <div class="card-admin" style="margin-top:14px">
      <h3>Balans boshqaruvi</h3>
      <form class="form" id="form-balance">
        <div class="row">
          <input class="field" name="numericId" type="number" placeholder="Foydalanuvchi numeric ID (mas: 1001)"/>
          <input class="field" name="delta" type="number" placeholder="Balansga qo'shish/ayirish (so'm)"/>
        </div>
        <button class="btn">Yangilash</button>
      </form>
      <div class="admin-note">* Tavsiya: <code>users_by_numeric/{numericId} → users/{uid}</code> mappingdan foydalanish.</div>
    </div>
  </section>
</main>

<!-- Floating dock nav -->
<nav class="dock" id="dock">
  <a data-go="#/home">🏠 Home</a>
  <a data-go="#/courses">📚 Kurslar</a>
  <a data-go="#/tests">📝 Testlar</a>
  <a data-go="#/simulators">🧪 Sim</a>
  <a data-go="#/profile">👤 Profil</a>
  <a data-go="#/admin">🛠️ Admin</a>
</nav>

<!-- Profile edit dialog -->
<dialog id="dlgProfile">
  <form method="dialog" class="form" id="form-profile">
    <h3>Profil ma'lumotlari</h3>
    <div class="row">
      <input class="field" name="name" placeholder="Ism"/>
      <input class="field" name="birth" type="date" placeholder="Tug'ilgan sana"/>
    </div>
    <div class="row">
      <input class="field" name="balance" type="number" placeholder="Balans (so'm)"/>
      <input class="field" name="points" type="number" placeholder="Ball"/>
    </div>
    <menu style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn ghost" value="cancel">Bekor qilish</button>
      <button class="btn" value="ok">Saqlash</button>
    </menu>
  </form>
</dialog>

<script type="module">
// ===== Firebase init (v10 modular) =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, setDoc, doc, onSnapshot, query, orderBy, serverTimestamp, getDocs, where, getDoc, updateDoc, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  authDomain: "xplusy-760fa.firebaseapp.com",
  projectId: "xplusy-760fa",
  storageBucket: "xplusy-760fa.firebasestorage.app",
  messagingSenderId: "992512966017",
  appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
  measurementId: "G-459PLJ7P7L"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ===== Simple SPA router =====
const pages = {
  home: document.querySelector('#page-home'),
  courses: document.querySelector('#page-courses'),
  tests: document.querySelector('#page-tests'),
  simulators: document.querySelector('#page-simulators'),
  profile: document.querySelector('#page-profile'),
  admin: document.querySelector('#page-admin'),
};
function setActive(hash){
  const key = (hash||'#/home').replace('#/','');
  Object.values(pages).forEach(s=>s.classList.remove('active'));
  (pages[key]||pages.home).classList.add('active');
  document.querySelectorAll('[data-go]').forEach(a=>{
    const match = a.getAttribute('data-go')===`#/${key}`;
    a.classList.toggle('active', match);
  });
}
window.addEventListener('hashchange', ()=>setActive(location.hash));
setActive(location.hash||'#/home');

document.querySelectorAll('[data-go]').forEach(a=>a.addEventListener('click',e=>{
  e.preventDefault();
  location.hash = a.getAttribute('data-go');
}));

// ===== User state (profile) =====
const LS_USER = 'xplusy_user';
let stateUser = JSON.parse(localStorage.getItem(LS_USER)||'{}');

function calcAge(birth){
  if(!birth) return '-';
  const b=new Date(birth),now=new Date();
  let age=now.getFullYear()-b.getFullYear();
  const m=now.getMonth()-b.getMonth();
  if(m<0||(m===0&&now.getDate()<b.getDate())) age--; 
  return age;
}
function renderProfile(){
  const name = stateUser.name||'-';
  const id = stateUser.numericId||'-';
  const age = calcAge(stateUser.birth);
  const bal = stateUser.balance||0;
  const pts = stateUser.points||0;
  document.getElementById('hello').textContent = `Salom! ${name}`;
  document.getElementById('balance').textContent = bal;
  document.getElementById('points').textContent = pts;
  document.getElementById('p-name').textContent = `Ism: ${name}`;
  document.getElementById('p-id').textContent = `ID: ${id}`;
  document.getElementById('p-age').textContent = `Yosh: ${age}`;
  document.getElementById('p-balance').textContent = bal;
  document.getElementById('p-points').textContent = pts;
}
renderProfile();
// Auth → users bilan sync
onAuthStateChanged(auth, async (user)=>{
  try{
    if(user){
      const uref = doc(db, 'users', user.uid);
      const usnap = await getDoc(uref);
      if(usnap.exists()){
        const u = usnap.data();
        stateUser = {...stateUser, ...u};
        localStorage.setItem(LS_USER, JSON.stringify(stateUser));
        renderProfile();
      }
    }
  }catch(err){ console.warn('User sync err', err); }
});

// Edit profile dialog
const dlgProfile = document.getElementById('dlgProfile');
const formProfile = document.getElementById('form-profile');
document.getElementById('btn-edit-profile').onclick = ()=>{
  formProfile.name.value = stateUser.name||'';
  formProfile.birth.value = stateUser.birth||'';
  formProfile.balance.value = stateUser.balance||0;
  formProfile.points.value = stateUser.points||0;
  dlgProfile.showModal();
};
formProfile.addEventListener('close', async ()=>{
  if(dlgProfile.returnValue==='ok'){
    stateUser.name=formProfile.name.value.trim();
    stateUser.birth=formProfile.birth.value;
    stateUser.balance=Number(formProfile.balance.value||0);
    stateUser.points=Number(formProfile.points.value||0);
    if(!stateUser.numericId){ stateUser.numericId = 1001; }
    localStorage.setItem(LS_USER, JSON.stringify(stateUser));
    renderProfile();
    // Firestore sync + mapping
    try{
      if(auth.currentUser){
        await setDoc(doc(db,'users',auth.currentUser.uid), stateUser, {merge:true});
        await setDoc(doc(db,'users_by_numeric', String(stateUser.numericId)), {uid: auth.currentUser.uid, numericId: stateUser.numericId}, {merge:true});
      }
    }catch(err){ console.warn('profile sync error', err); }
  }
});
    stateUser.birth=formProfile.birth.value;
    stateUser.balance=Number(formProfile.balance.value||0);
    stateUser.points=Number(formProfile.points.value||0);
    if(!stateUser.numericId){ stateUser.numericId = 1001; } // demo
    localStorage.setItem(LS_USER, JSON.stringify(stateUser));
    renderProfile();
  }
});

// ===== Region → Tuman (dinamik) =====
const REGIONS = {
  "Qoraqalpog'iston": ["Amudaryo","Beruniy","Chimboy","Ellikqal'a","Kegeyli","Mo'ynoq","Nukus shahri","Nukus tumani","Qanliko'l","Qo'ng'irot","Qorao'zak","Shumanay","Taxtako'pir","To'rtko'l","Xo'jayli"],
  "Andijon": ["Andijon shahri","Andijon tuman","Asaka","Baliqchi","Bo'z","Buloqboshi","Izboskan","Jalaquduq","Marhamat","Oltinko'l","Paxtaobod","Qo'rg'ontepa","Shahrixon","Ulug'nor","Xo'jaobod"],
  "Buxoro": ["Buxoro shahri","Buxoro tuman","G'ijduvon","Jondor","Kogon shahri","Kogon tuman","Olot","Peshku","Qorako'l","Qorovulbozor","Romitan","Shofirkon","Vobkent"],
  "Farg'ona": ["Farg'ona shahri","Beshariq","Bog'dod","Buvayda","Dang'ara","Farg'ona tuman","Furqat","Qo'qon shahri","Oltiariq","Quva","Quvasoy shahri","Rishton","So'x","Toshloq","Uchko'prik","Yozyovon"],
  "Jizzax": ["Jizzax shahri","Arnasoy","Baxmal","Do'stlik","Forish","G'allaorol","Mirzacho'l","Paxtakor","Yangiobod","Zafarobod","Zarbdor","Zomin"],
  "Xorazm": ["Urganch shahri","Bog'ot","Gurlan","Hazorasp","Honqa","Qo'shko'pir","Shovot","Urganch tuman","Xiva shahri","Xiva tuman","Yangiariq","Yangibozor"],
  "Namangan": ["Namangan shahri","Chortoq","Chust","Kosonsoy","Mingbuloq","Namangan tuman","Norin","Pop","To'raqo'rg'on","Uchqo'rg'on","Uychi","Yangiqo'rg'on"],
  "Navoiy": ["Navoiy shahri","Karmana","Konimex","Qiziltepa","Navbahor","Nurota","Tomdi","Uchquduq","Xatirchi","Zarafshon shahri"],
  "Qashqadaryo": ["Qarshi shahri","Chiroqchi","Dehqonobod","G'uzor","Kasbi","Kitob","Koson","Mirishkor","Muborak","Nishon","Qamashi","Qarshi tuman","Shahrisabz shahri","Shahrisabz tuman","Yakkabog'"],
  "Samarqand": ["Samarqand shahri","Bulung'ur","Ishtixon","Jomboy","Kattako'rg'on shahri","Kattako'rg'on tuman","Narpay","Nurobod","Oqdaryo","Paxtachi","Payariq","Past Darg'om","Samarqand tuman","Toyloq","Urgut"],
  "Sirdaryo": ["Guliston shahri","Boyovut","Guliston tuman","Mirzaobod","Oqoltin","Sayxunobod","Sardoba","Sirdaryo tuman","Xovos"],
  "Surxondaryo": ["Termiz shahri","Angor","Bandixon","Boysun","Denov","Jarqo'rg'on","Qiziriq","Qumqo'rg'on","Muzrabot","Oltinsoy","Sariosiyo","Sherobod","Shurchi","Termiz tuman"],
  "Toshkent viloyati": ["Bekobod tuman","Bekobod shahri","Bo'ka","Bostonliq","Chinoz","Ohangaron tuman","Ohangaron shahri","Oqqo'rg'on","Parkent","Piskent","Qibray","Quyichirchiq","Yangiyo'l tuman","Yangiyo'l shahri","Yuqorichirchiq","Zangiota"],
  "Toshkent shahri": ["Bektemir","Chilonzor","Mirobod","Mirzo Ulug'bek","Olmazor","Sergeli","Shayxontohur","Uchtepa","Yakkasaroy","Yashnobod","Yunusobod"]
};
function fillRegions(sel){ sel.innerHTML = '<option value="">Region</option>' + Object.keys(REGIONS).map(r=>`<option>${r}</option>`).join(''); }
function fillDistricts(region, sel){ const list = REGIONS[region]||[]; sel.innerHTML = '<option value="">Tuman</option>' + list.map(d=>`<option>${d}</option>`).join(''); }
['admin-region'].forEach(id=>{ const s=document.getElementById(id); if(s) fillRegions(s); });
const adminRegion=document.getElementById('admin-region'), adminDistrict=document.getElementById('admin-district');
if(adminRegion&&adminDistrict){ adminRegion.oninput=()=>fillDistricts(adminRegion.value, adminDistrict); }
['region-courses','region-tests','region-sim'].forEach(id=>{ const s=document.getElementById(id); if(s) fillRegions(s); });
['region-courses','region-tests','region-sim'].forEach((rid,i)=>{ const ds=['district-courses','district-tests','district-sim'][i]; const r=document.getElementById(rid), d=document.getElementById(ds); if(r&&d){ r.oninput=()=>fillDistricts(r.value,d); }});

// ===== Collections listeners =====
const colRefs = {
  banners: collection(db, 'home_banners'),
  courses: collection(db, 'courses'),
  tests: collection(db, 'tests'),
  simulators: collection(db, 'simulators'),
  promocodes: collection(db, 'promocodes'),
  users: collection(db, 'users')
};

// Home banners
const homeBanners = document.getElementById('homeBanners');
onSnapshot(query(colRefs.banners, orderBy('order','asc')), snap=>{
  homeBanners.innerHTML='';
  snap.forEach(docu=>{
    const b = docu.data();
    const el = document.createElement('div');
    el.className = 'banner';
    el.innerHTML = `<img src="${b.img||''}" alt="${b.title||''}">`;
    if(b.link){
      const a = document.createElement('a'); a.href=b.link; a.target = b.link.startsWith('http')?'_blank':'_self'; el.appendChild(a);
    }
    homeBanners.appendChild(el);
  });
});

// Utilities for grids
function uniq(arr){return [...new Set(arr.filter(Boolean))]}
function buildFilters(items, ids){
  const [f1,f2,f3] = ids.map(id=>document.getElementById(id));
  const v1 = uniq(items.map(x=>x.f1)); const v2 = uniq(items.map(x=>x.f2)); const v3 = uniq(items.map(x=>x.f3));
  [v1,v2,v3].forEach((vals, i)=>{
    const s=[f1,f2,f3][i];
    const cur=s.value; s.innerHTML = `<option value="">Filter-${i+1}</option>` + vals.map(v=>`<option>${v}</option>`).join('');
    if([...s.options].some(o=>o.value===cur)) s.value=cur;
  });
}
function paginate(items, page=1, per=12){
  const pages=Math.max(1, Math.ceil(items.length/per));
  const start=(page-1)*per; return { slice: items.slice(start,start+per), pages };
}
function renderPager(host, pages, cur, onGo){
  host.innerHTML='';
  const mk=(t, p)=>{ const b=document.createElement('button'); b.textContent=t; b.onclick=()=>onGo(p); return b };
  host.appendChild(mk('⟨ Oldingi', Math.max(1,cur-1)));
  host.appendChild(document.createTextNode(`  ${cur} / ${pages}  `));
  host.appendChild(mk('Keyingi ⟩', Math.min(pages,cur+1)));
}

// COURSES grid
let CACHE_COURSES=[]; let pageCourses=1;
const gridCourses=document.getElementById('grid-courses');
const pagerCourses=document.getElementById('pager-courses');
function filterCourses(){
  const q=(document.getElementById('q-courses').value||'').toLowerCase();
  const reg=document.getElementById('region-courses').value; const dis=document.getElementById('district-courses').value;
  const f1=document.getElementById('f1-courses').value; const f2=document.getElementById('f2-courses').value; const f3=document.getElementById('f3-courses').value;
  const list=CACHE_COURSES.filter(x=>
    (!reg||x.region===reg)&&(!dis||x.district===dis)&&(!f1||x.f1===f1)&&(!f2||x.f2===f2)&&(!f3||x.f3===f3)&&
    (!q||(`${x.title} ${x.info}`.toLowerCase().includes(q)))
  );
  const {slice,pages}=paginate(list, pageCourses, 12);
  gridCourses.innerHTML = slice.map(cardHtml).join('');
  renderPager(pagerCourses, pages, pageCourses, p=>{pageCourses=p; filterCourses()});
} ${x.info}`.toLowerCase().includes(q)))
  );
  const {slice,pages}=paginate(list, pageCourses, 12);
  gridCourses.innerHTML = slice.map(cardHtml).join('');
  renderPager(pagerCourses, pages, pageCourses, p=>{pageCourses=p; filterCourses()});
}
function cardHtml(x){
  const tierTag = x.tier?`<span class='tag'>${x.tier.toUpperCase()}</span>`:'';
  const priceBadge = x.price===0?`<div class='badge free'>FREE</div>`:`<div class='badge pro'>PRO · ${x.price?.toLocaleString?.('uz-UZ')} so'm</div>`;
  return `<div class='card'>${priceBadge}
    <div class='thumb'>${x.img?`<img src='${x.img}' alt=''>`:''}</div>
    <div class='card-body'>
      <div class='title'>${x.title||''}</div>
      <div class='muted'>${x.info||''}</div>
      <div class='tags'>${[x.region,x.district,x.f1,x.f2,x.f3].filter(Boolean).map(v=>`<span class='tag'>${v}</span>`).join('')}${tierTag}</div>
      <div class='cta'>${x.link?`<a class='btn' href='${x.link}' target='_blank'>Boshlash</a>`:''}
        <button class='btn ghost' ${x.link?'':'disabled'} onclick='navigator.clipboard.writeText("${x.link||''}")'>Nusxa</button>
      </div>
    </div></div>`
}
['q-courses','f1-courses','f2-courses','f3-courses'].forEach(id=>document.getElementById(id).addEventListener('input',()=>{pageCourses=1; filterCourses()}));

onSnapshot(query(colRefs.courses, orderBy('createdAt','desc')), snap=>{
  CACHE_COURSES = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  buildFilters(CACHE_COURSES, ['f1-courses','f2-courses','f3-courses']);
  pageCourses=1; filterCourses();
});

// SIMULATORS grid
let CACHE_SIM=[]; let pageSim=1;
const gridSim=document.getElementById('grid-sim');
const pagerSim=document.getElementById('pager-sim');
function filterSim(){
  const q=(document.getElementById('q-sim').value||'').toLowerCase();
  const reg=document.getElementById('region-sim').value; const dis=document.getElementById('district-sim').value;
  const f1=document.getElementById('f1-sim').value; const f2=document.getElementById('f2-sim').value; const f3=document.getElementById('f3-sim').value;
  const list=CACHE_SIM.filter(x=>(!reg||x.region===reg)&&(!dis||x.district===dis)&&(!f1||x.f1===f1)&&(!f2||x.f2===f2)&&(!f3||x.f3===f3)&&(!q||(`${x.title} ${x.info}`.toLowerCase().includes(q))));
  const {slice,pages}=paginate(list, pageSim, 12);
  gridSim.innerHTML = slice.map(cardHtml).join('');
  renderPager(pagerSim, pages, pageSim, p=>{pageSim=p; filterSim()});
} ${x.info}`.toLowerCase().includes(q))));
  const {slice,pages}=paginate(list, pageSim, 12);
  gridSim.innerHTML = slice.map(cardHtml).join('');
  renderPager(pagerSim, pages, pageSim, p=>{pageSim=p; filterSim()});
}
['q-sim','f1-sim','f2-sim','f3-sim'].forEach(id=>document.getElementById(id).addEventListener('input',()=>{pageSim=1; filterSim()}));

onSnapshot(query(colRefs.simulators, orderBy('createdAt','desc')), snap=>{
  CACHE_SIM = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  buildFilters(CACHE_SIM, ['f1-sim','f2-sim','f3-sim']);
  pageSim=1; filterSim();
});

// TESTS grid (online & oddiy)
let CACHE_TESTS=[]; let pageTests=1;
const gridTests=document.getElementById('grid-tests');
const pagerTests=document.getElementById('pager-tests');
function onlineState(x){
  const now=Date.now();
  const start = x.start ? new Date(x.start).getTime():null;
  const end   = x.end   ? new Date(x.end).getTime():null;
  const isOnline = x.mode==='online';
  function fmt(sec){
    const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60;
    const pad=n=>String(n).padStart(2,'0');
    return `${pad(h)}:${pad(m)}:${pad(s)}`;
  }
  if(!isOnline) return {label:'Oddiy', open:true, countdown:''};
  if(start && now<start){
    const sec=Math.max(0, Math.floor((start-now)/1000));
    return {label:'Online (kutish)', open:false, countdown:fmt(sec)};
  }
  if(end && now>end){ return {label:'Yopiq', open:false, countdown:''}; }
  return {label:'Online', open:true, countdown:''};
};
  if(start && now<start){
    const sec=Math.max(0, Math.floor((start-now)/1000));
    return {label:'Online (kutish)', open:false, countdown:`${sec}s`};
  }
  if(end && now>end){ return {label:'Yopiq', open:false, countdown:''}; }
  return {label:'Online', open:true, countdown:''};
}
function testCardHtml(x){
  const st=onlineState(x);
  const tierTag = x.tier?`<span class='tag'>${x.tier.toUpperCase()}</span>`:'';
  const priceBadge = x.price===0?`<div class='badge free'>FREE</div>`:`<div class='badge pro'>PRO · ${x.price?.toLocaleString?.('uz-UZ')} so'm</div>`;
  return `<div class='card'>${priceBadge}
    <div class='thumb'>${x.img?`<img src='${x.img}' alt=''>`:''}</div>
    <div class='card-body'>
      <div class='title'>${x.title||''}</div>
      <div class='muted'>${x.info||''}</div>
      <div class='tags'>${[x.region,x.district,x.f1,x.f2,x.f3, x.mode==='online'?'ONLINE':'ODDIY'].filter(Boolean).map(v=>`<span class='tag'>${v}</span>`).join('')}${tierTag}</div>
      ${x.mode==='online'?`<div class='muted'>Boshlash: ${x.start||'-'} · Tugash: ${x.end||'-'}</div>`:''}
      ${st.countdown?`<div class='muted'>⏳ ${st.countdown}</div>`:''}
      <div class='cta'>${x.link?`<a class='btn' ${st.open?'':'disabled'} href='${x.link}' target='_blank'>${st.open?'Boshlash':'Yopiq'}</a>`:''}
        <button class='btn ghost' ${x.link?'':'disabled'} onclick='navigator.clipboard.writeText("${x.link||''}")'>Nusxa</button>
      </div>
    </div></div>`
}
function filterTests(){
  const q=(document.getElementById('q-tests').value||'').toLowerCase();
  const reg=document.getElementById('region-tests').value; const dis=document.getElementById('district-tests').value;
  const f1=document.getElementById('f1-tests').value; const f2=document.getElementById('f2-tests').value; const f3=document.getElementById('f3-tests').value;
  const list=CACHE_TESTS
   .filter(x=>(!reg||x.region===reg)&&(!dis||x.district===dis)&&(!f1||x.f1===f1)&&(!f2||x.f2===f2)&&(!f3||x.f3===f3)&&(!q||(`${x.title} ${x.info}`.toLowerCase().includes(q))))
   .sort((a,b)=> (b.mode==='online') - (a.mode==='online'));
  const {slice,pages}=paginate(list, pageTests, 12);
  gridTests.innerHTML = slice.map(testCardHtml).join('');
  renderPager(pagerTests, pages, pageTests, p=>{pageTests=p; filterTests()});
} ${x.info}`.toLowerCase().includes(q))))
   .sort((a,b)=> (b.mode==='online') - (a.mode==='online'));
  const {slice,pages}=paginate(list, pageTests, 12);
  gridTests.innerHTML = slice.map(testCardHtml).join('');
  renderPager(pagerTests, pages, pageTests, p=>{pageTests=p; filterTests()});
}
['q-tests','f1-tests','f2-tests','f3-tests'].forEach(id=>document.getElementById(id).addEventListener('input',()=>{pageTests=1; filterTests()}));

onSnapshot(query(colRefs.tests, orderBy('createdAt','desc')), snap=>{
  CACHE_TESTS = snap.docs.map(d=>({ id:d.id, ...d.data() }));
  buildFilters(CACHE_TESTS, ['f1-tests','f2-tests','f3-tests']);
  pageTests=1; filterTests();
});

// Live countdown for tests
setInterval(()=>{
  if(pages.tests.classList.contains('active')) filterTests();
}, 1000);

// ===== Admin auth & create =====
const ADMIN_EMAILS = ["sohibjonmath@gmail.com"]; 
const ADMIN_IDS = [38864];
function isAdmin(user){ return user && ADMIN_EMAILS.includes(user.email); }
function isAdminIdLocal(){ return !!stateUser.numericId && ADMIN_IDS.includes(Number(stateUser.numericId)); }

const btnGoogle = document.getElementById('btn-google');
const btnAdminLogout = document.getElementById('btn-admin-logout');
btnGoogle.onclick = async ()=>{ try{ await signInWithPopup(auth, new GoogleAuthProvider()); }catch(e){ alert('Kirishda xatolik: '+e.message); } };
btnAdminLogout.onclick = ()=> signOut(auth);
// Email/parol auth
document.getElementById('btn-email-login').onclick = async ()=>{
  try{ await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); }
  catch(e){ alert('Email kirishda xato: '+e.message); }
};
document.getElementById('btn-email-register').onclick = async ()=>{
  try{ await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); alert('Ro'yxatdan o'tdi'); }
  catch(e){ alert('Ro'yxatdan o'tishda xato: '+e.message); }
};

onAuthStateChanged(auth, user=>{
  const ok = isAdmin(user) || isAdminIdLocal();
  btnGoogle.style.display = ok?'none':'inline-flex';
  btnAdminLogout.style.display = ok?'inline-flex':'none';
  document.querySelectorAll('#page-admin form button').forEach(b=>b.disabled=!ok);
});

// Save banner
document.getElementById('form-banner').addEventListener('submit', async (e)=>{
  e.preventDefault(); const f=e.target; const user=auth.currentUser; if(!(isAdmin(user)||isAdminIdLocal())) return alert('Ruxsat yo'q');
  const data={ title:f.title.value.trim(), link:f.link.value.trim(), img:f.img.value.trim(), order:Number(f.order.value||0), createdAt:serverTimestamp() };
  try{ await addDoc(colRefs.banners, data); f.reset(); alert('Banner saqlandi'); }catch(err){ alert('Xatolik: '+err.message); }
}); const f=e.target; const user=auth.currentUser; if(!isAdmin(user)) return alert('Ruxsat yo'q');
  const data={ title:f.title.value.trim(), link:f.link.value.trim(), img:f.img.value.trim(), order:Number(f.order.value||0), createdAt:serverTimestamp() };
  try{ await addDoc(colRefs.banners, data); f.reset(); alert('Banner saqlandi'); }catch(err){ alert('Xatolik: '+err.message); }
});

// Save item (course/test/simulator)
document.getElementById('form-item').addEventListener('submit', async (e)=>{
  e.preventDefault(); const f=e.target; const user=auth.currentUser; if(!(isAdmin(user)||isAdminIdLocal())) return alert('Ruxsat yo'q');
  const kind=f.kind.value; const base={
    title:f.title.value.trim(), info:f.info.value.trim(), img:f.img.value.trim(), price:Number(f.price.value||0), link:f.link.value.trim(),
    region:f.region?.value||'', district:f.district?.value||'', tier:f.tier?.value||'',
    f1:f.f1?.value.trim()||'', f2:f.f2?.value.trim()||'', f3:f.f3?.value.trim()||'', mode:f.mode.value, createdAt:serverTimestamp()
  };
  try{
    if(kind==='tests'){
      const payload={...base, start:f.start.value||null, end:f.end.value||null};
      await addDoc(colRefs.tests, payload);
    } else if(kind==='courses'){ await addDoc(colRefs.courses, base); }
    else { await addDoc(colRefs.simulators, base); }
    f.reset(); alert('Saqlandi');
  }catch(err){ alert('Xatolik: '+err.message); }
}); const f=e.target; const user=auth.currentUser; if(!isAdmin(user)) return alert('Ruxsat yo'q');
  const kind=f.kind.value; const base={
    title:f.title.value.trim(), info:f.info.value.trim(), img:f.img.value.trim(), price:Number(f.price.value||0), link:f.link.value.trim(),
    f1:f.f1.value.trim(), f2:f.f2.value.trim(), f3:f.f3.value.trim(), mode:f.mode.value, createdAt:serverTimestamp()
  };
  try{
    if(kind==='tests'){
      const payload={...base, start:f.start.value||null, end:f.end.value||null};
      await addDoc(colRefs.tests, payload);
    } else if(kind==='courses'){ await addDoc(colRefs.courses, base); }
    else { await addDoc(colRefs.simulators, base); }
    f.reset(); alert('Saqlandi');
  }catch(err){ alert('Xatolik: '+err.message); }
});

// Promo create
document.getElementById('form-promo')?.addEventListener('submit', async (e)=>{
  e.preventDefault(); const f=e.target; const user=auth.currentUser; if(!(isAdmin(user)||isAdminIdLocal())) return alert('Ruxsat yo'q');
  const expires = f.expires.value? new Date(f.expires.value): null;
  const payload={ code:f.code.value.trim().toUpperCase(), amount:Number(f.amount.value||0), kind:f.kind.value,
    expiresAt: expires? expires.toISOString(): null, usageLimit:Number(f.usageLimit.value||0)||0, perUser: f.perUser.value==='true',
    minBalance:Number(f.minBalance.value||0)||0, maxBenefit:Number(f.maxBenefit.value||0)||0,
    usedCount:0, usedByIds:[], active:true, createdAt:serverTimestamp() };
  try{ await addDoc(colRefs.promocodes, payload); f.reset(); alert('Promo saqlandi'); }catch(err){ alert('Xatolik: '+err.message); }
});

// Promo list (live)
onSnapshot(query(colRefs.promocodes, orderBy('createdAt','desc')), snap=>{
  const box=document.getElementById('promo-list'); if(!box) return;
  const rows=[]; snap.forEach(d=>{ const p=d.data(); rows.push(`${p.code} — ${p.kind==='percent'?p.amount+'%':(p.amount+' so'm')} ${p.expiresAt?('· gacha: '+p.expiresAt):''} · used: ${p.usedCount}/${p.usageLimit||'∞'} ${p.minBalance?('· minBal: '+p.minBalance):''} ${p.maxBenefit?('· cap: '+p.maxBenefit):''} ${p.active?'':'(o'chiq)'}`); });
  box.textContent = rows.join('
');
});

// Promo apply (profile)
document.getElementById('btn-apply-promo')?.addEventListener('click', async ()=>{
  const input = (document.getElementById('promoInput').value||'').trim().toUpperCase();
  const msg = document.getElementById('promo-msg'); if(!msg) return; msg.textContent='';
  if(!input) return;
  try{
    const qSnap = await getDocs(query(colRefs.promocodes, where('code','==', input)));
    if(qSnap.empty) return msg.textContent='❌ Noto'g'ri promo kod';
    const d=qSnap.docs[0]; const p=d.data();
    const now = Date.now();
    if(p.active===false) return msg.textContent='❌ Promo o'chiq';
    if(p.expiresAt && now > new Date(p.expiresAt).getTime()) return msg.textContent='❌ Muddat tugagan';
    if(p.usageLimit && p.usedCount>=p.usageLimit) return msg.textContent='❌ Limit tugagan';
    const uidNum = Number(stateUser.numericId||0);
    if(p.perUser && Array.isArray(p.usedByIds) && p.usedByIds.includes(uidNum)) return msg.textContent='❌ Ushbu promo allaqachon ishlatilgan';
    if(p.minBalance && Number(stateUser.balance||0) < p.minBalance) return msg.textContent = `❌ Minimal balans: ${p.minBalance}`;
    // Hisoblash + cap
    let add = 0;
    if(p.kind==='flat'){ add = p.amount; } else { add = Math.round((Number(stateUser.balance||0)) * (p.amount/100)); }
    if(p.maxBenefit && add > p.maxBenefit) add = p.maxBenefit;

    // Lokal balans yangilash
    stateUser.balance = Number(stateUser.balance||0) + Math.max(0, add);
    localStorage.setItem(LS_USER, JSON.stringify(stateUser)); renderProfile();

    // Firestore balans (agar mapping mavjud bo'lsa)
    try{
      if(auth.currentUser){
        await updateDoc(doc(db,'users',auth.currentUser.uid), { balance: Number(stateUser.balance) });
      } else if(stateUser.numericId){
        const mapSnap = await getDoc(doc(db,'users_by_numeric', String(stateUser.numericId)));
        if(mapSnap.exists()){
          const tgtUid = mapSnap.data().uid;
          await updateDoc(doc(db,'users', tgtUid), { balance: Number(stateUser.balance) });
        }
      }
    }catch(e){ console.warn('Firestore balance update warn', e); }

    // Promo yangilash
    await updateDoc(doc(db, 'promocodes', d.id), { usedCount: increment(1), usedByIds: arrayUnion(uidNum) });
    msg.textContent = `✅ Qo'llandi! ${add} so'm qo'shildi`;
  }catch(err){ msg.textContent = 'Xatolik: '+err.message; }
});

// Admin balance update
document.getElementById('form-balance')?.addEventListener('submit', async (e)=>{
  e.preventDefault(); const f=e.target; const user=auth.currentUser; if(!(isAdmin(user)||isAdminIdLocal())) return alert('Ruxsat yo'q');
  const nid = Number(f.numericId.value||0); const delta = Number(f.delta.value||0);
  if(!nid) return alert('Numeric ID kiriting');
  try{
    const mapRef = doc(db,'users_by_numeric', String(nid));
    const mapSnap = await getDoc(mapRef);
    if(mapSnap.exists() && mapSnap.data().uid){
      const uid = mapSnap.data().uid;
      await updateDoc(doc(db,'users', uid), { balance: increment(delta) });
      alert('Balans Firestore’da yangilandi');
    } else {
      if(stateUser.numericId==nid){ stateUser.balance = Number(stateUser.balance||0)+delta; localStorage.setItem(LS_USER, JSON.stringify(stateUser)); renderProfile(); }
      alert('Mapping topilmadi (users_by_numeric). Avval profilni auth bilan saqlang.');
    }
  }catch(err){ alert('Xatolik: '+err.message); }
  f.reset();
});

</script>

<!--
======================== FIRESTORE RULES TAVSIYA (production draft) ========================
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn(){ return request.auth != null; }
    function isAdmin(){ return isSignedIn() && request.auth.token.email in ['sohibjonmath@gmail.com']; }

    // Ommaviy kontent o'qish mumkin, yozish faqat admin
    match /{col}/{doc} where col in ['home_banners','courses','tests','simulators','promocodes'] {
      allow read: if true;               // public read
      allow create, update, delete: if isAdmin();
    }

    // Foydalanuvchi profili
    match /users/{uid} {
      // Foydalanuvchi o'zi o'qiydi; o'zi yangilaydi
      allow read, update: if isSignedIn() && request.auth.uid == uid;
      // Yaratishni har qanday signed-in foydalanuvchi qilishi mumkin
      allow create: if isSignedIn();
      // Balansni o'zgartirish faqat admin: agar request.resource.data.balance != resource.data.balance bo'lsa, admin bo'lsin
      allow update: if (
        isSignedIn() && request.auth.uid == uid && request.resource.data.diff(resource.data).keys().hasOnly(['name','birth','points','numericId'])
      ) || (
        isAdmin()
      );
    }

    // Numeric ID ↔ UID mapping — faqat admin yozadi, o'qish ham faqat admin
    match /users_by_numeric/{id} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
  }
}
===============================================================================
-->

</body>
</html>
