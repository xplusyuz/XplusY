<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MathCenter.uz — Super Admin</title>
  <!-- Favicon: inline SVG (green M) -->
  <link rel="icon" type="image/svg+xml" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="14" fill="%230faf64"/><path d="M12 46V18h8l12 15 12-15h8v28h-8V31L33 46h-2L20 31v15z" fill="white"/></svg>' />
  <meta name="theme-color" content="#0faf64" />
  <style>
    :root{
      --green:#0faf64; --green-700:#0a8f52; --edge:#dff4eb; --bg:#f6fffb; --ink:#0b1f17; --muted:#557a6f;
      --card:#fff; --shadow:0 10px 22px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;color:var(--ink);background:var(--bg)}

    /* Header */
    header{position:sticky;top:0;z-index:40;background:#ffffffe6;border-bottom:1px solid var(--edge);backdrop-filter:saturate(150%) blur(8px)}
    .header-inner{max-width:1200px;margin:0 auto;padding:10px 16px;display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;background:radial-gradient(60% 60% at 50% 35%, #b8ffd9, #2de38d 55%, #0ea55a 100%);box-shadow:0 0 36px rgba(14,175,100,.35), inset 0 0 18px rgba(255,255,255,.7)}
    .logo svg{width:26px;height:26px;fill:#fff}
    .brand-title{padding:6px 10px;border-radius:12px;background:linear-gradient(145deg,#f7fffb,#eafff5);box-shadow:0 10px 18px #b0f5d633,inset 0 -3px 8px rgba(255,255,255,.8)}
    .brand-title h1{margin:0;font-size:18px;letter-spacing:.3px;background:linear-gradient(180deg,#0dbb6f,#0a8f52);-webkit-background-clip:text;color:transparent;font-weight:900}
    .admin-badge{margin-left:6px;font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid var(--edge);background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.08);font-weight:900;color:var(--green-700);display:none}

    /* Quick stats */
    .stats{display:flex;gap:10px;align-items:center}
    .pill{background:#fff;border:1px solid var(--edge);border-radius:12px;padding:8px 10px;box-shadow:var(--shadow);font-size:12px}
    .pill b{font-size:13px}
    @media(max-width:780px){ .stats{display:none} }

    main{max-width:1200px;margin:16px auto 120px;padding:0 16px}
    .content{background:var(--card);border:1px solid var(--edge);border-radius:16px;box-shadow:var(--shadow);padding:16px;position:relative}
    .content h2{margin:0 0 10px}
    .admin-toolbar{position:absolute;right:12px;top:12px;display:none;gap:6px}
    .btn, .chip, .btn-icon{cursor:pointer;border:1px solid var(--edge);background:#fff}
    .btn{padding:10px 14px;border-radius:12px;font-weight:800}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn--pri{background:var(--green);border-color:var(--green);color:#fff}
    .chip{padding:9px 12px;border-radius:12px;font-weight:800;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .chip.active{background:var(--green);border-color:var(--green);color:#fff;box-shadow:0 8px 22px rgba(15,175,100,.35)}
    .btn-icon{width:40px;height:40px;border-radius:12px;display:grid;place-items:center}

    /* Grid cards */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .card{background:#fff;border:1px solid var(--edge);border-radius:14px;overflow:hidden;box-shadow:var(--shadow)}
    .card .cover{aspect-ratio:16/9;background:#f3f7f5;object-fit:cover;width:100%}
    .card .body{padding:10px 12px}
    .card h3{margin:0 0 6px;font-size:16px}
    .meta{font-size:12px;color:var(--muted)}
    .badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .badge{font-size:11px;border:1px solid var(--edge);border-radius:999px;padding:2px 8px}

    /* Filters + pager */
    .filters{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin:8px 0 12px;align-items:center}
    @media(max-width:900px){.filters{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:520px){.filters{grid-template-columns:1fr}}
    .filters .flt{display:flex;gap:6px;align-items:center}
    .filters select{flex:1;padding:10px 12px;border:1px solid var(--edge);border-radius:12px}
    .pager{display:flex;justify-content:space-between;align-items:center;margin-top:10px}

    /* FAB (touch-first, floating speed dial) */
    .fab{position:fixed;right:16px;bottom:16px;z-index:80;touch-action:manipulation}
    .fab .main{width:64px;height:64px;border-radius:22px;background:var(--green);color:#fff;font-size:26px;border:none;font-weight:900;box-shadow:0 10px 24px rgba(0,0,0,.25)}
    .fab .menu{position:absolute;right:0;bottom:76px;display:none;flex-direction:column;gap:10px}
    .fab.open .menu{display:flex}

    /* Modals */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.25);z-index:90}
    .modal.open{display:grid}
    .dialog{background:#fff;border:1px solid var(--edge);border-radius:16px;box-shadow:0 10px 26px rgba(0,0,0,.12);max-width:840px;width:100%;max-height:90vh;overflow:auto;padding:16px}
    .dialog .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .dialog .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media(max-width:680px){.dialog .grid{grid-template-columns:1fr}}
    .row{display:grid;gap:6px}
    .row label{font-size:12px;color:var(--muted)}
    .row input,.row select,.row textarea{padding:10px 12px;border:1px solid var(--edge);border-radius:12px;outline:none}
    .row textarea{min-height:100px;resize:vertical}
    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}

    /* Tables */
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--edge);border-radius:14px;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid var(--edge);font-size:14px}
    th{background:#f7fffb;text-align:left}
    tr:last-child td{border-bottom:none}

    .admin-only{display:none}
    .muted{color:var(--muted)}
    .hidden{display:none !important}
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg"><path d="M76 92h104c9 0 16-7 16-16s-7-16-16-16H60c-9 0-16 7-16 16s7 16 16 16h4c8 41 4 77-8 97-5 8 5 17 13 12 24-14 35-53 29-109zm57 0c7 39 3 74-8 94-5 9 6 18 14 12 24-16 35-56 28-106h-34z"/></svg>
        </div>
        <div class="brand-title"><h1>MathCenter.uz</h1></div>
        <span id="adminBadge" class="admin-badge">ADMIN</span>
      </div>
      <div class="stats" id="headerStats">
        <span class="pill">Salom, <b id="helloName">Mehmon</b></span>
        <span class="pill">ID: <b id="headerID">—</b></span>
        <span class="pill">Balans: <b id="headerBalans">0</b></span>
        <span class="pill">Ball: <b id="headerBall">0</b></span>
      </div>
    </div>
  </header>

  <main>
    <div id="app"><div class="content"><h2>Bosh sahifa</h2><p>Xush kelibsiz!</p></div></div>
  </main>

  <!-- Floating touch menu (Speed dial) -->
  <div class="fab" id="fab">
    <button class="main" id="fabMain">≡</button>
    <div class="menu" id="fabMenu">
      <button class="chip" data-route="home">Bosh sahifa</button>
      <button class="chip" data-route="courses">Kurslar</button>
      <button class="chip" data-route="tests">Testlar</button>
      <button class="chip" data-route="simulators">Simulyatorlar</button>
      <button class="chip" data-route="results">Natijalar</button>
      <button class="chip" data-route="profile">Profil</button>
      <button class="chip admin-only" data-route="admin">Admin panel</button>
    </div>
  </div>

  <!-- AUTH dialog -->
  <div class="modal" id="authModal"><div class="dialog">
    <div class="head"><div class="title"><b>Kirish / Ro‘yxatdan o‘tish</b></div><button class="btn" data-x="authModal">✕</button></div>
    <div class="grid">
      <div class="row"><label>Numeric ID</label><input id="login_id" placeholder="masalan: 38864"></div>
      <div class="row"><label>Parol</label><input type="password" id="login_pass" placeholder="Parol"></div>
    </div>
    <div class="actions"><button class="btn" id="btnOpenSignup">Ro‘yxatdan</button><button class="btn btn--pri" id="btnLoginId">Kirish</button></div>
  </div></div>

  <div class="modal" id="signupModal"><div class="dialog">
    <div class="head"><div class="title"><b>Ro‘yxatdan o‘tish (tez)</b></div><button class="btn" data-x="signupModal">✕</button></div>
    <div class="grid">
      <div class="row"><label>Ism</label><input id="su_ism"></div>
      <div class="row"><label>Familiya</label><input id="su_fam"></div>
      <div class="row"><label>Telefon</label><input id="su_tel" placeholder="+998..."></div>
      <div class="row"><label>Email</label><input id="su_email" type="email" placeholder="email@..."></div>
      <div class="row"><label>Parol</label><input id="su_pass" type="password" placeholder="kamida 6 belgi"></div>
    </div>
    <div class="actions"><button class="btn" data-x="signupModal">Bekor</button><button class="btn btn--pri" id="btnSignup">Ro‘yxatdan</button></div>
  </div></div>

  <!-- PROFILE dialog -->
  <div class="modal" id="profileModal"><div class="dialog">
    <div class="head"><div class="title"><b>Profil ma’lumotlari</b></div><button class="btn" data-x="profileModal">✕</button></div>
    <div class="grid">
      <div class="row"><label>Ism</label><input id="p_ism"></div>
      <div class="row"><label>Familiya</label><input id="p_familiya"></div>
      <div class="row"><label>Tug‘ilgan sana</label><input type="date" id="p_tugilgan"></div>
      <div class="row"><label>Telefon</label><input id="p_tel"></div>
      <div class="row"><label>Telegram</label><input id="p_tg" placeholder="https://t.me/username"></div>
      <div class="row"><label>Email</label><input id="p_email"></div>
      <div class="row"><label>Rol</label>
        <select id="p_role"><option value="">Tanlang</option><option value="oquvchi">O‘quvchi</option><option value="oqituvchi">O‘qituvchi</option></select>
      </div>
      <div class="row"><label>Viloyat</label><input id="p_viloyat" placeholder="Toshkent"></div>
      <div class="row"><label>Tuman</label><input id="p_tuman" placeholder="Chilonzor"></div>
      <div class="row"><label>Maktab</label><input id="p_maktab"></div>
      <div class="row" style="grid-column:1/-1"><label>Manzil</label><input id="p_manzil"></div>
    </div>
    <div class="actions"><button class="btn" data-x="profileModal">Bekor</button><button class="btn btn--pri" id="btnSaveProfile">Saqlash</button></div>
  </div></div>

  <!-- PROMO dialog -->
  <div class="modal" id="promoModal"><div class="dialog">
    <div class="head"><div class="title"><b>Promo kod</b></div><button class="btn" data-x="promoModal">✕</button></div>
    <div class="grid">
      <div class="row" style="grid-column:1/-1"><label>Promo kod kiriting</label><input id="promoInput" placeholder="ABC123"></div>
      <div class="row"><button class="btn" id="btnCheckPromo">Tekshirish</button></div>
      <div class="row"><button class="btn btn--pri" id="btnApplyPromo">Qo‘llash</button></div>
      <div class="row" style="grid-column:1/-1"><div id="promoInfo" class="muted"></div></div>
    </div>
  </div></div>

  <!-- ADMIN: Banner/Card/Test dialogs -->
  <div class="modal" id="bannerModal"><div class="dialog">
    <div class="head"><div class="title"><b>Banner</b></div><button class="btn" data-x="bannerModal">✕</button></div>
    <div class="grid">
      <div class="row" style="grid-column:1/-1"><label>Sarlavha</label><input id="bn_title"></div>
      <div class="row" style="grid-column:1/-1"><label>Rasm URL</label><input id="bn_img" placeholder="img/banner.jpg yoki https://..."></div>
      <div class="row"><label>Filter 1</label><input id="bn_f1"></div>
      <div class="row"><label>Filter 2</label><input id="bn_f2"></div>
      <div class="row"><label>Filter 3</label><input id="bn_f3"></div>
      <div class="row" style="grid-column:1/-1"><label>Link</label><input id="bn_link" placeholder="#courses yoki https://..."></div>
    </div>
    <div class="actions"><button class="btn" data-x="bannerModal">Bekor</button><button class="btn btn--pri" id="btnSaveBanner">Saqlash</button></div>
  </div></div>

  <div class="modal" id="cardModal"><div class="dialog">
    <div class="head"><div class="title" id="cardModalTitle"><b>Card</b></div><button class="btn" data-x="cardModal">✕</button></div>
    <div class="grid">
      <div class="row" style="grid-column:1/-1"><label>Bo‘lim</label>
        <select id="cd_coll"><option value="courses">Kurslar</option><option value="simulators">Simulyatorlar</option><option value="testsOddiy">Testlar (oddiy)</option></select>
      </div>
      <div class="row" style="grid-column:1/-1"><label>Sarlavha</label><input id="cd_title"></div>
      <div class="row" style="grid-column:1/-1"><label>Rasm URL</label><input id="cd_img" placeholder="img/cover.jpg yoki https://..."></div>
      <div class="row"><label>Filter 1</label><input id="cd_f1"></div>
      <div class="row"><label>Filter 2</label><input id="cd_f2"></div>
      <div class="row"><label>Filter 3</label><input id="cd_f3"></div>
      <div class="row"><label>Fan</label><input id="cd_subject" placeholder="Matematika"></div>
      <div class="row"><label>Daraja</label><input id="cd_level" placeholder="Boshlang‘ich"></div>
      <div class="row"><label>Turi</label><input id="cd_type" placeholder="video/pdf/lab"></div>
      <div class="row"><label>Davomiylik</label><input id="cd_duration" placeholder="45 daqiqa"></div>
      <div class="row" style="grid-column:1/-1"><label>Link</label><input id="cd_link" placeholder="# yoki https://..."></div>
    </div>
    <div class="actions"><button class="btn" data-x="cardModal">Bekor</button><button class="btn btn--pri" id="btnSaveCard">Saqlash</button></div>
  </div></div>

  <div class="modal" id="onlineTestModal"><div class="dialog">
    <div class="head"><div class="title"><b>Onlayn test</b></div><button class="btn" data-x="onlineTestModal">✕</button></div>
    <div class="grid">
      <div class="row" style="grid-column:1/-1"><label>Sarlavha</label><input id="to_title"></div>
      <div class="row" style="grid-column:1/-1"><label>Rasm URL</label><input id="to_img"></div>
      <div class="row"><label>Filter 1</label><input id="to_f1"></div>
      <div class="row"><label>Filter 2</label><input id="to_f2"></div>
      <div class="row"><label>Filter 3</label><input id="to_f3"></div>
      <div class="row"><label>Boshlash</label><input id="to_start" type="datetime-local"></div>
      <div class="row"><label>Tugash</label><input id="to_end" type="datetime-local"></div>
      <div class="row" style="grid-column:1/-1"><label>Link</label><input id="to_link"></div>
    </div>
    <div class="actions"><button class="btn" data-x="onlineTestModal">Bekor</button><button class="btn btn--pri" id="btnSaveOnlineTest">Saqlash</button></div>
  </div></div>

  <!-- ADMIN PANEL -->
  <div class="modal" id="adminModal"><div class="dialog" style="max-width:1000px">
    <div class="head"><div class="title"><b>Admin panel</b></div><button class="btn" data-x="adminModal">✕</button></div>
    <div class="grid" style="grid-template-columns:220px 1fr">
      <div class="row" style="gap:8px">
        <button class="chip adminTab active" data-tab="users">👥 Foydalanuvchilar</button>
        <button class="chip adminTab" data-tab="banners">🖼 Bannerlar</button>
        <button class="chip adminTab" data-tab="cards">🗂 Cardlar</button>
        <button class="chip adminTab" data-tab="tests">🧪 Testlar</button>
        <button class="chip adminTab" data-tab="filters">🔎 Filtrlar</button>
        <button class="chip adminTab" data-tab="promos">🎟 Promo</button>
        <button class="chip adminTab" data-tab="settings">⚙️ Sozlamalar</button>
      </div>
      <div id="adminBody" class="row"></div>
    </div>
  </div></div>

  <script>
    // ------------------------------
    // Local-first tiny store (no backend needed). Can be swapped to Firestore later.
    // ------------------------------
    const LS = {
      get(k, def){ try{ const v = JSON.parse(localStorage.getItem(k) || 'null'); return v ?? def; }catch{ return def; } },
      set(k, v){ localStorage.setItem(k, JSON.stringify(v)); },
      uid(){ return 'id_'+Math.random().toString(36).slice(2,10)+Date.now().toString(36); }
    };

    // Schemas
    const DB = {
      users: LS.get('mc_users', []),
      current: LS.get('mc_current', null), // {id}
      banners: LS.get('mc_banners', []), // {id,title,img,f1,f2,f3,link,ts}
      courses: LS.get('mc_courses', []),
      simulators: LS.get('mc_simulators', []),
      tests: LS.get('mc_tests', []), // {type:'oddiy'|'online', start,end}
      promos: LS.get('mc_promos', []) // {code, off, bonus, limit, used, expiresAt}
    };
    function persist(){ LS.set('mc_users', DB.users); LS.set('mc_current', DB.current); LS.set('mc_banners', DB.banners); LS.set('mc_courses', DB.courses); LS.set('mc_simulators', DB.simulators); LS.set('mc_tests', DB.tests); LS.set('mc_promos', DB.promos); }

    // Seed a Super Admin if empty
    (function seed(){
      if(DB.users.length===0){
        const admin = { id: LS.uid(), numericId: 38864, ism:'Super', familiya:'Admin', tel:'', email:'', role:'admin', balans:0, ball:0, pass:'admin123', createdAt:Date.now() };
        DB.users.push(admin); DB.current = { id: admin.id }; persist();
      }
    })();

    // Helpers
    const $ = (s, r=document)=>r.querySelector(s);
    const $$= (s, r=document)=>Array.from(r.querySelectorAll(s));
    function openModal(id){ const el = $('#'+id); if(!el) return; el.classList.add('open'); document.body.style.overflow='hidden'; }
    function closeModal(id){ const el = $('#'+id); if(!el) return; el.classList.remove('open'); if(!document.querySelector('.modal.open')) document.body.style.overflow=''; }
    document.addEventListener('click', e=>{ const btn=e.target.closest('[data-x]'); if(btn){ closeModal(btn.dataset.x); }});
    document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ $$('.modal.open').forEach(m=>m.classList.remove('open')); document.body.style.overflow=''; }});

    // Router
    const routes = ['home','courses','tests','simulators','results','profile','admin'];
    const Views = {
      home: async ()=> section('Bosh sahifa', `
        <div class="grid" id="homeBanners"></div>
        <div class="grid" style="margin-top:12px">
          <a class="card" onclick="loadRoute('courses')" style="cursor:pointer"><div class="body"><h3>Kurslar</h3><div class="meta">Yangi darslar</div></div></a>
          <a class="card" onclick="loadRoute('tests')" style="cursor:pointer"><div class="body"><h3>Testlar</h3><div class="meta">Onlayn va oddiy</div></div></a>
          <a class="card" onclick="loadRoute('simulators')" style="cursor:pointer"><div class="body"><h3>Simulyatorlar</h3><div class="meta">Trening</div></div></a>
        </div>
      `, `<button class="btn btn--pri" id="home_add_banner">+ Banner</button>`),

      courses: async ()=> listShell('Kurslar','courses'),
      simulators: async ()=> listShell('Simulyatorlar','simulators'),
      tests: async ()=> listShell('Testlar','tests', true),
      results: async ()=> section('Natijalar', `<p>Shaxsiy natijalaringiz tez orada shu yerda bo‘ladi.</p>`),
      profile: async ()=> profileView(),
      admin: async ()=> adminPanel()
    };

    function section(title, inner="", toolbar=""){ return `
      <div class="content">
        <div class="admin-toolbar admin-only">${toolbar||''}</div>
        <h2>${title}</h2>
        ${inner}
      </div>`; }

    function listShell(title, coll, isTests=false){
      return section(title, `
        <div class="filters">
          <div class="flt">
            <select id="${coll}_f1"><option value="">Filter 1</option></select>
            <button class="btn-icon admin-only" id="${coll}_add_here1">+</button>
          </div>
          <div class="flt"><select id="${coll}_f2"><option value="">Filter 2</option></select></div>
          <div class="flt"><select id="${coll}_f3"><option value="">Filter 3</option></select></div>
          <button class="chip" id="${coll}_reset">Tozalash</button>
        </div>
        ${isTests?`<div id="${coll}_online"></div>`:''}
        <div class="grid" id="${coll}_grid"></div>
        <div class="pager">
          <button class="btn" id="${coll}_prev" disabled>← Oldingi</button>
          <div id="${coll}_pageinfo">1-sahifa</div>
          <button class="btn" id="${coll}_next" disabled>Keyingi →</button>
        </div>
        <div style="position:sticky;bottom:8px;display:flex;justify-content:flex-end;margin-top:10px">
          ${isTests?`<button class="btn btn--pri admin-only" id="${coll}_add_online">+ Onlayn test</button>`:''}
          <button class="btn btn--pri admin-only" id="${coll}_add_card" style="margin-left:8px">+ Card</button>
        </div>`);
    }

    function cardHTML(d, extraMeta=[]){
      const img = d.img || d.cover || d.banner || 'https://picsum.photos/640/360?grayscale&random='+(d.rand||0);
      const title = d.title || d.name || 'Nomlanmagan';
      const meta = [d.level, d.subject, d.type, d.duration, ...extraMeta].filter(Boolean).join(' · ');
      return `<div class="card">
        <img class="cover" src="${img}" alt="">
        <div class="body">
          <h3>${title}</h3>
          ${meta?`<div class="meta">${meta}</div>`:''}
          <div class="badges">
            ${d.f1?`<span class="badge">${d.f1}</span>`:''}
            ${d.f2?`<span class="badge">${d.f2}</span>`:''}
            ${d.f3?`<span class="badge">${d.f3}</span>`:''}
            ${d.type==='online'?`<span class="badge">ONLINE</span>`:''}
          </div>
        </div>
      </div>`;
    }

    async function loadRoute(route){
      if(!routes.includes(route)) route='home';
      const app = document.getElementById('app');
      app.innerHTML = await Views[route]();
      history.replaceState({},'', '#'+route);
      setActive(route); window.scrollTo({top:0,behavior:'smooth'});
      // Show admin UI if needed
      if(isAdmin()){ $$('.admin-only', app).forEach(el=>el.style.display=''); $$('.admin-toolbar', app).forEach(el=>el.style.display='flex'); }

      if(route==='home') renderHome();
      if(route==='courses') bootList('courses');
      if(route==='simulators') bootList('simulators');
      if(route==='tests') bootTests();
      if(route==='admin') openModal('adminModal');
    }
    window.addEventListener('hashchange',()=>{ const r=location.hash.replace('#',''); loadRoute(r); });

    // FAB
    const fab = $('#fab'), fabMain=$('#fabMain'), fabMenu=$('#fabMenu');
    fabMain.addEventListener('click', (e)=>{ e.stopPropagation(); fab.classList.toggle('open'); });
    document.addEventListener('click', (e)=>{ if(fab.classList.contains('open') && !fab.contains(e.target)) fab.classList.remove('open'); });
    fabMenu.addEventListener('click',(e)=>{ const b=e.target.closest('.chip'); if(!b) return; const r=b.dataset.route; if(!r) return; fab.classList.remove('open'); loadRoute(r); });

    // Header state
    function isAdmin(){ const u = getCurrentUser(); return !!u && Number(u.numericId)===38864; }
    function getCurrentUser(){ if(!DB.current) return null; return DB.users.find(u=>u.id===DB.current.id)||null; }
    function setHeader(){
      const u = getCurrentUser();
      $('#helloName').textContent = u?.ism || 'Mehmon';
      $('#headerID').textContent = u?.numericId ?? '—';
      $('#headerBalans').textContent = u?.balans ?? 0;
      $('#headerBall').textContent = u?.ball ?? 0;
      $('#adminBadge').style.display = isAdmin()? 'inline-block':'none';
      // FAB admin button
      const adminBtn = $(`[data-route="admin"]`);
      if(adminBtn) adminBtn.style.display = isAdmin()? 'inline-block':'none';
    }

    // Auth
    $('#btnOpenSignup').addEventListener('click', ()=>{ closeModal('authModal'); openModal('signupModal'); });
    $('#btnLoginId').addEventListener('click', ()=>{
      const nid = Number($('#login_id').value.trim()); const pass=$('#login_pass').value;
      const u = DB.users.find(u=>Number(u.numericId)===nid && u.pass===pass);
      if(!u){ alert('ID yoki parol xato'); return; }
      DB.current={id:u.id}; persist(); setHeader(); closeModal('authModal'); loadRoute('home');
    });
    $('#btnSignup').addEventListener('click', ()=>{
      const ism=$('#su_ism').value.trim(); const fam=$('#su_fam').value.trim(); const tel=$('#su_tel').value.trim(); const email=$('#su_email').value.trim(); const pass=$('#su_pass').value;
      if(!ism || !fam || !tel || !pass || pass.length<6){ alert('Ism, Familiya, Telefon va Parol (≥6) majburiy'); return; }
      const numericId = genNumericId();
      const u = { id:LS.uid(), numericId, ism, familiya:fam, tel, email, pass, role:'oquvchi', balans:0, ball:0, createdAt:Date.now() };
      DB.users.push(u); DB.current={id:u.id}; persist(); closeModal('signupModal'); setHeader(); alert('Muvaffaqiyatli! Sizning ID: '+numericId);
    });
    function genNumericId(){
      let id = 10000 + Math.floor(Math.random()*89999);
      while(DB.users.some(u=>Number(u.numericId)===id)) id++;
      return id;
    }

    // Profile view
    function profileView(){
      const u = getCurrentUser();
      if(!u){ openModal('authModal'); return section('Profil', `<p>Kirish talab etiladi.</p>`); }
      return section('Profil', `
        <div class="content" style="margin-bottom:10px">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" id="btnEditProfile">Tahrirlash</button>
            <button class="btn" id="btnPromo">Promo</button>
            <button class="btn" id="btnLogout">Chiqish</button>
          </div>
        </div>
        <div class="grid" id="profileGrid"></div>
      `);
    }
    function renderProfile(){
      const u = getCurrentUser(); if(!u) return;
      const grid = $('#profileGrid');
      grid.innerHTML = [
        rowKV('Ism', u.ism), rowKV('Familiya', u.familiya), rowKV('Telefon', u.tel), rowKV('Email', u.email||'—'),
        rowKV('Rol', u.role), rowKV('Viloyat', u.viloyat||'—'), rowKV('Tuman', u.tuman||'—'),
        rowKV('Maktab', u.maktab||'—'), rowKV('Manzil', u.manzil||'—'),
        rowKV('Numeric ID', u.numericId), rowKV('Balans', u.balans), rowKV('Ball', u.ball)
      ].map(htmlCard).join('');
      $('#btnEditProfile').onclick = ()=>{
        $('#p_ism').value=u.ism||''; $('#p_familiya').value=u.familiya||''; $('#p_tugilgan').value=u.tugilganSana||''; $('#p_tel').value=u.tel||''; $('#p_tg').value=u.tg||''; $('#p_email').value=u.email||''; $('#p_role').value=u.role||''; $('#p_viloyat').value=u.viloyat||''; $('#p_tuman').value=u.tuman||''; $('#p_maktab').value=u.maktab||''; $('#p_manzil').value=u.manzil||''; openModal('profileModal');
      };
      $('#btnPromo').onclick = ()=> openModal('promoModal');
      $('#btnLogout').onclick = ()=>{ DB.current=null; persist(); setHeader(); loadRoute('home'); };
    }
    function rowKV(k,v){ return `<div><div class="muted" style="font-size:12px">${k}</div><div><b>${(v??'')===''?'—':v}</b></div></div>`; }
    function htmlCard(inner){ return `<div class="card"><div class="body">${inner}</div></div>`; }

    $('#btnSaveProfile').addEventListener('click', ()=>{
      const u = getCurrentUser(); if(!u) return;
      u.ism=$('#p_ism').value.trim(); u.familiya=$('#p_familiya').value.trim(); u.tugilganSana=$('#p_tugilgan').value; u.tel=$('#p_tel').value.trim(); u.tg=$('#p_tg').value.trim(); u.email=$('#p_email').value.trim(); u.role=$('#p_role').value; u.viloyat=$('#p_viloyat').value; u.tuman=$('#p_tuman').value; u.maktab=$('#p_maktab').value.trim(); u.manzil=$('#p_manzil').value.trim();
      persist(); closeModal('profileModal'); setHeader(); renderProfile();
    });

    // Promo
    function findPromo(code){ return DB.promos.find(p=>p.code===code); }
    $('#btnCheckPromo').addEventListener('click', ()=>{
      const code = $('#promoInput').value.trim().toUpperCase(); if(!code){ alert('Kod kiriting'); return; }
      const p = findPromo(code); if(!p){ $('#promoInfo').textContent='Kod topilmadi'; return; }
      $('#promoInfo').textContent = `Chegirma: ${(p.off||0)}%, Bonus: ${(p.bonus||0)} so‘m, Limit: ${p.limit||'—'}, Ishlatilgan: ${p.used||0}`;
    });
    $('#btnApplyPromo').addEventListener('click', ()=>{
      const u=getCurrentUser(); if(!u){ openModal('authModal'); return; }
      const code = $('#promoInput').value.trim().toUpperCase(); if(!code) return;
      const p = findPromo(code); if(!p){ alert('Kod topilmadi'); return; }
      const now = Date.now(); if(p.expiresAt && now>p.expiresAt){ alert('Kod muddati tugagan'); return; }
      if(p.limit!=null && (p.used||0)>=p.limit){ alert('Kod limiti tugagan'); return; }
      // One-per-user: track in p.redeemers
      p.redeemers = p.redeemers||[]; if(p.redeemers.includes(u.id)){ alert('Siz bu koddan allaqachon foydalandingiz'); return; }
      u.balans = (u.balans||0) + (p.bonus||0); u.activeDiscount = {code: p.code, off: p.off||0, expiresAt: p.expiresAt||null};
      p.used = (p.used||0)+1; p.redeemers.push(u.id);
      persist(); setHeader(); alert('Promo qo‘llandi!'); closeModal('promoModal');
    });

    // Home banners
    function renderHome(){
      const box = $('#homeBanners');
      const list = [...DB.banners].sort((a,b)=>b.ts-a.ts).slice(0,8);
      box.innerHTML = list.length? list.map(b=>cardHTML({...b, img:b.img, title:b.title, f1:b.f1, f2:b.f2, f3:b.f3})).join('') : `<div class="card"><div class="body"><h3>Bannerlar hali yo‘q</h3></div></div>`;
      $('#home_add_banner')?.addEventListener('click', ()=>{ if(!isAdmin()) return alert('Admin kerak'); clearBannerForm(); openModal('bannerModal'); });
    }

    // Generic lists
    function bootList(coll){
      const store = DB[coll]; const box = $('#'+coll+'_grid'); const f1=$('#'+coll+'_f1'), f2=$('#'+coll+'_f2'), f3=$('#'+coll+'_f3'); const reset=$('#'+coll+'_reset');
      const PAGE=12; let page=1;
      function uniq(a){ return Array.from(new Set(a.filter(Boolean))); }
      function fillFilters(){
        const u1=uniq(store.map(d=>d.f1)), u2=uniq(store.map(d=>d.f2)), u3=uniq(store.map(d=>d.f3));
        f1.innerHTML='<option value="">Filter 1</option>'+u1.map(x=>`<option>${x}</option>`).join('');
        f2.innerHTML='<option value="">Filter 2</option>'+u2.map(x=>`<option>${x}</option>`).join('');
        f3.innerHTML='<option value="">Filter 3</option>'+u3.map(x=>`<option>${x}</option>`).join('');
      }
      function filtered(){ const s1=f1.value, s2=f2.value, s3=f3.value; return store.filter(d=>(!s1||d.f1===s1)&&(!s2||d.f2===s2)&&(!s3||d.f3===s3)); }
      function render(){ const arr=filtered().sort((a,b)=>b.ts-a.ts); const start=(page-1)*PAGE; const pageItems=arr.slice(start,start+PAGE); box.innerHTML = pageItems.length? pageItems.map(cardHTML).join('') : `<div class="card"><div class="body"><h3>Hech narsa topilmadi</h3></div></div>`; $('#'+coll+'_pageinfo').textContent=page+'-sahifa'; $('#'+coll+'_prev').disabled = (page<=1); $('#'+coll+'_next').disabled = (start+PAGE>=arr.length); }
      fillFilters(); render();
      f1.onchange=f2.onchange=f3.onchange=()=>{ page=1; render(); };
      reset.onclick=()=>{ f1.value=''; f2.value=''; f3.value=''; page=1; render(); };
      $('#'+coll+'_prev').onclick=()=>{ if(page>1){ page--; render(); }};
      $('#'+coll+'_next').onclick=()=>{ page++; render(); };
      $('#'+coll+'_add_card')?.addEventListener('click', ()=>{ if(!isAdmin()) return alert('Admin kerak'); clearCardForm(); $('#cd_coll').value = (coll==='tests'?'testsOddiy':coll); // tests oddiy
        $('#cd_f1').value=f1.value||''; $('#cd_f2').value=f2.value||''; $('#cd_f3').value=f3.value||''; openModal('cardModal'); });
      $('#'+coll+'_add_here1')?.addEventListener('click', ()=>{ if(!isAdmin()) return alert('Admin kerak'); clearCardForm(); $('#cd_coll').value=(coll==='tests'?'testsOddiy':coll); $('#cd_f1').value=f1.value||''; openModal('cardModal'); });
    }

    // Tests
    function bootTests(){
      bootList('tests'); // oddiy render uchun lekin biz filtlar bilan bir xil API kerak => DB.tests dan faqat oddiy ko‘rsatamiz
      const onlineBox = $('#tests_online');
      function renderOnline(){
        const now=Date.now(); const items=DB.tests.filter(t=>t.type==='online').sort((a,b)=>b.ts-a.ts).slice(0,24);
        if(items.length===0){ onlineBox.innerHTML=''; return; }
        onlineBox.innerHTML = `<div class="content" style="margin-bottom:12px"><div class="admin-toolbar admin-only"><button class="btn btn--pri" id="tests_add_online_toolbar">+ Onlayn test</button></div><h3 style="margin-top:0">Onlayn testlar (birinchi ko‘rinadi)</h3><div class="grid">${items.map(x=>{ const live = (x.start && x.end) ? (now>=x.start && now<=x.end) : false; const s = x.start? new Date(x.start).toLocaleString() : ''; const e = x.end? new Date(x.end).toLocaleString() : ''; return cardHTML({...x}, [(s&&e)?`Boshlash: ${s}`:'',(s&&e)?`Tugash: ${e}`:'', live?'LIVE':'']); }).join('')}</div></div>`;
        if(isAdmin()) onlineBox.querySelectorAll('.admin-toolbar').forEach(el=>el.style.display='flex');
        $('#tests_add_online_toolbar')?.addEventListener('click', ()=>{ if(!isAdmin()) return alert('Admin kerak'); clearOnlineForm(); openModal('onlineTestModal'); });
      }
      renderOnline();
      $('#tests_add_online')?.addEventListener('click', ()=>{ if(!isAdmin()) return alert('Admin kerak'); clearOnlineForm(); openModal('onlineTestModal'); });

      // override default list to only oddiy in grid/pager
      const coll='tests';
      const f1=$('#'+coll+'_f1'), f2=$('#'+coll+'_f2'), f3=$('#'+coll+'_f3'); const box=$('#'+coll+'_grid'); const PAGE=12; let page=1;
      function uniq(a){ return Array.from(new Set(a.filter(Boolean))); }
      function fillFilters(){ const src=DB.tests.filter(t=>t.type!=='online'); const u1=uniq(src.map(d=>d.f1)), u2=uniq(src.map(d=>d.f2)), u3=uniq(src.map(d=>d.f3)); f1.innerHTML='<option value="">Filter 1</option>'+u1.map(x=>`<option>${x}</option>`).join(''); f2.innerHTML='<option value="">Filter 2</option>'+u2.map(x=>`<option>${x}</option>`).join(''); f3.innerHTML='<option value="">Filter 3</option>'+u3.map(x=>`<option>${x}</option>`).join(''); }
      function filtered(){ const s1=f1.value,s2=f2.value,s3=f3.value; return DB.tests.filter(t=>t.type!=='online').filter(d=>(!s1||d.f1===s1)&&(!s2||d.f2===s2)&&(!s3||d.f3===s3)); }
      function render(){ const arr=filtered().sort((a,b)=>b.ts-a.ts); const start=(page-1)*PAGE; const pageItems=arr.slice(start,start+PAGE); box.innerHTML = pageItems.length? pageItems.map(cardHTML).join('') : `<div class="card"><div class="body"><h3>Oddiy test topilmadi</h3></div></div>`; $('#'+coll+'_pageinfo').textContent=page+'-sahifa (oddiy)'; $('#'+coll+'_prev').disabled=(page<=1); $('#'+coll+'_next').disabled=(start+PAGE>=arr.length); }
      fillFilters(); render();
      f1.onchange=f2.onchange=f3.onchange=()=>{ page=1; render(); };
      $('#'+coll+'_prev').onclick=()=>{ if(page>1){ page--; render(); }};
      $('#'+coll+'_next').onclick=()=>{ page++; render(); };
      $('#'+coll+'_reset').onclick=()=>{ f1.value='';f2.value='';f3.value='';page=1;render(); };
    }

    // Forms: clear + save
    function clearBannerForm(){ $('#bn_title').value=''; $('#bn_img').value=''; $('#bn_f1').value=''; $('#bn_f2').value=''; $('#bn_f3').value=''; $('#bn_link').value=''; }
    function clearCardForm(){ $('#cd_title').value=''; $('#cd_img').value=''; $('#cd_f1').value=''; $('#cd_f2').value=''; $('#cd_f3').value=''; $('#cd_subject').value=''; $('#cd_level').value=''; $('#cd_type').value=''; $('#cd_duration').value=''; $('#cd_link').value=''; }
    function clearOnlineForm(){ $('#to_title').value=''; $('#to_img').value=''; $('#to_f1').value=''; $('#to_f2').value=''; $('#to_f3').value=''; $('#to_start').value=''; $('#to_end').value=''; $('#to_link').value=''; }

    $('#btnSaveBanner').addEventListener('click', ()=>{ if(!isAdmin()) return alert('Admin kerak'); const obj={ id:LS.uid(), title:$('#bn_title').value.trim(), img:$('#bn_img').value.trim(), f1:$('#bn_f1').value.trim(), f2:$('#bn_f2').value.trim(), f3:$('#bn_f3').value.trim(), link:$('#bn_link').value.trim(), ts:Date.now() }; DB.banners.push(obj); persist(); closeModal('bannerModal'); if(location.hash==="#home") renderHome(); alert('Banner saqlandi'); });

    $('#btnSaveCard').addEventListener('click', ()=>{ if(!isAdmin()) return alert('Admin kerak'); const collSel=$('#cd_coll').value; const obj={ id:LS.uid(), title:$('#cd_title').value.trim(), img:$('#cd_img').value.trim(), f1:$('#cd_f1').value.trim(), f2:$('#cd_f2').value.trim(), f3:$('#cd_f3').value.trim(), subject:$('#cd_subject').value.trim(), level:$('#cd_level').value.trim(), type: (collSel==='testsOddiy' ? 'oddiy' : $('#cd_type').value.trim()), duration:$('#cd_duration').value.trim(), link:$('#cd_link').value.trim(), ts:Date.now() };
      let targetArr, targetRoute;
      if(collSel==='courses'){ targetArr=DB.courses; targetRoute='courses'; }
      else if(collSel==='simulators'){ targetArr=DB.simulators; targetRoute='simulators'; }
      else { targetArr=DB.tests; targetRoute='tests'; obj.type='oddiy'; }
      targetArr.push(obj); persist(); closeModal('cardModal'); alert('Card saqlandi');
      loadRoute(targetRoute);
      if($('#adminModal') && $('#adminModal').classList.contains('open')){ renderAdminTab(targetRoute==='tests'?'tests':'cards'); }
    });

    $('#btnSaveOnlineTest').addEventListener('click', ()=>{ if(!isAdmin()) return alert('Admin kerak'); const start=$('#to_start').value? new Date($('#to_start').value).getTime(): null; const end=$('#to_end').value? new Date($('#to_end').value).getTime(): null; const obj={ id:LS.uid(), title:$('#to_title').value.trim(), img:$('#to_img').value.trim(), f1:$('#to_f1').value.trim(), f2:$('#to_f2').value.trim(), f3:$('#to_f3').value.trim(), type:'online', start, end, link:$('#to_link').value.trim(), ts:Date.now() }; DB.tests.push(obj); persist(); closeModal('onlineTestModal'); alert('Onlayn test saqlandi'); loadRoute('tests'); });

    // Admin Panel
    function adminPanel(){ if(!isAdmin()){ openModal('authModal'); return section('Admin', '<p>Admin kerak</p>'); }
      setTimeout(()=>{ openModal('adminModal'); renderAdminTab('users'); }, 0); // open modal instantly
      return section('Admin panel', `<p class="muted">Admin oynasi ochildi.</p>`);
    }
    function renderAdminTab(name){
      const body = $('#adminBody');
      $$('.adminTab').forEach(t=>t.classList.toggle('active', t.dataset.tab===name));
      if(name==='users') body.innerHTML = adminUsersHTML();
      if(name==='banners') body.innerHTML = adminBannersHTML();
      if(name==='cards') body.innerHTML = adminCardsHTML();
      if(name==='tests') body.innerHTML = adminTestsHTML();
      if(name==='filters') body.innerHTML = adminFiltersHTML();
      if(name==='promos') body.innerHTML = adminPromosHTML();
      if(name==='settings') body.innerHTML = adminSettingsHTML();
      // attach events per tab
      if(name==='users') bindAdminUsers();
      if(name==='banners') bindAdminBanners();
      if(name==='cards') bindAdminCards();
      if(name==='tests') bindAdminTests();
      if(name==='filters') bindAdminFilters();
      if(name==='promos') bindAdminPromos();
      if(name==='settings') bindAdminSettings();
    }
    $('#adminModal').addEventListener('click', (e)=>{ const t=e.target.closest('.adminTab'); if(t){ renderAdminTab(t.dataset.tab); }});

    // USERS
    function adminUsersHTML(){
      const rows = DB.users.map(u=>`<tr>
        <td>${u.numericId}</td><td>${u.ism} ${u.familiya||''}</td><td>${u.role||'oquvchi'}</td>
        <td>${u.tel||'—'}</td><td>${u.email||'—'}</td>
        <td>${u.balans||0}</td><td>${u.ball||0}</td>
        <td><button class="btn" data-edit-user="${u.id}">Tahrir</button> <button class="btn" data-del-user="${u.id}">O‘chirish</button></td>
      </tr>`).join('');
      return `<div class="row">
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <input id="usr_search" placeholder="qidirish (ism, id, tel)" style="flex:1;padding:10px 12px;border:1px solid var(--edge);border-radius:12px">
          <button class="btn" id="usr_new">+ Yangi foydalanuvchi</button>
        </div>
        <div class="card"><div class="body"><div style="overflow:auto"><table><thead><tr><th>ID</th><th>FIO</th><th>Rol</th><th>Tel</th><th>Email</th><th>Balans</th><th>Ball</th><th>Amal</th></tr></thead><tbody id="usr_tbody">${rows}</tbody></table></div></div></div>
      </div>`;
    }
    function bindAdminUsers(){
      $('#usr_new').onclick=()=>{ const id=genNumericId(); const u={ id:LS.uid(), numericId:id, ism:'', familiya:'', tel:'', email:'', pass:'123456', role:'oquvchi', balans:0, ball:0, createdAt:Date.now() }; DB.users.push(u); persist(); renderAdminTab('users'); };
      $('#usr_tbody').addEventListener('click',(e)=>{
        const ed=e.target.closest('[data-edit-user]'); const del=e.target.closest('[data-del-user]');
        if(ed){ const uid=ed.dataset.editUser; const u=DB.users.find(x=>x.id===uid); if(!u) return; const vals=promptEdit(`Foydalanuvchini tahrirlash (format: ism,familiya,rol,balans,ball,parol)`, `${u.ism||''},${u.familiya||''},${u.role||'oquvchi'},${u.balans||0},${u.ball||0},${u.pass||''}`); if(!vals) return; const [ism,fam,rol,bal,ball,pass]=vals.split(','); u.ism=ism?.trim()||u.ism; u.familiya=fam?.trim()||u.familiya; u.role=(rol||u.role); u.balans=Number(bal)||u.balans; u.ball=Number(ball)||u.ball; u.pass=pass||u.pass; persist(); renderAdminTab('users'); }
        if(del){ const uid=del.dataset.delUser; if(confirm('O‘chirasizmi?')){ DB.users=DB.users.filter(x=>x.id!==uid); if(DB.current?.id===uid) DB.current=null; persist(); renderAdminTab('users'); setHeader(); }}
      });
      $('#usr_search').oninput=(e)=>{ const q=e.target.value.toLowerCase(); const tbody=$('#usr_tbody'); const rows = DB.users.filter(u=>String(u.numericId).includes(q)|| (u.ism+" "+(u.familiya||'')).toLowerCase().includes(q) || (u.tel||'').includes(q)).map(u=>`<tr>
        <td>${u.numericId}</td><td>${u.ism} ${u.familiya||''}</td><td>${u.role||'oquvchi'}</td>
        <td>${u.tel||'—'}</td><td>${u.email||'—'}</td>
        <td>${u.balans||0}</td><td>${u.ball||0}</td>
        <td><button class="btn" data-edit-user="${u.id}">Tahrir</button> <button class="btn" data-del-user="${u.id}">O‘chirish</button></td>
      </tr>`).join(''); tbody.innerHTML=rows; };
    }

    // BANNERS
    function adminBannersHTML(){
      return `<div class="row">
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <button class="btn btn--pri" id="bn_new">+ Banner</button>
        </div>
        <div class="grid">${DB.banners.sort((a,b)=>b.ts-a.ts).map(b=>htmlCard(`<b>${b.title}</b><div class=\"muted\">${b.f1||''} ${b.f2||''} ${b.f3||''}</div><div style=\"margin-top:6px\"><button class=\"btn\" data-edit-bn=\"${b.id}\">Tahrir</button> <button class=\"btn\" data-del-bn=\"${b.id}\">O‘chirish</button></div>`)).join('')}</div>
      </div>`;
    }
    function bindAdminBanners(){
      $('#bn_new').onclick=()=>{ clearBannerForm(); openModal('bannerModal'); };
      $('#adminBody').addEventListener('click',(e)=>{
        const ed=e.target.closest('[data-edit-bn]'); const del=e.target.closest('[data-del-bn]');
        if(ed){ const id=ed.dataset.editBn; const b=DB.banners.find(x=>x.id===id); if(!b) return; $('#bn_title').value=b.title; $('#bn_img').value=b.img; $('#bn_f1').value=b.f1||''; $('#bn_f2').value=b.f2||''; $('#bn_f3').value=b.f3||''; $('#bn_link').value=b.link||''; openModal('bannerModal'); $('#btnSaveBanner').onclick=()=>{ b.title=$('#bn_title').value.trim(); b.img=$('#bn_img').value.trim(); b.f1=$('#bn_f1').value.trim(); b.f2=$('#bn_f2').value.trim(); b.f3=$('#bn_f3').value.trim(); b.link=$('#bn_link').value.trim(); b.ts=Date.now(); persist(); closeModal('bannerModal'); renderAdminTab('banners'); if(location.hash==='#home') renderHome(); }; }
        if(del){ const id=del.dataset.delBn; if(confirm('O‘chirasizmi?')){ DB.banners=DB.banners.filter(x=>x.id!==id); persist(); renderAdminTab('banners'); if(location.hash==='#home') renderHome(); }}
      });
    }

    // CARDS (courses & simulators)
    function adminCardsHTML(){
      function rows(list, label){ return `<div class="content" style="margin-bottom:10px"><h3 style="margin:0 0 8px">${label}</h3><div class="grid">${list.sort((a,b)=>b.ts-a.ts).map(c=>htmlCard(`<b>${c.title}</b><div class=\"muted\">${c.f1||''} ${c.f2||''} ${c.f3||''}</div><div style=\"margin-top:6px\"><button class=\"btn\" data-edit-card=\"${c.id}\" data-coll=\"${label}\">Tahrir</button> <button class=\"btn\" data-del-card=\"${c.id}\" data-coll=\"${label}\">O‘chirish</button></div>`)).join('')}</div></div>`; }
      return `<div class="row">
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <button class="btn btn--pri" id="cd_new_courses">+ Kurs card</button>
          <button class="btn btn--pri" id="cd_new_sim">+ Simulyator card</button>
        </div>
        ${rows(DB.courses,'courses')}
        ${rows(DB.simulators,'simulators')}
      </div>`;
    }
    function bindAdminCards(){
      $('#cd_new_courses').onclick=()=>{ clearCardForm(); $('#cd_coll').value='courses'; openModal('cardModal'); };
      $('#cd_new_sim').onclick=()=>{ clearCardForm(); $('#cd_coll').value='simulators'; openModal('cardModal'); };
      $('#adminBody').addEventListener('click',(e)=>{
        const ed=e.target.closest('[data-edit-card]'); const del=e.target.closest('[data-del-card]');
        if(ed){ const id=ed.dataset.editCard; const coll=ed.dataset.coll; const arr=coll==='courses'?DB.courses:DB.simulators; const c=arr.find(x=>x.id===id); if(!c) return; $('#cd_coll').value=coll; $('#cd_title').value=c.title; $('#cd_img').value=c.img; $('#cd_f1').value=c.f1||''; $('#cd_f2').value=c.f2||''; $('#cd_f3').value=c.f3||''; $('#cd_subject').value=c.subject||''; $('#cd_level').value=c.level||''; $('#cd_type').value=c.type||''; $('#cd_duration').value=c.duration||''; $('#cd_link').value=c.link||''; openModal('cardModal'); $('#btnSaveCard').onclick=()=>{ c.title=$('#cd_title').value.trim(); c.img=$('#cd_img').value.trim(); c.f1=$('#cd_f1').value.trim(); c.f2=$('#cd_f2').value.trim(); c.f3=$('#cd_f3').value.trim(); c.subject=$('#cd_subject').value.trim(); c.level=$('#cd_level').value.trim(); c.type=$('#cd_type').value.trim(); c.duration=$('#cd_duration').value.trim(); c.link=$('#cd_link').value.trim(); c.ts=Date.now(); persist(); closeModal('cardModal'); renderAdminTab('cards'); loadRoute(location.hash.replace('#','')||'home'); } }
        if(del){ const id=del.dataset.delCard; const coll=del.dataset.coll; const arr=coll==='courses'?DB.courses:DB.simulators; if(confirm('O‘chirasizmi?')){ const i=arr.findIndex(x=>x.id===id); if(i>-1) arr.splice(i,1); persist(); renderAdminTab('cards'); loadRoute(location.hash.replace('#','')||'home'); } }
      });
    }

    // TESTS
    function adminTestsHTML(){
      function rows(list, label){ return `<div class="content" style="margin-bottom:10px"><h3 style="margin:0 0 8px">${label}</h3><div class="grid">${list.sort((a,b)=>b.ts-a.ts).map(c=>htmlCard(`<b>${c.title}</b><div class=\"muted\">${c.f1||''} ${c.f2||''} ${c.f3||''} ${c.type==='online'?'(ONLINE)':''}</div><div style=\"margin-top:6px\"><button class=\"btn\" data-edit-test=\"${c.id}\">Tahrir</button> <button class=\"btn\" data-del-test=\"${c.id}\">O‘chirish</button></div>`)).join('')}</div></div>`; }
      return `<div class="row">
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <button class="btn btn--pri" id="ts_new_oddiy">+ Oddiy test</button>
          <button class="btn btn--pri" id="ts_new_online">+ Onlayn test</button>
        </div>
        ${rows(DB.tests.filter(t=>t.type!=='online'),'Oddiy testlar')}
        ${rows(DB.tests.filter(t=>t.type==='online'),'Onlayn testlar')}
      </div>`;
    }
    function bindAdminTests(){
      $('#ts_new_oddiy').onclick=()=>{ clearCardForm(); $('#cd_coll').value='testsOddiy'; openModal('cardModal'); };
      $('#ts_new_online').onclick=()=>{ clearOnlineForm(); openModal('onlineTestModal'); };
      $('#adminBody').addEventListener('click',(e)=>{
        const ed=e.target.closest('[data-edit-test]'); const del=e.target.closest('[data-del-test]');
        if(ed){ const id=ed.dataset.editTest; const t=DB.tests.find(x=>x.id===id); if(!t) return; if(t.type==='online'){ $('#to_title').value=t.title; $('#to_img').value=t.img||''; $('#to_f1').value=t.f1||''; $('#to_f2').value=t.f2||''; $('#to_f3').value=t.f3||''; $('#to_start').value=t.start? new Date(t.start).toISOString().slice(0,16):''; $('#to_end').value=t.end? new Date(t.end).toISOString().slice(0,16):''; $('#to_link').value=t.link||''; openModal('onlineTestModal'); $('#btnSaveOnlineTest').onclick=()=>{ t.title=$('#to_title').value.trim(); t.img=$('#to_img').value.trim(); t.f1=$('#to_f1').value.trim(); t.f2=$('#to_f2').value.trim(); t.f3=$('#to_f3').value.trim(); t.start=$('#to_start').value?new Date($('#to_start').value).getTime():null; t.end=$('#to_end').value?new Date($('#to_end').value).getTime():null; t.link=$('#to_link').value.trim(); t.ts=Date.now(); persist(); closeModal('onlineTestModal'); renderAdminTab('tests'); loadRoute('tests'); }; }
        else { $('#cd_coll').value='testsOddiy'; $('#cd_title').value=t.title; $('#cd_img').value=t.img||''; $('#cd_f1').value=t.f1||''; $('#cd_f2').value=t.f2||''; $('#cd_f3').value=t.f3||''; $('#cd_subject').value=t.subject||''; $('#cd_level').value=t.level||''; $('#cd_type').value='oddiy'; $('#cd_duration').value=t.duration||''; $('#cd_link').value=t.link||''; openModal('cardModal'); $('#btnSaveCard').onclick=()=>{ t.title=$('#cd_title').value.trim(); t.img=$('#cd_img').value.trim(); t.f1=$('#cd_f1').value.trim(); t.f2=$('#cd_f2').value.trim(); t.f3=$('#cd_f3').value.trim(); t.subject=$('#cd_subject').value.trim(); t.level=$('#cd_level').value.trim(); t.type='oddiy'; t.duration=$('#cd_duration').value.trim(); t.link=$('#cd_link').value.trim(); t.ts=Date.now(); persist(); closeModal('cardModal'); renderAdminTab('tests'); loadRoute('tests'); }; }
        }
        if(del){ const id=del.dataset.delTest; if(confirm('O‘chirasizmi?')){ DB.tests=DB.tests.filter(x=>x.id!==id); persist(); renderAdminTab('tests'); loadRoute('tests'); }}
      });
    }

    // FILTERS
    function adminFiltersHTML(){
      const stat = (arr)=>{ const m=new Map(); arr.forEach(x=>{[x.f1,x.f2,x.f3].forEach(f=>{ if(!f) return; m.set(f,(m.get(f)||0)+1); });}); return Array.from(m.entries()).sort((a,b)=>b[1]-a[1]); };
      const all = [...DB.courses, ...DB.simulators, ...DB.tests];
      const rows = stat(all).map(([k,v])=>`<tr><td>${k}</td><td>${v}</td><td><button class="btn" data-merge="${k}">Birlashtir</button> <button class="btn" data-rename="${k}">Nomini o‘zgartir</button> <button class="btn" data-del="${k}">O‘chirish</button></td></tr>`).join('');
      return `<div class="row">
        <div class="card"><div class="body"><div style="overflow:auto"><table><thead><tr><th>Filter</th><th>Soni</th><th>Amal</th></tr></thead><tbody id="flt_body">${rows||'<tr><td colspan=3>Filter topilmadi</td></tr>'}</tbody></table></div></div></div>
      </div>`;
    }
    function bindAdminFilters(){
      $('#flt_body').addEventListener('click',(e)=>{
        const m=e.target.closest('[data-merge]'); const r=e.target.closest('[data-rename]'); const d=e.target.closest('[data-del]');
        const apply=(fn)=>{ ['courses','simulators','tests'].forEach(coll=>{ DB[coll].forEach(fn); }); persist(); renderAdminTab('filters'); loadRoute(location.hash.replace('#','')||'home'); };
        if(m){ const from=m.dataset.merge; const to=prompt('Qaysiga birlashtirish (target)?', from); if(!to) return; apply(item=>{ ['f1','f2','f3'].forEach(k=>{ if(item[k]===from) item[k]=to; });}); }
        if(r){ const from=r.dataset.rename; const to=prompt('Yangi nom?', from); if(!to) return; apply(item=>{ ['f1','f2','f3'].forEach(k=>{ if(item[k]===from) item[k]=to; });}); }
        if(d){ const name=d.dataset.del; if(!confirm('Haqiqatan o‘chirasizmi?')) return; apply(item=>{ ['f1','f2','f3'].forEach(k=>{ if(item[k]===name) item[k]=''; });}); }
      });
    }

    // PROMOS
    function adminPromosHTML(){
      const rows = DB.promos.sort((a,b)=> (b.expiresAt||0)-(a.expiresAt||0)).map(p=>`<tr><td>${p.code}</td><td>${p.off||0}%</td><td>${p.bonus||0}</td><td>${p.limit||'—'}</td><td>${p.used||0}</td><td>${p.expiresAt? new Date(p.expiresAt).toLocaleDateString():'—'}</td><td><button class="btn" data-edit-p="${p.code}">Tahrir</button> <button class="btn" data-del-p="${p.code}">O‘chirish</button></td></tr>`).join('');
      return `<div class="row">
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <button class="btn btn--pri" id="pr_new">+ Promo</button>
        </div>
        <div class="card"><div class="body"><div style="overflow:auto"><table><thead><tr><th>Kod</th><th>Off</th><th>Bonus</th><th>Limit</th><th>Ishlatildi</th><th>Tugash</th><th>Amal</th></tr></thead><tbody id="promo_tbody">${rows||'<tr><td colspan=7>Promo yo‘q</td></tr>'}</tbody></table></div></div></div>
      </div>`;
    }
    function bindAdminPromos(){
      $('#pr_new').onclick=()=>{ const code=(prompt('Kod?','WELCOME')||'WELCOME').toUpperCase(); const off=Number(prompt('Chegirma %','10')||'0'); const bonus=Number(prompt('Bonus (so‘m)','5000')||'0'); const limit=Number(prompt('Limit (yoki bo‘sh qoldiring)','')||'')||null; const days=Number(prompt('Necha kunda tugaydi?','30')||'0'); const expiresAt = days>0? Date.now()+days*86400000 : null; DB.promos.push({code, off, bonus, limit, used:0, expiresAt}); persist(); renderAdminTab('promos'); };
      $('#promo_tbody').addEventListener('click',(e)=>{
        const ed=e.target.closest('[data-edit-p]'); const del=e.target.closest('[data-del-p]');
        if(ed){ const code=ed.dataset.editP; const p=findPromo(code); if(!p) return; const off=Number(prompt('Chegirma %', p.off||0)||p.off||0); const bonus=Number(prompt('Bonus', p.bonus||0)||p.bonus||0); const limit=Number(prompt('Limit', p.limit||'')||p.limit||0)||null; const days=Number(prompt('Necha kunda tugaydi?', p.expiresAt? Math.ceil((p.expiresAt-Date.now())/86400000):0)||0); p.off=off; p.bonus=bonus; p.limit=limit; p.expiresAt = days>0? Date.now()+days*86400000 : null; persist(); renderAdminTab('promos'); }
        if(del){ const code=del.dataset.delP; if(confirm('O‘chirasizmi?')){ DB.promos=DB.promos.filter(x=>x.code!==code); persist(); renderAdminTab('promos'); }}
      });
    }

    // SETTINGS
    function adminSettingsHTML(){
      return `<div class="row">
        <div class="card"><div class="body">
          <div class="muted">Sayt sozlamalari (lokal demo):</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <button class="btn" id="set_reset">♻️ Barcha ma’lumotlarni tozalash</button>
            <button class="btn" id="set_seed">🌱 Demo ma’lumot qo‘shish</button>
            <button class="btn" id="set_export">⬇️ JSON eksport</button>
            <button class="btn" id="set_import">⬆️ JSON import</button>
          </div>
          <p class="muted" style="margin-top:8px">Eslatma: hozirgi versiya LocalStorage’da ishlaydi. Keyin Firestore yoki serverga ulash juda oson — saqlash funksiyalarini API chaqirig‘i bilan almashtiring.</p>
        </div></div>
      </div>`;
    }
    function bindAdminSettings(){
      $('#set_reset').onclick=()=>{ if(!confirm('Barchasini tozalaysizmi?')) return; localStorage.clear(); location.reload(); };
      $('#set_seed').onclick=()=>{ seedDemo(); renderAdminTab('settings'); loadRoute('home'); };
      $('#set_export').onclick=()=>{ const dump=JSON.stringify(DB,null,2); const blob=new Blob([dump],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='mathcenter-export.json'; a.click(); URL.revokeObjectURL(url); };
      $('#set_import').onclick=()=>{ const input=document.createElement('input'); input.type='file'; input.accept='application/json'; input.onchange=()=>{ const f=input.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ const data=JSON.parse(fr.result); Object.assign(DB, data); persist(); alert('Import qilindi'); location.reload(); }catch{ alert('JSON xato'); } }; fr.readAsText(f); }; input.click(); };
    }

    function seedDemo(){
      // Some demo content
      DB.banners.push({id:LS.uid(), title:'Yangi Algebra kursi', img:'https://picsum.photos/seed/alg/800/450', f1:'10-sinf', f2:'1-chorak', f3:'Algebra', link:'#courses', ts:Date.now()});
      DB.courses.push({id:LS.uid(), title:'Algebra 10-sinf', img:'https://picsum.photos/seed/a10/800/450', f1:'10-sinf', f2:'Algebra', f3:'Qo‘shish', subject:'Matematika', level:'O‘rta', type:'video', duration:'45 daqiqa', link:'#', ts:Date.now()});
      DB.simulators.push({id:LS.uid(), title:'Tezkor misollar', img:'https://picsum.photos/seed/sim/800/450', f1:'Trening', f2:'Qiziqarli', f3:'', subject:'Matematika', level:'Boshlang‘ich', type:'lab', duration:'—', link:'#', ts:Date.now()});
      DB.tests.push({id:LS.uid(), title:'Nazorat 1', img:'https://picsum.photos/seed/t1/800/450', f1:'10-sinf', f2:'1-chorak', f3:'Algebra', subject:'Matematika', level:'Oson', type:'oddiy', duration:'25 daqiqa', link:'#', ts:Date.now()});
      DB.tests.push({id:LS.uid(), title:'Onlayn Olimpiada', img:'https://picsum.photos/seed/olimp/800/450', f1:'Barchaga', f2:'Online', f3:'', type:'online', start:Date.now()-3600e3, end:Date.now()+3600e3*6, link:'#', ts:Date.now()});
      DB.promos.push({code:'WELCOME', off:10, bonus:5000, limit:100, used:0, expiresAt:Date.now()+86400000*30});
      persist();
    }

    // INIT
    function setActive(route){ $$('#fabMenu .chip').forEach(b=>b.classList.toggle('active', b.dataset.route===route)); }
    function boot(){ setHeader(); const start=location.hash.replace('#','')||'home'; loadRoute(start); }
    boot();
  </script>
</body>
</html>
