<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>X+Y ‚Äî MathCenter SPA</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand:#12b67c; --brand-2:#1dd492; --brand-3:#0aa267;
      --text:#0b1b14; --muted:#6c7a73; --card:#fff; --line:#e6f4ed;
      --bg-1:#f7fffb; --bg-2:#eafff5; --glass:rgba(255,255,255,.7);
      --radius:22px; --r12:14px; --r10:12px; --r8:10px;
      --shadow-lg:0 24px 60px rgba(18,182,124,.18);
      --shadow-md:0 14px 30px rgba(18,182,124,.18);
      --shadow-sm:0 8px 16px rgba(18,182,124,.15);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system; color:var(--text);
      background:
        radial-gradient(800px 400px at -10% -10%, #ebfff6 0%, rgba(235,255,246,0) 60%),
        radial-gradient(1200px 600px at 110% -20%, #e6fff2 0%, rgba(230,255,242,0) 60%),
        linear-gradient(160deg, #ffffff 0%, #f7fffb 50%, #ebfff6 100%);
    }
    a{color:inherit; text-decoration:none}

    /* ====== Animations ====== */
    @keyframes fadeUp { from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none} }
    @keyframes slideIn { from{transform:translateX(-100%)} to{transform:translateX(0)} }

    /* ====== Topbar ====== */
    .topbar{
      position:sticky; top:0; z-index:50;
      display:grid; grid-template-columns:auto 1fr auto; gap:12px; align-items:center; padding:12px clamp(10px,2vw,18px);
      border-bottom:1px solid var(--line);
      backdrop-filter:blur(10px);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.75));
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:0}
    .pi{width:44px;height:44px;border-radius:16px;display:grid;place-items:center;color:#fff;font-weight:900;font-size:20px;
        background:conic-gradient(from 220deg, var(--brand), var(--brand-2), var(--brand));
        box-shadow: inset 0 -10px 16px rgba(0,0,0,.06), var(--shadow-sm)}
    .title{font-weight:900; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .nav-btn{border:none;background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;padding:10px 14px;border-radius:14px;cursor:pointer;font-weight:900;box-shadow:var(--shadow-sm)}
    .nav-btn:active{transform:translateY(1px)}

    /* ====== User badge ====== */
    .user-badge{display:grid; grid-template-columns:auto auto; gap:12px; align-items:center; animation:fadeUp .35s ease both}
    .hello{display:flex; flex-direction:column; line-height:1.05; min-width:0}
    .hello .hi{font-weight:900; letter-spacing:.2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .hello .sub{font-size:12px; color:var(--muted)}

    .kpi{display:flex; gap:10px; flex-wrap:nowrap; overflow:auto; scrollbar-width:none}
    .kpi::-webkit-scrollbar{display:none}
    .chip{position:relative; padding:10px 12px; border-radius:16px; background:linear-gradient(180deg,#ffffff,#f6fffb); display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:10px; border:1px solid var(--line); box-shadow: 0 10px 20px rgba(0,0,0,.04), 0 16px 34px rgba(18,182,124,.16), inset 0 -10px 14px rgba(0,0,0,.03);} .chip::before{content:""; position:absolute; inset:-1px; border-radius:inherit; pointer-events:none; background:linear-gradient(180deg, rgba(18,182,124,.25), rgba(18,182,124,0)); opacity:.6; mix-blend:soft-light} .chip small{font-weight:800; color:var(--muted); text-transform:uppercase; letter-spacing:.3px; font-size:11px; line-height:1} .chip b{font-weight:900; font-size:16px; line-height:1} .chip .meta{display:flex; align-items:center; gap:6px} .chip .ic{width:16px; height:16px; display:inline-grid; place-items:center} .chip .val{font-variant-numeric:tabular-nums; letter-spacing:.2px}
    .chip::before{content:""; position:absolute; inset:-1px; border-radius:inherit; pointer-events:none;
      background:linear-gradient(180deg, rgba(18,182,124,.25), rgba(18,182,124,0)); opacity:.6; mix-blend:soft-light}
    .chip small{font-weight:800; color:var(--muted); text-transform:uppercase; letter-spacing:.3px; font-size:11px}
    .chip b{font-weight:900; font-size:15px}

    /* ====== Drawer ====== */
    .drawer-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.25); display:none; z-index:55}
    .drawer{position:fixed; inset:0 auto 0 0; width:320px; background:var(--card); border-right:1px solid var(--line);
            transform:translateX(-100%); transition:transform .25s ease; z-index:60; display:flex; flex-direction:column;
            box-shadow:var(--shadow-lg)}
    .drawer.open{transform:translateX(0)}
    .drawer header{padding:18px; font-weight:900; background:linear-gradient(135deg,#f1fff8,#fff); border-bottom:1px solid var(--line)}
    .nav{display:flex; flex-direction:column; gap:6px; padding:12px}
    .nav a{padding:12px 14px; border-radius:14px; font-weight:700}
    .nav a:hover{background:#f0fff7}
    .nav a.active{background:linear-gradient(135deg,#eafff4,#f7fffb); outline:1px solid #e8f6ef}

    /* ====== App ====== */
    #app{padding: clamp(12px,2.2vw,20px); max-width:1120px; margin:0 auto}
    .card{background:var(--card); border-radius: var(--radius); padding:18px; border:1px solid var(--line); box-shadow:var(--shadow-md); animation:fadeUp .35s ease both}

    /* ====== Modals ====== */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:80}
    .modal{width:min(560px, 94vw); background:#fff; border-radius:22px; box-shadow:0 30px 60px rgba(0,0,0,.25); overflow:hidden}
    .modal header{padding:16px 18px; font-weight:900; background:linear-gradient(135deg,#ebfff6,#fff)}
    .modal .body{padding:18px; display:grid; gap:12px}
    .row{display:grid; gap:8px}
    .row.inline{grid-template-columns:1fr 1fr; gap:12px}
    label{font-size:13px; color:#406055; font-weight:800}
    input, select{width:100%; padding:12px 12px; border-radius:12px; border:1px solid #d9efe4; outline:none; background:#fbfffd}
    input:focus, select:focus{border-color:#bdebd8; box-shadow:0 0 0 3px #e6fff4}
    .btn{padding:12px 14px; border-radius:12px; border:none; font-weight:900; cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#fff; box-shadow:var(--shadow-sm)}
    .btn.ghost{background:#f1fff8}
    .actions{display:flex; justify-content:flex-end; gap:10px; padding-top:6px}

    /* ====== Mobile tweaks ====== */
    @media (max-width:740px){ .topbar{grid-template-columns:1fr; row-gap:10px; padding:8px 10px; background:#fff} .title{font-size:12px} .user-badge{grid-template-columns:1fr; gap:8px} .hello .hi{font-size:12px} .hello .sub{font-size:11px} .kpi{flex-direction:column; gap:8px} .chip{width:100%; padding:8px 10px} .chip small{font-size:10px; letter-spacing:.2px} .chip b{font-size:14px} } @media (max-width:480px){ .pi{width:38px;height:38px;border-radius:14px} .nav-btn{padding:8px 12px; border-radius:12px} .title{font-size:11px} }
  .title{font-size:13px}
  /* Badge pastga tushadi, hamma narsa tagma-tag aniq ko'rinadi */
  .user-badge{grid-template-columns:1fr; gap:8px}
  .hello .hi{font-size:13px}
  .hello .sub{font-size:11px}
  .kpi{flex-direction:column; gap:8px}
  .chip{width:100%; padding:8px 10px}
  .chip small{font-size:10px; letter-spacing:.2px}
  .chip b{font-size:13px; font-variant-numeric:tabular-nums; letter-spacing:.2px}
}

/* Yanada ixcham ekranlar (<=480px) uchun, chiplar vizual ajralib tursin */
@media (max-width:480px){
  .pi{width:40px;height:40px;border-radius:14px}
  .nav-btn{padding:8px 12px; border-radius:12px}
  .title{font-size:12px}
}
      .title{font-size:14px}
      .user-badge{grid-template-columns:1fr}
      .chip b{font-size:14px}
    }
  </style>
</head>
<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="brand">
      <button id="btnOpen" class="nav-btn" aria-label="Menyuni ochish">‚â°</button>
      <div class="pi" aria-hidden="true">œÄ</div>
      <div class="title">X+Y ‚Äî MathCenter</div>
    </div>
    <div></div>
    <div class="user-badge" id="userBadge" hidden>
      <div class="hello">
        <div class="hi">Salom, <span id="helloName">Mehmon</span> <span id="helloAge"></span></div>
        <div class="sub">Xush kelibsiz!</div>
      </div>
      <div class="kpi">
        <div class="chip"><div class="meta"><span class="ic" aria-hidden="true"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="18" height="14" rx="2"/><line x1="7" y1="9" x2="13" y2="9"/><line x1="7" y1="13" x2="11" y2="13"/></svg></span><small>ID</small></div><b class="val" id="chipId">‚Äî</b></div>
        <div class="chip"><div class="meta"><span class="ic" aria-hidden="true"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a3 3 0 0 0-3-3H6a3 3 0 0 0-3 3v2"/><circle cx="16" cy="14" r="2"/></svg></span><small>Balans</small></div><b class="val" id="chipBalance">0</b></div>
        <div class="chip"><div class="meta"><span class="ic" aria-hidden="true"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 21h8"/><path d="M12 17v4"/><circle cx="12" cy="8" r="5"/></svg></span><small>Ball</small></div><b class="val" id="chipScore">0</b></div>
      </div>
    </div>
  </div>

  <!-- Drawer + backdrop -->
  <div id="drawerBackdrop" class="drawer-backdrop" hidden></div>
  <aside id="drawer" class="drawer" aria-hidden="true">
    <header>Menyu</header>
    <nav class="nav">
      <a href="#home" data-route="home" class="active">üè† Bosh sahifa</a>
      <a href="#tests" data-route="tests">üß™ Testlar</a>
      <a href="#live" data-route="live">üì° Live</a>
      <a href="#sim" data-route="sim">üß© Simulator</a>
      <a href="#leader" data-route="leader">üèÜ Reyting</a>
      <a href="#profile" data-route="profile">üë§ Profil</a>
      <a href="#settings" data-route="settings">‚öôÔ∏è Sozlamalar</a>
      <a href="#admin" data-route="admin">üõ°Ô∏è Admin</a>
      <a href="#logout" id="btnLogout">‚Ü©Ô∏è Chiqish</a>
    </nav>
  </aside>

  <!-- App container -->
  <main id="app"><div class="card">Yuklanmoqda‚Ä¶</div></main>

  <!-- Login Modal (ID + Parol) -->
  <div id="loginBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <header>ID orqali kirish</header>
      <div class="body">
        <div class="row inline">
          <div>
            <label for="loginId">ID (1001‚Ä¶)</label>
            <input id="loginId" type="number" inputmode="numeric" placeholder="Masalan, 1001" />
          </div>
          <div>
            <label for="loginPass">Parol</label>
            <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          </div>
        </div>
        <div class="actions">
          <button class="btn ghost" id="openRegister">Ro'yxatdan o'tish</button>
          <button class="btn primary" id="doLogin">Kirish</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Register Modal (email + Google + Phone) -->
  <div id="regBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <header>Ro'yxatdan o'tish</header>
      <div class="body">
        <div class="row">
          <label for="regEmail">Email</label>
          <input id="regEmail" type="email" placeholder="email@example.com" />
        </div>
        <div class="row inline">
          <div>
            <label for="regPass">Parol</label>
            <input id="regPass" type="password" placeholder="Kamida 6 belgidan" />
          </div>
          <div>
            <label for="regPass2">Parol (takror)</label>
            <input id="regPass2" type="password" placeholder="Parolni takrorlang" />
          </div>
        </div>
        <div class="row">
          <button class="btn ghost" id="regWithGoogle">Google bilan</button>
          <button class="btn ghost" id="regWithPhone">Telefon raqam bilan</button>
        </div>
        <div class="actions">
          <button class="btn" id="cancelReg">Bekor qilish</button>
          <button class="btn primary" id="createEmailUser">Ro'yxatdan o'tish</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Modal (majburiy) -->
  <div id="profileBackdrop" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <header>Profil ma'lumotlari (majburiy)</header>
      <div class="body">
        <div class="row inline">
          <div>
            <label for="pLast">Familiya</label>
            <input id="pLast" type="text" placeholder="Familiya"/>
          </div>
          <div>
            <label for="pFirst">Ism</label>
            <input id="pFirst" type="text" placeholder="Ism"/>
          </div>
        </div>
        <div class="row inline">
          <div>
            <label for="pMiddle">Sharif</label>
            <input id="pMiddle" type="text" placeholder="Sharif"/>
          </div>
          <div>
            <label for="pBirth">Tug'ilgan sana</label>
            <input id="pBirth" type="date"/>
          </div>
        </div>
        <div class="row inline">
          <div>
            <label for="pPhone">Telefon</label>
            <input id="pPhone" type="tel" placeholder="+998 xx xxx xx xx"/>
          </div>
          <div>
            <label for="pTelegram">Telegram link</label>
            <input id="pTelegram" type="url" placeholder="https://t.me/username"/>
          </div>
        </div>
        <div class="row inline">
          <div>
            <label for="pEmail">Email</label>
            <input id="pEmail" type="email" placeholder="email@example.com"/>
          </div>
          <div>
            <label for="pRole">Roli</label>
            <select id="pRole">
              <option value="oquvchi">O'quvchi</option>
              <option value="oqituvchi">O'qituvchi</option>
            </select>
          </div>
        </div>
        <div class="row">
          <label for="pRegion">Viloyat</label>
          <select id="pRegion"></select>
        </div>
        <div class="row">
          <label for="pDistrict">Tuman/Shahar</label>
          <select id="pDistrict"></select>
        </div>
        <div class="row">
          <label for="pSchool">Maktab</label>
          <input id="pSchool" type="text" placeholder="Masalan, 23-maktab"/>
        </div>
        <div class="actions">
          <button class="btn" id="cancelProfile">Chiqish</button>
          <button class="btn primary" id="saveProfile">Saqlash</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK + App JS -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, query, where, getDocs, collection, runTransaction } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.appspot.com",
      messagingSenderId: "992512966017",
      appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId: "G-459PLJ7P7L"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Backdrop helper
    const backdrop = document.getElementById('drawerBackdrop');
    function showBackdrop(){ backdrop.hidden=false; backdrop.style.display='block'; }
    function hideBackdrop(){ backdrop.style.display='none'; backdrop.hidden=true; }

    // Drawer logic
    const drawer = document.getElementById('drawer');
    const btnOpen = document.getElementById('btnOpen');
    function openDrawer(){ drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); showBackdrop(); }
    function closeDrawer(){ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); hideBackdrop(); }
    btnOpen.addEventListener('click', ()=> drawer.classList.contains('open') ? closeDrawer() : openDrawer());
    backdrop.addEventListener('click', closeDrawer);
    drawer.addEventListener('click', (e)=>{ if(e.target.matches('a[data-route]')) closeDrawer(); });

    // Regions & districts
    const REGIONS = {
      "Qoraqalpog'iston Respublikasi": ["Amudaryo","Beruniy","Chimboy","Ellikqal'a","Kegeyli","Mo'ynoq","Nukus sh.","Nukus t.","Qo'ng'irot","Qorao'zak","Shumanay","Taxtako'pir","To'rtko'l","Xo'jayli"],
      "Andijon": ["Andijon sh.","Andijon t.","Asaka","Baliqchi","Bo'z","Buloqboshi","Izboskan","Jalaquduq","Qo'rg'ontepa","Marhamat","Oltinko'l","Paxtaobod","Shahrixon","Xo'jaobod","Ulug'nor"],
      "Buxoro": ["Buxoro sh.","Buxoro t.","G'ijduvon","Jondor","Kogon sh.","Kogon t.","Qorako'l","Qorovulbozor","Peshku","Romitan","Shofirkon","Vobkent"],
      "Farg'ona": ["Farg'ona sh.","Farg'ona t.","Beshariq","Bog'dod","Buvayda","Dang'ara","Furqat","Oltiariq","Qo'shtepa","Quva","Quvasoy","Rishton","Shohimardon","So'x","Toshloq","Uchko'prik","Yozyovon"],
      "Jizzax": ["Jizzax sh.","Arnasoy","Baxmal","Do'stlik","Forish","G'allaorol","Mirzacho'l","Paxtakor","Yangiobod","Zafarobod","Zarbdor","Zomin"],
      "Qashqadaryo": ["Qarshi sh.","Qarshi t.","Chiroqchi","Dehqonobod","G'uzor","Kasbi","Kitob","Koson","Mirishkor","Muborak","Nishon","Shahrisabz","Yakkabog'"],
      "Namangan": ["Namangan sh.","Namangan t.","Chortoq","Chust","Mingbuloq","Norin","Pop","To'raqo'rg'on","Uchqo'rg'on","Uychi","Yangiqo'rg'on"],
      "Navoiy": ["Navoiy sh.","Konimex","Karmana","Qiziltepa","Navbahor","Nurota","Tomdi","Uchquduq","Zarafshon"],
      "Samarqand": ["Samarqand sh.","Bulung'ur","Ishtixon","Jomboy","Kattaqo'rg'on sh.","Kattaqo'rg'on t.","Narpay","Nurobod","Oqdaryo","Paxtachi","Payariq","Pastdarg'om","Samarkand t.","Toyloq","Urgut"],
      "Surxondaryo": ["Termiz sh.","Angor","Bandixon","Boysun","Denov","Jarqo'rg'on","Qiziriq","Muzrabot","Oltinsoy","Sariosiyo","Sherobod","Sho'rchi","Termiz t."],
      "Sirdaryo": ["Guliston sh.","Guliston t.","Baxt","Boyovut","Hovos","Mirzaobod","Sayxunobod","Sardoba","Shirin","Sirdaryo t.","Yangiyer"],
      "Toshkent viloyati": ["Nurafshon","Angren","Bekobod","Bo'stonliq","Bo'ka","Chinoz","Ohangaron","Oqqo'rg'on","Parkent","Piskent","Qibray","Quyichirchiq","Yangiyo'l","Yuqorichirchiq","Zangiota","Chirchiq","Toshkent t."],
      "Toshkent shahri": ["Bektemir","Chilonzor","Mirobod","Mirzo Ulug'bek","Olmazor","Sergeli","Shayxontohur","Uchtepa","Yakkasaroy","Yashnobod","Yunusobod"],
      "Xorazm": ["Urganch sh.","Urganch t.","Bog'ot","Gurlan","Hazorasp","Honqa","Qo'shko'pir","Shovot","Xiva","Xonqa","Yangiariq","Yangibozor"]
    };

    // Router
    const appEl = document.getElementById('app');
    const navLinks = document.querySelectorAll('.nav a[data-route]');
    function highlight(route){ navLinks.forEach(a=>a.classList.toggle('active', a.dataset.route===route)); }
    async function load(route){
      const file = route && route !== 'home' ? `${route}.html` : 'home.html';
      try{
        const resp = await fetch(`./partials/${file}?v=${Date.now()}`);
        if(!resp.ok) throw 0; const html = await resp.text(); appEl.innerHTML = html;
        highlight(route||'home');
        if((route||'home')==='profile'){ try{ await renderProfileView(); }catch(e){ console.warn('profile render', e); } }
      }catch(e){ appEl.innerHTML = '<div class="card">Sahifa topilmadi</div>'; }
    }
    window.addEventListener('hashchange', ()=> load(location.hash.replace('#','')));

    // Auth / Modals
    const show = el => el.style.display='flex';
    const hide = el => el.style.display='none';
    const loginBackdrop = document.getElementById('loginBackdrop');
    const regBackdrop = document.getElementById('regBackdrop');
    const profileBackdrop = document.getElementById('profileBackdrop');

    document.getElementById('openRegister').addEventListener('click', ()=>{ hide(loginBackdrop); show(regBackdrop); });
    document.getElementById('cancelReg').addEventListener('click', ()=>{ hide(regBackdrop); show(loginBackdrop); });

    async function loginWithIdPassword(numericId, pass){
      const q = query(collection(db,'users'), where('numericId','==', Number(numericId)));
      const snap = await getDocs(q);
      if(snap.empty) throw new Error('ID topilmadi');
      const data = snap.docs[0].data();
      if(!data.email) throw new Error('Email bog'lanmagan');
      return await signInWithEmailAndPassword(auth, data.email, pass);
    }
    document.getElementById('doLogin').addEventListener('click', async ()=>{
      const id = document.getElementById('loginId').value.trim();
      const pass = document.getElementById('loginPass').value.trim();
      try{ if(!id||!pass) throw new Error('ID va parol kiriting'); await loginWithIdPassword(id, pass); hide(loginBackdrop);}catch(err){ alert(err.message); }
    });

    document.getElementById('regWithGoogle').addEventListener('click', async ()=>{
      try{ const prov=new GoogleAuthProvider(); const res=await signInWithPopup(auth, prov); await ensureUserDocument(res.user, res.user.email||null); hide(regBackdrop); show(profileBackdrop);}catch(err){ alert(err.message); }
    });
    document.getElementById('regWithPhone').addEventListener('click', ()=>{ alert('Telefon raqam bilan ro'yxatdan o'tish uchun reCAPTCHA integratsiyasi talab qilinadi. Keyingi bosqichda qo'shamiz.'); });
    document.getElementById('createEmailUser').addEventListener('click', async ()=>{
      const email = document.getElementById('regEmail').value.trim();
      const pass = document.getElementById('regPass').value.trim();
      const pass2 = document.getElementById('regPass2').value.trim();
      try{ if(!email||!pass) throw new Error('Email va parol kiriting'); if(pass!==pass2) throw new Error('Parollar mos emas');
        const cred = await createUserWithEmailAndPassword(auth, email, pass); await ensureUserDocument(cred.user, email); hide(regBackdrop); show(profileBackdrop);
      }catch(err){ alert(err.message); }
    });

    async function ensureUserDocument(user, email){
      const uref = doc(db,'users', user.uid);
      const u = await getDoc(uref);
      if(!u.exists()){
        await runTransaction(db, async (tx)=>{
          const sref = doc(db,'settings','counters');
          const s = await tx.get(sref);
          const nextId = (s.exists()? (s.data().nextNumericId||1001) : 1001);
          tx.set(sref, { nextNumericId: nextId+1 }, { merge:true });
          tx.set(uref, { uid:user.uid, numericId:nextId, createdAt:serverTimestamp(), email, balance:0, score:0, profileCompleted:false }, { merge:true });
        });
      }
    }

    // Profile logic
    const pRegion = document.getElementById('pRegion');
    const pDistrict = document.getElementById('pDistrict');
    function fillRegions(){ pRegion.innerHTML = '<option value="" disabled selected>Viloyatni tanlang</option>' + Object.keys(REGIONS).map(r=>`<option>${r}</option>`).join(''); pDistrict.innerHTML = '<option value="" disabled selected>Avval viloyatni tanlang</option>'; }
    function onRegionChange(){ const r=pRegion.value; const d=REGIONS[r]||[]; pDistrict.innerHTML = d.map(x=>`<option>${x}</option>`).join(''); }
    pRegion.addEventListener('change', onRegionChange); fillRegions();

    document.getElementById('cancelProfile').addEventListener('click', ()=>{ show(profileBackdrop); });
    document.getElementById('saveProfile').addEventListener('click', async ()=>{
      try{
        const last = document.getElementById('pLast').value.trim();
        const first = document.getElementById('pFirst').value.trim();
        const middle = document.getElementById('pMiddle').value.trim();
        const birth = document.getElementById('pBirth').value;
        const phone = document.getElementById('pPhone').value.trim();
        const tg = document.getElementById('pTelegram').value.trim();
        const email = document.getElementById('pEmail').value.trim();
        const role = document.getElementById('pRole').value;
        const region = pRegion.value; const district = pDistrict.value; const school = document.getElementById('pSchool').value.trim();
        if(!last||!first||!birth||!phone||!role||!region||!district||!school) throw new Error('Barcha majburiy maydonlarni to'ldiring');
        const u = auth.currentUser; if(!u) throw new Error('Avval kiring');
        const uref = doc(db,'users', u.uid);
        await updateDoc(uref, { last, first, middle, birth, phone, telegram:tg, email, role, region, district, school, profileCompleted:true });
        hide(profileBackdrop); await refreshHeader(); load('home');
      }catch(err){ alert(err.message); }
    });

    function calcAge(iso){ if(!iso) return ''; const d=new Date(iso); if(Number.isNaN(d)) return ''; const diff=Date.now()-d.getTime(); const y = Math.floor(diff/31557600000); return y>0? `${y} yosh` : '' }

    async function refreshHeader(){
      const badge = document.getElementById('userBadge');
      const u = auth.currentUser; if(!u){ badge.hidden=true; return; }
      const data = (await getDoc(doc(db,'users',u.uid))).data(); if(!data) return;
      document.getElementById('helloName').textContent = data.first ? `${data.first}` : (data.email||'Foydalanuvchi');
      document.getElementById('helloAge').textContent = data.birth ? `‚Äî ${calcAge(data.birth)}` : '';
      document.getElementById('chipId').textContent = data.numericId||'‚Äî';
      document.getElementById('chipBalance').textContent = (data.balance??0);
      document.getElementById('chipScore').textContent = (data.score??0);
      badge.hidden=false;
    }

    document.getElementById('btnLogout').addEventListener('click', async (e)=>{ e.preventDefault(); await signOut(auth); location.hash='#home'; location.reload(); });

    onAuthStateChanged(auth, async (user)=>{
      if(user){ await ensureUserDocument(user, user.email||null); const data=(await getDoc(doc(db,'users',user.uid))).data(); await refreshHeader(); if(!data?.profileCompleted){ show(profileBackdrop); } else{ hide(profileBackdrop); } hide(loginBackdrop); hide(regBackdrop); }
      else{ show(loginBackdrop); document.getElementById('userBadge').hidden=true; }
    });

    // ---- Profile renderer ----
    async function renderProfileView(){
      const u = auth.currentUser; if(!u){ document.querySelector('#profileReadonly')?.classList.add('hidden'); return; }
      const d = (await getDoc(doc(db,'users',u.uid))).data(); if(!d){ return; }
      const appEl = document.getElementById('app');
      const $ = (sel)=> appEl.querySelector(sel);
      const full = [d.last,d.first,d.middle].filter(Boolean).join(' ');
      const age = (iso=>{ if(!iso) return ''; const t=Date.now()-new Date(iso).getTime(); const y=Math.floor(t/31557600000); return y>0? `${y} yosh`:'' })(d.birth);
      $('#pFull')?.replaceChildren(document.createTextNode(full||d.email||'Foydalanuvchi'));
      $('#pAge')?.replaceChildren(document.createTextNode(age));
      $('#pId')?.replaceChildren(document.createTextNode(d.numericId||'‚Äî'));
      $('#pBalance')?.replaceChildren(document.createTextNode((d.balance??0))); 
      $('#pScore')?.replaceChildren(document.createTextNode((d.score??0)));

      const map = {
        '#pRole': d.role,
        '#pBirth': d.birth,
        '#pPhone': d.phone,
        '#pEmail': d.email,
        '#pTelegram': d.telegram,
        '#pRegion': d.region,
        '#pDistrict': d.district,
        '#pSchool': d.school,
      };
      for(const k in map){ const el=$(k); if(el){ el.textContent = map[k]||'‚Äî'; } }
    }

    // boot
    load(location.hash.replace('#',''));
  </script>

  <!-- PARTIALS: /partials/home.html va boshqalar bo'lishi shart -->
  <!-- /partials/home.html namunasi:
  <section style="display:grid;gap:14px">
    <div class="card">
      <h2 style="margin:0 0 8px">Bosh sahifa</h2>
      <p style="margin:0;color:#406055">Menyudan kerakli bo'limni tanlang.</p>
    </div>
  </section>
  -->
</body>
</html>
