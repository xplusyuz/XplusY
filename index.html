<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"/>
  <title>LeaderMath.UZ — Matematika Platformasi</title>

  <meta name="theme-color" content="#2E8B57" id="meta-theme-color"/>
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="icon" href="/logo.png" sizes="192x192">
  <link rel="apple-touch-icon" href="/logo.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

  <style>
  :root{
    --brand:#2E8B57;
    --brand-dark:#1F6B45;
    --accent:#6B8E23;

    --bg:#F6FAF7;
    --bg-soft:#ECF4EF;
    --card:#FFFFFF;
    --card-soft:#F8FBF9;

    --text:#0F1B15;
    --text-muted:#5F7469;
    --line:#E1EAE4;

    --radius:18px;
    --radius-lg:20px;
    --pill:999px;

    --shadow-sm:0 4px 14px rgba(0,0,0,.06);
    --shadow-md:0 10px 30px rgba(0,0,0,.09);

    --wrap: min(1160px, 100vw - 24px);
    --header-h:64px;
  }

  :root.dark{
    --bg:#0F1512;
    --bg-soft:#151F1A;
    --card:#101C16;
    --card-soft:#15231C;
    --text:#EAF7EE;
    --text-muted:#A5C7B4;
    --line:#23372C;
    --shadow-sm:0 4px 14px rgba(0,0,0,.45);
    --shadow-md:0 10px 30px rgba(0,0,0,.55);
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}

  body{
    margin:0;
    font:15px/1.5 system-ui, -apple-system, BlinkMacSystemFont,"Segoe UI",sans-serif;
    color:var(--text);
    background:radial-gradient(circle at top left,#E3F1E8 0,#F6FAF7 45%,#F6FAF7 100%);
    -webkit-tap-highlight-color:transparent;
    overflow-x:hidden;
  }

  a{color:inherit;text-decoration:none}

  /* ===== HEADER ===== */
  .hdr{
    position:sticky;
    top:0;
    z-index:50;
    background:rgba(246,250,247,0.96);
    backdrop-filter:blur(10px);
    border-bottom:1px solid rgba(225,234,228,0.9);
  }
  :root.dark .hdr{
    background:rgba(15,21,18,0.96);
    border-bottom-color:rgba(35,55,44,0.9);
  }

  .row{
    max-width:var(--wrap);
    margin:0 auto;
    padding:8px 4px;
    display:flex;
    align-items:center;
    gap:12px;
  }

  .brand{
    display:flex;
    align-items:center;
    gap:10px;
  }
  .brand-logo{
    width:40px;
    height:40px;
    border-radius:14px;
    background:linear-gradient(135deg,#2E8B57,#3AA177);
    display:flex;
    align-items:center;
    justify-content:center;
    box-shadow:0 6px 14px rgba(46,139,87,.28);
  }
  .brand-logo img{
    width:28px;
    height:28px;
    filter:brightness(0) invert(1);
  }
  .brand-text{
    display:flex;
    flex-direction:column;
    line-height:1.1;
  }
  .brand-text span{
    font-weight:800;
    font-size:17px;
  }
  .brand-text span b{
    color:var(--brand);
  }
  .brand-text small{
    font-size:11px;
    color:var(--text-muted);
  }

  .grow{flex:1}

  /* USER CHIP */
  .userchip{
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(0,0,0,0.03);
    background:rgba(255,255,255,0.9);
    box-shadow:var(--shadow-sm);
    cursor:pointer;
  }
  :root.dark .userchip{
    background:rgba(15,24,20,0.95);
    border-color:rgba(255,255,255,0.06);
  }
  .avatar{
    width:32px;
    height:32px;
    border-radius:50%;
    background:linear-gradient(135deg,#2E8B57,#3AA177);
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-weight:700;
    font-size:15px;
  }
  .user-meta{
    display:flex;
    flex-direction:column;
    gap:1px;
  }
  .user-meta-main{
    font-size:13px;
    font-weight:600;
  }
  .user-meta-sub{
    font-size:11px;
    color:var(--text-muted);
  }

  .btn{
    cursor:pointer;
    border-radius:12px;
    border:1px solid var(--brand);
    padding:8px 14px;
    font-weight:700;
    font-size:14px;
    background:var(--brand);
    color:#fff;
    box-shadow:var(--shadow-sm);
  }
  .btn[disabled]{opacity:.6;cursor:not-allowed}

  /* USER MENU */
  .menu{
    position:fixed;
    inset:auto 8px auto auto;
    min-width:220px;
    background:var(--card);
    border-radius:16px;
    border:1px solid rgba(0,0,0,0.05);
    box-shadow:var(--shadow-md);
    display:none;
    overflow:hidden;
    z-index:60;
  }
  :root.dark .menu{
    background:var(--card);
    border-color:rgba(255,255,255,0.05);
  }
  .menu.open{display:block}
  .menu .label{
    padding:10px 14px;
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.04em;
    color:var(--text-muted);
    border-bottom:1px solid var(--line);
    background:var(--card-soft);
  }
  .menu a{
    display:flex;
    align-items:center;
    padding:10px 14px;
    font-size:14px;
    border-bottom:1px solid var(--line);
  }
  .menu a:last-child{border-bottom:none}
  .menu a:hover{
    background:rgba(46,139,87,0.07);
  }

  /* ===== CHIPBAR ===== */
  .chipbar-wrap{
    position:sticky;
    top:var(--header-h);
    z-index:45;
    background:linear-gradient(to bottom,
      rgba(246,250,247,0.97) 0,
      rgba(246,250,247,0.92) 70%,
      rgba(246,250,247,0)
    );
    backdrop-filter:blur(10px);
  }
  :root.dark .chipbar-wrap{
    background:linear-gradient(to bottom,
      rgba(15,21,18,0.97) 0,
      rgba(15,21,18,0.9) 70%,
      rgba(15,21,18,0)
    );
  }
  .chipbar{
    max-width:var(--wrap);
    margin:0 auto;
    padding:6px 4px 10px;
    display:flex;
    gap:8px;
    overflow-x:auto;
    scrollbar-width:none;
  }
  .chipbar::-webkit-scrollbar{display:none}

  .chip{
    white-space:nowrap;
    padding:7px 14px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(255,255,255,0.96);
    font-size:13px;
    font-weight:700;
    cursor:pointer;
  }
  :root.dark .chip{
    background:rgba(16,28,22,0.96);
  }
  .chip.active{
    background:var(--brand);
    border-color:var(--brand);
    color:#fff;
  }

  /* ===== HERO BANNER ===== */
  .hero{
    max-width:var(--wrap);
    margin:10px auto 16px;
    border-radius:var(--radius-lg);
    background:var(--card);
    box-shadow:var(--shadow-md);
    position:relative;
    overflow:hidden;
    min-height:190px;
  }
  :root.dark .hero{
    background:var(--card);
  }
  .hero .rail{
    position:absolute;
    inset:0;
    display:flex;
    transition:transform .45s ease;
  }
  .hero .slide{
    flex:0 0 100%;
    position:relative;
  }
  .hero iframe{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    border:0;
    display:block;
    background:#fff;
  }

  .hero-nav{
    position:absolute;
    top:50%;
    transform:translateY(-50%);
    width:34px;
    height:34px;
    border-radius:50%;
    border:none;
    display:flex;
    align-items:center;
    justify-content:center;
    background:rgba(255,255,255,0.9);
    box-shadow:0 4px 12px rgba(0,0,0,.12);
    cursor:pointer;
    font-size:20px;
  }
  :root.dark .hero-nav{
    background:rgba(12,20,16,0.9);
  }
  .hero-nav.prev{left:10px}
  .hero-nav.next{right:10px}

  .hero-dots{
    position:absolute;
    left:0;right:0;bottom:8px;
    display:flex;
    justify-content:center;
    gap:6px;
  }
  .hero-dot{
    width:7px;height:7px;
    border-radius:50%;
    background:rgba(0,0,0,0.16);
    border:1px solid rgba(255,255,255,0.5);
  }
  .hero-dot.active{
    background:var(--brand);
    border-color:var(--brand);
  }

  /* ===== MAIN / SECTIONS ===== */
  main{
    max-width:var(--wrap);
    margin:0 auto;
    padding:0 0 44px;
  }

  .section{
    margin-bottom:18px;
    background:var(--card);
    border-radius:var(--radius-lg);
    border:1px solid var(--line);
    box-shadow:var(--shadow-sm);
    overflow:hidden;
  }
  .section-hdr{
    padding:14px 16px;
    border-bottom:1px solid var(--line);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
  }
  .section-hdr h3{
    font-size:16px;
    font-weight:800;
  }
  .inner{
    padding:14px 16px 16px;
  }

  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
    gap:12px;
  }

  .cardX{
    border-radius:16px;
    border:1px solid var(--line);
    background:var(--card-soft);
    padding:10px 10px 12px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .thumb{
    width:100%;
    aspect-ratio:16/9;
    border-radius:12px;
    object-fit:cover;
    border:1px solid var(--line);
    background:#F2F6F3;
  }
  .cardX h4{
    font-size:14px;
    margin-bottom:2px;
  }
  .cardX-sub{
    font-size:12px;
    color:var(--text-muted);
  }
  .cardX-info{
    font-size:13px;
    color:var(--text-muted);
  }
  .cardX-footer{
    margin-top:6px;
  }
  .btn-small{
    border-radius:10px;
    border:1px solid var(--brand);
    background:var(--brand);
    color:#fff;
    padding:6px 10px;
    font-size:12px;
    font-weight:700;
    cursor:pointer;
  }

  /* ===== TOASTS ===== */
  .toasts{
    position:fixed;
    right:12px;
    bottom:12px;
    display:grid;
    gap:8px;
    z-index:90;
    max-width:min(340px,90vw);
  }
  .toast{
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--line);
    background:var(--card);
    display:flex;
    align-items:flex-start;
    gap:8px;
    box-shadow:var(--shadow-sm);
    font-size:13px;
  }
  .toast .t{font-weight:700}
  .toast .x{
    margin-left:auto;
    border:none;
    background:transparent;
    cursor:pointer;
    font-weight:700;
  }

  /* INSTALL BANNER (soddalashtirilgan) */
  .install-wrap{position:sticky;top:0;z-index:70;display:none}
  .install-banner{
    max-width:var(--wrap);
    margin:0 auto;
    padding:8px 10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    background:#ffffff;
    border-radius:0 0 16px 16px;
    border:1px solid var(--line);
    border-top:none;
    box-shadow:0 8px 24px rgba(0,0,0,.08);
  }
  .install-left{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .install-ico{
    width:26px;
    height:26px;
    border-radius:10px;
    background:linear-gradient(135deg,#2E8B57,#3AA177);
    display:flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-size:15px;
  }
  .install-title{font-size:13px;font-weight:700}
  .install-sub{font-size:11px;color:var(--text-muted)}
  .install-actions{
    display:flex;
    align-items:center;
    gap:6px;
  }
  .install-btn{
    border-radius:10px;
    border:1px solid var(--line);
    padding:6px 9px;
    background:#fff;
    font-size:12px;
    font-weight:600;
    cursor:pointer;
  }
  .install-btn.primary{
    border-color:var(--brand);
    background:var(--brand);
    color:#fff;
  }
  .install-x{
    border:none;
    background:transparent;
    cursor:pointer;
    font-size:16px;
  }

  /* OVERLAY + PANEL (profil modallari uchun tayyor) */
  .overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.3);
    display:none;
    place-items:center;
    z-index:80;
  }
  .overlay.show{display:grid}
  .panel{
    width:min(480px,92vw);
    max-height:90vh;
    background:var(--card);
    border-radius:18px;
    padding:18px 18px 20px;
    box-shadow:var(--shadow-md);
    overflow:auto;
  }

  @media (max-width:600px){
    :root{--header-h:60px}
    .row{padding-inline:8px}
    .chipbar{padding-inline:8px}
    .hero{border-radius:16px}
    .section{border-radius:16px}
  }
  </style>
</head>
<body>

<!-- INSTALL BANNER -->
<div id="installWrap" class="install-wrap" role="region" aria-label="O‘rnatish taklifi">
  <div class="install-banner">
    <div class="install-left">
      <div class="install-ico">⬇️</div>
      <div>
        <div class="install-title">LeaderMath’ni o‘rnatib oling</div>
        <div class="install-sub">Offline, tez kirish va to‘liq ekran</div>
      </div>
    </div>
    <div class="install-actions">
      <button id="btnInstallNow" class="install-btn primary">O‘rnatish</button>
      <button id="btnInstallLater" class="install-btn">Keyinroq</button>
      <button id="btnInstallClose" class="install-x" aria-label="Yopish">✕</button>
    </div>
  </div>
</div>

<header class="hdr" id="hdr">
  <div class="row">
    <div class="brand">
      <div class="brand-logo">
        <img src="/logo.png" alt="LM">
      </div>
      <div class="brand-text">
        <span>LeaderMath.<b>UZ</b></span>
        <small>Matematika platformasi</small>
      </div>
    </div>
    <div class="grow"></div>
    <div id="user-slot"></div>
  </div>
  <div class="chipbar-wrap" id="chipwrap">
    <nav id="chipbar" class="chipbar" aria-label="Bo‘limlar"></nav>
  </div>
</header>

<section id="hero" class="hero" aria-label="Bannerlar">
  <div class="rail" id="heroRail"></div>
  <button class="hero-nav prev" id="heroPrev" aria-label="Oldingi">‹</button>
  <button class="hero-nav next" id="heroNext" aria-label="Keyingi">›</button>
  <div class="hero-dots" id="heroDots"></div>
</section>

<main id="app">
  <div id="sections"></div>
</main>

<div id="takeover" class="takeover-host" style="display:none"></div>
<div id="overlay" class="overlay" aria-modal="true"></div>
<div id="portal-root"></div>
<div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>

<script>
// INSTALL BANNER (logika o‘sha-o‘sha)
(() => {
  const wrap = document.getElementById('installWrap');
  const btnNow = document.getElementById('btnInstallNow');
  const btnLater = document.getElementById('btnInstallLater');
  const btnClose = document.getElementById('btnInstallClose');
  const DISMISS_KEY = 'lm_install_dismiss_until';
  let deferredPrompt = null;
  const isStandalone = () =>
    window.matchMedia('(display-mode: standalone)').matches ||
    window.navigator.standalone === true;
  const show = () => (wrap.style.display = 'block');
  const hide = () => (wrap.style.display = 'none');
  const snooze = (days=7)=>localStorage.setItem(DISMISS_KEY, Date.now()+days*864e5);
  const snoozed = ()=>Number(localStorage.getItem(DISMISS_KEY)||0)>Date.now();
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);

  if (isStandalone()) hide();
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault(); deferredPrompt = e;
    if (isStandalone() || snoozed()) return;
    btnNow.onclick = async () => {
      hide(); deferredPrompt?.prompt();
      const choice = await deferredPrompt?.userChoice; deferredPrompt = null;
      if (!choice || choice.outcome !== 'accepted') snooze(7);
    };
    btnLater.onclick = ()=>{ hide(); snooze(3); };
    btnClose.onclick = ()=>{ hide(); snooze(14); };
    show();
  });
  if (!('BeforeInstallPromptEvent' in window) && isIOS && !isStandalone() && !snoozed()){
    const t = document.querySelector('.install-title');
    const s = document.querySelector('.install-sub');
    if(t && s){
      t.textContent = 'Home Screen’ga qo‘shing';
      s.innerHTML = "Safari’da <b>Share</b> → <b>Add to Home Screen</b>";
    }
    btnNow.textContent='Tushunarli';
    btnNow.onclick = ()=>{ hide(); snooze(7); };
    btnLater.onclick = ()=>{ hide(); snooze(3); };
    btnClose.onclick = ()=>{ hide(); snooze(14); };
    show();
  }
  window.addEventListener('appinstalled', ()=>{ hide(); localStorage.removeItem(DISMISS_KEY); });
})();
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider,
  setPersistence, browserLocalPersistence, signOut
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  authDomain: "xplusy-760fa.firebaseapp.com",
  projectId: "xplusy-760fa",
  storageBucket: "xplusy-760fa.appspot.com",
  messagingSenderId: "992512966017",
  appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
  measurementId: "G-459PLJ7P7L"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
try{ await setPersistence(auth, browserLocalPersistence); }catch(e){ console.warn(e); }

const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));

function toast(msg,type='info',timeout=3500){
  const host=$('#toasts'); if(!host) return;
  const el=document.createElement('div');
  el.className='toast '+type;
  el.innerHTML=`<span class="t">${type==='error'?'❌':type==='success'?'✅':'ℹ️'}</span>
                <div>${msg}</div>
                <button class="x" aria-label="Yopish">×</button>`;
  const remove=()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(),200); };
  el.querySelector('.x').onclick=remove;
  host.appendChild(el);
  setTimeout(remove, timeout);
}

// ===== STATE =====
const HSTATE = {
  sections: [],
  activeSectionId: null,
  heroSlides: [],
  heroIndex: 0,
  heroTimer: null
};

// ===== HOME LOAD =====
async function fetchHome(){
  // 1) Firestore configs/home
  try{
    const snap = await getDoc(doc(db,'configs','home'));
    if(snap.exists()){
      return snap.data();
    }
  }catch(e){
    console.warn('Firestore home doc error', e);
  }

  // 2) local /home.json
  try{
    const res = await fetch('/home.json',{cache:'no-store'});
    if(res.ok){
      return await res.json();
    }
  }catch(e){
    console.warn('home.json load error', e);
  }

  // 3) default
  return {
    sections: [
      {
        id: 'welcome',
        title: 'Boshlash',
        subsections: [
          {
            id:'intro',
            title:'LeaderMath.UZ ga xush kelibsiz',
            banners:[],
            cards:[
              {
                title:'Demo testlar',
                cardStyle:'available',
                ctaLabel:'Boshlash',
                ctaHref:'#',
                infoHtml:'Tezkor demo testlar orqali platforma bilan tanishing.'
              }
            ]
          }
        ]
      }
    ]
  };
}

// ===== HERO =====
function heroRender(banners){
  const hero = $('#hero');
  const rail = $('#heroRail');
  const dots = $('#heroDots');

  HSTATE.heroSlides = Array.isArray(banners) ? banners : [];

  if(!HSTATE.heroSlides.length){
    hero.style.display='none';
    rail.innerHTML=''; dots.innerHTML='';
    return;
  }

  hero.style.display='block';
  rail.innerHTML='';
  dots.innerHTML='';
  HSTATE.heroIndex=0;

  HSTATE.heroSlides.forEach((b,idx)=>{
    const slide=document.createElement('div');
    slide.className='slide';
    const iframe=document.createElement('iframe');

    if(b.mode==='html' && b.contentHtml){
      const blob=new Blob([b.contentHtml],{type:'text/html'});
      iframe.src=URL.createObjectURL(blob);
    }else if(b.mode==='url' && b.src){
      iframe.src=b.src;
    }else if(b.src){
      iframe.src=b.src;
    }else{
      iframe.srcdoc=`<!doctype html><html><body style="margin:0;display:flex;align-items:center;justify-content:center;font-family:system-ui;background:#F6FAF7;color:#0F1B15">
        Banner mavjud emas
      </body></html>`;
    }

    slide.appendChild(iframe);
    rail.appendChild(slide);

    const dot=document.createElement('button');
    dot.type='button';
    dot.className='hero-dot'+(idx===0?' active':'');
    dot.addEventListener('click',()=>heroGo(idx));
    dots.appendChild(dot);
  });

  rail.style.transform='translateX(0)';
  heroStartAuto();
}

function heroGo(index){
  const rail = $('#heroRail');
  const dots = $$('.hero-dot',$('#heroDots'));
  const n = HSTATE.heroSlides.length;
  if(!n) return;
  HSTATE.heroIndex = (index + n) % n;
  rail.style.transform=`translateX(-${HSTATE.heroIndex*100}%)`;
  dots.forEach((d,i)=>d.classList.toggle('active', i===HSTATE.heroIndex));
}

function heroStartAuto(){
  heroStopAuto();
  if(HSTATE.heroSlides.length<=1) return;
  HSTATE.heroTimer=setInterval(()=>heroGo(HSTATE.heroIndex+1),8000);
}
function heroStopAuto(){
  if(HSTATE.heroTimer){ clearInterval(HSTATE.heroTimer); HSTATE.heroTimer=null; }
}

$('#heroPrev').addEventListener('click',()=>{
  heroStopAuto(); heroGo(HSTATE.heroIndex-1); heroStartAuto();
});
$('#heroNext').addEventListener('click',()=>{
  heroStopAuto(); heroGo(HSTATE.heroIndex+1); heroStartAuto();
});

// ===== SECTIONS & CHIPS =====
function renderChips(){
  const bar = $('#chipbar');
  bar.innerHTML='';
  HSTATE.sections.forEach(sec=>{
    const btn=document.createElement('button');
    btn.className='chip';
    btn.textContent=sec.title || 'Bo‘lim';
    btn.dataset.id=sec.id;
    btn.addEventListener('click',()=>activate(sec.id));
    bar.appendChild(btn);
  });
}

function renderSections(){
  const host = $('#sections');
  host.innerHTML='';

  HSTATE.sections.forEach(sec=>{
    const wrap=document.createElement('section');
    wrap.className='section';
    wrap.dataset.id=sec.id;

    const hdr=document.createElement('div');
    hdr.className='section-hdr';
    hdr.innerHTML=`<h3>${sec.title || 'Bo‘lim'}</h3>`;
    wrap.appendChild(hdr);

    const inner=document.createElement('div');
    inner.className='inner';

    const cards=[];
    if(Array.isArray(sec.subsections)){
      sec.subsections.forEach(sub=>{
        if(Array.isArray(sub.cards)){
          sub.cards.forEach(c=>cards.push({...c,_subTitle:sub.title}));
        }
      });
    }
    if(Array.isArray(sec.cards)){
      sec.cards.forEach(c=>cards.push(c));
    }

    if(cards.length){
      const grid=document.createElement('div');
      grid.className='grid';
      cards.forEach(card=>{
        const el=document.createElement('article');
        el.className='cardX';
        el.innerHTML = `
          ${card.thumb ? `<img class="thumb" src="${card.thumb}" alt="">` : ''}
          <div>
            <h4>${card.title || ''}</h4>
            ${card._subTitle ? `<div class="cardX-sub">${card._subTitle}</div>` : ''}
            ${card.infoHtml ? `<div class="cardX-info">${card.infoHtml}</div>` : ''}
          </div>
          ${card.ctaHref ? `<div class="cardX-footer"><button class="btn-small" type="button">${card.ctaLabel || 'Boshlash'}</button></div>` : ''}
        `;
        if(card.ctaHref){
          el.querySelector('.btn-small')?.addEventListener('click',()=>{
            const href = card.ctaHref;
            location.href = href;
          });
        }
        grid.appendChild(el);
      });
      inner.appendChild(grid);
    }else{
      inner.innerHTML='<p style="font-size:13px;color:var(--text-muted)">Bu bo‘lim hozircha bo‘sh.</p>';
    }

    wrap.appendChild(inner);
    host.appendChild(wrap);
  });
}

function activate(id){
  HSTATE.activeSectionId=id;
  $$('.chip').forEach(ch=>ch.classList.toggle('active', ch.dataset.id===id));
  $$('.section').forEach(sec=>{
    sec.style.display = (!id || sec.dataset.id===id) ? 'block' : 'none';
  });

  const sec = HSTATE.sections.find(s=>s.id===id);
  if(!sec){ heroRender([]); return; }
  let banners=[];
  if(Array.isArray(sec.subsections)){
    for(const sub of sec.subsections){
      if(Array.isArray(sub.banners) && sub.banners.length){
        banners=sub.banners; break;
      }
    }
  }
  heroRender(banners);
}

// ===== USER CHIP (soddalashtirilgan) =====
function renderUserChip(user){
  const slot = $('#user-slot');
  if(!user){
    slot.innerHTML = `<button id="btnLogin" class="btn" type="button">Kirish</button>`;
    $('#btnLogin').onclick = async()=>{
      try{
        const provider=new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      }catch(e){
        console.error(e);
        toast('Kirishda xatolik yuz berdi','error');
      }
    };
    return;
  }

  const name = user.displayName || user.email || 'Foydalanuvchi';
  const initial = (name[0]||'L').toUpperCase();
  slot.innerHTML = `
    <div class="userchip" id="userChip">
      <div class="avatar">${initial}</div>
      <div class="user-meta">
        <div class="user-meta-main">${name}</div>
        <div class="user-meta-sub">LeaderMath foydalanuvchisi</div>
      </div>
    </div>
    <div class="menu" id="userMenu">
      <div class="label">Profil</div>
      <a href="#" id="menuLogout">Chiqish</a>
    </div>
  `;

  const chip=$('#userChip');
  const menu=$('#userMenu');

  const toggleMenu=(ev)=>{
    ev.stopPropagation();
    const r=chip.getBoundingClientRect();
    menu.style.top=(r.bottom+6)+'px';
    menu.style.right=(window.innerWidth-r.right+8)+'px';
    menu.classList.toggle('open');
  };
  chip.onclick=toggleMenu;
  document.addEventListener('click', (e)=>{
    if(!menu.contains(e.target) && !chip.contains(e.target)){
      menu.classList.remove('open');
    }
  });
  $('#menuLogout').onclick=async(e)=>{
    e.preventDefault();
    try{
      await signOut(auth);
      toast('Akkauntdan chiqildi','success');
    }catch(err){
      console.error(err);
      toast('Chiqishda xatolik','error');
    }
  };
}

onAuthStateChanged(auth, user=>{
  renderUserChip(user);
});

// ===== BOOT =====
async function boot(){
  try{
    const d = await fetchHome();
    HSTATE.sections = (Array.isArray(d.sections)?d.sections:[])
      .map((s,i)=>({ id: s.id || `sec${i+1}`, ...s }));

    renderChips();
    renderSections();

    if(HSTATE.sections.length){
      activate(HSTATE.sections[0].id);
    }else{
      heroRender([]);
    }
  }catch(e){
    console.error('Boot error', e);
    toast('Maʼlumotlarni yuklashda xatolik','error');
    heroRender([]);
  }
}

await boot();

// SERVICE WORKER
if('serviceWorker' in navigator){
  try{
    const reg = await navigator.serviceWorker.register('/sw.js');
    if(!localStorage.getItem('sw_installed')){
      toast('Offline rejim yoqildi ✅','success');
      localStorage.setItem('sw_installed','1');
    }
    reg.addEventListener('updatefound',()=>{
      const nw=reg.installing;
      nw?.addEventListener('statechange',()=>{
        if(nw.state==='installed' && navigator.serviceWorker.controller){
          toast('Yangi versiya tayyor. Iltimos sahifani yangilang.','info');
        }
      });
    });
  }catch(e){
    console.warn(e);
  }
}
</script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-459PLJ7P7L"></script>
<script>
window.dataLayer=window.dataLayer||[];
function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());
gtag('config','G-459PLJ7P7L');
</script>

</body>
</html>
