<!doctype html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <title>LeaderMath — Portal</title>
  <meta name="theme-color" content="#007AFF">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --p:#007AFF;--s:#5856D6;--bg:#FFFFFF;--bg2:#F2F2F7;--t:#111827;--m:#6b7280;--b:#e5e7eb;
      --r:18px;--shadow:0 10px 30px rgba(0,0,0,.10);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--t);min-height:100vh}
    .header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.92);backdrop-filter:blur(18px);border-bottom:1px solid var(--b);padding:12px 16px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
    .logo{width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,var(--p),var(--s));display:flex;align-items:center;justify-content:center;color:white;font-weight:900}
    .bt{display:flex;flex-direction:column;min-width:0}
    .bt .h{font-weight:800;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .bt .sub{font-size:12px;color:var(--m);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .chip{background:var(--bg2);border:1px solid var(--b);border-radius:999px;padding:10px 12px;display:flex;align-items:center;gap:10px;cursor:pointer}
    .avatar{width:32px;height:32px;border-radius:999px;background:linear-gradient(135deg,var(--p),var(--s));color:white;display:flex;align-items:center;justify-content:center;font-weight:800;overflow:hidden}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .main{padding:16px 16px 98px}
    .hero{background:linear-gradient(135deg,rgba(0,122,255,.10),rgba(88,86,214,.10));border:1px solid rgba(0,0,0,.06);border-radius:22px;padding:16px;box-shadow:var(--shadow);margin-bottom:16px}
    .hero h2{font-size:18px;font-weight:900}
    .hero p{margin-top:6px;color:var(--m);font-size:13px;line-height:1.4}
    .section{margin-top:18px}
    .st{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .st h3{font-size:14px;font-weight:900}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .card{background:white;border:1px solid var(--b);border-radius:18px;box-shadow:0 8px 24px rgba(0,0,0,.06);overflow:hidden;cursor:pointer;transition:transform .12s}
    .card:active{transform:scale(.98)}
    .ch{height:84px;background:linear-gradient(135deg,var(--p),#5AC8FA);display:flex;align-items:center;justify-content:center;color:white;font-size:22px}
    .cb{padding:12px}
    .ct{font-weight:800;font-size:14px}
    .cd{margin-top:4px;color:var(--m);font-size:12px;line-height:1.35;min-height:32px}
    .banner{border-radius:18px;border:1px solid var(--b);overflow:hidden;background:var(--bg2);box-shadow:var(--shadow)}
    .banner iframe{width:100%;height:140px;border:0;display:block;background:white}
    .nav{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:rgba(255,255,255,.92);border:1px solid var(--b);border-radius:999px;display:flex;gap:10px;padding:10px;box-shadow:0 12px 32px rgba(0,0,0,.14);max-width:calc(100% - 28px);overflow:auto}
    .nav::-webkit-scrollbar{display:none}
    .ni{border:1px solid var(--b);background:var(--bg2);border-radius:999px;padding:10px 14px;display:flex;align-items:center;gap:8px;white-space:nowrap;cursor:pointer;font-weight:800;color:var(--m)}
    .ni.active{background:linear-gradient(135deg,var(--p),var(--s));border-color:transparent;color:white}
    .page{display:none}
    .page.active{display:block;animation:fade .25s ease}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);backdrop-filter:blur(10px);padding:18px;z-index:50}
    .modal.open{display:flex}
    .dialog{width:min(520px,100%);background:white;border-radius:22px;box-shadow:0 25px 65px rgba(0,0,0,.25);padding:18px;position:relative}
    .x{position:absolute;top:12px;right:12px;width:42px;height:42px;border-radius:999px;border:none;background:#F2F2F7;cursor:pointer}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:block;font-size:12px;color:var(--m);margin-top:10px}
    input,select{width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--b);margin-top:6px;font-size:14px;outline:none;background:white}
    input:focus,select:focus{border-color:var(--p);box-shadow:0 0 0 3px rgba(0,122,255,.12)}
    .btn{margin-top:14px;width:100%;border:none;border-radius:999px;padding:14px 16px;font-weight:900;cursor:pointer;background:linear-gradient(135deg,var(--p),var(--s));color:white}
    .btn2{background:#FFE4E6;color:#9f1239}
    .mut{font-size:12px;color:var(--m);margin-top:8px}
  </style>
</head>
<body>
  <div class="header">
    <div class="brand">
      <div class="logo">LM</div>
      <div class="bt">
        <div class="h">LeaderMath Portal</div>
        <div class="sub" id="greet">Yuklanmoqda…</div>
      </div>
    </div>
    <div class="chip" id="openProfile">
      <div class="avatar" id="ava">U</div>
      <div style="display:flex;flex-direction:column;gap:2px">
        <div style="font-size:12px;color:var(--m);font-weight:800">ID: <span id="uid">—</span></div>
        <div style="font-size:12px;font-weight:900"><span id="points">0</span> ball</div>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="page active" id="page-home">
      <div class="hero">
        <h2>Premium mobil dizayn + API-only</h2>
        <p>Banner va cardlar serverdan keladi. Pastki nav dinamik (scroll).</p>
      </div>

      <div class="section">
        <div class="st"><h3>Bannerlar</h3></div>
        <div id="banners" style="display:grid;gap:12px"></div>
      </div>

      <div class="section">
        <div class="st"><h3>Cardlar</h3></div>
        <div class="grid" id="cards"></div>
      </div>
    </div>

    <div class="page" id="page-ranking">
      <div class="hero">
        <h2>Reyting</h2>
        <p>API orqali top o'quvchilar ro'yxati.</p>
      </div>
      <div id="ranking" style="display:grid;gap:10px"></div>
    </div>

    <div class="page" id="page-about">
      <div class="hero">
        <h2>Sayt haqida</h2>
        <p>Bu skeleton keyin sizning kontent/bo'limlaringiz bilan kengayadi.</p>
      </div>
    </div>
  </div>

  <div class="nav" id="nav">
    <div class="ni active" data-page="home"><i class="fa-solid fa-house"></i>Home</div>
    <div class="ni" data-page="ranking"><i class="fa-solid fa-ranking-star"></i>Reyting</div>
    <div class="ni" data-page="about"><i class="fa-solid fa-circle-info"></i>About</div>
  </div>

  <div class="modal" id="mProfile">
    <div class="dialog">
      <button class="x" data-close="mProfile"><i class="fa-solid fa-xmark"></i></button>
      <div style="font-weight:900;font-size:16px;margin:6px 0 8px">Profil</div>
      <div class="mut">Ism/familiya, viloyat/tuman va avatarni yangilash mumkin.</div>

      <form id="pf">
        <div class="row">
          <label>Ism
            <input id="fn" placeholder="Ism">
          </label>
          <label>Familiya
            <input id="ln" placeholder="Familiya">
          </label>
        </div>
        <div class="row">
          <label>Viloyat
            <input id="rg" placeholder="Viloyat">
          </label>
          <label>Tuman
            <input id="dt" placeholder="Tuman">
          </label>
        </div>

        <label>Avatar (base64)
          <input id="av64" placeholder="data:image/png;base64,..." autocomplete="off">
        </label>

        <button class="btn" type="submit"><i class="fa-solid fa-floppy-disk"></i> Saqlash</button>
        <button class="btn btn2" type="button" id="logout"><i class="fa-solid fa-right-from-bracket"></i> Chiqish</button>
      </form>
    </div>
  </div>

  <script src="api-utils.js"></script>
  <script src="auth-utils.js"></script>
  <script>
    const $ = (id)=>document.getElementById(id);
    const open = (id)=>$(id).classList.add('open');
    const close = (id)=>$(id).classList.remove('open');

    // SW register
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(()=>{});
    }

    // nav
    document.getElementById('nav').addEventListener('click', (e)=>{
      const it = e.target.closest('.ni'); if(!it) return;
      document.querySelectorAll('.ni').forEach(x=>x.classList.remove('active'));
      it.classList.add('active');
      const page = it.dataset.page;
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.getElementById('page-'+page).classList.add('active');

      if (page === 'ranking') loadRanking();
    });

    document.addEventListener('click',(e)=>{
      const b = e.target.closest('[data-close]');
      if (b) close(b.dataset.close);
      if (e.target.classList.contains('modal')) close(e.target.id);
    });

    $('openProfile').onclick = ()=> open('mProfile');

    $('logout').onclick = async ()=>{
      if (!confirm("Chiqasizmi?")) return;
      await authUtils.logout();
      location.href = 'login.html';
    };

    $('pf').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const patch = {
        firstName: $('fn').value.trim(),
        lastName: $('ln').value.trim(),
        region: $('rg').value.trim(),
        district: $('dt').value.trim()
      };
      const u = await authUtils.updateUserData(patch);
      renderUser(u);
      const av = $('av64').value.trim();
      if (av.startsWith('data:image')) {
        try {
          const out = await apiUtils.uploadAvatar(u.id, av);
          renderUser(out.user);
        } catch(e){}
      }
      close('mProfile');
    });

    function renderUser(u){
      const name = ((u.firstName||'')+' '+(u.lastName||'')).trim() || 'Foydalanuvchi';
      $('greet').textContent = `Salom, ${name}`;
      $('uid').textContent = u.loginId || u.id || '—';
      $('points').textContent = u.points || 0;

      $('fn').value = u.firstName || '';
      $('ln').value = u.lastName || '';
      $('rg').value = u.region || '';
      $('dt').value = u.district || '';

      const ava = $('ava');
      if (u.avatar) {
        ava.innerHTML = `<img src="${u.avatar}" alt="avatar">`;
      } else {
        ava.textContent = (u.firstName ? u.firstName[0] : 'U').toUpperCase();
      }
    }

    async function loadHome(){
      const content = await apiUtils.getHomeContent();
      // banners
      const b = $('banners'); b.innerHTML = '';
      (content.banners||[]).forEach(x=>{
        const wrap = document.createElement('div');
        wrap.className = 'banner';
        if (x.mode === 'html') {
          const blob = new Blob([x.contentHtml||''], {type:'text/html'});
          const url = URL.createObjectURL(blob);
          wrap.innerHTML = `<iframe sandbox="${x.sandbox||'allow-scripts allow-forms'}" src="${url}"></iframe>`;
        } else {
          wrap.innerHTML = `<iframe sandbox="${x.sandbox||'allow-scripts allow-forms'}" src="${x.src}"></iframe>`;
        }
        b.appendChild(wrap);
      });
      // cards
      const c = $('cards'); c.innerHTML = '';
      (content.cards||[]).forEach(x=>{
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <div class="ch"><i class="${x.icon || 'fa-solid fa-square-root-variable'}"></i></div>
          <div class="cb">
            <div class="ct">${x.title||'Card'}</div>
            <div class="cd">${x.description||''}</div>
          </div>`;
        el.onclick = ()=> {
          if (x.href) window.location.href = x.href;
          else alert(x.title||'Card');
        };
        c.appendChild(el);
      });
    }

    async function loadRanking(){
      const box = $('ranking');
      box.innerHTML = '<div class="hero"><p>Yuklanmoqda…</p></div>';
      try{
        const data = await apiUtils.getRanking();
        box.innerHTML = '';
        (data.users||[]).slice(0,50).forEach((u, idx)=>{
          const name = ((u.firstName||'')+' '+(u.lastName||'')).trim() || 'Foydalanuvchi';
          const row = document.createElement('div');
          row.className = 'card';
          row.style.display = 'flex';
          row.style.alignItems = 'center';
          row.style.gap = '12px';
          row.style.padding = '12px';
          row.innerHTML = `
            <div style="width:38px;text-align:center;font-weight:900">${idx+1}</div>
            <div class="avatar" style="width:38px;height:38px">${u.avatar ? `<img src="${u.avatar}">` : (name[0]||'U').toUpperCase()}</div>
            <div style="flex:1;min-width:0">
              <div style="font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${name}</div>
              <div style="font-size:12px;color:var(--m)">${u.district||u.region||'—'}</div>
            </div>
            <div style="font-weight:900;color:var(--p)">${u.points||0}</div>
          `;
          box.appendChild(row);
        });
      }catch(e){
        box.innerHTML = '<div class="hero"><p style="color:#991b1b">Reyting yuklanmadi: '+(e.message||'xato')+'</p></div>';
      }
    }

    (async ()=>{
      const u = await authUtils.requireSession();
      renderUser(u);
      await loadHome();
    })();
  </script>
</body>
</html>
