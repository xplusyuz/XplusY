<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LeaderMath ‚Äî Portal</title>
  <meta name="theme-color" content="#070B14" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#070B14;
      --panel:rgba(255,255,255,.08);
      --panel2:rgba(255,255,255,.05);
      --stroke:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.66);
      --green:#2E8B57;
      --blue:#1B9DFF;
      --blue2:#6AD7FF;
      --shadow:0 28px 90px rgba(0,0,0,.55);
      --r:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      color:var(--text);
      min-height:100vh;
      padding-bottom:92px;
      background:linear-gradient(180deg,#070B14,#0B1220);
      overflow-x:hidden;
    }
    header{
      position:sticky; top:0; z-index:30;
      background:linear-gradient(180deg, rgba(7,11,20,.82), rgba(7,11,20,.62));
      backdrop-filter: blur(16px);
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .bar{
      width:min(1180px,100%);
      margin:0 auto;
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      position:relative; z-index:2;
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logoWrap{
      width:46px;height:46px;border-radius:18px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      padding:8px;
      box-shadow:0 16px 44px rgba(0,0,0,.38);
      display:flex; align-items:center; justify-content:center;
    }
    .logoWrap img{width:100%;height:100%;object-fit:contain; display:block}
    .title{display:flex; flex-direction:column; line-height:1.1;}
    .title b{font-size:14px; letter-spacing:-.2px;}
    .title span{font-size:12px; color:var(--muted);}

    .actions{display:flex; gap:10px; align-items:center;}
    .iconbtn{
      width:42px; height:42px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.88);
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      font-weight:900;
      transition:transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .iconbtn:hover{border-color:rgba(106,215,255,.35)}
    .iconbtn:active{transform:scale(.98)}

    .userchip{
      display:flex; align-items:center; gap:10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      padding:7px 10px;
      border-radius:999px;
      cursor:pointer;
      transition:transform .12s ease, border-color .12s ease;
      user-select:none;
      position:relative;
    }
    .userchip:hover{transform:translateY(-1px); border-color:rgba(27,157,255,.35)}
    .avatar{
      width:34px; height:34px; border-radius:50%;
      border:1px solid rgba(255,255,255,.20);
      background:rgba(0,0,0,.22);
      overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      font-weight:1000;
    }
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .chipmeta{display:flex; flex-direction:column; line-height:1.15;}
    .chipmeta b{font-size:12px;}
    .chipmeta span{font-size:11px; color:var(--muted);}

    main{
      width:min(1180px,100%);
      margin:0 auto;
      padding:14px;
      position:relative; z-index:2;
    }

    .hero{
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border-radius:26px;
      box-shadow:var(--shadow);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(620px 300px at 15% 20%, rgba(27,157,255,.22), transparent 60%),
        radial-gradient(640px 300px at 85% 25%, rgba(46,139,87,.18), transparent 60%);
      pointer-events:none;
    }
    .hero *{position:relative; z-index:1;}
    .heroTop{display:flex; align-items:flex-start; justify-content:space-between; gap:12px;}
    .heroTop h1{margin:0;font-size:18px;letter-spacing:-.4px;}
    .pill{
      border:1px solid rgba(27,157,255,.30);
      background:rgba(27,157,255,.10);
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:1000;
      color:#dbefff;
      display:inline-flex;align-items:center;gap:8px;
    }
    .pulsedot{width:8px;height:8px;border-radius:50%;background:#6AD7FF; box-shadow:0 0 0 0 rgba(106,215,255,.0); animation:pulse 1.4s ease-in-out infinite;}
    @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(106,215,255,.0)}50%{box-shadow:0 0 0 10px rgba(106,215,255,.12)}}
    .sub{margin:8px 0 0; color:var(--muted); font-size:12px; line-height:1.55; max-width:78ch;}
    .stats{margin-top:14px; display:grid; grid-template-columns:repeat(4,1fr); gap:10px;}
    @media(max-width:900px){.stats{grid-template-columns:repeat(2,1fr);}}
    .stat{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      border-radius:18px;
      padding:12px;
    }
    .stat b{display:block;font-size:18px;letter-spacing:-.4px;}
    .stat span{display:block;margin-top:4px;font-size:12px;color:var(--muted);}

    /* Chips */
    .chipbar{
      margin-top:12px;
      display:flex; gap:10px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:none;
      padding-bottom:2px;
    }
    .chipbar::-webkit-scrollbar{display:none;}
    .chip{
      flex:0 0 auto;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.88);
      font-weight:1000;
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;
      transition:transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .chip:hover{transform:translateY(-1px); border-color:rgba(106,215,255,.35)}
    .chip.active{border-color:rgba(27,157,255,.55); background:rgba(27,157,255,.14); color:#e9f7ff;}

    /* Banners */
    .bannerRail{
      margin-top:12px;
      display:flex;
      gap:12px;
      overflow-x:auto;
      scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:none;
      padding-bottom:4px;
    }
    .bannerRail::-webkit-scrollbar{display:none;}
    .banner{
      flex:0 0 auto;
      width:min(720px, 92vw);
      scroll-snap-align:start;
      border:1px solid rgba(255,255,255,.12);
      background:linear-gradient(135deg, rgba(27,157,255,.18), rgba(46,139,87,.10));
      border-radius:24px;
      box-shadow:var(--shadow);
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .banner:after{
      content:"";
      position:absolute;
      width:280px;height:280px;border-radius:50%;
      background:radial-gradient(circle, rgba(255,255,255,.12), transparent 60%);
      right:-140px; top:-140px;
      opacity:.55;
    }
    .banner b{display:block;font-size:15px;}
    .banner span{display:block;margin-top:6px;color:var(--muted);font-size:12px;line-height:1.45; max-width:64ch;}
    .banner .row{margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .btn{
      border:1px solid rgba(27,157,255,.55);
      background:linear-gradient(180deg,rgba(27,157,255,.95),rgba(27,157,255,.62));
      color:white;
      padding:12px 14px;
      border-radius:16px;
      font-weight:1000;
      cursor:pointer;
      transition:transform .12s ease, filter .12s ease;
      text-decoration:none;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{filter:brightness(1.04)}
    .btn:active{transform:scale(.99)}
    .btn.secondary{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.92);
    }

    /* Cards */
    .cards{
      margin-top:12px;
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:12px;
    }
    @media(max-width:980px){.cards{grid-template-columns:repeat(2,1fr);}}
    @media(max-width:560px){.cards{grid-template-columns:1fr;}}
    .card{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      border-radius:24px;
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
      transition:transform .14s ease, border-color .14s ease;
      cursor:pointer;
    }
    .card:hover{transform:translateY(-2px); border-color:rgba(106,215,255,.30);}
    .cardTop{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(255,255,255,.86);
      font-size:11px;
      font-weight:1000;
    }
    .cardTop h3{margin:10px 0 0;font-size:14px;letter-spacing:-.2px;}
    .cardTop p{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.45;}
    .cardBot{padding:14px; display:flex; justify-content:space-between; align-items:center; gap:10px;}
    .mode{font-size:12px; color:rgba(255,255,255,.86); font-weight:1000;}
    .arrow{width:40px;height:40px;border-radius:16px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); display:flex;align-items:center;justify-content:center;font-weight:1000;}

    /* bottom nav */
    .bottom{
      position:fixed; left:0; right:0; bottom:0; z-index:40;
      background:linear-gradient(180deg, rgba(11,18,32,.55), rgba(11,18,32,.92));
      backdrop-filter: blur(16px);
      border-top:1px solid rgba(255,255,255,.10);
    }
    .nav{
      width:min(1180px,100%);
      margin:0 auto;
      padding:10px 10px 12px;
      display:flex; gap:10px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:none;
    }
    .nav::-webkit-scrollbar{display:none;}
    .navbtn{
      flex:0 0 auto;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.88);
      padding:10px 12px;
      border-radius:999px;
      font-weight:1000;
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;
      transition:transform .12s ease, background .12s ease, border-color .12s ease;
      display:flex; align-items:center; gap:8px;
    }
    .navbtn:active{transform:scale(.98)}
    .navbtn.active{border-color:rgba(27,157,255,.55); background:rgba(27,157,255,.14); color:#e9f7ff;}

    /* Avatar menu */
    .menu{
      position:absolute;
      right:0;
      top:56px;
      width:min(340px, 92vw);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(15,22,38,.92);
      box-shadow:var(--shadow);
      backdrop-filter: blur(16px);
      overflow:hidden;
      display:none;
      z-index:70;
    }
    .menu.open{display:block; animation:menuIn .14s ease-out both;}
    @keyframes menuIn{from{transform:translateY(6px);opacity:.85}to{transform:translateY(0);opacity:1}}
    .menuHead{
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; gap:12px; align-items:center;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .menuHead .av{width:44px;height:44px;border-radius:50%; overflow:hidden; border:1px solid rgba(255,255,255,.2); background:rgba(0,0,0,.22); display:flex;align-items:center;justify-content:center;font-weight:1000;}
    .menuHead .av img{width:100%;height:100%;object-fit:cover;display:block}
    .menuHead b{display:block;font-size:13px;}
    .menuHead span{display:block;margin-top:3px;font-size:12px;color:var(--muted);}
    .menuBtns{padding:12px; display:grid; gap:10px;}
    .mBtn{
      width:100%;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.92);
      padding:12px 12px;
      border-radius:16px;
      font-weight:1000;
      cursor:pointer;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      transition:transform .12s ease, border-color .12s ease;
    }
    .mBtn:hover{border-color:rgba(106,215,255,.30); transform:translateY(-1px)}
    .mBtn.danger{border-color:rgba(255,59,48,.35); background:rgba(255,59,48,.10);}
    .mBtn.danger:hover{border-color:rgba(255,59,48,.55)}
    .hint{padding:0 14px 14px; color:var(--muted); font-size:12px; line-height:1.45;}

    /* Modal sheet */
    .modal{
      position:fixed; inset:0; z-index:80;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
    }
    .modal.open{display:flex;}
    .sheet{
      width:min(820px,100%);
      border-radius:26px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(15,22,38,.92);
      box-shadow:var(--shadow);
      backdrop-filter: blur(16px);
      overflow:hidden;
      animation:sheetIn .18s ease-out both;
    }
    @keyframes sheetIn{from{transform:translateY(22px);opacity:.85}to{transform:translateY(0);opacity:1}}
    .sheetHead{
      padding:14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .sheetHead b{font-size:14px; font-weight:1000;}
    .xbtn{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.9);
      width:42px;height:42px;border-radius:16px;
      cursor:pointer;font-weight:1000;
    }
    .sheetBody{padding:14px;}
    .fields{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    @media(max-width:560px){.fields{grid-template-columns:1fr;}}
    label{font-size:12px; color:rgba(255,255,255,.75); font-weight:800;}
    input,select,textarea{
      width:100%;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
      font-size:14px;
      transition:border-color .12s ease, box-shadow .12s ease;
    }
    input:focus,select:focus,textarea:focus{border-color:rgba(27,157,255,.65); box-shadow:0 0 0 4px rgba(27,157,255,.18);}
    .toast{
      position:fixed; left:50%; bottom:104px; transform:translateX(-50%);
      background:rgba(0,0,0,.78);
      border:1px solid rgba(255,255,255,.18);
      color:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius:999px;
      display:none;
      z-index:90;
      font-size:12px;
    }
    .toast.show{display:block;}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand">
        <div class="logoWrap"><img src="logo.png" alt="LeaderMath logo"></div>
        <div class="title">
          <b>LeaderMath</b>
          <span id="subline">Yuklanmoqda‚Ä¶</span>
        </div>
      </div>

      <div class="actions">
        <button class="iconbtn" id="btnRefresh" title="Yangilash">‚ü≥</button>
        <div class="userchip" id="userChip" aria-haspopup="true" aria-expanded="false">
          <div class="avatar" id="avatar"></div>
          <div class="chipmeta">
            <b id="chipName">‚Äî</b>
            <span id="chipId">ID: ‚Äî ‚Ä¢ 0 pts</span>
          </div>

          <!-- popover menu -->
          <div class="menu" id="userMenu">
            <div class="menuHead">
              <div class="av" id="menuAv"></div>
              <div>
                <b id="menuName">‚Äî</b>
                <span id="menuMeta">ID: ‚Äî ‚Ä¢ 0 pts</span>
              </div>
            </div>
            <div class="menuBtns">
              <button class="mBtn" id="mProfile">üë§ Profil <span>‚Ä∫</span></button>
              <button class="mBtn" id="mEdit">‚úèÔ∏è Profil tahrirlash <span>‚Ä∫</span></button>
              <button class="mBtn" id="mAvatar">üñºÔ∏è Avatar almashtirish <span>‚Ä∫</span></button>
              <button class="mBtn danger" id="mLogout">üö™ Chiqish <span>‚Ä∫</span></button>
            </div>
            <div class="hint">Avatar ustini bossangiz shu menyu ochiladi. Hamma boshqaruv shu yerda.</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="heroTop">
        <div>
          <h1 id="pageTitle">Home</h1>
          <p class="sub" id="pageDesc">Bosh sahifa bannerlardan iborat. Qolgan sahifalarda cardlar va chiplar orqali tartiblash bor.</p>
        </div>
        <div class="pill"><span class="pulsedot"></span> Session OK</div>
      </div>

      <div class="stats">
        <div class="stat"><b id="pts">0</b><span>Points</span></div>
        <div class="stat"><b id="region">‚Äî</b><span>Viloyat</span></div>
        <div class="stat"><b id="district">‚Äî</b><span>Tuman</span></div>
        <div class="stat"><b id="birth">‚Äî</b><span>Tug‚Äòilgan sana</span></div>
      </div>
    </section>

    <!-- Home banners -->
    <section id="homeWrap" style="display:none;">
      <div class="bannerRail" id="banners"></div>
    </section>

    <!-- Cards pages -->
    <section id="cardsWrap" style="display:none;">
      <div class="chipbar" id="chips"></div>
      <div class="cards" id="cards"></div>
    </section>
  </main>

  <div class="bottom">
    <div class="nav" id="nav">
      <button class="navbtn active" data-page="home">üè† Home</button>
      <button class="navbtn" data-page="tests">üìù Testlar</button>
      <button class="navbtn" data-page="sim">ü§ñ Simulyatorlar</button>
      <button class="navbtn" data-page="ranking">üìä Reyting</button>
      <button class="navbtn" data-page="admin">üõ†Ô∏è Admin</button>
    </div>
  </div>

  <!-- Profile view modal -->
  <div class="modal" id="profileModal">
    <div class="sheet">
      <div class="sheetHead">
        <b>Profil</b>
        <button class="xbtn" id="pClose">‚úï</button>
      </div>
      <div class="sheetBody">
        <div class="fields">
          <div><label>ID</label><input id="pId" disabled /></div>
          <div><label>Points</label><input id="pPoints" disabled /></div>
          <div><label>Ism</label><input id="pFirst" disabled /></div>
          <div><label>Familiya</label><input id="pLast" disabled /></div>
          <div><label>Viloyat</label><input id="pRegion" disabled /></div>
          <div><label>Tuman</label><input id="pDistrict" disabled /></div>
          <div><label>Tug‚Äòilgan sana</label><input id="pBirth" disabled /></div>
          <div><label>Yangilangan</label><input id="pUpdated" disabled /></div>
        </div>
        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn secondary" id="pToEdit">Profil tahrirlash</button>
          <button class="btn secondary" id="pToAvatar">Avatar almashtirish</button>
          <button class="btn secondary" id="pClose2">Yopish</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile edit modal -->
  <div class="modal" id="editModal">
    <div class="sheet">
      <div class="sheetHead">
        <b>Profil tahrirlash</b>
        <button class="xbtn" id="eClose">‚úï</button>
      </div>
      <div class="sheetBody">
        <div class="fields">
          <div><label>Ism</label><input id="firstName" placeholder="Ismingiz" /></div>
          <div><label>Familiya</label><input id="lastName" placeholder="Familiyangiz" /></div>
          <div><label>Viloyat</label><select id="regionSel"><option value="">Tanlang‚Ä¶</option></select></div>
          <div><label>Tuman</label><select id="districtSel" disabled><option value="">Avval viloyat tanlang‚Ä¶</option></select></div>
          <div><label>Tug‚Äòilgan sana</label><input id="birthdate" type="date" /></div>
        </div>

        <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
          <button class="btn" id="save">Saqlash</button>
          <button class="btn secondary" id="eClose2">Yopish</button>
        </div>

        <div style="margin-top:12px;">
          <button class="btn secondary" id="pw">üîë Parolni almashtirish</button>
        </div>

        <div id="pwBox" style="display:none;margin-top:12px;">
          <div class="fields">
            <div><label>Joriy parol</label><input id="pwCur" type="password" /></div>
            <div><label>Yangi parol (>=6)</label><input id="pwNew" type="password" /></div>
          </div>
          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn" id="pwSave">Yangilash</button>
            <button class="btn secondary" id="pwCancel">Bekor</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Avatar change modal -->
  <div class="modal" id="avatarModal">
    <div class="sheet">
      <div class="sheetHead">
        <b>Avatar almashtirish</b>
        <button class="xbtn" id="aClose">‚úï</button>
      </div>
      <div class="sheetBody">
        <div class="banner" style="width:100%; max-width:none;">
          <b>Rasm tanlang</b>
          <span>PNG/JPG. Rasm avtomatik kichraytiriladi va profilga saqlanadi.</span>
          <div class="row">
            <input type="file" id="avatarFile" accept="image/*" style="flex:1; min-width:220px;">
            <button class="btn" id="avatarSave">Saqlash</button>
            <button class="btn secondary" id="avatarCancel">Bekor</button>
          </div>
        </div>
        <div style="margin-top:12px; display:flex; gap:12px; align-items:center;">
          <div class="avatar" style="width:64px;height:64px;" id="avatarPreview"></div>
          <div class="sub">Preview. Saqlash bosilganda API orqali users hujjatiga yoziladi.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="assets/anim-bg.js"></script>
  <script src="assets/api-client.js"></script>
  <script src="assets/auth-client.js"></script>
  <script>
    const $ = (id)=>document.getElementById(id);
    const toast = (m)=>{ const t=$('toast'); t.textContent=m; t.classList.add('show'); clearTimeout(t.__t); t.__t=setTimeout(()=>t.classList.remove('show'), 2200); };

    let regionData=null;
    let ME=null;
    let page='home';
    let pageDoc=null;
    let chip='Hammasi';
    let avatarDataUrl=null;

    const PAGE_META = {
      home:{ title:'Home', desc:'Bosh sahifa bannerlardan iborat (carousel).'},
      tests:{ title:'Testlar', desc:'Cardlar: chiplar orqali tartiblash (taglar).'},
      sim:{ title:'Simulyatorlar', desc:'Cardlar: chiplar orqali tartiblash (taglar).'},
      ranking:{ title:'Reyting', desc:'Cardlar: chiplar orqali tartiblash (taglar).'},
      admin:{ title:'Admin', desc:'Admin panel (admin.html) ‚Äî kontent va foydalanuvchilar.'},
    };

    (async ()=>{
      ME = await lmAuth.require();
      if (!ME) return;
      await init();
      await go('home');
    })();

    async function init(){
      paintUser(ME);

      try{
        const r = await fetch('region.json', {cache:'no-store'});
        regionData = await r.json();
        fillRegions(regionData);
      }catch(e){ console.warn('region.json yuklanmadi', e); }

      $('btnRefresh').onclick = async ()=>{
        try{
          await refreshMe();
          await render();
          toast('Yangilandi ‚úÖ');
        }catch(e){ toast(e?.message||'Xatolik'); }
      };

      $('nav').addEventListener('click',(e)=>{
        const btn = e.target.closest('.navbtn');
        if(!btn) return;
        const p = btn.dataset.page;
        if(p==='admin'){ location.href='admin.html'; return; }
        go(p);
      });

      // Avatar menu toggling
      const chipEl = $('userChip');
      const menu = $('userMenu');
      chipEl.addEventListener('click', (e)=>{
        e.stopPropagation();
        menu.classList.toggle('open');
        chipEl.setAttribute('aria-expanded', menu.classList.contains('open') ? 'true':'false');
      });
      document.addEventListener('click', ()=>{ menu.classList.remove('open'); chipEl.setAttribute('aria-expanded','false'); });

      // menu actions
      $('mProfile').onclick = (e)=>{ e.stopPropagation(); menu.classList.remove('open'); openProfile(); };
      $('mEdit').onclick = (e)=>{ e.stopPropagation(); menu.classList.remove('open'); openEdit(); };
      $('mAvatar').onclick = (e)=>{ e.stopPropagation(); menu.classList.remove('open'); openAvatar(); };
      $('mLogout').onclick = async (e)=>{ e.stopPropagation(); try{ await lmAuth.logout(); }catch{} };

      // Profile modal
      $('pClose').onclick = closeProfile;
      $('pClose2').onclick = closeProfile;
      $('pToEdit').onclick = ()=>{ closeProfile(); openEdit(); };
      $('pToAvatar').onclick = ()=>{ closeProfile(); openAvatar(); };
      $('profileModal').addEventListener('click', (e)=>{ if(e.target===$('profileModal')) closeProfile(); });

      // Edit modal
      $('eClose').onclick = closeEdit;
      $('eClose2').onclick = closeEdit;
      $('editModal').addEventListener('click', (e)=>{ if(e.target===$('editModal')) closeEdit(); });

      $('regionSel').addEventListener('change',(e)=>updateDistricts(e.target.value));
      $('save').onclick = saveProfile;

      $('pw').onclick = ()=>{ $('pwBox').style.display='block'; };
      $('pwCancel').onclick = ()=>{ $('pwBox').style.display='none'; };
      $('pwSave').onclick = changePassword;

      // Avatar modal
      $('aClose').onclick = closeAvatar;
      $('avatarCancel').onclick = closeAvatar;
      $('avatarModal').addEventListener('click', (e)=>{ if(e.target===$('avatarModal')) closeAvatar(); });
      $('avatarFile').addEventListener('change', onAvatarFile);
      $('avatarSave').onclick = saveAvatar;
    }

    async function go(p){
      page=p;
      chip='Hammasi';
      document.querySelectorAll('.navbtn').forEach(b=>b.classList.toggle('active', b.dataset.page===p));
      await loadPageDoc();
      await render();
      window.scrollTo({top:0, behavior:'smooth'});
    }

    async function loadPageDoc(){
      try{
        pageDoc = await lmApi.pageGet(page);
      }catch(e){
        pageDoc = null;
      }
    }

    async function render(){
      const m = PAGE_META[page] || {title:page, desc:''};
      $('pageTitle').textContent = m.title;
      $('pageDesc').textContent = m.desc;

      $('homeWrap').style.display = (page==='home') ? '' : 'none';
      $('cardsWrap').style.display = (page==='home') ? 'none' : '';

      if(page==='home'){
        renderBanners((pageDoc && pageDoc.banners) ? pageDoc.banners : []);
      }else{
        const cards = (pageDoc && pageDoc.cards) ? pageDoc.cards : [];
        renderCardsPage(cards);
      }
    }

    function renderBanners(banners){
      const rail=$('banners');
      rail.innerHTML='';
      if(!banners.length){
        rail.innerHTML = '<div class="banner"><b>Hozircha banner yo‚Äòq</b><span>Admin paneldan banner qo‚Äòshing (admin.html).</span><div class="row"><a class="btn secondary" href="admin.html">üõ†Ô∏è Admin</a></div></div>';
        return;
      }
      banners.sort((a,b)=>(a.order||0)-(b.order||0));
      for(const b of banners){
        const el=document.createElement('div');
        el.className='banner';
        const title = esc(b.title||'Banner');
        const desc = esc(b.subtitle||b.text||'');
        const ctaLabel = esc(b.ctaLabel||'Ochish');
        const ctaHref = esc(b.ctaHref||'#');
        el.innerHTML = \`
          <b>\${title}</b>
          <span>\${desc}</span>
          <div class="row">
            \${ctaHref && ctaHref!=='#' ? \`<a class="btn" href="\${ctaHref}">üöÄ \${ctaLabel}</a>\` : \`<button class="btn secondary" type="button" data-toast="Tayyor emas">‚è≥ Tez kunda</button>\`}
            \${b.tag ? \`<span class="tag">üè∑Ô∏è \${esc(b.tag)}</span>\` : ''}
          </div>\`;
        el.addEventListener('click', (e)=>{
          const btn = e.target.closest('a,button');
          if(btn && btn.dataset.toast){ toast(btn.dataset.toast); }
        });
        rail.appendChild(el);
      }
    }

    function renderCardsPage(cards){
      const tags = new Set(['Hammasi']);
      for(const c of cards){ if(c.tag) tags.add(String(c.tag)); }
      const chipbar=$('chips');
      chipbar.innerHTML='';
      [...tags].forEach(t=>{
        const b=document.createElement('button');
        b.className='chip'+(t===chip?' active':'');
        b.textContent=t;
        b.onclick=()=>{ chip=t; renderCardsPage(cards); };
        chipbar.appendChild(b);
      });

      const wrap=$('cards');
      wrap.innerHTML='';
      let view = cards.slice().sort((a,b)=>(a.order||0)-(b.order||0));
      if(chip!=='Hammasi') view=view.filter(x=>String(x.tag||'')===chip);

      if(!view.length){
        wrap.innerHTML = '<div class="card" style="grid-column:1/-1; cursor:default;"><div class="cardTop"><span class="tag">‚ÑπÔ∏è</span><h3>Hozircha card yo‚Äòq</h3><p>Admin paneldan card qo‚Äòshing (admin.html). Chipni ‚ÄúHammasi‚Äùga qo‚Äòying.</p></div><div class="cardBot"><span class="mode">‚Äî</span><div class="arrow">‚Ä∫</div></div></div>';
        return;
      }

      for(const c of view){
        const el=document.createElement('div');
        el.className='card';
        const mode = (c.mode||'available');
        const modeLabel = mode==='soon' ? 'Tez kunda' : (mode==='timed'?'Vaqtli':'Mavjud');
        el.innerHTML = \`
          <div class="cardTop">
            <span class="tag">\${c.tag?('üè∑Ô∏è '+esc(c.tag)):'üìå Card'}</span>
            <h3>\${esc(c.title||'Card')}</h3>
            <p>\${esc(c.subtitle||c.text||'')}</p>
          </div>
          <div class="cardBot">
            <span class="mode">\${modeLabel}</span>
            <div class="arrow">‚Ä∫</div>
          </div>\`;
        el.onclick=()=>{
          if(mode==='soon'){ toast('Tez kunda ‚úÖ'); return; }
          const href = c.href || c.ctaHref || '';
          if(href) location.href = href;
          else toast('Link yo‚Äòq');
        };
        wrap.appendChild(el);
      }
    }

    function paintUser(u){
      const fn=(u.firstName||'').trim(), ln=(u.lastName||'').trim();
      const name=(fn+' '+ln).trim() || 'Foydalanuvchi';
      $('chipName').textContent=name;
      $('chipId').textContent=\`ID: \${u.loginId || u.id || '‚Äî'} ‚Ä¢ \${u.points||0} pts\`;
      $('subline').textContent=\`Xush kelibsiz, \${name}!\`;

      $('menuName').textContent = name;
      $('menuMeta').textContent = \`ID: \${u.loginId || u.id || '‚Äî'} ‚Ä¢ \${u.points||0} pts\`;

      $('pts').textContent=u.points||0;
      $('region').textContent=u.region||'‚Äî';
      $('district').textContent=u.district||'‚Äî';
      $('birth').textContent=u.birthdate||'‚Äî';

      setAvatar($('avatar'), u.avatar, fn);
      setAvatar($('menuAv'), u.avatar, fn);
      setAvatar($('avatarPreview'), u.avatar, fn);
    }

    function setAvatar(node, avatar, fallback){
      node.innerHTML='';
      if(avatar){
        const img=document.createElement('img');
        img.src=avatar;
        img.alt='avatar';
        node.appendChild(img);
      }else{
        node.textContent=(fallback?fallback[0]:'U').toUpperCase();
      }
    }

    async function refreshMe(){
      const out = await lmApi.me();
      ME = out.user;
      paintUser(ME);
      return ME;
    }

    // Profile modals
    function openProfile(){
      const u=ME||{};
      $('pId').value = u.loginId || u.id || '';
      $('pPoints').value = u.points || 0;
      $('pFirst').value = u.firstName || '';
      $('pLast').value = u.lastName || '';
      $('pRegion').value = u.region || '';
      $('pDistrict').value = u.district || '';
      $('pBirth').value = u.birthdate || '';
      $('pUpdated').value = u.updatedAt || '';
      $('profileModal').classList.add('open');
    }
    function closeProfile(){ $('profileModal').classList.remove('open'); }

    function openEdit(){
      const u = ME || {};
      $('firstName').value = u.firstName || '';
      $('lastName').value = u.lastName || '';
      $('birthdate').value = u.birthdate || '';
      if(u.region) $('regionSel').value = u.region;
      updateDistricts(u.region || '', true);
      if(u.district) $('districtSel').value = u.district;

      $('pwBox').style.display='none';
      $('pwCur').value='';
      $('pwNew').value='';
      $('editModal').classList.add('open');
    }
    function closeEdit(){ $('editModal').classList.remove('open'); }

    function openAvatar(){
      avatarDataUrl=null;
      $('avatarFile').value='';
      setAvatar($('avatarPreview'), ME?.avatar, (ME?.firstName||'U'));
      $('avatarModal').classList.add('open');
    }
    function closeAvatar(){ $('avatarModal').classList.remove('open'); }

    async function onAvatarFile(){
      const f = $('avatarFile').files && $('avatarFile').files[0];
      if(!f) return;
      if(f.size > 2_000_000){ toast('Rasm 2MB dan katta.'); return; }
      const data = await fileToDataUrl(f);
      const resized = await resizeImage(data, 256);
      avatarDataUrl = resized;
      setAvatar($('avatarPreview'), avatarDataUrl, 'U');
    }

    async function saveAvatar(){
      if(!avatarDataUrl){ toast('Avval rasm tanlang.'); return; }
      try{
        await lmApi.userAvatar({ avatar: avatarDataUrl });
        toast('Avatar saqlandi ‚úÖ');
        await refreshMe();
        closeAvatar();
      }catch(e){
        toast(e?.message || 'Xatolik');
      }
    }

    // profile save
    async function saveProfile(){
      const firstName=$('firstName').value.trim();
      const lastName=$('lastName').value.trim();
      const region=$('regionSel').value.trim();
      const district=$('districtSel').value.trim();
      const birthdate=$('birthdate').value.trim();

      if(!firstName) return toast('Ism kiriting.');
      if(!region) return toast('Viloyat tanlang.');
      if(!district) return toast('Tuman tanlang.');
      if(!birthdate) return toast('Tug‚Äòilgan sana kiriting.');

      try{
        await lmApi.userPatch({ firstName, lastName, region, district, birthdate });
        toast('Saqlandi ‚úÖ');
        await refreshMe();
        closeEdit();
      }catch(e){ toast(e?.message || 'Xatolik'); }
    }

    async function changePassword(){
      const currentPassword=$('pwCur').value.trim();
      const newPassword=$('pwNew').value.trim();
      if(!currentPassword) return toast('Joriy parolni kiriting.');
      if(!newPassword || newPassword.length<6) return toast('Yangi parol kamida 6 belgi.');

      try{
        await lmApi.changePassword(currentPassword, newPassword);
        toast('Parol yangilandi ‚úÖ');
        $('pwBox').style.display='none';
        $('pwCur').value=''; $('pwNew').value='';
      }catch(e){ toast(e?.message || 'Xatolik'); }
    }

    // region helpers
    function fillRegions(data){
      const sel=$('regionSel');
      if(!data||!data.regions) return;
      sel.innerHTML='<option value="">Tanlang‚Ä¶</option>';
      data.regions.forEach(r=>{ const o=document.createElement('option'); o.value=r.name; o.textContent=r.name; sel.appendChild(o); });
    }
    function updateDistricts(region, keep=false){
      const ds=$('districtSel');
      ds.innerHTML='<option value="">Tanlang‚Ä¶</option>';
      ds.disabled=!region;
      if(!regionData||!region) return;
      const r=regionData.regions.find(x=>x.name===region);
      if(!r) return;
      r.districts.forEach(d=>{ const o=document.createElement('option'); o.value=d; o.textContent=d; ds.appendChild(o); });
      if(!keep) ds.value='';
    }

    // utils
    function esc(s){ return String(s||'').replace(/[&<>"']/g,(c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

    function fileToDataUrl(file){
      return new Promise((resolve,reject)=>{
        const r=new FileReader();
        r.onload=()=>resolve(String(r.result||''));
        r.onerror=()=>reject(r.error||new Error('File error'));
        r.readAsDataURL(file);
      });
    }

    async function resizeImage(dataUrl, size){
      // resize to square canvas (contain)
      const img = await new Promise((res,rej)=>{
        const i=new Image(); i.onload=()=>res(i); i.onerror=()=>rej(new Error('Image load')); i.src=dataUrl;
      });
      const c=document.createElement('canvas');
      c.width=size; c.height=size;
      const ctx=c.getContext('2d');
      ctx.clearRect(0,0,size,size);
      // background transparent
      const scale=Math.min(size/img.width, size/img.height);
      const w=img.width*scale, h=img.height*scale;
      const x=(size-w)/2, y=(size-h)/2;
      ctx.drawImage(img, x, y, w, h);
      return c.toDataURL('image/png', 0.92);
    }
  </script>
</body>
</html>
