<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>LeaderMath ‚Äî Namangan shahar 1-son ixtisoslashtirilgan maktab internati</title>
  <meta name="theme-color" content="#2E8B57" id="meta-theme-color"/>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./favicon.png">
  <style>
    :root{
      --brand:#2E8B57;--brand2:#1F6B45;
      --bg:#f4f8f6;--text:#0d1b14;--muted:#375c4c;--card:#ffffff;
      --frame:#d8e7dd;--frame-strong:#b7d6c5;--chip:#eaf6f0;--chip-b:#cfe7db;
      --radius:16px; --ring:#8ad1b1;
    }
    :root.dark{
      --bg:#0e1512; --text:#EAF7EE; --muted:#A5C7B4; --card:#142018;
      --frame:#244b39; --frame-strong:#2f6b52; --chip:#132a20; --chip-b:#2a5742; --ring:#2fbf7d;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .modal-open{overflow:hidden}

    /* Appbar */
    .appbar{position:sticky;top:0;z-index:90;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:10px 12px;display:flex;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
    .logo{width:40px;height:40px;border-radius:14px;background:#fff2;display:grid;place-items:center;font-weight:800}
    .title{font-weight:800;font-size:18px}
    .spacer{flex:1}
    .iconbtn{background:#ffffff22;border:1px solid #ffffff33;color:#fff;border-radius:12px;padding:8px 10px;font-weight:700;cursor:pointer}

    /* USER BAR */
    .userbar{
      background:var(--card);border:1px solid var(--frame);border-radius:14px;margin:10px 12px;padding:12px;
      display:grid;grid-template-columns:56px 1fr auto;grid-template-areas:
        "ava name chip"
        "ava meta chip";
      column-gap:12px;row-gap:6px;box-shadow:0 8px 20px #0001
    }
    @media(max-width:560px){
      .userbar{
        grid-template-columns:56px 1fr;grid-template-areas:
          "ava name"
          "ava mstats"
          "chip chip";
      }
    }
    .ava{grid-area:ava;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand2));display:grid;place-items:center;color:#fff;font-weight:900;overflow:hidden}
    .ava img{width:100%;height:100%;object-fit:cover}
    .uinfo{grid-area:name}
    .uinfo b{display:block;font-size:16px;line-height:1.15}
    .uinfo .meta{grid-area:meta;color:var(--muted);font-size:12px}
    .uvals{grid-area:chip;text-align:right;align-self:center}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-b);font-size:12px}
    .link{color:inherit;text-decoration:underline dotted}
    .ustars{display:inline-flex;gap:3px;margin-left:8px;vertical-align:middle}
    .btn-primary{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;font-weight:800;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;border:1px solid #0000;box-shadow:0 6px 16px rgba(46,139,87,.25)}
    .btn-primary:hover{filter:brightness(1.02)} .btn-primary:active{transform:translateY(1px)}

    /* Banner */
    .banner{margin:10px 12px;border-radius:18px;overflow:hidden;border:1px solid var(--frame);box-shadow:0 8px 22px rgba(0,0,0,.08);background:linear-gradient(135deg,#f0fff6,#e7f6ee)}
    .dark .banner{background:linear-gradient(135deg,#11231b,#0d1914)}

    /* Glass + gradient border */
    .glass{background:rgba(255,255,255,.6);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)}
    .dark .glass{background:rgba(20,32,24,.55)}
    .grad-border{position:relative}
    .grad-border::before{
      content:""; position:absolute; inset:0; padding:1px; border-radius:14px;
      background:linear-gradient(135deg, #9ce8c0, #2E8B57 40%, #39B6FF);
      -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
      -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none;
    }

    /* ==== FILTERLAR ==== */
    .filters{margin:10px 12px;padding:10px;background:var(--card);border:1px solid var(--frame);
      border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.06)}
    .filters h4{margin:0 0 8px;font-size:14px;opacity:.75}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip.filter{cursor:pointer;background:var(--chip);border:1px solid var(--chip-b)}
    .chip.filter[aria-pressed="true"]{background:linear-gradient(135deg,var(--brand),var(--brand2));border-color:#0000;color:#fff}
    .chip.sm{font-size:11px;padding:5px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-b)}

    /* Leaderboard */
    .board{background:var(--card);border:1px solid var(--frame);border-radius:16px;margin:10px 12px;padding:12px;border:none}
    .board h3{margin:0 0 8px;font-size:16px}
    .group{border:none;border-radius:14px;overflow:hidden;margin:10px 0;box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .board .group + .group{margin-top:14px}
    .groupBody{padding:12px}
    .groupHead{position:relative;border:none;border-radius:14px;padding:14px 16px;color:var(--muted);font-weight:900;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .dark .groupHead{color:#c7ffe7}
    .groupHead.tier-bronze{background:linear-gradient(135deg,#fff1e6,#ffd9c2)}
    .groupHead.tier-silver{background:linear-gradient(135deg,#f4f7fb,#dfe7f4)}
    .groupHead.tier-gold{background:linear-gradient(135deg,#fff4cc,#ffe48a)}
    .groupHead.tier-emerald{background:linear-gradient(135deg,#e3f8ee,#c9f1df)}
    .groupHead.tier-diamond{background:linear-gradient(135deg,#e8f8ff,#d8f1ff)}
    .tier-badge{font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--frame);background:rgba(255,255,255,.4)}
    .legend{display:flex;align-items:center;gap:8px;font-size:12px;opacity:.9}

    .rank{display:grid;grid-template-columns:54px 1fr auto;gap:12px;align-items:center;padding:10px;border-radius:12px;border:1px solid var(--frame);margin-bottom:8px;background:var(--card);box-shadow:0 2px 6px rgba(0,0,0,.04);transition:.2s;border:none;position:relative}
    .rank:hover{transform:scale(1.02);box-shadow:0 10px 28px rgba(46,139,87,.28)}
    .rnk{font-weight:900;background:var(--chip);border:1px solid var(--frame);padding:6px 10px;border-radius:10px}
    .medal{font-size:22px;line-height:1}
    .m1,.m2,.m3{display:inline-block;width:40px;text-align:center}
    @keyframes pulse-glow{0%{filter:drop-shadow(0 0 0 rgba(255,200,0,.0))}100%{filter:drop-shadow(0 0 8px rgba(255,200,0,.55))}}
    .m1,.m2,.m3{animation:pulse-glow 1.6s ease-in-out infinite alternate}

    /* Stars / Diamonds */
    .stars{display:inline-flex;gap:3px;vertical-align:middle}
    .tier-bronze .stars{--s:16}
    .tier-silver .stars{--s:17}
    .tier-gold .stars{--s:18}
    .tier-emerald .stars{--s:20}
    .tier-diamond .stars{--s:24}
    .stars svg{width:calc(var(--s)*1px);height:calc(var(--s)*1px)}

    /* Pager */
    .pager{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:8px 0}
    .pager .pbtn{background:var(--chip);border:1px solid var(--frame);border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer}
    .pager .pbtn[disabled]{opacity:.5;cursor:not-allowed}
    .pager .pinfo{font-size:12px;color:var(--muted)}

    /* Cards grid */
    .container{padding:6px 12px 90px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:560px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card);border:1px solid var(--frame);border-radius:14px;overflow:hidden;box-shadow:0 10px 24px rgba(0,0,0,.06);position:relative;transition:transform .18s ease, box-shadow .18s ease}
    .card:hover{transform:translateY(-3px);box-shadow:0 14px 36px rgba(0,0,0,.12)}
    .thumb{aspect-ratio:16/9;background:linear-gradient(135deg,#e9f5ef,#f6fbf8);display:grid;place-items:center}
    .dark .thumb{background:linear-gradient(135deg,#122019,#0f1714)}
    .badge{position:absolute;top:10px;left:10px;border-radius:999px;padding:6px 10px;background:linear-gradient(135deg,#2E8B57,#1F6B45);color:#fff;font-weight:800}
    .badge::after{content:"";position:absolute;inset:-1px;border-radius:999px;background:conic-gradient(from 0deg,#7fffd4 0%, transparent 20%, transparent 60%, #7fffd4 80%, #7fffd4 100%);-webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);-webkit-mask-composite:xor; mask-composite:exclude; animation:shimmer 2.6s linear infinite;}
    @keyframes shimmer{to{transform:rotate(360deg)}}
    .body{padding:12px}
    .name{font-size:16px;font-weight:900;margin:0 0 6px}
    .desc{font-size:13px;color:var(--muted);margin:0 0 10px}
    .actions{display:flex;gap:8px}
    .btn{flex:1;display:inline-flex;align-items:center;justify-content:center;gap:8px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer;text-decoration:none}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn.ghost{background:#fff;color:#1F6B45;border:1px solid var(--frame)}
    .meta{font-size:12px;color:var(--muted);margin-top:6px;display:flex;gap:10px;align-items:center}
    .countdown{font-weight:800}

    /* Diamond shine & TOP-3 glow */
    .tier-diamond .stars{ position:relative; overflow:visible }
    .tier-diamond .stars::after{ content:""; position:absolute; top:-25%; bottom:-25%; left:-30%; width:40%; transform:skewX(-20deg); background:linear-gradient(90deg, transparent, rgba(255,255,255,.75), transparent); filter:blur(0.5px); pointer-events:none; animation:shineSweep 2.8s ease-in-out infinite; }
    @keyframes shineSweep{ 0%{left:-30%;opacity:0} 8%{opacity:.9} 60%{left:110%;opacity:0} 100%{left:110%;opacity:0} }
    .tier-diamond .stars svg{ filter:drop-shadow(0 0 6px rgba(57,182,255,.45)); animation:diamondTwinkle 2.2s ease-in-out infinite alternate; }
    @keyframes diamondTwinkle{ 0%{ transform:scale(1); opacity:.95 } 100%{ transform:scale(1.03); opacity:1 } }
    .rank.top-1{ box-shadow:0 10px 28px rgba(255,215,0,.35), 0 0 24px rgba(255,215,0,.22) inset; animation:crownPulseGold 1.8s ease-in-out infinite; }
    .rank.top-2{ box-shadow:0 10px 28px rgba(150,180,210,.35), 0 0 24px rgba(180,200,220,.20) inset; animation:crownPulseSilver 1.9s ease-in-out infinite; }
    .rank.top-3{ box-shadow:0 10px 28px rgba(198,148,98,.35), 0 0 24px rgba(198,148,98,.20) inset; animation:crownPulseBronze 2.0s ease-in-out infinite; }
    @keyframes crownPulseGold{ 0%{transform:scale(1)} 100%{transform:scale(1.01)} }
    @keyframes crownPulseSilver{ 0%{transform:scale(1)} 100%{transform:scale(1.009)} }
    @keyframes crownPulseBronze{ 0%{transform:scale(1)} 100%{transform:scale(1.008)} }

    /* MODAL */
    .modal-mask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:999}
    .modal{width:min(840px,94%);max-height:90vh;overflow:auto;background:var(--card);border-radius:18px;border:1px solid var(--frame-strong);box-shadow:0 24px 64px rgba(0,0,0,.35);padding:18px;background-image: radial-gradient(1200px 600px at 10% -20%, rgba(46,139,87,.08), transparent 55%), radial-gradient(1200px 600px at 110% 120%, rgba(57,182,255,.08), transparent 55%);}
    .ctl label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    .ctl input,.ctl textarea,.ctl select{width:100%;padding:11px 12px;border:1px solid var(--frame);border-radius:12px;font:inherit;background:var(--card);color:var(--text);outline:none;transition:border .15s, box-shadow .15s}
    .ctl input:focus{ border-color:var(--ring); box-shadow:0 0 0 4px color-mix(in srgb, var(--ring) 25%, transparent) }
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    @media(max-width:560px){ .grid2,.grid3{grid-template-columns:1fr} }
    .row{display:flex;gap:8px;justify-content:flex-end;margin-top:14px}
    .danger{color:#c62828;font-size:12px;margin-right:auto}
    .btn-ghost{background:#ffffff; border:1px solid var(--frame); border-radius:12px; padding:9px 12px; cursor:pointer}
    .btn-solid{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}

    /* === MOBILE USER CHIPS === */
    .mstats{display:none;margin-top:6px;gap:6px;flex-wrap:wrap}
    .mchip{display:inline-flex;align-items:center;gap:6px;max-width:100%;padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-b);font-size:12px;line-height:1;white-space:nowrap}
    .mchip .txt{display:inline-block;max-width:180px;text-overflow:ellipsis;overflow:hidden}
    @media(max-width:560px){
      .uinfo .meta{display:none}
      .mstats{display:flex}
      .mchip .txt{max-width:120px}
    }
	.logo {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 48px;
  width: 48px;
  border-radius: 12px;
  overflow: hidden;
}

.logo img {
  width: 100%;
  height: 100%;
  object-fit: contain; /* yoki cover ‚Äî agar to‚Äòliq to‚Äòldirishni xohlasangiz */
}

  </style>
</head>
<body>
  <!-- Appbar -->
  <header class="appbar">
    <div class="logo">
  <img src="./icon-512.png" alt="LeaderMath Logo">
</div>
    <div><div class="title">LeaderMath</div><div class="sub">BSB / CHSB / ONLINE OLIMPIADA / DTM / va turli testlar va dars resurslari</div></div>
    <div class="spacer"></div>
    <button id="themeBtn" class="iconbtn" title="Dark/Light">üåô</button>
  </header>

  <!-- USERBAR -->
  <section class="userbar" id="userbar">
    <div class="ava" id="ava">LM</div>
    <div class="uinfo">
      <b id="uname">Mehmon
        <span id="userTierStars" class="ustars"></span>
      </b>

      <!-- Mobil uchun chiplar -->
      <div class="mstats" id="mstats"></div>

      <!-- Desktop meta -->
      <div class="meta">
        <span id="uid">ID: ‚Äî</span> ¬∑
        <span id="uregion">Viloyat: ‚Äî</span> ¬∑
        <span id="udistrict">Tuman: ‚Äî</span> ¬∑
        <span id="uschool">Maktab: ‚Äî</span> ¬∑
        <span id="uclass">Sinf: ‚Äî</span> ¬∑
        <span id="urank">O‚Äòrin: ‚Äî</span> ¬∑
        <span id="utier">Daraja: ‚Äî</span>
      </div>
    </div>
    <div class="uvals">
      <div class="chip" style="margin-bottom:6px">
        <b id="points">Ball: ‚Äî</b>
        <span id="userStarsPts" class="ustars"></span>
      </div>
      <div style="font-size:12px">
        <a href="#" id="signin" class="btn-primary">Kirish</a>
        ¬∑ <a href="#" id="editProfile" class="link" style="display:none">Profil</a>
        ¬∑ <a href="#" id="signout" class="link" style="display:none">Chiqish</a>
      </div>
    </div>
  </section>

  <!-- Banners -->
  <section id="banners"></section>

  <!-- Leaderboard -->
  <section class="board grad-border glass" id="board">
    <h3>Top 50 ‚Äî Ball bo‚Äòyicha (o‚Äòntalik pager)</h3>
    <div class="pager">
      <button id="decilePrev" class="pbtn">‚¨ÖÔ∏è Oldingi (10)</button>
      <div class="pinfo" id="decileInfo">10‚Äì1 (Diamond)</div>
      <button id="decileNext" class="pbtn">Keyingi (10) ‚û°Ô∏è</button>
    </div>
    <div id="boardList"></div>
  </section>

  <!-- GLOBAL MAIN TAGS (Top 50 dan pastda, bo‚Äòlimlardan yuqorida) -->
  <section class="filters grad-border glass" id="filtersMain">
    <h4>Katta teglar (bo‚Äòlimlar) bo‚Äòyicha:</h4>
    <div id="mainTags" class="chips"></div>
  </section>

  <!-- Sections (cards) -->
  <div class="container">
    <div id="sections"></div>
  </div>

  <!-- Profile modal -->
  <div id="profileModal" class="modal-mask" aria-modal="true" role="dialog">
    <div class="modal">
      <h3>Profil ma‚Äôlumotlari (majburiy)</h3>
      <div class="grid2">
        <div class="ctl"><label>Ism *</label><input id="pFirst"></div>
        <div class="ctl"><label>Familiya *</label><input id="pLast"></div>
      </div>
      <div class="grid3">
        <div class="ctl"><label>Viloyat *</label><input id="pRegion" placeholder="Namangan"></div>
        <div class="ctl"><label>Tuman/Shahar *</label><input id="pDistrict" placeholder="Yangiqo‚Äòrg‚Äòon"></div>
        <div class="ctl"><label>Maktab nomi *</label><input id="pSchool" placeholder="1-maktab"></div>
      </div>
      <div class="grid2">
        <div class="ctl"><label>Sinf *</label><input id="pClass" placeholder="9-A"></div>
        <div class="ctl"><label>Telefon *</label><input id="pPhone" placeholder="+998 XX XXX XX XX"></div>
      </div>
      <div class="row">
        <div class="danger" id="pError"></div>
        <button id="pSave" class="btn-solid">Saqlash</button>
        <button id="pClose" class="btn-ghost">Yopish</button>
      </div>
    </div>
  </div>

<script type="module">
  // --- Always unlock scroll on load
  document.body.classList.remove('modal-open');

  // Theme
  const root=document.documentElement, themeBtn=document.getElementById('themeBtn'), THEME_KEY='lm-theme';
  const setTheme=m=>{root.classList.toggle('dark',m==='dark');localStorage.setItem(THEME_KEY,m);themeBtn.textContent=m==='dark'?'‚òÄÔ∏è':'üåô'};
  setTheme(localStorage.getItem(THEME_KEY)||(matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
  themeBtn.onclick=()=>setTheme(root.classList.contains('dark')?'light':'dark');
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./service-worker.js'); }

  // Firebase
  import { auth, db, signOut } from './lib/firebase.client.js';
  import { watchAuth } from './lib/auth-guard.js';
  import { doc, getDoc, setDoc, runTransaction, collection, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // ---- Elements
  const el = {
    uname: document.getElementById('uname'), uid: document.getElementById('uid'),
    uregion: document.getElementById('uregion'), udistrict: document.getElementById('udistrict'),
    uschool: document.getElementById('uschool'), uclass: document.getElementById('uclass'),
    urank: document.getElementById('urank'), utier: document.getElementById('utier'),
    points: document.getElementById('points'),
    ava: document.getElementById('ava'), signin: document.getElementById('signin'),
    signout: document.getElementById('signout'), editProfile: document.getElementById('editProfile'),
    banners: document.getElementById('banners'), sections: document.getElementById('sections'),
    boardList: document.getElementById('boardList'),
    decilePrev: document.getElementById('decilePrev'), decileNext: document.getElementById('decileNext'), decileInfo: document.getElementById('decileInfo'),
    userTierStars: document.getElementById('userTierStars'), userStarsPts: document.getElementById('userStarsPts'),
    mainTags: document.getElementById('mainTags'),
    mstats: document.getElementById('mstats')
  };

  // ---- Modal helpers
  const PM = {
    mask: document.getElementById('profileModal'),
    first: document.getElementById('pFirst'), last: document.getElementById('pLast'),
    region: document.getElementById('pRegion'), district: document.getElementById('pDistrict'),
    school: document.getElementById('pSchool'), klass: document.getElementById('pClass'),
    phone: document.getElementById('pPhone'), err: document.getElementById('pError'),
    save: document.getElementById('pSave'), close: document.getElementById('pClose'),
  };
  const isModalVisible=()=> PM.mask && getComputedStyle(PM.mask).display!=='none';
  function openProfileModal(pref={}){
    PM.first.value=pref.first||''; PM.last.value=pref.last||'';
    PM.region.value=pref.region||''; PM.district.value=pref.district||'';
    PM.school.value=pref.school||''; PM.klass.value=pref.klass||'';
    PM.phone.value=pref.phone||''; PM.err.textContent='';
    PM.mask.style.display='flex'; document.body.classList.add('modal-open');
  }
  function closeProfileModal(){ PM.mask.style.display='none'; document.body.classList.remove('modal-open'); }
  PM.close.onclick=closeProfileModal;
  new MutationObserver(()=>{ if(isModalVisible()) document.body.classList.add('modal-open'); else document.body.classList.remove('modal-open'); })
    .observe(PM.mask,{attributes:true,attributeFilter:['style','class']});
  window.addEventListener('keydown',e=>{ if(e.key==='Escape'&&isModalVisible()) closeProfileModal(); });

  // ---- Utils
  function initials(n){ if(!n) return 'LM'; const p=n.trim().split(/\s+/); return (p[0]?.[0]||'L')+(p[1]?.[0]||'M'); }
  function profileIsComplete(u){ return !!(u && u.name && /\s/.test(u.name) && u.region && u.district && u.school && u.class && u.phone); }
  const toMs=v=> v? (new Date(v)).getTime():null;
  const fmt=(ms)=>{ if(ms<=0) return '00:00:00'; const s=Math.floor(ms/1000); const h=String(Math.floor(s/3600)).padStart(2,'0'); const m=String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${h}:${m}:${ss}`; };
  const escapeHtml=(s)=>String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  function fmtPoints(v){ const n = Number(v)||0; return n.toLocaleString('uz-UZ',{maximumFractionDigits:1}); }

  // ==== GLOBAL FILTR STATE ====
  let FILTER = { main: null }; // faqat katta teg
  const SECTION_FILTERS = new Map(); // har bo'lim uchun: key -> Set(sub-tags)

  const byText = (txt)=> document.createTextNode(txt);
  function chipEl(label, pressed=false, onClick=()=>{}, extraClass=''){
    const b=document.createElement('button');
    b.className='chip filter '+extraClass;
    b.type='button';
    b.setAttribute('aria-pressed', pressed?'true':'false');
    b.appendChild(byText(label));
    b.onclick=()=> onClick(b);
    return b;
  }

  function collectMainTags(data){
    const main=new Set();
    (data.sections||[]).forEach(sec=>{ if(sec.tag) main.add(String(sec.tag)); });
    return [...main].sort();
  }
  function getSecKey(sec){ return (sec.title||'')+'__'+(sec.tag||''); }

  function renderMainChips(tags){
    const wrap=el.mainTags; wrap.innerHTML='';
    wrap.appendChild(chipEl('Hammasi', FILTER.main===null, ()=>{
      FILTER.main=null; renderAll();
    }));
    tags.forEach(t=>{
      wrap.appendChild(chipEl(t, FILTER.main===t, ()=>{
        FILTER.main = (FILTER.main===t? null : t);
        renderAll();
      }));
    });
  }

  // ---- Cards (with per-section subfilters)
  function computeState(it, now){
    const t=it.type||'open', start=toMs(it.startAt), end=toMs(it.endAt);
    if(t==='open') return {status:'open'};
    if(t==='coming_soon') return {status:'soon'};
    if(t==='window'){ if(!start||!end) return {status:'open'}; if(now<start) return {status:'locked_until', left:start-now}; if(now<=end) return {status:'open'}; return {status:'closed'}; }
    return {status:'open'};
  }

  function sectionTags(sec){
    const s=new Set();
    (sec.items||[]).forEach(it=> (it.tags||[]).forEach(t=> s.add(String(t))));
    return [...s].sort();
  }

  function renderSection(sec){
    const key = getSecKey(sec);
    if(!SECTION_FILTERS.has(key)) SECTION_FILTERS.set(key, new Set());
    const subSel = SECTION_FILTERS.get(key);

    // sarlavha
    const title=document.createElement('h3');
    title.style.margin='10px 6px'; title.style.fontSize='15px'; title.style.opacity='.8';
    title.innerHTML = escapeHtml(sec.title||'Bo‚Äòlim') + (sec.tag ? ` ‚Äî <span style="font-weight:600;opacity:.9">${escapeHtml(sec.tag)}</span>` : '');

    // bo'lim ichidagi sub-tag chiplar
    const subWrap=document.createElement('section');
    subWrap.className='filters grad-border glass';
    subWrap.innerHTML = `<h4>Bu bo‚Äòlim uchun kichik teglar:</h4><div class="chips"></div>`;
    const chipsRow = subWrap.querySelector('.chips');

    const tags = sectionTags(sec);
    if(tags.length===0){
      chipsRow.innerHTML = `<span class="chip sm" style="opacity:.7">Teglar yo‚Äòq</span>`;
    }else{
      // Reset
      chipsRow.appendChild(chipEl('Reset', subSel.size===0, ()=>{
        subSel.clear(); renderAll();
      }, 'sm'));
      // tags
      tags.forEach(t=>{
        const pressed = subSel.has(t);
        chipsRow.appendChild(chipEl(t, pressed, (btn)=>{
          const on = btn.getAttribute('aria-pressed')==='true';
          if(on){ subSel.delete(t); btn.setAttribute('aria-pressed','false'); }
          else { subSel.add(t); btn.setAttribute('aria-pressed','true'); }
          renderAll();
        }, 'sm'));
      });
    }

    // grid
    const grid=document.createElement('div'); grid.className='grid';

    // filter items by section subSel (ANY)
    let items = (sec.items||[]);
    if(subSel.size>0){
      const want=[...subSel];
      items = items.filter(it=>{
        const tags=(it.tags||[]).map(String);
        return want.some(t=> tags.includes(t));
      });
    }

    items.forEach(it=>{
      const card=document.createElement('article'); card.className='card grad-border glass';
      const best=it.best?'<div class="badge">BEST</div>':'';
      const slug=(it.name||'').replace(/\W+/g,'-');
      card.innerHTML=`
        <div class="thumb"><div style="font-weight:900;opacity:.75">${escapeHtml(it.name||'')}</div>${best}</div>
        <div class="body">
          <h3 class="name">${escapeHtml(it.name||'')}</h3>
          ${it.description?`<p class="desc">${escapeHtml(it.description)}</p>`:''}
          <div class="actions">
            <a class="btn" id="start-${slug}">Boshlash</a>
            <button class="btn ghost" disabled id="info-${slug}">Info</button>
          </div>
          <div class="meta">
            <span class="countdown" data-id="${slug}"></span>
          </div>
          <div class="chips" style="margin-top:8px">
            ${(it.tags||[]).map(t=> `<span class="chip sm">${escapeHtml(String(t))}</span>`).join('')}
          </div>
        </div>`;

      const startBtn=card.querySelector(`#start-${slug}`);
      const cdEl=card.querySelector(`[data-id="${slug}"]`);
      const tick=()=>{ const st=computeState(it,Date.now());
        if(st.status==='open'){ startBtn.removeAttribute('disabled'); startBtn.setAttribute('href', it.link||'#'); cdEl.textContent=''; }
        else if(st.status==='soon'){ startBtn.setAttribute('disabled','1'); startBtn.removeAttribute('href'); cdEl.textContent='Tez orada'; }
        else if(st.status==='locked_until'){ startBtn.setAttribute('disabled','1'); startBtn.removeAttribute('href'); cdEl.textContent='Qolgan vaqt: '+fmt(st.left); }
        else { startBtn.setAttribute('disabled','1'); startBtn.removeAttribute('href'); cdEl.textContent='Tugadi'; }
      };
      tick(); setInterval(tick,1000); grid.appendChild(card);
    });

    // bo'lim blokini qaytarish
    const frag=document.createDocumentFragment();
    frag.appendChild(title);
    frag.appendChild(subWrap);
    if(items.length===0){
      const empty=document.createElement('div');
      empty.className='desc'; empty.style.margin='0 6px 10px'; empty.style.opacity='.7';
      empty.textContent='Bu bo‚Äòlim uchun tanlangan teg(lar) bo‚Äòyicha ma‚Äôlumot topilmadi.';
      frag.appendChild(empty);
    }
    frag.appendChild(grid);
    return frag;
  }

  function renderCards(data){
    const wrap=el.sections; wrap.innerHTML='';

    // main tag bo'yicha bo'lim filtri
    const sections = (data.sections||[]).filter(sec=>{
      if(!FILTER.main) return true;
      return (sec.tag && String(sec.tag)===FILTER.main);
    });

    if(sections.length===0){
      const empty=document.createElement('div');
      empty.className='desc'; empty.style.margin='10px 6px'; empty.style.opacity='.75';
      empty.textContent='Tanlangan katta teg bo‚Äòyicha bo‚Äòlim topilmadi.';
      wrap.appendChild(empty);
      return;
    }

    sections.forEach(sec=>{
      wrap.appendChild(renderSection(sec));
    });
  }

  (async function initContent(){
    try{
      const r=await fetch('./index.json',{cache:'no-store'});
      const data=await r.json();

      // Banners
      el.banners.innerHTML=(data.banners||[]).map(b=>`<div class="banner grad-border glass">${b.html||''}</div>`).join('');

      // Main tags (global)
      const mains = collectMainTags(data);
      renderMainChips(mains);

      // Dastlabki render
      window.__LM_DATA=data;
      renderCards(data);
    }catch(e){ console.error(e); }
  })();

  function renderAll(){
    if(!window.__LM_DATA) return;
    renderCards(window.__LM_DATA);
  }

  // ---- Leaderboard groups
  const GROUPS=[
    {label:'10‚Äì1 (Diamond)',start:1,end:10,tier:'diamond',grad:['#9FE3FF','#39B6FF','#0077FF']},
    {label:'20‚Äì11 (Emerald)',start:11,end:20,tier:'emerald',grad:['#8FE3B0','#2E8B57','#1F6B45']},
    {label:'30‚Äì21 (Gold)',start:21,end:30,tier:'gold',grad:['#FFE082','#FFC107','#FF8F00']},
    {label:'40‚Äì31 (Silver)',start:31,end:40,tier:'silver',grad:['#DDE3EC','#BFC6D4','#9AA6B2']},
    {label:'50‚Äì41 (Bronze)',start:41,end:50,tier:'bronze',grad:['#C69462','#9A6B3F','#7C4F2E']}
  ];
  let CURRENT_DECILE=0;

  function iconSVG(shape,fillPct,colors){
    const [c1,c2,c3]=colors, gid='g'+Math.random().toString(36).slice(2,8), cid='c'+Math.random().toString(36).slice(2,8);
    if(shape!=='diamond'){
      const pathStar='M12 2.3l2.9 5.9 6.5.9-4.7 4.5 1.1 6.4L12 17.8l-5.8 3.1 1.1-6.4L2.6 9.1l6.5-.9L12 2.3z';
      return `<svg viewBox="0 0 24 24" aria-hidden="true"><defs><linearGradient id="${gid}" x1="0" x2="1"><stop offset="0%" stop-color="${c1}"/><stop offset="50%" stop-color="${c2}"/><stop offset="100%" stop-color="${c3}"/></linearGradient><clipPath id="${cid}"><rect x="0" y="0" width="${fillPct}%" height="100%"/></clipPath></defs><path d="${pathStar}" fill="#d0dbd5"></path><path d="${pathStar}" fill="url(#${gid})" clip-path="url(#${cid})"></path></svg>`;
    }
    return `<svg viewBox="0 0 24 24" aria-hidden="true"><defs><linearGradient id="${gid}" x1="0" x2="1"><stop offset="0%" stop-color="${c1}"/><stop offset="50%" stop-color="${c2}"/><stop offset="100%" stop-color="${c3}"/></linearGradient><clipPath id="${cid}"><rect x="0" y="0" width="${fillPct}%" height="100%"/></clipPath></defs><path d="M12 2 L20.5 8.5 L12 22 L3.5 8.5 Z" fill="#cfe8ff"/><path d="M12 2 L20.5 8.5 L12 22 L3.5 8.5 Z" fill="url(#${gid})" clip-path="url(#${cid})"/><polygon points="6,8.5 9,4.7 12,4.7 9.6,8.5" fill="rgba(255,255,255,.35)"/><polygon points="12,4.7 15,4.7 18,8.5 14.4,8.5" fill="rgba(255,255,255,.25)"/><polygon points="6,8.5 9.6,8.5 12,12.2 8.4,12.2" fill="rgba(255,255,255,.18)"/><polygon points="18,8.5 14.4,8.5 12,12.2 15.6,12.2" fill="rgba(255,255,255,.12)"/><polygon points="9.6,8.5 14.4,8.5 12,12.2" fill="rgba(255,255,255,.22)"/><polygon points="8.4,12.2 12,22 12,12.2" fill="rgba(255,255,255,.2)"/><polygon points="15.6,12.2 12,22 12,12.2" fill="rgba(255,255,255,.16)"/><path d="M12 2 L20.5 8.5 L12 22 L3.5 8.5 Z" fill="none" stroke="rgba(255,255,255,.6)" stroke-width=".8"/><path d="M6 8.5 L9 4.7 L15 4.7 L18 8.5" fill="none" stroke="rgba(255,255,255,.55)" stroke-width=".7"/><path d="M6 8.5 L12 12.2 L18 8.5" fill="none" stroke="rgba(255,255,255,.45)" stroke-width=".7"/></svg>`;
  }
  function renderStars(count,tier){
    const g=GROUPS.find(x=>x.tier===tier)||GROUPS[0], shape=(tier==='diamond')?'diamond':'star';
    const full=Math.floor(count), half=(count-full>=0.5)?1:0, empty=5-full-half;
    const fullIcon=iconSVG(shape,100,g.grad), halfIcon=iconSVG(shape,50,g.grad), emptyIcon=iconSVG(shape,0,g.grad);
    return `<span class="stars">${Array.from({length:full}).map(()=>fullIcon).join('')}${half?halfIcon:''}${Array.from({length:empty}).map(()=>emptyIcon).join('')}</span>`;
  }

  function drawDecile(users,ix){
    const g=GROUPS[ix]; if(!g){ el.boardList.innerHTML='<div class="desc">Hali ma‚Äôlumot yo‚Äòq</div>'; return; }
    const arr=users.slice(0,50), rows=[], pos=(rank)=>g.end-rank+1, starsFor=(rank)=>0.5*pos(rank);
    for(let r=g.start;r<=g.end;r++){
      const u=arr[r-1]; if(!u) continue; const isTop3=r<=3;
      const left=isTop3?`<span class="medal ${r===1?'m1':r===2?'m2':'m3'}">${r===1?'üèÜ':r===2?'ü•à':'ü•â'}</span>`:`<span class="rnk">#${r}</span>`;
      rows.push(`<div class="rank grad-border glass tier-${g.tier} ${isTop3?('top-'+r):''}">
        <div>${left}</div>
        <div><b>${escapeHtml(u.name||'Foydalanuvchi')}</b><div class="desc">${escapeHtml(u.region||'‚Äî')} ¬∑ ${escapeHtml(u.district||'‚Äî')} ¬∑ ${escapeHtml(u.school||'‚Äî')}</div></div>
        <div style="text-align:right"><div><b>${fmtPoints(u.points)}</b></div>${renderStars(starsFor(r),g.tier)}</div>
      </div>`);
    }
    el.boardList.innerHTML=`<div class="group grad-border glass">
      <div class="groupHead tier-${g.tier}"><span class="tier-badge">${g.label}</span><span class="legend">${renderStars(3,g.tier)}</span></div>
      <div class="groupBody">${rows.join('')}</div></div>`;
    el.decileInfo.textContent=g.label; el.decilePrev.disabled=(ix<=0); el.decileNext.disabled=(ix>=GROUPS.length-1);
  }

  // ---- Rank + stars to userbar (desktop) + mobile chips
  const TIER_NAME = { diamond:'Olmos', emerald:'Zumrad', gold:'Oltin', silver:'Kumush', bronze:'Bronza' };

  function updateUserbarRank(sorted,currentUid){
    const idx=sorted.findIndex(u=>(u.uid||u.id||u.userId)===currentUid);
    if(idx===-1){ el.userTierStars.innerHTML=''; el.userStarsPts.innerHTML=''; el.urank.textContent='O‚Äòrin: ‚Äî'; el.utier.textContent='Daraja: ‚Äî'; renderMobileUserChips(); return; }
    const rank=idx+1; let g=null; for(const gr of GROUPS){ if(rank>=gr.start&&rank<=gr.end){ g=gr; break; } }
    if(!g){ el.userTierStars.innerHTML=''; el.userStarsPts.innerHTML=''; el.urank.textContent='O‚Äòrin: ‚Äî'; el.utier.textContent='Daraja: ‚Äî'; renderMobileUserChips({rank}); return; }
    const stars=0.5*(g.end-rank+1);
    const html=renderStars(stars,g.tier);
    el.userTierStars.innerHTML=html;   // ism yonida
    el.userStarsPts.innerHTML=html;    // ball chipida
    el.urank.textContent = `O‚Äòrin: #${rank}`;
    el.utier.textContent = `Daraja: ${TIER_NAME[g.tier]} ${stars.toFixed(1)}/5`;

    // mobil chiplar
    renderMobileUserChips({
      school: CURRENT_PROFILE?.school || null,
      klass: CURRENT_PROFILE?.class || null,
      points: CURRENT_PROFILE?.points ?? null,
      rank,
      tier: g.tier
    });
  }

  // === MOBILE CHIPS ===
  function renderMobileUserChips({school, klass, points, rank, tier} = {}){
    const host = el.mstats; if(!host) return;
    const chips = [];
    if(school) chips.push({emoji:'üè´', text:String(school)});
    if(klass)  chips.push({emoji:'üéí', text:String(klass)});
    if(points!=null) chips.push({emoji:'‚≠ê', text:(Number(points)||0).toLocaleString('uz-UZ')});
    if(rank!=null) chips.push({emoji:'üèÖ', text:'#'+rank});
    if(tier){
      const tn = TIER_NAME[tier] || tier;
      chips.push({emoji:'üíé', text:tn});
    }
    host.innerHTML = chips.map(c=>`<span class="mchip"><span>${c.emoji}</span><span class="txt">${escapeHtml(c.text)}</span></span>`).join('');
  }

  // ---- Auth + profile/live listeners
  let latestUsers=[], currentUserId=null, CURRENT_PROFILE=null;

  PM.save.onclick=async ()=>{
    PM.err.textContent='';
    const first=PM.first.value.trim(), last=PM.last.value.trim(),
          region=PM.region.value.trim(), district=PM.district.value.trim(),
          school=PM.school.value.trim(), klass=PM.klass.value.trim(), phone=PM.phone.value.trim();
    if(!first||!last||!region||!district||!school||!klass||!phone){ PM.err.textContent='Barcha maydonlar majburiy.'; return; }
    const name=`${first} ${last}`;
    try{
      const ref=doc(db,'users',currentUserId);
      await setDoc(ref,{name,region,district,school,class:klass,phone},{merge:true});
      el.uname.childNodes[0].nodeValue=name+' ';
      el.uregion.textContent='Viloyat: '+region; el.udistrict.textContent='Tuman: '+district; el.uschool.textContent='Maktab: '+school; el.uclass.textContent='Sinf: '+klass;
      CURRENT_PROFILE={...(CURRENT_PROFILE||{}),name,region,district,school,class:klass,phone};
      localStorage.setItem(`lm-profile-seen:${currentUserId}`,'1'); renderMobileUserChips({
        school, klass, points: CURRENT_PROFILE?.points ?? null,
        rank: (el.urank.textContent.match(/#(\d+)/)?.[1])||null,
        tier: (el.utier.textContent.toLowerCase().includes('olmos') && 'diamond') || null
      });
      closeProfileModal();
    }catch(e){ console.error('profile save error',e); PM.err.textContent='Saqlashda xatolik. Internetni tekshiring.'; }
  };

  el.signin.onclick=(e)=>{ e.preventDefault(); const ret=encodeURIComponent(location.pathname+location.search+location.hash); location.href=`./login.html?return=${ret}`; };
  el.signout.onclick=async (e)=>{ e.preventDefault(); await signOut(auth); const ret=encodeURIComponent('./index.html'); location.href=`./login.html?return=${ret}`; };
  el.editProfile.onclick=(e)=>{
    e.preventDefault();
    const u = CURRENT_PROFILE || {};
    const nm = (u.name || el.uname.textContent).trim().split(/\s+/,2);
    openProfileModal({
      first:nm[0]||'', last:nm[1]||'',
      region:u.region||'', district:u.district||'', school:u.school||'',
      klass:u.class||'', phone:u.phone||''
    });
  };

  async function ensureUser(user){
    const ref=doc(db,'users',user.uid);
    await runTransaction(db, async(tx)=>{
      const snap=await tx.get(ref);
      if(!snap.exists()){
        tx.set(ref,{ name:user.displayName|| (user.email?user.email.split('@')[0]:'Foydalanuvchi'), email:user.email||null, photoURL:user.photoURL||null, role:'user', numericId:Math.floor(1000+Math.random()*9000), points:0, region:null, district:null, school:null, class:null, phone:null, createdAt:Date.now() });
      }
    });
    return (await getDoc(ref)).data();
  }

  watchAuth(async (user)=>{
    if(!user){
      el.uname.childNodes[0].nodeValue='Mehmon ';
      el.uid.textContent='ID: ‚Äî'; el.uregion.textContent='Viloyat: ‚Äî'; el.udistrict.textContent='Tuman: ‚Äî'; el.uschool.textContent='Maktab: ‚Äî'; el.uclass.textContent='Sinf: ‚Äî';
      el.urank.textContent='O‚Äòrin: ‚Äî'; el.utier.textContent='Daraja: ‚Äî'; el.points.textContent='Ball: ‚Äî';
      el.ava.textContent='LM'; el.ava.style.backgroundImage=''; el.signin.style.display='inline-flex'; el.signout.style.display='none'; el.editProfile.style.display='none';
      el.userTierStars.innerHTML=''; el.userStarsPts.innerHTML=''; currentUserId=null; CURRENT_PROFILE=null;
      renderMobileUserChips(); // clear
      if(isModalVisible()) closeProfileModal();
      return;
    }
    el.signin.style.display='none'; el.signout.style.display='inline'; currentUserId=user.uid;

    // live listener for own profile
    onSnapshot(doc(db,'users',currentUserId),(snap)=>{
      CURRENT_PROFILE = snap.exists()?snap.data():null;
      if(CURRENT_PROFILE?.class) el.uclass.textContent='Sinf: '+CURRENT_PROFILE.class;
      // profil o'zgarsa mobil chiplarni yangilab turamiz
      renderMobileUserChips({
        school: CURRENT_PROFILE?.school || null,
        klass: CURRENT_PROFILE?.class || null,
        points: CURRENT_PROFILE?.points ?? null,
        rank: (el.urank.textContent.match(/#(\d+)/)?.[1]) ? Number(el.urank.textContent.match(/#(\d+)/)[1]) : null,
        tier: (el.utier.textContent.includes('Olmos') && 'diamond') ||
              (el.utier.textContent.includes('Zumrad') && 'emerald') ||
              (el.utier.textContent.includes('Oltin') && 'gold') ||
              (el.utier.textContent.includes('Kumush') && 'silver') ||
              (el.utier.textContent.includes('Bronza') && 'bronze') || null
      });
    });

    const u=await ensureUser(user);
    CURRENT_PROFILE=u;
    el.uname.childNodes[0].nodeValue=(u.name || user.displayName || (user.email?.split('@')[0] ?? 'Foydalanuvchi')) + ' ';
    el.uid.textContent='ID: '+(u.numericId || '‚Äî');
    el.uregion.textContent='Viloyat: '+(u.region || '‚Äî');
    el.udistrict.textContent='Tuman: '+(u.district || '‚Äî');
    el.uschool.textContent='Maktab: '+(u.school || '‚Äî');
    el.uclass.textContent='Sinf: '+(u.class || '‚Äî');
    el.points.textContent='Ball: '+fmtPoints(u.points);
    if(user.photoURL){ el.ava.innerHTML='<img src="'+user.photoURL+'" alt="ava">'; } else { el.ava.textContent=initials(el.uname.textContent); }
    el.editProfile.style.display='inline';

    const seenKey=`lm-profile-seen:${currentUserId}`;
    if(!profileIsComplete(u) && !localStorage.getItem(seenKey)){
      const nm=(u.name||'').trim().split(/\s+/,2);
      openProfileModal({ first:nm[0]||'', last:nm[1]||'', region:u.region||'', district:u.district||'', school:u.school||'', klass:u.class||'', phone:u.phone||'' });
    }else{ if(isModalVisible()) closeProfileModal(); }

    onSnapshot(query(collection(db,'users'), orderBy('points','desc'), limit(100)), (snap)=>{
      latestUsers = snap.docs.map(d=>({ id:d.id, uid:d.id, ...d.data() }))
        .sort((a,b)=> (Number(b.points)||0) - (Number(a.points)||0) ? (Number(b.points)||0) - (Number(a.points)||0) : (a.numericId??0)-(b.numericId??0));
      drawDecile(latestUsers, CURRENT_DECILE);
      updateUserbarRank(latestUsers, currentUserId); // desktop + mobile chips ichida ham chaqiriladi
    }, (err)=>{
      console.error('board error',err);
      el.boardList.innerHTML='<div class="desc">Leaderboard hozircha yopiq</div>';
      el.userTierStars.innerHTML=''; el.userStarsPts.innerHTML=''; el.urank.textContent='O‚Äòrin: ‚Äî'; el.utier.textContent='Daraja: ‚Äî';
      renderMobileUserChips(); // clear
    });
  });

  // Pager
  document.getElementById('decilePrev').onclick=()=>{ if(CURRENT_DECILE>0){ CURRENT_DECILE--; drawDecile(latestUsers,CURRENT_DECILE); } };
  document.getElementById('decileNext').onclick=()=>{ if(CURRENT_DECILE<GROUPS.length-1){ CURRENT_DECILE++; drawDecile(latestUsers,CURRENT_DECILE); } };
</script>
</body>
</html>
