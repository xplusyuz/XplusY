<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MathCenter ‚Äî Bosh sahifa</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    body{margin:0;font-family:Inter,system-ui}
    .container{max-width:1280px;margin:0 auto;padding:16px}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);align-items:center;justify-content:center;z-index:200}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 20px 44px rgba(0,0,0,.12);overflow:hidden}
    .gTab{border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:10px 14px;cursor:pointer;font-weight:700}
    .gTab.active{background:#2E8B57;color:#fff;border-color:transparent}
  </style>
</head>
<body>

  <!-- ‚ñº‚ñº‚ñº BU YERGA KANONIK HEADERINGIZNI QO'YING (Firebase + Promo) ‚ñº‚ñº‚ñº -->
  <div id="headerSlot" class="container" style="margin-top:12px">
    <div style="padding:12px;border:1px dashed #e5e7eb;border-radius:12px">
      <b>Header joyi</b> ‚Äî Sizning ‚ÄúMathCenter Header ‚Äî Firebase + Promo (yangilangan)‚Äù kodingiz shu yerda bo‚Äòladi.
    </div>
  </div>
  <!-- ‚ñ≤‚ñ≤‚ñ≤ HEADER TUGADI ‚ñ≤‚ñ≤‚ñ≤ -->

  <main class="container">

    <!-- Banner Carousel -->
    <section id="bannerCarousel" style="position:relative;overflow:hidden;border-radius:16px;border:1px solid #e5e7eb;box-shadow:0 10px 30px rgba(0,0,0,.06)">
      <div id="bannerTrack" style="display:flex;transition:transform .5s ease"></div>
      <button id="bnPrev" aria-label="Oldingi" style="position:absolute;left:8px;top:50%;transform:translateY(-50%);border:0;background:#fff;border-radius:50%;width:40px;height:40px;box-shadow:0 6px 16px rgba(0,0,0,.2)">‚Äπ</button>
      <button id="bnNext" aria-label="Keyingi" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);border:0;background:#fff;border-radius:50%;width:40px;height:40px;box-shadow:0 6px 16px rgba(0,0,0,.2)">‚Ä∫</button>
    </section>

    <!-- Katta menyu (glavniy teg) -->
    <nav style="display:flex;gap:8px;flex-wrap:wrap;margin:18px 0">
      <button class="gTab active" data-sec="tests">Testlar</button>
      <button class="gTab" data-sec="courses">Kurslar</button>
      <button class="gTab" data-sec="simulators">Simulyatorlar</button>
    </nav>

    <!-- Kichik taglar (chiplar) + qidiruv -->
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 12px">
      <input id="q" placeholder="Qidiruv‚Ä¶" style="padding:10px;border:1px solid #e5e7eb;border-radius:999px"/>
      <div id="chips" style="display:flex;gap:6px;flex-wrap:wrap"></div>
    </div>

    <!-- Cards grid -->
    <section id="grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px"></section>

    <!-- Pagination -->
    <div style="display:flex;justify-content:center;gap:10px;margin:16px 0">
      <button id="pgPrev">Oldingi</button>
      <div id="pgInfo" style="padding:10px 14px;border:1px solid #e5e7eb;border-radius:10px">1/1</div>
      <button id="pgNext">Keyingi</button>
    </div>
  </main>

  <!-- Batafsil modal -->
  <div id="detailModal" class="modal">
    <div class="card" style="width:92%;max-width:720px">
      <div style="display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,#2E8B57,#1F6B45);color:#fff;padding:14px 18px">
        <div id="dtTitle" style="font-weight:800"></div>
        <button id="dtClose" style="border:0;background:rgba(255,255,255,.25);width:36px;height:36px;border-radius:50%;color:#fff;font-size:18px">&times;</button>
      </div>
      <div style="padding:16px">
        <img id="dtImg" alt="" style="width:100%;max-height:260px;object-fit:cover;border-radius:12px"/>
        <div id="dtHtml" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const PAGE_SIZE = 18;
    const $ = s => document.querySelector(s);
    const grid = $('#grid');
    const chipsEl = $('#chips');
    const q = $('#q');
    const pgPrev = $('#pgPrev');
    const pgNext = $('#pgNext');
    const pgInfo = $('#pgInfo');
    const tabs = document.querySelectorAll('.gTab');
    const bannerTrack = document.getElementById('bannerTrack');

    let bnIdx = 0, bnTimer = null;
    let db = null;
    let section = 'tests';
    let activeTags = new Set();
    let page = 1;
    let timers = [];

    async function loadData(){
      const local = localStorage.getItem('__ADMIN_JSON');
      if(local){ try{ db = JSON.parse(local); }catch{} }
      if(!db){
        try{ const r=await fetch('admin.json?_=' + Date.now()); if(r.ok) db = await r.json(); }
        catch{}
      }
      if(!db) db = {banners:[], cards:{tests:[],courses:[],simulators:[]}};
    }

    function renderBanners(){
      bannerTrack.innerHTML='';
      (db.banners||[]).forEach(b=>{
        const d = document.createElement('div');
        d.style.cssText = 'min-width:100%;display:flex;align-items:center;gap:16px;padding:16px;background:'+ (b.bg||'#0b3d2c') +';color:#fff';
        d.innerHTML = `
          <div style="flex:1">
            <div style="font-size:28px;font-weight:800;line-height:1.1">${b.title||''}</div>
            <div style="opacity:.9;margin-top:6px">${b.subtitle||''}</div>
            ${b.link? `<a href="${b.link}" style="display:inline-block;margin-top:12px;padding:10px 14px;border-radius:10px;background:#fff;color:#0b3d2c;text-decoration:none;font-weight:700">Batafsil</a>`:''}
          </div>
          ${b.image? `<img src="${b.image}" alt="" style="width:520px;max-width:50%;border-radius:12px;object-fit:cover">`:''}
        `;
        bannerTrack.appendChild(d);
      });
      moveBanner(0);
      if(bnTimer) clearInterval(bnTimer);
      bnTimer = setInterval(()=> moveBanner(bnIdx+1), 5000);
      document.getElementById('bnPrev').onclick = ()=> moveBanner(bnIdx-1);
      document.getElementById('bnNext').onclick = ()=> moveBanner(bnIdx+1);
    }
    function moveBanner(i){
      const n = (db.banners||[]).length || 1;
      bnIdx = ( (i % n) + n ) % n;
      bannerTrack.style.transform = `translateX(-${bnIdx*100}%)`;
    }

    function buildTags(){
      const items = db.cards[section] || [];
      const all = new Set();
      items.forEach(it=> (it.tags||[]).forEach(t=> all.add(t)) );
      chipsEl.innerHTML='';
      all.forEach(tag=>{
        const b = document.createElement('button');
        b.textContent = tag; b.className='chip';
        b.style.cssText='padding:8px 12px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;cursor:pointer';
        if(activeTags.has(tag)) b.style.background='#E8F5E9';
        b.onclick=()=>{ if(activeTags.has(tag)) activeTags.delete(tag); else activeTags.add(tag); page=1; renderGrid(); };
        chipsEl.appendChild(b);
      });
    }

    function statusOf(it){
      if(it.mode !== 'online') return {label:null, state:'static'};
      const now = Date.now();
      const s = it.startAt? Date.parse(it.startAt): null;
      const e = it.endAt? Date.parse(it.endAt): null;
      if(s && now < s) return {label: 'Boshlashgacha', until: s, state:'before'};
      if(e && now > e) return {label: 'Vaqt tugadi', state:'after'};
      return {label: 'Boshlash', state:'open'};
    }

    function clearTimers(){ timers.forEach(x=> clearInterval(x)); timers=[]; }

    function renderGrid(){
      clearTimers();
      const query = (q.value||'').toLowerCase().trim();
      let items = [...(db.cards[section]||[])];
      items.sort((a,b)=> (b.best?1:0) - (a.best?1:0));
      if(activeTags.size){ items = items.filter(it => (it.tags||[]).some(t=> activeTags.has(t))); }
      if(query){ items = items.filter(it => (it.title||'').toLowerCase().includes(query)); }

      const total = items.length; const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      page = Math.min(Math.max(1,page), pages);
      const start = (page-1)*PAGE_SIZE; const slice = items.slice(start, start+PAGE_SIZE);

      grid.innerHTML='';
      slice.forEach(it=>{
        const st = statusOf(it);
        const card = document.createElement('article');
        card.style.cssText='border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;background:#fff;box-shadow:0 10px 24px rgba(0,0,0,.06)';
        card.innerHTML = `
          ${it.image? `<img src="${it.image}" alt="" style="width:100%;height:160px;object-fit:cover">`:''}
          <div style="padding:12px">
            <div style="display:flex;gap:6px;align-items:center;justify-content:space-between">
              <h3 style="margin:0;font-size:16px">${it.title||''}</h3>
              ${it.best? '<span style="padding:4px 8px;border:1px solid #e5e7eb;border-radius:999px;font-size:12px">BEST</span>':''}
            </div>
            <div style="margin:6px 0;color:#555;font-size:12px">${(it.tags||[]).join(' ‚Ä¢ ')}</div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px">
              <a href="${it.link||'#'}" class="btn-primary" data-role="action" style="padding:8px 12px;border-radius:10px;background:#2E8B57;color:#fff;text-decoration:none;font-weight:700">${st.label||'Batafsil'}</a>
              <button class="btn-ghost" data-role="detail" style="padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;background:#fff">Batafsil</button>
              ${it.prize? `<span style="font-size:12px;color:#0b3d2c">üèÖ ${it.prize}</span>`:''}
              ${st.state==='before'? `<span class="cd" data-until="${st.until}"></span>`:''}
            </div>
          </div>
        `;
        const act = card.querySelector('[data-role="action"]');
        if(it.mode==='online'){
          const st2 = statusOf(it);
          if(st2.state==='before'){ act.href = '#'; act.onclick = (e)=> e.preventDefault(); }
          if(st2.state==='after'){ act.href = '#'; act.textContent = 'Vaqt tugadi'; act.onclick = (e)=> e.preventDefault(); }
        }
        const cd = card.querySelector('.cd');
        if(cd){
          const until = Number(cd.getAttribute('data-until'));
          const tick = ()=>{
            const left = Math.max(0, Math.floor((until - Date.now())/1000));
            const d = Math.floor(left/86400), h = Math.floor(left%86400/3600), m = Math.floor(left%3600/60), s = left%60;
            cd.textContent = `‚è≥ ${d} kun ${h} soat ${m} daqiqa ${s} s`;
            if(left<=0) { renderGrid(); }
          };
          tick(); timers.push(setInterval(tick,1000));
        }
        card.querySelector('[data-role="detail"]').onclick = ()=> openDetail(it);
        grid.appendChild(card);
      });

      // Pg info (filtered count)
      const filtered = (db.cards[section]||[]).filter(it=>{
        const okTag = !activeTags.size || (it.tags||[]).some(t=> activeTags.has(t));
        const okQ = !q.value || (it.title||'').toLowerCase().includes(q.value.toLowerCase());
        return okTag && okQ;
      }).length;
      const totalPages = Math.max(1, Math.ceil(filtered / PAGE_SIZE));
      pgInfo.textContent = `${page}/${totalPages}`;
      pgPrev.disabled = (page<=1); pgNext.disabled = (page>=totalPages);
    }

    function openDetail(it){
      document.getElementById('dtTitle').textContent = it.title||'';
      const img = document.getElementById('dtImg');
      if(it.image){ img.src = it.image; img.style.display='block'; } else { img.style.display='none'; }
      document.getElementById('dtHtml').innerHTML = it.detailsHtml || '<p>Ma‚Äôlumot yo‚Äòq.</p>';
      const modal = document.getElementById('detailModal');
      modal.style.display='flex';
      document.getElementById('dtClose').onclick = ()=> modal.style.display='none';
      window.addEventListener('click', e=>{ if(e.target===modal) modal.style.display='none'; }, {once:true});
    }

    tabs.forEach(t=> t.addEventListener('click', ()=>{ tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); section=t.dataset.sec; activeTags.clear(); page=1; buildTags(); renderGrid(); }));
    q.addEventListener('input', ()=>{ page=1; renderGrid(); });
    pgPrev.addEventListener('click', ()=>{ page=Math.max(1,page-1); renderGrid(); });
    pgNext.addEventListener('click', ()=>{ page=page+1; renderGrid(); });

    loadData().then(()=>{ renderBanners(); buildTags(); renderGrid(); });
  })();
  </script>
</body>
</html>
