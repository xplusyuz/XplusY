<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — MathCenter.uz</title>
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <style>
    :root{ --green:#0faf64; --edge:#e0f3eb; --bg:#f6fffb; }
    *{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg)}
    header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:#fff;border-bottom:1px solid var(--edge)}
    .logo{width:36px;height:36px;border-radius:12px;background:radial-gradient(60% 60% at 50% 35%, #b9ffd9, #2de38d 55%, #0ea55a 100%)}
    main{max-width:1100px;margin:16px auto;padding:0 16px;display:grid;gap:16px}
    .card{background:#fff;border:1px solid var(--edge);border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,.06);padding:14px}
    h2{margin:0 0 10px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    @media(max-width:800px){.grid{grid-template-columns:1fr}}
    .row{display:grid;gap:6px}
    label{font-size:12px;opacity:.7}
    input,select{padding:10px 12px;border:1px solid var(--edge);border-radius:12px;outline:none}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--edge);cursor:pointer;background:#fff;font-weight:800}
    .btn--pri{background:var(--green);color:#fff;border-color:var(--green)}
    .grid-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
    .gcard{background:#fff;border:1px solid var(--edge);border-radius:12px;overflow:hidden}
    .gcard .cover{aspect-ratio:16/9;width:100%;object-fit:cover;background:#f3f7f5}
    .gcard .body{padding:10px 12px}
  </style>
</head>
<body>
  <header>
    <div class="logo"></div>
    <div style="font-weight:900">Admin panel</div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <a class="btn" href="index.html">← Saytga qaytish</a>
      <button id="btnLogout" class="btn">Chiqish</button>
    </div>
  </header>

  <main id="app" style="display:none"><!-- guard tekshiruvi tugagach ko‘rinadi -->
    <div class="card">
      <h2>Banner qo‘shish</h2>
      <div class="grid">
        <div class="row"><label>Sarlavha</label><input id="ban_title" placeholder="Masalan: Yangi kurslar!"></div>
        <div class="row"><label>Rasm URL (16:9)</label><input id="ban_cover" placeholder="https://..."></div>
        <div class="row"><label>Subject (ixtiyoriy)</label><input id="ban_subject" placeholder="Matematika"></div>
        <div class="row"><label>Daraja/Level (ixtiyoriy)</label><input id="ban_level" placeholder="Boshlang‘ich"></div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
        <button id="btnAddBanner" class="btn btn--pri">Qo‘shish</button>
      </div>
    </div>

    <div class="card">
      <h2>Karta qo‘shish (Kurs/Test/Simulyator)</h2>
      <div class="grid">
        <div class="row"><label>Tur</label>
          <select id="itm_type">
            <option value="courses">Kurs</option>
            <option value="tests">Test</option>
            <option value="simulators">Simulyator</option>
          </select>
        </div>
        <div class="row"><label>Sarlavha</label><input id="itm_title" placeholder="Nom"></div>
        <div class="row"><label>Rasm URL (16:9)</label><input id="itm_cover" placeholder="https://..."></div>
        <div class="row"><label>Fan / Subject (ixtiyoriy)</label><input id="itm_subject" placeholder="Algebra"></div>
        <div class="row"><label>Daraja / Level (ixtiyoriy)</label><input id="itm_level" placeholder="O‘rta"></div>
        <div class="row"><label>Davomiylik / Duration (ixtiyoriy)</label><input id="itm_duration" placeholder="12 soat"></div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
        <button id="btnAddItem" class="btn btn--pri">Qo‘shish</button>
      </div>
    </div>

    <div class="card">
      <h2>Bannerlar ro‘yxati</h2>
      <div id="list_banners" class="grid-cards"></div>
    </div>

    <div class="card">
      <h2>Kartalar ro‘yxati</h2>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button class="btn" data-scope="courses">Kurslar</button>
        <button class="btn" data-scope="tests">Testlar</button>
        <button class="btn" data-scope="simulators">Simulyatorlar</button>
      </div>
      <div id="list_items" class="grid-cards"></div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, addDoc, deleteDoc,
      collection, serverTimestamp, query, orderBy, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.firebasestorage.app",
      messagingSenderId: "992512966017",
      appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId: "G-459PLJ7P7L"
    };

    const appFB = initializeApp(firebaseConfig);
    const auth = getAuth(appFB);
    const db   = getFirestore(appFB);

    const $ = (s, r=document)=>r.querySelector(s);
    const $$= (s, r=document)=>Array.from(r.querySelectorAll(s));

    function isAdminNumericId(val){ return (val===38864 || val==='38864'); }

    // Guard: faqat 38864
    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.href = "index.html#home"; return; }
      const me = await getDoc(doc(db,'users',user.uid));
      if(!me.exists() || !isAdminNumericId(me.data().numericId)){
        alert("Kirish ruxsati yo‘q (admin emas).");
        location.href = "index.html#home";
        return;
      }
      // Show app
      $('#app').style.display = 'grid';
      // Load lists
      await Promise.all([loadBanners(), loadItems('courses')]);
    });

    $('#btnLogout')?.addEventListener('click', async ()=>{ await signOut(auth); location.href="index.html#home"; });

    // Create Banner
    $('#btnAddBanner')?.addEventListener('click', async ()=>{
      const title = $('#ban_title').value.trim();
      const cover = $('#ban_cover').value.trim();
      const subject = $('#ban_subject').value.trim();
      const level   = $('#ban_level').value.trim();
      if(!title) return alert('Sarlavha shart');
      await setDoc(doc(collection(db,'banners')), {
        title, cover, subject: subject||null, level: level||null,
        createdAt: serverTimestamp()
      });
      $('#ban_title').value=''; $('#ban_cover').value=''; $('#ban_subject').value=''; $('#ban_level').value='';
      await loadBanners();
      alert('Banner qo‘shildi');
    });

    // Create Item
    $('#btnAddItem')?.addEventListener('click', async ()=>{
      const coll = $('#itm_type').value;
      const title = $('#itm_title').value.trim();
      const cover = $('#itm_cover').value.trim();
      const subject = $('#itm_subject').value.trim();
      const level   = $('#itm_level').value.trim();
      const duration= $('#itm_duration').value.trim();
      if(!title) return alert('Sarlavha shart');
      await addDoc(collection(db,coll), {
        title, cover, subject: subject||null, level: level||null, duration: duration||null,
        createdAt: serverTimestamp()
      });
      $('#itm_title').value=''; $('#itm_cover').value=''; $('#itm_subject').value=''; $('#itm_level').value=''; $('#itm_duration').value='';
      await loadItems(coll);
      alert('Karta qo‘shildi');
    });

    // Lists
    async function loadBanners(){
      const box = $('#list_banners'); if(!box) return;
      box.innerHTML = 'Yuklanmoqda...';
      const qs = await getDocs(query(collection(db,'banners'), orderBy('createdAt','desc')));
      if(qs.empty){ box.innerHTML = '<div class="gcard"><div class="body"><h3>Banner yo‘q</h3></div></div>'; return; }
      box.innerHTML = qs.docs.map(docSnap=>{
        const d = docSnap.data();
        return `
          <div class="gcard">
            <img class="cover" src="${d.cover||''}" alt="">
            <div class="body">
              <h3 style="margin:0 0 6px">${d.title||'—'}</h3>
              <div style="font-size:12px;opacity:.8">${[d.subject,d.level].filter(Boolean).join(' · ')}</div>
              <div style="margin-top:8px;display:flex;gap:8px">
                <button class="btn" data-del-ban="${docSnap.id}">O‘chirish</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
      // bind delete
      $$('[data-del-ban]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          if(!confirm('Banner o‘chirilsinmi?')) return;
          await deleteDoc(doc(db,'banners', btn.dataset.delBan));
          await loadBanners();
        });
      });
    }

    let currentScope = 'courses';
    $$('[data-scope]').forEach(btn=>{
      btn.addEventListener('click', ()=>{ currentScope = btn.dataset.scope; loadItems(currentScope); });
    });

    async function loadItems(scope){
      const box = $('#list_items'); if(!box) return;
      box.innerHTML = 'Yuklanmoqda...';
      const qs = await getDocs(query(collection(db,scope), orderBy('createdAt','desc')));
      if(qs.empty){ box.innerHTML = '<div class="gcard"><div class="body"><h3>Hozircha ma’lumot yo‘q</h3></div></div>'; return; }
      box.innerHTML = qs.docs.map(docSnap=>{
        const d = docSnap.data();
        return `
          <div class="gcard">
            <img class="cover" src="${d.cover||''}" alt="">
            <div class="body">
              <h3 style="margin:0 0 6px">${d.title||'—'}</h3>
              <div style="font-size:12px;opacity:.8">${[d.subject,d.level,d.duration].filter(Boolean).join(' · ')}</div>
              <div style="margin-top:8px;display:flex;gap:8px">
                <button class="btn" data-del-item="${docSnap.id}">O‘chirish</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
      // delete binding
      $$('[data-del-item]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          if(!confirm('O‘chirilsinmi?')) return;
          await deleteDoc(doc(db,scope, btn.dataset.delItem));
          await loadItems(scope);
        });
      });
    }
  </script>
</body>
</html>
