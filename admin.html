<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MathCenter Admin — 5 Bo‘lim (kengaytirilgan, barqaror)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    :root { --p:#2E8B57; --b:#111; --muted:#6b7280; --bd:#e5e7eb; --bg:#fff; --r:14px; --sh:0 10px 30px rgba(0,0,0,.08); }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--b)}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bd);z-index:10}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0;font-weight:800;color:var(--p)}
    .sub{color:var(--muted);font-size:13px}
    .topbar{display:flex;align-items:center;gap:16px;justify-content:space-between}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .tab{padding:10px 14px;border:1px solid var(--bd);border-radius:999px;cursor:pointer}
    .tab.active{background:#E8F5E9;border-color:#86efac;color:#14532d;font-weight:700}
    main{padding:16px 0}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
    .card{background:#fff;border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--sh);padding:14px}
    .row{display:flex;gap:12px;align-items:center}
    .muted{color:var(--muted)}
    .mini{font-size:12px;color:#374151}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:12px 0}
    button,.btn{cursor:pointer;border:1px solid var(--bd);background:#fff;border-radius:10px;padding:8px 12px}
    .btn.primary{background:#2E8B57;border-color:#2E8B57;color:#fff;font-weight:700}
    .btn.warn{background:#fffbeb;border-color:#f59e0b}
    input,textarea,select{width:100%;padding:10px;border:1px solid var(--bd);border-radius:10px}
    label{display:block;font-size:12px;color:#374151;margin-bottom:6px}
    .form{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .full{grid-column:1/-1}
    .hidden{display:none!important}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border:1px solid var(--bd);border-radius:999px;font-size:12px;background:#fff}
    .pill.best{background:#0b3d2c;color:#fff;border-color:#0b3d2c}
    .list-item{border:1px solid var(--bd);border-radius:12px;padding:10px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .list-title{font-weight:700}
    .split{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    @media (max-width:900px){ .split{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div class="container topbar">
      <div>
        <h1>Admin Panel</h1>
        <div class="sub">Banner • Best • Oddiy • Promo • Foydalanuvchilar</div>
      </div>
      <div class="row">
        <button id="btnImport" class="btn">JSON Import</button>
        <button id="btnExport" class="btn">JSON Export</button>
        <button id="btnLocal" class="btn warn">Local Preview</button>
        <span id="status" class="muted mini"></span>
      </div>
    </div>
    <div class="container">
      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="banners">Banner</div>
        <div class="tab" data-tab="best">Best card</div>
        <div class="tab" data-tab="ordinary">Oddiy card</div>
        <div class="tab" data-tab="promo">Promo</div>
        <div class="tab" data-tab="users">Foydalanuvchilar</div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="split">
      <section>
        <div class="toolbar" id="toolbar">
          <button id="btnNew" class="btn primary">Yangi qo‘shish</button>
          <span class="muted mini" id="count"></span>
        </div>
        <div id="list" class="grid"></div>

        <section id="usersSec" class="card hidden">
          <h3>Foydalanuvchilar</h3>
          <div class="row" style="gap:8px;flex-wrap:wrap;margin:8px 0">
            <input id="u-q" placeholder="Email yoki Numeric ID" style="max-width:320px" />
            <button id="u-find" class="btn">Qidirish</button>
          </div>
          <div id="u-results" class="grid"></div>
          <div class="mini muted" style="margin-top:8px">Eslatma: Firebase SDK kerak. Admin huquqlari Firestore qoidalarida ta’riflanadi.</div>
        </section>
      </section>

      <section>
        <div id="editor" class="card hidden">
          <h3 id="editorTitle">Yangi element</h3>
          <div class="form">
            <div class="full"><label>Bo‘lim</label>
              <select id="f-section">
                <option value="banners">Banner</option>
                <option value="best">Best card</option>
                <option value="ordinary">Oddiy card</option>
                <option value="promo">Promo</option>
              </select>
            </div>

            <div><label>ID</label><input id="f-id" placeholder="Bo‘sh qoldirsangiz avtomatik" /></div>
            <div><label>Title</label><input id="f-title" /></div>
            <div><label>Subtitle</label><input id="f-subtitle" /></div>
            <div class="full"><label>Image URL</label><input id="f-image" placeholder="https://..." /></div>
            <div class="full"><label>Link</label><input id="f-link" placeholder="/tests/..., /courses/... yoki to‘liq URL" /></div>

            <div><label>Best?</label><input id="f-best" type="checkbox" /></div>
            <div><label>Bosh sahifada ko‘rsatilsin?</label><input id="f-home" type="checkbox" /></div>

            <div class="only-best full"><label>Qaysi bo‘limlarda ko‘rinsin?</label>
              <div class="row">
                <label><input type="checkbox" id="t-tests" /> Testlar</label>
                <label><input type="checkbox" id="t-courses" /> Kurslar</label>
                <label><input type="checkbox" id="t-simulators" /> Simulyatorlar</label>
                <label><input type="checkbox" id="t-home-best" /> Bosh sahifa</label>
              </div>
            </div>
            </div>

            <div class="only-tests"><label>Mode (faqat testlar)</label>
              <select id="f-mode">
                <option value="">—</option>
                <option value="online">online</option>
                <option value="offline">offline</option>
              </select>
            </div>

            <div class="hide-when-ordinary"><label>StartAt (best uchun)</label><input id="f-start" type="datetime-local" /></div>
            <div class="hide-when-ordinary"><label>EndAt (best uchun)</label><input id="f-end" type="datetime-local" /></div>
            <div class="hide-when-ordinary full"><label>Prize / Qo‘shimcha</label><input id="f-prize" /></div>

            <div class="hide-when-best full"><label>CTA matni (kartadagi tugma)</label><input id="f-cta" placeholder="Boshlash / Batafsil" /></div>
            <div class="hide-when-best full"><label>Tags (oddiy kartalar uchun, vergul bilan)</label><input id="f-tags" placeholder="algebra, geometriya" /></div>
            <div class="hide-when-best"><label>Oddiy kartani qaysi bo‘limga saqlaymiz?</label>
              <select id="f-ordinary-section">
                <option value="tests">Testlar</option>
                <option value="courses">Kurslar</option>
                <option value="simulators">Simulyatorlar</option>
              </select>
            </div>

            <!-- Banner qo‘shimcha -->
            <div class="when-banner"><label>Banner aktiv?</label><input id="f-bn-active" type="checkbox" /></div>
            <div class="when-banner"><label>CTA matni (banner)</label><input id="f-bn-cta" placeholder="Boshlash" /></div>
            <div class="when-banner"><label>Mobil rasm URL</label><input id="f-bn-mobile" placeholder="https://..." /></div>
            <div class="when-banner"><label>Tartib (order)</label><input id="f-bn-order" type="number" min="0" /></div>
            <div class="when-banner"><label>Gradient 2 (ixtiyoriy)</label><input id="f-bn-bg2" placeholder="#1F6B45" /></div>

            <div class="full"><label>Details HTML</label><textarea id="f-details" rows="5" placeholder="&lt;p&gt;Matn ...&lt;/p&gt;"></textarea></div>

            <!-- Promo (site-wide, sahifada ko‘rinmaydi) -->
            <div class="when-promo"><label>Promo code</label><input id="f-promo-code" /></div>
            <div class="when-promo"><label>Valid From</label><input id="f-promo-from" type="date" /></div>
            <div class="when-promo"><label>Valid To</label><input id="f-promo-to" type="date" /></div>
            <div class="when-promo"><label>Promo turi</label>
              <select id="f-promo-type">
                <option value="discount">Chegirma (%)</option>
                <option value="bonus">Bonus (balans)</option>
              </select>
            </div>
            <div class="when-promo"><label>Miqdor (chegirma % yoki bonus summasi)</label><input id="f-promo-amount" type="number" min="0" /></div>
            <div class="when-promo"><label>Bir foydalanuvchi — bir marta?</label><input id="f-promo-once" type="checkbox" checked /></div>
            <div class="when-promo"><label>Global limit (0=unlimited)</label><input id="f-promo-max" type="number" min="0" /></div>
            <div class="when-promo full mini muted">Promo <b>sahifalarda ko‘rinmaydi</b> — butun sayt bo‘ylab chegirma yoki balans bonusi sifatida qo‘llanadi. Claim/usage nazorati Firestore orqali yuritiladi.</div>
          </div>
          <div class="row" style="justify-content:flex-end;margin-top:10px">
            <button id="cancelEdit" class="btn">Bekor qilish</button>
            <button id="saveEdit" class="btn primary">Saqlash</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
  'use strict';
  // ===== Utilities =====
  const $ = (s)=>document.querySelector(s);
  const list=$('#list'), editor=$('#editor'), usersSec=$('#usersSec'), statusEl=$('#status'), countEl=$('#count');
  const state={ tab:'banners', editing:null, data:null };
  const emptyData={ meta:{updatedAt:new Date().toISOString()}, banners:[], cards:{tests:[],courses:[],simulators:[]}, promo_codes:[] };

  function setStatus(m){ statusEl.textContent=m||''; }
  function loadLocal(){ const t=localStorage.getItem('__ADMIN_JSON'); if(!t) return null; try{ return JSON.parse(t);}catch{ return null; } }
  function saveLocal(json){ try{ localStorage.setItem('__ADMIN_JSON', JSON.stringify(json,null,2)); setStatus('Local saqlandi'); }catch(e){ console.warn(e); setStatus('Saqlash xatosi'); } }
  function download(name,txt){ const a=document.createElement('a'); a.href='data:application/json;charset=utf-8,'+encodeURIComponent(txt); a.download=name; document.body.appendChild(a); a.click(); a.remove(); }
  async function pickFile(){ return new Promise(res=>{ const i=document.createElement('input'); i.type='file'; i.accept='.json,application/json'; i.onchange=()=>{ const f=i.files[0]; const r=new FileReader(); r.onload=()=>res(r.result); r.readAsText(f); }; i.click(); }); }
  function toLocal(iso){ if(!iso) return ''; const d=new Date(iso); if(isNaN(d)) return ''; const tz=d.getTimezoneOffset(); const d2=new Date(d.getTime()-tz*60000); return d2.toISOString().slice(0,16); }
  function makeId(){ return 'id-'+Math.random().toString(36).slice(2); }

  // ===== View helpers =====
  function applyTab(tab){
    state.tab=tab;
    document.querySelectorAll('.tab').forEach(t=> t.classList.toggle('active', t.dataset.tab===tab));
    list.classList.toggle('hidden', tab==='users');
    usersSec.classList.toggle('hidden', tab!=='users');
    editor.classList.add('hidden');
    render();
  }

  function toggleEditorFields(){
    const sec=$('#f-section').value;
    const isBest=$('#f-best').checked;
    const isPromo=(sec==='promo');
    const isBanner=(sec==='banners');

    // show/hide groups
    document.querySelectorAll('.hide-when-ordinary').forEach(el=>{ (el.closest('div')||el).style.display = isBest? '' : 'none'; });
    document.querySelectorAll('.hide-when-best').forEach(el=>{ (el.closest('div')||el).style.display = isBest? 'none' : ''; });
    document.querySelectorAll('.only-tests').forEach(el=>{
      const box=(el.closest('div')||el); box.style.display = ((sec==='best' && $('#t-tests').checked) || (sec==='ordinary' && ($('#f-ordinary-section').value==='tests')))? '' : 'none';
    });
    document.querySelectorAll('.when-promo').forEach(el=>{ (el.closest('div')||el).style.display = isPromo? '' : 'none'; });
    document.querySelectorAll('.when-banner').forEach(el=>{ (el.closest('div')||el).style.display = isBanner? '' : 'none'; });

    // Sync best-home group with standalone home checkbox
    const homeBest=$('#t-home-best'); if(homeBest){ const fh=$('#f-home'); fh.checked = homeBest.checked; }

    // hide irrelevant when banner/promo
    const toHideBanner=['#f-best','#f-home','#f-tags','#f-cta','#f-start','#f-end','#f-prize','#t-tests','#t-courses','#t-simulators','#t-home-best','#f-mode','#f-ordinary-section'];
    toHideBanner.forEach(id=>{ const box=$(id)?.closest('div'); if(isBanner && box) box.style.display='none'; });
    const toHidePromo=['#f-subtitle','#f-image','#f-link','#f-best','#f-home','#f-tags','#f-cta','#f-start','#f-end','#f-prize','#t-tests','#t-courses','#t-simulators','#t-home-best','#f-mode','#f-ordinary-section','#f-bn-active','#f-bn-cta','#f-bn-mobile','#f-bn-order','#f-bn-bg2'];
    toHidePromo.forEach(id=>{ const box=$(id)?.closest('div'); if(isPromo && box) box.style.display='none'; });
  });
    document.querySelectorAll('.hide-when-best').forEach(el=>{ (el.closest('div')||el).style.display = isBest? 'none' : ''; });
    document.querySelectorAll('.only-tests').forEach(el=>{
      const box=(el.closest('div')||el); box.style.display = ((sec==='best' && $('#t-tests').checked) || (sec==='ordinary' && ($('#f-ordinary-section').value==='tests')))? '' : 'none';
    });
    document.querySelectorAll('.when-promo').forEach(el=>{ (el.closest('div')||el).style.display = isPromo? '' : 'none'; });
    document.querySelectorAll('.when-banner').forEach(el=>{ (el.closest('div')||el).style.display = isBanner? '' : 'none'; });

    // hide irrelevant when banner/promo
    const toHideBanner=['#f-best','#f-home','#f-tags','#f-cta','#f-start','#f-end','#f-prize','#t-tests','#t-courses','#t-simulators','#f-mode','#f-ordinary-section'];
    toHideBanner.forEach(id=>{ const box=$(id)?.closest('div'); if(isBanner && box) box.style.display='none'; });
    const toHidePromo=['#f-subtitle','#f-image','#f-link','#f-best','#f-home','#f-tags','#f-cta','#f-start','#f-end','#f-prize','#t-tests','#t-courses','#t-simulators','#f-mode','#f-ordinary-section','#f-bn-active','#f-bn-cta','#f-bn-mobile','#f-bn-order','#f-bn-bg2'];
    toHidePromo.forEach(id=>{ const box=$(id)?.closest('div'); if(isPromo && box) box.style.display='none'; });
  }

  // ===== Data helpers =====
  function gatherItemsFor(tab, d){
    const out=[];
    if(tab==='banners'){ (d.banners||[]).forEach((it,idx)=> out.push({it, sec:'banners', idx})); }
    else if(tab==='promo'){ (d.promo_codes||[]).forEach((it,idx)=> out.push({it, sec:'promo', idx})); }
    else if(tab==='best' || tab==='ordinary'){
      const wantBest=(tab==='best');
      ['tests','courses','simulators'].forEach(sec=>{
        (d.cards[sec]||[]).forEach((it,idx)=>{ if(!!it.best===wantBest){ out.push({it, sec, idx}); } });
      });
    }
    return out;
  }

  function upsertBy(arr, obj, key){
    const i = key ? arr.findIndex(x=>x && x[key]===obj[key]) : arr.findIndex(x=>x && x.id===obj.id);
    if(i>-1) arr[i]=obj; else arr.push(obj);
  }

  // ===== Render list =====
  function render(){
    if(state.tab==='users') return;
    const d=state.data||emptyData;
    const views=gatherItemsFor(state.tab, d);
    list.innerHTML='';
    countEl.textContent = views.length + ' ta';
    views.forEach(v=>{
      const it=v.it;
      const el=document.createElement('div'); el.className='list-item';
      const left=document.createElement('div');
      const right=document.createElement('div'); right.style.display='flex'; right.style.gap='8px';
      right.innerHTML='<button class="btn" data-act="edit">Tahrirlash</button><button class="btn" data-act="del">O‘chirish</button>';

      if(v.sec==='banners'){
        left.innerHTML=`<div class="list-title">${it.title||''}</div><div class="mini muted">${it.subtitle||''} ${(it.active?'• aktiv':'')}</div>`;
      } else if(v.sec==='promo'){
        const typeStr = it.type==='bonus' ? `Bonus: ${it.amount||0}` : `Chegirma: ${(it.amount||0)}%`;
        left.innerHTML=`<div class="list-title">${it.code}</div><div class="mini muted">${typeStr} • ${it.validFrom||''} → ${it.validTo||''} • 1x/user:${it.onePerUser!==false}</div>`;
      } else {
        const pills=[]; if(it.best) pills.push('<span class="pill best">BEST</span>'); if(it.home) pills.push('<span class="pill">HOME</span>'); if(it.mode) pills.push(`<span class="pill">${it.mode}</span>`);
        left.innerHTML=`<div class="list-title">${it.title||''}</div><div class="mini muted">${(it.tags||[]).join(' • ')}</div><div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">${pills.join(' ')}</div>`;
      }

      el.appendChild(left); el.appendChild(right); list.appendChild(el);
      el.querySelector('[data-act="edit"]').onclick=()=> openEditor({sec:v.sec, idx:v.idx});
      el.querySelector('[data-act="del"]').onclick=()=>{
        if(!confirm('O‘chirishni tasdiqlaysizmi?')) return;
        if(v.sec==='banners') d.banners.splice(v.idx,1);
        else if(v.sec==='promo') d.promo_codes.splice(v.idx,1);
        else d.cards[v.sec].splice(v.idx,1);
        d.meta.updatedAt=new Date().toISOString();
        saveLocal(d);
        render();
      };
    });
  }

  // ===== Editor =====
  function openEditor(ref){
    const d=state.data;
    editor.classList.remove('hidden');
    const tab=state.tab;
    const secSel=$('#f-section'); const idInp=$('#f-id'); const titleInp=$('#f-title'); const subInp=$('#f-subtitle'); const imgInp=$('#f-image'); const linkInp=$('#f-link');
    const bestInp=$('#f-best'); const homeInp=$('#f-home'); const tTests=$('#t-tests'), tCourses=$('#t-courses'), tSims=$('#t-simulators');
    const tagsInp=$('#f-tags'); const ctaInp=$('#f-cta'); const modeSel=$('#f-mode'); const ordSecSel=$('#f-ordinary-section');
    const sAt=$('#f-start'), eAt=$('#f-end'), prize=$('#f-prize'); const details=$('#f-details');
    const bnActive=$('#f-bn-active'), bnCta=$('#f-bn-cta'), bnMobile=$('#f-bn-mobile'), bnOrder=$('#f-bn-order'), bnBg2=$('#f-bn-bg2');
    const pc=$('#f-promo-code'), pf=$('#f-promo-from'), pt=$('#f-promo-to'), pType=$('#f-promo-type'), pAmt=$('#f-promo-amount'), pOnce=$('#f-promo-once'), pMax=$('#f-promo-max');
    const tHomeBest=$('#t-home-best');

    const viewSec = (ref && ref.sec) ? ref.sec : (tab==='banners'?'banners' : (tab==='promo'?'promo' : (tab==='best'?'best':'ordinary')));
    secSel.value=viewSec;

    let it=null;
    if(ref && (ref.idx!=null)){
      if(viewSec==='banners') it=d.banners[ref.idx];
      else if(viewSec==='promo') it=d.promo_codes[ref.idx];
      else it=d.cards[ref.sec][ref.idx];
    }

    // Force best/ordinary checkbox state
    if(viewSec==='best'){ bestInp.checked=true; bestInp.disabled=true; }
    else if(viewSec==='ordinary'){ bestInp.checked=false; bestInp.disabled=true; }
    else { bestInp.disabled=false; }

    if(it){
      $('#editorTitle').textContent='Tahrirlash';
      idInp.value=it.id||''; titleInp.value=it.title||''; subInp.value=it.subtitle||''; imgInp.value=it.image||''; linkInp.value=it.link||'';
      bestInp.checked=!!it.best; homeInp.checked=!!it.home;
      tTests.checked=!!(it.targetSections?.includes('tests'));
      tCourses.checked=!!(it.targetSections?.includes('courses'));
      tSims.checked=!!(it.targetSections?.includes('simulators'));
      if(tHomeBest) tHomeBest.checked=!!it.home;
      tagsInp.value=(it.tags||[]).join(', ');
      ctaInp.value=it.cta||''; modeSel.value=it.mode||'';
      sAt.value=it.startAt? toLocal(it.startAt):''; eAt.value=it.endAt? toLocal(it.endAt):''; prize.value=it.prize||''; details.value=it.detailsHtml||'';
      if(viewSec==='ordinary' && ordSecSel) ordSecSel.value=ref.sec||'tests';
      if(viewSec==='banners'){ bnActive.checked=!!it.active; bnCta.value=it.cta||''; bnMobile.value=it.mobileImage||''; bnOrder.value=Number(it.order||0); bnBg2.value=it.bg2||''; }
      if(viewSec==='promo'){ pc.value=it.code||''; pf.value=it.validFrom||''; pt.value=it.validTo||''; pType.value=it.type||'discount'; pAmt.value=it.amount||0; pOnce.checked=(it.onePerUser!==false); pMax.value=it.maxUse||0; }
    } else {
      $('#editorTitle').textContent='Yangi element';
      [idInp,titleInp,subInp,imgInp,linkInp,tagsInp,ctaInp,modeSel,sAt,eAt,prize,details,bnCta,bnMobile,bnOrder,bnBg2,pc,pf,pt,pAmt,pMax].forEach(i=>{ if(!i) return; if(i.tagName==='SELECT'){ i.value=''; } else { i.value=''; } });
      if(tHomeBest) tHomeBest.checked=false; homeInp.checked=false; [tTests,tCourses,tSims,bnActive].forEach(x=> x && (x.checked=false));
      if(pOnce) pOnce.checked=true; if(pType) pType.value='discount'; if(ordSecSel) ordSecSel.value='tests';
    } else { i.value=''; } });
      homeInp.checked=false; [tTests,tCourses,tSims,bnActive].forEach(x=> x && (x.checked=false));
      if(pOnce) pOnce.checked=true; if(pType) pType.value='discount'; if(ordSecSel) ordSecSel.value='tests';
    }

    toggleEditorFields();
    secSel.oninput=()=>{ if(secSel.value==='best'){ bestInp.checked=true; bestInp.disabled=true; } else if(secSel.value==='ordinary'){ bestInp.checked=false; bestInp.disabled=true; } else { bestInp.disabled=false; } toggleEditorFields(); };
    bestInp.onchange=toggleEditorFields;
    ;[tTests,tCourses,tSims].forEach(x=> x && (x.onchange=toggleEditorFields));
    if(ordSecSel) ordSecSel.onchange=toggleEditorFields;

    $('#saveEdit').onclick=()=> saveEditor(ref? {sec:viewSec, idx:ref.idx} : null);
    $('#cancelEdit').onclick=()=> editor.classList.add('hidden');
  }

  function saveEditor(ref){
    const d=state.data;
    const sec=$('#f-section').value; if(!sec) return alert('Bo‘limni tanlang');
    const id=$('#f-id').value.trim()||makeId();
    const title=$('#f-title').value.trim(); if(!title && sec!=='promo') return alert('Title majburiy');

    const common={
      id,
      title,
      subtitle:$('#f-subtitle').value.trim()||undefined,
      image:$('#f-image').value.trim()||undefined,
      link:$('#f-link').value.trim()||undefined,
      best:$('#f-best').checked||false,
      home:$('#f-home').checked||false,
      cta:($('#f-cta').value||undefined),
      detailsHtml:$('#f-details').value||undefined
    };

    if(sec==='banners'){
      const obj={ id, title:common.title, subtitle:common.subtitle, image:common.image, link:common.link, bg:'#0b3d2c', cta:($('#f-bn-cta').value||undefined), active:$('#f-bn-active').checked||false, mobileImage:($('#f-bn-mobile').value||undefined), order:Number($('#f-bn-order').value||0), bg2:($('#f-bn-bg2').value||undefined) };
      upsertBy(d.banners, obj, 'id');
    }
    else if(sec==='promo'){
      const obj={ code:$('#f-promo-code').value.trim().toUpperCase(), validFrom:$('#f-promo-from').value||null, validTo:$('#f-promo-to').value||null, type:$('#f-promo-type').value, amount:Number($('#f-promo-amount').value||0), onePerUser:$('#f-promo-once').checked!==false, maxUse:Number($('#f-promo-max').value||0) };
      if(!obj.code) return alert('Promo code majburiy');
      if(obj.type==='discount' && (obj.amount<0 || obj.amount>100)) return alert('Chegirma 0-100%');
      upsertBy(d.promo_codes, obj, 'code');
      // push to Firestore (source of truth)
      (async ()=>{ const app=await ensureFirebase(); if(!app) return; const db=firebase.firestore(); await db.collection('promos').doc(obj.code).set(obj, {merge:true}); console.log('Promo pushed to Firestore:', obj.code); })();
    }
    else if(sec==='best' || sec==='ordinary'){
      const isBest=(sec==='best');
      if(isBest){
        const targets=obj.targetSections||[]; if(targets.length===0) return alert('Best uchun kamida bitta bo‘lim tanlang');
        // Home ko‘rsatish, agar belgilanganda
        obj.home = !!(tHomeBest && tHomeBest.checked);
        ['tests','courses','simulators'].forEach(secName=>{
          const arr=d.cards[secName]||(d.cards[secName]=[]);
          const idx=arr.findIndex(x=>x && x.id===obj.id && x.best===true);
          if(targets.includes(secName)){
            const copy=Object.assign({}, obj, {best:true});
            if(idx>-1) arr[idx]=copy; else arr.push(copy);
          } else {
            if(idx>-1) arr.splice(idx,1);
          }
        });
      } else {
        const ordSec=$('#f-ordinary-section').value|| (ref && ref.sec) || 'tests';
        const arr=d.cards[ordSec]||(d.cards[ordSec]=[]);
        const copy=Object.assign({}, obj, {best:false});
        upsertBy(arr, copy, 'id');
      }
        });
      } else {
        const ordSec=$('#f-ordinary-section').value|| (ref && ref.sec) || 'tests';
        const arr=d.cards[ordSec]||(d.cards[ordSec]=[]);
        const copy=Object.assign({}, obj, {best:false});
        upsertBy(arr, copy, 'id');
      }
    }

    d.meta.updatedAt=new Date().toISOString();
    saveLocal(d);
    editor.classList.add('hidden');
    render();
  }

  // ===== Users (optional Firebase) =====
  async function ensureFirebase(){
    if(window.firebase && window.firebase.initializeApp){
      try{ if(!window.firebaseApp){ window.firebaseApp=firebase.initializeApp(window.__FIREBASE_CONFIG||{}); } }catch(e){}
      return window.firebaseApp;
    }
    return null;
  }
  function renderUsers(){ const btn=$('#u-find'); if(!btn) return; btn.onclick= async ()=>{ const q=($('#u-q').value||'').trim().toLowerCase(); const app=await ensureFirebase(); if(!app){ alert('Firebase SDK yo‘q yoki sozlanmagan.'); return; } const db=firebase.firestore(); const box=$('#u-results'); box.innerHTML='<div class="muted">Yuklanmoqda...</div>'; const [byEmail,byId]=await Promise.all([ db.collection('users').where('email','==',q).get().catch(()=>({docs:[]})), (!isNaN(Number(q))? db.collection('users').where('numericId','==',Number(q)).get(): Promise.resolve({docs:[]})) ]); const docs=[...(byEmail.docs||[]),...(byId.docs||[])]; box.innerHTML=''; if(docs.length===0){ box.innerHTML='<div class="muted">Topilmadi</div>'; return; } docs.forEach(dDoc=>{ const u=dDoc.data(); const el=document.createElement('div'); el.className='card'; el.innerHTML=`<div class="row"><div style="width:44px;height:44px;border-radius:999px;background:#eef2ff;display:flex;align-items:center;justify-content:center">${(u.name||'?')[0]||'?'}</div><div><div style="font-weight:700">${u.name||''}</div><div class="mini muted">${u.email||''}</div></div></div><div class="row" style="gap:10px;margin-top:8px"><div style="flex:1"><label>Balance</label><input type="number" value="${u.balance||0}" data-k="balance"></div><div style="flex:1"><label>Points</label><input type="number" value="${u.points||0}" data-k="points"></div></div><div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn" data-act="dry">Promo dry-run</button><button class="btn primary" data-act="save">Saqlash</button></div>`; el.querySelector('[data-act="save"]').onclick= async ()=>{ const bal=Number(el.querySelector('input[data-k="balance"]').value||0); const pts=Number(el.querySelector('input[data-k="points"]').value||0); await db.collection('users').doc(dDoc.id).update({balance:bal, points:pts}).catch(e=>alert('Xato: '+e)); alert('Yangilandi'); }; el.querySelector('[data-act="dry"]').onclick= async ()=>{ const code=prompt('Promo kod:'); if(!code) return; const result = await window.promoDryRun(code, dDoc.id).catch(e=>({ok:false,error:String(e)})); console.log('DRY-RUN RESULT', result); alert(result.ok? ('OK: '+result.message) : ('Xato: '+result.error)); }; box.appendChild(el); }); } } const db=firebase.firestore(); const box=$('#u-results'); box.innerHTML='<div class="muted">Yuklanmoqda...</div>'; const [byEmail,byId]=await Promise.all([ db.collection('users').where('email','==',q).get().catch(()=>({docs:[]})), (!isNaN(Number(q))? db.collection('users').where('numericId','==',Number(q)).get(): Promise.resolve({docs:[]})) ]); const docs=[...(byEmail.docs||[]),...(byId.docs||[])]; box.innerHTML=''; if(docs.length===0){ box.innerHTML='<div class="muted">Topilmadi</div>'; return; } docs.forEach(dDoc=>{ const u=dDoc.data(); const el=document.createElement('div'); el.className='card'; el.innerHTML=`<div class="row"><div style="width:44px;height:44px;border-radius:999px;background:#eef2ff;display:flex;align-items:center;justify-content:center">${(u.name||'?')[0]||'?'}</div><div><div style="font-weight:700">${u.name||''}</div><div class="mini muted">${u.email||''}</div></div></div><div class="row" style="gap:10px;margin-top:8px"><div style="flex:1"><label>Balance</label><input type="number" value="${u.balance||0}" data-k="balance"></div><div style="flex:1"><label>Points</label><input type="number" value="${u.points||0}" data-k="points"></div></div><div class="row" style="justify-content:flex-end;margin-top:8px"><button class="btn primary" data-act="save">Saqlash</button></div>`; el.querySelector('[data-act="save"]').onclick= async ()=>{ const bal=Number(el.querySelector('input[data-k="balance"]').value||0); const pts=Number(el.querySelector('input[data-k="points"]').value||0); await db.collection('users').doc(dDoc.id).update({balance:bal, points:pts}).catch(e=>alert('Xato: '+e)); alert('Yangilandi'); }; box.appendChild(el); }); } }

  // ===== Promo helpers (Firebase) =====
  async function getPromoDoc(db, code){ const snap = await db.collection('promos').doc(code).get(); return snap.exists? {id:snap.id, ...snap.data()} : null; }
  async function countPromoUses(db, code){ const snap = await db.collection('promos').doc(code).collection('uses').get(); return snap.size||0; }
  async function hasUserUsedPromo(db, code, uid){ const doc = await db.collection('promos').doc(code).collection('uses').doc(uid).get(); return doc.exists; }
  function isWithin(dateStr, now){ if(!dateStr) return true; const d=new Date(dateStr+'T00:00:00Z'); return now>=d; }
  function isBefore(dateStr, now){ if(!dateStr) return true; const d=new Date(dateStr+'T23:59:59Z'); return now<=d; }
  function validatePromoRecord(p, now, usageCount, usedByUser){
    if(!p) return {ok:false, error:'Promo topilmadi'};
    if(!(p.type==='discount' || p.type==='bonus')) return {ok:false, error:'Noto‘g‘ri turi'};
    if(p.type==='discount' && (p.amount<0 || p.amount>100)) return {ok:false, error:'Chegirma 0-100%'};
    if(!isWithin(p.validFrom||'', now)) return {ok:false, error:'Muddat hali boshlanmagan'};
    if(!isBefore(p.validTo||'', now)) return {ok:false, error:'Muddat tugagan'};
    if(p.onePerUser!==false && usedByUser) return {ok:false, error:'Foydalanuvchi allaqachon ishlatgan'};
    if((p.maxUse||0)>0 && usageCount >= (p.maxUse||0)) return {ok:false, error:'Global limit tugagan'};
    return {ok:true, message: (p.type==='bonus'? ('Bonus '+p.amount): ('Chegirma '+p.amount+'%')) };
  }
  // Global DRY-RUN callable from console or UI
  window.promoDryRun = async function(code, uid){
    const app = await ensureFirebase(); if(!app) throw new Error('Firebase ulanmagan');
    const db = firebase.firestore(); const now = new Date();
    const p = await getPromoDoc(db, code);
    const usageCount = p? await countPromoUses(db, code) : 0;
    const usedByUser = uid? await hasUserUsedPromo(db, code, uid) : false;
    return validatePromoRecord(p, now, usageCount, usedByUser);
  }
  // Mark usage (optional helper)
  window.promoMarkUsed = async function(code, uid, payload={}){
    const app = await ensureFirebase(); if(!app) throw new Error('Firebase ulanmagan');
    const db = firebase.firestore(); const now = new Date().toISOString();
    await db.collection('promos').doc(code).collection('uses').doc(uid).set({usedAt:now, ...payload}, {merge:true});
    return {ok:true};
  }

  // ===== Init =====
  (function init(){
    state.data = loadLocal() || JSON.parse(JSON.stringify(emptyData));
    $('#btnLocal').onclick = ()=>{ const d=loadLocal(); alert(d? 'Localdan o‘qildi' : 'Local topilmadi'); };
    $('#btnExport').onclick = ()=> download('admin.json', JSON.stringify(state.data,null,2));
    $('#btnImport').onclick = async ()=>{ const txt = await pickFile(); try{ state.data = JSON.parse(txt); saveLocal(state.data); render(); alert('Import ok'); }catch(e){ alert('Xato JSON'); } };
    document.querySelectorAll('#tabs .tab').forEach(t=> t.onclick = ()=> applyTab(t.dataset.tab));
    $('#btnNew').onclick = ()=> openEditor(null);
    renderUsers();
    render();

    // ===== Simple runtime tests (console) =====
    (function runTests(){
      const sample=JSON.parse(JSON.stringify(emptyData));
      sample.cards.tests=[{id:'a',best:true},{id:'b',best:false}];
      sample.cards.courses=[{id:'c',best:true}];
      const bestOnly=gatherItemsFor('best', sample);
      console.assert(bestOnly.every(x=>x.it.best===true), 'TEST: gatherItemsFor best returns only best');
      const ordOnly=gatherItemsFor('ordinary', sample);
      console.assert(ordOnly.every(x=>x.it.best===false), 'TEST: gatherItemsFor ordinary returns only ordinary');
      const arr=[]; upsertBy(arr,{id:'x',title:'1'},'id'); upsertBy(arr,{id:'x',title:'2'},'id');
      console.assert(arr.length===1 && arr[0].title==='2', 'TEST: upsertBy replaces by id');
      console.assert(toLocal('2025-01-01T10:00:00.000Z').length===16, 'TEST: toLocal returns yyyy-mm-ddTHH:MM');
      console.log('%cSelf-tests passed','color:#2E8B57;font-weight:bold');
    })();
  })();
  </script>

  <!-- Firebase (Users va Promo uchun zarur) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    // Prod config — siz bergan ma'lumotlar
    window.__FIREBASE_CONFIG = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.firebasestorage.app",
      messagingSenderId: "992512966017",
      appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId: "G-459PLJ7P7L"
    };
  </script>
</body>
</html>
