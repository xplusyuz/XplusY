<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MathCenter — Admin (admin.json tahrirlash)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root{--primary:#2E8B57;--primary-d:#1F6B45;--br:#e5e7eb;--muted:#6b7280;--bg:#f7f8fa;--card:#fff;--shadow:0 12px 32px rgba(0,0,0,.08);--radius:14px}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg);color:#111}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--br);box-shadow:var(--shadow);z-index:10}
    .container{max-width:1200px;margin:0 auto;padding:14px 16px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brand{display:flex;align-items:center;gap:10px}
    .pi{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--primary-d));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid var(--br);background:#fff;border-radius:999px;padding:8px 12px;font-weight:700;cursor:pointer}
    .tab.active{background:linear-gradient(135deg,var(--primary),var(--primary-d));color:#fff;border-color:transparent}

    .grid{display:grid;grid-template-columns:360px 1fr;gap:16px;align-items:start;margin:16px auto;max-width:1200px;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--br);border-radius:16px;box-shadow:var(--shadow)}
    .card__head{padding:12px 14px;border-bottom:1px solid var(--br);display:flex;align-items:center;justify-content:space-between}
    .card__body{padding:12px 14px}
    .list{max-height:70vh;overflow:auto}
    .item{display:flex;gap:10px;align-items:center;justify-content:space-between;border:1px dashed var(--br);border-radius:12px;padding:10px;margin:8px 0;background:#fff}
    .item h4{margin:0;font-size:14px}
    .muted{color:var(--muted);font-size:12px}
    .row2{display:flex;gap:10px}
    .group{margin:8px 0}
    label{font-size:12px;color:#111;font-weight:700;display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px;border:1px solid var(--br);border-radius:10px;font-size:14px;background:#fff}
    textarea{min-height:120px;resize:vertical}
    .btn{border:1px solid var(--br);background:#fff;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
    .btn--primary{background:linear-gradient(135deg,var(--primary),var(--primary-d));border:0;color:#fff}
    .btn--danger{border-color:#ef4444;color:#b91c1c}
    .pill{border:1px solid var(--br);border-radius:999px;padding:4px 8px;background:#fff;font-size:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .help{font-size:12px;color:var(--muted)}
    .code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px;background:#0b3d2c;color:#eafff3;padding:8px;border-radius:8px;overflow:auto}
    .hr{height:1px;background:var(--br);margin:12px 0}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="row">
        <div class="brand"><div class="pi">π</div><div><b>MathCenter</b> — Admin</div></div>
        <div class="toolbar">
          <button class="btn" id="btnLoad"><i class="fa-solid fa-folder-open"></i> JSON yuklash</button>
          <button class="btn" id="btnFetch"><i class="fa-solid fa-download"></i> admin.json dan o‘qish</button>
          <button class="btn" id="btnDownload"><i class="fa-solid fa-file-arrow-down"></i> JSON yuklab olish</button>
          <button class="btn" id="btnPretty"><i class="fa-solid fa-wand-magic-sparkles"></i> Pretty format</button>
          <button class="btn btn--primary" id="btnUpload"><i class="fa-solid fa-cloud-arrow-up"></i> Firebase Storage’ga yuklash</button>
        </div>
      </div>
      <div class="help container" style="padding-top:6px">
        <b>Eslatma:</b> admin.json’ni to‘g‘ridan-to‘g‘ri saytga yozib bo‘lmaydi. Bu sahifa JSON’ni tahrirlaydi, keyin <i>yuklab olasiz</i> yoki <i>Firebase Storage</i> ga (public/admin.json) yuklaysiz. Yuklash faqat admin email(lar) uchun ruxsat.
      </div>
    </div>
  </header>

  <main class="grid">
    <!-- LEFT: LIST -->
    <section class="card">
      <div class="card__head">
        <div class="tabs">
          <button class="tab active" data-tab="banners">Bannerlar</button>
          <button class="tab" data-tab="cards">Cardlar</button>
          <button class="tab" data-tab="promos">Promo kodlar</button>
          <button class="tab" data-tab="raw">Raw JSON</button>
        </div>
        <div class="toolbar">
          <button class="btn" id="btnAdd"><i class="fa-solid fa-plus"></i> Yangi</button>
          <button class="btn btn--danger" id="btnDelete"><i class="fa-solid fa-trash"></i> O‘chirish</button>
        </div>
      </div>
      <div class="card__body">
        <div id="list" class="list" aria-live="polite"></div>
      </div>
    </section>

    <!-- RIGHT: EDITOR -->
    <section class="card">
      <div class="card__head"><strong id="editTitle">Tahrirlash</strong></div>
      <div class="card__body" id="editor"></div>
    </section>
  </main>

  <!-- HIDDEN: file chooser -->
  <input id="fileChooser" type="file" accept="application/json" hidden />
  <input id="imgChooser" type="file" accept="image/*" hidden />

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, uploadString } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey:"AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain:"xplusy-760fa.firebaseapp.com",
      projectId:"xplusy-760fa",
      storageBucket:"xplusy-760fa.firebasestorage.app",
      messagingSenderId:"992512966017",
      appId:"1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId:"G-459PLJ7P7L"
    };

    const ADMIN_EMAILS = ["mathcenteruz@gmail.com"]; // kerak bo‘lsa ko‘paytirasiz

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);
    const provider = new GoogleAuthProvider();

    /* ---------------- State ---------------- */
    const state = {
      data: { version:1, banners:[], cards:[], promo_codes:[] },
      tab: 'banners',
      selType: null, // 'banners' | 'cards' | 'promos'
      selId: null,
    };

    /* --------------- Shortcuts -------------- */
    const $ = (q, root=document) => root.querySelector(q);
    const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));
    const list = $('#list');
    const editor = $('#editor');
    const fileChooser = $('#fileChooser');
    const imgChooser = $('#imgChooser');

    function uid(p){ return (p||'id')+'-'+Math.random().toString(36).slice(2,8); }

    /* --------------- Tabs + List -------------- */
    $$('.tab').forEach(t=>t.addEventListener('click',()=>{
      $$('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      state.tab = t.dataset.tab;
      state.selId = null; state.selType = null;
      renderList(); renderEditor();
    }));

    function renderList(){
      const type = state.tab;
      const arr = type==='banners' ? state.data.banners : type==='cards' ? state.data.cards : type==='promos' ? state.data.promo_codes : [];
      if (state.tab==='raw') { list.innerHTML = '<div class="help">Butun JSON o‘ng tomondagi <b>Raw JSON</b> editorida.</div>'; renderRaw(); return; }
      list.innerHTML = arr.map(item=>{
        const title = (item.title || item.code || '(sarlavha yo‘q)');
        const sub = item.id ? ('#'+item.id) : (item.code ? 'promo' : '');
        return `<div class="item" data-id="${item.id||item.code}" data-type="${type}">
          <div>
            <h4>${title}</h4>
            <div class="muted">${sub}</div>
          </div>
          <div style="display:flex;gap:6px;align-items:center">
            <span class="pill">${type}</span>
            ${(item.visible===false && type!=='promos')?'<span class="pill" style="border-color:#ef4444;color:#b91c1c">hidden</span>':''}
          </div>
        </div>`
      }).join('');
      $$('#list .item').forEach(it=>it.addEventListener('click',()=>{
        state.selId = it.dataset.id; state.selType = it.dataset.type; renderEditor();
      }));
    }

    /* --------------- Editor Builders -------------- */
    function inputRow(label, id, value='', type='text', placeholder=''){ return `
      <div class="group">
        <label for="${id}">${label}</label>
        <input id="${id}" type="${type}" placeholder="${placeholder}" value="${value?String(value).replace(/&/g,'&amp;').replace(/\"/g,'&quot;'):''}">
      </div>`; }
    function switchRow(label, id, value=true){ return `
      <div class="group">
        <label>${label}</label>
        <select id="${id}">
          <option value="true" ${value!==false?'selected':''}>Ha</option>
          <option value="false" ${value===false?'selected':''}>Yo‘q</option>
        </select>
      </div>`; }
    function tagsRow(id, tags){ return `
      <div class="group">
        <label>Teglar (vergul bilan)</label>
        <input id="${id}" value="${(tags||[]).join(', ')}" placeholder="masalan: test, algebra">
      </div>`; }
    function pagesRow(id, pages){ const opts=['home','tests','courses','simulators','results']; return `
      <div class="group"><label>Sahifalar</label>
        <div class="row2" style="flex-wrap:wrap">${opts.map(p=>`<label class="pill"><input type="checkbox" data-pg="${id}" value="${p}" ${pages?.includes(p)?'checked':''}> ${p}</label>`).join('')}</div>
      </div>`; }

    function renderEditor(){
      const t = state.tab;
      if (t==='raw') { renderRaw(); return; }
      if (!state.selId){ editor.innerHTML = '<div class="help">Chapdan element tanlang yoki <b>Yangi</b> tugmasini bosing.</div>'; return; }
      const arr = t==='banners' ? state.data.banners : t==='cards' ? state.data.cards : state.data.promo_codes;
      const item = arr.find(x => (x.id||x.code)===state.selId);
      if (!item){ editor.innerHTML = '<div class="help">Topilmadi.</div>'; return; }

      if (t==='banners'){
        editor.innerHTML = `
          ${inputRow('ID','ed_id', item.id || '')}
          ${inputRow('Sarlavha','ed_title', item.title || '')}
          ${inputRow('Rasm URL','ed_image', item.image || '')}
          <div class="row2"><button class="btn" id="btnPickImg"><i class="fa-solid fa-image"></i> Rasm yuklash</button></div>
          ${inputRow('Link','ed_link', item.link || '')}
          ${pagesRow('ed_pages', item.pages||['home'])}
          ${switchRow('Ko‘rinishi','ed_visible', item.visible!==false)}
          <div class="hr"></div>
          <div class="row2">
            <button class="btn btn--primary" id="btnSave"><i class="fa-solid fa-floppy-disk"></i> Saqlash</button>
          </div>`;
      } else if (t==='cards'){
        editor.innerHTML = `
          ${inputRow('ID','ed_id', item.id || '')}
          <div class="group"><label>Tur</label>
            <select id="ed_type">
              <option value="best" ${item.type==='best'?'selected':''}>best</option>
              <option value="ordinary" ${item.type!=='best'?'selected':''}>ordinary</option>
            </select>
          </div>
          ${inputRow('Sarlavha','ed_title', item.title || '')}
          ${inputRow('Rasm URL','ed_image', item.image || '')}
          <div class="row2"><button class="btn" id="btnPickImg"><i class="fa-solid fa-image"></i> Rasm yuklash</button></div>
          ${inputRow('Link','ed_link', item.link || '')}
          ${tagsRow('ed_tags', item.tags)}
          <div class="row2">
            ${inputRow('Boshlanish (ISO)','ed_start', item.startAt||'', 'text', '2025-10-01T09:00:00+05:00')}
            ${inputRow('Tugash (ISO)','ed_end', item.endAt||'', 'text', '2025-10-01T21:00:00+05:00')}
          </div>
          <div class="group">
            <label>Tafsilot (HTML)</label>
            <textarea id="ed_detail">${item.detailHtml||item.detailText||''}</textarea>
          </div>
          ${pagesRow('ed_pages', item.pages||['home'])}
          ${switchRow('Ko‘rinishi','ed_visible', item.visible!==false)}
          <div class="hr"></div>
          <div class="row2">
            <button class="btn btn--primary" id="btnSave"><i class="fa-solid fa-floppy-disk"></i> Saqlash</button>
          </div>`;
      } else { // promos
        editor.innerHTML = `
          ${inputRow('Promo kod','ed_code', item.code || '')}
          ${inputRow('Chegirma %','ed_discount', item.discountPercent || 0, 'number')}
          ${inputRow('Maks ishlatish (0=cheksiz)','ed_max', item.maxUse ?? 0, 'number')}
          <div class="row2">
            ${inputRow('Valid from (ISO)','ed_from', item.validFrom||'', 'text')}
            ${inputRow('Valid to (ISO)','ed_to', item.validTo||'', 'text')}
          </div>
          <div class="hr"></div>
          <div class="row2">
            <button class="btn btn--primary" id="btnSave"><i class="fa-solid fa-floppy-disk"></i> Saqlash</button>
          </div>`;
      }

      // hooks
      $('#btnSave')?.addEventListener('click', saveEdits);
      $('#btnPickImg')?.addEventListener('click', ()=> imgChooser.click());
    }

    function readPages(id){ return $$('input[type="checkbox"][data-pg="'+id+'"]:checked').map(x=>x.value); }

    function saveEdits(){
      const t = state.tab;
      const arr = t==='banners' ? state.data.banners : t==='cards' ? state.data.cards : state.data.promo_codes;
      const idx = arr.findIndex(x => (x.id||x.code)===state.selId);
      if (idx<0) return alert('Topilmadi');
      const it = arr[idx];
      if (t==='banners'){
        it.id = $('#ed_id').value.trim() || it.id || uid('bnr');
        it.title = $('#ed_title').value.trim();
        it.image = $('#ed_image').value.trim();
        it.link  = $('#ed_link').value.trim();
        it.pages = readPages('ed_pages');
        it.visible = ($('#ed_visible').value==='true');
        state.selId = it.id;
      } else if (t==='cards'){
        it.id = $('#ed_id').value.trim() || it.id || uid('c');
        it.type = $('#ed_type').value;
        it.title = $('#ed_title').value.trim();
        it.image = $('#ed_image').value.trim();
        it.link  = $('#ed_link').value.trim();
        it.tags  = ($('#ed_tags').value||'').split(',').map(s=>s.trim()).filter(Boolean);
        it.startAt = $('#ed_start').value.trim() || null;
        it.endAt = $('#ed_end').value.trim() || null;
        it.detailHtml = $('#ed_detail').value;
        it.pages = readPages('ed_pages');
        it.visible = ($('#ed_visible').value==='true');
        state.selId = it.id;
      } else {
        it.code = $('#ed_code').value.trim().toUpperCase();
        it.discountPercent = +($('#ed_discount').value||0);
        it.maxUse = +($('#ed_max').value||0);
        it.validFrom = $('#ed_from').value.trim() || null;
        it.validTo   = $('#ed_to').value.trim() || null;
        state.selId = it.code;
      }
      renderList(); renderEditor();
    }

    /* -------- Add / Delete -------- */
    $('#btnAdd').addEventListener('click',()=>{
      if (state.tab==='banners'){
        const o={ id: uid('bnr'), title:'Yangi banner', image:'', link:'', pages:['home'], visible:true };
        state.data.banners.unshift(o); state.selId=o.id; state.selType='banners';
      } else if (state.tab==='cards'){
        const o={ id: uid('c'), type:'ordinary', title:'Yangi card', image:'', link:'', tags:[], pages:['home'], visible:true };
        state.data.cards.unshift(o); state.selId=o.id; state.selType='cards';
      } else if (state.tab==='promos'){
        const o={ code:'NEWCODE', discountPercent:10, maxUse:0, validFrom:null, validTo:null };
        state.data.promo_codes.unshift(o); state.selId=o.code; state.selType='promos';
      }
      renderList(); renderEditor();
    });

    $('#btnDelete').addEventListener('click',()=>{
      if (!state.selId) return alert('Avval element tanlang');
      if (!confirm('Rostdan o‘chirasizmi?')) return;
      if (state.selType==='banners' || state.tab==='banners') state.data.banners = state.data.banners.filter(x=>x.id!==state.selId);
      else if (state.selType==='cards' || state.tab==='cards') state.data.cards = state.data.cards.filter(x=>x.id!==state.selId);
      else state.data.promo_codes = state.data.promo_codes.filter(x=>(x.code)!==state.selId);
      state.selId=null; renderList(); renderEditor();
    });

    /* -------- Image upload to Firebase Storage -------- */
    $('#editor').addEventListener('click', (e)=>{
      if (e.target && e.target.id==='btnPickImg') imgChooser.click();
    });
    imgChooser.addEventListener('change', async ()=>{
      const f = imgChooser.files?.[0]; if(!f) return;
      const user = auth.currentUser || await signIn();
      if (!isAdmin(user)) return alert('Rasm yuklash uchun admin sifatida kiring.');
      const path = `uploads/${Date.now()}-${f.name.replace(/[^a-zA-Z0-9_.-]/g,'_')}`;
      const r = ref(storage, path);
      await uploadBytes(r, f);
      const url = await getDownloadURL(r);
      const el = $('#ed_image'); if (el) el.value = url;
      alert('Yuklandi! URL maydonga qo‘yildi.');
    });

    /* -------- Load / Fetch / Download / Pretty / Upload -------- */
    $('#btnLoad').addEventListener('click', ()=> fileChooser.click());
    fileChooser.addEventListener('change', async ()=>{
      const file = fileChooser.files?.[0]; if(!file) return;
      const text = await file.text();
      try{ state.data = JSON.parse(text); normalize(); renderList(); renderEditor(); alert('Yuklandi.'); }
      catch(e){ alert('JSON xatolik: '+e.message); }
    });

    $('#btnFetch').addEventListener('click', async ()=>{
      try{
        const r = await fetch('admin.json?_=' + Date.now());
        if(!r.ok) throw new Error('HTTP '+r.status);
        const j = await r.json(); state.data = j; normalize(); renderList(); renderEditor(); alert('admin.json o‘qildi.');
      }catch(e){ alert('O‘qishda xatolik: '+e.message); }
    });

    $('#btnDownload').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(state.data, null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'admin.json'; a.click(); URL.revokeObjectURL(a.href);
    });

    $('#btnPretty').addEventListener('click', ()=>{ try{ state.data = JSON.parse(JSON.stringify(state.data)); renderList(); renderEditor(); }catch{} });

    $('#btnUpload').addEventListener('click', async ()=>{
      const user = auth.currentUser || await signIn();
      if (!isAdmin(user)) return alert('Faqat admin yuklashi mumkin.');
      try{
        const json = JSON.stringify(state.data, null, 2);
        const r = ref(storage, 'public/admin.json');
        await uploadString(r, json, 'raw', { contentType: 'application/json; charset=utf-8' });
        const url = await getDownloadURL(r);
        alert('Yuklandi → '+url+'\nSaytda ishlashi uchun fetch("admin.json") o‘rniga shu public URLni qo‘ying yoki rewriteni sozlang.');
      }catch(e){ alert('Yuklashda xatolik: '+e.message); }
    });

    /* -------- Auth helpers -------- */
    onAuthStateChanged(auth, (u)=>{ window.__adminUser = u||null; });
    function isAdmin(u){ return !!u && ADMIN_EMAILS.includes((u.email||'').toLowerCase()); }
    async function signIn(){ try{ const r=await signInWithPopup(auth, new GoogleAuthProvider()); return r.user; }catch(e){ console.error(e); return null; } }

    /* -------- Raw JSON tab -------- */
    function renderRaw(){
      editor.innerHTML = `<div class="group"><label>Raw JSON</label><textarea id="rawJson" class="code" style="min-height:420px">${JSON.stringify(state.data, null, 2)}</textarea></div>
      <div class="row2"><button class="btn btn--primary" id="btnApplyRaw"><i class="fa-solid fa-floppy-disk"></i> Qo‘llash</button></div>`;
      $('#btnApplyRaw').addEventListener('click',()=>{
        try{ const j = JSON.parse($('#rawJson').value); state.data = j; normalize(); renderList(); renderEditor(); alert('Yangilandi'); }
        catch(e){ alert('JSON xatolik: '+e.message); }
      });
    }

    /* -------- Normalize / Init -------- */
    function normalize(){
      state.data.version ||= 1;
      state.data.banners ||= [];
      state.data.cards ||= [];
      state.data.promo_codes ||= [];
      // to‘ldirish
      state.data.banners.forEach(b=>{ b.id ||= uid('bnr'); b.pages ||= ['home']; if (typeof b.visible==='undefined') b.visible=true; });
      state.data.cards.forEach(c=>{ c.id ||= uid('c'); c.type = (c.type==='best')?'best':'ordinary'; c.pages ||= ['home']; if (typeof c.visible==='undefined') c.visible=true; });
      state.data.promo_codes.forEach(p=>{ p.code = (p.code||'').toUpperCase(); p.discountPercent = +(+p.discountPercent||0); p.maxUse = +(p.maxUse??0); p.validFrom = p.validFrom||null; p.validTo = p.validTo||null; });
    }

    // Init with example (admin.json) if available
    try{ const r = await fetch('admin.json?_=' + Date.now()); if(r.ok){ state.data = await r.json(); normalize(); } }
    catch{}
    renderList(); renderEditor();
  </script>
</body>
</html>
