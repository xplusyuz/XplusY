<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MathCenter Admin â€” Neo+</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--brand:#16a34a}
    .glass{backdrop-filter:blur(14px); background:rgba(255,255,255,.78)}
    .btn{@apply px-3 py-2 rounded-xl shadow transition font-medium}
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{@apply bg-green-600 text-white}
    .btn-secondary{@apply bg-white border border-gray-200}
    .input{@apply w-full rounded-xl border border-gray-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-400}
    .card{@apply rounded-3xl shadow-sm border border-gray-100 bg-white}
    .tag{@apply text-xs px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700}
    /* 3D gradient hover */
    .g3d{position:relative; isolation:isolate}
    .g3d::before{content:""; position:absolute; inset:-1px; z-index:-1; border-radius:inherit; background:conic-gradient(from 180deg at 50% 50%, #10b981 0%, #06b6d4 40%, #a78bfa 70%, #10b981 100%); filter:blur(18px); opacity:.35; transition:.35s}
    .g3d:hover::before{opacity:.75; filter:blur(10px)}
    .g3d:hover{transform:translateY(-3px); box-shadow:0 25px 60px rgba(16,185,129,.25)}

    /* Modal FX */
    dialog.neo{border:none; padding:0; border-radius:20px; overflow:hidden; box-shadow:0 30px 80px rgba(2,6,23,.25)}
    dialog.neo[open]{animation:pop .18s ease-out}
    @keyframes pop{from{transform:translateY(6px) scale(.98); opacity:0} to{transform:none; opacity:1}}
    dialog::backdrop{background:linear-gradient(45deg, rgba(16,185,129,.3), rgba(6,182,212,.3)); backdrop-filter:blur(2px)}

    .badge{ @apply absolute top-2 right-2 text-[10px] font-bold px-2 py-1 rounded-full shadow; }
    .badge-free{ @apply bg-emerald-600 text-white; }
    .badge-pro{ @apply bg-amber-500 text-white; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-emerald-50 via-white to-sky-50 text-gray-900">
  <!-- LOGIN SCREEN (Modern) -->
  <section id="loginPane" class="min-h-screen grid place-items-center px-4">
    <div class="relative w-full max-w-md">
      <div class="absolute -inset-1 rounded-3xl bg-gradient-to-r from-emerald-400 to-sky-400 blur"></div>
      <div class="relative glass rounded-3xl p-6 border border-white/60 shadow-xl">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-emerald-500 to-emerald-600 grid place-items-center text-white text-2xl font-black">Ï€</div>
          <div>
            <h1 class="text-xl font-bold">MathCenter Admin</h1>
            <p class="text-xs text-gray-600">Xavfsiz kirish</p>
          </div>
        </div>
        <form class="mt-5 space-y-3" onsubmit="return false;">
          <div>
            <label class="text-sm text-gray-600">Login</label>
            <div class="relative">
              <input id="inpLogin" class="input pr-10" autocomplete="username" placeholder="Login"/>
              <span class="absolute inset-y-0 right-3 grid place-items-center text-gray-400">ğŸ‘¤</span>
            </div>
          </div>
          <div>
            <label class="text-sm text-gray-600">Parol</label>
            <div class="relative">
              <input id="inpPass" type="password" class="input pr-10" autocomplete="current-password" placeholder="Parol"/>
              <button id="btnEye" type="button" class="absolute inset-y-0 right-0 px-3 text-gray-500">ğŸ‘ï¸</button>
            </div>
          </div>
          <button id="btnLogin" type="button" class="btn btn-primary w-full">Kirish</button>
          <div class="text-[11px] text-gray-500 leading-snug">
            Promo va foydalanuvchilar Firestore orqali boshqariladi; qolganlari qurilmangizda lokal saqlanadi.
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- APP SHELL -->
  <header id="topbar" class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-gray-100 hidden">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-2">
        <div class="w-9 h-9 rounded-2xl bg-gradient-to-br from-emerald-500 to-emerald-600 grid place-items-center text-white text-xl font-black">Ï€</div>
        <div>
          <div class="text-sm font-semibold">MathCenter Admin â€” Neo+</div>
          <div class="text-xs text-gray-500">Boshqaruv paneli</div>
        </div>
      </div>
      <nav class="ml-6 hidden md:flex gap-1">
        <button data-tab="tab-home" class="tab btn btn-secondary">ğŸ  Bannerlar</button>
        <button data-tab="tab-courses" class="tab btn btn-secondary">ğŸ“š Kurslar</button>
        <button data-tab="tab-tests" class="tab btn btn-secondary">ğŸ“ Testlar</button>
        <button data-tab="tab-sims" class="tab btn btn-secondary">ğŸ§ª Simulyatorlar</button>
        <button data-tab="tab-promos" class="tab btn btn-secondary">ğŸ·ï¸ Promolar</button>
        <button data-tab="tab-users" class="tab btn btn-secondary">ğŸ‘¥ Foydalanuvchilar</button>
      </nav>
      <div class="ml-auto flex items-center gap-2">
        <span id="whoami" class="text-sm text-gray-600"></span>
        <button id="btnLogout" type="button" class="btn btn-secondary">Chiqish</button>
      </div>
    </div>
  </header>

  <main id="adminUi" class="max-w-7xl mx-auto px-4 py-6 hidden">
    <!-- HOME / BANNERS -->
    <section id="tab-home" class="tab-pane">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Katta reklama bannerlari</h2>
        <button id="btnAddBanner" class="btn btn-primary">â• Yangi banner</button>
      </div>
      <div id="bannersWrap" class="grid lg:grid-cols-2 gap-6"></div>

      <!-- Live Hero Preview -->
      <div class="mt-8">
        <h3 class="text-lg font-semibold">Jonli preview</h3>
        <div class="relative mt-3 rounded-3xl overflow-hidden border shadow g3d">
          <div class="absolute inset-0 z-0 bg-[url('https://images.unsplash.com/photo-1549221986-3d8b6e8d3c61')] bg-cover bg-center" id="heroBg"></div>
          <div class="absolute inset-0 z-[1] bg-gradient-to-br from-black/55 via-emerald-900/25 to-transparent"></div>
          <div class="relative z-[2] p-8 md:p-12 lg:p-16 text-white grid lg:grid-cols-2 gap-8 min-h-[380px]">
            <div>
              <div class="text-emerald-200 text-xs font-bold tracking-wide uppercase">MathCenter</div>
              <h1 id="heroTitle" class="text-3xl md:text-4xl font-black leading-tight mt-2">Sarlavha</h1>
              <p id="heroSub" class="text-white/90 mt-3 max-w-xl">Qisqa tavsif matniâ€¦</p>
              <div id="heroTags" class="flex flex-wrap gap-2 mt-3"></div>
              <div class="mt-5 flex gap-3">
                <a id="heroBtn" class="btn bg-white text-emerald-700 border border-white shadow-xl" target="_blank">Boshlash</a>
                <a id="heroLink" class="btn btn-secondary bg-white/20 text-white border-white/40" target="_blank">Batafsil</a>
              </div>
            </div>
            <div class="hidden lg:block"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- COURSES -->
    <section id="tab-courses" class="tab-pane hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Kurslar</h2>
        <button id="addCourse" class="btn btn-primary">â• Kurs qoâ€˜shish</button>
      </div>
      <div id="coursesGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <!-- TESTS -->
    <section id="tab-tests" class="tab-pane hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Testlar</h2>
        <button id="addTest" class="btn btn-primary">â• Test qoâ€˜shish</button>
      </div>
      <!-- Filters: up to 3 tags -->
      <div class="flex flex-wrap gap-2 mb-4" id="testFilters"></div>
      <div id="testsGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <!-- SIMULATORS -->
    <section id="tab-sims" class="tab-pane hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Simulyatorlar</h2>
        <button id="addSimulator" class="btn btn-primary">â• Simulyator qoâ€˜shish</button>
      </div>
      <div id="simsGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <!-- PROMOS (Firestore) -->
    <section id="tab-promos" class="tab-pane hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Promo kodlar</h2>
        <button id="addPromo" class="btn btn-primary">â• Promo kod</button>
      </div>
      <div id="promosGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>

    <!-- USERS (Firestore) -->
    <section id="tab-users" class="tab-pane hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Foydalanuvchilar</h2>
        <div class="flex gap-2">
          <input id="userSearch" class="input w-64" placeholder="Qidirish (ism/email/id)" />
          <button id="btnReloadUsers" class="btn btn-secondary">ğŸ”„ Yangilash</button>
        </div>
      </div>
      <div class="overflow-x-auto card">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-gray-500">
              <th class="py-2 px-3">ID</th>
              <th class="py-2 px-3">Ism</th>
              <th class="py-2 px-3">Email</th>
              <th class="py-2 px-3">Balans</th>
              <th class="py-2 px-3">Ball (Gems)</th>
              <th class="py-2 px-3">Rol</th>
              <th class="py-2 px-3">Holat</th>
              <th class="py-2 px-3">Amal</th>
            </tr>
          </thead>
          <tbody id="usersTbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- MODAL (upgraded) -->
  <dialog id="crudModal" class="neo w-[95vw] max-w-2xl">
    <form method="dialog" class="glass p-0">
      <div class="flex items-center justify-between px-5 py-3 border-b">
        <h3 id="crudTitle" class="text-lg font-semibold">Tahrirlash</h3>
        <button id="crudClose" class="px-2 py-1 text-gray-500" type="button">âœ–</button>
      </div>
      <div class="p-5 space-y-3" id="crudBody"></div>
      <div class="flex items-center justify-end gap-2 px-5 py-3 border-t">
        <button class="btn btn-secondary" id="crudCancel" type="button">Bekor</button>
        <button id="crudSave" class="btn btn-primary" type="button">Saqlash</button>
      </div>
    </form>
  </dialog>

  <!-- Templates -->
  <template id="bannerCardTpl">
    <article class="relative rounded-3xl overflow-hidden border shadow g3d">
      <img class="w-full h-56 object-cover banner-img" />
      <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent"></div>
      <div class="absolute bottom-0 p-4 text-white">
        <div class="text-xs text-emerald-200 font-bold">Banner</div>
        <div class="text-lg font-semibold title">â€”</div>
        <div class="text-sm opacity-90 subtitle">â€”</div>
        <div class="mt-2 flex flex-wrap gap-2 tags"></div>
        <div class="mt-3 flex gap-2">
          <a class="btn bg-white text-emerald-700 border border-white/60 link" target="_blank">Boshlash</a>
          <button class="btn btn-secondary edit" type="button">âœï¸</button>
          <button class="btn btn-secondary del" type="button">ğŸ—‘ï¸</button>
        </div>
      </div>
    </article>
  </template>

  <template id="gridCardTpl">
    <div class="card overflow-hidden relative g3d group">
      <span class="badge badge-free hidden">FREE</span>
      <span class="badge badge-pro hidden">PRO</span>
      <img class="w-full h-40 object-cover"/>
      <div class="p-4">
        <div class="font-semibold title line-clamp-1">â€”</div>
        <div class="text-xs text-gray-500 subtitle line-clamp-2">â€”</div>
        <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
          <a class="btn btn-secondary startLink" target="_blank">Boshlash</a>
          <div class="text-right font-semibold price">â€”</div>
        </div>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-secondary btn-edit" type="button">âœï¸</button>
          <button class="btn btn-secondary btn-delete" type="button">ğŸ—‘ï¸</button>
        </div>
      </div>
    </div>
  </template>

  <template id="testCardTpl">
    <div class="card overflow-hidden relative g3d">
      <span class="badge badge-free hidden">FREE</span>
      <span class="badge badge-pro hidden">PRO</span>
      <img class="w-full h-36 object-cover test-img hidden"/>
      <div class="p-4">
        <div class="flex items-center justify-between">
          <div class="font-semibold title line-clamp-1">Test</div>
          <span class="text-xs px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 type">Oddiy</span>
        </div>
        <p class="text-xs text-gray-500 mt-1 subtitle">â€”</p>
        <div class="mt-2 text-xs text-gray-600 schedule">â€”</div>
        <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
          <button class="btn btn-secondary openBtn" type="button">Boshlash</button>
          <div class="flex gap-2 justify-end">
            <button class="btn btn-secondary infoBtn hidden" type="button">â„¹ï¸ Info</button>
            <a class="btn btn-secondary link" target="_blank">Havola</a>
          </div>
        </div>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-secondary btn-edit" type="button">âœï¸</button>
          <button class="btn btn-secondary btn-delete" type="button">ğŸ—‘ï¸</button>
        </div>
      </div>
    </div>
  </template>

  <script type="module">
    // ===== Login (offline) =====
    const VALID_LOGIN='Sohibjonmath';
    const VALID_PASS='Math@1999';
    const LS_AUTH='mc_auth3';

    const loginPane=document.getElementById('loginPane');
    const adminUi=document.getElementById('adminUi');
    const topbar=document.getElementById('topbar');
    const whoami=document.getElementById('whoami');

    document.getElementById('btnEye').onclick=()=>{
      const p=document.getElementById('inpPass');
      p.type=p.type==='password'?'text':'password';
    };

    document.getElementById('btnLogin').onclick=()=>{
      const u=document.getElementById('inpLogin').value.trim();
      const p=document.getElementById('inpPass').value;
      if(u===VALID_LOGIN && p===VALID_PASS){ localStorage.setItem(LS_AUTH,'1'); applyAuth(); }
      else alert('Login yoki parol notoâ€˜gâ€˜ri.');
    };
    document.getElementById('btnLogout').onclick=()=>{ localStorage.removeItem(LS_AUTH); applyAuth(); };

    function applyAuth(){
      const ok=localStorage.getItem(LS_AUTH)==='1';
      loginPane.classList.toggle('hidden',ok);
      adminUi.classList.toggle('hidden',!ok);
      topbar.classList.toggle('hidden',!ok);
      whoami.textContent=ok?'Admin':'';
      if(ok) initOnce();
    }

    // ===== Local data layer (except promos/users) =====
    const LS={ banners:'neo2_banners', courses:'neo2_courses', tests:'neo2_tests', sims:'neo2_sims' };
    const get=(k,d)=>{ try{ return JSON.parse(localStorage.getItem(k))??d; }catch{return d;} };
    const set=(k,v)=> localStorage.setItem(k,JSON.stringify(v));

    // ===== Tabs =====
    document.querySelectorAll('.tab').forEach(b=> b.addEventListener('click', ()=> selectTab(b.dataset.tab)));
    function selectTab(id){
      document.querySelectorAll('.tab-pane').forEach(p=>p.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('!bg-emerald-600','!text-white'));
      document.querySelector(`[data-tab="${id}"]`).classList.add('!bg-emerald-600','!text-white');
    }

    // ===== CRUD modal =====
    const crudModal=document.getElementById('crudModal');
    const crudTitle=document.getElementById('crudTitle');
    const crudBody=document.getElementById('crudBody');
    const crudSave=document.getElementById('crudSave');
    const crudCancel=document.getElementById('crudCancel');
    const crudClose=document.getElementById('crudClose');
    crudCancel.onclick=crudClose.onclick=()=>crudModal.close();

    function openCrud({title,fields,onSave}){
      crudTitle.textContent=title; crudBody.innerHTML='';
      fields.forEach(f=>{
        const wrap=document.createElement('div');
        wrap.innerHTML=`<label class="text-sm text-gray-600">${f.label}${f.required?' *':''}</label>${inputHtml(f)}`;
        if(f.type==='checkbox') wrap.querySelector('input').checked=!!f.value; else { const inp=wrap.querySelector('input,textarea,select'); if(inp) inp.value=f.value ?? ''; }
        crudBody.appendChild(wrap);
      });
      crudModal.showModal();
      crudSave.onclick=()=>{
        const vals={}; const inputs=crudBody.querySelectorAll('input,textarea,select');
        for(const el of inputs){ const key=el.name; let v=(el.type==='checkbox')?el.checked:el.value; if(el.type==='number') v=Number(v); if(el.required && !v){ alert('Majburiy maydon: '+key); return; } vals[key]=v; }
        onSave(vals).then(()=>crudModal.close()).catch(e=>alert('Xatolik: '+e.message));
      };
    }
    function inputHtml(f){
      if(f.type==='select') return `<select name="${f.key}" class="input">${(f.options||[]).map(o=>`<option value="${o}">${o}</option>`).join('')}</select>`;
      const base=`name="${f.key}" class="input" ${f.required?'required':''}`;
      if(f.type==='textarea') return `<textarea ${base} rows="3"></textarea>`;
      if(f.type==='checkbox') return `<input type="checkbox" ${base}>`;
      const extra=f.step?` step="${f.step}"`:''; return `<input type="${f.type||'text'}" ${base}${extra}>`;
    }
    const esc=s=>String(s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));

    // ===== BANNERS =====
    const bannersWrap=document.getElementById('bannersWrap');
    document.getElementById('btnAddBanner').onclick=()=>{
      openCrud({
        title:'Yangi banner',
        fields:[
          {key:'imageUrl',label:'Fon rasm URL',type:'url',required:true},
          {key:'title',label:'Sarlavha',type:'text',required:true},
          {key:'subtitle',label:'Qisqa matn',type:'textarea'},
          {key:'cta',label:'Tugma matni',type:'text',value:'Boshlash'},
          {key:'link',label:'Tugma havolasi',type:'url'},
          {key:'tags',label:'Meta teglar (vergul bilan)',type:'text',value:'Algebra, Geometriya'}
        ],
        onSave: async(v)=>{ const arr=get(LS.banners,[]); v.tags=String(v.tags||'').split(',').map(s=>s.trim()).filter(Boolean); arr.unshift(v); set(LS.banners,arr); renderBanners(); applyHero(arr[0]); }
      });
    };

    function renderBanners(){
      const arr=get(LS.banners,[]); bannersWrap.innerHTML='';
      arr.forEach((b,idx)=> bannersWrap.appendChild(bannerEl(b,idx)));
      if(arr[0]) applyHero(arr[0]);
    }
    function bannerEl(b,idx){
      const tpl=document.getElementById('bannerCardTpl').content.cloneNode(true);
      tpl.querySelector('.banner-img').src=b.imageUrl;
      tpl.querySelector('.title').textContent=b.title||'â€”';
      tpl.querySelector('.subtitle').textContent=b.subtitle||'â€”';
      tpl.querySelector('.link').href=b.link||'#';
      const tagsWrap=tpl.querySelector('.tags'); tagsWrap.innerHTML=(b.tags||[]).map(t=>`<span class="tag">${esc(t)}</span>`).join('');
      tpl.querySelector('.edit').onclick=()=>{
        openCrud({title:'Banner tahrirlash',fields:[
          {key:'imageUrl',label:'Fon rasm URL',type:'url',required:true,value:b.imageUrl||''},
          {key:'title',label:'Sarlavha',type:'text',required:true,value:b.title||''},
          {key:'subtitle',label:'Qisqa matn',type:'textarea',value:b.subtitle||''},
          {key:'cta',label:'Tugma matni',type:'text',value:b.cta||'Boshlash'},
          {key:'link',label:'Tugma havolasi',type:'url',value:b.link||''},
          {key:'tags',label:'Meta teglar (vergul bilan)',type:'text',value:(b.tags||[]).join(', ')}
        ], onSave: async(v)=>{ v.tags=String(v.tags||'').split(',').map(s=>s.trim()).filter(Boolean); const arr=get(LS.banners,[]); arr[idx]={...arr[idx],...v}; set(LS.banners,arr); renderBanners(); applyHero(arr[idx]); }});
      };
      tpl.querySelector('.del').onclick=()=>{ if(!confirm('Oâ€˜chirishni tasdiqlaysizmi?')) return; const arr=get(LS.banners,[]); arr.splice(idx,1); set(LS.banners,arr); renderBanners(); };
      return tpl;
    }
    function applyHero(b){
      document.getElementById('heroBg').style.backgroundImage=`url('${(b.imageUrl||'').replace(/'/g,'%27')}')`;
      document.getElementById('heroTitle').textContent=b.title||'â€”';
      document.getElementById('heroSub').textContent=b.subtitle||'â€”';
      document.getElementById('heroBtn').textContent=b.cta||'Boshlash';
      document.getElementById('heroBtn').href=b.link||'#';
      document.getElementById('heroLink').href=b.link||'#';
      const tags=(b.tags||[]).map(t=>`<span class="tag">${esc(t)}</span>`).join('');
      document.getElementById('heroTags').innerHTML=tags;
    }

    // ===== COURSES & SIMS =====
    const catalog={
      courses:{ grid:'coursesGrid', title:'Kurs', ls:LS.courses, btn:'Boshlash' },
      sims:{ grid:'simsGrid', title:'Simulyator', ls:LS.sims, btn:'Oâ€˜ynash' }
    };
    document.getElementById('addCourse').onclick=()=> addItem('courses');
    document.getElementById('addSimulator').onclick=()=> addItem('sims');

    function addItem(kind){
      const cfg=catalog[kind];
      openCrud({ title:cfg.title+' qoâ€˜shish', fields:[
        {key:'imageUrl',label:'Rasm URL',type:'url',required:true},
        {key:'title',label:'Nomi',type:'text',required:true},
        {key:'subtitle',label:'Info',type:'textarea'},
        {key:'link',label:'Tugma havolasi',type:'url'},
        {key:'price',label:'Narx (UZS)',type:'number',value:0},
        {key:'rating',label:'Reyting (0-5)',type:'number',step:'0.1',value:5}
      ], onSave: async(v)=>{ const arr=get(cfg.ls,[]); arr.unshift(v); set(cfg.ls,arr); renderGrid(kind); }});
    }
    function editItem(kind,idx){
      const cfg=catalog[kind]; const arr=get(cfg.ls,[]); const x=arr[idx];
      openCrud({ title:cfg.title+' tahrirlash', fields:[
        {key:'imageUrl',label:'Rasm URL',type:'url',required:true,value:x.imageUrl||''},
        {key:'title',label:'Nomi',type:'text',required:true,value:x.title||''},
        {key:'subtitle',label:'Info',type:'textarea',value:x.subtitle||''},
        {key:'link',label:'Tugma havolasi',type:'url',value:x.link||''},
        {key:'price',label:'Narx (UZS)',type:'number',value:x.price||0},
        {key:'rating',label:'Reyting (0-5)',type:'number',step:'0.1',value:x.rating??5}
      ], onSave: async(v)=>{ arr[idx]={...x,...v}; set(cfg.ls,arr); renderGrid(kind); }});
    }
    function renderGrid(kind){
      const cfg=catalog[kind]; const wrap=document.getElementById(cfg.grid); wrap.innerHTML='';
      const arr=get(cfg.ls,[]);
      arr.forEach((data,idx)=>{
        const tpl=document.getElementById('gridCardTpl').content.cloneNode(true);
        const free=Number(data.price||0)===0; tpl.querySelector('.badge-free').classList.toggle('hidden',!free); tpl.querySelector('.badge-pro').classList.toggle('hidden',free);
        tpl.querySelector('img').src=data.imageUrl||'';
        tpl.querySelector('.title').textContent=data.title||'â€”';
        tpl.querySelector('.subtitle').textContent=data.subtitle||'â€”';
        tpl.querySelector('.startLink').textContent=cfg.btn; tpl.querySelector('.startLink').href=data.link||'#';
        tpl.querySelector('.price').textContent=(data.price? new Intl.NumberFormat('uz-UZ').format(data.price)+' soâ€˜m':'Bepul');
        tpl.querySelector('.btn-edit').onclick=()=> editItem(kind,idx);
        tpl.querySelector('.btn-delete').onclick=()=>{ if(!confirm('Oâ€˜chirishni tasdiqlaysizmi?')) return; const a=get(cfg.ls,[]); a.splice(idx,1); set(cfg.ls,a); renderGrid(kind); };
        wrap.appendChild(tpl);
      });
    }

    // ===== TESTS (simple/online) =====
    const testLS=LS.tests;
    document.getElementById('addTest').onclick=()=>{
      openCrud({ title:'Yangi test', fields:[
        {key:'type',label:'Turi',type:'select',options:['Oddiy','Online'],value:'Oddiy'},
        {key:'title',label:'Sarlavha',type:'text',required:true},
        {key:'subtitle',label:'Qisqa info',type:'textarea'},
        {key:'price',label:'Narx (UZS)',type:'number',value:0},
        {key:'imageUrl',label:'Rasm (Oddiy uchun)',type:'url'},
        {key:'link',label:'Havola',type:'url'},
        {key:'startAt',label:'Boshlash (Online)',type:'text'},
        {key:'endAt',label:'Tugash (Online)',type:'text'},
        {key:'infoText',label:'Info matni (Online info tugmasi uchun)',type:'textarea'},
        {key:'tags',label:'Teglar (filter, vergul bilan)',type:'text',value:'Algebra,Geometriya'}
      ], onSave: async(v)=>{ v.tags=String(v.tags||'').split(',').map(s=>s.trim()).filter(Boolean); const arr=get(testLS,[]); arr.unshift(v); set(testLS,arr); renderTests(); }});
    };

    const testsGrid=document.getElementById('testsGrid');
    const testFilters=document.getElementById('testFilters');
    let activeTags=new Set();

    function renderTests(){
      const arr=get(testLS,[]);
      const allTags=[...new Set(arr.flatMap(x=>x.tags||[]))].slice(0,12);
      testFilters.innerHTML=allTags.map(t=>`<button data-t="${esc(t)}" class="px-3 py-1 rounded-full border ${activeTags.has(t)?'bg-emerald-600 text-white border-emerald-600':'bg-white'} text-sm">${esc(t)}</button>`).join('');
      testFilters.querySelectorAll('button').forEach(b=> b.onclick=()=>{ const t=b.dataset.t; if(activeTags.has(t)) activeTags.delete(t); else { if(activeTags.size>=3){ alert('Maksimum 3 ta filter.'); return;} activeTags.add(t);} renderTests(); });

      const list=arr.filter(x=> activeTags.size? (x.tags||[]).some(t=>activeTags.has(t)) : true);
      testsGrid.innerHTML='';
      list.forEach((x,idx)=> testsGrid.appendChild(testCard(x,idx)));
    }

    function testCard(x,idx){
      const tpl=document.getElementById('testCardTpl').content.cloneNode(true);
      const free=Number(x.price||0)===0; tpl.querySelector('.badge-free').classList.toggle('hidden',!free); tpl.querySelector('.badge-pro').classList.toggle('hidden',free);
      const typeStr=(x.type||'Oddiy');
      tpl.querySelector('.type').textContent= typeStr;
      tpl.querySelector('.title').textContent=x.title||'â€”';
      tpl.querySelector('.subtitle').textContent=x.subtitle||'â€”';
      const img=tpl.querySelector('.test-img'); if(typeStr==='Oddiy' && x.imageUrl){ img.src=x.imageUrl; img.classList.remove('hidden'); }
      const linkEl=tpl.querySelector('.link'); linkEl.href=x.link||'#';
      const openBtn=tpl.querySelector('.openBtn');
      const schedule=tpl.querySelector('.schedule');
      const infoBtn=tpl.querySelector('.infoBtn');

      if(typeStr==='Online'){
        infoBtn.classList.remove('hidden');
        infoBtn.onclick=()=> showInfoModal(x.title||'Info', x.infoText||'');
        const now=new Date();
        const s=x.startAt? new Date(x.startAt): null; const e=x.endAt? new Date(x.endAt): null;
        let msg='â€”'; let enabled=false;
        if(s&&e){ msg=`${s.toLocaleString()} â€” ${e.toLocaleString()}`; enabled= now>=s && now<=e; }
        else if(s){ msg=`Boshlanish: ${s.toLocaleString()}`; enabled= now>=s; }
        else if(e){ msg=`Tugash: ${e.toLocaleString()}`; enabled= now<=e; }
        schedule.textContent=msg;
        openBtn.disabled=!enabled; openBtn.classList.toggle('opacity-50',!enabled);
        openBtn.onclick=()=>{ if(!enabled) return; window.open(x.link||'#','_blank'); };
      } else {
        schedule.textContent='â€”';
        openBtn.onclick=()=> window.open(x.link||'#','_blank');
      }

      tpl.querySelector('.btn-edit').onclick=()=>{
        openCrud({ title:'Test tahrirlash', fields:[
          {key:'type',label:'Turi',type:'select',options:['Oddiy','Online'],value:typeStr},
          {key:'title',label:'Sarlavha',type:'text',required:true,value:x.title||''},
          {key:'subtitle',label:'Qisqa info',type:'textarea',value:x.subtitle||''},
          {key:'price',label:'Narx (UZS)',type:'number',value:x.price||0},
          {key:'imageUrl',label:'Rasm (Oddiy uchun)',type:'url',value:x.imageUrl||''},
          {key:'link',label:'Havola',type:'url',value:x.link||''},
          {key:'startAt',label:'Boshlash (Online)',type:'text',value:x.startAt||''},
          {key:'endAt',label:'Tugash (Online)',type:'text',value:x.endAt||''},
          {key:'infoText',label:'Info matni (Online)',type:'textarea',value:x.infoText||''},
          {key:'tags',label:'Teglar (vergul bilan)',type:'text',value:(x.tags||[]).join(', ')}
        ], onSave: async(v)=>{ v.tags=String(v.tags||'').split(',').map(s=>s.trim()).filter(Boolean); const arr=get(testLS,[]); arr[idx]={...arr[idx],...v}; set(testLS,arr); renderTests(); }});
      };
      tpl.querySelector('.btn-delete').onclick=()=>{ if(!confirm('Oâ€˜chirishni tasdiqlaysizmi?')) return; const arr=get(testLS,[]); arr.splice(idx,1); set(testLS,arr); renderTests(); };
      return tpl;
    }

    function showInfoModal(title, text){
      openCrud({ title: title+' â€” maÊ¼lumot', fields:[{key:'info',label:'',type:'textarea',value:text}], onSave: async()=> Promise.resolve() });
      // faqat ko'rish rejimi: saqlash tugmasini yashiramiz
      document.getElementById('crudSave').classList.add('hidden');
    }

    // ===== PROMOS & USERS (Firestore) =====
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const firebaseConfig={
      apiKey:"AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain:"xplusy-760fa.firebaseapp.com",
      projectId:"xplusy-760fa",
      storageBucket:"xplusy-760fa.appspot.com",
      messagingSenderId:"992512966017",
      appId:"1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId:"G-459PLJ7P7L"
    };
    const fApp=initializeApp(firebaseConfig, 'admin-secondary');
    const db=getFirestore(fApp);

    // Promos
    document.getElementById('addPromo').onclick=()=>{
      openCrud({ title:'Promo kod qoâ€˜shish', fields:[
        {key:'code',label:'Kod',type:'text',required:true},
        {key:'discountPercent',label:'Chegirma %',type:'number',value:20},
        {key:'maxUses',label:'Maks. foydalanish',type:'number',value:100},
        {key:'usedCount',label:'Ishlatilgan',type:'number',value:0},
        {key:'active',label:'Faol',type:'checkbox',value:true},
        {key:'expiresAt',label:'Tugash sanasi (YYYY-MM-DD)',type:'date'}
      ], onSave: async(v)=>{ await addDoc(collection(db,'promos'), v); await loadPromos(); }});
    };
    async function loadPromos(){
      const wrap=document.getElementById('promosGrid'); wrap.innerHTML='<div class="text-sm text-gray-500">Yuklanmoqdaâ€¦</div>';
      const snap=await getDocs(query(collection(db,'promos'), orderBy('code')));
      wrap.innerHTML='';
      snap.forEach(d=>{
        const p={id:d.id, ...d.data()};
        const card=document.createElement('div'); card.className='card p-4 g3d';
        card.innerHTML=`<div class='flex items-center justify-between'>
          <div>
            <div class='text-xs text-gray-500'>Promo</div>
            <div class='text-lg font-semibold'>${esc(p.code||'â€”')}</div>
            <div class='text-sm text-gray-600'>${Number(p.discountPercent||0)}% Â· Max ${p.maxUses||0} Â· Ishl. ${p.usedCount||0} Â· ${p.active?'âœ… Faol':'â›” Nofaol'}</div>
          </div>
          <div class='flex gap-2'>
            <button class='btn btn-secondary edit'>âœï¸</button>
            <button class='btn btn-secondary del'>ğŸ—‘ï¸</button>
          </div>
        </div>`;
        card.querySelector('.edit').onclick=()=>{
          openCrud({ title:'Promo tahrirlash', fields:[
            {key:'code',label:'Kod',type:'text',required:true,value:p.code||''},
            {key:'discountPercent',label:'Chegirma %',type:'number',value:p.discountPercent||20},
            {key:'maxUses',label:'Maks. foydalanish',type:'number',value:p.maxUses||100},
            {key:'usedCount',label:'Ishlatilgan',type:'number',value:p.usedCount||0},
            {key:'active',label:'Faol',type:'checkbox',value:!!p.active},
            {key:'expiresAt',label:'Tugash sanasi',type:'date',value:p.expiresAt||''}
          ], onSave: async(v)=>{ await updateDoc(doc(db,'promos',p.id), v); await loadPromos(); }});
        };
        card.querySelector('.del').onclick=async()=>{ if(!confirm('Oâ€˜chirishni tasdiqlaysizmi?')) return; await deleteDoc(doc(db,'promos',p.id)); await loadPromos(); };
        wrap.appendChild(card);
      });
    }

    // Users
    const usersTbody=document.getElementById('usersTbody');
    document.getElementById('btnReloadUsers').onclick=()=> loadUsers(document.getElementById('userSearch').value.trim());
    document.getElementById('userSearch').oninput=(e)=> loadUsers(e.target.value.trim());

    async function loadUsers(qStr=''){
      usersTbody.innerHTML='<tr><td class="py-3 text-sm text-gray-500" colspan="8">Yuklanmoqdaâ€¦</td></tr>';
      const snap=await getDocs(query(collection(db,'users'), orderBy('numericId','asc'), limit(200)));
      usersTbody.innerHTML='';
      snap.forEach(d=>{
        const u={id:d.id, ...d.data()};
        const needle=qStr.toLowerCase(); const hay=`${u.numericId||''} ${u.name||''} ${u.email||''}`.toLowerCase();
        if(needle && !hay.includes(needle)) return;
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class='py-2 px-3'>${u.numericId||'â€”'}</td>
          <td class='py-2 px-3'>${esc(u.name||'â€”')}</td>
          <td class='py-2 px-3'>${esc(u.email||'â€”')}</td>
          <td class='py-2 px-3'>${Number(u.balance||0).toFixed(2)}</td>
          <td class='py-2 px-3'>${Number(u.gems||0)}</td>
          <td class='py-2 px-3'>${esc(u.role||'user')}</td>
          <td class='py-2 px-3'>${esc(u.status||'active')}</td>
          <td class='py-2 px-3'><button class='btn btn-secondary edit'>âœï¸</button></td>`;
        tr.querySelector('.edit').onclick=()=>{
          openCrud({ title:'Foydalanuvchi tahrirlash', fields:[
            {key:'name',label:'Ism',type:'text',value:u.name||''},
            {key:'balance',label:'Balans',type:'number',value:u.balance||0},
            {key:'gems',label:'Ball (Gems)',type:'number',value:u.gems||0},
            {key:'role',label:'Rol (user/admin)',type:'text',value:u.role||'user'},
            {key:'status',label:'Holat (active/banned)',type:'text',value:u.status||'active'}
          ], onSave: async(v)=>{ await updateDoc(doc(db,'users',u.id), v); await loadUsers(qStr); }});
        };
        usersTbody.appendChild(tr);
      });
      if(!usersTbody.children.length){ usersTbody.innerHTML='<tr><td class="py-3 text-sm text-gray-500" colspan="8">Hech narsa topilmadi</td></tr>'; }
    }

    // ===== INIT =====
    let booted=false;
    function initOnce(){ if(booted) return; booted=true; selectTab('tab-home'); renderBanners(); renderGrid('courses'); renderGrid('sims'); renderTests(); loadPromos(); loadUsers(''); }

    applyAuth();
  </script>
</body>
</html>
