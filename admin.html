<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — MathCenter.uz</title>
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <style>
    :root{ --green:#0faf64; --edge:#e0f3eb; --bg:#f6fffb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg)}
    header{padding:12px 16px;background:#fff;border-bottom:1px solid var(--edge)}
    main{max-width:1100px;margin:16px auto;padding:0 16px;display:grid;gap:12px}
    .panel{background:#fff;border:1px solid var(--edge);border-radius:16px;padding:14px;box-shadow:0 4px 10px rgba(0,0,0,.06)}
    .row{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    .row3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    @media(max-width:720px){ .row,.row3{grid-template-columns:1fr} }
    label{font-size:12px;opacity:.75}
    input,select,textarea{padding:10px 12px;border:1px solid var(--edge);border-radius:12px;outline:none}
    textarea{min-height:80px}
    .btn{padding:10px 14px;border:1px solid var(--edge);border-radius:12px;background:#fff;font-weight:800;cursor:pointer}
    .btn--pri{background:var(--green);color:#fff;border-color:var(--green)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-top:10px}
    .card{border:1px solid var(--edge);border-radius:12px;padding:10px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px}
  </style>
</head>
<body>
  <header class="topbar">
    <div><b>Admin panel</b></div>
    <div>
      <button id="btnLogin" class="btn btn--pri">Google bilan kirish</button>
      <button id="btnLogout" class="btn" style="display:none">Chiqish</button>
      <a href="index.html" class="btn">Bosh sahifa</a>
    </div>
  </header>

  <main>
    <!-- Banner (home) -->
    <section class="panel">
      <div class="topbar"><h3 style="margin:0">Home banner</h3><span id="bannerStatus"></span></div>
      <div class="row">
        <div><label>Sarlavha</label><input id="b_title"></div>
        <div><label>Tugma matni</label><input id="b_button" placeholder="Boshlash"></div>
        <div><label>Tavsif</label><textarea id="b_desc"></textarea></div>
        <div><label>Link</label><input id="b_link" placeholder="#courses"></div>
        <div><label>Tag (ixtiyoriy)</label><input id="b_tag" placeholder="NEW yoki PROMO"></div>
        <div><label>Rasm URL</label><input id="b_image" placeholder="https://..."></div>
        <div><label>Rasm yuklash</label><input type="file" id="b_file" accept="image/*"></div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="b_save" class="btn btn--pri">Saqlash</button>
        <button id="b_load" class="btn">Yuklash</button>
      </div>
    </section>

    <!-- Catalog editor -->
    <section class="panel">
      <div class="topbar"><h3 style="margin:0">Katalog (Kurs/Sim/Test)</h3><span id="catStatus"></span></div>
      <div class="row3">
        <div><label>Turi</label><select id="c_type"><option value="course">course</option><option value="sim">sim</option><option value="test">test</option></select></div>
        <div><label>Hujjat ID (ixtiyoriy — yangilash/o‘chirish uchun)</label><input id="c_id" placeholder="auto yoki mavjud ID"></div>
        <div><label>Sarlavha</label><input id="c_title"></div>
        <div><label>Tavsif</label><textarea id="c_desc"></textarea></div>
        <div><label>Narx</label><input type="number" id="c_price" value="0"></div>
        <div><label>Link</label><input id="c_link" placeholder="https:// ... yoki /test/123"></div>
        <div><label>Tugma matni</label><input id="c_button" placeholder="Boshlash"></div>
        <div><label>Tag</label><input id="c_tag" placeholder="NEW/FREE/PRO"></div>
        <div><label>Bo‘lim</label><input id="c_cat"></div>
        <div><label>Bo‘lim 2</label><input id="c_cat2"></div>
        <div><label>Bo‘lim 3</label><input id="c_cat3"></div>
        <div><label>Rasm URL</label><input id="c_image" placeholder="https://..."></div>
        <div><label>Rasm yuklash</label><input type="file" id="c_file" accept="image/*"></div>
        <div><label>Start (test)</label><input id="c_start" type="datetime-local"></div>
        <div><label>End (test)</label><input id="c_end" type="datetime-local"></div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="c_create" class="btn btn--pri">Yaratish / Saqlash</button>
        <button id="c_delete" class="btn">O‘chirish</button>
        <button id="c_refresh" class="btn">Ro‘yxatni yangilash</button>
      </div>
      <div id="list" class="grid"></div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { 
      getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc,
      collection, addDoc, serverTimestamp, query, where, orderBy, getDocs, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const firebaseConfig = {"apiKey": "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM", "authDomain": "xplusy-760fa.firebaseapp.com", "projectId": "xplusy-760fa", "storageBucket": "xplusy-760fa.appspot.com", "messagingSenderId": "992512966017", "appId": "1:992512966017:web:5e919dbc9b8d8abcb43c80", "measurementId": "G-459PLJ7P7L"};
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const st   = getStorage(app);

    const ADMIN_EMAILS = ["sohibjonmath@gmail.com"];

    const $ = (s, r=document)=>r.querySelector(s);
    const el = html=>{ const t=document.createElement('template'); t.innerHTML=html.trim(); return t.content.firstChild; };

    // ---- Auth ----
    async function login(){ await signInWithPopup(auth, new GoogleAuthProvider()); }
    async function logout(){ await signOut(auth); }
    document.getElementById('btnLogin').onclick=login;
    document.getElementById('btnLogout').onclick=logout;

    function canUse(u){ return u && u.email && ADMIN_EMAILS.includes(u.email); }

    onAuthStateChanged(auth, async (u)=>{
      $('#btnLogin').style.display = u? 'none':'inline-block';
      $('#btnLogout').style.display= u? 'inline-block':'none';
      if(!u){ document.body.dataset.authed=''; return; }
      if(!canUse(u)){ alert('Bu sahifa faqat admin uchun.'); await logout(); return; }
      document.body.dataset.authed='1';
      await loadBanner();
      await refreshList();
    });

    // ---- Helpers ----
    async function uploadImage(file, pathPrefix){
      const ext = (file.name.split('.').pop()||'jpg').toLowerCase();
      const id = Date.now() + '-' + Math.random().toString(36).slice(2,8) + '.' + ext;
      const r = ref(st, `${pathPrefix}/${id}`);
      await uploadBytes(r, file, { contentType: file.type || 'image/jpeg' });
      return await getDownloadURL(r);
    }

    // ---- Home banner CRUD ----
    async function loadBanner(){
      const qy = query(collection(db,'catalog'), where('type','==','home'), orderBy('updatedAt','desc'));
      const snap = await getDocs(qy);
      let d=null; snap.forEach(doc=> d = { id: doc.id, ...doc.data() });
      if(!d){ $('#bannerStatus').textContent='Banner topilmadi (yangi yaratib saqlang)'; return; }
      $('#bannerStatus').textContent = 'Banner ID: ' + d.id;
      $('#b_title').value = d.title||''; $('#b_desc').value=d.desc||''; $('#b_link').value=d.link||''; $('#b_button').value=d.button||''; $('#b_tag').value=d.tag||d.promotag||''; $('#b_image').value=d.image||'';
    }

    $('#b_load').onclick = loadBanner;
    $('#b_save').onclick = async ()=>{
      if(!auth.currentUser || !canUse(auth.currentUser)) return alert('Kirish talab etiladi');
      const f = $('#b_file').files[0];
      let image = $('#b_image').value.trim();
      if(f) image = await uploadImage(f, 'banners');

      const data = { type: 'home', title: $('#b_title').value.trim(), desc: $('#b_desc').value.trim(), link: $('#b_link').value.trim(), button: $('#b_button').value.trim()||'Boshlash', tag: $('#b_tag').value.trim(), image, updatedAt: serverTimestamp() };
      await setDoc(doc(db,'catalog','home'), data, { merge:true });
      $('#bannerStatus').textContent='Saqlandi (ID: home)';
      alert('Banner saqlandi');
    };

    // ---- Catalog list ----
    function renderRow(id,d){
      return el(`<div class="card">
        <div style="font-weight:800">${d.title||'—'}</div>
        <div style="font-size:12px;opacity:.8">Turi: ${d.type} | Narx: ${d.price||0} | Tag: ${d.tag||''}</div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <button class="btn" data-edit="${id}">Tahrirlash</button>
          <button class="btn" data-del="${id}">O‘chirish</button>
        </div>
      </div>`);
    }

    async function refreshList(){
      const qy = query(collection(db,'catalog'), where('type','in',['course','sim','test']), orderBy('updatedAt','desc'));
      const snap = await getDocs(qy);
      const box = $('#list'); box.innerHTML='';
      snap.forEach(docSnap=> box.appendChild(renderRow(docSnap.id, docSnap.data())));
    }
    $('#c_refresh').onclick = refreshList;

    // Edit / Delete bind
    document.getElementById('list').addEventListener('click', async (e)=>{
      const b = e.target.closest('button'); if(!b) return;
      if(b.dataset.edit){
        const id=b.dataset.edit;
        const s = await getDoc(doc(db,'catalog',id));
        if(!s.exists()) return;
        const d=s.data();
        $('#c_id').value=id; $('#c_type').value=d.type||'course'; $('#c_title').value=d.title||''; $('#c_desc').value=d.desc||''; $('#c_price').value=d.price||0; $('#c_link').value=d.link||''; $('#c_button').value=d.button||''; $('#c_tag').value=d.tag||''; $('#c_cat').value=d.cat||''; $('#c_cat2').value=d.cat2||''; $('#c_cat3').value=d.cat3||''; $('#c_image').value=d.image||'';
        if(d.start?.seconds) $('#c_start').value = new Date(d.start.seconds*1000).toISOString().slice(0,16);
        if(d.end?.seconds)   $('#c_end').value   = new Date(d.end.seconds*1000).toISOString().slice(0,16);
      }
      if(b.dataset.del){
        const id=b.dataset.del;
        if(confirm('O‘chirishni tasdiqlaysizmi?')){ await deleteDoc(doc(db,'catalog',id)); await refreshList(); alert('O‘chirildi'); }
      }
    });

    // Create/Save
    $('#c_create').onclick = async ()=>{
      if(!auth.currentUser || !canUse(auth.currentUser)) return alert('Kirish talab etiladi');
      const imgFile = $('#c_file').files[0];
      let image = $('#c_image').value.trim();
      if(imgFile) image = await uploadImage(imgFile, 'catalog');

      const base = {
        type: $('#c_type').value,
        title: $('#c_title').value.trim(),
        desc:  $('#c_desc').value.trim(),
        price: +($('#c_price').value||0),
        link:  $('#c_link').value.trim(),
        button:$('#c_button').value.trim()||'Boshlash',
        tag:   $('#c_tag').value.trim(),
        cat:   $('#c_cat').value.trim(),
        cat2:  $('#c_cat2').value.trim(),
        cat3:  $('#c_cat3').value.trim(),
        image,
        updatedAt: serverTimestamp()
      };
      const start = $('#c_start').value ? Timestamp.fromMillis(new Date($('#c_start').value).getTime()) : null;
      const end   = $('#c_end').value   ? Timestamp.fromMillis(new Date($('#c_end').value).getTime())   : null;
      if(start) base.start=start; if(end) base.end=end;

      const id = $('#c_id').value.trim();
      if(id){ await setDoc(doc(db,'catalog',id), base, { merge:true }); }
      else  { await addDoc(collection(db,'catalog'), base); }
      await refreshList();
      alert('Saqlandi');
    };

    // Delete by ID
    $('#c_delete').onclick = async ()=>{
      const id = $('#c_id').value.trim(); if(!id) return alert('ID kiriting');
      await deleteDoc(doc(db,'catalog',id));
      await refreshList(); alert('O‘chirildi');
    };
  </script>
</body>
</html>
