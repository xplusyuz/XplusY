<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LeaderMath â€” Home Admin (Subsections + Carousel)</title>
  <style>
    :root{--brand:#2E8B57;--line:#dfe7e2;--muted:#4a6b5a}
    body{margin:0;font:15px/1.5 system-ui,Segoe UI,Arial;background:#f4f8f6;color:#0d1b14}
    header{position:sticky;top:0;background:#f4f8f6;border-bottom:1px solid var(--line);z-index:10}
    .row{max-width:1180px;margin:0 auto;padding:10px 16px;display:flex;gap:10px;align-items:center}
    .brand{font-weight:800;color:var(--brand)}
    main{max-width:1180px;margin:0 auto;padding:16px;display:grid;gap:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    button{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    button.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{border:1px solid var(--line);border-radius:12px;background:#fff}
    .card h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--line)}
    .card .body{padding:12px}
    input,select,textarea{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px}
    textarea{min-height:160px;font-family:ui-monospace,Consolas,monospace}
    table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid #eef2ee;text-align:left;vertical-align:top}
    .small{font-size:12px;color:var(--muted)}
    .rowflex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{padding:3px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px}
    .danger{color:#b00020}
    .subtbl td{background:#fbfdfb}
    .muted{color:var(--muted)}
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.appspot.com",
      messagingSenderId: "992512966017",
      appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId: "G-459PLJ7P7L"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const ADMIN_EMAILS = ["sohibjonmath@gmail.com"];

    function guard(u){
      const wrap = document.getElementById('guard');
      if(!u){ wrap.innerHTML = '<button id="glogin">Google bilan kiring</button>'; document.getElementById('glogin').onclick=()=>signInWithPopup(auth,new GoogleAuthProvider()); return false; }
      if(ADMIN_EMAILS.indexOf(u.email)<0){ wrap.innerHTML = '<div class="danger">Kirish taqiqlangan. Bu sahifa faqat admin uchun.</div>'; return false; }
      wrap.innerHTML = '<div>ðŸ‘‹ '+(u.email||u.uid)+'</div>'; return true;
    }

    // ====== State (sections -> subsections -> banners/cards) ======
    let state = {sections:[], selSec:-1, selSub:-1, selKind:'banner', selIdx:-1};

    // ---- Rendering: Sections list + editor panels ----
    const $ = (s,r=document)=>r.querySelector(s);

    function renderSectionsTable(){
      const tb = document.querySelector('#tbl-sections tbody'); tb.innerHTML='';
      state.sections.forEach((s,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${s.id||''}</td>
          <td>${s.title||''}</td>
          <td>${s.fullBleed?'<span class="pill">full</span>':''}</td>
          <td class="rowflex">
            <button data-i="${i}" class="selSec">Tanlash</button>
            <button data-i="${i}" class="upSec">â†‘</button>
            <button data-i="${i}" class="downSec">â†“</button>
            <button data-i="${i}" class="delSec">Oâ€˜chirish</button>
          </td>`;
        tb.appendChild(tr);
      });
    }

    function renderSubsectionsTable(){
      const tb = document.querySelector('#tbl-subs tbody'); tb.innerHTML='';
      const s = state.sections[state.selSec]; if(!s){ tb.innerHTML='<tr><td colspan="5" class="small">Avval boâ€˜lim tanlang.</td></tr>'; return; }
      (s.subsections||[]).forEach((sb,i)=>{
        const tr = document.createElement('tr');
        tr.className='subtbl';
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${sb.id||''}</td>
          <td>${sb.title||''}</td>
          <td>${sb.fullBleed?'<span class="pill">full</span>':''}</td>
          <td class="rowflex">
            <button data-i="${i}" class="selSub">Tanlash</button>
            <button data-i="${i}" class="upSub">â†‘</button>
            <button data-i="${i}" class="downSub">â†“</button>
            <button data-i="${i}" class="delSub">Oâ€˜chirish</button>
          </td>`;
        tb.appendChild(tr);
      });
    }

    function editSection(i){
      state.selSec = i; state.selSub = -1; state.selIdx=-1;
      const s = state.sections[i]||{subsections:[]};
      const ed = $('#sec-editor');
      ed.innerHTML = `
        <div class="rowflex">
          <div style="flex:1"><label>ID</label><input id="sid" value="${s.id||''}"></div>
          <div style="flex:1"><label>Sarlavha</label><input id="stitle" value="${s.title||''}"></div>
        </div>
        <div class="rowflex">
          <div style="flex:1"><label>fullBleed</label>
            <select id="sfull"><option value="false"${!s.fullBleed?' selected':''}>false</option>
            <option value="true"${s.fullBleed?' selected':''}>true</option></select></div>
          <div style="flex:1"><label>baseHref</label><input id="sbase" value="${s.baseHref||''}"></div>
        </div>
        <div class="rowflex" style="margin-top:8px">
          <button id="saveSec" class="primary">Boâ€˜limni saqlash</button>
          <button id="addSub">+ Sub-boâ€˜lim qoâ€˜shish</button>
        </div>`;
      $('#saveSec').onclick=()=>{
        const o={ id:$('#sid').value.trim(), title:$('#stitle').value.trim(), fullBleed:($('#sfull').value==='true') };
        const baseHref=$('#sbase').value.trim(); if(baseHref) o.baseHref=baseHref;
        o.subsections = s.subsections||[];
        state.sections[i]=o; renderSectionsTable(); alert('Boâ€˜lim saqlandi.');
      };
      $('#addSub').onclick=()=>{
        s.subsections = s.subsections||[];
        const n=s.subsections.length+1;
        s.subsections.push({id:'sub'+n,title:'Yangi sub '+n,fullBleed:false,banners:[],cards:[]});
        renderSubsectionsTable(); editSubsection(s.subsections.length-1);
      };
      renderSubsectionsTable();
      $('#item-editor').innerHTML='<div class="small">Sub-boâ€˜lim tanlang.</div>';
    }

    function editSubsection(j){
      state.selSub = j; state.selIdx=-1;
      const s = state.sections[state.selSec]; const sb = s.subsections[j];
      const ed = $('#sub-editor');
      ed.innerHTML = `
        <div class="rowflex">
          <div style="flex:1"><label>ID</label><input id="bid" value="${sb.id||''}"></div>
          <div style="flex:1"><label>Sarlavha</label><input id="btitle" value="${sb.title||''}"></div>
        </div>
        <div class="rowflex">
          <div style="flex:1"><label>fullBleed</label>
            <select id="bfull"><option value="false"${!sb.fullBleed?' selected':''}>false</option>
            <option value="true"${sb.fullBleed?' selected':''}>true</option></select></div>
          <div style="flex:1"><label>baseHref</label><input id="bbase" value="${sb.baseHref||''}"></div>
        </div>
        <div class="rowflex" style="margin-top:8px">
          <button id="saveSub" class="primary">Sub-boâ€˜limni saqlash</button>
          <span class="pill">Banners: ${sb.banners?.length||0}</span>
          <span class="pill">Cards: ${sb.cards?.length||0}</span>
        </div>
        <div class="rowflex" style="margin-top:8px">
          <button id="addBanner">+ Banner</button>
          <button id="addCard">+ Card</button>
        </div>
        <div class="rowflex" style="margin-top:8px">
          <button id="selBanner" class="${state.selKind==='banner'?'primary':''}">Bannerlar</button>
          <button id="selCard" class="${state.selKind==='card'?'primary':''}">Cardlar</button>
        </div>`;
      $('#saveSub').onclick=()=>{
        sb.id=$('#bid').value.trim();
        sb.title=$('#btitle').value.trim();
        sb.fullBleed=$('#bfull').value==='true';
        const baseHref=$('#bbase').value.trim(); sb.baseHref=baseHref;
        alert('Sub-boâ€˜lim saqlandi.');
      };
      $('#addBanner').onclick=()=>{ sb.banners.push({mode:'html',sandbox:'allow-scripts allow-forms',contentHtml:'<section style="display:grid;place-items:center;height:100vh"><h2>Yangi Banner</h2></section>'}); state.selKind='banner'; state.selIdx=sb.banners.length-1; renderItemsList(); editItem(); };
      $('#addCard').onclick=()=>{ sb.cards.push({title:'Yangi Card',cardStyle:'available',ctaLabel:'Boshlash',ctaHref:'',infoHtml:'<p>â€”</p>'}); state.selKind='card'; state.selIdx=sb.cards.length-1; renderItemsList(); editItem(); };
      $('#selBanner').onclick=()=>{ state.selKind='banner'; state.selIdx=-1; renderItemsList(); $('#item-editor').innerHTML='<div class="small">Banner tanlang.</div>'; };
      $('#selCard').onclick=()=>{ state.selKind='card'; state.selIdx=-1; renderItemsList(); $('#item-editor').innerHTML='<div class="small">Card tanlang.</div>'; };
      renderItemsList();
      $('#item-editor').innerHTML='<div class="small">Element tanlang.</div>';
    }

    function renderItemsList(){
      const list = $('#items-list'); list.innerHTML='';
      const s = state.sections[state.selSec]; if(!s) return;
      const sb = s.subsections[state.selSub]; if(!sb) return;
      const arr = state.selKind==='banner' ? (sb.banners||[]) : (sb.cards||[]);
      arr.forEach((it,i)=>{
        const li=document.createElement('div');
        const label = state.selKind==='banner'
          ? `Banner ${i+1} â€” ${it.mode||'html'}`
          : `Card ${i+1} â€” ${it.title||''}`;
        li.className='rowflex'; li.style.marginBottom='6px';
        li.innerHTML = `
          <span>${label}</span>
          <button data-i="${i}" class="selIt">Tahrirlash</button>
          <button data-i="${i}" class="upIt">â†‘</button>
          <button data-i="${i}" class="downIt">â†“</button>
          <button data-i="${i}" class="delIt">Oâ€˜chirish</button>`;
        list.appendChild(li);
      });
    }

    function editItem(){
      const s=state.sections[state.selSec]; const sb=s?.subsections?.[state.selSub];
      if(!sb) return;
      const arr = state.selKind==='banner'?sb.banners:sb.cards;
      const it = arr?.[state.selIdx]; if(!it){ $('#item-editor').innerHTML='<div class="small">Element tanlang.</div>'; return; }
      const ed = $('#item-editor');
      if(state.selKind==='banner'){
        ed.innerHTML = `
          <div class="rowflex">
            <div style="flex:1"><label>Mode</label>
              <select id="emode"><option value="html"${it.mode==='html'?' selected':''}>html</option>
              <option value="url"${it.mode==='url'?' selected':''}>url</option></select></div>
            <div style="flex:1"><label>Sandbox</label><input id="esbx" value="${it.sandbox||'allow-scripts allow-forms'}"></div>
          </div>
          <div class="rowflex">
            <div style="flex:1"><label>baseHref</label><input id="ebase" value="${it.baseHref||''}"></div>
          </div>
          <div id="htmlBlock" style="${it.mode==='html'?'':'display:none'}"><label>contentHtml</label><textarea id="ehtml">${it.contentHtml?String(it.contentHtml).replace(/</g,'&lt;'):''}</textarea></div>
          <div id="urlBlock" style="${it.mode==='url'?'':'display:none'}"><label>src</label><input id="esrc" value="${it.src||''}"></div>
          <div class="rowflex" style="margin-top:8px"><button id="saveItem" class="primary">Banner saqlash</button></div>`;
        $('#emode').onchange=function(){
          const v=this.value; $('#htmlBlock').style.display=(v==='html'?'block':'none'); $('#urlBlock').style.display=(v==='url'?'block':'none');
        };
        $('#saveItem').onclick=function(){
          it.mode=$('#emode').value;
          it.sandbox=$('#esbx').value.trim();
          const base=$('#ebase').value.trim(); it.baseHref=base;
          if(it.mode==='html'){ it.contentHtml = $('#ehtml').value; } else { it.src = $('#esrc').value.trim(); }
          alert('Banner saqlandi.');
        };
      }else{
        ed.innerHTML = `
          <div class="rowflex">
            <div style="flex:1"><label>Sarlavha</label><input id="ctitle" value="${it.title||''}"></div>
            <div style="flex:1"><label>Holat</label>
              <select id="cstyle">
                <option value="available"${it.cardStyle==='available'?' selected':''}>available</option>
                <option value="soon"${it.cardStyle==='soon'?' selected':''}>coming soon</option>
                <option value="timed"${it.cardStyle==='timed'?' selected':''}>timed (start/end)</option>
              </select>
            </div>
          </div>
          <div class="rowflex">
            <div style="flex:1"><label>Start (YYYY-MM-DD HH:mm)</label><input id="cstart" value="${it.startAt||''}"></div>
            <div style="flex:1"><label>End (YYYY-MM-DD HH:mm)</label><input id="cend" value="${it.endAt||''}"></div>
          </div>
          <div class="rowflex">
            <div style="flex:1"><label>CTA Label</label><input id="clab" value="${it.ctaLabel||'Boshlash'}"></div>
            <div style="flex:1"><label>CTA Link</label><input id="chref" value="${it.ctaHref||''}"></div>
          </div>
          <div><label>Info HTML</label><textarea id="cinfo">${it.infoHtml?String(it.infoHtml).replace(/</g,'&lt;'):''}</textarea></div>
          <div class="rowflex" style="margin-top:8px"><button id="saveItem" class="primary">Card saqlash</button></div>`;
        $('#saveItem').onclick=function(){
          it.title=$('#ctitle').value.trim();
          it.cardStyle=$('#cstyle').value;
          it.startAt=$('#cstart').value.trim();
          it.endAt=$('#cend').value.trim();
          it.ctaLabel=$('#clab').value.trim();
          it.ctaHref=$('#chref').value.trim();
          it.infoHtml=$('#cinfo').value;
          alert('Card saqlandi.');
        };
      }
    }

    // Delegation for tables/lists
    document.addEventListener('click', (e)=>{
      const s = state.sections;
      const t=e.target;
      // sections
      if(t.classList.contains('selSec')) editSection(parseInt(t.dataset.i,10));
      if(t.classList.contains('upSec')){ const i=+t.dataset.i; if(i>0){ const x=s[i-1]; s[i-1]=s[i]; s[i]=x; renderSectionsTable(); } }
      if(t.classList.contains('downSec')){ const i=+t.dataset.i; if(i<s.length-1){ const x=s[i+1]; s[i+1]=s[i]; s[i]=x; renderSectionsTable(); } }
      if(t.classList.contains('delSec')){ const i=+t.dataset.i; if(confirm('Oâ€˜chirishni tasdiqlaysizmi?')){ s.splice(i,1); renderSectionsTable(); $('#sec-editor').innerHTML='<div class="small">Chapdan boâ€˜lim tanlang.</div>'; $('#sub-editor').innerHTML=''; $('#items-list').innerHTML=''; $('#item-editor').innerHTML=''; } }

      // subsections
      const sec = s[state.selSec||0];
      if(t.classList.contains('selSub')) editSubsection(parseInt(t.dataset.i,10));
      if(t.classList.contains('upSub')){ const i=+t.dataset.i; if(i>0){ const arr=sec.subsections; const x=arr[i-1]; arr[i-1]=arr[i]; arr[i]=x; renderSubsectionsTable(); } }
      if(t.classList.contains('downSub')){ const i=+t.dataset.i; const arr=sec.subsections; if(i<arr.length-1){ const x=arr[i+1]; arr[i+1]=arr[i]; arr[i]=x; renderSubsectionsTable(); } }
      if(t.classList.contains('delSub')){ const i=+t.dataset.i; if(confirm('Sub-boâ€˜lim oâ€˜chirilsinmi?')){ sec.subsections.splice(i,1); renderSubsectionsTable(); $('#item-editor').innerHTML=''; $('#items-list').innerHTML=''; } }

      // items (banner/card)
      const sb = sec?.subsections?.[state.selSub];
      if(!sb) return;
      const arr = state.selKind==='banner'?sb.banners:sb.cards;
      if(t.classList.contains('selIt')){ state.selIdx=+t.dataset.i; editItem(); }
      if(t.classList.contains('upIt')){ const i=+t.dataset.i; if(i>0){ const x=arr[i-1]; arr[i-1]=arr[i]; arr[i]=x; renderItemsList(); } }
      if(t.classList.contains('downIt')){ const i=+t.dataset.i; if(i<arr.length-1){ const x=arr[i+1]; arr[i+1]=arr[i]; arr[i]=x; renderItemsList(); } }
      if(t.classList.contains('delIt')){ const i=+t.dataset.i; if(confirm('Oâ€˜chirilsinmi?')){ arr.splice(i,1); renderItemsList(); $('#item-editor').innerHTML='<div class="small">Element tanlang.</div>'; } }
    });

    // Toolbar actions
    document.addEventListener('DOMContentLoaded', async ()=>{
      onAuthStateChanged(auth, async (u)=>{
        if(!guard(u)) return;
        const snap = await getDoc(doc(db,'configs','home'));
        state = snap.exists()? (snap.data()||{sections:[]}) : {sections:[]};
        if(!Array.isArray(state.sections)) state.sections=[];
        renderSectionsTable();
        $('#sec-editor').innerHTML='<div class="small">Chapdan boâ€˜lim tanlang.</div>';
        $('#sub-editor').innerHTML=''; $('#items-list').innerHTML=''; $('#item-editor').innerHTML='';
      });

      $('#addSec').onclick = ()=>{
        const n=state.sections.length+1;
        state.sections.push({id:'sec'+n,title:'Yangi boâ€˜lim '+n,fullBleed:false,subsections:[]});
        renderSectionsTable(); editSection(state.sections.length-1);
      };
      $('#download').onclick = ()=>{
        const blob=new Blob([JSON.stringify({sections:state.sections},null,2)],{type:'application/json'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='home.json'; a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href),800);
      };
      $('#publish').onclick = async ()=>{
        try{ await setDoc(doc(db,'configs','home'), {sections:state.sections}); alert('Firestoreâ€™ga saqlandi âœ…'); }
        catch(e){ alert('Saqlash xatosi: '+e.message); }
      };
      $('#loadfile').onchange = async (e)=>{
        const f=e.target.files[0]; if(!f) return; const txt=await f.text();
        try{ const obj=JSON.parse(txt); if(Array.isArray(obj.sections)) { state.sections=obj.sections; renderSectionsTable(); } else { alert('JSON: sections topilmadi'); } }
        catch(err){ alert('JSON parse xato: '+err.message); }
      };
    });
  </script>
</head>
<body>
  <header><div class="row"><div class="brand">LeaderMath â€” Home Admin</div>
    <div class="rowflex" style="margin-left:auto" id="guard"><button id="glogin">Google bilan kiring</button></div>
  </div></header>

  <main>
    <div class="toolbar">
      <button id="addSec">+ Boâ€˜lim qoâ€˜shish</button>
      <label class="rowflex">JSON fayldan yuklash <input id="loadfile" type="file" accept="application/json"/></label>
      <button id="download">Yuklab olish (home.json)</button>
      <button id="publish" class="primary">Firestoreâ€™ga chiqarish</button>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Boâ€˜limlar</h3>
        <div class="body">
          <table id="tbl-sections"><thead><tr><th>#</th><th>ID</th><th>Sarlavha</th><th>Full</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div class="card">
        <h3>Boâ€˜lim tahriri</h3>
        <div class="body" id="sec-editor"><div class="small">Chapdan boâ€˜lim tanlang.</div></div>
      </div>

      <div class="card">
        <h3>Sub-boâ€˜limlar</h3>
        <div class="body">
          <table id="tbl-subs"><thead><tr><th>#</th><th>ID</th><th>Sarlavha</th><th>Full</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div class="card">
        <h3>Sub-boâ€˜lim tahriri</h3>
        <div class="body" id="sub-editor"></div>
      </div>

      <div class="card">
        <h3>Banner/Card roâ€˜yxati</h3>
        <div class="body" id="items-list"></div>
      </div>

      <div class="card">
        <h3>Element tahriri</h3>
        <div class="body" id="item-editor"></div>
      </div>
    </div>
  </main>
</body>
</html>
