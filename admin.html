<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MathCenter Admin — Offline (Login/Parol)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--brand:#16a34a}
    .brand-grad{background:linear-gradient(135deg,#eafff2,white)}
    .btn{@apply px-3 py-2 rounded-xl shadow hover:scale-[1.02] transition font-medium}
    .btn-primary{@apply bg-green-600 text-white}
    .btn-secondary{@apply bg-white border border-gray-200}
    .tag{@apply text-xs px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700}
    .card{@apply rounded-2xl shadow-sm border border-gray-100 bg-white}
    .input{@apply w-full rounded-lg border border-gray-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-400}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    dialog::backdrop{background:rgba(0,0,0,.35)}
    .sec-title{@apply text-lg font-semibold}
  </style>
</head>
<body class="min-h-screen brand-grad text-gray-900">
  <!-- Topbar -->
  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-gray-100">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-2">
        <div class="w-9 h-9 rounded-2xl bg-gradient-to-br from-emerald-500 to-emerald-600 grid place-items-center text-white text-xl font-black">π</div>
        <div>
          <div class="text-sm font-semibold">MathCenter Admin — Offline</div>
          <div class="text-xs text-gray-500">Login/Parol bilan kirish</div>
        </div>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <span id="authEmail" class="text-sm text-gray-600"></span>
        <button id="btnLogout" type="button" class="btn btn-secondary hidden">Chiqish</button>
      </div>
    </div>
  </header>

  <!-- Login panel -->
  <main class="max-w-7xl mx-auto px-4 py-6" id="loginPane">
    <div class="max-w-md mx-auto card p-6">
      <h1 class="text-xl font-bold">Kirish</h1>
      <p class="text-sm text-gray-600 mt-1">Admin panelga kirish uchun login va parol kiriting.</p>
      <div class="mt-4 space-y-3">
        <div>
          <label class="text-sm text-gray-600">Login</label>
          <input id="inpLogin" class="input" placeholder="Sohibjonmath" />
        </div>
        <div>
          <label class="text-sm text-gray-600">Parol</label>
          <input id="inpPass" type="password" class="input" placeholder="Math@1999" />
        </div>
        <button id="btnLogin" type="button" class="btn btn-primary w-full">Kirish</button>
      </div>
      <p class="text-xs text-gray-500 mt-3">Login: <b>Sohibjonmath</b> · Parol: <b>Math@1999</b></p>
    </div>
  </main>

  <!-- App UI -->
  <main class="max-w-7xl mx-auto px-4 py-6 hidden" id="adminUi">
      <!-- Tabs -->
      <div class="flex flex-wrap gap-2 mb-4">
        <button data-tab="tab-dashboard" class="tab btn btn-secondary">🏠 Banner</button>
        <button data-tab="tab-courses" class="tab btn btn-secondary">📚 Kurslar</button>
        <button data-tab="tab-tests" class="tab btn btn-secondary">📝 Testlar</button>
        <button data-tab="tab-simulators" class="tab btn btn-secondary">🧪 Simulyatorlar</button>
        <button data-tab="tab-promos" class="tab btn btn-secondary">🏷️ Promo kodlar</button>
        <button data-tab="tab-users" class="tab btn btn-secondary">👥 Foydalanuvchilar</button>
      </div>

      <!-- Banner -->
      <section id="tab-dashboard" class="tab-pane card p-5">
        <div class="flex items-center justify-between mb-4">
          <h3 class="sec-title">Katta reklama banneri</h3>
          <div class="flex gap-2">
            <button id="btnEditBanner" class="btn btn-primary">✏️ Banner tahrirlash</button>
          </div>
        </div>
        <div id="bannerView" class="grid lg:grid-cols-[2fr,1fr] gap-4">
          <div class="card p-4">
            <img id="bannerImage" class="w-full h-56 object-cover rounded-xl border border-gray-100" src="" alt="Banner"/>
          </div>
          <div class="card p-4 text-sm">
            <div class="text-gray-500">Sarlavha</div>
            <div id="bannerTitle" class="text-xl font-semibold">—</div>
            <div class="text-gray-500 mt-3">Matn</div>
            <div id="bannerSubtitle" class="text-gray-700">—</div>
            <div class="grid grid-cols-2 gap-3 mt-3">
              <div>
                <div class="text-gray-500">CTA</div>
                <div id="bannerCta" class="text-gray-700">—</div>
              </div>
              <div>
                <div class="text-gray-500">Havola</div>
                <a id="bannerLink" class="text-emerald-700 underline" href="#" target="_blank">—</a>
              </div>
            </div>
            <div class="text-gray-500 mt-3">Meta teglar</div>
            <div id="bannerTags" class="flex flex-wrap gap-2"></div>
          </div>
        </div>
        <div class="mt-5">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold">⬇️ Export: <code>partials/home.html</code></h4>
            <div class="flex gap-2">
              <button id="btnExportHomeCopy" class="btn btn-secondary">📋 Nusxa olish</button>
              <button id="btnExportHomeDown" class="btn btn-secondary">💾 Yuklab olish</button>
              <button id="btnExportHomePrev" class="btn btn-secondary">👁️ Ko‘rish</button>
            </div>
          </div>
          <textarea id="exportHome" class="input mono mt-3" rows="16" spellcheck="false"></textarea>
          <iframe id="previewHome" class="w-full h-72 rounded-xl border mt-3 bg-white"></iframe>
        </div>
      </section>

      <!-- Courses -->
      <section id="tab-courses" class="tab-pane card p-5 hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="sec-title">Kurslar</h3>
          <button class="btn btn-primary" id="addCourse">➕ Yangi kurs qo‘shish</button>
        </div>
        <div id="coursesGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        <div class="mt-6">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold">⬇️ Export: <code>partials/courses.html</code></h4>
            <div class="flex gap-2">
              <button id="btnExportCoursesCopy" class="btn btn-secondary">📋 Nusxa olish</button>
              <button id="btnExportCoursesDown" class="btn btn-secondary">💾 Yuklab olish</button>
              <button id="btnExportCoursesPrev" class="btn btn-secondary">👁️ Ko‘rish</button>
            </div>
          </div>
          <textarea id="exportCourses" class="input mono mt-3" rows="16" spellcheck="false"></textarea>
          <iframe id="previewCourses" class="w-full h-72 rounded-xl border mt-3 bg-white"></iframe>
        </div>
      </section>

      <!-- Tests -->
      <section id="tab-tests" class="tab-pane card p-5 hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="sec-title">Testlar</h3>
          <button class="btn btn-primary" id="addTest">➕ Yangi test qo‘shish</button>
        </div>
        <div id="testsGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        <div class="mt-6">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold">⬇️ Export: <code>partials/tests.html</code></h4>
            <div class="flex gap-2">
              <button id="btnExportTestsCopy" class="btn btn-secondary">📋 Nusxa olish</button>
              <button id="btnExportTestsDown" class="btn btn-secondary">💾 Yuklab olish</button>
              <button id="btnExportTestsPrev" class="btn btn-secondary">👁️ Ko‘rish</button>
            </div>
          </div>
          <textarea id="exportTests" class="input mono mt-3" rows="16" spellcheck="false"></textarea>
          <iframe id="previewTests" class="w-full h-72 rounded-xl border mt-3 bg-white"></iframe>
        </div>
      </section>

      <!-- Simulators -->
      <section id="tab-simulators" class="tab-pane card p-5 hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="sec-title">Simulyatorlar</h3>
          <button class="btn btn-primary" id="addSimulator">➕ Yangi simulyator qo‘shish</button>
        </div>
        <div id="simulatorsGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        <div class="mt-6">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold">⬇️ Export: <code>partials/simulators.html</code></h4>
            <div class="flex gap-2">
              <button id="btnExportSimsCopy" class="btn btn-secondary">📋 Nusxa olish</button>
              <button id="btnExportSimsDown" class="btn btn-secondary">💾 Yuklab olish</button>
              <button id="btnExportSimsPrev" class="btn btn-secondary">👁️ Ko‘rish</button>
            </div>
          </div>
          <textarea id="exportSims" class="input mono mt-3" rows="16" spellcheck="false"></textarea>
          <iframe id="previewSims" class="w-full h-72 rounded-xl border mt-3 bg-white"></iframe>
        </div>
      </section>

      <!-- Promos (local only) -->
      <section id="tab-promos" class="tab-pane card p-5 hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="sec-title">Promo kodlar</h3>
          <button class="btn btn-primary" id="addPromo">➕ Promo kod qo‘shish</button>
        </div>
        <div id="promosGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>

      <!-- Users (local only) -->
      <section id="tab-users" class="tab-pane card p-5 hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="sec-title">Foydalanuvchilar</h3>
          <div class="flex gap-2">
            <input id="userSearch" class="input w-60" placeholder="Qidirish (ism/email/id)" />
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-gray-500">
                <th class="py-2 pr-3">ID</th>
                <th class="py-2 pr-3">Ism</th>
                <th class="py-2 pr-3">Email</th>
                <th class="py-2 pr-3">Balans</th>
                <th class="py-2 pr-3">Ball (Gems)</th>
                <th class="py-2 pr-3">Rol</th>
                <th class="py-2 pr-3">Holat</th>
                <th class="py-2 pr-3">Amal</th>
              </tr>
            </thead>
            <tbody id="usersTbody"></tbody>
          </table>
        </div>
      </section>
  </main>

  <!-- CRUD Modal -->
  <dialog id="crudModal" class="rounded-2xl w-[95vw] max-w-2xl p-0">
    <form method="dialog" class="card p-0" onsubmit="return false;">
      <div class="flex items-center justify-between px-5 py-3 border-b">
        <h3 id="crudTitle" class="text-lg font-semibold">Tahrirlash</h3>
        <button id="crudClose" class="px-2 py-1 text-gray-500" type="button">✖</button>
      </div>
      <div class="p-5 space-y-3" id="crudBody"></div>
      <div class="flex items-center justify-end gap-2 px-5 py-3 border-t">
        <button class="btn btn-secondary" id="crudCancel" type="button">Bekor</button>
        <button id="crudSave" class="btn btn-primary" type="button">Saqlash</button>
      </div>
    </form>
  </dialog>

  <template id="gridCardTpl">
    <div class="card overflow-hidden">
      <img class="w-full h-36 object-cover"/>
      <div class="p-3">
        <div class="font-semibold title line-clamp-1">—</div>
        <div class="text-xs text-gray-500 subtitle line-clamp-2">—</div>
        <div class="mt-2 flex items-center gap-2">
          <span class="tag rating">⭐ 5.0</span>
          <a class="text-emerald-700 underline link" target="_blank">Havola</a>
        </div>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-secondary btn-edit" type="button">✏️</button>
          <button class="btn btn-secondary btn-delete" type="button">🗑️</button>
        </div>
      </div>
    </div>
  </template>

  <script>
    // ===== Simple login (no Firebase) =====
    const VALID_LOGIN = 'Sohibjonmath';
    const VALID_PASS = 'Math@1999';
    const LS_AUTH = 'mc_auth';

    const loginPane = document.getElementById('loginPane');
    const adminUi = document.getElementById('adminUi');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const authEmailEl = document.getElementById('authEmail');

    function setAuthed(ok){ localStorage.setItem(LS_AUTH, ok? '1':'0'); }
    function isAuthed(){ return localStorage.getItem(LS_AUTH) === '1'; }
    function applyAuthUi(){
      const ok = isAuthed();
      loginPane.classList.toggle('hidden', ok);
      adminUi.classList.toggle('hidden', !ok);
      btnLogout.classList.toggle('hidden', !ok);
      authEmailEl.textContent = ok ? 'Admin' : '';
      if (ok) initAfterAuth();
    }

    btnLogin.addEventListener('click', ()=>{
      const u = document.getElementById('inpLogin').value.trim();
      const p = document.getElementById('inpPass').value;
      if (u === VALID_LOGIN && p === VALID_PASS){ setAuthed(true); applyAuthUi(); }
      else alert('Login yoki parol noto‘g‘ri.');
    });
    btnLogout.addEventListener('click', ()=>{ setAuthed(false); applyAuthUi(); });

    // ===== Local storage data layer =====
    const LS = {
      banner: 'mc_banner',
      courses: 'mc_courses',
      tests: 'mc_tests',
      simulators: 'mc_simulators',
      promos: 'mc_promos',
      users: 'mc_users'
    };
    function getData(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def; }catch{ return def; } }
    function setData(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

    // ===== Tabs =====
    document.querySelectorAll('.tab').forEach(b=> b.addEventListener('click', ()=> selectTab(b.dataset.tab)));
    function selectTab(id){
      document.querySelectorAll('.tab-pane').forEach(p=>p.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('!bg-emerald-600','!text-white'));
      document.querySelector(`[data-tab="${id}"]`).classList.add('!bg-emerald-600','!text-white');
    }

    // ===== CRUD Modal helper =====
    const crudModal = document.getElementById('crudModal');
    const crudTitle = document.getElementById('crudTitle');
    const crudBody = document.getElementById('crudBody');
    const crudSave = document.getElementById('crudSave');
    const crudCancel = document.getElementById('crudCancel');
    const crudClose = document.getElementById('crudClose');
    crudCancel.onclick = crudClose.onclick = ()=> crudModal.close();

    function openCrud({ title, fields, onSave }){
      crudTitle.textContent = title; crudBody.innerHTML = '';
      fields.forEach(f=>{
        const wrap = document.createElement('div');
        wrap.innerHTML = `<label class="text-sm text-gray-600">${f.label}${f.required? ' *':''}</label>${ inputHtml(f) }`;
        if (f.type==='checkbox') wrap.querySelector('input').checked = !!f.value; else { const inp = wrap.querySelector('input,textarea'); if (inp) inp.value = f.value ?? ''; }
        crudBody.appendChild(wrap);
      });
      crudModal.showModal();
      crudSave.onclick = async ()=>{
        const vals = {}; const inputs = crudBody.querySelectorAll('input,textarea');
        for (const el of inputs){ const key = el.name; let v = (el.type==='checkbox') ? el.checked : el.value; if (el.type==='number') v = Number(v); if (el.required && !v){ alert('Majburiy maydon: '+ key); return; } vals[key] = v; }
        try{ await onSave(vals); crudModal.close(); }catch(err){ alert('Saqlashda xatolik: '+ err.message); }
      };
    }
    function inputHtml(f){ const base = `name="${f.key}" class="input" ${f.required? 'required':''}`; if (f.type==='textarea') return `<textarea ${base} rows="3"></textarea>`; if(f.type==='checkbox') return `<input type="checkbox" ${base}>`; const extra = f.step? ` step="${f.step}"` : ''; return `<input type="${f.type||'text'}" ${base}${extra}>`; }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    // ===== Banner =====
    const btnEditBanner = document.getElementById('btnEditBanner');
    const exportHomeEl = document.getElementById('exportHome');
    const previewHome = document.getElementById('previewHome');
    btnEditBanner.addEventListener('click', openBannerEditor);

    function loadBanner(){
      const b = getData(LS.banner, {});
      document.getElementById('bannerImage').src = b.imageUrl || 'https://images.unsplash.com/photo-1549221986-3d8b6e8d3c61';
      document.getElementById('bannerTitle').textContent = b.title || 'MathCenter — yangi mavsum!';
      document.getElementById('bannerSubtitle').textContent = b.subtitle || 'Eng yaxshi kurslar, testlar va simulyatorlar bitta joyda';
      document.getElementById('bannerCta').textContent = b.cta || 'Boshlash';
      const link = document.getElementById('bannerLink'); link.textContent = b.link || '—'; link.href = b.link || '#';
      const tagsWrap = document.getElementById('bannerTags');
      const tags = Array.isArray(b.tags)? b.tags : (b.tags? String(b.tags).split(',').map(s=>s.trim()) : []);
      tagsWrap.innerHTML = tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('');
    }

    function openBannerEditor(){
      const b = getData(LS.banner, {});
      openCrud({
        title:'Banner tahrirlash',
        fields:[
          {key:'imageUrl', label:'Rasm URL', type:'url', required:true, value: b.imageUrl||''},
          {key:'title', label:'Sarlavha', type:'text', required:true, value: b.title||''},
          {key:'subtitle', label:'Matn', type:'textarea', value: b.subtitle||''},
          {key:'link', label:'Havola', type:'url', value: b.link||''},
          {key:'cta', label:'CTA tugma matni', type:'text', value: b.cta||'Boshlash'},
          {key:'tags', label:'Meta teglar (vergul bilan)', type:'text', value: (Array.isArray(b.tags)? b.tags.join(', ') : b.tags)||'Algebra, Geometriya, Olimpiada'}
        ],
        onSave: async (vals)=>{
          if (typeof vals.tags === 'string') vals.tags = vals.tags.split(',').map(s=>s.trim()).filter(Boolean);
          setData(LS.banner, vals);
          loadBanner();
          updateHomeExporter();
        }
      });
    }

    // ===== Collections (local) =====
    const collections = {
      courses: { gridId:'coursesGrid', addBtnId:'addCourse', title:'Kurs', ls:LS.courses, icon:'⭐', label:'Reyting', btn:'Ko‘rish' },
      tests: { gridId:'testsGrid', addBtnId:'addTest', title:'Test', ls:LS.tests, icon:'🎯', label:'Murakkablik', btn:'Boshlash' },
      simulators: { gridId:'simulatorsGrid', addBtnId:'addSimulator', title:'Simulyator', ls:LS.simulators, icon:'🧩', label:'Foydalilik', btn:'Ochish' },
      promos: { gridId:'promosGrid', addBtnId:'addPromo', title:'Promo kod', ls:LS.promos }
    };

    function loadGrid(name){
      const cfg = collections[name]; const wrap = document.getElementById(cfg.gridId);
      const arr = getData(cfg.ls, []);
      wrap.innerHTML = '';
      arr.forEach((item, idx)=> wrap.appendChild(makeCard(name, item, idx)));
    }

    function makeCard(name, data, idx){
      const cfg = collections[name];
      const tpl = document.getElementById('gridCardTpl');
      const el = tpl.content.cloneNode(true);
      const img = el.querySelector('img');
      const title = el.querySelector('.title');
      const sub = el.querySelector('.subtitle');
      const link = el.querySelector('.link');
      const rating = el.querySelector('.rating');
      img.src = data.imageUrl || 'https://images.unsplash.com/photo-1529101091764-c3526daf38fe';
      title.textContent = data.title || (data.code ? ('Kod: '+data.code) : '—');
      sub.textContent = data.subtitle || (name==='promos' ? `Chegirma: ${data.discountPercent||0}% | Max: ${data.maxUses||0} | Ishlatilgan: ${data.usedCount||0}` : '—');
      if (name==='promos') rating.textContent = (data.active? '✅ Faol' : '⛔ Nofaol'); else rating.textContent = `${cfg.icon} ${cfg.label}: ${Number(data.rating||0).toFixed(1)}`;
      link.textContent = data.link ? cfg.btn : '—'; link.href = data.link || '#';
      el.querySelector('.btn-edit').addEventListener('click', ()=> editItem(name, idx, data));
      el.querySelector('.btn-delete').addEventListener('click', ()=> deleteItem(name, idx));
      return el;
    }

    function editItem(name, idx, data){
      const cfg = collections[name];
      let fields;
      if (name==='promos'){
        fields = [
          {key:'code', label:'Kod (masalan: MC25)', type:'text', required:true, value:data.code||''},
          {key:'discountPercent', label:'Chegirma %', type:'number', value:data.discountPercent||25},
          {key:'maxUses', label:'Maks. foydalanish', type:'number', value:data.maxUses||100},
          {key:'usedCount', label:'Ishlatilgan', type:'number', value:data.usedCount||0},
          {key:'active', label:'Faol', type:'checkbox', value: !!data.active},
          {key:'expiresAt', label:'Tugash sanasi (YYYY-MM-DD)', type:'date', value:data.expiresAt||''}
        ];
      } else {
        fields = [
          {key:'imageUrl', label:'Rasm URL', type:'url', required:true, value:data.imageUrl||''},
          {key:'title', label:'Sarlavha', type:'text', required:true, value:data.title||''},
          {key:'subtitle', label:'Qisqa matn', type:'textarea', value:data.subtitle||''},
          {key:'link', label:'Havola', type:'url', value:data.link||''},
          {key:'rating', label:`${cfg.label} (0-5)`, type:'number', step:'0.1', value:data.rating??5}
        ];
      }
      openCrud({ title: cfg.title + ' tahrirlash', fields, onSave: async(vals)=>{
        const arr = getData(cfg.ls, []); arr[idx] = {...arr[idx], ...vals}; setData(cfg.ls, arr); loadGrid(name); updateExportersFor(name);
      }});
    }

    function deleteItem(name, idx){
      if (!confirm('O‘chirishni tasdiqlaysizmi?')) return;
      const cfg = collections[name]; const arr = getData(cfg.ls, []); arr.splice(idx,1); setData(cfg.ls, arr); loadGrid(name); updateExportersFor(name);
    }

    // Add buttons
    document.getElementById('addCourse').addEventListener('click', ()=> addItem('courses'));
    document.getElementById('addTest').addEventListener('click', ()=> addItem('tests'));
    document.getElementById('addSimulator').addEventListener('click', ()=> addItem('simulators'));
    document.getElementById('addPromo').addEventListener('click', ()=> addItem('promos'));

    function addItem(name){
      const cfg = collections[name];
      let fields;
      if (name==='promos'){
        fields = [
          {key:'code', label:'Kod (masalan: MC25)', type:'text', required:true},
          {key:'discountPercent', label:'Chegirma %', type:'number', value:25},
          {key:'maxUses', label:'Maks. foydalanish', type:'number', value:100},
          {key:'usedCount', label:'Ishlatilgan', type:'number', value:0},
          {key:'active', label:'Faol', type:'checkbox', value:true},
          {key:'expiresAt', label:'Tugash sanasi (YYYY-MM-DD)', type:'date'}
        ];
      } else {
        fields = [
          {key:'imageUrl', label:'Rasm URL', type:'url', required:true},
          {key:'title', label:'Sarlavha', type:'text', required:true},
          {key:'subtitle', label:'Qisqa matn', type:'textarea'},
          {key:'link', label:'Havola', type:'url'},
          {key:'rating', label:`${cfg.label} (0-5)`, type:'number', step:'0.1', value:5}
        ];
      }
      openCrud({ title: cfg.title + ' qo‘shish', fields, onSave: async(vals)=>{
        const arr = getData(cfg.ls, []); arr.unshift(vals); setData(cfg.ls, arr); loadGrid(name); updateExportersFor(name);
      }});
    }

    // ===== Users (local) =====
    const usersTbody = document.getElementById('usersTbody');
    const userSearch = document.getElementById('userSearch');
    userSearch.addEventListener('input', ()=> renderUsers(userSearch.value.trim()));
    function renderUsers(q=''){
      const arr = getData(LS.users, []);
      usersTbody.innerHTML = '';
      arr.forEach((u, idx)=>{
        const needle = q.toLowerCase(); const hay = `${u.numericId||''} ${u.name||''} ${u.email||''}`.toLowerCase();
        if (needle && !hay.includes(needle)) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 pr-3">${u.numericId||'—'}</td>
          <td class="py-2 pr-3">${escapeHtml(u.name||'—')}</td>
          <td class="py-2 pr-3">${escapeHtml(u.email||'—')}</td>
          <td class="py-2 pr-3">${Number(u.balance||0).toFixed(2)}</td>
          <td class="py-2 pr-3">${Number(u.gems||0)}</td>
          <td class="py-2 pr-3">${escapeHtml(u.role||'user')}</td>
          <td class="py-2 pr-3">${escapeHtml(u.status||'active')}</td>
          <td class="py-2 pr-3"><button class="btn btn-secondary" type="button">✏️</button></td>`;
        tr.querySelector('button').addEventListener('click', ()=>{
          openCrud({ title:'Foydalanuvchi tahrirlash', fields:[
            {key:'name', label:'Ism', type:'text', value:u.name||''},
            {key:'balance', label:'Balans', type:'number', value:u.balance||0},
            {key:'gems', label:'Ball (Gems)', type:'number', value:u.gems||0},
            {key:'role', label:'Rol (user/admin)', type:'text', value:u.role||'user'},
            {key:'status', label:'Holat (active/banned)', type:'text', value:u.status||'active'}
          ], onSave: async(vals)=>{ const arr2=getData(LS.users,[]); arr2[idx]={...arr2[idx],...vals}; setData(LS.users,arr2); renderUsers(userSearch.value.trim()); }});
        });
        usersTbody.appendChild(tr);
      });
      if (!usersTbody.children.length){ usersTbody.innerHTML = '<tr><td class="py-3 text-sm text-gray-500" colspan="8">Hech narsa topilmadi</td></tr>'; }
    }

    // ===== Exporters (static, no Firebase) =====
    const exportAreas = {
      home: { ta: document.getElementById('exportHome'), iframe: document.getElementById('previewHome') },
      courses: { ta: document.getElementById('exportCourses'), iframe: document.getElementById('previewCourses') },
      tests: { ta: document.getElementById('exportTests'), iframe: document.getElementById('previewTests') },
      simulators: { ta: document.getElementById('exportSims'), iframe: document.getElementById('previewSims') }
    };

    document.getElementById('btnExportHomeCopy').onclick = ()=> copyText(exportAreas.home.ta.value);
    document.getElementById('btnExportHomeDown').onclick = ()=> downloadText('home.html', exportAreas.home.ta.value);
    document.getElementById('btnExportHomePrev').onclick = ()=> previewCode(exportAreas.home.iframe, exportAreas.home.ta.value);

    document.getElementById('btnExportCoursesCopy').onclick = ()=> copyText(exportAreas.courses.ta.value);
    document.getElementById('btnExportCoursesDown').onclick = ()=> downloadText('courses.html', exportAreas.courses.ta.value);
    document.getElementById('btnExportCoursesPrev').onclick = ()=> previewCode(exportAreas.courses.iframe, exportAreas.courses.ta.value);

    document.getElementById('btnExportTestsCopy').onclick = ()=> copyText(exportAreas.tests.ta.value);
    document.getElementById('btnExportTestsDown').onclick = ()=> downloadText('tests.html', exportAreas.tests.ta.value);
    document.getElementById('btnExportTestsPrev').onclick = ()=> previewCode(exportAreas.tests.iframe, exportAreas.tests.ta.value);

    document.getElementById('btnExportSimsCopy').onclick = ()=> copyText(exportAreas.simulators.ta.value);
    document.getElementById('btnExportSimsDown').onclick = ()=> downloadText('simulators.html', exportAreas.simulators.ta.value);
    document.getElementById('btnExportSimsPrev').onclick = ()=> previewCode(exportAreas.simulators.iframe, exportAreas.simulators.ta.value);

    function buildHomePartialFrom(b){
      const title = escapeHtml(b.title || 'Matematika bilan kuchli bo‘ling!');
      const subtitle = escapeHtml(b.subtitle || 'Kurslar, testlar va simulyatorlar — bitta joyda. Premium dizayn, mobilga mos.');
      const img = escapeHtml(b.imageUrl || 'https://images.unsplash.com/photo-1549221986-3d8b6e8d3c61');
      const link = escapeHtml(b.link || '#');
      const cta = escapeHtml(b.cta || 'Boshlash');
      const tags = Array.isArray(b.tags)? b.tags.join(',') : (b.tags||'Algebra,Geometriya,Olimpiada');
      return `<!-- /partials/home.html — static generated -->
<section id="hero" class="mc-hero" 
  data-title="${title}"
  data-subtitle="${subtitle}"
  data-img="${img}"
  data-link="${link}"
  data-cta="${cta}"
  data-tags="${escapeHtml(tags)}">
  <style>
    .mc-hero{position:relative;isolation:isolate;min-height:64vh;display:grid;place-items:center;padding:32px 16px}
    .mc-hero::before{content:\"\";position:absolute;inset:0;background:linear-gradient(160deg,#ecfdf5 0%,#ffffff 40%)}
    .mc-hero .bg{position:absolute;inset:0;z-index:-2;background-position:center;background-size:cover;filter:saturate(1.05)}
    .mc-hero .veil{position:absolute;inset:0;z-index:-1;background:radial-gradient(60% 60% at 20% 20%,rgba(16,185,129,.45),transparent 60%),radial-gradient(60% 60% at 80% 80%,rgba(16,185,129,.25),transparent 60%),linear-gradient(180deg,rgba(0,0,0,.25),transparent 35%)}
    .mc-wrap{max-width:1120px;width:100%;display:grid;grid-template-columns:1.15fr .85fr;gap:24px}
    .mc-card{backdrop-filter:blur(6px);background:rgba(255,255,255,.8);border:1px solid rgba(226,232,240,.8);border-radius:20px;box-shadow:0 10px 30px rgba(16,185,129,.12);padding:22px}
    .mc-eyebrow{color:#047857;font-weight:700;font-size:12px;letter-spacing:.02em}
    .mc-title{font-weight:900;font-size:32px;line-height:1.1;margin:8px 0 0 0;color:#0f172a}
    .mc-sub{color:#334155;margin:10px 0 0 0;font-size:15px}
    .mc-tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:14px}
    .mc-tag{font-size:12px;background:#dcfce7;color:#065f46;border:1px solid #bbf7d0;padding:6px 10px;border-radius:999px}
    .mc-cta{display:inline-flex;align-items:center;gap:10px;margin-top:16px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border-radius:14px;border:1px solid #10b981;background:#10b981;color:#fff;text-decoration:none;font-weight:700;box-shadow:0 10px 24px rgba(16,185,129,.25)}
    .btn:hover{transform:translateY(-1px)}
    .btn.secondary{background:#fff;color:#065f46;border-color:#a7f3d0}
    .mc-side{border-radius:22px;overflow:hidden;border:1px solid #e2e8f0;box-shadow:0 10px 24px rgba(2,6,23,.12)}
    .mc-img{width:100%;height:360px;object-fit:cover;display:block}
    @media (max-width:980px){.mc-wrap{grid-template-columns:1fr}.mc-img{height:280px}.mc-title{font-size:26px}}
  </style>
  <div class="bg"></div>
  <div class="veil"></div>
  <div class="mc-wrap">
    <div class="mc-card">
      <div class="mc-eyebrow">MathCenter</div>
      <h1 class="mc-title" id="heroTitle">—</h1>
      <p class="mc-sub" id="heroSub">—</p>
      <div class="mc-tags" id="heroTags"></div>
      <div class="mc-cta">
        <a id="heroBtn" class="btn" href="#" target="_blank">${cta}</a>
        <a id="heroLink" class="btn secondary" href="#" target="_blank">Batafsil</a>
      </div>
    </div>
    <div class="mc-side">
      <img id="heroImg" class="mc-img" alt="banner" src="" />
    </div>
  </div>
  <script>
    (function(){
      var root=document.currentScript.closest('#hero');
      var bg=root.querySelector('.bg');
      var elTitle=root.querySelector('#heroTitle');
      var elSub=root.querySelector('#heroSub');
      var elTags=root.querySelector('#heroTags');
      var elBtn=root.querySelector('#heroBtn');
      var elLink=root.querySelector('#heroLink');
      var elImg=root.querySelector('#heroImg');
      function apply(d){
        var tags=(d.tags||'').split(',').map(function(s){return s.trim()}).filter(Boolean);
        elTitle.textContent=d.title; elSub.textContent=d.subtitle; elBtn.textContent='${cta}'; elBtn.href=d.link; elLink.href=d.link; elImg.src=d.img; bg.style.backgroundImage=\"url('\"+d.img.replace(/'/g,'%27')+\"')\"; elTags.innerHTML=tags.map(function(t){return '<span class=\"mc-tag\">'+t+'</span>'}).join('');
      }
      apply({ title: root.dataset.title, subtitle: root.dataset.subtitle, img: root.dataset.img, link: root.dataset.link, cta: root.dataset.cta, tags: root.dataset.tags });
    })();
  <\/script>
</section>`;
    }

    function buildListStatic(collName, heading, icon, labelWord, btnWord){
      const items = getData(LS[collName], []);
      const cards = items.map(x=>{
        const img = x.imageUrl||'https://images.unsplash.com/photo-1523580846011-d3a5bc25702b';
        const rate = typeof x.rating==='number'? x.rating.toFixed(1): '5.0';
        const link = x.link||'#';
        const sub = x.subtitle||'Qisqa tavsif';
        return `
    <article class="rounded-2xl border border-gray-100 bg-white shadow overflow-hidden">
      <img src="${img}" class="w-full h-40 object-cover" alt="card"/>
      <div class="p-4">
        <div class="font-semibold line-clamp-1">${escapeHtml(x.title||'—')}</div>
        <p class="text-sm text-gray-600 line-clamp-2 mt-1">${escapeHtml(sub)}</p>
        <div class="mt-3 flex items-center justify-between">
          <span class="text-xs px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700">${icon} ${labelWord}: ${rate}</span>
          <a href="${link}" target="_blank" class="text-emerald-700 underline">${btnWord}</a>
        </div>
      </div>
    </article>`;
      }).join('');

      return `<!-- /partials/${collName}.html — static generated -->
<section class="max-w-7xl mx-auto px-4 py-8">
  <div class="flex items-center justify-between">
    <h2 class="text-2xl font-bold">${heading}</h2>
  </div>
  <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-5">
${cards}
  </div>
</section>`;
    }

    function updateHomeExporter(){
      const b = getData(LS.banner, {});
      const code = buildHomePartialFrom(b);
      exportAreas.home.ta.value = code; previewCode(exportAreas.home.iframe, code);
    }
    function updateCoursesExporter(){ const code = buildListStatic('courses','Kurslar','⭐','Reyting','Ko‘rish'); exportAreas.courses.ta.value = code; previewCode(exportAreas.courses.iframe, code); }
    function updateTestsExporter(){ const code = buildListStatic('tests','Testlar','🎯','Murakkablik','Boshlash'); exportAreas.tests.ta.value = code; previewCode(exportAreas.tests.iframe, code); }
    function updateSimsExporter(){ const code = buildListStatic('simulators','Simulyatorlar','🧩','Foydalilik','Ochish'); exportAreas.simulators.ta.value = code; previewCode(exportAreas.simulators.iframe, code); }

    function updateExportersFor(name){
      if (name==='courses') updateCoursesExporter();
      if (name==='tests') updateTestsExporter();
      if (name==='simulators') updateSimsExporter();
    }

    function updateAllExporters(){ updateHomeExporter(); updateCoursesExporter(); updateTestsExporter(); updateSimsExporter(); }

    // Utils
    function downloadText(filename, text){ const blob = new Blob([text], {type:'text/html;charset=utf-8'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000); }
    async function copyText(text){ try{ await navigator.clipboard.writeText(text); alert('Kod nusxalandi.'); }catch(e){ alert('Nusxalashda xatolik: '+e.message); } }
    function previewCode(iframe, code){ iframe.srcdoc = code; }

    // ===== Init after auth =====
    function initAfterAuth(){
      selectTab('tab-dashboard');
      loadBanner();
      Object.keys(collections).forEach(name=> loadGrid(name));
      renderUsers('');
      updateAllExporters();
    }

    // Bootstrap
    applyAuthUi();
  </script>
</body>
</html>
