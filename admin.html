<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MathCenter.uz — Super Admin</title>
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <style>
    :root{ --green:#0faf64; --edge:#e0f3eb; --bg:#f6fffb; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg)}
    header{position:sticky;top:0;z-index:10;padding:10px 16px;background:#ffffffd9;border-bottom:1px solid #eaf7f1;backdrop-filter:saturate(150%) blur(6px);}
    .header-inner{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:12px;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:40px;border-radius:12px;background:radial-gradient(60% 60% at 50% 35%, #b9ffd9, #2de38d 55%, #0ea55a 100%);display:grid;place-items:center;box-shadow:0 0 28px rgba(14,175,100,.35), inset 0 0 16px rgba(255,255,255,.7)}
    .logo svg{width:22px;height:22px;fill:#fff}
    .brand-title h1{margin:0;font-size:18px;background:linear-gradient(180deg,#0dbb6f,#0a8f52);-webkit-background-clip:text;color:transparent;font-weight:900;letter-spacing:.2px}
    .me{font-size:12px;opacity:.8}

    main{max-width:1100px;margin:16px auto 80px;padding:0 16px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .tab{padding:10px 14px;border-radius:12px;border:1px solid var(--edge);background:#fff;font-weight:800;cursor:pointer}
    .tab.active{background:var(--green);color:#fff;border-color:var(--green)}
    .section{background:#fff;border:1px solid var(--edge);border-radius:16px;padding:12px;box-shadow:0 4px 12px rgba(0,0,0,.06);margin-bottom:12px}

    .grid2{display:grid;grid-template-columns:1fr 1.2fr;gap:12px}
    @media(max-width:820px){ .grid2{grid-template-columns:1fr} }

    .form-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media(max-width:600px){ .form-grid{grid-template-columns:1fr} }
    .row{display:grid;gap:6px}
    label{font-size:12px;opacity:.7}
    input,select{padding:10px 12px;border:1px solid var(--edge);border-radius:12px;outline:none}
    input:focus,select:focus{box-shadow:0 0 0 3px rgba(15,175,100,.18)}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--edge);background:#fff;cursor:pointer;font-weight:800}
    .btn--pri{background:var(--green);color:#fff;border-color:var(--green)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}

    .filters{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:8px}
    @media(max-width:1000px){.filters{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media(max-width:640px){.filters{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:420px){.filters{grid-template-columns:1fr}}
    .grid-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
    .gcard{background:#fff;border:1px solid var(--edge);border-radius:14px;overflow:hidden;box-shadow:0 10px 22px rgba(0,0,0,.06)}
    .gcard .cover{aspect-ratio:16/9;background:#f3f7f5;object-fit:cover;width:100%}
    .gcard .body{padding:10px 12px}
    .gcard h3{margin:0 0 6px;font-size:15px}
    .meta{font-size:12px;opacity:.8}
    .row-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px}
    .badge{font-size:11px;border:1px solid var(--edge);border-radius:999px;padding:2px 8px}

    .pager{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
    .muted{opacity:.7;font-size:12px}

    .warning{background:#fff8e5;border:1px solid #ffe5a6;padding:10px;border-radius:12px}
    .danger{background:#ffe5e7;border:1px solid #ffc1c7;padding:10px;border-radius:12px}
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="brand">
        <div class="logo"><svg viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg"><path d="M76 92h104c9 0 16-7 16-16s-7-16-16-16H60c-9 0-16 7-16 16s7 16 16 16h4c8 41 4 77-8 97-5 8 5 17 13 12 24-14 35-53 29-109zm57 0c7 39 3 74-8 94-5 9 6 18 14 12 24-16 35-56 28-106h-34z"/></svg></div>
        <div class="brand-title"><h1>Super Admin</h1></div>
      </div>
      <div class="me"><span id="meName">—</span> · ID: <b id="meId">—</b></div>
    </div>
  </header>

  <main>
    <!-- Admin guard -->
    <div id="guard" class="section danger" style="display:none">
      <b>Ruxsat yo‘q.</b> Bu sahifa faqat numericId = <b>38864</b> bo‘lgan administrator uchun.
    </div>

    <div id="app" style="display:none">
      <div class="tabs">
        <button class="tab active" data-tab="banners">Bannerlar</button>
        <button class="tab" data-tab="courses">Kurslar</button>
        <button class="tab" data-tab="simulators">Simulyatorlar</button>
        <button class="tab" data-tab="tests">Testlar</button>
      </div>

      <!-- ===== BANNERS ===== -->
      <section id="tab_banners" class="section">
        <div class="grid2">
          <div>
            <h3 style="margin-top:0">Banner qo‘shish</h3>
            <div class="form-grid">
              <div class="row"><label>Sarlavha</label><input id="bn_title" placeholder="Banner nomi"></div>
              <div class="row"><label>Rasm URL (16:9)</label><input id="bn_cover" placeholder="https://..."></div>
              <div class="row"><label>Filter 1</label><input id="bn_f1" placeholder="mas: chsblar"></div>
              <div class="row"><label>Filter 2</label><input id="bn_f2" placeholder="mas: 10-sinf"></div>
              <div class="row"><label>Filter 3</label><input id="bn_f3" placeholder="mas: 1-chorak"></div>
              <div class="row"><label>&nbsp;</label><button id="bn_add" class="btn btn--pri">Qo‘shish</button></div>
            </div>
            <p class="muted" style="margin-top:6px">Bannerlar index bosh sahifasida ko‘rinadi.</p>
          </div>
          <div>
            <h3 style="margin-top:0">Bannerlar (ro‘yxat)</h3>
            <div class="filters" style="margin-bottom:8px">
              <select id="bn_filter1"><option value="">Filter 1</option></select>
              <select id="bn_filter2"><option value="">Filter 2</option></select>
              <select id="bn_filter3"><option value="">Filter 3</option></select>
              <button id="bn_reset" class="btn">Tozalash</button>
              <span class="muted" id="bn_info">—</span>
            </div>
            <div class="grid-cards" id="bn_list"></div>
            <div class="pager">
              <button id="bn_prev" class="btn" disabled>← Oldingi</button>
              <div class="muted" id="bn_page">1-sahifa</div>
              <button id="bn_next" class="btn" disabled>Keyingi →</button>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== COURSES ===== -->
      <section id="tab_courses" class="section" style="display:none">
        <div class="grid2">
          <div>
            <h3 style="margin-top:0">Kurs qo‘shish</h3>
            <div class="form-grid">
              <div class="row"><label>Sarlavha</label><input id="cr_title" placeholder="Kurs nomi"></div>
              <div class="row"><label>Rasm URL (16:9)</label><input id="cr_cover" placeholder="https://..."></div>
              <div class="row"><label>Fan/yo‘nalish</label><input id="cr_subject" placeholder="mas: Matematika"></div>
              <div class="row"><label>Daraja (level)</label><input id="cr_level" placeholder="mas: Boshlang‘ich"></div>
              <div class="row"><label>Dars uzunligi</label><input id="cr_duration" placeholder="mas: 12 soat"></div>
              <div class="row"><label>Filter 1</label><input id="cr_f1" placeholder="mas: chsblar"></div>
              <div class="row"><label>Filter 2</label><input id="cr_f2" placeholder="mas: 10-sinf"></div>
              <div class="row"><label>Filter 3</label><input id="cr_f3" placeholder="mas: 1-chorak"></div>
              <div class="row"><label>&nbsp;</label><button id="cr_add" class="btn btn--pri">Qo‘shish</button></div>
            </div>
          </div>
          <div>
            <h3 style="margin-top:0">Kurslar (ro‘yxat)</h3>
            <div class="filters" style="margin-bottom:8px">
              <select id="cr_filter1"><option value="">Filter 1</option></select>
              <select id="cr_filter2"><option value="">Filter 2</option></select>
              <select id="cr_filter3"><option value="">Filter 3</option></select>
              <button id="cr_reset" class="btn">Tozalash</button>
              <span class="muted" id="cr_info">—</span>
            </div>
            <div class="grid-cards" id="cr_list"></div>
            <div class="pager">
              <button id="cr_prev" class="btn" disabled>← Oldingi</button>
              <div class="muted" id="cr_page">1-sahifa</div>
              <button id="cr_next" class="btn" disabled>Keyingi →</button>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== SIMULATORS ===== -->
      <section id="tab_simulators" class="section" style="display:none">
        <div class="grid2">
          <div>
            <h3 style="margin-top:0">Simulyator qo‘shish</h3>
            <div class="form-grid">
              <div class="row"><label>Sarlavha</label><input id="sm_title" placeholder="Simulyator nomi"></div>
              <div class="row"><label>Rasm URL (16:9)</label><input id="sm_cover" placeholder="https://..."></div>
              <div class="row"><label>Fan/yo‘nalish</label><input id="sm_subject" placeholder="mas: Algebra"></div>
              <div class="row"><label>Daraja (level)</label><input id="sm_level" placeholder="mas: O‘rta"></div>
              <div class="row"><label>Trening davomiyligi</label><input id="sm_duration" placeholder="mas: 30 min"></div>
              <div class="row"><label>Filter 1</label><input id="sm_f1" placeholder="mas: chsblar"></div>
              <div class="row"><label>Filter 2</label><input id="sm_f2" placeholder="mas: 10-sinf"></div>
              <div class="row"><label>Filter 3</label><input id="sm_f3" placeholder="mas: 1-chorak"></div>
              <div class="row"><label>&nbsp;</label><button id="sm_add" class="btn btn--pri">Qo‘shish</button></div>
            </div>
          </div>
          <div>
            <h3 style="margin-top:0">Simulyatorlar (ro‘yxat)</h3>
            <div class="filters" style="margin-bottom:8px">
              <select id="sm_filter1"><option value="">Filter 1</option></select>
              <select id="sm_filter2"><option value="">Filter 2</option></select>
              <select id="sm_filter3"><option value="">Filter 3</option></select>
              <button id="sm_reset" class="btn">Tozalash</button>
              <span class="muted" id="sm_info">—</span>
            </div>
            <div class="grid-cards" id="sm_list"></div>
            <div class="pager">
              <button id="sm_prev" class="btn" disabled>← Oldingi</button>
              <div class="muted" id="sm_page">1-sahifa</div>
              <button id="sm_next" class="btn" disabled>Keyingi →</button>
            </div>
          </div>
        </div>
      </section>

      <!-- ===== TESTS ===== -->
      <section id="tab_tests" class="section" style="display:none">
        <div class="grid2">
          <div>
            <h3 style="margin-top:0">Test qo‘shish</h3>
            <div class="warning" style="margin-bottom:10px">
              <b>Online test</b> — boshlash/tugash vaqtlarini kiriting. <b>Oddiy test</b> — vaqt talab qilinmaydi (filtrlashga tushadi).
            </div>
            <div class="form-grid">
              <div class="row"><label>Sarlavha</label><input id="ts_title" placeholder="Test nomi"></div>
              <div class="row"><label>Rasm URL (16:9)</label><input id="ts_cover" placeholder="https://..."></div>
              <div class="row"><label>Turi</label>
                <select id="ts_type">
                  <option value="online">online</option>
                  <option value="oddiy">oddiy</option>
                </select>
              </div>
              <div class="row"><label>Filter 1</label><input id="ts_f1" placeholder="mas: chsblar"></div>
              <div class="row"><label>Filter 2</label><input id="ts_f2" placeholder="mas: 10-sinf"></div>
              <div class="row"><label>Filter 3</label><input id="ts_f3" placeholder="mas: 1-chorak"></div>
              <div class="row"><label>Boshlash (online)</label><input id="ts_start" type="datetime-local"></div>
              <div class="row"><label>Tugash (online)</label><input id="ts_end" type="datetime-local"></div>
              <div class="row"><label>&nbsp;</label><button id="ts_add" class="btn btn--pri">Qo‘shish</button></div>
            </div>
          </div>
          <div>
            <h3 style="margin-top:0">Testlar (ro‘yxat)</h3>
            <div class="filters" style="margin-bottom:8px">
              <select id="ts_filter_type">
                <option value="">Barchasi</option>
                <option value="online">faqat online</option>
                <option value="oddiy">faqat oddiy</option>
              </select>
              <select id="ts_filter1"><option value="">Filter 1</option></select>
              <select id="ts_filter2"><option value="">Filter 2</option></select>
              <select id="ts_filter3"><option value="">Filter 3</option></select>
              <button id="ts_reset" class="btn">Tozalash</button>
            </div>

            <div class="section" style="margin-bottom:8px">
              <h4 style="margin:0 0 8px 0">Onlayn testlar (doim birinchi)</h4>
              <div class="grid-cards" id="ts_online"></div>
            </div>

            <div class="grid-cards" id="ts_list"></div>
            <div class="pager">
              <button id="ts_prev" class="btn" disabled>← Oldingi</button>
              <div class="muted" id="ts_page">1-sahifa (oddiy)</div>
              <button id="ts_next" class="btn" disabled>Keyingi →</button>
            </div>
            <p class="muted" id="ts_info" style="margin-top:8px">—</p>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, collection, doc, setDoc, addDoc, getDoc, getDocs, deleteDoc,
      query, where, orderBy, limit as qLimit, startAfter, serverTimestamp, Timestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ===== SAME CONFIG AS INDEX =====
    const firebaseConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.firebasestorage.app",
      messagingSenderId: "992512966017",
      appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId: "G-459PLJ7P7L"
    };
    const appFB = initializeApp(firebaseConfig);
    const auth = getAuth(appFB);
    const db   = getFirestore(appFB);
    const provider = new GoogleAuthProvider();

    // ===== helpers
    const $  = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));

    function isAdminNumericId(v){ return (v===38864 || v==='38864'); }
    function cardHTML(d, extraMeta=[]){
      const img = d.cover || d.banner || d.image || "assets/placeholder.png";
      const title = d.title || d.name || "Nomlanmagan";
      const meta = [d.level, d.subject, d.type, d.duration, ...extraMeta].filter(Boolean).join(" · ");
      return `
        <div class="gcard">
          <img class="cover" src="${img}" alt="">
          <div class="body">
            <h3>${title}</h3>
            ${meta?`<div class="meta">${meta}</div>`:""}
            <div class="row-inline">
              ${d.filter1?`<span class="badge">${d.filter1}</span>`:""}
              ${d.filter2?`<span class="badge">${d.filter2}</span>`:""}
              ${d.filter3?`<span class="badge">${d.filter3}</span>`:""}
              ${d.type==='online'?`<span class="badge">ONLINE</span>`:""}
            </div>
          </div>
        </div>`;
    }
    function unique(arr){ return Array.from(new Set(arr.filter(Boolean))); }
    function toTsLocal(dtInput){ // datetime-local string -> Timestamp
      if(!dtInput) return null;
      const ms = new Date(dtInput).getTime();
      if(isNaN(ms)) return null;
      return Timestamp.fromMillis(ms);
    }
    function toHuman(ts){
      if(!ts) return '';
      const ms = ts.seconds? ts.seconds*1000 : ts;
      return new Date(ms).toLocaleString();
    }

    // ===== tab switch
    $$('.tab').forEach(b=>{
      b.addEventListener('click', ()=>{
        $$('.tab').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        const t=b.dataset.tab;
        ['banners','courses','simulators','tests'].forEach(id=>{
          $('#tab_'+id).style.display = (id===t)?'block':'none';
        });
      });
    });

    // ===== guard + whoami
    async function guard(){
      return new Promise((resolve)=>{
        onAuthStateChanged(auth, async (user)=>{
          if(!user){
            // allow quick Google login for admin from admin.html
            const ok = confirm('Admin sahifaga kirish uchun Google orqali tizimga kiring. Davom etamizmi?');
            if(ok){
              try{ await signInWithPopup(auth, provider); }
              catch{ /* ignore */ }
            }
            return resolve(false);
          }
          // read profile
          const snap = await getDoc(doc(db,'users', user.uid));
          const d = snap.exists()? snap.data() : {};
          $('#meName').textContent = d.ism || user.displayName || user.email || 'Admin';
          $('#meId').textContent = d.numericId ?? '—';
          if(!isAdminNumericId(d.numericId)){
            $('#guard').style.display='block';
            $('#app').style.display='none';
            return resolve(false);
          }
          $('#guard').style.display='none';
          $('#app').style.display='block';
          resolve(true);
        });
      });
    }

    // ===== FILTER dropdown fill
    function fill3(select1, select2, select3, docs){
      const u1 = unique(docs.map(d=>d.filter1));
      const u2 = unique(docs.map(d=>d.filter2));
      const u3 = unique(docs.map(d=>d.filter3));
      select1.innerHTML = `<option value="">Filter 1</option>` + u1.map(v=>`<option>${v}</option>`).join('');
      select2.innerHTML = `<option value="">Filter 2</option>` + u2.map(v=>`<option>${v}</option>`).join('');
      select3.innerHTML = `<option value="">Filter 3</option>` + u3.map(v=>`<option>${v}</option>`).join('');
    }
    function matchF(d, f1, f2, f3){
      if(f1 && d.filter1!==f1) return false;
      if(f2 && d.filter2!==f2) return false;
      if(f3 && d.filter3!==f3) return false;
      return true;
    }

    // ===== GENERIC LIST (12 tadan sahifalash)
    function makeLister({coll, listEl, prevEl, nextEl, pageEl, infoEl, f1El, f2El, f3El, fillInfo=true, extraWhere=null, extraMetaFn=null}){
      const PAGE=12;
      let page=1, lastDoc=null, stack=[], cachedForFilters=[];

      async function loadForFilters(){
        const qs = await getDocs(query(collection(db,coll), orderBy('createdAt','desc'), qLimit(400)));
        cachedForFilters = qs.docs.map(d=>({id:d.id, ...d.data()}));
        fill3(f1El, f2El, f3El, cachedForFilters);
        if(infoEl && fillInfo){ infoEl.textContent = `${cachedForFilters.length} ta obyekt (oxirgi 400 ichida)`; }
      }

      async function run(direction){
        const f1=f1El?.value||'', f2=f2El?.value||'', f3=f3El?.value||'';
        let qBase = query(collection(db,coll), orderBy('createdAt','desc'), qLimit(PAGE));
        if(extraWhere){ qBase = extraWhere(qBase); }
        if(direction==='next' && lastDoc){ qBase = query(qBase, startAfter(lastDoc)); }
        if(direction==='prev'){
          if(stack.length<=1) return;
          stack.pop();
          const cursor = stack[stack.length-1];
          qBase = query(collection(db,coll), orderBy('createdAt','desc'), qLimit(PAGE));
          if(extraWhere){ qBase = extraWhere(qBase); }
          if(cursor) qBase = query(qBase, startAfter(cursor));
          page = Math.max(1, page-1);
        }
        const qs = await getDocs(qBase);
        const docs = qs.docs.map(d=>({_id:d.id, ...d.data()}));
        const fdocs = docs.filter(d=>matchF(d, f1, f2, f3));
        listEl.innerHTML = fdocs.length
          ? fdocs.map(d=>{
              const extra = extraMetaFn? extraMetaFn(d) : [];
              return `
                <div>
                  ${cardHTML(d, extra)}
                  <div class="row-inline" style="padding:8px 10px">
                    <span class="muted">${d._id}</span>
                    <button class="btn" data-del="${d._id}">O‘chirish</button>
                  </div>
                </div>
              `;
            }).join('')
          : `<div class="warning">Hech narsa topilmadi</div>`;

        // hook delete
        listEl.querySelectorAll('[data-del]').forEach(b=>{
          b.addEventListener('click', async ()=>{
            if(!confirm('Rostdan ham o‘chirasizmi?')) return;
            await deleteDoc(doc(db,coll, b.dataset.del));
            // refresh page
            await loadForFilters().catch(()=>{});
            await run();
          });
        });

        if(direction!=='prev'){
          if(qs.docs.length){ stack.push(qs.docs[0]); lastDoc = qs.docs[qs.docs.length-1]; }
          if(direction==='next') page++;
        }
        pageEl.textContent = `${page}-sahifa`;
        prevEl.disabled = (page<=1);
        nextEl.disabled = (qs.docs.length<PAGE);
      }

      // events
      f1El?.addEventListener('change', ()=>{ page=1; lastDoc=null; stack=[]; run(); });
      f2El?.addEventListener('change', ()=>{ page=1; lastDoc=null; stack=[]; run(); });
      f3El?.addEventListener('change', ()=>{ page=1; lastDoc=null; stack=[]; run(); });

      prevEl?.addEventListener('click', ()=>run('prev'));
      nextEl?.addEventListener('click', ()=>run('next'));

      // init
      loadForFilters().catch(()=>{});
      run().catch(err=>{ listEl.innerHTML = `<div class="danger">${err?.message||'Xato'}</div>`; });

      return {reload: async()=>{ await loadForFilters(); await run(); }};
    }

    // ====== BANNERS
    const BN = makeLister({
      coll: 'banners',
      listEl: $('#bn_list'), prevEl: $('#bn_prev'), nextEl: $('#bn_next'),
      pageEl: $('#bn_page'), infoEl: $('#bn_info'),
      f1El: $('#bn_filter1'), f2El: $('#bn_filter2'), f3El: $('#bn_filter3'),
      extraMetaFn: (d)=>[d.createdAt?('Yaratildi: '+toHuman(d.createdAt)):'']
    });
    $('#bn_reset')?.addEventListener('click', ()=>{ $('#bn_filter1').value=''; $('#bn_filter2').value=''; $('#bn_filter3').value=''; BN.reload(); });
    $('#bn_add')?.addEventListener('click', async ()=>{
      const title=$('#bn_title').value.trim(), cover=$('#bn_cover').value.trim();
      const f1=$('#bn_f1').value.trim(), f2=$('#bn_f2').value.trim(), f3=$('#bn_f3').value.trim();
      if(!title) return alert('Sarlavha kerak');
      await addDoc(collection(db,'banners'), { title, cover, filter1:f1||null, filter2:f2||null, filter3:f3||null, createdAt: serverTimestamp() });
      $('#bn_title').value=''; $('#bn_cover').value=''; $('#bn_f1').value=''; $('#bn_f2').value=''; $('#bn_f3').value='';
      BN.reload();
    });

    // ====== COURSES
    const CR = makeLister({
      coll: 'courses',
      listEl: $('#cr_list'), prevEl: $('#cr_prev'), nextEl: $('#cr_next'),
      pageEl: $('#cr_page'), infoEl: $('#cr_info'),
      f1El: $('#cr_filter1'), f2El: $('#cr_filter2'), f3El: $('#cr_filter3'),
      extraMetaFn: (d)=>[d.subject, d.level, d.duration, d.createdAt?('Yaratildi: '+toHuman(d.createdAt)):'']
    });
    $('#cr_reset')?.addEventListener('click', ()=>{ $('#cr_filter1').value=''; $('#cr_filter2').value=''; $('#cr_filter3').value=''; CR.reload(); });
    $('#cr_add')?.addEventListener('click', async ()=>{
      const title=$('#cr_title').value.trim(), cover=$('#cr_cover').value.trim();
      const subject=$('#cr_subject').value.trim(), level=$('#cr_level').value.trim(), duration=$('#cr_duration').value.trim();
      const f1=$('#cr_f1').value.trim(), f2=$('#cr_f2').value.trim(), f3=$('#cr_f3').value.trim();
      if(!title) return alert('Sarlavha kerak');
      await addDoc(collection(db,'courses'), {
        title, cover, subject:subject||null, level:level||null, duration:duration||null,
        filter1:f1||null, filter2:f2||null, filter3:f3||null, createdAt: serverTimestamp()
      });
      ['#cr_title','#cr_cover','#cr_subject','#cr_level','#cr_duration','#cr_f1','#cr_f2','#cr_f3'].forEach(s=>$(s).value='');
      CR.reload();
    });

    // ====== SIMULATORS
    const SM = makeLister({
      coll: 'simulators',
      listEl: $('#sm_list'), prevEl: $('#sm_prev'), nextEl: $('#sm_next'),
      pageEl: $('#sm_page'), infoEl: $('#sm_info'),
      f1El: $('#sm_filter1'), f2El: $('#sm_filter2'), f3El: $('#sm_filter3'),
      extraMetaFn: (d)=>[d.subject, d.level, d.duration, d.createdAt?('Yaratildi: '+toHuman(d.createdAt)):'']
    });
    $('#sm_reset')?.addEventListener('click', ()=>{ $('#sm_filter1').value=''; $('#sm_filter2').value=''; $('#sm_filter3').value=''; SM.reload(); });
    $('#sm_add')?.addEventListener('click', async ()=>{
      const title=$('#sm_title').value.trim(), cover=$('#sm_cover').value.trim();
      const subject=$('#sm_subject').value.trim(), level=$('#sm_level').value.trim(), duration=$('#sm_duration').value.trim();
      const f1=$('#sm_f1').value.trim(), f2=$('#sm_f2').value.trim(), f3=$('#sm_f3').value.trim();
      if(!title) return alert('Sarlavha kerak');
      await addDoc(collection(db,'simulators'), {
        title, cover, subject:subject||null, level:level||null, duration:duration||null,
        filter1:f1||null, filter2:f2||null, filter3:f3||null, createdAt: serverTimestamp()
      });
      ['#sm_title','#sm_cover','#sm_subject','#sm_level','#sm_duration','#sm_f1','#sm_f2','#sm_f3'].forEach(s=>$(s).value='');
      SM.reload();
    });

    // ====== TESTS (online birinchi, keyin oddiy + 12 tadan)
    async function renderTestsOnline(){
      const box = $('#ts_online');
      box.innerHTML = 'Yuklanmoqda…';
      try{
        const qs = await getDocs(query(collection(db,'tests'), where('type','==','online'), orderBy('createdAt','desc'), qLimit(24)));
        if(qs.empty){ box.innerHTML = `<div class="muted">Onlayn test yo‘q.</div>`; return; }
        const now = Date.now();
        const items = qs.docs.map(d=>({_id:d.id, ...d.data()}));
        box.innerHTML = items.map(x=>{
          const s = x.startAt ? toHuman(x.startAt) : '';
          const e = x.endAt ? toHuman(x.endAt) : '';
          const live = (x.startAt && x.endAt) ? (now >= (x.startAt.seconds?x.startAt.seconds*1000:x.startAt) && now <= (x.endAt.seconds?x.endAt.seconds*1000:x.endAt)) : false;
          return `
            <div>
              ${cardHTML(x, [(s&&e)?`Boshlash: ${s}`:'', (s&&e)?`Tugash: ${e}`:'', live?'LIVE':''])}
              <div class="row-inline" style="padding:8px 10px">
                <span class="muted">${x._id}</span>
                <button class="btn" data-del="${x._id}">O‘chirish</button>
              </div>
            </div>
          `;
        }).join('');
        // delete handlers
        box.querySelectorAll('[data-del]').forEach(b=>{
          b.addEventListener('click', async ()=>{
            if(!confirm('Rostdan ham o‘chirasizmi?')) return;
            await deleteDoc(doc(db,'tests', b.dataset.del));
            await renderTestsOnline();
            TS.reload();
          });
        });
      }catch(err){
        box.innerHTML = `<div class="danger">${err?.message||'Online testlarni olishda xato'}</div>`;
      }
    }

    const TS = makeLister({
      coll: 'tests',
      listEl: $('#ts_list'), prevEl: $('#ts_prev'), nextEl: $('#ts_next'),
      pageEl: $('#ts_page'), infoEl: $('#ts_info'),
      f1El: $('#ts_filter1'), f2El: $('#ts_filter2'), f3El: $('#ts_filter3'),
      fillInfo: false,
      // oddiylar uchun: type != 'online' (Firestore’da composite index talab qilinishi mumkin)
      extraWhere: (qBase)=>{
        const t = $('#ts_filter_type')?.value || '';
        if(t==='online'){
          // faqat online (bu pastdagi listingda ko‘rinmasin — lekin admin xohlasa ko‘rsin desak alohida qilamiz)
          return query(collection(db,'tests'), where('type','==','online'), orderBy('createdAt','desc'), qLimit(12));
        }
        if(t==='oddiy'){
          return query(collection(db,'tests'), where('type','!=','online'), orderBy('type'), orderBy('createdAt','desc'), qLimit(12));
        }
        // default: oddiylar (online alohida blokda)
        return query(collection(db,'tests'), where('type','!=','online'), orderBy('type'), orderBy('createdAt','desc'), qLimit(12));
      },
      extraMetaFn: (d)=>[
        d.type,
        d.startAt?('Boshlash: '+toHuman(d.startAt)):'',
        d.endAt?('Tugash: '+toHuman(d.endAt)):'',
        d.createdAt?('Yaratildi: '+toHuman(d.createdAt)):''
      ]
    });
    $('#ts_reset')?.addEventListener('click', ()=>{
      $('#ts_filter_type').value='';
      $('#ts_filter1').value=''; $('#ts_filter2').value=''; $('#ts_filter3').value='';
      TS.reload(); renderTestsOnline();
    });
    $('#ts_filter_type')?.addEventListener('change', ()=>{ TS.reload(); });

    $('#ts_add')?.addEventListener('click', async ()=>{
      const title=$('#ts_title').value.trim(), cover=$('#ts_cover').value.trim();
      const type=$('#ts_type').value;
      const f1=$('#ts_f1').value.trim(), f2=$('#ts_f2').value.trim(), f3=$('#ts_f3').value.trim();
      const start=toTsLocal($('#ts_start').value), end=toTsLocal($('#ts_end').value);

      if(!title) return alert('Sarlavha kerak');
      if(type==='online' && (!start || !end)) return alert('Online test uchun boshlash/tugash vaqtlarini kiriting');
      if(type==='online' && start.toMillis() >= end.toMillis()) return alert('Boshlash va tugash vaqtlarini to‘g‘ri kiriting');

      await addDoc(collection(db,'tests'), {
        title, cover, type,
        filter1:f1||null, filter2:f2||null, filter3:f3||null,
        startAt: type==='online'? start : null,
        endAt:   type==='online'? end   : null,
        createdAt: serverTimestamp()
      });

      ['#ts_title','#ts_cover','#ts_f1','#ts_f2','#ts_f3','#ts_start','#ts_end'].forEach(s=>$(s).value='');
      $('#ts_type').value='online';
      await renderTestsOnline();
      TS.reload();
    });

    // start
    if(await guard()){
      await renderTestsOnline();
    }
  </script>
</body>
</html>
