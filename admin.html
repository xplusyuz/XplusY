<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MathCenter Admin — JSON Editor</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--p:#2E8B57;--b:#111;--muted:#6b7280;--bd:#e5e7eb;--bg:#fff;--card:#fafafa;--r:14px;--sh:0 10px 30px rgba(0,0,0,.08)}
    *{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--b)}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bd);z-index:10}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0;font-weight:800;color:var(--p)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button,.btn{border:1px solid var(--bd);background:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
    button.primary{background:linear-gradient(135deg,var(--p),#1F6B45);color:#fff;border:0}
    .tabs{display:flex;gap:6px;margin:18px 0}
    .tab{padding:10px 14px;border:1px solid var(--bd);border-radius:999px;cursor:pointer}
    .tab.active{background:var(--p);color:#fff;border-color:transparent}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);padding:12px;box-shadow:var(--sh)}
    .row{display:flex;gap:8px;align-items:center}
    .badge{display:inline-block;padding:3px 8px;border:1px solid var(--bd);border-radius:999px;font-size:12px;color:#333;background:#fff}
    .form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .form .full{grid-column:1/-1}
    label{font-size:12px;color:#555}
    input,textarea{width:100%;padding:10px;border:1px solid var(--bd);border-radius:10px}
    textarea{min-height:90px}
    .hidden{display:none}
    .footer{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Admin — JSON Editor</h1>
      <div class="toolbar">
        <label class="btn">Import admin.json <input id="fileInp" type="file" accept="application/json" class="hidden"></label>
        <button id="downloadBtn" class="primary">Download admin.json</button>
        <button id="saveLocalBtn">Save to Local (Preview)</button>
        <button id="resetLocalBtn">Clear Local</button>
        <span style="color:var(--muted)">LocalStorage kaliti: <code>__ADMIN_JSON</code></span>
      </div>
      <div style="margin-top:8px;color:var(--muted)" id="status"></div>
      <div class="tabs">
        <div class="tab active" data-tab="banners">Banners</div>
        <div class="tab" data-tab="tests">Tests</div>
        <div class="tab" data-tab="courses">Courses</div>
        <div class="tab" data-tab="simulators">Simulators</div>
        <div class="tab" data-tab="promo">Promo codes</div>
      </div>
    </div>
  </header>

  <main class="container">
    <section id="list" class="grid"></section>

    <section id="editor" class="card hidden">
      <h3 id="editorTitle">Yangi element</h3>
      <div class="form">
        <div class="full"><label>Bo'lim</label>
          <input id="f-section" list="sections" placeholder="banners / tests / courses / simulators / promo">
          <datalist id="sections">
            <option value="banners"/>
            <option value="tests"/>
            <option value="courses"/>
            <option value="simulators"/>
            <option value="promo"/>
          </datalist>
        </div>
        <div><label>ID</label><input id="f-id" placeholder="unique-id"/></div>
        <div><label>Title</label><input id="f-title"/></div>
        <div><label>Subtitle</label><input id="f-subtitle"/></div>
        <div><label>Image URL</label><input id="f-image"/></div>
        <div><label>Link</label><input id="f-link"/></div>
        <div><label>Best?</label><input id="f-best" type="checkbox"/></div><div><label>Bosh sahifada ko'rsatilsin?</label><input id="f-home" type="checkbox"/></div>
        <div><label>Tags (vergul bilan)</label><input id="f-tags" placeholder="algebra, online"/></div>
        <div><label>Mode (tests uchun: online/offline)</label><input id="f-mode" class="only-tests" placeholder="online"/></div>
        <div><label>StartAt</label><input id="f-start" class="only-best" type="datetime-local"/></div>
        <div><label>EndAt</label><input id="f-end" class="only-best" type="datetime-local"/></div>
        <div class="full"><label>Prize / Qo'shimcha</label><input id="f-prize" class="only-best"/></div>
        <div class="full"><label>Details HTML</label><textarea id="f-details"></textarea></div>
        <div><label>Promo code</label><input id="f-promo-code"/></div>
        <div><label>Valid From</label><input id="f-promo-from" type="date"/></div>
        <div><label>Valid To</label><input id="f-promo-to" type="date"/></div>
        <div><label>Discount %</label><input id="f-promo-disc" type="number" min="0" max="100"/></div>
        <div><label>Max Use (0=unlimited)</label><input id="f-promo-max" type="number" min="0"/></div>
      </div>
      <div class="footer">
        <button id="cancelEdit">Bekor qilish</button>
        <button id="saveEdit" class="primary">Saqlash</button>
      </div>
    </section>
  </main>

  <script>
    const $ = s => document.querySelector(s);
    const list = $('#list');
    const editorSec = $('#editor');
    
    function toggleEditorFields(){
      const sec = (document.querySelector('#f-section')?.value || state.tab || '').trim();
      const isBest = document.querySelector('#f-best')?.checked;
      document.querySelectorAll('.only-best').forEach(el=>{
        const box = el.closest('div') || el;
        box.style.display = isBest ? '' : 'none';
      });
      document.querySelectorAll('.only-tests').forEach(el=>{
        const box = el.closest('div') || el;
        box.style.display = (sec==='tests') ? '' : 'none';
      });
    }
const statusEl = $('#status');

    let state = {
      data: { meta:{version:1,updatedAt:new Date().toISOString()}, promo_codes:[], banners:[], cards:{tests:[],courses:[],simulators:[]} },
      tab: 'banners',
      editing: null
    };

    (async function init(){
      const local = localStorage.getItem('__ADMIN_JSON');
      if(local){
        try{ state.data = JSON.parse(local); setStatus('LocalStorage dan yuklandi'); }
        catch{ setStatus('LocalStorage buzilgan, tozalanmoqda'); localStorage.removeItem('__ADMIN_JSON'); }
      } else {
        try{ const r=await fetch('admin.json'); if(r.ok){ state.data = await r.json(); setStatus('admin.json dan yuklandi'); } }
        catch{}
      }
      render(); bindTabs(); bindToolbar();
    })();

    function setStatus(t){ statusEl.textContent = t; }

    function bindTabs(){
      document.querySelectorAll('.tab').forEach(t=>{
        t.addEventListener('click',()=>{
          document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
          t.classList.add('active');
          state.tab = t.dataset.tab;
          render();
        })
      })
    }

    function bindToolbar(){
      $('#fileInp').addEventListener('change', async (e)=>{
        const f=e.target.files[0]; if(!f) return;
        const txt = await f.text();
        try{ state.data = JSON.parse(txt); localStorage.setItem('__ADMIN_JSON', JSON.stringify(state.data)); setStatus('Import qabul qilindi va LocalStorage saqlandi'); render(); }
        catch(err){ alert('JSON xato: '+err.message); }
      });
      $('#downloadBtn').addEventListener('click',()=>{
        const blob = new Blob([JSON.stringify(state.data,null,2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='admin.json'; a.click(); URL.revokeObjectURL(url);
      });
      $('#saveLocalBtn').addEventListener('click',()=>{ localStorage.setItem('__ADMIN_JSON', JSON.stringify(state.data)); setStatus('LocalStorage yangilandi'); });
      $('#resetLocalBtn').addEventListener('click',()=>{ localStorage.removeItem('__ADMIN_JSON'); setStatus('LocalStorage tozalandi'); });
    }

    function sectionItems(){
      if(state.tab==='banners') return state.data.banners;
      if(state.tab==='promo') return state.data.promo_codes;
      return state.data.cards[state.tab] || [];
    }

    function render(){
      list.innerHTML='';
      const items = sectionItems();

      const add = document.createElement('div');
      add.className='card';
      add.innerHTML = `<div style="font-weight:800;margin-bottom:6px">Yangi qo'shish</div>
        <div class="row"><button class="primary" id="addBtn">+ Add</button></div>`;
      list.appendChild(add);
      add.querySelector('#addBtn').onclick = ()=> openEditor(null);

      items.forEach((it, idx)=>{
        const el = document.createElement('div'); el.className='card';
        if(state.tab==='promo'){
          el.innerHTML = `
            <div class="row" style="justify-content:space-between">
              <div><span class="badge">PROMO</span> <b>${it.code}</b> — ${it.discountPercent||0}%</div>
              <div class="row"><button class="btn-edit">Edit</button><button class="btn-del">Del</button></div>
            </div>
            <div style="color:#555;font-size:12px">${it.validFrom||''} → ${it.validTo||''} • maxUse: ${it.maxUse||0}</div>`;
        } else {
          el.innerHTML = `
            <div class="row" style="justify-content:space-between">
              <div class="row">
                <span class="badge">${state.tab.toUpperCase()}</span>
                ${it.best? '<span class="badge">BEST</span>':''}
              </div>
              <div class="row"><button class="btn-edit">Edit</button><button class="btn-del">Del</button></div>
            </div>
            <div style="margin:6px 0;font-weight:700">${it.title||it.id||'-'}</div>
            ${it.image? `<img src="${it.image}" alt="" style="width:100%;height:120px;object-fit:cover;border-radius:10px">`:''}
            <div style="color:#555;font-size:12px">${(it.tags||[]).join(', ')}</div>`;
        }
        el.querySelector('.btn-edit').onclick = ()=> openEditor({idx});
        el.querySelector('.btn-del').onclick = ()=> { if(confirm('O‘chirish?')){ items.splice(idx,1); render(); } };
        list.appendChild(el);
      });
    }

    function openEditor(ref){
      editorSec.classList.remove('hidden');
      const secInp = $('#f-section');
      const idInp = $('#f-id');
      const titleInp = $('#f-title');
      const subInp = $('#f-subtitle');
      const imgInp = $('#f-image');
      const linkInp = $('#f-link');
      const bestInp = $('#f-best');
      const tagsInp = $('#f-tags');
      const modeInp = $('#f-mode');
      const sAt = $('#f-start');
      const eAt = $('#f-end');
      const prize = $('#f-prize');
      const homeInp = $('#f-home');
      const details = $('#f-details');
      toggleEditorFields();
      $('#f-section').addEventListener('input', toggleEditorFields);
      $('#f-best').addEventListener('change', toggleEditorFields);

      const pc = $('#f-promo-code');
      const pf = $('#f-promo-from');
      const pt = $('#f-promo-to');
      const pd = $('#f-promo-disc');
      const pm = $('#f-promo-max');

      if(ref){
        const items = sectionItems();
        const it = items[ref.idx];
        state.editing = {section: state.tab, idx: ref.idx};
        $('#editorTitle').textContent = 'Tahrirlash';
        secInp.value = state.tab;
        idInp.value = it.id || it.code || '';
        titleInp.value = it.title || '';
        subInp.value = it.subtitle || '';
        imgInp.value = it.image || '';
        linkInp.value = it.link || '';
        bestInp.checked = !!it.best;
        homeInp.checked = !!it.home;
        tagsInp.value = (it.tags||[]).join(', ');
        modeInp.value = it.mode || '';
        sAt.value = it.startAt? toLocal(it.startAt):'';
        eAt.value = it.endAt? toLocal(it.endAt):'';
        prize.value = it.prize || '';
        details.value = it.detailsHtml || '';
        pc.value = it.code || '';
        pf.value = it.validFrom || '';
        pt.value = it.validTo || '';
        pd.value = it.discountPercent || '';
        pm.value = it.maxUse || 0;
      } else {
        state.editing = {section: state.tab, idx: null};
        $('#editorTitle').textContent = 'Yangi element';
        secInp.value = state.tab;
        idInp.value = ''; titleInp.value = ''; subInp.value=''; imgInp.value=''; linkInp.value=''; bestInp.checked=false; tagsInp.value=''; modeInp.value=''; sAt.value=''; eAt.value=''; prize.value=''; details.value=''; pc.value=''; pf.value=''; pt.value=''; pd.value=''; pm.value=0;
      }

      $('#cancelEdit').onclick = ()=> editorSec.classList.add('hidden');
      $('#saveEdit').onclick = ()=> saveEditor();
    }

    function toLocal(iso){ const d=new Date(iso); const tz=d.getTimezoneOffset(); const d2=new Date(d.getTime()-tz*60000); return d2.toISOString().slice(0,16); }

    function saveEditor(){
      const sec = $('#f-section').value || state.tab;
      if(!sec) return alert('Bo‘lim tanlang');
      if(sec==='promo'){
        const obj = {
          code: $('#f-promo-code').value.trim(),
          validFrom: $('#f-promo-from').value || null,
          validTo: $('#f-promo-to').value || null,
          discountPercent: Number($('#f-promo-disc').value||0),
          maxUse: Number($('#f-promo-max').value||0)
        };
        const arr = state.data.promo_codes;
        if(state.editing && state.editing.idx!=null && state.editing.section==='promo') arr[state.editing.idx]=obj; else arr.push(obj);
      } else if(sec==='banners' || sec==='tests' || sec==='courses' || sec==='simulators'){
        const obj = {
          id: $('#f-id').value.trim() || ('id-'+Math.random().toString(36).slice(2)),
          title: $('#f-title').value.trim(),
          subtitle: $('#f-subtitle').value.trim() || undefined,
          image: $('#f-image').value.trim() || undefined,
          link: $('#f-link').value.trim() || '#',
          best: $('#f-best').checked || false,
          home: $('#f-home').checked || false,
          tags: ($('#f-tags').value||'').split(',').map(s=>s.trim()).filter(Boolean),
          mode: $('#f-mode').value.trim() || undefined,
          startAt: $('#f-start').value? new Date($('#f-start').value).toISOString(): undefined,
          endAt: $('#f-end').value? new Date($('#f-end').value).toISOString(): undefined,
          prize: $('#f-prize').value.trim() || undefined,
          detailsHtml: $('#f-details').value || undefined
        };
        
        // Cleanup fields based on section/best
        if(sec!=='tests'){ delete obj.mode; }
        if(!obj.best){ delete obj.startAt; delete obj.endAt; delete obj.prize; }
const arr = (sec==='banners')? state.data.banners : state.data.cards[sec];
        if(state.editing && state.editing.idx!=null && state.editing.section===state.tab) arr[state.editing.idx]=obj; else arr.push(obj);
      } else {
        return alert('Noma’lum bo‘lim');
      }
      state.data.meta.updatedAt = new Date().toISOString();
      editorSec.classList.add('hidden');
      render();
    }
  </script>
</body>
</html>
