<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Äî 1688 ‚Üí products.json</title>
  <style>
    :root{
      --bg:#0b1220; --muted:#9bb0d0; --text:#eaf0ff; --stroke:rgba(255,255,255,.10);
      --brand:#2E8B57;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(46,139,87,.35), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(83,134,255,.25), transparent 55%),
        var(--bg);
    }
    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter: blur(10px);
      background: rgba(11,18,32,.55);
      border-bottom: 1px solid var(--stroke);
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; gap:10px; align-items:center}
    .logo{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;background:rgba(255,255,255,.08);border:1px solid var(--stroke)}
    .t1{font-weight:850}
    .t2{font-size:12px;color:var(--muted)}
    a.btn, button.btn{
      text-decoration:none; color:var(--text);
      border:1px solid rgba(46,139,87,.6);
      background: linear-gradient(180deg, rgba(46,139,87,.95), rgba(20,59,38,.95));
      padding:10px 12px; border-radius:14px; font-weight:900;
      cursor:pointer;
    }
    button.ghost{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 16px 40px}
    .panel{border:1px solid var(--stroke);border-radius:18px;background:rgba(255,255,255,.05);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grid2{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.grid2{grid-template-columns:1.1fr .9fr}}
    label{font-size:12px;color:var(--muted)}
    input, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
    }
    input:focus, textarea:focus{border-color: rgba(46,139,87,.65)}
    textarea{min-height:92px;resize:vertical}
    .divider{height:1px;background:var(--stroke);margin:14px 0}
    .status{font-size:12px;color:var(--muted)}
    .list{display:grid;gap:10px}
    .item{
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:10px 12px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      background:rgba(0,0,0,.18);
    }
    .left{display:flex; flex-direction:column; gap:2px; min-width:0}
    .title{font-weight:900;font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:620px}
    .sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:620px}
    .badge{font-size:11px;padding:6px 9px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.06)}
    img.preview{width:100%;aspect-ratio:1/1;object-fit:cover;border-radius:16px;border:1px solid var(--stroke);background:rgba(255,255,255,.05)}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}
    code{background:rgba(255,255,255,.08);padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">‚öôÔ∏è</div>
      <div>
        <div class="t1">Admin panel</div>
        <div class="t2">1688 link ‚Üí (metadata) ‚Üí products.json</div>
      </div>
    </div>
    <div class="row">
      <a class="btn" href="./index.html">Store</a>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="grid2">
        <div>
          <div class="row" style="justify-content:space-between">
            <div>
              <div style="font-weight:950">Import</div>
              <div class="hint">1688 sahifasini brauzer bevosita o‚Äòqiy olmaydi (CORS/anti-bot). Shuning uchun bu demo <b>Microlink</b> orqali title + rasm + description metadata oladi. Narx/variantlarni qo‚Äòlda to‚Äòldirasiz.</div>
            </div>
            <span class="badge">npm/deploy yo‚Äòq</span>
          </div>

          <div class="divider"></div>

          <label>1688 mahsulot URL</label>
          <div class="row">
            <input id="url" placeholder="https://detail.1688.com/..." />
            <button class="btn" id="btnFetch">Import</button>
          </div>
          <div class="status" id="status"></div>

          <div class="divider"></div>

          <div class="grid2" style="grid-template-columns:1fr 1fr; gap:12px">
            <div>
              <label>Nomi (title)</label>
              <input id="title" placeholder="Mahsulot nomi" />
            </div>
            <div>
              <label>Narx (UZS) ‚Äî qo‚Äòlda</label>
              <input id="priceUZS" placeholder="masalan: 99000 so'm" />
            </div>
          </div>

          <div style="height:10px"></div>

          <label>Rasm URL (asosiy)</label>
          <input id="img1" placeholder="https://..." />

          <div style="height:10px"></div>

          <label>Qo‚Äòshimcha rasmlar (har qatorga bitta URL)</label>
          <textarea id="imgs" placeholder="https://...
https://..."></textarea>

          <div style="height:10px"></div>

          <label>Qisqa izoh (description)</label>
          <textarea id="desc" placeholder="Mahsulot haqida qisqa matn"></textarea>

          <div style="height:10px"></div>

          <div class="row">
            <button class="btn" id="btnAdd">+ Ro‚Äòyxatga qo‚Äòshish</button>
            <button class="btn ghost" id="btnClear">Tozalash</button>
          </div>

          <div class="divider"></div>

          <div class="row">
            <button class="btn" id="btnDownload">‚¨á products.json yuklab olish</button>
            <button class="btn ghost" id="btnReset">LocalStorage tozalash</button>
            <span class="status">Hozirgi saqlangan: <b id="count">0</b> ta</span>
          </div>

          <div class="hint" style="margin-top:10px">
            ‚úÖ Hammasi statik: admin mahsulotlarni qo‚Äòshadi ‚Üí <code>products.json</code> ni yuklab oladi ‚Üí hostingdagi eski products.json o‚Äòrniga qo‚Äòyadi.
            <br/>‚ö†Ô∏è Eslatma: LocalStorage faqat sizning brauzeringizda. Hammaga bir xil ko‚Äòrinishi uchun products.json‚Äôni hostingda yangilash kerak.
          </div>
        </div>

        <div>
          <div style="font-weight:950">Preview</div>
          <div class="divider"></div>
          <img class="preview" id="previewImg" alt="Preview" />
          <div style="height:10px"></div>
          <div class="item" style="flex-direction:column; align-items:flex-start">
            <div class="title" id="previewTitle" style="max-width:100%">Mahsulot nomi shu yerda chiqadi</div>
            <div class="sub" id="previewSub" style="max-width:100%">Narx + manba URL</div>
          </div>

          <div class="divider"></div>
          <div style="font-weight:950">Ro‚Äòyxat</div>
          <div style="height:10px"></div>
          <div class="list" id="list"></div>
        </div>
      </div>
    </section>
  </main>

<script>
  const $ = (id) => document.getElementById(id);

  const status = $('status');
  const urlEl = $('url');
  const titleEl = $('title');
  const priceEl = $('priceUZS');
  const img1El = $('img1');
  const imgsEl = $('imgs');
  const descEl = $('desc');

  const previewImg = $('previewImg');
  const previewTitle = $('previewTitle');
  const previewSub = $('previewSub');

  const list = $('list');
  const count = $('count');

  const KEY = 'MINISHOP_PRODUCTS';

  function setStatus(msg){ status.textContent = msg || ''; }
  function safeText(s){ return (s ?? '').toString().trim(); }

  function loadStored(){
    const raw = localStorage.getItem(KEY);
    if(!raw) return [];
    try{
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }
  function saveStored(arr){
    localStorage.setItem(KEY, JSON.stringify(arr));
    count.textContent = String(arr.length);
  }

  function placeholder(){
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(
      "<svg xmlns='http://www.w3.org/2000/svg' width='800' height='800'>" +
      "<rect width='100%' height='100%' fill='rgba(255,255,255,.06)'/>" +
      "<text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='rgba(255,255,255,.55)' font-family='Arial' font-size='28'>No image</text>" +
      "</svg>"
    );
  }

  function refreshPreview(){
    const t = safeText(titleEl.value) || 'Mahsulot nomi shu yerda chiqadi';
    const p = safeText(priceEl.value);
    const u = safeText(urlEl.value);
    const img = safeText(img1El.value) || placeholder();

    previewImg.src = img;
    previewTitle.textContent = t;
    previewSub.textContent = [p, u].filter(Boolean).join(' ‚Ä¢ ');
  }

  [urlEl, titleEl, priceEl, img1El, imgsEl, descEl].forEach(el => el.addEventListener('input', refreshPreview));

  async function fetchMeta(){
    const url = safeText(urlEl.value);
    if(!/^https?:\/\//i.test(url)){
      setStatus("URL noto‚Äòg‚Äòri. https:// bilan boshlansin.");
      return;
    }
    setStatus("Import qilinyapti (metadata) ...");
    try{
      // Microlink Open Graph metadata (CORS open)
      const api = "https://api.microlink.io/?url=" + encodeURIComponent(url);
      const r = await fetch(api);
      const j = await r.json();
      if(!j || !j.data){
        setStatus("O‚Äòqib bo‚Äòlmadi. Boshqa link sinab ko‚Äòring.");
        return;
      }

      const t = safeText(j.data.title);
      const d = safeText(j.data.description);
      const img = j.data.image && j.data.image.url ? j.data.image.url : "";

      if(t && !safeText(titleEl.value)) titleEl.value = t;
      if(d && !safeText(descEl.value)) descEl.value = d;
      if(img && !safeText(img1El.value)) img1El.value = img;

      refreshPreview();
      setStatus("‚úÖ Import bo‚Äòldi. Endi narxni qo‚Äòlda kiriting va ro‚Äòyxatga qo‚Äòshing.");
    }catch(e){
      setStatus("Xato: " + (e && e.message ? e.message : String(e)));
    }
  }

  function normalizeImages(){
    const main = safeText(img1El.value);
    const extra = (imgsEl.value || "")
      .split(/\r?\n/g)
      .map(s => safeText(s))
      .filter(Boolean);

    const all = [main, ...extra].filter(Boolean)
      .map(u => u.startsWith("//") ? ("https:" + u) : u)
      .filter(u => /^https?:\/\//i.test(u));

    // unique
    const seen = new Set();
    const out = [];
    for(const u of all){
      if(seen.has(u)) continue;
      seen.add(u);
      out.push(u);
    }
    return out.slice(0, 12);
  }

  function addProduct(){
    const sourceUrl = safeText(urlEl.value);
    if(!/^https?:\/\//i.test(sourceUrl)){
      setStatus("Avval to‚Äòg‚Äòri URL kiriting.");
      return;
    }

    const title = safeText(titleEl.value);
    if(!title){
      setStatus("Mahsulot nomi bo‚Äòsh bo‚Äòlmasin.");
      return;
    }

    const images = normalizeImages();
    const priceUZS = safeText(priceEl.value);
    const description = safeText(descEl.value);

    const id = "p_" + Date.now().toString(36);

    const p = {
      id,
      source: "1688",
      sourceUrl,
      title,
      priceUZS,
      priceText: "",   // ixtiyoriy
      images,
      description,
      createdAt: new Date().toISOString()
    };

    const arr = loadStored();
    arr.unshift(p);
    saveStored(arr);
    renderList(arr);
    setStatus("‚úÖ Qo‚Äòshildi. products.json‚Äôni yuklab oling.");
  }

  function clearForm(){
    titleEl.value = "";
    priceEl.value = "";
    img1El.value = "";
    imgsEl.value = "";
    descEl.value = "";
    refreshPreview();
    setStatus("");
  }

  function renderList(arr){
    list.innerHTML = "";
    arr.forEach((p, idx) => {
      const wrap = document.createElement('div');
      wrap.className = 'item';

      const left = document.createElement('div');
      left.className = 'left';
      const t = document.createElement('div');
      t.className = 'title';
      t.textContent = p.title || 'Nomsiz';
      const s = document.createElement('div');
      s.className = 'sub';
      s.textContent = [p.priceUZS || p.priceText || "", p.sourceUrl || ""].filter(Boolean).join(" ‚Ä¢ ");
      left.appendChild(t);
      left.appendChild(s);

      const right = document.createElement('div');
      right.className = 'row';

      const open = document.createElement('a');
      open.className = 'badge';
      open.href = p.sourceUrl || '#';
      open.target = '_blank';
      open.rel = 'noreferrer';
      open.textContent = 'Ochish';

      const del = document.createElement('button');
      del.className = 'badge';
      del.style.cursor = 'pointer';
      del.textContent = 'O‚Äòchirish';
      del.addEventListener('click', () => {
        const fresh = loadStored().filter(x => x.id !== p.id);
        saveStored(fresh);
        renderList(fresh);
        setStatus("üóë O‚Äòchirildi.");
      });

      right.appendChild(open);
      right.appendChild(del);

      wrap.appendChild(left);
      wrap.appendChild(right);
      list.appendChild(wrap);
    });

    count.textContent = String(arr.length);
  }

  function downloadJson(){
    const products = loadStored();

    const payload = {
      schema: "minishop.products.v1",
      updatedAt: new Date().toISOString(),
      products
    };

    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "products.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 800);
    setStatus("‚¨á products.json yuklab olindi. Endi hostingdagi products.json o‚Äòrniga qo‚Äòying.");
  }

  $('btnFetch').addEventListener('click', fetchMeta);
  $('btnAdd').addEventListener('click', addProduct);
  $('btnClear').addEventListener('click', clearForm);
  $('btnDownload').addEventListener('click', downloadJson);
  $('btnReset').addEventListener('click', () => {
    localStorage.removeItem(KEY);
    renderList([]);
    setStatus("LocalStorage tozalandi.");
  });

  // init
  previewImg.src = placeholder();
  const init = loadStored();
  saveStored(init);
  renderList(init);
  refreshPreview();
</script>
</body>
</html>
