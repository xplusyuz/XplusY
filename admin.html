<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>LeaderMath ‚Äî Home Admin (Secure)</title>
  <meta name="theme-color" content="#2E8B57"/>

  <!-- Favicon: 404 bo'lmasligi uchun -->
  <link rel="icon" href="/favicon.png" sizes="any">
  <link rel="shortcut icon" href="/favicon.png" type="image/png">

  <style>
    :root{--brand:#2E8B57;--line:#dfe7e2;--muted:#4a6b5a}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font:15px/1.5 system-ui,Segoe UI,Arial;background:#f4f8f6;color:#0d1b14}
    header{position:sticky;top:0;background:#f4f8f6;border-bottom:1px solid var(--line);z-index:10}
    .row{max-width:1180px;margin:0 auto;padding:10px 16px;display:flex;gap:10px;align-items:center}
    .brand{font-weight:800;color:var(--brand)}
    main{max-width:1180px;margin:0 auto;padding:16px;display:grid;gap:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    button{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    button.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{border:1px solid var(--line);border-radius:12px;background:#fff}
    .card h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--line)}
    .card .body{padding:12px}
    input,select,textarea{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px}
    textarea{min-height:160px;font-family:ui-monospace,Consolas,monospace}
    table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid #eef2ee;text-align:left;vertical-align:top}
    .small{font-size:12px;color:var(--muted)}
    .rowflex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{padding:3px 8px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px}
    .danger{color:#b00020}
    .subtbl td{background:#fbfdfb}
    .muted{color:var(--muted)}
    /* Guard ekran */
    #gate{display:grid;place-items:center;min-height:60vh}
    #app{display:none} /* <‚Äî default: yashirin */
    /* Toast */
    .toasts{position:fixed;right:16px;bottom:16px;display:grid;gap:10px;z-index:1200;max-width:min(360px,90vw)}
    .toast{display:flex;gap:10px;padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;box-shadow:0 8px 26px rgba(0,0,0,.08)}
    .toast .x{margin-left:auto;border:0;background:transparent;cursor:pointer;font-weight:900}
    .toast.success{border-color:#9edfae}.toast.error{border-color:#f2b4ac}
    .thumb{width:48px;height:32px;object-fit:cover;border-radius:6px;border:1px solid var(--line)}
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

    // ‚îÄ‚îÄ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.appspot.com",
      messagingSenderId: "992512966017",
      appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId: "G-459PLJ7P7L"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const st   = getStorage(app);

    // ‚îÄ‚îÄ Faqat shu e-maillar admin
    const ADMIN_EMAILS = ["sohibjonmath@gmail.com"];

    // ‚îÄ‚îÄ Shirin helperlar
    const $  = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>[...r.querySelectorAll(s)];
    const toast=(t,kind='info')=>{
      const host=$('#toasts'); const el=document.createElement('div');
      el.className='toast '+kind; el.innerHTML=`<b>${kind==='error'?'‚ùå':'‚úÖ'}</b><span>${t}</span><button class="x">√ó</button>`;
      el.querySelector('.x').onclick=()=>el.remove(); host.appendChild(el); setTimeout(()=>el.remove(),3500);
    };

    // ‚îÄ‚îÄ Global state
    let state = {sections:[], selSec:-1, selSub:-1, selKind:'banner', selIdx:-1};

    // ‚îÄ‚îÄ Guard UI (kirishdan oldin faqat shu)
    const gate = () => {
      const g = $('#gate');
      g.innerHTML = `
        <div class="card" style="max-width:520px">
          <h3 style="display:flex;align-items:center;gap:8px;padding:12px">üîí Admin panel</h3>
          <div class="body">
            <p class="muted">Paneldan foydalanish faqat Administratorlar uchun.</p>
            <div class="rowflex">
              <button id="glogin" class="primary">Google bilan kiring</button>
            </div>
            <div id="gerr" class="small danger"></div>
          </div>
        </div>`;
      $('#glogin').onclick=async()=>{
        $('#gerr').textContent='';
        try{
          await signInWithPopup(auth,new GoogleAuthProvider());
        }catch(e){ $('#gerr').textContent = e.message||String(e); }
      };
    };

    // ‚îÄ‚îÄ Kirish holatini kuzatish
    onAuthStateChanged(auth, async (u)=>{
      const appWrap = $('#app');
      const guardWrap = $('#gate');
      if(!u){ appWrap.style.display='none'; guardWrap.style.display='grid'; gate(); return; }

      // faqat adminlar
      if(ADMIN_EMAILS.indexOf(u.email)<0){
        appWrap.style.display='none';
        guardWrap.style.display='grid';
        $('#gate').innerHTML = `
          <div class="card" style="max-width:520px">
            <h3 style="padding:12px">‚ùå Ruxsat yo‚Äòq</h3>
            <div class="body">
              <p class="muted">Bu sahifa faqat adminlar uchun. Siz: <b>${u.email||u.uid}</b></p>
              <button id="logout">Chiqish</button>
            </div>
          </div>`;
        $('#logout').onclick=()=>signOut(auth);
        return;
      }

      // OK ‚Äî appni ochamiz
      guardWrap.style.display='none';
      appWrap.style.display='block';
      $('#who').textContent = 'üëã ' + (u.email||u.uid);

      // Firestore‚Äôdan holatni yuklash (faqat admin bo‚Äòlganimizdan keyin!)
      try{
        const snap = await getDoc(doc(db,'configs','home'));
        state = snap.exists()? (snap.data()||{sections:[]}) : {sections:[]};
        if(!Array.isArray(state.sections)) state.sections=[];
        renderSectionsTable();
        $('#sec-editor').innerHTML='<div class="small">Chapdan bo‚Äòlim tanlang.</div>';
        $('#sub-editor').innerHTML=''; $('#items-list').innerHTML=''; $('#item-editor').innerHTML='';
      }catch(e){
        toast('Firestore o‚Äòqishda xato: '+(e.message||e),'error');
      }
    });

    // ‚îÄ‚îÄ Jadval va editorlar (sizdagi versiya asosida qisqartirilgan)
    function renderSectionsTable(){
      const tb = document.querySelector('#tbl-sections tbody'); tb.innerHTML='';
      state.sections.forEach((s,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${s.id||''}</td>
          <td>${s.title||''}</td>
          <td>${s.fullBleed?'<span class="pill">full</span>':''}</td>
          <td class="rowflex">
            <button data-i="${i}" class="selSec">Tanlash</button>
            <button data-i="${i}" class="upSec">‚Üë</button>
            <button data-i="${i}" class="downSec">‚Üì</button>
            <button data-i="${i}" class="delSec">O‚Äòchirish</button>
          </td>`;
        tb.appendChild(tr);
      });
    }

    // Delegation
    document.addEventListener('click', (e)=>{
      const t=e.target;

      // chiqish
      if(t.id==='signout'){ signOut(auth); return; }

      // sections
      if(t.classList.contains('selSec')){ editSection(+t.dataset.i); }
      if(t.classList.contains('upSec')){ const i=+t.dataset.i; if(i>0){ const x=state.sections[i-1]; state.sections[i-1]=state.sections[i]; state.sections[i]=x; renderSectionsTable(); } }
      if(t.classList.contains('downSec')){ const i=+t.dataset.i; if(i<state.sections.length-1){ const x=state.sections[i+1]; state.sections[i+1]=state.sections[i]; state.sections[i]=x; renderSectionsTable(); } }
      if(t.classList.contains('delSec')){ const i=+t.dataset.i; if(confirm('O‚Äòchirilsinmi?')){ state.sections.splice(i,1); renderSectionsTable(); } }
    });

    function editSection(i){
      state.selSec = i; state.selSub = -1; state.selIdx=-1;
      const s = state.sections[i]||{subsections:[]};
      const ed = $('#sec-editor');
      ed.innerHTML = `
        <div class="rowflex">
          <div style="flex:1"><label>ID</label><input id="sid" value="${s.id||''}"></div>
          <div style="flex:1"><label>Sarlavha</label><input id="stitle" value="${s.title||''}"></div>
        </div>
        <div class="rowflex">
          <div style="flex:1"><label>fullBleed</label>
            <select id="sfull"><option value="false"${!s.fullBleed?' selected':''}>false</option>
            <option value="true"${s.fullBleed?' selected':''}>true</option></select></div>
          <div style="flex:1"><label>baseHref</label><input id="sbase" value="${s.baseHref||''}"></div>
        </div>
        <div class="rowflex" style="margin-top:8px">
          <button id="saveSec" class="primary">Bo‚Äòlimni saqlash</button>
          <button id="addSub">+ Sub-bo‚Äòlim qo‚Äòshish</button>
        </div>`;
      $('#saveSec').onclick=()=>{
        const o={ id:$('#sid').value.trim(), title:$('#stitle').value.trim(), fullBleed:($('#sfull').value==='true') };
        const baseHref=$('#sbase').value.trim(); if(baseHref) o.baseHref=baseHref;
        o.subsections = s.subsections||[];
        state.sections[i]=o; renderSectionsTable(); toast('Bo‚Äòlim saqlandi','success');
      };
      $('#addSub').onclick=()=>{
        s.subsections = s.subsections||[];
        const n=s.subsections.length+1;
        s.subsections.push({id:'sub'+n,title:'Yangi sub '+n,fullBleed:false,banners:[],cards:[]});
        toast('Sub-bo‚Äòlim qo‚Äòshildi','success');
      };
    }

    // Toolbar
    document.addEventListener('DOMContentLoaded', ()=>{
      $('#addSec').onclick = ()=>{
        const n=state.sections.length+1;
        state.sections.push({id:'sec'+n,title:'Yangi bo‚Äòlim '+n,fullBleed:false,subsections:[]});
        renderSectionsTable(); editSection(state.sections.length-1);
      };
      $('#download').onclick = ()=>{
        const blob=new Blob([JSON.stringify({sections:state.sections},null,2)],{type:'application/json'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='home.json'; a.click();
        setTimeout(()=>URL.revokeObjectURL(a.href),800);
      };
      $('#publish').onclick = async ()=>{
        try{ await setDoc(doc(db,'configs','home'), {sections:state.sections}); toast('Firestore‚Äôga saqlandi ‚úÖ','success'); }
        catch(e){ toast('Saqlash xatosi: '+e.message,'error'); }
      };
      $('#loadfile').onchange = async (e)=>{
        const f=e.target.files[0]; if(!f) return; const txt=await f.text();
        try{ const obj=JSON.parse(txt); if(Array.isArray(obj.sections)) { state.sections=obj.sections; renderSectionsTable(); toast('JSON yuklandi','success'); } else { toast('JSON: sections topilmadi','error'); } }
        catch(err){ toast('JSON parse xato: '+err.message,'error'); }
      };
    });
  </script>
</head>
<body>
  <header>
    <div class="row">
      <div class="brand">LeaderMath ‚Äî Home Admin</div>
      <div class="rowflex" style="margin-left:auto;gap:8px">
        <div id="who" class="small muted"></div>
        <button id="signout">Chiqish</button>
      </div>
    </div>
  </header>

  <!-- Guard ekran -->
  <div id="gate"></div>

  <!-- Asosiy app (faqat admin kirgach ko'rinadi) -->
  <main id="app">
    <div class="toolbar">
      <button id="addSec">+ Bo‚Äòlim qo‚Äòshish</button>
      <label class="rowflex">JSON fayldan yuklash <input id="loadfile" type="file" accept="application/json"/></label>
      <button id="download">Yuklab olish (home.json)</button>
      <button id="publish" class="primary">Firestore‚Äôga chiqarish</button>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Bo‚Äòlimlar</h3>
        <div class="body">
          <table id="tbl-sections"><thead><tr><th>#</th><th>ID</th><th>Sarlavha</th><th>Full</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </div>
      </div>

      <div class="card">
        <h3>Bo‚Äòlim tahriri</h3>
        <div class="body" id="sec-editor"><div class="small">Chapdan bo‚Äòlim tanlang.</div></div>
      </div>

      <div class="card">
        <h3>Sub-bo‚Äòlimlar</h3>
        <div class="body small muted">Bo‚Äòlim tanlang ‚Äî keyin qo‚Äòshasiz</div>
      </div>

      <div class="card">
        <h3>Sub-bo‚Äòlim tahriri</h3>
        <div class="body" id="sub-editor"></div>
      </div>

      <div class="card">
        <h3>Banner/Card ro‚Äòyxati</h3>
        <div class="body" id="items-list"></div>
      </div>

      <div class="card">
        <h3>Element tahriri</h3>
        <div class="body" id="item-editor"></div>
      </div>
    </div>
  </main>

  <div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>
</body>
</html>
