<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MathCenter Admin â€” Perâ€‘page Exporters</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--brand:#16a34a}
    .brand-grad{background:linear-gradient(135deg,#eafff2,white)}
    .btn{@apply px-3 py-2 rounded-xl shadow hover:scale-[1.02] transition font-medium}
    .btn-primary{@apply bg-green-600 text-white}
    .btn-secondary{@apply bg-white border border-gray-200}
    .tag{@apply text-xs px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700}
    .card{@apply rounded-2xl shadow-sm border border-gray-100 bg-white}
    .input{@apply w-full rounded-lg border border-gray-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-400}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    dialog::backdrop{background:rgba(0,0,0,.35)}
    .sec-title{@apply text-lg font-semibold}
  </style>
</head>
<body class="min-h-screen brand-grad text-gray-900">
  <!-- Topbar -->
  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-gray-100">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-2">
        <div class="w-9 h-9 rounded-2xl bg-gradient-to-br from-emerald-500 to-emerald-600 grid place-items-center text-white text-xl font-black">Ï€</div>
        <div>
          <div class="text-sm font-semibold">MathCenter Admin</div>
          <div class="text-xs text-gray-500">Faqat ruxsat etilgan foydalanuvchi</div>
        </div>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <span id="authEmail" class="text-sm text-gray-600"></span>
        <button id="btnSignIn" type="button" class="btn btn-primary">Google bilan kirish</button>
        <button id="btnSignOut" type="button" class="btn btn-secondary hidden">Chiqish</button>
      </div>
    </div>
  </header>

  <!-- App -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    <div id="accessDenied" class="hidden">
      <div class="card p-6 text-center">
        <div class="text-3xl">ğŸš«</div>
        <h2 class="text-xl font-semibold mt-2">Kirish rad etildi</h2>
        <p class="text-sm text-gray-600 mt-1">Faqat <b>sohibjonmath@gmail.com</b> adminka kirishi mumkin.</p>
      </div>
    </div>

    <div id="adminUi" class="hidden">
      <!-- Tabs -->
      <div class="flex flex-wrap gap-2 mb-4">
        <button data-tab="tab-dashboard" class="tab btn btn-secondary">ğŸ  Banner</button>
        <button data-tab="tab-courses" class="tab btn btn-secondary">ğŸ“š Kurslar</button>
        <button data-tab="tab-tests" class="tab btn btn-secondary">ğŸ“ Testlar</button>
        <button data-tab="tab-simulators" class="tab btn btn-secondary">ğŸ§ª Simulyatorlar</button>
        <button data-tab="tab-promos" class="tab btn btn-secondary">ğŸ·ï¸ Promo kodlar</button>
        <button data-tab="tab-users" class="tab btn btn-secondary">ğŸ‘¥ Foydalanuvchilar</button>
      </div>

      <!-- Banner -->
      <section id="tab-dashboard" class="tab-pane card p-5">
        <div class="flex items-center justify-between mb-4">
          <h3 class="sec-title">Katta reklama banneri</h3>
          <div class="flex gap-2">
            <button id="btnEditBanner" class="btn btn-primary">âœï¸ Banner tahrirlash</button>
          </div>
        </div>
        <div id="bannerView" class="grid lg:grid-cols-[2fr,1fr] gap-4">
          <div class="card p-4">
            <img id="bannerImage" class="w-full h-56 object-cover rounded-xl border border-gray-100" src="" alt="Banner"/>
          </div>
          <div class="card p-4 text-sm">
            <div class="text-gray-500">Sarlavha</div>
            <div id="bannerTitle" class="text-xl font-semibold">â€”</div>
            <div class="text-gray-500 mt-3">Matn</div>
            <div id="bannerSubtitle" class="text-gray-700">â€”</div>
            <div class="grid grid-cols-2 gap-3 mt-3">
              <div>
                <div class="text-gray-500">CTA</div>
                <div id="bannerCta" class="text-gray-700">â€”</div>
              </div>
              <div>
                <div class="text-gray-500">Havola</div>
                <a id="bannerLink" class="text-emerald-700 underline" href="#" target="_blank">â€”</a>
              </div>
            </div>
            <div class="text-gray-500 mt-3">Meta teglar</div>
            <div id="bannerTags" class="flex flex-wrap gap-2"></div>
          </div>
        </div>
        <div class="mt-5">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold">â¬‡ï¸ Export: <code>partials/home.html</code></h4>
            <div class="flex gap-2">
              <button id="btnExportHomeCopy" class="btn btn-secondary">ğŸ“‹ Nusxa olish</button>
              <button id="btnExportHomeDown" class="btn btn-secondary">ğŸ’¾ Yuklab olish</button>
              <button id="btnExportHomePrev" class="btn btn-secondary">ğŸ‘ï¸ Koâ€˜rish</button>
            </div>
          </div>
          <textarea id="exportHome" class="input mono mt-3" rows="16" spellcheck="false"></textarea>
          <iframe id="previewHome" class="w-full h-72 rounded-xl border mt-3 bg-white"></iframe>
        </div>
      </section>

      <!-- Courses -->
      <section id="tab-courses" class="tab-pane card p-5 hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="sec-title">Kurslar</h3>
          <button class="btn btn-primary" id="addCourse">â• Yangi kurs qoâ€˜shish</button>
        </div>
        <div id="coursesGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        <div class="mt-6">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold">â¬‡ï¸ Export: <code>partials/courses.html</code></h4>
            <div class="flex gap-2">
              <button id="btnExportCoursesCopy" class="btn btn-secondary">ğŸ“‹ Nusxa olish</button>
              <button id="btnExportCoursesDown" class="btn btn-secondary">ğŸ’¾ Yuklab olish</button>
              <button id="btnExportCoursesPrev" class="btn btn-secondary">ğŸ‘ï¸ Koâ€˜rish</button>
            </div>
          </div>
          <textarea id="exportCourses" class="input mono mt-3" rows="16" spellcheck="false"></textarea>
          <iframe id="previewCourses" class="w-full h-72 rounded-xl border mt-3 bg-white"></iframe>
        </div>
      </section>

      <!-- Tests -->
      <section id="tab-tests" class="tab-pane card p-5 hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="sec-title">Testlar</h3>
          <button class="btn btn-primary" id="addTest">â• Yangi test qoâ€˜shish</button>
        </div>
        <div id="testsGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        <div class="mt-6">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold">â¬‡ï¸ Export: <code>partials/tests.html</code></h4>
            <div class="flex gap-2">
              <button id="btnExportTestsCopy" class="btn btn-secondary">ğŸ“‹ Nusxa olish</button>
              <button id="btnExportTestsDown" class="btn btn-secondary">ğŸ’¾ Yuklab olish</button>
              <button id="btnExportTestsPrev" class="btn btn-secondary">ğŸ‘ï¸ Koâ€˜rish</button>
            </div>
          </div>
          <textarea id="exportTests" class="input mono mt-3" rows="16" spellcheck="false"></textarea>
          <iframe id="previewTests" class="w-full h-72 rounded-xl border mt-3 bg-white"></iframe>
        </div>
      </section>

      <!-- Simulators -->
      <section id="tab-simulators" class="tab-pane card p-5 hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="sec-title">Simulyatorlar</h3>
          <button class="btn btn-primary" id="addSimulator">â• Yangi simulyator qoâ€˜shish</button>
        </div>
        <div id="simulatorsGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        <div class="mt-6">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold">â¬‡ï¸ Export: <code>partials/simulators.html</code></h4>
            <div class="flex gap-2">
              <button id="btnExportSimsCopy" class="btn btn-secondary">ğŸ“‹ Nusxa olish</button>
              <button id="btnExportSimsDown" class="btn btn-secondary">ğŸ’¾ Yuklab olish</button>
              <button id="btnExportSimsPrev" class="btn btn-secondary">ğŸ‘ï¸ Koâ€˜rish</button>
            </div>
          </div>
          <textarea id="exportSims" class="input mono mt-3" rows="16" spellcheck="false"></textarea>
          <iframe id="previewSims" class="w-full h-72 rounded-xl border mt-3 bg-white"></iframe>
        </div>
      </section>

      <!-- Promos -->
      <section id="tab-promos" class="tab-pane card p-5 hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="sec-title">Promo kodlar</h3>
          <button class="btn btn-primary" id="addPromo">â• Promo kod qoâ€˜shish</button>
        </div>
        <div id="promosGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>

      <!-- Users -->
      <section id="tab-users" class="tab-pane card p-5 hidden">
        <div class="flex items-center justify-between mb-4">
          <h3 class="sec-title">Foydalanuvchilar</h3>
          <div class="flex gap-2">
            <input id="userSearch" class="input w-60" placeholder="Qidirish (ism/email/id)" />
            <button id="btnReloadUsers" class="btn btn-secondary">ğŸ”„ Yangilash</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left text-gray-500">
                <th class="py-2 pr-3">ID</th>
                <th class="py-2 pr-3">Ism</th>
                <th class="py-2 pr-3">Email</th>
                <th class="py-2 pr-3">Balans</th>
                <th class="py-2 pr-3">Ball (Gems)</th>
                <th class="py-2 pr-3">Rol</th>
                <th class="py-2 pr-3">Holat</th>
                <th class="py-2 pr-3">Amal</th>
              </tr>
            </thead>
            <tbody id="usersTbody"></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <!-- CRUD Modal -->
  <dialog id="crudModal" class="rounded-2xl w-[95vw] max-w-2xl p-0">
    <form method="dialog" class="card p-0">
      <div class="flex items-center justify-between px-5 py-3 border-b">
        <h3 id="crudTitle" class="text-lg font-semibold">Tahrirlash</h3>
        <button id="crudClose" class="px-2 py-1 text-gray-500">âœ–</button>
      </div>
      <div class="p-5 space-y-3" id="crudBody"></div>
      <div class="flex items-center justify-end gap-2 px-5 py-3 border-t">
        <button class="btn btn-secondary" value="cancel">Bekor</button>
        <button id="crudSave" class="btn btn-primary" value="default">Saqlash</button>
      </div>
    </form>
  </dialog>

  <template id="gridCardTpl">
    <div class="card overflow-hidden">
      <img class="w-full h-36 object-cover"/>
      <div class="p-3">
        <div class="font-semibold title line-clamp-1">â€”</div>
        <div class="text-xs text-gray-500 subtitle line-clamp-2">â€”</div>
        <div class="mt-2 flex items-center gap-2">
          <span class="tag rating">â­ 5.0</span>
          <a class="text-emerald-700 underline link target="_blank">Havola</a>
        </div>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-secondary btn-edit">âœï¸</button>
          <button class="btn btn-secondary btn-delete">ğŸ—‘ï¸</button>
        </div>
      </div>
    </div>
  </template>

  <script type="module">
    // ===== Firebase Init =====
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, query, orderBy, limit, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.appspot.com",
      messagingSenderId: "992512966017",
      appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId: "G-459PLJ7P7L"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== Auth (only one email allowed) =====
    const ADMIN_EMAIL = 'sohibjonmath@gmail.com';
    const btnSignIn = document.getElementById('btnSignIn');
    const btnSignOutEl = document.getElementById('btnSignOut');
    const authEmailEl = document.getElementById('authEmail');
    const adminUi = document.getElementById('adminUi');
    const accessDenied = document.getElementById('accessDenied');

    btnSignIn.addEventListener('click', async () => {
      try {
        const provider = new GoogleAuthProvider();
        await signInWithPopup(auth, provider);
      } catch (e) {
        alert('Kirishda xatolik: '+ e.message);
        console.error(e);
      }
    });
    btnSignOutEl.addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        authEmailEl.textContent = '';
        btnSignIn.classList.remove('hidden');
        btnSignOutEl.classList.add('hidden');
        adminUi.classList.add('hidden');
        accessDenied.classList.add('hidden');
        return;
      }
      authEmailEl.textContent = user.email || '';
      btnSignIn.classList.add('hidden');
      btnSignOutEl.classList.remove('hidden');
      if ((user.email || '').toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
        adminUi.classList.add('hidden');
        accessDenied.classList.remove('hidden');
        return;
      }
      accessDenied.classList.add('hidden');
      adminUi.classList.remove('hidden');
      // Load initial data
      try {
        if (typeof selectTab === 'function') selectTab('tab-dashboard');
        if (typeof loadBanner === 'function') await loadBanner();
        if (typeof refreshAllGrids === 'function') await refreshAllGrids();
        if (typeof loadUsers === 'function') await loadUsers();
        if (typeof updateAllExporters === 'function') await updateAllExporters();
      } catch (err) { console.error('Init error after auth:', err); }
    });

    // ===== Tabs =====
    document.querySelectorAll('.tab').forEach(b=> b.addEventListener('click', ()=> selectTab(b.dataset.tab)));
    function selectTab(id){
      document.querySelectorAll('.tab-pane').forEach(p=>p.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('!bg-emerald-600','!text-white'));
      document.querySelector(`[data-tab="${id}"]`).classList.add('!bg-emerald-600','!text-white');
    }

    // ===== Banner CRUD & Export =====
    const btnEditBanner = document.getElementById('btnEditBanner');
    const exportHomeEl = document.getElementById('exportHome');
    const previewHome = document.getElementById('previewHome');
    btnEditBanner.addEventListener('click', openBannerEditor);

    document.getElementById('btnExportHomeCopy').onclick = () => copyText(exportHomeEl.value);
    document.getElementById('btnExportHomeDown').onclick = () => downloadText('home.html', exportHomeEl.value);
    document.getElementById('btnExportHomePrev').onclick = () => previewCode(previewHome, exportHomeEl.value);

    async function openBannerEditor(){
      const d = await getDoc(doc(db,'pages','home'));
      const b = d.exists()? (d.data().banner||{}) : {};
      openCrud({
        title:'Banner tahrirlash',
        fields:[
          {key:'imageUrl', label:'Rasm URL', type:'url', required:true, value: b.imageUrl||''},
          {key:'title', label:'Sarlavha', type:'text', required:true, value: b.title||''},
          {key:'subtitle', label:'Matn', type:'textarea', value: b.subtitle||''},
          {key:'link', label:'Havola', type:'url', value: b.link||''},
          {key:'cta', label:'CTA tugma matni', type:'text', value: b.cta||'Boshlash'},
          {key:'tags', label:'Meta teglar (vergul bilan)', type:'text', value: (Array.isArray(b.tags)? b.tags.join(', ') : b.tags)||'Algebra, Geometriya, Olimpiada'}
        ],
        onSave: async (vals)=>{
          if (typeof vals.tags === 'string') vals.tags = vals.tags.split(',').map(s=>s.trim()).filter(Boolean);
          await setDoc(doc(db,'pages','home'), { banner:{...vals, updatedAt: serverTimestamp()} }, { merge:true });
          await loadBanner();
          await updateHomeExporter();
        }
      });
    }

    async function loadBanner(){
      const image = document.getElementById('bannerImage');
      const title = document.getElementById('bannerTitle');
      const subtitle = document.getElementById('bannerSubtitle');
      const link = document.getElementById('bannerLink');
      const cta = document.getElementById('bannerCta');
      const tagsWrap = document.getElementById('bannerTags');
      const d = await getDoc(doc(db,'pages','home'));
      const b = d.exists()? (d.data().banner||{}) : {};
      image.src = b.imageUrl || 'https://images.unsplash.com/photo-1549221986-3d8b6e8d3c61';
      title.textContent = b.title || 'MathCenter â€” yangi mavsum!';
      subtitle.textContent = b.subtitle || 'Eng yaxshi kurslar, testlar va simulyatorlar bitta joyda';
      cta.textContent = b.cta || 'Boshlash';
      link.textContent = b.link || 'â€”';
      link.href = b.link || '#';
      const tags = Array.isArray(b.tags)? b.tags : (b.tags? String(b.tags).split(',').map(s=>s.trim()) : []);
      tagsWrap.innerHTML = tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('');
    }

    // ===== Generic Grids (Add/Edit/Delete only) =====
    const grids = [
      { name:'courses', title:'Kurs', addBtnId:'addCourse', gridId:'coursesGrid', fields:[
        {key:'imageUrl', label:'Rasm URL', type:'url', required:true},
        {key:'title', label:'Sarlavha', type:'text', required:true},
        {key:'subtitle', label:'Qisqa matn', type:'textarea'},
        {key:'link', label:'Havola', type:'url'},
        {key:'rating', label:'Reyting (0-5)', type:'number', step:'0.1', value:5}
      ]},
      { name:'tests', title:'Test', addBtnId:'addTest', gridId:'testsGrid', fields:[
        {key:'imageUrl', label:'Rasm URL', type:'url', required:true},
        {key:'title', label:'Sarlavha', type:'text', required:true},
        {key:'subtitle', label:'Qisqa matn', type:'textarea'},
        {key:'link', label:'Havola', type:'url'},
        {key:'rating', label:'Murakkablik (0-5)', type:'number', step:'0.1', value:4.5}
      ]},
      { name:'simulators', title:'Simulyator', addBtnId:'addSimulator', gridId:'simulatorsGrid', fields:[
        {key:'imageUrl', label:'Rasm URL', type:'url', required:true},
        {key:'title', label:'Sarlavha', type:'text', required:true},
        {key:'subtitle', label:'Qisqa matn', type:'textarea'},
        {key:'link', label:'Havola', type:'url'},
        {key:'rating', label:'Foydalilik (0-5)', type:'number', step:'0.1', value:4.8}
      ]},
      { name:'promos', title:'Promo kod', addBtnId:'addPromo', gridId:'promosGrid', fields:[
        {key:'code', label:'Kod (masalan: MC25)', type:'text', required:true},
        {key:'discountPercent', label:'Chegirma %', type:'number', value:25},
        {key:'maxUses', label:'Maks. foydalanish', type:'number', value:100},
        {key:'usedCount', label:'Ishlatilgan', type:'number', value:0},
        {key:'active', label:'Faol', type:'checkbox', value:true},
        {key:'expiresAt', label:'Tugash sanasi (YYYY-MM-DD)', type:'date'}
      ]}
    ];

    for (const g of grids){
      document.getElementById(g.addBtnId).addEventListener('click', ()=>
        openCrud({ title: g.title + ' qo\'shish', fields: g.fields, onSave: async(vals)=>{
          vals.createdAt = serverTimestamp();
          await addDoc(collection(db, g.name), vals);
          loadGrid(g);
          await updateExporterByCollection(g.name);
        }})
      );
    }

    async function refreshAllGrids(){ for (const g of grids){ await loadGrid(g); } }

    async function loadGrid(g){
      const wrap = document.getElementById(g.gridId);
      wrap.innerHTML = '<div class="text-sm text-gray-500">Yuklanmoqdaâ€¦</div>';
      const qs = query(collection(db,g.name), orderBy('createdAt','desc'));
      const snap = await getDocs(qs);
      wrap.innerHTML = '';
      snap.forEach(docu=>{ const data = { id:docu.id, ...docu.data() }; wrap.appendChild(makeCard(g, data)); });
    }

    function makeCard(g, data){
      const tpl = document.getElementById('gridCardTpl');
      const el = tpl.content.cloneNode(true);
      const img = el.querySelector('img');
      const title = el.querySelector('.title');
      const sub = el.querySelector('.subtitle');
      const link = el.querySelector('.link');
      const rating = el.querySelector('.rating');
      img.src = data.imageUrl || 'https://images.unsplash.com/photo-1529101091764-c3526daf38fe';
      title.textContent = data.title || (data.code ? ('Kod: '+data.code) : 'â€”');
      sub.textContent = data.subtitle || (g.name==='promos' ? `Chegirma: ${data.discountPercent||0}% | Max: ${data.maxUses||0} | Ishlatilgan: ${data.usedCount||0}` : 'â€”');
      if (g.name==='promos') rating.textContent = (data.active? 'âœ… Faol' : 'â›” Nofaol'); else rating.textContent = `â­ ${Number(data.rating||0).toFixed(1)}`;
      link.textContent = data.link ? 'Havola' : 'â€”'; link.href = data.link || '#';
      el.querySelector('.btn-edit').addEventListener('click', ()=>{
        const fields = g.fields.map(f=> ({...f, value: data[f.key] ?? (f.type==='checkbox'? false: '') }));
        openCrud({ title: g.title + ' tahrirlash', fields, onSave: async(vals)=>{ await updateDoc(doc(db, g.name, data.id), vals); loadGrid(g); await updateExporterByCollection(g.name);} });
      });
      el.querySelector('.btn-delete').addEventListener('click', async()=>{
        if (confirm('O\'chirishni tasdiqlaysizmi?')){ await deleteDoc(doc(db, g.name, data.id)); loadGrid(g); await updateExporterByCollection(g.name);} });
      return el;
    }

    // ===== Users =====
    const usersTbody = document.getElementById('usersTbody');
    const userSearch = document.getElementById('userSearch');
    const btnReloadUsers = document.getElementById('btnReloadUsers');
    btnReloadUsers.addEventListener('click', ()=> loadUsers());
    userSearch.addEventListener('input', ()=> loadUsers(userSearch.value.trim()));

    async function loadUsers(qStr=''){
      usersTbody.innerHTML = '<tr><td class="py-3 text-sm text-gray-500" colspan="8">Yuklanmoqdaâ€¦</td></tr>';
      const snap = await getDocs(query(collection(db,'users'), orderBy('numericId','asc'), limit(100)));
      usersTbody.innerHTML = '';
      snap.forEach(d=>{
        const u = { id:d.id, ...d.data() };
        const needle = qStr.toLowerCase();
        const hay = `${u.numericId||''} ${u.name||''} ${u.email||''}`.toLowerCase();
        if (needle && !hay.includes(needle)) return;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2 pr-3">${u.numericId||'â€”'}</td>
          <td class="py-2 pr-3">${escapeHtml(u.name||'â€”')}</td>
          <td class="py-2 pr-3">${escapeHtml(u.email||'â€”')}</td>
          <td class="py-2 pr-3">${Number(u.balance||0).toFixed(2)}</td>
          <td class="py-2 pr-3">${Number(u.gems||0)}</td>
          <td class="py-2 pr-3">${escapeHtml(u.role||'user')}</td>
          <td class="py-2 pr-3">${escapeHtml(u.status||'active')}</td>
          <td class="py-2 pr-3"><button class="btn btn-secondary btn-edit-user">âœï¸</button></td>`;
        tr.querySelector('.btn-edit-user').addEventListener('click', ()=>{
          openCrud({ title:'Foydalanuvchi tahrirlash', fields:[
            {key:'name', label:'Ism', type:'text', value:u.name||''},
            {key:'balance', label:'Balans', type:'number', value:u.balance||0},
            {key:'gems', label:'Ball (Gems)', type:'number', value:u.gems||0},
            {key:'role', label:'Rol (user/admin)', type:'text', value:u.role||'user'},
            {key:'status', label:'Holat (active/banned)', type:'text', value:u.status||'active'}
          ], onSave: async(vals)=>{ await updateDoc(doc(db,'users',u.id), vals); loadUsers(userSearch.value.trim()); }});
        });
        usersTbody.appendChild(tr);
      });
      if (!usersTbody.children.length){ usersTbody.innerHTML = '<tr><td class="py-3 text-sm text-gray-500" colspan="8">Hech narsa topilmadi</td></tr>'; }
    }

    // ===== CRUD Modal helper =====
    const crudModal = document.getElementById('crudModal');
    const crudTitle = document.getElementById('crudTitle');
    const crudBody = document.getElementById('crudBody');
    const crudSave = document.getElementById('crudSave');
    const crudClose = document.getElementById('crudClose');
    crudClose.addEventListener('click', (e)=>{ e.preventDefault(); crudModal.close(); });

    function openCrud({ title, fields, onSave }){
      crudTitle.textContent = title; crudBody.innerHTML = '';
      fields.forEach(f=>{
        const wrap = document.createElement('div');
        wrap.innerHTML = `<label class="text-sm text-gray-600">${f.label}${f.required? ' *':''}</label>${ inputHtml(f) }`;
        if (f.type==='checkbox') wrap.querySelector('input').checked = !!f.value; else { const inp = wrap.querySelector('input,textarea'); if (inp) inp.value = f.value ?? ''; }
        crudBody.appendChild(wrap);
      });
      crudModal.showModal();
      crudSave.onclick = async (e)=>{
        e.preventDefault();
        const vals = {}; const inputs = crudBody.querySelectorAll('input,textarea');
        for (const el of inputs){ const key = el.name; let v = (el.type==='checkbox') ? el.checked : el.value; if (el.type==='number') v = Number(v); if (el.required && !v){ alert('Majburiy maydon: '+ key); return; } vals[key] = v; }
        try{ await onSave(vals); crudModal.close(); }catch(err){ alert('Saqlashda xatolik: '+ err.message); }
      };
    }
    function inputHtml(f){ const base = `name="${f.key}" class="input" ${f.required? 'required':''}`; if (f.type==='textarea') return `<textarea ${base} rows="3"></textarea>`; if(f.type==='checkbox') return `<input type="checkbox" ${base}>`; const extra = f.step? ` step="${f.step}"` : ''; return `<input type="${f.type||'text'}" ${base}${extra}>`; }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    // ===== Export builders & previews =====
    async function updateAllExporters(){ await updateHomeExporter(); await updateCoursesExporter(); await updateTestsExporter(); await updateSimsExporter(); }

    async function updateExporterByCollection(name){
      if (name==='courses') await updateCoursesExporter();
      if (name==='tests') await updateTestsExporter();
      if (name==='simulators') await updateSimsExporter();
    }

    async function updateHomeExporter(){
      const d = await getDoc(doc(db,'pages','home'));
      const b = d.exists()? (d.data().banner||{}) : {};
      const code = buildHomePartialFrom(b);
      exportHomeEl.value = code;
      previewCode(previewHome, code);
    }

    async function updateCoursesExporter(){
      const code = buildListPartial('courses','Kurslar','â­', 'Reyting', 'Koâ€˜rish');
      document.getElementById('exportCourses').value = code;
      previewCode(document.getElementById('previewCourses'), code);
    }
    async function updateTestsExporter(){
      const code = buildListPartial('tests','Testlar','ğŸ¯', 'Murakkablik', 'Boshlash');
      document.getElementById('exportTests').value = code;
      previewCode(document.getElementById('previewTests'), code);
    }
    async function updateSimsExporter(){
      const code = buildListPartial('simulators','Simulyatorlar','ğŸ§©', 'Foydalilik', 'Ochish');
      document.getElementById('exportSims').value = code;
      previewCode(document.getElementById('previewSims'), code);
    }

    // Buttons for list exporters
    document.getElementById('btnExportCoursesCopy').onclick = ()=> copyText(document.getElementById('exportCourses').value);
    document.getElementById('btnExportCoursesDown').onclick = ()=> downloadText('courses.html', document.getElementById('exportCourses').value);
    document.getElementById('btnExportCoursesPrev').onclick = ()=> previewCode(document.getElementById('previewCourses'), document.getElementById('exportCourses').value);

    document.getElementById('btnExportTestsCopy').onclick = ()=> copyText(document.getElementById('exportTests').value);
    document.getElementById('btnExportTestsDown').onclick = ()=> downloadText('tests.html', document.getElementById('exportTests').value);
    document.getElementById('btnExportTestsPrev').onclick = ()=> previewCode(document.getElementById('previewTests'), document.getElementById('exportTests').value);

    document.getElementById('btnExportSimsCopy').onclick = ()=> copyText(document.getElementById('exportSims').value);
    document.getElementById('btnExportSimsDown').onclick = ()=> downloadText('simulators.html', document.getElementById('exportSims').value);
    document.getElementById('btnExportSimsPrev').onclick = ()=> previewCode(document.getElementById('previewSims'), document.getElementById('exportSims').value);

    // Building partials
    function buildHomePartialFrom(b){
      const title = escapeHtml(b.title || 'Matematika bilan kuchli boâ€˜ling!');
      const subtitle = escapeHtml(b.subtitle || 'Kurslar, testlar va simulyatorlar â€” bitta joyda. Premium dizayn, mobilga mos.');
      const img = escapeHtml(b.imageUrl || 'https://images.unsplash.com/photo-1549221986-3d8b6e8d3c61');
      const link = escapeHtml(b.link || '#');
      const cta = escapeHtml(b.cta || 'Boshlash');
      const tags = Array.isArray(b.tags)? b.tags.join(',') : (b.tags||'Algebra,Geometriya,Olimpiada');
      return `<!-- /partials/home.html â€” generated from Admin -->\n<section id="hero" class="mc-hero" \n  data-title="${title}"\n  data-subtitle="${subtitle}"\n  data-img="${img}"\n  data-link="${link}"\n  data-cta="${cta}"\n  data-tags="${escapeHtml(tags)}">\n  <style>\n    .mc-hero{position:relative;isolation:isolate;min-height:64vh;display:grid;place-items:center;padding:32px 16px}\n    .mc-hero::before{content:\"\";position:absolute;inset:0;background:linear-gradient(160deg,#ecfdf5 0%,#ffffff 40%)}\n    .mc-hero .bg{position:absolute;inset:0;z-index:-2;background-position:center;background-size:cover;filter:saturate(1.05)}\n    .mc-hero .veil{position:absolute;inset:0;z-index:-1;background:radial-gradient(60% 60% at 20% 20%,rgba(16,185,129,.45),transparent 60%),radial-gradient(60% 60% at 80% 80%,rgba(16,185,129,.25),transparent 60%),linear-gradient(180deg,rgba(0,0,0,.25),transparent 35%)}\n    .mc-wrap{max-width:1120px;width:100%;display:grid;grid-template-columns:1.15fr .85fr;gap:24px}\n    .mc-card{backdrop-filter:blur(6px);background:rgba(255,255,255,.8);border:1px solid rgba(226,232,240,.8);border-radius:20px;box-shadow:0 10px 30px rgba(16,185,129,.12);padding:22px}\n    .mc-eyebrow{color:#047857;font-weight:700;font-size:12px;letter-spacing:.02em}\n    .mc-title{font-weight:900;font-size:32px;line-height:1.1;margin:8px 0 0 0;color:#0f172a}\n    .mc-sub{color:#334155;margin:10px 0 0 0;font-size:15px}\n    .mc-tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:14px}\n    .mc-tag{font-size:12px;background:#dcfce7;color:#065f46;border:1px solid #bbf7d0;padding:6px 10px;border-radius:999px}\n    .mc-cta{display:inline-flex;align-items:center;gap:10px;margin-top:16px}\n    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border-radius:14px;border:1px solid #10b981;background:#10b981;color:#fff;text-decoration:none;font-weight:700;box-shadow:0 10px 24px rgba(16,185,129,.25)}\n    .btn:hover{transform:translateY(-1px)}\n    .btn.secondary{background:#fff;color:#065f46;border-color:#a7f3d0}\n    .mc-side{border-radius:22px;overflow:hidden;border:1px solid #e2e8f0;box-shadow:0 10px 24px rgba(2,6,23,.12)}\n    .mc-img{width:100%;height:360px;object-fit:cover;display:block}\n    @media (max-width:980px){.mc-wrap{grid-template-columns:1fr}.mc-img{height:280px}.mc-title{font-size:26px}}\n  </style>\n  <div class="bg"></div>\n  <div class="veil"></div>\n  <div class="mc-wrap">\n    <div class="mc-card">\n      <div class="mc-eyebrow">MathCenter</div>\n      <h1 class="mc-title" id="heroTitle">â€”</h1>\n      <p class="mc-sub" id="heroSub">â€”</p>\n      <div class="mc-tags" id="heroTags"></div>\n      <div class="mc-cta">\n        <a id="heroBtn" class="btn" href="#" target="_blank">Boshlash</a>\n        <a id="heroLink" class="btn secondary" href="#" target="_blank">Batafsil</a>\n      </div>\n    </div>\n    <div class="mc-side">\n      <img id="heroImg" class="mc-img" alt="banner" src="" />\n    </div>\n  </div>\n  <script>\n    (function(){\n      var root=document.currentScript.closest('#hero');\n      var bg=root.querySelector('.bg');\n      var elTitle=root.querySelector('#heroTitle');\n      var elSub=root.querySelector('#heroSub');\n      var elTags=root.querySelector('#heroTags');\n      var elBtn=root.querySelector('#heroBtn');\n      var elLink=root.querySelector('#heroLink');\n      var elImg=root.querySelector('#heroImg');\n      function apply(d){\n        var tags=(d.tags||'').split(',').map(function(s){return s.trim()}).filter(Boolean);\n        elTitle.textContent=d.title; elSub.textContent=d.subtitle; elBtn.textContent=d.cta; elBtn.href=d.link; elLink.href=d.link; elImg.src=d.img; bg.style.backgroundImage=\"url('\"+d.img.replace(/'/g,'%27')+\"')\"; elTags.innerHTML=tags.map(function(t){return '<span class=\\"mc-tag\\">'+t+'</span>'}).join('');\n      }\n      apply({ title: root.dataset.title, subtitle: root.dataset.subtitle, img: root.dataset.img, link: root.dataset.link, cta: root.dataset.cta, tags: root.dataset.tags });\n    })();\n  <\/script>\n</section>`;
    }

    function buildListPartial(coll, heading, icon, labelWord, btnWord){
      return `<!-- /partials/${coll}.html â€” generated from Admin -->\n<section class="max-w-7xl mx-auto px-4 py-8">\n  <div class="flex items-center justify-between">\n    <h2 class="text-2xl font-bold">${heading}</h2>\n    <button id="reload" class="px-3 py-2 rounded-xl border border-gray-200 bg-white shadow">ğŸ”„ Yangilash</button>\n  </div>\n  <div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-5"></div>\n</section>\n<script type="module">\n  import { getFirestore, collection, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';\n  const db = getFirestore();\n  const grid = document.getElementById('grid');\n  document.getElementById('reload').addEventListener('click', load);\n  async function load(){\n    grid.innerHTML = skeletons(6);\n    const snap = await getDocs(query(collection(db,'${coll}'), orderBy('createdAt','desc')));\n    const out = []; snap.forEach(d=>{ const x = Object.assign({id:d.id}, d.data()); out.push(card(x)); });\n    grid.innerHTML = out.join('');\n  }\n  function card(x){\n    const img = x.imageUrl||'https://images.unsplash.com/photo-1523580846011-d3a5bc25702b';\n    const rate = typeof x.rating==='number'? x.rating.toFixed(1): '5.0';\n    const link = x.link||'#';\n    const sub = x.subtitle||'Qisqa tavsif';\n    return \`\n    <article class=\\"rounded-2xl border border-gray-100 bg-white shadow overflow-hidden\\">\n      <img src=\\"\${img}\\" class=\\"w-full h-40 object-cover\\" alt=\\"card\\"/>\n      <div class=\\"p-4\\">\n        <div class=\\"font-semibold line-clamp-1\\">\${escapeHtml(x.title||'')||'â€”'}</div>\n        <p class=\\"text-sm text-gray-600 line-clamp-2 mt-1\\">\${escapeHtml(sub)}</p>\n        <div class=\\"mt-3 flex items-center justify-between\\">\n          <span class=\\"text-xs px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700\\">${icon} ${labelWord}: \${rate}</span>\n          <a href=\\"\${link}\\" target=\\"_blank\\" class=\\"text-emerald-700 underline\\">${btnWord}</a>\n        </div>\n      </div>\n    </article>\n    \`;\n  }\n  function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\\\"":"&quot;","'":"&#39;"}[c])); }\n  function skeletons(n){ return Array.from({length:n}).map(()=>`<div class='animate-pulse h-60 rounded-2xl bg-gray-100'></div>`).join(''); }\n  load();\n<\/script>`;
    }

    // Utils
    function downloadText(filename, text){ const blob = new Blob([text], {type:'text/html;charset=utf-8'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000); }
    async function copyText(text){ try{ await navigator.clipboard.writeText(text); alert('Kod nusxalandi.'); }catch(e){ alert('Nusxalashda xatolik: '+e.message); } }
    function previewCode(iframe, code){ iframe.srcdoc = code; }
  </script>

  <!-- Fallback (non-module) helper: if module didn't bind within 2s, clicking Sign In shows guidance -->
  <script>
    (function(){
      setTimeout(function(){
        try{
          if (window.__authReady) return; // module attached fine
          var btn = document.getElementById('btnSignIn');
          if (!btn) return;
          if (btn.__fallbackBound) return; btn.__fallbackBound = true;
          btn.addEventListener('click', function(){
            alert('Kirish ishlamadi: iltimos adminni HTTP orqali (masalan, http://localhost:5500/admin.html) oching va Firebase Authentication â†’ Authorized domains ga domeningizni qo\'shing. Agar popup bloklansa, redirect avtomatik ishlashi uchun sahifani qayta oching.');
          });
          console.warn('[Fallback] Auth module yuklanmagan. HTTP orqali oching yoki konsolni tekshiring.');
        }catch(e){ /* ignore */ }
      }, 2000);
    })();
  </script>
</body>
</html>
