<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MathCenter Admin — Neo+++</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--brand:#16a34a}
    .glass{backdrop-filter:blur(16px); background:rgba(255,255,255,.78)}
    .btn{@apply px-3 py-2 rounded-xl shadow transition font-medium}
    .btn:hover{transform:translateY(-1px)}
    .btn-primary{@apply bg-green-600 text-white}
    .btn-secondary{@apply bg-white border border-gray-200}
    .btn-ghost{@apply bg-white/0 border border-white/40 text-white}
    .input{@apply w-full rounded-xl border border-gray-200 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-400}
    .card{@apply rounded-3xl shadow-sm border border-gray-100 bg-white}
    .tag{@apply text-xs px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700}
    /* 3D gradient hover */
    .g3d{position:relative; isolation:isolate}
    .g3d::before{content:""; position:absolute; inset:-1px; z-index:-1; border-radius:inherit; background:conic-gradient(from 180deg at 50% 50%, #10b981 0%, #06b6d4 40%, #a78bfa 70%, #10b981 100%); filter:blur(18px); opacity:.35; transition:.35s}
    .g3d:hover::before{opacity:.75; filter:blur(10px)}
    .g3d:hover{transform:translateY(-3px); box-shadow:0 25px 60px rgba(16,185,129,.25)}

    /* Modal FX */
    dialog.neo{border:none; padding:0; border-radius:22px; overflow:hidden; box-shadow:0 30px 80px rgba(2,6,23,.25)}
    dialog.neo[open]{animation:pop .18s ease-out}
    @keyframes pop{from{transform:translateY(6px) scale(.98); opacity:0} to{transform:none; opacity:1}}
    dialog::backdrop{background:linear-gradient(45deg, rgba(16,185,129,.32), rgba(6,182,212,.32)); backdrop-filter:blur(2px)}

    .badge{ @apply absolute top-2 right-2 text-[10px] font-bold px-2 py-1 rounded-full shadow; }
    .badge-free{ @apply bg-emerald-600 text-white; }
    .badge-pro{ @apply bg-amber-500 text-white; }

    /* HERO button — stronger design */
    .btn-hero{display:inline-flex; align-items:center; gap:.6rem; padding:.9rem 1.1rem; border-radius:16px; font-weight:800; letter-spacing:.01em; box-shadow:0 12px 30px rgba(16,185,129,.35); transform:translateZ(0); transition:.2s ease}
    .btn-hero .ic{display:inline-grid; place-items:center; width:1.8rem; height:1.8rem; border-radius:12px; background:rgba(255,255,255,.15)}
    .btn-hero:hover{transform:translateY(-2px)}
    .btn-hero.white{background:#fff; color:#065f46; border:1px solid #fff}
    .btn-hero.green{background:#10b981; color:#fff; border:1px solid #10b981}
    .btn-hero.outline{background:transparent; color:#fff; border:1px solid rgba(255,255,255,.8); box-shadow:0 10px 28px rgba(0,0,0,.25)}
    .btn-hero.grad{background:linear-gradient(135deg,#10b981,#06b6d4); color:#fff; border:0}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-emerald-50 via-white to-sky-50 text-gray-900">
  <!-- LOGIN SCREEN (Modern) -->
  <section id="loginPane" class="min-h-screen grid place-items-center px-4">
    <div class="relative w-full max-w-md">
      <div class="absolute -inset-1 rounded-3xl bg-gradient-to-r from-emerald-400 to-sky-400 blur"></div>
      <div class="relative glass rounded-3xl p-6 border border-white/60 shadow-xl">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-emerald-500 to-emerald-600 grid place-items-center text-white text-2xl font-black">π</div>
          <div>
            <h1 class="text-xl font-bold">MathCenter Admin</h1>
            <p class="text-xs text-gray-600">Xavfsiz kirish</p>
          </div>
        </div>
        <form class="mt-5 space-y-3" onsubmit="return false;">
          <div>
            <label class="text-sm text-gray-600">Login</label>
            <div class="relative">
              <input id="inpLogin" class="input pr-10" autocomplete="username" placeholder="Login"/>
              <span class="absolute inset-y-0 right-3 grid place-items-center text-gray-400">👤</span>
            </div>
          </div>
          <div>
            <label class="text-sm text-gray-600">Parol</label>
            <div class="relative">
              <input id="inpPass" type="password" class="input pr-10" autocomplete="current-password" placeholder="Parol"/>
              <button id="btnEye" type="button" class="absolute inset-y-0 right-0 px-3 text-gray-500">👁️</button>
            </div>
          </div>
          <button id="btnLogin" type="button" class="btn btn-primary w-full">Kirish</button>
          <div class="text-[11px] text-gray-500 leading-snug">
            Promo va foydalanuvchilar Firestore orqali boshqariladi; qolganlari qurilmangizda lokal saqlanadi.
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- APP SHELL -->
  <header id="topbar" class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-gray-100 hidden">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-2">
        <div class="w-9 h-9 rounded-2xl bg-gradient-to-br from-emerald-500 to-emerald-600 grid place-items-center text-white text-xl font-black">π</div>
        <div>
          <div class="text-sm font-semibold">MathCenter Admin — Neo+++</div>
          <div class="text-xs text-gray-500">Boshqaruv paneli</div>
        </div>
      </div>
      <nav class="ml-6 hidden md:flex gap-1">
        <button data-tab="tab-home" class="tab btn btn-secondary">🏠 Bannerlar</button>
        <button data-tab="tab-courses" class="tab btn btn-secondary">📚 Kurslar</button>
        <button data-tab="tab-tests" class="tab btn btn-secondary">📝 Testlar</button>
        <button data-tab="tab-sims" class="tab btn btn-secondary">🧪 Simulyatorlar</button>
        <button data-tab="tab-promos" class="tab btn btn-secondary">🏷️ Promolar</button>
        <button data-tab="tab-users" class="tab btn btn-secondary">👥 Foydalanuvchilar</button>
      </nav>
      <div class="ml-auto flex items-center gap-2">
        <span id="whoami" class="text-sm text-gray-600"></span>
        <button id="btnLogout" type="button" class="btn btn-secondary">Chiqish</button>
      </div>
    </div>
  </header>

  <main id="adminUi" class="max-w-7xl mx-auto px-4 py-6 hidden">
    <!-- HOME / BANNERS -->
    <section id="tab-home" class="tab-pane">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Katta reklama bannerlari</h2>
        <div class="flex gap-2">
          <button id="btnAddBanner" class="btn btn-primary">➕ Yangi banner</button>
          <button id="btnDownloadHome" class="btn btn-secondary">💾 home.html</button>
        </div>
      </div>
      <div id="bannersWrap" class="grid lg:grid-cols-2 gap-6"></div>

      <!-- Live Hero Preview (no 'Batafsil') -->
      <div class="mt-8">
        <h3 class="text-lg font-semibold">Jonli preview</h3>
        <div class="relative mt-3 rounded-3xl overflow-hidden border shadow g3d">
          <div class="absolute inset-0 z-0 bg-[url('https://images.unsplash.com/photo-1549221986-3d8b6e8d3c61')] bg-cover bg-center" id="heroBg"></div>
          <div class="absolute inset-0 z-[1]" id="heroOverlay"></div>
          <div class="relative z-[2] p-8 md:p-12 lg:p-16 text-white grid lg:grid-cols-2 gap-8 min-h-[420px]">
            <div id="heroTextBox" class="flex flex-col items-start">
              <div class="text-emerald-200 text-[11px] font-black tracking-widest uppercase">MathCenter</div>
              <h1 id="heroTitle" class="text-4xl md:text-5xl font-black leading-tight mt-2">Sarlavha</h1>
              <p id="heroSub" class="text-white/90 mt-3 max-w-xl text-[15px]">Qisqa tavsif matni…</p>
              <div id="heroTags" class="flex flex-wrap gap-2 mt-3"></div>
              <div class="mt-5 flex gap-3">
                <a id="heroBtn" class="btn-hero white" target="_blank"><span class="lbl">Boshlash</span><span class="ic">➔</span></a>
              </div>
            </div>
            <div class="hidden lg:block"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- COURSES -->
    <section id="tab-courses" class="tab-pane hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Kurslar</h2>
        <button id="addCourse" class="btn btn-primary">➕ Kurs qo‘shish</button>
      </div>
      <div id="coursesGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <!-- TESTS -->
    <section id="tab-tests" class="tab-pane hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Testlar</h2>
        <button id="addTest" class="btn btn-primary">➕ Test qo‘shish</button>
      </div>
      <!-- Filters: up to 3 tags -->
      <div class="flex flex-wrap gap-2 mb-4" id="testFilters"></div>
      <div id="testsGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <!-- SIMULATORS -->
    <section id="tab-sims" class="tab-pane hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Simulyatorlar</h2>
        <button id="addSimulator" class="btn btn-primary">➕ Simulyator qo‘shish</button>
      </div>
      <div id="simsGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <!-- PROMOS (Firestore) -->
    <section id="tab-promos" class="tab-pane hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Promo kodlar</h2>
        <button id="addPromo" class="btn btn-primary">➕ Promo kod</button>
      </div>
      <div id="promosGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>

    <!-- USERS (Firestore) -->
    <section id="tab-users" class="tab-pane hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Foydalanuvchilar</h2>
        <div class="flex gap-2">
          <input id="userSearch" class="input w-64" placeholder="Qidirish (ism/email/id)" />
          <button id="btnReloadUsers" class="btn btn-secondary">🔄 Yangilash</button>
        </div>
      </div>
      <div class="overflow-x-auto card">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="text-left text-gray-500">
              <th class="py-2 px-3">ID</th>
              <th class="py-2 px-3">Ism</th>
              <th class="py-2 px-3">Email</th>
              <th class="py-2 px-3">Balans</th>
              <th class="py-2 px-3">Ball (Gems)</th>
              <th class="py-2 px-3">Rol</th>
              <th class="py-2 px-3">Holat</th>
              <th class="py-2 px-3">Amal</th>
            </tr>
          </thead>
          <tbody id="usersTbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- MODAL (upgraded) -->
  <dialog id="crudModal" class="neo w-[95vw] max-w-3xl">
    <form method="dialog" class="glass p-0">
      <div class="px-5 py-4 border-b bg-gradient-to-r from-emerald-500/10 to-sky-500/10">
        <h3 id="crudTitle" class="text-lg font-semibold">Tahrirlash</h3>
        <p id="crudSubtitle" class="text-xs text-gray-500">Maydonlarni to‘ldiring</p>
      </div>
      <div class="p-5 grid md:grid-cols-2 gap-4" id="crudBody"></div>
      <div class="flex items-center justify-between gap-2 px-5 py-3 border-t">
        <div class="text-xs text-gray-500">Design+ • Neo modal</div>
        <div class="flex gap-2">
          <button class="btn btn-secondary" id="crudCancel" type="button">Bekor</button>
          <button id="crudSave" class="btn btn-primary" type="button">Saqlash</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- Templates -->
  <template id="bannerCardTpl">
    <article class="relative rounded-3xl overflow-hidden border shadow g3d">
      <img class="w-full h-56 object-cover banner-img" />
      <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent"></div>
      <div class="absolute bottom-0 p-4 text-white">
        <div class="text-xs text-emerald-200 font-bold">Banner</div>
        <div class="text-lg font-semibold title">—</div>
        <div class="text-sm opacity-90 subtitle">—</div>
        <div class="mt-2 flex flex-wrap gap-2 tags"></div>
        <div class="mt-3 flex gap-2">
          <a class="btn bg-white text-emerald-700 border border-white/60 link" target="_blank">Boshlash</a>
          <button class="btn btn-secondary edit" type="button">✏️</button>
          <button class="btn btn-secondary del" type="button">🗑️</button>
        </div>
      </div>
    </article>
  </template>

  <template id="gridCardTpl">
    <div class="card overflow-hidden relative g3d group">
      <span class="badge badge-free hidden">FREE</span>
      <span class="badge badge-pro hidden">PRO</span>
      <img class="w-full h-40 object-cover"/>
      <div class="p-4">
        <div class="font-semibold title line-clamp-1">—</div>
        <div class="text-xs text-gray-500 subtitle line-clamp-2">—</div>
        <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
          <a class="btn btn-secondary startLink" target="_blank">Boshlash</a>
          <div class="text-right font-semibold price">—</div>
        </div>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-secondary btn-edit" type="button">✏️</button>
          <button class="btn btn-secondary btn-delete" type="button">🗑️</button>
        </div>
      </div>
    </div>
  </template>

  <template id="testCardTpl">
    <div class="card overflow-hidden relative g3d">
      <span class="badge badge-free hidden">FREE</span>
      <span class="badge badge-pro hidden">PRO</span>
      <img class="w-full h-36 object-cover test-img hidden"/>
      <div class="p-4">
        <div class="flex items-center justify-between">
          <div class="font-semibold title line-clamp-1">Test</div>
          <span class="text-xs px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 type">Oddiy</span>
        </div>
        <p class="text-xs text-gray-500 mt-1 subtitle">—</p>
        <div class="mt-2 text-xs text-gray-600 schedule">—</div>
        <div class="mt-3 grid grid-cols-2 gap-2 text-sm">
          <button class="btn btn-secondary openBtn" type="button">Boshlash</button>
          <div class="flex gap-2 justify-end">
            <button class="btn btn-secondary infoBtn hidden" type="button">ℹ️ Info</button>
            <a class="btn btn-secondary link" target="_blank">Havola</a>
          </div>
        </div>
        <div class="mt-3 flex gap-2">
          <button class="btn btn-secondary btn-edit" type="button">✏️</button>
          <button class="btn btn-secondary btn-delete" type="button">🗑️</button>
        </div>
      </div>
    </div>
  </template>

  <script type="module">
    // ===== Login (offline) =====
    const VALID_LOGIN='Sohibjonmath';
    const VALID_PASS='Math@1999';
    const LS_AUTH='mc_auth5';

    const loginPane=document.getElementById('loginPane');
    const adminUi=document.getElementById('adminUi');
    const topbar=document.getElementById('topbar');
    const whoami=document.getElementById('whoami');

    document.getElementById('btnEye').onclick=()=>{
      const p=document.getElementById('inpPass');
      p.type=p.type==='password'?'text':'password';
    };

    document.getElementById('btnLogin').onclick=()=>{
      const u=document.getElementById('inpLogin').value.trim();
      const p=document.getElementById('inpPass').value;
      if(u===VALID_LOGIN && p===VALID_PASS){ localStorage.setItem(LS_AUTH,'1'); applyAuth(); }
      else alert('Login yoki parol noto‘g‘ri.');
    };
    document.getElementById('btnLogout').onclick=()=>{ localStorage.removeItem(LS_AUTH); applyAuth(); };

    function applyAuth(){
      const ok=localStorage.getItem(LS_AUTH)==='1';
      loginPane.classList.toggle('hidden',ok);
      adminUi.classList.toggle('hidden',!ok);
      topbar.classList.toggle('hidden',!ok);
      whoami.textContent=ok?'Admin':'';
      if(ok) initOnce();
    }

    // ===== Local data layer (except promos/users) =====
    const LS={ banners:'neo4_banners', courses:'neo4_courses', tests:'neo4_tests', sims:'neo4_sims' };
    const get=(k,d)=>{ try{ return JSON.parse(localStorage.getItem(k))??d; }catch{return d;} };
    const set=(k,v)=> localStorage.setItem(k,JSON.stringify(v));

    // ===== Utils =====
    function esc(s){return String(s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;","\"":"&quot;","'":"&#39;","\">":"&gt;"}[c]));}
    function downloadText(filename, text){ const blob=new Blob([text],{type:'text/html;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href), 1000); }
    function safeBind(id, fn){ const el=document.getElementById(id); if(el) el.addEventListener('click', fn); }

    // ===== Tabs =====
    document.querySelectorAll('.tab').forEach(b=> b.addEventListener('click', ()=> selectTab(b.dataset.tab)));
    function selectTab(id){
      document.querySelectorAll('.tab-pane').forEach(p=>p.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('!bg-emerald-600','!text-white'));
      document.querySelector(`[data-tab="${id}"]`).classList.add('!bg-emerald-600','!text-white');
    }

    // ===== CRUD modal =====
    const crudModal=document.getElementById('crudModal');
    const crudTitle=document.getElementById('crudTitle');
    const crudSubtitle=document.getElementById('crudSubtitle');
    const crudBody=document.getElementById('crudBody');
    const crudSave=document.getElementById('crudSave');
    const crudCancel=document.getElementById('crudCancel');
    const crudClose=document.getElementById('crudClose');
    crudCancel.onclick=crudClose.onclick=()=>crudModal.close();

    function openCrud({title,subtitle='Maydonlarni to‘ldiring',fields,onSave}){
      crudTitle.textContent=title; crudSubtitle.textContent=subtitle; crudBody.innerHTML='';
      fields.forEach(f=>{
        const wrap=document.createElement('div');
        wrap.innerHTML=`<label class="text-sm text-gray-600">${f.label}${f.required?' *':''}</label>${inputHtml(f)}`;
        if(f.type==='checkbox') wrap.querySelector('input').checked=!!f.value; else { const inp=wrap.querySelector('input,textarea,select'); if(inp){ if(f.type==='range' && f.value!=null) inp.value=f.value; else inp.value=f.value ?? ''; } }
        crudBody.appendChild(wrap);
      });
      crudModal.showModal();
      crudSave.onclick=()=>{
        const vals={}; const inputs=crudBody.querySelectorAll('input,textarea,select');
        for(const el of inputs){ const key=el.name; let v=(el.type==='checkbox')?el.checked:el.value; if(el.type==='number') v=Number(v); if(el.required && !v){ alert('Majburiy maydon: '+key); return; } vals[key]=v; }
        onSave(vals).then(()=>crudModal.close()).catch(e=>alert('Xatolik: '+e.message));
      };
    }
    function inputHtml(f){
      if(f.type==='select') return `<select name="${f.key}" class="input">${(f.options||[]).map(o=>`<option value="${o}">${o}</option>`).join('')}</select>`;
      if(f.type==='range') return `<input type="range" name="${f.key}" class="w-full" min="${f.min||0}" max="${f.max||1}" step="${f.step||0.05}" value="${f.value??0.55}">`;
      const base=`name="${f.key}" class="input" ${f.required?'required':''}`;
      if(f.type==='textarea') return `<textarea ${base} rows="3"></textarea>`;
      if(f.type==='checkbox') return `<input type="checkbox" ${base}>`;
      const extra=f.step?` step="${f.step}"`:''; const val=f.value!=null?` value="${f.value}"`:''; return `<input type="${f.type||'text'}" ${base}${extra}${val}>`;
    }

    // ===== BANNERS =====
    const bannersWrap=document.getElementById('bannersWrap');
    const heroOverlay=document.getElementById('heroOverlay');
    const heroTextBox=document.getElementById('heroTextBox');

    // Robust delegate (fix for button not firing even if earlier error occurred)
    document.addEventListener('click', (e)=>{
      if(e.target.closest('#btnAddBanner')) return addBannerFlow();
      if(e.target.closest('#btnDownloadHome')) return downloadHomeFlow();
    });

    function addBannerFlow(){
      openCrud({
        title:'Yangi banner', subtitle:'Dizayn parametrlarini tanlang',
        fields:[
          {key:'imageUrl',label:'Fon rasm URL',type:'url',required:true},
          {key:'title',label:'Sarlavha',type:'text',required:true},
          {key:'subtitle',label:'Qisqa matn',type:'textarea'},
          {key:'cta',label:'Tugma matni',type:'text',value:'Boshlash'},
          {key:'link',label:'Tugma havolasi',type:'url'},
          {key:'tags',label:'Meta teglar (vergul bilan)',type:'text',value:'Algebra, Geometriya'},
          {key:'align',label:'Matn hizalash',type:'select',options:['chap','markaz','o‘ng'],value:'chap'},
          {key:'titleFont',label:'Title shrift',type:'select',options:['system','serif','display'],value:'display'},
          {key:'subtitleFont',label:'Subtitle shrift',type:'select',options:['system','serif','display'],value:'system'},
          {key:'btnStyle',label:'Tugma uslubi',type:'select',options:['oq-solid','yashil-solid','oq-outline','gradient'],value:'oq-solid'},
          {key:'overlay',label:'Qoplama kuchi (0–1)',type:'range',min:0,max:1,step:0.05,value:.55}
        ],
        onSave: async(v)=>{ const arr=get(LS.banners,[]); v.tags=String(v.tags||'').split(',').map(s=>s.trim()).filter(Boolean); arr.unshift(v); set(LS.banners,arr); renderBanners(); applyHero(arr[0]); }
      });
    }

    function downloadHomeFlow(){
      const b=(get(LS.banners,[])[0])||null; if(!b){ alert('Avval biror banner yarating.'); return; }
      const code=buildHomePartialFrom(b); downloadText('home.html', code);
    }

    function renderBanners(){
      const arr=get(LS.banners,[]); bannersWrap.innerHTML='';
      arr.forEach((b,idx)=> bannersWrap.appendChild(bannerEl(b,idx)));
      if(arr[0]) applyHero(arr[0]);
    }
    function bannerEl(b,idx){
      const tpl=document.getElementById('bannerCardTpl').content.cloneNode(true);
      tpl.querySelector('.banner-img').src=b.imageUrl;
      tpl.querySelector('.title').textContent=b.title||'—';
      tpl.querySelector('.subtitle').textContent=b.subtitle||'—';
      tpl.querySelector('.link').href=b.link||'#';
      const tagsWrap=tpl.querySelector('.tags'); tagsWrap.innerHTML=(b.tags||[]).map(t=>`<span class="tag">${esc(t)}</span>`).join('');
      tpl.querySelector('.edit').onclick=()=>{
        openCrud({title:'Banner tahrirlash', subtitle:'Dizayn parametrlarini yangilang', fields:[
          {key:'imageUrl',label:'Fon rasm URL',type:'url',required:true,value:b.imageUrl||''},
          {key:'title',label:'Sarlavha',type:'text',required:true,value:b.title||''},
          {key:'subtitle',label:'Qisqa matn',type:'textarea',value:b.subtitle||''},
          {key:'cta',label:'Tugma matni',type:'text',value:b.cta||'Boshlash'},
          {key:'link',label:'Tugma havolasi',type:'url',value:b.link||''},
          {key:'tags',label:'Meta teglar (vergul bilan)',type:'text',value:(b.tags||[]).join(', ')},
          {key:'align',label:'Matn hizalash',type:'select',options:['chap','markaz','o‘ng'],value:b.align||'chap'},
          {key:'titleFont',label:'Title shrift',type:'select',options:['system','serif','display'],value:b.titleFont||'display'},
          {key:'subtitleFont',label:'Subtitle shrift',type:'select',options:['system','serif','display'],value:b.subtitleFont||'system'},
          {key:'btnStyle',label:'Tugma uslubi',type:'select',options:['oq-solid','yashil-solid','oq-outline','gradient'],value:b.btnStyle||'oq-solid'},
          {key:'overlay',label:'Qoplama kuchi (0–1)',type:'range',min:0,max:1,step:0.05,value:b.overlay??.55}
        ], onSave: async(v)=>{ v.tags=String(v.tags||'').split(',').map(s=>s.trim()).filter(Boolean); const arr=get(LS.banners,[]); arr[idx]={...arr[idx],...v}; set(LS.banners,arr); renderBanners(); applyHero(arr[idx]); }});
      };
      tpl.querySelector('.del').onclick=()=>{ if(!confirm('O‘chirishni tasdiqlaysizmi?')) return; const arr=get(LS.banners,[]); arr.splice(idx,1); set(LS.banners,arr); renderBanners(); };
      return tpl;
    }

    function fontClass(kind){ if(kind==='serif') return 'font-serif'; if(kind==='display') return 'tracking-tight'; return 'font-sans'; }
    function applyHero(b){
      document.getElementById('heroBg').style.backgroundImage=`url('${(b.imageUrl||'').replace(/'/g,'%27')}')`;
      const ov = Math.max(0, Math.min(1, Number(b.overlay ?? .55)));
      heroOverlay.style.background = `linear-gradient(120deg, rgba(0,0,0,${ov+0.25}) 0%, rgba(0,0,0,${ov}) 35%, rgba(0,0,0,0) 100%)`;
      const box=heroTextBox; box.classList.remove('items-start','items-center','items-end','text-left','text-center','text-right');
      if((b.align||'chap')==='chap'){ box.classList.add('items-start','text-left'); }
      else if(b.align==='markaz'){ box.classList.add('items-center','text-center'); }
      else { box.classList.add('items-end','text-right'); }
      const t=document.getElementById('heroTitle'); const s=document.getElementById('heroSub');
      t.textContent=b.title||'—'; s.textContent=b.subtitle||'—';
      t.className = `text-4xl md:text-5xl font-black leading-tight mt-2 ${fontClass(b.titleFont||'display')}`;
      s.className = `text-white/90 mt-3 max-w-xl text-[15px] ${fontClass(b.subtitleFont||'system')}`;
      const btn=document.getElementById('heroBtn'); btn.querySelector('.lbl').textContent=b.cta||'Boshlash'; btn.href=b.link||'#';
      // HERO button variant
      btn.className='btn-hero';
      const st=b.btnStyle||'oq-solid';
      if(st==='yashil-solid') btn.classList.add('green');
      else if(st==='oq-outline') btn.classList.add('outline');
      else if(st==='gradient') btn.classList.add('grad');
      else btn.classList.add('white');
      const tags=(b.tags||[]).map(t=>`<span class="tag">${esc(t)}</span>`).join('');
      document.getElementById('heroTags').innerHTML=tags;
    }

    function buildHomePartialFrom(b){
      const align = b.align||'chap';
      const tFont = b.titleFont||'display';
      const sFont = b.subtitleFont||'system';
      const btnStyle = b.btnStyle||'oq-solid';
      const ov = Math.max(0, Math.min(1, Number(b.overlay ?? .55)));
      const tags = (b.tags||[]).join(',');
      return `<!-- /partials/home.html — generated by Admin Neo+++ -->
<section id="hero" data-img="${esc(b.imageUrl||'')}" data-title="${esc(b.title||'')}" data-subtitle="${esc(b.subtitle||'')}" data-cta="${esc(b.cta||'Boshlash')}" data-link="${esc(b.link||'#')}" data-tags="${esc(tags)}" data-align="${esc(align)}" data-title-font="${esc(tFont)}" data-sub-font="${esc(sFont)}" data-btn-style="${esc(btnStyle)}" data-overlay="${ov}">
  <style>
    #hero{position:relative;min-height:68vh;display:grid;place-items:center;padding:40px 16px;isolation:isolate}
    #hero .bg{position:absolute;inset:0;background-size:cover;background-position:center;z-index:-2}
    #hero .ov{position:absolute;inset:0;z-index:-1}
    #hero .box{max-width:1120px;width:100%;display:grid;grid-template-columns:1.1fr .9fr;gap:24px;color:#fff}
    #hero .title{font-weight:900;font-size:40px;line-height:1.05;margin:8px 0 0 0}
    #hero .sub{opacity:.92;margin-top:12px;max-width:720px}
    #hero .tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    #hero .tag{font-size:12px;background:#dcfce7;color:#065f46;border:1px solid #bbf7d0;padding:6px 10px;border-radius:999px}
    #hero .btn{display:inline-flex;align-items:center;gap:10px;padding:14px 16px;border-radius:16px;text-decoration:none;font-weight:800}
    #hero .ic{display:inline-grid;place-items:center;width:28px;height:28px;border-radius:12px;background:rgba(255,255,255,.15)}
    @media (max-width:980px){#hero .box{grid-template-columns:1fr} #hero .title{font-size:32px}}
  </style>
  <div class="bg"></div>
  <div class="ov"></div>
  <div class="box">
    <div class="txt">
      <div class="eyebrow" style="color:#bbf7d0;font-weight:900;letter-spacing:.2em;font-size:11px;text-transform:uppercase">MathCenter</div>
      <h1 class="title"></h1>
      <p class="sub"></p>
      <div class="tags"></div>
      <div class="cta" style="margin-top:16px"><a class="btn"><span class="lbl"></span><span class="ic">➔</span></a></div>
    </div>
    <div></div>
  </div>
  <script>(function(){
    var root=document.currentScript.closest('#hero');
    var data=root.dataset;
    var bg=root.querySelector('.bg'); var ov=root.querySelector('.ov');
    var titleEl=root.querySelector('.title'); var subEl=root.querySelector('.sub'); var tagsEl=root.querySelector('.tags'); var btn=root.querySelector('.btn'); var box=root.querySelector('.txt');
    bg.style.backgroundImage=\"url('\"+data.img.replace(/'/g,'%27')+\"')\";
    var o=Number(data.overlay||0.55); ov.style.background='linear-gradient(120deg, rgba(0,0,0,'+(o+0.25)+') 0%, rgba(0,0,0,'+o+') 35%, rgba(0,0,0,0) 100%)';
    titleEl.textContent=data.title||''; subEl.textContent=data.subtitle||'';
    var a=(data.align||'chap'); box.style.textAlign=(a==='chap'?'left':(a==='markaz'?'center':'right'));
    var ff=function(kind){ if(kind==='serif') return 'Georgia, Cambria, Times New Roman, serif'; if(kind==='display') return 'Poppins, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif'; return 'Inter, Roboto, Segoe UI, system-ui, Arial, sans-serif'; }
    titleEl.style.fontFamily=ff(data.titleFont||'display'); subEl.style.fontFamily=ff(data.subFont||'system');
    var lbl=btn.querySelector('.lbl'); lbl.textContent=data.cta||'Boshlash'; btn.href=data.link||'#';
    // styles
    if(data.btnStyle==='yashil-solid'){ btn.style.cssText='background:#10b981;color:#fff;border:1px solid #10b981'; }
    else if(data.btnStyle==='oq-outline'){ btn.style.cssText='background:transparent;color:#fff;border:1px solid rgba(255,255,255,.7)'; }
    else if(data.btnStyle==='gradient'){ btn.style.cssText='background:linear-gradient(135deg,#10b981,#06b6d4);color:#fff;border:0'; }
    else { btn.style.cssText='background:#fff;color:#065f46;border:1px solid #fff'; }
    var tags=(data.tags||'').split(',').map(function(s){return s.trim()}).filter(Boolean);
    tagsEl.innerHTML=tags.map(function(t){return '<span class=\"tag\">'+t+'</span>'}).join('');
  })();<\/script>
</section>`;
    }

    // ===== COURSES & SIMS =====
    const catalog={
      courses:{ grid:'coursesGrid', title:'Kurs', ls:LS.courses, btn:'Boshlash' },
      sims:{ grid:'simsGrid', title:'Simulyator', ls:LS.sims, btn:'O‘ynash' }
    };
    document.getElementById('addCourse').onclick=()=> addItem('courses');
    document.getElementById('addSimulator').onclick=()=> addItem('sims');

    function addItem(kind){
      const cfg=catalog[kind];
      openCrud({ title:cfg.title+' qo‘shish', subtitle:'Karta maʼlumotlari', fields:[
        {key:'imageUrl',label:'Rasm URL',type:'url',required:true},
        {key:'title',label:'Nomi',type:'text',required:true},
        {key:'subtitle',label:'Info',type:'textarea'},
        {key:'link',label:'Tugma havolasi',type:'url'},
        {key:'price',label:'Narx (UZS)',type:'number',value:0},
        {key:'rating',label:'Reyting (0-5)',type:'number',step:'0.1',value:5}
      ], onSave: async(v)=>{ const arr=get(cfg.ls,[]); arr.unshift(v); set(cfg.ls,arr); renderGrid(kind); }});
    }
    function editItem(kind,idx){
      const cfg=catalog[kind]; const arr=get(cfg.ls,[]); const x=arr[idx];
      openCrud({ title:cfg.title+' tahrirlash', subtitle:'Kartani yangilang', fields:[
        {key:'imageUrl',label:'Rasm URL',type:'url',required:true,value:x.imageUrl||''},
        {key:'title',label:'Nomi',type:'text',required:true,value:x.title||''},
        {key:'subtitle',label:'Info',type:'textarea',value:x.subtitle||''},
        {key:'link',label:'Tugma havolasi',type:'url',value:x.link||''},
        {key:'price',label:'Narx (UZS)',type:'number',value:x.price||0},
        {key:'rating',label:'Reyting (0-5)',type:'number',step:'0.1',value:x.rating??5}
      ], onSave: async(v)=>{ arr[idx]={...x,...v}; set(cfg.ls,arr); renderGrid(kind); }});
    }
    function renderGrid(kind){
      const cfg=catalog[kind]; const wrap=document.getElementById(cfg.grid); wrap.innerHTML='';
      const arr=get(cfg.ls,[]);
      arr.forEach((data,idx)=>{
        const tpl=document.getElementById('gridCardTpl').content.cloneNode(true);
        const free=Number(data.price||0)===0; tpl.querySelector('.badge-free').classList.toggle('hidden',!free); tpl.querySelector('.badge-pro').classList.toggle('hidden',free);
        tpl.querySelector('img').src=data.imageUrl||'';
        tpl.querySelector('.title').textContent=data.title||'—';
        tpl.querySelector('.subtitle').textContent=data.subtitle||'—';
        tpl.querySelector('.startLink').textContent=cfg.btn; tpl.querySelector('.startLink').href=data.link||'#';
        tpl.querySelector('.price').textContent=(data.price? new Intl.NumberFormat('uz-UZ').format(data.price)+' so‘m':'Bepul');
        tpl.querySelector('.btn-edit').onclick=()=> editItem(kind,idx);
        tpl.querySelector('.btn-delete').onclick=()=>{ if(!confirm('O‘chirishni tasdiqlaysizmi?')) return; const a=get(cfg.ls,[]); a.splice(idx,1); set(cfg.ls,a); renderGrid(kind); };
        wrap.appendChild(tpl);
      });
    }

    // ===== TESTS (Oddiy/Online) =====
    const testLS=LS.tests;
    document.getElementById('addTest').onclick=()=>{
      openCrud({ title:'Yangi test', subtitle:'Oddiy yoki Online turini tanlang', fields:[
        {key:'type',label:'Turi',type:'select',options:['Oddiy','Online'],value:'Oddiy'},
        {key:'title',label:'Sarlavha',type:'text',required:true},
        {key:'subtitle',label:'Qisqa info',type:'textarea'},
        {key:'price',label:'Narx (UZS)',type:'number',value:0},
        {key:'imageUrl',label:'Rasm (Oddiy uchun)',type:'url'},
        {key:'link',label:'Havola',type:'url'},
        {key:'startAt',label:'Boshlash (Online)',type:'text'},
        {key:'endAt',label:'Tugash (Online)',type:'text'},
        {key:'infoText',label:'Info matni (Online info tugmasi uchun)',type:'textarea'},
        {key:'tags',label:'Teglar (filter, vergul bilan)',type:'text',value:'Algebra,Geometriya'}
      ], onSave: async(v)=>{ v.tags=String(v.tags||'').split(',').map(s=>s.trim()).filter(Boolean); const arr=get(testLS,[]); arr.unshift(v); set(testLS,arr); renderTests(); }});
    };

    const testsGrid=document.getElementById('testsGrid');
    const testFilters=document.getElementById('testFilters');
    let activeTags=new Set();

    function renderTests(){
      const arr=get(testLS,[]);
      const allTags=[...new Set(arr.flatMap(x=>x.tags||[]))].slice(0,12);
      testFilters.innerHTML=allTags.map(t=>`<button data-t="${esc(t)}" class="px-3 py-1 rounded-full border ${activeTags.has(t)?'bg-emerald-600 text-white border-emerald-600':'bg-white'} text-sm">${esc(t)}</button>`).join('');
      testFilters.querySelectorAll('button').forEach(b=> b.onclick=()=>{ const t=b.dataset.t; if(activeTags.has(t)) activeTags.delete(t); else { if(activeTags.size>=3){ alert('Maksimum 3 ta filter.'); return;} activeTags.add(t);} renderTests(); });

      const list=arr.filter(x=> activeTags.size? (x.tags||[]).some(t=>activeTags.has(t)) : true);
      testsGrid.innerHTML='';
      list.forEach((x,idx)=> testsGrid.appendChild(testCard(x,idx)));
    }

    function testCard(x,idx){
      const tpl=document.getElementById('testCardTpl').content.cloneNode(true);
      const free=Number(x.price||0)===0; tpl.querySelector('.badge-free').classList.toggle('hidden',!free); tpl.querySelector('.badge-pro').classList.toggle('hidden',free);
      const typeStr=(x.type||'Oddiy');
      tpl.querySelector('.type').textContent= typeStr;
      tpl.querySelector('.title').textContent=x.title||'—';
      tpl.querySelector('.subtitle').textContent=x.subtitle||'—';
      const img=tpl.querySelector('.test-img'); if(typeStr==='Oddiy' && x.imageUrl){ img.src=x.imageUrl; img.classList.remove('hidden'); }
      const linkEl=tpl.querySelector('.link'); linkEl.href=x.link||'#';
      const openBtn=tpl.querySelector('.openBtn');
      const schedule=tpl.querySelector('.schedule');
      const infoBtn=tpl.querySelector('.infoBtn');

      if(typeStr==='Online'){
        infoBtn.classList.remove('hidden');
        infoBtn.onclick=()=> showInfoModal(x.title||'Info', x.infoText||'');
        const now=new Date();
        const s=x.startAt? new Date(x.startAt): null; const e=x.endAt? new Date(x.endAt): null;
        let msg='—'; let enabled=false;
        if(s&&e){ msg=`${s.toLocaleString()} — ${e.toLocaleString()}`; enabled= now>=s && now<=e; }
        else if(s){ msg=`Boshlanish: ${s.toLocaleString()}`; enabled= now>=s; }
        else if(e){ msg=`Tugash: ${e.toLocaleString()}`; enabled= now<=e; }
        schedule.textContent=msg;
        openBtn.disabled=!enabled; openBtn.classList.toggle('opacity-50',!enabled);
        openBtn.onclick=()=>{ if(!enabled) return; window.open(x.link||'#','_blank'); };
      } else {
        schedule.textContent='—';
        openBtn.onclick=()=> window.open(x.link||'#','_blank');
      }

      tpl.querySelector('.btn-edit').onclick=()=>{
        openCrud({ title:'Test tahrirlash', subtitle:'Oddiy/Online parametrlarini yangilang', fields:[
          {key:'type',label:'Turi',type:'select',options:['Oddiy','Online'],value:typeStr},
          {key:'title',label:'Sarlavha',type:'text',required:true,value:x.title||''},
          {key:'subtitle',label:'Qisqa info',type:'textarea',value:x.subtitle||''},
          {key:'price',label:'Narx (UZS)',type:'number',value:x.price||0},
          {key:'imageUrl',label:'Rasm (Oddiy uchun)',type:'url',value:x.imageUrl||''},
          {key:'link',label:'Havola',type:'url',value:x.link||''},
          {key:'startAt',label:'Boshlash (Online)',type:'text',value:x.startAt||''},
          {key:'endAt',label:'Tugash (Online)',type:'text',value:x.endAt||''},
          {key:'infoText',label:'Info matni (Online)',type:'textarea',value:x.infoText||''},
          {key:'tags',label:'Teglar (vergul bilan)',type:'text',value:(x.tags||[]).join(', ')}
        ], onSave: async(v)=>{ v.tags=String(v.tags||'').split(',').map(s=>s.trim()).filter(Boolean); const arr=get(testLS,[]); arr[idx]={...arr[idx],...v}; set(testLS,arr); renderTests(); }});
      };
      tpl.querySelector('.btn-delete').onclick=()=>{ if(!confirm('O‘chirishni tasdiqlaysizmi?')) return; const arr=get(testLS,[]); arr.splice(idx,1); set(testLS,arr); renderTests(); };
      return tpl;
    }

    function showInfoModal(title, text){
      openCrud({ title: title+' — maʼlumot', subtitle:'Faqat ko‘rish', fields:[{key:'info',label:'',type:'textarea',value:text}], onSave: async()=> Promise.resolve() });
      document.getElementById('crudSave').classList.add('hidden');
    }

    // ===== PROMOS & USERS (Firestore) =====
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getFirestore, collection, doc, getDoc, getDocs, addDoc, setDoc, updateDoc, deleteDoc, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    const firebaseConfig={
      apiKey:"AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain:"xplusy-760fa.firebaseapp.com",
      projectId:"xplusy-760fa",
      storageBucket:"xplusy-760fa.appspot.com",
      messagingSenderId:"992512966017",
      appId:"1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId:"G-459PLJ7P7L"
    };
    const fApp=initializeApp(firebaseConfig, 'admin-secondary');
    const db=getFirestore(fApp);

    // Promos
    document.getElementById('addPromo').onclick=()=>{
      openCrud({ title:'Promo kod qo‘shish', subtitle:'Serverga yoziladi', fields:[
        {key:'code',label:'Kod',type:'text',required:true},
        {key:'discountPercent',label:'Chegirma %',type:'number',value:20},
        {key:'maxUses',label:'Maks. foydalanish',type:'number',value:100},
        {key:'usedCount',label:'Ishlatilgan',type:'number',value:0},
        {key:'active',label:'Faol',type:'checkbox',value:true},
        {key:'expiresAt',label:'Tugash sanasi (YYYY-MM-DD)',type:'date'}
      ], onSave: async(v)=>{ await addDoc(collection(db,'promos'), v); await loadPromos(); }});
    };
    async function loadPromos(){
      const wrap=document.getElementById('promosGrid'); wrap.innerHTML='<div class="text-sm text-gray-500">Yuklanmoqda…</div>';
      const snap=await getDocs(query(collection(db,'promos'), orderBy('code')));
      wrap.innerHTML='';
      snap.forEach(d=>{
        const p={id:d.id, ...d.data()};
        const card=document.createElement('div'); card.className='card p-4 g3d';
        card.innerHTML=`<div class='flex items-center justify-between'>
          <div>
            <div class='text-xs text-gray-500'>Promo</div>
            <div class='text-lg font-semibold'>${esc(p.code||'—')}</div>
            <div class='text-sm text-gray-600'>${Number(p.discountPercent||0)}% · Max ${p.maxUses||0} · Ishl. ${p.usedCount||0} · ${p.active?'✅ Faol':'⛔ Nofaol'}</div>
          </div>
          <div class='flex gap-2'>
            <button class='btn btn-secondary edit'>✏️</button>
            <button class='btn btn-secondary del'>🗑️</button>
          </div>
        </div>`;
        card.querySelector('.edit').onclick=()=>{
          openCrud({ title:'Promo tahrirlash', subtitle:'Serverga yoziladi', fields:[
            {key:'code',label:'Kod',type:'text',required:true,value:p.code||''},
            {key:'discountPercent',label:'Chegirma %',type:'number',value:p.discountPercent||20},
            {key:'maxUses',label:'Maks. foydalanish',type:'number',value:p.maxUses||100},
            {key:'usedCount',label:'Ishlatilgan',type:'number',value:p.usedCount||0},
            {key:'active',label:'Faol',type:'checkbox',value:!!p.active},
            {key:'expiresAt',label:'Tugash sanasi',type:'date',value:p.expiresAt||''}
          ], onSave: async(v)=>{ await updateDoc(doc(db,'promos',p.id), v); await loadPromos(); }});
        };
        card.querySelector('.del').onclick=async()=>{ if(!confirm('O‘chirishni tasdiqlaysizmi?')) return; await deleteDoc(doc(db,'promos',p.id)); await loadPromos(); };
        wrap.appendChild(card);
      });
    }

    // Users
    const usersTbody=document.getElementById('usersTbody');
    document.getElementById('btnReloadUsers').onclick=()=> loadUsers(document.getElementById('userSearch').value.trim());
    document.getElementById('userSearch').oninput=(e)=> loadUsers(e.target.value.trim());

    async function loadUsers(qStr=''){
      usersTbody.innerHTML='<tr><td class="py-3 text-sm text-gray-500" colspan="8">Yuklanmoqda…</td></tr>';
      const snap=await getDocs(query(collection(db,'users'), orderBy('numericId','asc'), limit(200)));
      usersTbody.innerHTML='';
      snap.forEach(d=>{
        const u={id:d.id, ...d.data()};
        const needle=qStr.toLowerCase(); const hay=`${u.numericId||''} ${u.name||''} ${u.email||''}`.toLowerCase();
        if(needle && !hay.includes(needle)) return;
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class='py-2 px-3'>${u.numericId||'—'}</td>
          <td class='py-2 px-3'>${esc(u.name||'—')}</td>
          <td class='py-2 px-3'>${esc(u.email||'—')}</td>
          <td class='py-2 px-3'>${Number(u.balance||0).toFixed(2)}</td>
          <td class='py-2 px-3'>${Number(u.gems||0)}</td>
          <td class='py-2 px-3'>${esc(u.role||'user')}</td>
          <td class='py-2 px-3'>${esc(u.status||'active')}</td>
          <td class='py-2 px-3'><button class='btn btn-secondary edit'>✏️</button></td>`;
        tr.querySelector('.edit').onclick=()=>{
          openCrud({ title:'Foydalanuvchi tahrirlash', subtitle:'Serverga yoziladi', fields:[
            {key:'name',label:'Ism',type:'text',value:u.name||''},
            {key:'balance',label:'Balans',type:'number',value:u.balance||0},
            {key:'gems',label:'Ball (Gems)',type:'number',value:u.gems||0},
            {key:'role',label:'Rol (user/admin)',type:'text',value:u.role||'user'},
            {key:'status',label:'Holat (active/banned)',type:'text',value:u.status||'active'}
          ], onSave: async(v)=>{ await updateDoc(doc(db,'users',u.id), v); await loadUsers(qStr); }});
        };
        usersTbody.appendChild(tr);
      });
      if(!usersTbody.children.length){ usersTbody.innerHTML='<tr><td class="py-3 text-sm text-gray-500" colspan="8">Hech narsa topilmadi</td></tr>'; }
    }

    // ===== INIT =====
    let booted=false;
    function initOnce(){ if(booted) return; booted=true; selectTab('tab-home'); renderBanners(); renderGrid('courses'); renderGrid('sims'); renderTests(); loadPromos(); loadUsers(''); }

    applyAuth();
  </script>
</body>
</html>
