<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MathCenter — Lite (Ball-only)</title>

  <!-- Favicon (3D/granit π) -->
  <link rel="icon" type="image/svg+xml"
    href='data:image/svg+xml;utf8,
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
      <defs>
        <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="%232E8B57"/>
          <stop offset="1" stop-color="%231F6B45"/>
        </linearGradient>
        <filter id="s" x="-50%" y="-50%" width="200%" height="200%">
          <feDropShadow dx="0" dy="10" stdDeviation="12" flood-color="%23000000" flood-opacity="0.35"/>
        </filter>
      </defs>
      <rect width="512" height="512" rx="96" fill="url(%23g1)"/>
      <g filter="url(%23s)"><text x="256" y="332" text-anchor="middle" font-size="300" font-family="Georgia,serif" fill="white">π</text></g>
    </svg>'>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    :root{
      --primary:#2E8B57;--primary-dark:#1F6B45;--primary-light:#E8F5E9;
      --accent:#FFC107;--text:#222;--muted:#6b7280;
      --gray-50:#fafafa;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;
      --shadow:0 10px 30px rgba(0,0,0,.08);--tr:all .25s cubic-bezier(.25,.8,.25,1);--radius:14px
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#fff;color:var(--text)}
    .container{max-width:1280px;margin:0 auto;padding:0 16px}
    .row{display:flex;align-items:center;justify-content:space-between}

    /* Header */
    .mc-header{box-shadow:var(--shadow);border-radius:var(--radius);overflow:visible;border:1px solid var(--gray-200);background:#fff;position:relative;z-index:20}
    .mc-top{background:#123a31;color:#fff}
    .mc-top .row{padding:8px 0}
    .mc-main .row{padding:16px 0;gap:16px;flex-wrap:wrap;align-items:center}
    .logo{display:flex;align-items:center;gap:14px;text-decoration:none;color:inherit;position:relative;top:2px;order:1}
    .logo__pi{width:64px;height:64px;border-radius:16px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:34px;
      background:radial-gradient(120% 140% at 20% 10%, rgba(255,255,255,.35), transparent 50%),
                 repeating-linear-gradient(45deg, rgba(255,255,255,.08) 0 6px, rgba(0,0,0,.06) 6px 12px),
                 linear-gradient(135deg,var(--primary),var(--primary-dark));
      box-shadow:inset 0 6px 18px rgba(255,255,255,.25), inset 0 -10px 18px rgba(0,0,0,.18), 0 10px 24px rgba(46,139,87,.35);}
    .logo__txt{display:flex;flex-direction:column}
    .logo__name{font-family:Montserrat,sans-serif;font-size:28px;font-weight:700;color:var(--primary)}
    .logo__sub{font-size:12px;color:var(--muted);letter-spacing:.6px}

    /* Nav */
    .nav{order:3;flex:0 0 100%;margin-top:14px}
    .nav ul{list-style:none;display:flex;gap:8px;margin:0;padding:0;justify-content:space-between}
    .nav a{display:flex;gap:8px;align-items:center;justify-content:center;width:100%;padding:10px 14px;border-radius:12px;font-weight:600;color:var(--text);text-decoration:none;transition:var(--tr)}
    .nav a:hover{background:var(--primary-light);color:#0b3d2c}
    .nav .active>a{background:var(--primary);color:#fff}
    .nav li{flex:1 1 0}

    /* Buttons & badges */
    .btn{border:0;border-radius:12px;padding:10px 16px;font-weight:700;display:flex;align-items:center;gap:10px;cursor:pointer;transition:var(--tr)}
    .btn--primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;box-shadow:0 6px 16px rgba(46,139,87,.35)}
    .btn--ghost{background:#fff;border:1px solid var(--gray-200)}
    .btn:hover{transform:translateY(-2px)}

    /* User chip (only points) */
    .userBtn{display:none;align-items:center;gap:12px;background:linear-gradient(90deg,#fff,var(--gray-100));
      border:1px solid var(--gray-200);padding:8px 44px 8px 12px;border-radius:12px;cursor:pointer;position:relative}
    .avatar{width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;font-weight:700}
    .user__meta{display:flex;flex-direction:column}
    .user__name{font-weight:700;font-size:14px;white-space:nowrap;max-width:200px;overflow:hidden;text-overflow:ellipsis}
    .user__stats{display:flex;gap:12px;font-size:12px;color:#6b7280;flex-wrap:wrap}
    .id-badge{font-variant-numeric:tabular-nums;padding:2px 6px;border:1px dashed var(--gray-300);border-radius:8px;display:inline-flex;align-items:center;gap:6px}

    .dropdown{position:absolute;right:0;top:calc(100% + 8px);background:#fff;border:1px solid var(--gray-200);
      border-radius:12px;box-shadow:var(--shadow);min-width:260px;display:none;z-index:1000}
    .dropdown.open{display:block}

    /* Modals */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);z-index:120;align-items:center;justify-content:center}
    .card{width:92%;max-width:720px;background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 20px 44px rgba(0,0,0,.22)}
    .card__head{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:18px 22px;display:flex;align-items:center;justify-content:space-between}
    .card__title{font-family:Montserrat,sans-serif;font-weight:700}
    .close{width:36px;height:36px;border-radius:50%;border:0;background:rgba(255,255,255,.25);color:#fff;font-size:18px;cursor:pointer}
    .card__body{padding:18px 22px;max-height:72vh;overflow:auto}
    .row2{display:flex;gap:16px}
    .group{flex:1;margin-bottom:14px}
    label{display:block;font-weight:700;font-size:14px;margin-bottom:6px}
    input,select{width:100%;padding:10px 12px;border:1px solid var(--gray-200);border-radius:12px;background:#fff;transition:var(--tr);font-size:14px}
    input:focus,select:focus{outline:none;box-shadow:0 0 0 3px rgba(46,139,87,.15);border-color:var(--primary)}
    .submit{width:100%}

    /* Grid/cards */
    main{padding:16px 16px 32px}
    #grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .mc-card{border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;background:#fff;box-shadow:0 10px 24px rgba(0,0,0,.06);transition: transform .18s, box-shadow .18s}
    .mc-card:hover{ transform: translateY(-4px); box-shadow: 0 16px 36px rgba(0,0,0,.12); }

    /* Table (Natijalar) */
    table{width:100%;border-collapse:collapse}
    thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid #e5e7eb;text-align:left;padding:10px}
    tbody td{border-bottom:1px solid #f1f5f9;padding:10px}
    .rank{font-weight:800}

    /* Mobile tweaks */
    @media (max-width:900px){ .logo__txt{display:none} .user__name{max-width:140px} }
    @media (max-width:480px){
      .mc-main .row{align-items:stretch; gap:10px}
      .nav{order:3; flex-basis:100%; margin-top:8px}
      .nav ul{flex-wrap:wrap; gap:6px}
      .nav li{flex:1 1 calc(50% - 6px)}
      .nav a{padding:10px 12px}
      .logo__pi{width:56px;height:56px}
    }
  </style>
</head>
<body>
  <header class="mc-header">
    <div class="mc-top">
      <div class="container">
        <div class="row">
          <div style="font-size:13px;opacity:.95;display:flex;gap:14px;align-items:center">
            <span><i class="fa-solid fa-envelope"></i> mathcenteruz@gmail.com</span>
          </div>
          <div style="display:flex;gap:12px">
            <a href="#" aria-label="Telegram" style="color:#fff"><i class="fab fa-telegram"></i></a>
            <a href="#" aria-label="Instagram" style="color:#fff"><i class="fab fa-instagram"></i></a>
            <a href="#" aria-label="YouTube" style="color:#fff"><i class="fab fa-youtube"></i></a>
          </div>
        </div>
      </div>
    </div>

    <div class="mc-main">
      <div class="container">
        <div class="row">
          <a class="logo" href="#">
            <div class="logo__pi">π</div>
            <div class="logo__txt"><div class="logo__name">MathCenter</div><div class="logo__sub">MATEMATIKA MARKAZI (Lite)</div></div>
          </a>

          <nav class="nav" aria-label="Asosiy menyu">
            <ul id="deskNav">
              <li class="active"><a href="#" data-sec="home"><i class="fa-solid fa-house"></i> Bosh sahifa</a></li>
              <li><a href="#" data-sec="tests"><i class="fa-solid fa-clipboard-list"></i> Testlar</a></li>
              <li><a href="#" data-sec="courses"><i class="fa-solid fa-book-open"></i> Kurslar</a></li>
              <li><a href="#" data-sec="simulators"><i class="fa-solid fa-gears"></i> Simulyatorlar</a></li>
              <li><a href="#" data-sec="results"><i class="fa-solid fa-chart-line"></i> Natijalar</a></li>
            </ul>
          </nav>

          <div style="display:flex;align-items:center;gap:10px">
            <!-- Admin tugmasi (faqat isAdmin=true foydalanuvchiga) -->
            <button id="adminBtn" class="btn btn--ghost" style="display:none"><i class="fa-solid fa-shield-halved"></i> Admin</button>

            <!-- Kirish / Foydalanuvchi -->
            <button id="openLogin" class="btn btn--primary"><i class="fa-solid fa-right-to-bracket"></i> Kirish</button>

            <div id="userBtn" class="userBtn">
              <div id="avatarFallback" class="avatar">U</div>
              <div class="user__meta">
                <div id="uFullName" class="user__name">Foydalanuvchi</div>
                <div class="user__stats">
                  <span title="Ball"><i class="fa-solid fa-star" style="color:var(--primary)"></i> <b id="uPoints">0</b></span>
                  <span class="id-badge"><i class="fa-solid fa-id-card"></i> <b id="uClass">Sinf —</b></span>
                </div>
              </div>
              <button id="userMenuBtn" class="btn btn--ghost" style="position:absolute;right:6px;top:50%;transform:translateY(-50%);width:32px;height:32px;padding:0"><i class="fa-solid fa-chevron-down"></i></button>

              <div id="userDropdown" class="dropdown">
                <div style="padding:12px 14px;border-bottom:1px solid var(--gray-200)">
                  <div style="font-weight:800" id="ddFullName">Foydalanuvchi</div>
                  <div style="color:#6b7280;font-size:12px;margin-top:6px">
                    <i class="fa-solid fa-star" style="color:var(--primary)"></i> <b id="ddPoints">0</b> • <span id="ddClass">Sinf —</span>
                  </div>
                </div>
                <a class="dd-link" href="#" id="openProfile" style="display:block;padding:12px 14px;text-decoration:none;color:#111"><i class="fa-regular fa-user"></i> Profil (login/parol)</a>
                <div class="dd-sep" style="height:1px;background:#e5e7eb"></div>
                <a class="dd-link" href="#" id="logoutLink" style="display:block;padding:12px 14px;color:#b91c1c;text-decoration:none"><i class="fa-solid fa-right-from-bracket"></i> Chiqish</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Banner + Cards + Natijalar -->
  <main class="container">
    <section id="bannerCarousel" style="position:relative;overflow:hidden;border-radius:16px;border:1px solid #e5e7eb;box-shadow:0 10px 30px rgba(0,0,0,.06)">
      <div id="bannerTrack" style="display:flex;transition:transform .5s ease"></div>
      <button id="bnPrev" aria-label="Oldingi" style="position:absolute;left:8px;top:50%;transform:translateY(-50%);border:0;background:#fff;border-radius:50%;width:40px;height:40px;box-shadow:0 6px 16px rgba(0,0,0,.2)">‹</button>
      <button id="bnNext" aria-label="Keyingi" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);border:0;background:#fff;border-radius:50%;width:40px;height:40px;box-shadow:0 6px 16px rgba(0,0,0,.2)">›</button>
    </section>

    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0 12px">
      <input id="q" placeholder="Qidiruv…" style="padding:10px;border:1px solid #e5e7eb;border-radius:999px;flex:1;min-width:220px"/>
      <div id="chips" style="display:flex;gap:6px;flex-wrap:wrap"></div>
    </div>

    <section id="grid"></section>

    <!-- Natijalar (Reyting) -->
    <section id="resultsSec" style="display:none;margin-top:18px">
      <h2 style="margin:12px 0 8px">Reyting (Ball bo‘yicha)</h2>
      <div style="overflow:auto;border:1px solid #e5e7eb;border-radius:12px">
        <table>
          <thead><tr><th>#</th><th>F.I.Sh</th><th>Sinf</th><th>Ball</th></tr></thead>
          <tbody id="resultsBody"><tr><td colspan="4" style="padding:14px;color:#6b7280">Yuklanmoqda…</td></tr></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- === Kirish (login/parol) modal — faqat lite_users ro‘yxati uchun === -->
  <div id="loginModal" class="modal" data-flex="true">
    <div class="card" style="max-width:480px">
      <div class="card__head"><div class="card__title">Kirish</div><button id="closeLogin" class="close" aria-label="Yopish">&times;</button></div>
      <div class="card__body">
        <p style="margin-top:0;color:#4b5563">Foydalanuvchilarni admin Excel orqali qo‘shadi. Quyida <b>login</b> va <b>parol</b>ingizni kiriting.</p>
        <div class="group"><label>Login</label><input id="liLogin" autocomplete="username"/></div>
        <div class="group"><label>Parol</label><input id="liPass" type="password" autocomplete="current-password"/></div>
        <button id="doLogin" class="btn btn--primary submit"><i class="fa-solid fa-right-to-bracket"></i> Kirish</button>
        <div id="loginMsg" style="margin-top:10px;font-weight:700"></div>
      </div>
    </div>
  </div>

  <!-- === Profil (login/parolni almashtirish) === -->
  <div id="profileModal" class="modal" data-flex="true">
    <div class="card">
      <div class="card__head"><div class="card__title">Profil (login/parol)</div><button id="closeProfile" class="close" aria-label="Yopish">&times;</button></div>
      <div class="card__body">
        <form id="profileForm">
          <div class="row2">
            <div class="group"><label>Ism Familiya Sharif (F.I.Sh)</label><input id="pfFullName" placeholder="Familiya Ism Sharif"/></div>
            <div class="group"><label>Sinf</label><input id="pfClass" placeholder="8-A"/></div>
          </div>
          <div class="row2">
            <div class="group"><label>Login</label><input id="pfLogin" autocomplete="username"/></div>
            <div class="group"><label>Parol</label><input id="pfPass" type="password" autocomplete="new-password"/></div>
          </div>
          <button class="btn btn--primary submit" type="submit">Saqlash</button>
          <div id="pfMsg" style="margin-top:10px;font-weight:700"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- === Admin (Excel yuklash: F.I.Sh | Sinf | login | parol) === -->
  <div id="adminModal" class="modal" data-flex="true">
    <div class="card">
      <div class="card__head"><div class="card__title">Admin — Foydalanuvchilarni Excel orqali qo‘shish</div><button id="closeAdmin" class="close" aria-label="Yopish">&times;</button></div>
      <div class="card__body">
        <p style="margin-top:0">Fayl ustun tartibi: <b>F.I.Sh</b> | <b>Sinf</b> | <b>login</b> | <b>parol</b>. Birinchi qator — sarlavha bo‘lishi mumkin.</p>
        <input id="excelFile" type="file" accept=".xlsx,.xls" />
        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="previewExcel" class="btn btn--ghost"><i class="fa-regular fa-eye"></i> Oldindan ko‘rish</button>
          <button id="importExcel" class="btn btn--primary"><i class="fa-solid fa-file-import"></i> Import</button>
        </div>
        <div id="adminMsg" style="margin-top:10px;font-weight:700"></div>
        <div id="excelPreview" style="margin-top:14px;border:1px dashed #e5e7eb;border-radius:12px;padding:10px;display:none"></div>
      </div>
    </div>
  </div>

  <!-- SheetJS (Excel o‘qish uchun) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Firebase (faqat Firestore) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc,
      query, where, getDocs, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // === Firebase config (sizniki) ===
    const firebaseConfig = {
      apiKey:"AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain:"xplusy-760fa.firebaseapp.com",
      projectId:"xplusy-760fa",
      storageBucket:"xplusy-760fa.firebasestorage.app",
      messagingSenderId:"992512966017",
      appId:"1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId:"G-459PLJ7P7L"
    };

    // === App init ===
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // --- One-time admin seeder (login: Math@1999, parol: Math@28021999) ---
    // Admin yaratilib bo'lgach, quyidagi blokni o'chirib qo'yish tavsiya etiladi.
    const DEFAULT_ADMIN = {
      fullName: 'Admin',
      class: '—',
      login: 'Math@1999',
      password: 'Math@28021999',
      points: 0,
      isAdmin: true
    };
    async function ensureAdminOnce(){
      if (localStorage.getItem('__LITE_ADMINSEEDED__') === '1') return;
      try{
        const qs = await getDocs(query(collection(db,'lite_users'), where('login','==', DEFAULT_ADMIN.login)));
        if (qs.empty){
          await addDoc(collection(db,'lite_users'), DEFAULT_ADMIN);
          console.log('[lite] Admin created.');
        } else {
          const ref = qs.docs[0].ref;
          await updateDoc(ref, { isAdmin: true, password: DEFAULT_ADMIN.password, fullName: DEFAULT_ADMIN.fullName });
          console.log('[lite] Admin updated.');
        }
        localStorage.setItem('__LITE_ADMINSEEDED__', '1');
      } catch(e){
        console.error('[lite] ensureAdminOnce error:', e);
      }
    }
    ensureAdminOnce();

    // ====== Helpers ======
    const $ = (id)=>document.getElementById(id);
    const show = (el, on=true)=>{ if(!el) return; el.style.display = on? (el.dataset.flex?'flex':'block') : 'none'; };
    const toast = (el, msg, ok=true)=>{ if(!el) return; el.textContent = msg; el.style.color = ok? '#065f46':'#b91c1c'; };

    // ====== UI refs ======
    const openLogin = $('openLogin'), loginModal = $('loginModal'), liLogin = $('liLogin'), liPass = $('liPass'), doLogin = $('doLogin'), loginMsg = $('loginMsg'), closeLogin = $('closeLogin');
    const userBtn = $('userBtn'), userMenuBtn = $('userMenuBtn'), userDropdown = $('userDropdown'), logoutLink = $('logoutLink');
    const uFullName = $('uFullName'), uPoints = $('uPoints'), uClass = $('uClass');
    const ddFullName = $('ddFullName'), ddPoints = $('ddPoints'), ddClass = $('ddClass');
    const openProfile = $('openProfile'), profileModal = $('profileModal'), closeProfile = $('closeProfile'), pfFullName = $('pfFullName'), pfClass = $('pfClass'), pfLogin = $('pfLogin'), pfPass = $('pfPass'), profileForm = $('profileForm'), pfMsg = $('pfMsg');
    const adminBtn = $('adminBtn'), adminModal = $('adminModal'), closeAdmin = $('closeAdmin'), excelFile = $('excelFile'), previewExcel = $('previewExcel'), importExcel = $('importExcel'), adminMsg = $('adminMsg'), excelPreview = $('excelPreview');
    const bannerTrack = $('bannerTrack'), bnPrev = $('bnPrev'), bnNext = $('bnNext'), q = $('q'), chipsEl = $('chips'), grid = $('grid'), resultsSec = $('resultsSec'), resultsBody = $('resultsBody');

    // ====== App state ======
    let currentLiteUser = null; // {id, fullName, className, login, points, isAdmin}
    let dbData = null;          // liteadmin.json dan

    // ====== Cards state ======
    const PAGE_SIZE = 18;
    let section = 'home';
    let page = 1;
    const activeTags = new Set();
    let bnIdx = 0, bnTimer = null;

    // ====== Nav (section switching) ======
    const deskNav = document.getElementById('deskNav');
    deskNav.querySelectorAll('a[data-sec]').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        deskNav.querySelectorAll('li').forEach(li=>li.classList.remove('active'));
        a.parentElement.classList.add('active');
        const sec = a.getAttribute('data-sec');
        if(sec==='results'){ show(resultsSec,true); renderResults(); }
        else { show(resultsSec,false); }
        section = sec;
        page = 1; activeTags.clear();
        buildTags(); renderGrid();
        const gridEl = document.getElementById('grid');
        if (gridEl) window.scrollTo({ top: gridEl.offsetTop - 80, behavior: 'smooth' });
      });
    });

    // ====== Login modal ======
    function openLoginModal(){ show(loginModal,true); }
    function closeLoginModal(){ show(loginModal,false); }
    openLogin.addEventListener('click', openLoginModal);
    closeLogin.addEventListener('click', closeLoginModal);
    window.addEventListener('click', e=>{ if(e.target===loginModal) closeLoginModal(); });

    // Dropdown
    userMenuBtn.addEventListener('click', (e)=>{
      e.stopPropagation();
      userDropdown.classList.toggle('open');
    });
    document.addEventListener('click',(e)=>{ if(!userBtn.contains(e.target)) userDropdown.classList.remove('open'); });

    // ====== Local persistence ======
    function saveSession(u){ localStorage.setItem('__LITE_USER', JSON.stringify(u)); }
    function loadSession(){ try{ const s=localStorage.getItem('__LITE_USER'); return s? JSON.parse(s):null; } catch { return null; } }
    function clearSession(){ localStorage.removeItem('__LITE_USER'); }

    function reflectUser(u){
      if(!u){
        show(openLogin,true);
        show(userBtn,false);
        return;
      }
      show(openLogin,false);
      show(userBtn,true);
      const full = u.fullName || 'Foydalanuvchi';
      uFullName.textContent = full;
      uPoints.textContent = u.points ?? 0;
      uClass.textContent = u.className ? `Sinf ${u.className}` : 'Sinf —';
      ddFullName.textContent = full;
      ddPoints.textContent = u.points ?? 0;
      ddClass.textContent = u.className || '—';
      // Admin tugmasi
      adminBtn.style.display = u.isAdmin ? 'inline-flex' : 'none';
    }

    // ====== Lite login (Firestore: lite_users) ======
    async function doLiteLogin(){
      loginMsg.textContent='';
      const L = (liLogin.value||'').trim();
      const P = (liPass.value||'').trim();
      if(!L || !P){ toast(loginMsg,'Login va parolni kiriting', false); return; }
      try{
        const qref = query(collection(db,'lite_users'), where('login','==', L), where('password','==', P));
        const qs = await getDocs(qref);
        if(qs.empty){ toast(loginMsg,'Login yoki parol xato', false); return; }
        const docSnap = qs.docs[0];
        const d = docSnap.data();
        currentLiteUser = { id: docSnap.id, fullName: d.fullName||'', className: d.class||'', login: d.login, points: d.points||0, isAdmin: !!d.isAdmin };
        saveSession(currentLiteUser);
        reflectUser(currentLiteUser);
        closeLoginModal();
      }catch(e){
        console.error(e);
        toast(loginMsg,'Server xatosi', false);
      }
    }
    doLogin.addEventListener('click', doLiteLogin);

    // Logout
    logoutLink.addEventListener('click', (e)=>{ e.preventDefault(); currentLiteUser=null; clearSession(); reflectUser(null); });

    // ====== Profil (login/parolni o‘zgartirish) ======
    function openProfileModal(){
      if(!currentLiteUser){ openLoginModal(); return; }
      pfFullName.value = currentLiteUser.fullName || '';
      pfClass.value    = currentLiteUser.className || '';
      pfLogin.value    = currentLiteUser.login || '';
      pfPass.value     = '';
      toast(pfMsg,'',true);
      show(profileModal,true);
    }
    function closeProfileModal(){ show(profileModal,false); }
    openProfile.addEventListener('click', (e)=>{ e.preventDefault(); userDropdown.classList.remove('open'); openProfileModal(); });
    closeProfile.addEventListener('click', closeProfileModal);
    window.addEventListener('click', e=>{ if(e.target===profileModal) closeProfileModal(); });

    profileForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!currentLiteUser){ openLoginModal(); return; }
      const payload = {
        fullName: pfFullName.value.trim(),
        class: pfClass.value.trim(),
        login: pfLogin.value.trim()
      };
      const newPass = pfPass.value.trim();
      if(newPass) payload.password = newPass; // demo: client-side; prod: hash
      try{
        await updateDoc(doc(db,'lite_users', currentLiteUser.id), payload);
        Object.assign(currentLiteUser, { fullName: payload.fullName, className: payload.class, login: payload.login });
        saveSession(currentLiteUser);
        reflectUser(currentLiteUser);
        toast(pfMsg,'Saqlandi', true);
        setTimeout(()=> closeProfileModal(), 500);
      }catch(e){ console.error(e); toast(pfMsg,'Saqlashda xato', false); }
    });

    // ====== Admin (Excel import) ======
    function openAdmin(){ if(!currentLiteUser?.isAdmin){ return; } show(adminModal,true); }
    function closeAdminModal(){ show(adminModal,false); }
    adminBtn.addEventListener('click', openAdmin);
    closeAdmin.addEventListener('click', closeAdminModal);
    window.addEventListener('click', e=>{ if(e.target===adminModal) closeAdminModal(); });

    let parsedRows = [];
    previewExcel.addEventListener('click', async ()=>{
      adminMsg.textContent='';
      parsedRows=[]; excelPreview.innerHTML='';
      if(!excelFile.files?.length){ toast(adminMsg,'Fayl tanlang', false); return; }
      const file = excelFile.files[0];
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data);
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {header:1}); // 2D rows
      // Expect: [F.I.Sh, Sinf, login, parol]
      const out = [];
      for(let i=0;i<rows.length;i++){
        const r = rows[i];
        if(!r || r.length<4) continue;
        if(i===0 && String(r[0]).toLowerCase().includes('f') ) continue; // header skip
        out.push({fullName:String(r[0]||'').trim(), class:String(r[1]||'').trim(), login:String(r[2]||'').trim(), password:String(r[3]||'').trim(), points:0, isAdmin:false});
      }
      parsedRows = out;
      if(!out.length){ toast(adminMsg,'Ma’lumot topilmadi', false); return; }
      excelPreview.style.display='block';
      excelPreview.innerHTML = `
        <div style="font-weight:800;margin-bottom:8px">Oldindan ko‘rish (${out.length} ta):</div>
        <div style="max-height:240px;overflow:auto">
          <table>
            <thead><tr><th>F.I.Sh</th><th>Sinf</th><th>Login</th><th>Parol</th></tr></thead>
            <tbody>
              ${out.map(r=>`<tr><td>${r.fullName}</td><td>${r.class}</td><td>${r.login}</td><td>${r.password?'••••••':''}</td></tr>`).join('')}
            </tbody>
          </table>
        </div>`;
      toast(adminMsg,'Tayyor. “Import” bosing.', true);
    });

    importExcel.addEventListener('click', async ()=>{
      if(!currentLiteUser?.isAdmin){ return; }
      if(!parsedRows.length){ toast(adminMsg,'Avval “Oldindan ko‘rish” qiling', false); return; }
      try{
        let added = 0;
        for(const r of parsedRows){
          if(!r.login || !r.password || !r.fullName) continue;
          // login unikal bo‘lishi uchun bor-yo‘qligini tekshiramiz
          const qref = query(collection(db,'lite_users'), where('login','==', r.login));
          const qs = await getDocs(qref);
          if(!qs.empty){ // mavjud — tashlab ketamiz
            continue;
          }
          await addDoc(collection(db,'lite_users'), r);
          added++;
        }
        toast(adminMsg, `Import yakunlandi: ${added} ta yangi foydalanuvchi qo‘shildi.`, true);
        parsedRows=[];
      }catch(e){ console.error(e); toast(adminMsg,'Importda xato', false); }
    });

    // ====== Cards & Banners (liteadmin.json) ======
    async function loadLiteData(){
      try{
        const r = await fetch('liteadmin.json?_=' + Date.now());
        dbData = r.ok ? await r.json() : {banners:[], cards:{tests:[],courses:[],simulators:[]}};
      }catch{ dbData = {banners:[], cards:{tests:[],courses:[],simulators:[]}}; }
    }

    function moveBanner(i){
      const n = (dbData.banners||[]).length || 1;
      bnIdx = ((i % n) + n) % n;
      bannerTrack.style.transform = `translateX(-${bnIdx*100}%)`;
    }
    function renderBanners(){
      bannerTrack.innerHTML = '';
      (dbData.banners||[]).forEach(b=>{
        const d = document.createElement('div');
        d.style.cssText = 'min-width:100%;display:flex;align-items:center;gap:16px;padding:16px;background:'+ (b.bg||'#0b3d2c') +';color:#fff';
        d.innerHTML = `
          <div style="flex:1">
            <div style="font-size:28px;font-weight:800">${b.title||''}</div>
            <div style="opacity:.9;margin-top:6px">${b.subtitle||''}</div>
            ${b.link? `<a href="${b.link}" style="display:inline-block;margin-top:12px;padding:10px 14px;border-radius:10px;background:#fff;color:#0b3d2c;text-decoration:none;font-weight:700">Batafsil</a>`:''}
          </div>
          ${b.image? `<img src="${b.image}" alt="" style="width:520px;max-width:50%;border-radius:12px;object-fit:cover">`:''}
        `;
        bannerTrack.appendChild(d);
      });
      moveBanner(0);
      if(bnTimer) clearInterval(bnTimer);
      bnTimer = setInterval(()=> moveBanner(bnIdx+1), 5000);
      bnPrev.onclick = ()=> moveBanner(bnIdx-1);
      bnNext.onclick = ()=> moveBanner(bnIdx+1);
    }

    function buildTags(){
      const items = dbData.cards[section] || [];
      const all = new Set();
      items.forEach(it=> (it.tags||[]).forEach(t=> all.add(t)) );
      chipsEl.innerHTML = '';
      all.forEach(tag=>{
        const b = document.createElement('button');
        b.textContent = tag;
        b.className='chip';
        b.style.cssText='padding:8px 12px;border:1px solid #e5e7eb;border-radius:999px;background:#fff;cursor:pointer';
        if(activeTags.has(tag)) { b.style.background='#E8F5E9'; b.style.borderColor='#86efac'; b.style.color='#14532d'; }
        b.onclick=()=>{ if(activeTags.has(tag)) activeTags.delete(tag); else activeTags.add(tag); page=1; buildTags(); renderGrid(); };
        chipsEl.appendChild(b);
      });
    }

    function statusOf(it){
      if(it.mode !== 'online') return {label:'Boshlash', state:'static'};
      const now = Date.now();
      const s = it.startAt? Date.parse(it.startAt): null;
      const e = it.endAt? Date.parse(it.endAt): null;
      if(s && now < s) return {label: 'Boshlashgacha', until: s, state:'before'};
      if(e && now > e) return {label: 'Vaqt tugadi', state:'after'};
      return {label: 'Boshlash', state:'open'};
    }

    function renderGrid(){
      const queryStr = (q.value||'').toLowerCase().trim();
      let items = (section==='home')
        ? [...(dbData.cards.tests||[]), ...(dbData.cards.courses||[]), ...(dbData.cards.simulators||[])]
            .filter(it=>it.home)
        : [...(dbData.cards[section]||[])];

      items.sort((a,b)=> (b.best?1:0) - (a.best?1:0));
      if(activeTags.size){ items = items.filter(it => (it.tags||[]).some(t=> activeTags.has(t))); }
      if(queryStr){ items = items.filter(it => (it.title||'').toLowerCase().includes(queryStr)); }

      const total = items.length;
      const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      page = Math.min(Math.max(1,page), pages);
      const start = (page-1)*PAGE_SIZE; const slice = items.slice(start, start+PAGE_SIZE);

      grid.innerHTML='';
      slice.forEach(it=>{
        const st = statusOf(it);
        const card = document.createElement('article'); card.className='mc-card';
        card.innerHTML = `
          ${it.image? `<img src="${it.image}" alt="" style="width:100%;height:160px;object-fit:cover">`:''}
          <div style="padding:12px">
            <div style="display:flex;gap:6px;align-items:center;justify-content:space-between">
              <h3 style="margin:0;font-size:16px;display:flex;align-items:center;gap:8px">${it.title||""}${((section==="tests") || (section==="home" && it.mode))? `<span style="font-size:11px;padding:2px 6px;border:1px solid #e5e7eb;border-radius:999px">${it.mode||''}</span>` : ``}</h3>
              ${it.best? '<span style="padding:4px 8px;border:1px solid #e5e7eb;border-radius:999px;font-size:12px">BEST</span>':''}
            </div>
            ${(section==='courses'||section==='simulators')
              ? `<div style="display:flex;gap:6px;flex-wrap:wrap;margin:6px 0">${(it.tags||[]).map(t=>`<span style='display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #e5e7eb;border-radius:999px;font-size:12px;background:#f8fafc;color:#334155'>${t}</span>`).join('')}</div>`
              : `<div style="margin:6px 0;color:#555;font-size:12px">${(it.tags||[]).join(' • ')}</div>` }
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px">
              <a href="${it.link||'#'}" class="btn btn--primary" data-role="action">${st.label}</a>
              <button class="btn btn--ghost" data-role="detail">Batafsil</button>
              ${it.prize? `<span style="font-size:12px;color:#0b3d2c">🏅 ${it.prize}</span>`:''}
              ${(it.best && st.state==='before')? `<span class="cd" data-until="${st.until}"></span>`:''}
            </div>
          </div>
        `;
        const act = card.querySelector('[data-role="action"]');
        if(it.mode==='online'){
          const st2 = statusOf(it);
          if(st2.state==='before'){ act.href = '#'; act.onclick = (e)=> e.preventDefault(); }
          if(st2.state==='after'){ act.href = '#'; act.textContent = 'Vaqt tugadi'; act.onclick = (e)=> e.preventDefault(); }
        }
        const cd = card.querySelector('.cd');
        if(cd){
          const until = Number(cd.getAttribute('data-until'));
          const tick = ()=>{
            const left = Math.max(0, Math.floor((until - Date.now())/1000));
            const d = Math.floor(left/86400), h = Math.floor(left%86400/3600), m = Math.floor(left%3600/60), s = left%60;
            cd.textContent = `⏳ ${d} kun ${h} soat ${m} daqiqa ${s} s`;
            if(left<=0) { renderGrid(); }
          };
          tick(); setInterval(tick,1000);
        }
        grid.appendChild(card);
      });
    }

    // ====== Natijalar (points desc) ======
    async function renderResults(){
      try{
        const qref = query(collection(db,'lite_users'), orderBy('points','desc'));
        const qs = await getDocs(qref);
        let rank = 0;
        resultsBody.innerHTML = qs.docs.map(d=>{
          const x=d.data(); rank++;
          return `<tr><td class="rank">${rank}</td><td>${x.fullName||''}</td><td>${x.class||''}</td><td>${x.points||0}</td></tr>`;
        }).join('') || `<tr><td colspan="4" style="padding:14px;color:#6b7280">Hali foydalanuvchilar yo‘q</td></tr>`;
      }catch(e){
        console.error(e);
        resultsBody.innerHTML = `<tr><td colspan="4" style="padding:14px;color:#b91c1c">Reytingni yuklashda xato</td></tr>`;
      }
    }

    // ====== Init flow (single definition, no duplicates) ======
    (async ()=>{
      const sess = loadSession();
      if(sess){ currentLiteUser = sess; reflectUser(currentLiteUser); }
      else{ reflectUser(null); }
      await loadLiteData();
      renderBanners();
      buildTags();
      renderGrid();
    })();
  </script>
</body>
</html>
