<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin User + Telegram Login</title>
<style>
body { font-family: Arial, sans-serif; background:#f0f2f5; margin:0; padding:20px; }
h1 { color:#10b981; text-align:center; margin-bottom:20px; }
input, button { padding:8px 12px; border-radius:6px; border:1px solid #ccc; outline:none; }
button { cursor:pointer; }
table { width:100%; border-collapse:collapse; background:white; border-radius:8px; overflow:hidden; }
th, td { padding:12px; text-align:left; border-bottom:1px solid #eee; }
th { background:#10b981; color:white; font-weight:600; }
tr:hover { background:#f1fdf6; }
.btn-edit { background:#059669; color:white; border:none; padding:6px 12px; border-radius:4px; }
#searchInput { margin-bottom:15px; padding:10px; font-size:16px; }
#balanceModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
  background:rgba(0,0,0,0.5); justify-content:center; align-items:center; animation:fadeIn 0.3s; }
#balanceModalContent { background:white; padding:20px; border-radius:12px; width:90%; max-width:350px; position:relative;
  transform:translateY(-50px); animation:slideDown 0.3s forwards; }
#modalCloseBtn { position:absolute; top:10px; right:15px; font-size:20px; cursor:pointer; color:#555; }
#modalSaveBtn { background:#10b981; color:white; border:none; width:100%; font-size:16px; border-radius:6px; }
#loginBox { text-align:center; margin-bottom:20px; }
#welcomeMsg { font-weight:600; color:#059669; margin-left:10px; }
#balanceBox { font-weight:bold; color:#10b981; margin-left:15px; }
@keyframes fadeIn { from {opacity:0} to {opacity:1} }
@keyframes slideDown { from {opacity:0; transform:translateY(-50px);} to {opacity:1; transform:translateY(0);} }
@media (max-width:600px){
  th, td { font-size:14px; padding:8px; }
  input, button { font-size:14px; padding:6px 10px; }
}
</style>
</head>
<body>

<h1>Foydalanuvchilar roâ€˜yxati</h1>

<div id="loginBox">
  <script async src="https://telegram.org/js/telegram-widget.js?7"
          data-telegram-login="YOUR_BOT_USERNAME"
          data-size="large"
          data-userpic="false"
          data-request-access="write"
          data-onauth="onTelegramAuth(user)"
          data-lang="uz">
  </script>
  <span id="welcomeMsg" style="display:none;"></span>
  <span id="balanceBox" style="display:none;">ðŸ’° 0 soâ€˜m</span>
</div>

<input type="text" id="searchInput" placeholder="Foydalanuvchini izlash...">
<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>Ism</th>
      <th>Username</th>
      <th>Balans (soâ€˜m)</th>
      <th>Amallar</th>
    </tr>
  </thead>
  <tbody id="usersTableBody"></tbody>
</table>

<div id="balanceModal">
  <div id="balanceModalContent">
    <span id="modalCloseBtn">Ã—</span>
    <h3 id="modalUserName"></h3>
    <input type="number" id="modalBalansInput">
    <button id="modalSaveBtn">Saqlash</button>
  </div>
</div>

<script>
let users = JSON.parse(localStorage.getItem("users")) || [];
let loggedInUser = null;

// Telegram logindan kelgan foydalanuvchi
function onTelegramAuth(user){
  loggedInUser = user;
  localStorage.setItem("telegramUser", JSON.stringify(user));

  // UI update
  document.getElementById("welcomeMsg").innerText = `Salom, ${user.first_name} (ID: ${user.id})`;
  document.getElementById("welcomeMsg").style.display = "inline";
  document.getElementById("balanceBox").style.display = "inline";

  addOrUpdateUser(user);
}

// Foydalanuvchini qoâ€˜shish yoki yangilash
function addOrUpdateUser(user){
  let existing = users.find(u => u.id == user.id);
  if(!existing){
    users.push({ id: user.id, first_name: user.first_name, username: user.username || "", balans: 0 });
  }
  localStorage.setItem("users", JSON.stringify(users));
  renderUsers();
}

// Jadvalni yangilash
function renderUsers(filter="") {
  const tbody = document.getElementById("usersTableBody");
  tbody.innerHTML = "";

  users.filter(u =>
    u.first_name.toLowerCase().includes(filter.toLowerCase()) ||
    (u.username && u.username.toLowerCase().includes(filter.toLowerCase()))
  ).forEach(user => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${user.id}</td>
      <td>${user.first_name}</td>
      <td>${user.username}</td>
      <td>${user.balans || 0}</td>
      <td><button class="btn-edit" data-id="${user.id}">Tahrirlash</button></td>
    `;
    tbody.appendChild(tr);
  });

  document.querySelectorAll(".btn-edit").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = btn.getAttribute("data-id");
      const user = users.find(u => u.id == id);
      if(user) openModal(user);
    });
  });
}

// Modal
function openModal(user){
  document.getElementById("modalUserName").innerText = `${user.first_name} (ID: ${user.id})`;
  document.getElementById("modalBalansInput").value = user.balans || 0;
  document.getElementById("modalSaveBtn").setAttribute("data-id", user.id);
  document.getElementById("balanceModal").style.display = "flex";
}
document.getElementById("modalCloseBtn").addEventListener("click", ()=>{ document.getElementById("balanceModal").style.display="none"; });
document.getElementById("modalSaveBtn").addEventListener("click", ()=>{
  const id = document.getElementById("modalSaveBtn").getAttribute("data-id");
  const value = Number(document.getElementById("modalBalansInput").value);
  const userIndex = users.findIndex(u=>u.id==id);
  if(userIndex>-1){ users[userIndex].balans=value; localStorage.setItem("users",JSON.stringify(users)); renderUsers(document.getElementById("searchInput").value); document.getElementById("balanceModal").style.display="none";}
});

// Search
document.getElementById("searchInput").addEventListener("input", e=>renderUsers(e.target.value));

// Sahifa yuklanganda render
document.addEventListener("DOMContentLoaded",()=>{ 
  // Avvalgi Telegram foydalanuvchi
  const savedUser = localStorage.getItem("telegramUser");
  if(savedUser){
    loggedInUser = JSON.parse(savedUser);
    document.getElementById("welcomeMsg").innerText = `Salom, ${loggedInUser.first_name} (ID: ${loggedInUser.id})`;
    document.getElementById("welcomeMsg").style.display = "inline";
    document.getElementById("balanceBox").style.display = "inline";
    addOrUpdateUser(loggedInUser);
  }
  renderUsers();
});
</script>
</body>
</html>
