import { auth, db, provider, GoogleAuthProvider, signInWithPopup, signInWithRedirect, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile, doc, getDoc, setDoc, updateDoc, runTransaction, serverTimestamp } from "./firebase.js";const $=(s,r=document)=>r.querySelector(s);export let currentUser=null;export let currentUserProfile=null;export function titleFromPoints(p){const n=p||0;return n>=1e4?"Legend":n>=5e3?"Diamond":n>=2e3?"Platinum":n>=1e3?"Gold":n>=500?"Silver":n>=100?"Bronze":"Newbie";}async function ensureUserProfile(user){const uref=doc(db,"users",user.uid);const snap=await getDoc(uref);async function allocateId(tx){const mref=doc(db,"meta","counters");const ms=await tx.get(mref);let last=100000;if(ms.exists()&&(ms.data().lastUserId||ms.data().nextUserId)){if(typeof ms.data().lastUserId==="number"){last=ms.data().lastUserId;tx.update(mref,{lastUserId:last+1});}else if(typeof ms.data().nextUserId==="number"){last=ms.data().nextUserId-1;tx.update(mref,{nextUserId:last+2});}}else{tx.set(mref,{lastUserId:last+1},{merge:true});}return last+1;}if(!snap.exists()){await runTransaction(db,async(tx)=>{const numericId=await allocateId(tx);tx.set(uref,{uid:user.uid,numericId,displayName:user.displayName||user.email?.split("@")[0]||"Foydalanuvchi",photoURL:user.photoURL||"",balance:0,points:0,title:"Newbie",createdAt:serverTimestamp(),updatedAt:serverTimestamp()},{merge:true});});}else{const data=snap.data()||{};if(typeof data.numericId!=="number"){await runTransaction(db,async(tx)=>{const numericId=await allocateId(tx);tx.update(uref,{numericId,updatedAt:serverTimestamp()});});}const refreshed=await getDoc(uref);const d=refreshed.data()||{};const title=titleFromPoints(d.points||0);if(d.title!==title){await updateDoc(uref,{title,updatedAt:serverTimestamp()});}}return (await getDoc(uref)).data();}function updateHeaderUI(){const elGuest=$("#guest-actions");const elUser=$("#user-actions");const elHello=$("#menu-hello");const elHelloDetails=$("#menu-hello-details");if(currentUser&&currentUserProfile){elGuest?.classList.add("hidden");elUser?.classList.remove("hidden");$("#chip-id .val")?.replaceChildren(document.createTextNode(String(currentUserProfile.numericId||"")));$("#chip-balance .val")?.replaceChildren(document.createTextNode(String(currentUserProfile.balance??0)));$("#chip-title .val")?.replaceChildren(document.createTextNode(currentUserProfile.title||""));if(elHello)elHello.textContent="Salom! "+(currentUserProfile.displayName||"Foydalanuvchi");if(elHelloDetails)elHelloDetails.textContent=`Ball: ${currentUserProfile.points||0} â€¢ Unvon: ${currentUserProfile.title}`;}else{elGuest?.classList.remove("hidden");elUser?.classList.add("hidden");if(elHello)elHello.textContent="Salom! Mehmon";if(elHelloDetails)elHelloDetails.textContent="Kirish orqali imkoniyatlarni oching";}}export function refreshHeaderUI(){updateHeaderUI();}export function openModal(s){document.querySelector(s)?.classList.add("show");}export function closeModal(s){document.querySelector(s)?.classList.remove("show");}export async function signInWithGoogle(){try{if(/Mobi|Android/i.test(navigator.userAgent)){await signInWithRedirect(auth,provider);}else{await signInWithPopup(auth,provider);}}catch(e){alert("Google orqali kirishda xatolik: "+(e.message||e));}}export async function emailPasswordLogin(e,p){await signInWithEmailAndPassword(auth,e,p);}export async function emailPasswordRegister(n,e,p){const cred=await createUserWithEmailAndPassword(auth,e,p);if(n){await updateProfile(cred.user,{displayName:n});}}export async function doSignOut(){await signOut(auth);}onAuthStateChanged(auth,async(user)=>{currentUser=user||null;currentUserProfile=user?await ensureUserProfile(user):null;updateHeaderUI();const requiresAuth=document.body.dataset.requireAuth==="1";if(requiresAuth&&!currentUser){openModal("#loginModal");}});document.addEventListener("click",(e)=>{const t=e.target;if(!(t instanceof HTMLElement))return;if(t.closest("[data-open]")){const target=t.closest("[data-open]").getAttribute("data-open");if(target)openModal(target);}if(t.closest("[data-close]")){const target=t.closest("[data-close]").getAttribute("data-close");if(target)closeModal(target);}if(t.closest("#googleSignInBtn")){signInWithGoogle();}if(t.closest("#signOutBtn")){doSignOut();}});document.addEventListener("submit",async(e)=>{const f=e.target;if(!(f instanceof HTMLFormElement))return;if(f.matches("#loginForm")){e.preventDefault();try{await emailPasswordLogin(f.email.value.trim(),f.password.value);closeModal("#loginModal");}catch(err){alert("Kirishda xatolik: "+(err.message||err));}}if(f.matches("#registerForm")){e.preventDefault();try{await emailPasswordRegister(f.name.value.trim(),f.email.value.trim(),f.password.value);closeModal("#registerModal");}catch(err){alert("Ro'yxatdan o'tishda xatolik: "+(err.message||err));}}});