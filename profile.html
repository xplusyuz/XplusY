<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <title>Profil â€” XplusY.uz</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="firebase.js"></script>
</head>
<body>

  <!-- HEADER -->
  <div id="header"></div>

  <div class="container profile-page">
    <h2>ðŸ‘¤ Shaxsiy kabinet</h2>

    <form id="profileForm" class="profile-form">
      <!-- Avtomatik maydonlar -->
      <label>ID:</label>
      <input type="text" id="userId" disabled>

      <label>Ism:</label>
      <input type="text" id="firstName" disabled>

      <label>Familiya:</label>
      <input type="text" id="lastName" disabled>

      <label>Email (gmail):</label>
      <input type="email" id="email" disabled>

      <!-- Ball faqat koâ€˜rsatiladi -->
      <label>Ball:</label>
      <input type="number" id="points" disabled>

      <!-- Balans va qoâ€˜shish tugmasi -->
      <label>Balans:</label>
      <div style="display:flex;align-items:center;gap:10px;">
        <input type="number" id="balance" disabled>
        <button type="button" onclick="goBalance()">âž• Balans qoâ€˜shish</button>
      </div>

      <!-- Foydalanuvchi toâ€˜ldiradigan maydonlar -->
      <label>Sharif:</label>
      <input type="text" id="middleName">

      <label>Viloyat:</label>
      <input type="text" id="region">

      <label>Tuman/Shahar:</label>
      <input type="text" id="district">

      <label>Oâ€˜quvchi yoki Oâ€˜qituvchi:</label>
      <select id="role">
        <option value="oquvchi">Oâ€˜quvchi</option>
        <option value="oqituvchi">Oâ€˜qituvchi</option>
      </select>

      <label>Maktab:</label>
      <input type="text" id="school">

      <label>Telegram username:</label>
      <input type="text" id="telegram">

      <!-- Saqlash -->
      <button type="submit">ðŸ’¾ Saqlash</button>
    </form>
  </div>

  <!-- FOOTER -->
  <div id="footer"></div>

<script>
  // HEADER va FOOTER ulash
  fetch("header.html").then(r=>r.text()).then(d=>document.getElementById("header").innerHTML=d);
  fetch("footer.html").then(r=>r.text()).then(d=>document.getElementById("footer").innerHTML=d);

  // Foydalanuvchini olish (test uchun ID 100001)
  async function loadProfile(){
    const user = await getUser("100001");
    if(user){
      document.getElementById("userId").value = user.id;
      document.getElementById("firstName").value = user.first_name || "";
      document.getElementById("lastName").value = user.last_name || "";
      document.getElementById("email").value = user.email || "";
      document.getElementById("points").value = user.points || 0;
      document.getElementById("balance").value = user.balance || 0;

      // tahrirlanadiganlar
      document.getElementById("middleName").value = user.middle_name || "";
      document.getElementById("region").value = user.region || "";
      document.getElementById("district").value = user.district || "";
      document.getElementById("school").value = user.school || "";
      document.getElementById("telegram").value = user.telegram || "";
      document.getElementById("role").value = user.role || "oquvchi";
    }
  }

  // Saqlash
  document.getElementById("profileForm").addEventListener("submit", async (e)=>{
    e.preventDefault();

    const id = document.getElementById("userId").value;

    await db.collection("users").doc(id).update({
      middle_name: document.getElementById("middleName").value,
      region: document.getElementById("region").value,
      district: document.getElementById("district").value,
      role: document.getElementById("role").value,
      school: document.getElementById("school").value,
      telegram: document.getElementById("telegram").value,
      updated_at: firebase.firestore.FieldValue.serverTimestamp()
    });

    alert("âœ… Ma'lumotlar yangilandi!");
  });

  // Balans qoâ€˜shish sahifasiga oâ€˜tish
  function goBalance(){
    window.location.href = "balance.html";
  }

  loadProfile();
</script>

</body>
</html>
