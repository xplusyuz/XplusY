<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LeaderMath — Test</title>
  <link rel="icon" href="./favicon.ico">
  <script>
    window.MathJax = { tex:{ inlineMath:[['$','$'],['\\(','\\)']], displayMath:[['$$','$$'],['\\[','\\]']], processEscapes:true, packages:{'[+]':['noerrors']} }, options:{ renderActions:{ addMenu:[] } }, loader:{ load:['[tex]/noerrors'] } };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <style>
    :root{ --brand:#2E8B57; --brand2:#1F6B45; --bg:#f6faf8; --text:#0f172a; --frame:#e3efe8; --muted:#667a72 }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:960px;margin:0 auto;padding:14px}
    .card{background:#fff;border:1px solid var(--frame);border-radius:16px;padding:16px;margin:16px 0;box-shadow:0 8px 24px rgba(20,40,30,.06)}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--brand);background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;cursor:pointer;font-weight:700}
    .btn.ghost{background:#fff;color:var(--brand)}
    .hidden{display:none!important}
    .opt{display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border:1px solid #edf3ee;border-radius:12px;background:#fbfdfc;margin:8px 0}
    #qImage{width:min(860px,100%);display:block;margin:10px auto;border-radius:12px;border:1px solid #edf3ee;box-shadow:0 6px 18px rgba(31,107,69,.06);-webkit-user-drag:none;user-select:none}
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card" id="introCard">
      <h2 id="testTitle">Test</h2>
      <div id="testDesc" style="color:var(--muted)">Rasm + variantlar.</div>
      <div style="margin:8px 0">
        <span id="metaCount">Savollar: —</span> · <span id="metaPoints">Umumiy ball: —</span> · <span id="metaTimer" class="hidden">00:00</span>
      </div>
      <button id="startBtn" class="btn">Boshlash</button>
    </section>

    <section class="card hidden" id="questionsCard">
      <div style="display:flex;justify-content:space-between">
        <div><b id="qIndex">1</b>/<span id="qTotal">—</span></div>
        <div><button id="finishBtn" class="btn">Yakunlash</button></div>
      </div>
      <div id="qText" style="margin-top:8px"></div>
      <img id="qImage" alt="Savol rasmi">
      <div id="opts"></div>
    </section>

    <section class="card hidden" id="resultCard">
      <h3>Natija: <span id="scoreTotal">0</span>/<span id="scoreMax">0</span></h3>
      <div id="scoreNote" style="color:var(--muted)"></div>
      <button id="againBtn" class="btn ghost">Savollarga qaytish</button>
    </section>
  </main>

<script type="module">
  import { requireAuth } from "./lib/auth-guard.js";
  import { auth, db } from "./lib/firebase.client.js";
  import { doc, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const $ = s=>document.querySelector(s);
  const pad2 = n => String(Math.max(0,n)).padStart(2,'0');
  const sum = a => a.reduce((x,y)=>x+y,0);
  const isMulti = q => Array.isArray(q.correctIndices);
  const normalize = arr => Array.from(new Set((arr||[]).map(Number))).sort((a,b)=>a-b);
  const arraysEqual = (a,b)=> a.length===b.length && a.every((v,i)=>v===b[i]);
  async function typeset(el){ if(window.MathJax?.typesetPromise){ try{ await MathJax.typesetPromise([el]); }catch(_){} } }

  document.addEventListener('contextmenu', e=> e.preventDefault());
  document.addEventListener('dragstart', e=> e.preventDefault());

  await requireAuth();

  let testData=null, answers=[], currentIndex=0, timeLeft=0, timer=null;
  const testId = 'demo-test';

  function normalizeTestData(d){
    if(!d?.questions) return d;
    d.questions = d.questions.map(q=>({...q, points:Number(q.points||1)}));
    if(d.totalTime && !d.durationMinutes) d.durationMinutes = Number(d.totalTime);
    return d;
  }
  async function loadTest(){
    try{
      const r = await fetch('./test.json',{cache:'no-store'});
      if(!r.ok) throw 0;
      testData = normalizeTestData(await r.json());
    }catch{
      testData = normalizeTestData({
        title:'Demo test', description:'Fallback', durationMinutes:0,
        questions:[
          { text:"$2+2$ nechiga teng?", options:["2","3","4","5"], correctIndex:2, points:1 },
          { text:"Tub son(lar)ni belgilang.", options:["2","4","5","9"], correctIndices:[0,2], points:2 }
        ]
      });
    }
  }

  function renderQuestion(){
    const q = testData.questions[currentIndex];
    $('#qIndex').textContent = String(currentIndex+1);
    $('#qTotal').textContent = String(testData.questions.length);
    $('#qText').innerHTML = q.text || '';
    $('#opts').innerHTML = '';
    const chosen=new Set(answers[currentIndex]||[]);
    const multi=isMulti(q);
    q.options.forEach((opt,i)=>{
      const row=document.createElement('label'); row.className='opt';
      const inp=document.createElement('input'); inp.type=multi?'checkbox':'radio'; inp.name='q'; inp.value=String(i); inp.checked=chosen.has(i);
      inp.addEventListener('change',()=>{
        if(multi){ if(inp.checked) chosen.add(i); else chosen.delete(i); answers[currentIndex]=normalize([...chosen]); }
        else { answers[currentIndex]=inp.checked?[i]:[]; }
      });
      const sp=document.createElement('span'); sp.innerHTML=opt;
      row.appendChild(inp); row.appendChild(sp); $('#opts').appendChild(row);
    });
    const idx1=currentIndex+1;
    const jpg=`./${idx1}.jpg`, png=`./${idx1}.png`;
    const img=new Image(); img.onload=()=>$('#qImage').src=jpg; img.onerror=()=>{
      const img2=new Image(); img2.onload=()=>$('#qImage').src=png; img2.onerror=()=>$('#qImage').src=(q.image||'');
      img2.src=png+'?t='+Date.now();
    }; img.src=jpg+'?t='+Date.now();
    typeset($('#questionsCard'));
  }

  function startTimer(){
    const m=Number(testData.durationMinutes||0);
    if(!m){ $('#metaTimer').classList.add('hidden'); return; }
    timeLeft=Math.round(m*60); $('#metaTimer').classList.remove('hidden');
    const upd=()=>{ const mm=String(Math.floor(timeLeft/60)).padStart(2,'0'), ss=String(timeLeft%60).padStart(2,'0'); $('#metaTimer').textContent=mm+':'+ss; };
    upd();
    timer=setInterval(()=>{ timeLeft--; upd(); if(timeLeft<=0){ clearInterval(timer); finish(); } },1000);
  }

  function compute(){
    let total=0,max=0; const rows=[];
    testData.questions.forEach((q,i)=>{
      const pts=Number(q.points||1); max+=pts;
      const picked=normalize(answers[i]||[]);
      const correct=isMulti(q)?normalize(q.correctIndices||[]):[Number(q.correctIndex??-1)];
      const ok=isMulti(q)?arraysEqual(picked,correct):(picked.length===1 && picked[0]===correct[0]);
      if(ok) total+=pts;
      rows.push({i,pts,ok,picked,correct});
    });
    return {total,max,rows};
  }

  async function saveFirst({total,max,rows}){
    const user = auth.currentUser; if(!user) return;
    const ref = doc(db,'results',testId,'users',user.uid);
    return runTransaction(db, async (tx)=>{
      const snap = await tx.get(ref);
      if(snap.exists()) return {skipped:true};
      tx.set(ref,{uid:user.uid,testId,firstTotal:total,max,detail:rows,createdAt:serverTimestamp()});
      return {skipped:false};
    });
  }

  async function finish(){
    const {total,max,rows}=compute();
    $('#questionsCard').classList.add('hidden');
    $('#resultCard').classList.remove('hidden');
    $('#scoreTotal').textContent=String(total);
    $('#scoreMax').textContent=String(max);
    $('#scoreNote').textContent=`To‘g‘ri: ${rows.filter(r=>r.ok).length} / ${rows.length}`;
    try{ await saveFirst({total,max,rows}); }catch(e){ console.error(e); }
  }

  async function boot(){
    await loadTest();
    $('#testTitle').textContent=testData.title||'Test';
    $('#testDesc').textContent=testData.description||'';
    $('#metaCount').textContent='Savollar: '+testData.questions.length;
    $('#metaPoints').textContent='Umumiy ball: '+(testData.questions.map(q=>q.points).reduce((a,b)=>a+b,0));
    answers=Array.from({length:testData.questions.length},()=>[]);
    $('#startBtn').onclick=()=>{ $('#introCard').classList.add('hidden'); $('#questionsCard').classList.remove('hidden'); renderQuestion(); startTimer(); };
    $('#finishBtn').onclick=finish;
    $('#againBtn').onclick=()=>{ $('#resultCard').classList.add('hidden'); $('#questionsCard').classList.remove('hidden'); };
  }
  boot();
</script>
</body>
</html>
