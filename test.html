<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Testlar</title>
  <style>
    :root{
      --bg:#041f12;--card:#0a2e1b;--accent:#23d08f;--text:#f2fff7;--muted:#b8e1c6;--danger:#ff5a5f;--warn:#ffb703;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1000px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;gap:10px;padding:12px 0}
    header h1{font-size:20px;margin:0}
    .pill{padding:6px 10px;border:1px solid #1b4f33;border-radius:999px;background:#08361f;color:var(--muted)}

    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid #0f3d24;border-radius:16px;overflow:hidden;display:flex;flex-direction:column}
    .card img{width:100%;height:140px;object-fit:cover;background:#062015}
    .card .body{padding:12px;display:flex;flex-direction:column;gap:8px}
    .title{font-weight:700}
    .meta{color:var(--muted);font-size:13px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .btn{appearance:none;border:1px solid #145a37;background:#0e3a22;color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#052114;border-color:#23d08f;font-weight:700}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .hidden{display:none !important}

    /* Test sahifasi */
    .topbar{position:sticky;top:0;background:linear-gradient(180deg,#062315,#062315ee);padding:10px;border-bottom:1px solid #0f3d24;z-index:5}
    .topbar .timer{font-weight:800}
    .progress{height:6px;border-radius:999px;background:#0a2e1b;border:1px solid #124f31;overflow:hidden}
    .progress>div{height:100%;background:var(--accent);width:0%}

    .qwrap{display:grid;grid-template-columns:1fr;gap:14px;margin-top:12px}
    .qimg{width:100%;max-height:240px;object-fit:contain;background:#062015;border:1px solid #0f3d24;border-radius:12px}
    .qtext{padding:12px;border:1px solid #0f3d24;border-radius:12px;background:#0a2e1b}

    .choices{display:grid;gap:10px}
    .choice{border:1px solid #0f3d24;border-radius:12px;padding:10px;background:#0a2e1b;display:flex;gap:10px;align-items:flex-start}
    .choice input{margin-top:4px}

    .navs{display:flex;gap:10px;justify-content:space-between;margin-top:12px}

    .notice{padding:10px;border:1px dashed #1d6c43;border-radius:12px;background:#072617;color:var(--muted)}
    .danger{color:#ffecec;background:#320a0a;border-color:#6b1212}

    .table{width:100%;border-collapse:separate;border-spacing:0 8px}
    .table th,.table td{padding:10px;border:1px solid #0f3d24}
    .table th{background:#08361f}
    .table td{background:#0a2e1b}

    dialog{border:1px solid #125633;background:#082816;color:var(--text);border-radius:14px;padding:0;max-width:420px}
    dialog::backdrop{background:rgba(0,0,0,.6)}
    .dlg-head{padding:12px 14px;border-bottom:1px solid #0f3d24;font-weight:700}
    .dlg-body{padding:12px 14px;display:flex;flex-direction:column;gap:8px}
    .dlg-actions{display:flex;gap:8px;justify-content:flex-end;padding:12px 14px;border-top:1px solid #0f3d24}
  </style>
  <!-- MathJax (TeX) -->
  <script>
    window.MathJax = { tex: {inlineMath: [['$','$'], ['\(','\)']]}, svg:{fontCache:'global'} };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" async></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üßÆ Testlar</h1>
      <div id="userBadge" class="pill">Kirish talab qilinadi</div>
    </header>

    <!-- Katalog -->
    <section id="catalog" class="screen">
      <div class="notice" id="dirNote">
        <b>Eslatma:</b> Brauzer katalog ichidagi fayllarni avtomatik sanay olmaydi.
        Shu sabab <code>tests.csv</code> orqali ro‚Äòyxat keladi. Har bir testning kartasi bevosita o‚Äòsha test CSV faylidan olinadi.
      </div>
      <div class="grid" id="cards"></div>
    </section>

    <!-- Test -->
    <section id="test" class="screen hidden">
      <div class="topbar">
        <div class="row">
          <div><b id="testTitle">‚Äî</b></div>
          <div class="timer" id="timer">00:00</div>
        </div>
        <div class="progress"><div id="progressBar"></div></div>
      </div>

      <div class="qwrap">
        <img id="qimg" class="qimg hidden" alt="savol rasmi" />
        <div id="qtext" class="qtext">‚Äî</div>
        <div id="choices" class="choices"></div>
        <div class="navs">
          <button class="btn" id="prevBtn">‚¨ÖÔ∏è Oldingi</button>
          <div style="display:flex;gap:8px">
            <button class="btn ghost" id="catalogBtn">üìö Katalog</button>
            <button class="btn" id="nextBtn">Keyingi ‚û°Ô∏è</button>
            <button class="btn primary" id="finishBtn">‚úÖ Yakunlash</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Natija -->
    <section id="result" class="screen hidden">
      <h2>üìà Natija</h2>
      <div id="summary" class="notice"></div>
      <h3>Savol tahlili</h3>
      <table class="table" id="detailTable"></table>
      <div style="margin-top:12px">
        <button class="btn" id="backToCatalog">‚¨ÖÔ∏è Katalogga qaytish</button>
      </div>
    </section>
  </div>

  <!-- Tasdiq dialog -->
  <dialog id="confirmDlg">
    <div class="dlg-head">To‚Äòlov tasdiqlanishi</div>
    <div class="dlg-body" id="confirmBody"></div>
    <div class="dlg-actions">
      <button class="btn" id="cancelPay">Bekor qilish</button>
      <button class="btn primary" id="okPay">Tasdiqlayman</button>
    </div>
  </dialog>

  <script type="module">
    // ===== Firebase (v10) =====
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, runTransaction, serverTimestamp, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const fbConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.appspot.com",
      messagingSenderId: "992512966017",
      appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId: "G-459PLJ7P7L"
    };
    if (!getApps().length) initializeApp(fbConfig);
    const auth = getAuth();
    const db = getFirestore();

    // ====== Elements ======
    const screens = {
      catalog: document.getElementById('catalog'),
      test: document.getElementById('test'),
      result: document.getElementById('result')
    };
    const cardsEl = document.getElementById('cards');
    const userBadge = document.getElementById('userBadge');

    const testTitle = document.getElementById('testTitle');
    const qimg = document.getElementById('qimg');
    const qtext = document.getElementById('qtext');
    const choicesEl = document.getElementById('choices');
    const timerEl = document.getElementById('timer');
    const progressBar = document.getElementById('progressBar');

    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const finishBtn = document.getElementById('finishBtn');
    const catalogBtn = document.getElementById('catalogBtn');

    const summaryEl = document.getElementById('summary');
    const detailTable = document.getElementById('detailTable');
    const backToCatalog = document.getElementById('backToCatalog');

    const confirmDlg = document.getElementById('confirmDlg');
    const confirmBody = document.getElementById('confirmBody');
    const cancelPay = document.getElementById('cancelPay');
    const okPay = document.getElementById('okPay');

    // ====== State ======
    let currentUser = null; // Firebase user
    let userDocRef = null;  // /users/{uid}
    let userData = null;    // cached doc data

    let manifest = [];      // [{file}]
    let catalogItems = [];  // [{file, card_img, card_title, card_meta, price_som, time_min}]

    let test = null;        // {title, price_som, time_min, questions: [...]}
    let answers = [];       // ['a'|'b'|'c'|'d'|null]
    let idx = 0;            // current question index
    let deadline = 0;       // timestamp ms
    let ticker = null;      // setInterval id

    // ===== Helpers =====
    const fmtSom = v => new Intl.NumberFormat('uz-UZ').format(v) + ' so\'m';
    const fmtMinSec = (sec) => {
      const m = Math.floor(sec/60).toString().padStart(2,'0');
      const s = Math.floor(sec%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    };

    function parseCSV(text){
      // Minimal CSV parser with quotes support
      const rows=[]; let row=[]; let cell=''; let inQ=false;
      for(let i=0;i<text.length;i++){
        const c=text[i];
        if(inQ){
          if(c=='"'){
            if(text[i+1]=='"'){cell+='"'; i++;} else {inQ=false;}
          } else cell+=c;
        } else {
          if(c=='"') inQ=true;
          else if(c==','){row.push(cell.trim()); cell='';}
          else if(c=='\n' || c=='\r'){
            if(cell!=='' || row.length){row.push(cell.trim()); rows.push(row); row=[]; cell='';}
          } else cell+=c;
        }
      }
      if(cell!=='' || row.length){row.push(cell.trim()); rows.push(row);} 
      return rows.filter(r=>r.length && r.some(v=>v!==''));
    }

    function rowsToObjects(rows){
      const header = rows[0].map(h=>h.trim());
      return rows.slice(1).map(r=>{
        const o={}; header.forEach((h,i)=>o[h]=r[i]??''); return o;
      });
    }

    function show(screen){
      Object.values(screens).forEach(el=>el.classList.add('hidden'));
      screens[screen].classList.remove('hidden');
      if (screen==='test') MathJax?.typesetPromise?.();
    }

    function progress(){
      const p = ((idx)/(test.questions.length))*100; 
      progressBar.style.width = p+"%";
    }

    function renderCatalog(){
      cardsEl.innerHTML='';
      catalogItems.forEach(item=>{
        const card=document.createElement('div');
        card.className='card';
        const img=document.createElement('img'); img.src=item.card_img||''; img.alt='banner';
        const body=document.createElement('div'); body.className='body';
        const title=document.createElement('div'); title.className='title'; title.textContent=item.card_title||'Nomsiz test';
        const meta=document.createElement('div'); meta.className='meta'; meta.textContent=item.card_meta||'';
        const row=document.createElement('div'); row.className='row';
        const price=document.createElement('div'); price.className='pill'; price.textContent=fmtSom(+item.price_som||0);
        const time=document.createElement('div'); time.className='pill'; time.textContent=(+item.time_min||0)+' daq';
        const row2=document.createElement('div'); row2.className='row';
        const start=document.createElement('button'); start.className='btn primary'; start.textContent='Boshlash';
        start.onclick=()=>startFlow(item);
        const open=document.createElement('a'); open.className='btn'; open.textContent='Ko‚Äòrish';
        open.href=`${location.pathname}?src=${encodeURIComponent(item.file)}`;
        row.append(price,time); row2.append(open,start);
        body.append(title,meta,row,row2);
        card.append(img,body); cardsEl.append(card);
      });
    }

    // ===== Loading tests list =====
    async function loadManifest(){
      // supports ?manifest=/path/to/tests.csv ; default ./tests.csv
      const u = new URL(location.href);
      const manifestPath = u.searchParams.get('manifest') || 'tests.csv';
      const res = await fetch(manifestPath);
      if(!res.ok) throw new Error('tests.csv topilmadi');
      const rows = parseCSV(await res.text());
      const objs = rowsToObjects(rows);
      // manifest minimal: {file}
      manifest = objs.map(o=>({file:o.file?.trim()})).filter(o=>o.file);
    }

    async function hydrateCatalogFromEachCSV(){
      catalogItems = [];
      for(const m of manifest){
        try{
          const res = await fetch(m.file);
          if(!res.ok) continue;
          const rows = parseCSV(await res.text());
          if(!rows.length) continue;
          const metaRow = rows[0];
          // First row is meta (no header): card_img, card_title, card_meta, price_som, time_min
          const [card_img, card_title, card_meta, price_som, time_min] = metaRow;
          catalogItems.push({file:m.file, card_img, card_title, card_meta, price_som, time_min});
        }catch(e){console.warn('CSV o‚Äòqishda xato', m.file, e)}
      }
      renderCatalog();
    }

    // ===== Test CSV -> structure =====
    function parseTestCSV(text){
      const rows = parseCSV(text);
      if(rows.length<3) throw new Error('CSV format noto‚Äòg‚Äòri: kamida 3 qator');
      const [card_img, card_title, card_meta, price_som, time_min] = rows[0];
      const header = rows[1].map(h=>h.trim().toLowerCase());
      const qrows = rows.slice(2);
      const get = (obj, key) => obj[header.indexOf(key)] ?? '';

      const questions = qrows.map(r=>{
        const obj = header.reduce((a,h,i)=>{a[h]=r[i]??''; return a;},{});
        const q_img = get(r,'q_img') || get(r,'img') || '';
        const q_text= get(r,'q_text')|| get(r,'savol matni')|| get(r,'question')||'';
        const a = get(r,'a');
        const b = get(r,'b');
        const c = get(r,'c');
        const d = get(r,'d');
        const correct = (get(r,'correct')||'a').toLowerCase(); // agar yo‚Äòq bo‚Äòlsa A to‚Äòg‚Äòri
        const olmos = parseInt(get(r,'olmos')||'0',10)||0;
        const penalty = parseFloat(get(r,'penalty_olmos')||get(r,'-olmos')||'0')||0;
        return {q_img, q_text, choices:{a,b,c,d}, correct, olmos, penalty};
      });
      return {
        title: card_title||'Nomsiz test', price_som: +price_som||0, time_min: +time_min||0, card_img, card_meta, questions
      };
    }

    function renderQuestion(){
      const q = test.questions[idx];
      testTitle.textContent = `${test.title} ‚Äî ${idx+1}/${test.questions.length}`;
      qimg.classList.add('hidden');
      if(q.q_img){ qimg.src=q.q_img; qimg.classList.remove('hidden'); }
      qtext.innerHTML = q.q_text || '‚Äî';

      choicesEl.innerHTML='';
      ['a','b','c','d'].forEach(letter=>{
        const div=document.createElement('label'); div.className='choice';
        const input=document.createElement('input'); input.type='radio'; input.name='ans'; input.value=letter;
        input.checked = answers[idx]===letter;
        input.onchange = ()=>{ answers[idx]=letter; };
        const span=document.createElement('div'); span.innerHTML = `<b>${letter.toUpperCase()}.</b> ` + (q.choices[letter]||'');
        div.append(input, span); choicesEl.append(div);
      });
      prevBtn.disabled = idx===0;
      nextBtn.disabled = idx===test.questions.length-1;
      progress();
      MathJax?.typesetPromise?.([qtext, choicesEl]);
    }

    function startTimer(){
      clearInterval(ticker);
      const totalSec = test.time_min*60;
      deadline = Date.now() + totalSec*1000;
      ticker=setInterval(()=>{
        const left = Math.max(0, Math.floor((deadline-Date.now())/1000));
        timerEl.textContent = fmtMinSec(left);
        if(left<=0){ clearInterval(ticker); finish(); }
      }, 250);
    }

    async function startFlow(item){
      // Agar URL ?src= mavjud bo‚Äòlsa ham shu yo‚Äòl bilan boshlaymiz
      try{
        // 1) Test CSV ni yuklash
        const res = await fetch(item.file);
        if(!res.ok) throw new Error('Test CSV topilmadi');
        test = parseTestCSV(await res.text());

        // 2) To‚Äòlov tasdiqlash (Firebase balansidan yechish)
        if(!currentUser){
          alert('Kirish talab qilinadi. Iltimos, asosiy saytda avval tizimga kiring.');
          return;
        }
        const price = test.price_som || +item.price_som || 0;
        confirmBody.innerHTML = `
          <div><b>${test.title}</b></div>
          <div class="meta">Narx: <b>${fmtSom(price)}</b></div>
          <div class="notice">Balansdan ushbu summa yechiladi va test boshlanadi.</div>
        `;
        confirmDlg.showModal();

        const onCancel = () => confirmDlg.close();
        const onOk = async () => {
          cancelPay.removeEventListener('click', onCancel);
          okPay.removeEventListener('click', onOk);
          confirmDlg.close();

          // Transaction: balance - price, lastPurchase, attempts++
          await runTransaction(db, async (tx)=>{
            const snap = await tx.get(userDocRef);
            if(!snap.exists()) throw new Error('User doc yo‚Äòq');
            const data = snap.data();
            const balance = +data.balance||0;
            if(balance < price) throw new Error('Balans yetarli emas');
            tx.update(userDocRef, { balance: balance - price, lastPurchase: serverTimestamp() });
          });

          // 3) Testni boshlash
          answers = Array(test.questions.length).fill(null);
          idx = 0; show('test'); renderQuestion(); startTimer();
        };
        cancelPay.addEventListener('click', onCancel, {once:true});
        okPay.addEventListener('click', onOk, {once:true});

      }catch(e){
        alert('Boshlashda xato: '+ e.message);
      }
    }

    function finish(){
      // Hisoblash
      let correct=0, wrong=0, empty=0, olmosGain=0, olmosLoss=0;
      const rows=[["#", "Savol", "Sizning javob", "To‚Äòg‚Äòri", "Olmos"]];

      test.questions.forEach((q,i)=>{
        const ans = answers[i];
        if(!ans){empty++; rows.push([i+1, '‚Äî', '‚Äî', q.correct.toUpperCase(), 0]); return;}
        if(ans===q.correct){
          correct++; olmosGain += q.olmos||0; rows.push([i+1, '‚Äî', ans.toUpperCase(), q.correct.toUpperCase(), "+"+(q.olmos||0)]);
        } else {
          wrong++; olmosLoss += q.penalty||0; rows.push([i+1, '‚Äî', ans.toUpperCase(), q.correct.toUpperCase(), q.penalty? ("-"+q.penalty): 0]);
        }
      });
      const netOlmos = (olmosGain - olmosLoss) | 0;

      // UI natija
      summaryEl.innerHTML = `
        <div><b>${test.title}</b></div>
        <div>To‚Äòg‚Äòri: <b>${correct}</b> | Xato: <b>${wrong}</b> | Bo‚Äòsh: <b>${empty}</b></div>
        <div>Yig‚Äòilgan olmos: <b>+${olmosGain}</b>${olmosLoss?`, jarima: <b>-${olmosLoss}</b>`:''}</div>
        <div class="${netOlmos>=0?'':'danger notice'}">Sof olmos: <b>${netOlmos>=0?'+':''}${netOlmos}</b></div>
      `;

      // Detal jadval
      const html = rows.map((r,ri)=>{
        if(ri===0) return `<tr><th>${r.join('</th><th>')}</th></tr>`;
        return `<tr><td>${r.map(c=>String(c)).join('</td><td>')}</td></tr>`;
      }).join('');
      detailTable.innerHTML = html;

      show('result');
      clearInterval(ticker);

      // Olmosni yozish (agar foydalanuvchi bor bo‚Äòlsa)
      if(currentUser && netOlmos){
        updateDoc(userDocRef, { gems: increment(netOlmos) }).catch(()=>{});
      }
    }

    // ===== Events =====
    prevBtn.onclick = ()=>{ if(idx>0){ idx--; renderQuestion(); } };
    nextBtn.onclick = ()=>{ if(idx<test.questions.length-1){ idx++; renderQuestion(); } };
    finishBtn.onclick = ()=>{
      if(confirm('Testni yakunlaysizmi?')) finish();
    };
    catalogBtn.onclick = ()=>{ clearInterval(ticker); show('catalog'); };
    backToCatalog.onclick = ()=>{ show('catalog'); };

    // ===== Auth state (kirish UI qo‚Äòshmaymiz: asosiy saytga tayanadi) =====
    onAuthStateChanged(auth, async (u)=>{
      currentUser = u||null;
      if(u){
        userBadge.textContent = `ID: ${u.uid.slice(0,8)}...`;
        userDocRef = doc(db, 'users', u.uid);
        const s = await getDoc(userDocRef);
        userData = s.exists()? s.data(): null;
        if(userData && typeof userData.numericId!== 'undefined'){
          userBadge.textContent = `ID: ${userData.numericId} | Balans: ${fmtSom(+userData.balance||0)} | üíé ${+userData.gems||0}`;
        }
      }else{
        userBadge.textContent = 'Kirish talab qilinadi';
      }
    });

    // ===== Entry: katalog yoki bevosita test =====
    (async function init(){
      const u = new URL(location.href);
      const directSrc = u.searchParams.get('src');
      try{
        if(directSrc){
          // bevosita testga (oldingi link formatini qo‚Äòllab-quvvatlash)
          await startFlow({file: directSrc});
        } else {
          await loadManifest();
          await hydrateCatalogFromEachCSV();
          show('catalog');
        }
      }catch(e){
        document.getElementById('dirNote').classList.add('danger');
        document.getElementById('dirNote').innerHTML = 'Xato: '+e.message + '<br>Manzil: <code>'+location.href+'</code>';
      }
    })();
  </script>
</body>
</html>
