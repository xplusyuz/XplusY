<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Header & Footer Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #19b36b;
      --text: #0b1f17;
      --bg: #f2f8f5;
    }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 16px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:16px; box-shadow: 0 12px 28px rgba(0,0,0,.06); padding:16px; }
    h1 { margin: 0 0 16px; }
    input, select, textarea { width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(0,0,0,.12); }
    .btn { padding: 10px 14px; border-radius: 12px; border:none; cursor:pointer; }
    .btn.primary { background: var(--primary); color:#fff; }
    .stack { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .muted { opacity:.75; }
    .menu-item { display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:8px; align-items:center; }
    .menu-item button { padding:8px 10px; }
    .pill { padding:6px 10px; border-radius:999px; background:#fff; border:1px solid rgba(0,0,0,.08);}
    @media (max-width: 900px) {
      .row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Header & Footer Admin</h1>
    <div class="stack">
      <span id="authInfo" class="pill">Kirmagansiz</span>
      <button id="loginBtn" class="btn">Google bilan kirish</button>
      <button id="logoutBtn" class="btn" style="display:none">Chiqish</button>
      <button id="saveFirestore" class="btn primary" style="display:none">Firestore-ga saqlash</button>
      <button id="exportJson" class="btn">JSON eksport</button>
      <label class="btn">
        JSON import
        <input id="importJson" type="file" accept=".json" hidden/>
      </label>
    </div>
    <p class="muted">Bu sahifa orqali saytning kirish tizimi, menyu va profil shablonlarini to'liq tahrirlaysiz. Firestore yozish faqat adminlarga ruxsat.</p>

    <div class="row">
      <div class="card">
        <h3>Brand / Mavzu</h3>
        <label>Logo matni <input id="logoText"/></label><br><br>
        <label>Logo sarlavhasi <input id="logoSub"/></label><br><br>
        <label>Logo link <input id="logoHref"/></label><br><br>
        <div class="row">
          <div><label>Primary rang <input id="cPrimary" type="color"/></label></div>
          <div><label>Primary dark <input id="cPrimaryDark" type="color"/></label></div>
          <div><label>Accent <input id="cAccent" type="color"/></label></div>
          <div><label>Matn rangi <input id="cText" type="color"/></label></div>
        </div>
      </div>

      <div class="card">
        <h3>Profil Header</h3>
        <label>Ko'rsatilsinmi?
          <select id="profileShow">
            <option value="true">Ha</option>
            <option value="false">Yo'q</option>
          </select>
        </label><br><br>
        <label>Format
          <input id="profileFormat" placeholder="Salom, {name}! ID: {id} • Balans: {balans} • Ball: {ball}"/>
        </label>
      </div>

      <div class="card">
        <h3>Menyu</h3>
        <div id="menuList"></div>
        <button id="addMenu" class="btn">+ Element qo'shish</button>
      </div>

      <div class="card">
        <h3>Footer</h3>
        <div id="footerList"></div>
        <button id="addFoot" class="btn">+ Havola qo'shish</button>
        <br><br>
        <label>Mualliflik matni <input id="copyTxt"/></label>
      </div>

      <div class="card">
        <h3>Adminlar</h3>
        <label>Admin email-lar (vergul bilan) <textarea id="adminEmails" rows="3"></textarea></label>
      </div>

      <div class="card">
        <h3>JSON</h3>
        <textarea id="raw" rows="18" spellcheck="false" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></textarea>
        <div class="stack" style="margin-top:8px">
          <button id="applyRaw" class="btn">JSON qo'llash</button>
          <button id="refreshRaw" class="btn">Yuklab olish</button>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {"apiKey": "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM", "authDomain": "xplusy-760fa.firebaseapp.com", "projectId": "xplusy-760fa", "storageBucket": "xplusy-760fa.firebasestorage.app", "messagingSenderId": "992512966017", "appId": "1:992512966017:web:5e919dbc9b8d8abcb43c80", "measurementId": "G-459PLJ7P7L"};
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const ui = {
    authInfo: document.getElementById("authInfo"),
    login: document.getElementById("loginBtn"),
    logout: document.getElementById("logoutBtn"),
    saveFs: document.getElementById("saveFirestore"),
    exportJson: document.getElementById("exportJson"),
    importJson: document.getElementById("importJson"),

    logoText: document.getElementById("logoText"),
    logoSub: document.getElementById("logoSub"),
    logoHref: document.getElementById("logoHref"),
    cPrimary: document.getElementById("cPrimary"),
    cPrimaryDark: document.getElementById("cPrimaryDark"),
    cAccent: document.getElementById("cAccent"),
    cText: document.getElementById("cText"),

    profileShow: document.getElementById("profileShow"),
    profileFormat: document.getElementById("profileFormat"),

    menuList: document.getElementById("menuList"),
    addMenu: document.getElementById("addMenu"),

    footerList: document.getElementById("footerList"),
    addFoot: document.getElementById("addFoot"),
    copyTxt: document.getElementById("copyTxt"),

    adminEmails: document.getElementById("adminEmails"),

    raw: document.getElementById("raw"),
    applyRaw: document.getElementById("applyRaw"),
    refreshRaw: document.getElementById("refreshRaw"),
  };

  let cfg = null;
  function isAdmin(user, c) {
    const emails = (c?.admins?.emails||[]).map(x=>x.toLowerCase());
    return !!user && emails.includes((user.email||"").toLowerCase());
  }

  async function loadConfig() {
    try {
      const snap = await getDoc(doc(db, "meta", "header_footer"));
      if (snap.exists()) return snap.data();
    } catch(e) { console.warn("No Firestore config", e); }
    try {
      const resp = await fetch("headerfooteradmin.json", {cache: "no-store"});
      if (resp.ok) return await resp.json();
    } catch(e) { console.warn("No local JSON", e); }
    return {"theme": {"primary": "#19b36b", "primaryDark": "#118654", "accent": "#A0EBC5", "text": "#0b1f17", "graniteBg": "#f2f8f5"}, "brand": {"logoText": "\u03c0 XplusY", "logoSubtitle": "MathCenter", "logoHref": "/"}, "menu": [{"title": "Bosh sahifa", "href": "index.html", "icon": "home"}, {"title": "Testlar", "href": "tests.html", "icon": "check-square"}, {"title": "Kurslar", "href": "courses.html", "icon": "book-open"}, {"title": "Simulyator", "href": "simulators.html", "icon": "cpu"}, {"title": "Natijalar", "href": "results.html", "icon": "bar-chart-2"}, {"title": "Profil", "href": "profile.html", "icon": "user"}], "auth": {"enabled": true, "requireProfileComplete": true}, "profileHeader": {"show": true, "format": "Salom, {name}! ID: {id} \u2022 Balans: {balans} \u2022 Ball: {ball}"}, "admins": {"uids": ["1000001", "1000002"], "emails": ["admin@xplusy.uz"]}, "footer": {"links": [{"title": "Yordam", "href": "help.html"}, {"title": "Qoidalar", "href": "rules.html"}, {"title": "Aloqa", "href": "contact.html"}], "copyright": "\u00a9 2025 XplusY MathCenter"}};
  }

  function render() {
    ui.logoText.value = cfg.brand?.logoText || "";
    ui.logoSub.value = cfg.brand?.logoSubtitle || "";
    ui.logoHref.value = cfg.brand?.logoHref || "";
    ui.cPrimary.value = cfg.theme?.primary || "#19b36b";
    ui.cPrimaryDark.value = cfg.theme?.primaryDark || "#118654";
    ui.cAccent.value = cfg.theme?.accent || "#A0EBC5";
    ui.cText.value = cfg.theme?.text || "#0b1f17";
    ui.profileShow.value = String(cfg.profileHeader?.show ?? true);
    ui.profileFormat.value = cfg.profileHeader?.format || "";
    ui.menuList.innerHTML = "";
    (cfg.menu||[]).forEach((m,i)=> addMenuRow(m, i));
    ui.footerList.innerHTML = "";
    (cfg.footer?.links||[]).forEach((f,i)=> addFootRow(f, i));
    ui.copyTxt.value = cfg.footer?.copyright || "";
    ui.adminEmails.value = (cfg.admins?.emails||[]).join(", ");
    ui.raw.value = JSON.stringify(cfg, null, 2);
  }

  function addMenuRow(m, i){
    const row = document.createElement("div");
    row.className = "menu-item";
    row.innerHTML = `
      <input placeholder="Sarlavha" value="${m.title||""}"/>
      <input placeholder="Havola" value="${m.href||""}"/>
      <input placeholder="Ikonka (lucide nomi)" value="${m.icon||""}"/>
      <button class="btn" data-action="del">O'chirish</button>
    `;
    row.querySelector('[data-action="del"]').onclick = () => { cfg.menu.splice(i,1); render(); };
    ui.menuList.appendChild(row);
    const [t,h,ic] = row.querySelectorAll("input");
    t.oninput = () => cfg.menu[i].title = t.value;
    h.oninput = () => cfg.menu[i].href = h.value;
    ic.oninput = () => cfg.menu[i].icon = ic.value;
  }
  function addFootRow(f, i){
    const row = document.createElement("div");
    row.className = "menu-item";
    row.innerHTML = `
      <input placeholder="Sarlavha" value="${f.title||""}"/>
      <input placeholder="Havola" value="${f.href||""}"/>
      <div></div>
      <button class="btn" data-action="del">O'chirish</button>
    `;
    row.querySelector('[data-action="del"]').onclick = () => { cfg.footer.links.splice(i,1); render(); };
    ui.footerList.appendChild(row);
    const [t,h] = row.querySelectorAll("input");
    t.oninput = () => cfg.footer.links[i].title = t.value;
    h.oninput = () => cfg.footer.links[i].href = h.value;
  }

  ui.addMenu.onclick = () => { cfg.menu.push({title:"Yangi", href:"#", icon:"circle"}); render(); };
  ui.addFoot.onclick = () => { cfg.footer.links.push({title:"Yangi", href:"#"}); render(); };

  ui.applyRaw.onclick = () => { try { cfg = JSON.parse(ui.raw.value); render(); } catch(e) { alert("JSON xato: "+e.message); } };
  ui.refreshRaw.onclick = () => ui.raw.value = JSON.stringify(cfg, null, 2);

  ui.exportJson.onclick = () => {
    const blob = new Blob([JSON.stringify(cfg, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "headerfooteradmin.json";
    a.click();
    URL.revokeObjectURL(a.href);
  };
  ui.importJson.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const txt = await file.text();
    try { cfg = JSON.parse(txt); render(); }
    catch(e) { alert("JSON xato: "+e.message); }
    e.target.value = "";
  };

  ui.login.onclick = async () => { await signInWithPopup(auth, new GoogleAuthProvider()); }
  ui.logout.onclick = async () => { await signOut(auth); }

  ui.saveFs.onclick = async () => {
    try {
      await setDoc(doc(db, "meta", "header_footer"), cfg, {merge:false});
      alert("Firestore-ga saqlandi ✅");
    } catch(e) { alert("Saqlashda xato: "+e.message); }
  };

  onAuthStateChanged(auth, async (user) => {
    cfg = await loadConfig();
    render();
    if (user) {
      document.getElementById("authInfo").textContent = user.email || user.uid;
      document.getElementById("loginBtn").style.display = "none";
      document.getElementById("logoutBtn").style.display = "inline-block";
      document.getElementById("saveFirestore").style.display = isAdmin(user, cfg) ? "inline-block" : "none";
    } else {
      document.getElementById("authInfo").textContent = "Kirmagansiz";
      document.getElementById("loginBtn").style.display = "inline-block";
      document.getElementById("logoutBtn").style.display = "none";
      document.getElementById("saveFirestore").style.display = "none";
    }
  });
</script>
</body>
</html>
