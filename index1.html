<!doctype html>
<html lang="uz">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LeaderMath — Mobil</title>
<meta name="theme-color" content="#2E8B57"/>
<link rel="manifest" href="./manifest.webmanifest"/>
<link rel="icon" href="./favicon.ico"/>
<style>
:root{
 --brand:#2E8B57;--brand2:#1F6B45;
 --bg:#f4f8f6;--card:#fff;--text:#0d1b14;--muted:#324e41;
 --frame:#d8e7dd;--chip:#e9f5ef;--chip-b:#b9dfc9;
}
:root.dark{
 --bg:#0e1512;--card:#142018;--text:#EAF7EE;--muted:#A5C7B4;
 --frame:#204030;--chip:#183323;--chip-b:#25573b;
}
body{
 margin:0;
 font-family:Inter,system-ui;
 background:var(--bg);
 color:var(--text);
 line-height:1.6;
}
.appbar{
 background:linear-gradient(135deg,var(--brand),var(--brand2));
 color:#fff;
 padding:10px 14px;
 display:flex;
 align-items:center;
 gap:10px;
 position:sticky;
 top:0;
 z-index:100;
 box-shadow:0 2px 10px rgba(0,0,0,0.1);
}
.logo{
 width:40px;
 height:40px;
 border-radius:12px;
 background:#fff2;
 display:grid;
 place-items:center;
 font-weight:800;
 font-size:20px;
}
.title{
 font-size:18px;
 font-weight:800;
}
.iconbtn{
 margin-left:auto;
 border:none;
 background:#ffffff33;
 color:#fff;
 border-radius:10px;
 padding:6px 10px;
 cursor:pointer;
 transition:all 0.2s ease;
}
.iconbtn:hover{
 background:#ffffff55;
 transform:scale(1.05);
}

/* Banner carousel */
.banner-container {
 position:relative;
 margin:12px;
 border-radius:16px;
 overflow:hidden;
 box-shadow:0 6px 14px rgba(0,0,0,.08);
 height:180px;
}
.banner {
 width:100%;
 height:100%;
 display:none;
 position:relative;
}
.banner.active {
 display:block;
}
.banner-content {
 width:100%;
 height:100%;
 display:flex;
 align-items:center;
 justify-content:center;
 text-align:center;
 padding:20px;
 box-sizing:border-box;
}
.banner-nav {
 position:absolute;
 bottom:10px;
 left:0;
 right:0;
 display:flex;
 justify-content:center;
 gap:8px;
}
.banner-dot {
 width:8px;
 height:8px;
 border-radius:50%;
 background:rgba(255,255,255,0.5);
 cursor:pointer;
 transition:all 0.2s ease;
}
.banner-dot.active {
 background:white;
 transform:scale(1.2);
}

/* Section styling */
.section {
 margin:20px 10px;
}
.section-header {
 display:flex;
 align-items:center;
 justify-content:space-between;
 margin-bottom:12px;
}
.section-title {
 font-size:18px;
 font-weight:700;
 margin:0;
 color:var(--text);
}
.section-subtitle {
 font-size:14px;
 color:var(--muted);
 margin-top:4px;
}

/* Cards grid */
.cards-grid {
 display:grid;
 grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
 gap:14px;
 margin-top:10px;
}
.card {
 background:var(--card);
 border:1px solid var(--frame);
 border-radius:14px;
 padding:16px;
 box-shadow:0 4px 10px rgba(0,0,0,.05);
 transition:all 0.3s ease;
 position:relative;
 overflow:hidden;
}
.card:hover {
 transform:translateY(-5px);
 box-shadow:0 8px 20px rgba(46,139,87,.15);
}
.card-header {
 display:flex;
 align-items:flex-start;
 justify-content:space-between;
 margin-bottom:10px;
}
.card-title {
 font-size:16px;
 font-weight:700;
 margin:0 0 8px 0;
 color:var(--text);
}
.card-image {
 width:100%;
 height:120px;
 object-fit:cover;
 border-radius:8px;
 margin-bottom:12px;
 background:var(--frame);
}
.card-desc {
 font-size:14px;
 color:var(--muted);
 margin-bottom:16px;
 line-height:1.5;
}
.card-tags {
 display:flex;
 flex-wrap:wrap;
 gap:6px;
 margin-bottom:16px;
}
.tag {
 background:var(--chip);
 border:1px solid var(--chip-b);
 padding:4px 10px;
 border-radius:999px;
 font-size:12px;
 color:var(--muted);
}
.card-footer {
 display:flex;
 align-items:center;
 justify-content:space-between;
 margin-top:auto;
}
.card-best {
 position:absolute;
 top:12px;
 right:12px;
 background:gold;
 color:#333;
 font-size:12px;
 padding:4px 8px;
 border-radius:6px;
 font-weight:700;
}
.card-time {
 font-size:12px;
 color:var(--muted);
 margin-top:8px;
}
.btn {
 display:inline-block;
 padding:10px 16px;
 border-radius:10px;
 font-weight:700;
 text-decoration:none;
 text-align:center;
 transition:all 0.2s ease;
 cursor:pointer;
 border:none;
 font-family:inherit;
}
.btn.main {
 background:linear-gradient(135deg,var(--brand),var(--brand2));
 color:#fff;
}
.btn.main:hover {
 transform:translateY(-2px);
 box-shadow:0 4px 12px rgba(46,139,87,.3);
}
.btn.ghost {
 border:1px solid var(--frame);
 background:var(--chip);
 color:var(--text);
}
.btn.ghost:hover {
 background:var(--frame);
}

/* Leaderboard */
.leaderboard-section {
 margin:20px 10px;
}
.rank {
 display:grid;
 grid-template-columns:40px 1fr auto;
 gap:8px;
 align-items:center;
 padding:12px;
 border-radius:12px;
 border:1px solid var(--frame);
 margin:6px 0;
 background:var(--card);
 box-shadow:0 2px 6px rgba(0,0,0,.04);
 transition:all 0.2s ease;
}
.rank:hover {
 transform:scale(1.02);
 box-shadow:0 6px 16px rgba(46,139,87,.15);
}
.rank-1 {
 background:linear-gradient(135deg, #fff9e6, #fff0cc);
 border-color:#ffd966;
}
.dark .rank-1 {
 background:linear-gradient(135deg, #332a0d, #665214);
 border-color:#b38f00;
}
.rank-2 {
 background:linear-gradient(135deg, #f0f0f0, #e0e0e0);
 border-color:#c0c0c0;
}
.dark .rank-2 {
 background:linear-gradient(135deg, #2a2a2a, #404040);
 border-color:#606060;
}
.rank-3 {
 background:linear-gradient(135deg, #ffe6cc, #ffcc99);
 border-color:#e69500;
}
.dark .rank-3 {
 background:linear-gradient(135deg, #331a00, #663300);
 border-color:#b35900;
}
.rank-number {
 font-weight:800;
 font-size:16px;
 text-align:center;
}
.rank-name {
 font-weight:600;
}
.rank-school {
 font-size:12px;
 color:var(--muted);
 margin-top:2px;
}
.rank-points {
 font-weight:700;
 color:var(--brand);
}

/* Empty states */
.empty-state {
 text-align:center;
 padding:40px 20px;
 color:var(--muted);
}
.empty-state-icon {
 font-size:48px;
 margin-bottom:16px;
}
.empty-state-text {
 font-size:16px;
}

/* Responsive */
@media (max-width: 480px) {
 .cards-grid {
   grid-template-columns:1fr;
 }
 .banner-container {
   height:150px;
   margin:10px;
 }
 .banner-content {
   padding:15px;
 }
}
</style>
</head>
<body>
<header class="appbar">
  <div class="logo">L</div>
  <div class="title">LeaderMath</div>
  <button id="themeBtn" class="iconbtn">🌙</button>
</header>

<div id="bannerWrap" class="banner-container">
  <!-- Banners will be loaded here -->
</div>

<div id="sectionsWrap">
  <!-- Sections will be loaded here -->
</div>

<section class="leaderboard-section">
  <div class="card">
    <h3>Top 50 — Ball bo‘yicha</h3>
    <div id="boardList"></div>
  </div>
</section>

<script type="module">
import {auth,db,onAuthStateChanged} from './lib/firebase.client.js';
import {collection,query,orderBy,limit,onSnapshot} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// Theme toggle
const root = document.documentElement;
const btn = document.getElementById('themeBtn');
const key = 'lm-theme';

function setTheme(m) {
  root.classList.toggle('dark', m === 'dark');
  localStorage.setItem(key, m);
  btn.textContent = m === 'dark' ? '☀️' : '🌙';
}

setTheme(localStorage.getItem(key) || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
btn.onclick = () => setTheme(root.classList.contains('dark') ? 'light' : 'dark');

// Banner carousel functionality
let currentBannerIndex = 0;
let bannerInterval;

function startBannerCarousel(banners) {
  if (banners.length <= 1) return;
  
  bannerInterval = setInterval(() => {
    currentBannerIndex = (currentBannerIndex + 1) % banners.length;
    showBanner(currentBannerIndex, banners);
  }, 5000);
}

function showBanner(index, banners) {
  const bannerContainer = document.getElementById('bannerWrap');
  const bannerDots = bannerContainer.querySelectorAll('.banner-dot');
  
  // Hide all banners
  bannerContainer.querySelectorAll('.banner').forEach(banner => {
    banner.classList.remove('active');
  });
  
  // Show selected banner
  const currentBanner = bannerContainer.querySelector(`.banner[data-index="${index}"]`);
  if (currentBanner) {
    currentBanner.classList.add('active');
  }
  
  // Update dots
  bannerDots.forEach((dot, i) => {
    dot.classList.toggle('active', i === index);
  });
  
  currentBannerIndex = index;
}

// Format date for display
function formatDate(dateString) {
  if (!dateString) return '';
  
  const date = new Date(dateString);
  return date.toLocaleDateString('uz-UZ', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// Check if item is currently active based on type and time
function isItemActive(item) {
  const now = new Date();
  
  if (item.type === 'open') {
    return true;
  } else if (item.type === 'start') {
    if (!item.startAt) return false;
    return now >= new Date(item.startAt);
  } else if (item.type === 'window') {
    if (!item.startAt || !item.endAt) return false;
    return now >= new Date(item.startAt) && now <= new Date(item.endAt);
  }
  
  return false;
}

// Load banners and sections
fetch('./index.json').then(r => r.json()).then(data => {
  const banners = data.banners || [];
  const sections = data.sections || [];
  
  // Render banners
  const bannerWrap = document.getElementById('bannerWrap');
  if (banners.length > 0) {
    bannerWrap.innerHTML = banners
      .filter(banner => banner.active)
      .map((banner, index) => `
        <div class="banner ${index === 0 ? 'active' : ''}" data-index="${index}">
          <div class="banner-content">${banner.html}</div>
        </div>
      `).join('') + 
      (banners.length > 1 ? `
        <div class="banner-nav">
          ${banners.map((_, index) => 
            `<div class="banner-dot ${index === 0 ? 'active' : ''}" data-index="${index}"></div>`
          ).join('')}
        </div>
      ` : '');
    
    // Add click events to dots
    if (banners.length > 1) {
      bannerWrap.querySelectorAll('.banner-dot').forEach(dot => {
        dot.addEventListener('click', () => {
          const index = parseInt(dot.getAttribute('data-index'));
          showBanner(index, banners);
          // Reset interval
          clearInterval(bannerInterval);
          startBannerCarousel(banners);
        });
      });
      
      // Start carousel
      startBannerCarousel(banners.filter(banner => banner.active));
    }
  } else {
    bannerWrap.innerHTML = `
      <div class="banner active">
        <div class="banner-content">
          <h3>LeaderMath ga xush kelibsiz!</h3>
          <p>Matematika bo'yicha bilimingizni sinang</p>
        </div>
      </div>
    `;
  }
  
  // Render sections
  const sectionsWrap = document.getElementById('sectionsWrap');
  if (sections.length > 0) {
    sectionsWrap.innerHTML = sections
      .filter(section => section.active)
      .map(section => {
        const activeItems = section.items.filter(item => item.active && isItemActive(item));
        
        return `
          <section class="section">
            <div class="section-header">
              <div>
                <h2 class="section-title">${section.title}</h2>
                <div class="section-subtitle">${activeItems.length} ta test</div>
              </div>
            </div>
            ${activeItems.length > 0 ? `
              <div class="cards-grid">
                ${activeItems.map(item => `
                  <div class="card">
                    ${item.best ? '<div class="card-best">⭐ Eng yaxshi</div>' : ''}
                    ${item.image ? `<img src="${item.image}" alt="${item.name}" class="card-image">` : ''}
                    <div class="card-header">
                      <h3 class="card-title">${item.name}</h3>
                    </div>
                    ${item.description ? `<p class="card-desc">${item.description}</p>` : ''}
                    ${item.tags && item.tags.length > 0 ? `
                      <div class="card-tags">
                        ${item.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                      </div>
                    ` : ''}
                    ${(item.startAt || item.endAt) ? `
                      <div class="card-time">
                        ${item.startAt ? `Boshlanish: ${formatDate(item.startAt)}` : ''}
                        ${item.startAt && item.endAt ? '<br>' : ''}
                        ${item.endAt ? `Tugash: ${formatDate(item.endAt)}` : ''}
                      </div>
                    ` : ''}
                    <div class="card-footer">
                      <a class="btn main" href="${item.link}">Boshlash</a>
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : `
              <div class="empty-state">
                <div class="empty-state-icon">📝</div>
                <div class="empty-state-text">Hozircha testlar mavjud emas</div>
              </div>
            `}
          </section>
        `;
      }).join('');
  } else {
    sectionsWrap.innerHTML = `
      <section class="section">
        <div class="empty-state">
          <div class="empty-state-icon">📚</div>
          <div class="empty-state-text">Hozircha bo'limlar mavjud emas</div>
        </div>
      </section>
    `;
  }
}).catch(err => {
  console.error('Failed to load index.json:', err);
  document.getElementById('bannerWrap').innerHTML = `
    <div class="banner active">
      <div class="banner-content">
        <h3>Xatolik yuz berdi</h3>
        <p>Ma'lumotlarni yuklab bo'lmadi</p>
      </div>
    </div>
  `;
  document.getElementById('sectionsWrap').innerHTML = `
    <section class="section">
      <div class="empty-state">
        <div class="empty-state-icon">⚠️</div>
        <div class="empty-state-text">Ma'lumotlarni yuklab bo'lmadi</div>
      </div>
    </section>
  `;
});

// Leaderboard
onSnapshot(query(collection(db,'users'),orderBy('points','desc'),limit(50)),snap=>{
  const arr = snap.docs.map(d => d.data());
  const boardList = document.getElementById('boardList');
  
  if (arr.length > 0) {
    boardList.innerHTML = arr.map((u,i) => {
      let rankClass = '';
      if (i === 0) rankClass = 'rank-1';
      else if (i === 1) rankClass = 'rank-2';
      else if (i === 2) rankClass = 'rank-3';
      
      return `
        <div class="rank ${rankClass}">
          <div class="rank-number">${i+1}</div>
          <div>
            <div class="rank-name">${u.name||'Foydalanuvchi'}</div>
            <div class="rank-school">${u.school||''}</div>
          </div>
          <div class="rank-points">${u.points||0}</div>
        </div>
      `;
    }).join('');
  } else {
    boardList.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">🏆</div>
        <div class="empty-state-text">Hali reytingda hech kim yo'q</div>
      </div>
    `;
  }
});
</script>
</body>
</html>