<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LeaderMath — Test</title>

  <!-- MathJax -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$','$'],['\\(','\\)']], displayMath: [['$$','$$'],['\\[','\\]']], processEscapes:true, packages:{'[+]':['noerrors']} },
      options: { renderActions: { addMenu: [] } }, loader: { load: ['[tex]/noerrors'] }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root{ --brand:#2E8B57; --brand2:#1F6B45; --bg:#f6faf8; --text:#0f172a; --muted:#667a72; --frame:#e3efe8; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--frame);z-index:10}
    .wrap{max-width:960px;margin:0 auto;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .pi{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;display:grid;place-items:center;font-weight:900}
    .chip{border:1px solid #d8e9df;background:#f4fbf7;padding:6px 10px;border-radius:999px}
    .card{background:#fff;border:1px solid var(--frame);border-radius:16px;padding:16px;margin:16px 0;box-shadow:0 8px 24px rgba(20,40,30,.06)}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--brand);background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;cursor:pointer;font-weight:700}
    .btn.ghost{background:#fff;color:var(--brand)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .hidden{display:none!important}

    /* Question UI */
    .qtext{font-size:18px;margin-bottom:10px}
    .opt{display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border:1px solid #edf3ee;border-radius:12px;background:#fbfdfc;margin:8px 0;
      transition: box-shadow .2s ease, background .2s ease, border-color .2s ease;}
    .opt:hover{border-color:var(--brand);box-shadow:0 0 0 4px rgba(46,139,87,.15);background:#fff}
    .navdots{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .dot{width:36px;height:36px;border-radius:10px;border:1px solid var(--frame);display:grid;place-items:center;background:#fff;cursor:pointer}
    .dot.active{border-color:var(--brand);box-shadow:0 0 0 3px rgba(46,139,87,.15)}
    .score{font-size:20px;font-weight:800}
    .ok{color:#1F6B45} .bad{color:#b91c1c}
    #qImage{width:min(860px,100%);max-height:80vh;display:block;margin:10px auto;border-radius:12px;border:1px solid #edf3ee;
      box-shadow:0 6px 18px rgba(31,107,69,.06);-webkit-user-drag:none;user-select:none}

    @media print { body{display:none} }
  </style>
</head>
<body>
  <header>
    <div class="wrap row" style="justify-content:space-between">
      <div class="brand">
        <div class="pi">π</div>
        <div>
          <div style="font-weight:800">LeaderMath — Test</div>
          <small style="color:var(--muted)">BSB / CHSB sinov</small>
        </div>
      </div>
      <div class="row">
        <span id="authInfo" class="chip">Kirish: aniqlanmoqda…</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Intro -->
    <section id="introCard" class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 style="margin:6px 0 10px" id="testTitle">Test</h2>
          <div id="testDesc" style="color:var(--muted)">Rasm + variantlar.</div>
          <div class="row" style="gap:8px;margin-top:8px">
            <span id="metaCount" class="chip">Savollar: —</span>
            <span id="metaPoints" class="chip">Umumiy ball: —</span>
            <span id="metaTimer" class="chip hidden">00:00</span>
          </div>
        </div>
        <div class="row">
          <button id="startBtn" class="btn">Boshlash</button>
        </div>
      </div>
    </section>

    <!-- Questions -->
    <section id="questionsCard" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <div><b id="qIndex">1</b>/<span id="qTotal">—</span></div>
        <div class="row">
          <button id="prevBtn" class="btn ghost">← Oldingi</button>
          <button id="nextBtn" class="btn">Keyingi →</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <div id="qText" class="qtext"></div>
        <img id="qImage" alt="Savol rasmi">
        <div id="opts"></div>
      </div>

      <div class="row" style="justify-content:space-between;margin-top:8px">
        <div id="navDots" class="navdots"></div>
        <div class="row">
          <button id="revealBtn" class="btn ghost">To‘g‘ri javob(lar)ni ko‘rsat</button>
          <button id="finishBtn" class="btn">Yakunlash</button>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section id="resultCard" class="card hidden">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div class="score">Natija: <span id="scoreTotal">0</span>/<span id="scoreMax">0</span></div>
          <div id="scoreNote" style="color:var(--muted);margin-top:6px"></div>
        </div>
        <div class="row">
          <button id="againBtn" class="btn ghost">Savollarga qaytish</button>
        </div>
      </div>
      <div id="detailTable" style="margin-top:10px"></div>
    </section>

    <section id="emptyCard" class="card hidden" style="text-align:center">
      <h3>Test topilmadi</h3>
      <p class="muted">Shu papkaga <code>test.json</code> qo‘ying yoki <code>localStorage['testData']</code>ga yozing.</p>
    </section>
  </main>

  <script type="module">
    /* ================= CENTER LOGIN SYSTEM IMPORTS ================= */
    import { auth, db, onAuthStateChanged } from "/lib/firebase.client.js";
    import { requireAuth } from "/lib/auth-guard.js";
    import {
      doc, runTransaction, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    /* ================= BASIC UTIL ================= */
    const $ = s=>document.querySelector(s);
    const pad2 = n => String(Math.max(0,n)).padStart(2,'0');
    const sum = a => a.reduce((x,y)=>x+y,0);
    const isMulti = q => Array.isArray(q.correctIndices);
    const normalize = arr => Array.from(new Set((arr||[]).map(Number))).sort((a,b)=>a-b);
    const arraysEqual = (a,b)=> a.length===b.length && a.every((v,i)=>v===b[i]);

    async function typeset(el){ if(window.MathJax?.typesetPromise){ try{ await MathJax.typesetPromise([el]); }catch(_){} } }

    // Disable right-click / drag / some hotkeys
    document.addEventListener('contextmenu', e=> e.preventDefault());
    document.addEventListener('dragstart', e=> e.preventDefault());
    document.addEventListener('keydown', (e)=>{
      const k = (e.key||'').toLowerCase();
      if ((e.ctrlKey||e.metaKey) && ['s','p','u'].includes(k)) e.preventDefault();
    });

    /* ================ STATE ================ */
    let testData = null;
    let currentIndex = 0;
    let answers = [];         // each: ORIGINAL indices
    let startedAt = null;
    let timeLeftSec = 0, timerId = null;
    const currentTestId = new URLSearchParams(location.search).get('id') ||
                          (location.pathname.split('/').pop().replace(/\..*$/,'') || 'test');

    /* ================ AUTH GUARD ================ */
    // Redirects to login.html if not signed in
    await requireAuth();

    // Show user in header
    onAuthStateChanged(auth, (user)=>{
      $('#authInfo').textContent = user ? `Kirish: ${user.displayName || user.email}` : 'Kirish: mehmon';
    });

    /* ================ LOAD TEST ================ */
    function normalizeTestData(data){
      if(!data || !Array.isArray(data.questions)) return data;
      data.title = data.title || 'Test';
      data.description = data.description || 'Rasm + variantlar';
      data.questions = data.questions.map(q=>({ ...q, points: Number(q.points || 1) }));
      if (data.totalTime && !data.durationMinutes) data.durationMinutes = Number(data.totalTime);
      return data;
    }
    async function loadTestData(){
      const stored = localStorage.getItem('testData');
      if(stored){
        try{ testData = normalizeTestData(JSON.parse(stored)); return; }catch{}
      }
      try{
        const r = await fetch('./test.json',{cache:'no-store'});
        if(!r.ok) throw new Error('no test.json');
        testData = normalizeTestData(await r.json());
      }catch{
        testData = {
          title: 'Demo test',
          description: 'Fallback ma’lumotlar',
          questions: [
            { text: "1) $2+2$ nechiga teng?", options:["2","3","4","5"], correctIndex:2, points:1 },
            { text: "2) Ko‘p tanlov: tub son(lar)ni belgilang.", options:["2","4","5","9"], correctIndices:[0,2], points:2 },
            { text: "3) Nisbatni toping (rasmga qarang).", image:"https://upload.wikimedia.org/wikipedia/commons/thumb/3/3b/Geometric_figure_square.svg/512px-Geometric_figure_square.svg.png", options:["1:1","1:2","2:3","3:4"], correctIndex:0, points:1 }
          ]
        };
      }
    }

    /* ================ UI INIT ================ */
    function buildNavDots(){
      const n = testData.questions.length;
      const root = $('#navDots'); root.innerHTML='';
      for(let i=0;i<n;i++){
        const b=document.createElement('button');
        b.className='dot'; b.textContent = i+1;
        b.addEventListener('click', ()=>{ currentIndex=i; renderQuestion(); });
        root.appendChild(b);
      }
      highlightDot(0);
    }
    function highlightDot(i){
      [...document.querySelectorAll('.dot')].forEach((el,idx)=> el.classList.toggle('active', idx===i));
    }

    function resolveImageSrc(idx1){
      // Try local 1.jpg -> 1.png else q.image
      const q = testData.questions[idx1-1] || {};
      const tryJpg = `./${idx1}.jpg`, tryPng = `./${idx1}.png`;
      return new Promise(res=>{
        const img = new Image();
        img.onload = ()=>res(tryJpg);
        img.onerror = ()=>{
          const img2 = new Image();
          img2.onload = ()=>res(tryPng);
          img2.onerror = ()=>res(q.image||'');
          img2.src = tryPng + `?t=${Date.now()}`;
        };
        img.src = tryJpg + `?t=${Date.now()}`;
      });
    }

    function renderQuestion(){
      const q = testData.questions[currentIndex];
      $('#qIndex').textContent = String(currentIndex+1);
      $('#qTotal').textContent = String(testData.questions.length);
      $('#qText').innerHTML = q.text || '';
      $('#opts').innerHTML = '';

      const multi = isMulti(q);
      const nameAttr = `q${currentIndex}` + (multi?'[]':'');
      const chosen = new Set(answers[currentIndex] || []);

      q.options.forEach((opt, i)=>{
        const row = document.createElement('label'); row.className='opt';
        const inp = document.createElement('input');
        inp.type = multi ? 'checkbox' : 'radio';
        inp.name = nameAttr;
        inp.value = String(i); // ORIGINAL index
        inp.checked = chosen.has(i);
        inp.addEventListener('change', ()=>{
          if(multi){
            if(inp.checked) chosen.add(i); else chosen.delete(i);
            answers[currentIndex] = normalize([...chosen]);
          } else {
            answers[currentIndex] = inp.checked ? [i] : [];
          }
        });
        const span = document.createElement('span'); span.innerHTML = opt;
        row.appendChild(inp); row.appendChild(span);
        $('#opts').appendChild(row);
      });

      resolveImageSrc(currentIndex+1).then(src=>{ $('#qImage').src = src; });

      highlightDot(currentIndex);
      if (window.MathJax?.typesetPromise) typeset($('#questionsCard'));
    }

    /* ================ TIMER ================= */
    function startTimerIfNeeded(){
      const minutes = Number(testData.durationMinutes || 0);
      if(!minutes){ $('#metaTimer').classList.add('hidden'); return; }
      timeLeftSec = Math.round(minutes*60);
      $('#metaTimer').classList.remove('hidden');
      const upd=()=>{
        const m=Math.max(0,Math.floor(timeLeftSec/60)), s=Math.max(0,timeLeftSec%60);
        $('#metaTimer').textContent = `${pad2(m)}:${pad2(s)}`;
      };
      upd();
      timerId = setInterval(()=>{
        timeLeftSec--; upd();
        if(timeLeftSec<=0){ clearInterval(timerId); onFinish(); }
      }, 1000);
    }

    /* ================ SCORING ================= */
    function computeTotals(){
      let total=0, max=0;
      const perQuestion=[];
      testData.questions.forEach((q,i)=>{
        const pts = Number(q.points||1); max+=pts;
        const picked = normalize(answers[i] || []);
        const correct = isMulti(q) ? normalize(q.correctIndices||[]) : [Number(q.correctIndex??-1)];
        const ok = isMulti(q) ? arraysEqual(picked, correct) : (picked.length===1 && picked[0]===correct[0]);
        if(ok) total+=pts;
        perQuestion.push({i, pts, ok, picked, correct});
      });
      return { total, max, perQuestion };
    }

    /* ================ SAVE FIRST RESULT ONLY ================= */
    async function saveFirstResultOnly({testId, uid, total, max, detail}){
      const ref = doc(db, 'results', testId, 'users', uid);
      return runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        if (snap.exists()){
          return { skipped:true, already:snap.data() };
        }
        tx.set(ref, {
          uid, testId,
          firstTotal: total, max,
          detail,
          createdAt: serverTimestamp()
        });
        return { skipped:false };
      });
    }

    /* ================ FINISH ================= */
    async function onFinish(){
      const { total, max, perQuestion } = computeTotals();
      $('#questionsCard').classList.add('hidden');
      $('#resultCard').classList.remove('hidden');
      $('#scoreTotal').textContent = String(total);
      $('#scoreMax').textContent = String(max);
      $('#scoreNote').textContent = `To‘g‘ri: ${perQuestion.filter(x=>x.ok).length} ta / ${perQuestion.length} ta`;

      // detail list
      const tbl = document.createElement('div'); tbl.style.marginTop='8px';
      perQuestion.forEach(row=>{
        const el = document.createElement('div');
        el.style.border='1px solid var(--frame)'; el.style.borderRadius='12px';
        el.style.padding='10px'; el.style.margin='6px 0';
        el.innerHTML = `
          <div><b>${row.i+1}-savol</b> — <span class="${row.ok?'ok':'bad'}">${row.ok?'to‘g‘ri':'noto‘g‘ri'}</span> (<b>${row.pts}</b> ball)</div>
          <div style="color:var(--muted)">tanlangan: [${row.picked.map(x=>x+1).join(', ')||'—'}] · to‘g‘ri: [${row.correct.map(x=>x+1).join(', ')}]</div>
        `;
        tbl.appendChild(el);
      });
      $('#detailTable').innerHTML=''; $('#detailTable').appendChild(tbl);

      // save once
      const user = auth.currentUser;
      if(user){
        try{
          const res = await saveFirstResultOnly({
            testId: (testData.id || currentTestId),
            uid: user.uid,
            total, max, detail: perQuestion
          });
          console.log(res.skipped ? 'Oldin saqlangan — bu urinish yozilmadi' : 'Birinchi natija saqlandi');
        }catch(e){ console.error('save error:', e); }
      }
    }

    /* ================ REVEAL CORRECT ================= */
    function revealCorrect(){
      $('#resultCard').classList.add('hidden');
      $('#questionsCard').classList.remove('hidden');
      const q=testData.questions[currentIndex]; const multi=isMulti(q);
      const correct = multi?(q.correctIndices||[]):[Number(q.correctIndex??-1)];
      document.querySelectorAll('#opts .opt').forEach(row=>{
        row.style.borderColor='#edf3ee'; row.style.boxShadow='none'; row.style.background='#fbfdfc';
      });
      document.querySelectorAll('#opts input').forEach(inp=>{
        const orig = Number(inp.value);
        const row=inp.closest('.opt');
        if(correct.includes(orig)){
          row.style.borderColor='rgba(46,139,87,.55)';
          row.style.boxShadow='0 0 0 4px rgba(46,139,87,.18)';
          row.style.background='#f3fbf6';
        }
      });
    }

    /* ================ BOOTSTRAP ================= */
    async function boot(){
      // data
      await loadTestData();
      if(!testData || !testData.questions?.length){
        $('#introCard').classList.add('hidden');
        $('#questionsCard').classList.add('hidden');
        $('#emptyCard').classList.remove('hidden');
        return;
      }
      // header meta
      $('#testTitle').textContent = testData.title || 'Test';
      $('#testDesc').textContent = testData.description || '';
      $('#metaCount').textContent = `Savollar: ${testData.questions.length}`;
      $('#metaPoints').textContent = `Umumiy ball: ${sum(testData.questions.map(q=>q.points))}`;

      // answers init
      answers = Array.from({length:testData.questions.length}, ()=>[]);

      // nav
      buildNavDots();

      // events
      $('#startBtn').onclick = ()=>{
        startedAt = new Date();
        $('#introCard').classList.add('hidden');
        $('#questionsCard').classList.remove('hidden');
        renderQuestion();
        startTimerIfNeeded();
      };
      $('#prevBtn').onclick = ()=>{ if(currentIndex>0){ currentIndex--; renderQuestion(); } };
      $('#nextBtn').onclick = ()=>{ if(currentIndex<testData.questions.length-1){ currentIndex++; renderQuestion(); } };
      $('#finishBtn').onclick = onFinish;
      $('#againBtn').onclick = ()=>{
        $('#resultCard').classList.add('hidden');
        $('#questionsCard').classList.remove('hidden');
      };
      $('#revealBtn').onclick = revealCorrect;
    }

    boot();
  </script>
</body>
</html>
