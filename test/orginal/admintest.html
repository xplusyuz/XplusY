<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Rasm-Only Test — Admin (ID/Kod + Sections + Import)</title>

  <!-- MathJax (preview va keypad tugmalarini render qilish uchun) -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$','$'],['\\(','\\)']], displayMath: [['$$','$$'],['\\[','\\]']], processEscapes: true, packages:{'[+]':['noerrors']} },
      options: { renderActions: { addMenu: [] } }, loader: { load: ['[tex]/noerrors'] }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root{--g:#2E8B57;--gd:#1F6B45;--bd:#e9f2ec;--muted:#64748b;--ring:rgba(46,139,87,.18)}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#f6faf8;color:#0f172a}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{display:flex;align-items:center;gap:10px;margin:0 0 16px}
    .pi{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,var(--g),var(--gd));color:#fff;font-weight:800}

    .grid{display:grid;gap:12px}
    .card{background:#fff;border:1px solid var(--bd);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(31,107,69,.06)}
    .row{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    label{font-size:12px;color:#475569}
    input[type="text"],input[type="number"],textarea,select{width:100%;padding:10px 12px;border:1px solid #dfeae3;border-radius:10px;background:#fbfdfc}
    textarea{min-height:92px;resize:vertical}
    .qbox{border:1px dashed #cfe4d7;border-radius:14px;padding:12px;display:grid;gap:12px}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:700;color:#fff;background:linear-gradient(135deg,var(--g),var(--gd));cursor:pointer}
    .btn.ghost{background:#fff;color:#1F6B45;border:1px solid #cfe4d7}
    .btn.danger{background:linear-gradient(135deg,#d32f2f,#b71c1c)}
    .btn.flat{background:#f8fbf9;color:#1F6B45;border:1px solid #cfe4d7}
    .muted{color:#64748b;font-size:13px}
    .flex{display:flex;gap:10px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#f1f8f4;border:1px solid #dfeae3;border-radius:999px;padding:6px 10px;font-size:12px}
    .mini{font-size:12px;color:#64748b}
    .help{font-size:12px;color:#6b7280}
    .answers .opt{display:flex;align-items:center;gap:8px}
    .answers .opt input{transform:translateY(2px)}
    .hr{height:1px;background:#eef4f0;margin:8px 0}
    .side{display:grid;gap:10px}
    .preview{border:1px dashed #dfeae3;border-radius:12px;padding:12px;background:#fbfdfc}
    .warn{color:#b45309}

    /* Drawer keypad */
    .drawer{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);transition:transform .25s ease;background:#fffffff2;backdrop-filter:saturate(1.2) blur(6px);border-top:1px solid #dfeae3;box-shadow:0 -10px 24px rgba(31,107,69,.12);padding:12px 14px;z-index:9999}
    .drawer.open{transform:translateY(0%)}
    .drawer .rowbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .kgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(72px,1fr));gap:8px}
    .kbtn{appearance:none;cursor:pointer;padding:8px 10px;border:1px solid #dfeae3;background:#fff;border-radius:10px;display:flex;align-items:center;justify-content:center;min-height:44px;transition:box-shadow .15s,border-color .15s,background .15s}
    .kbtn:hover{border-color:#b9dfc8;box-shadow:0 0 0 4px var(--ring);background:#fff}
    .pin{display:flex;align-items:center;gap:8px}
    .pin input{transform:translateY(1px)}
    .drawer .title{font-weight:700}
    .toolbar-note{font-size:12px;color:#64748b}

    .qbox.collapsed .row, .qbox.collapsed .side, .qbox.collapsed .preview, .qbox.collapsed .miniLocal {display:none}
    .sec-row{display:grid;gap:10px;grid-template-columns:260px 1fr 1fr 1fr}
    .sec-item{display:contents}
    .sec-list{display:grid;gap:8px}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1><span class="pi">π</span> Rasm-Only Test — Admin</h1>

    <!-- Test meta -->
    <div class="card grid">
      <div class="row">
        <div><label>Sarlavha</label><input id="title" type="text" placeholder="Algebra — Rasm test"></div>
        <div><label>Ta'rif</label><input id="desc" type="text" placeholder="Savol matnisiz, rasm + variantlar"></div>
        <div><label>Test ID (slug)</label><input id="tid" type="text" placeholder="bsb-alg-geo-20"></div>
        <div><label>Test kodi (Firestore uchun)</label><input id="tcode" type="text" placeholder="bsb-a1-2025-10"></div>
        <div><label>Vaqt (daqiqada)</label><input id="dur" type="number" min="0" value="30"></div>
        <div><label>Nechta savol (rasmlar soni)</label><input id="qcount" type="number" min="1" value="20"></div>
      </div>

      <!-- Sections editor -->
      <div class="row">
        <div>
          <label>Nechta bo'lim?</label>
          <input id="secCount" type="number" min="0" value="2">
          <div class="mini">0 bo'lsa — <b>test.html</b> default bo'limlardan foydalanadi.</div>
        </div>
        <div class="sec-list" id="secList"></div>
      </div>

      <!-- Import/Export/Preview -->
      <div class="flex" style="align-items:center;justify-content:space-between">
        <div class="flex" style="gap:8px">
          <button class="btn" id="buildBtn" type="button">Savol shakllarini yarat</button>
          <button class="btn flat" id="importBtn" type="button">Import JSON (fayldan)</button>
          <input id="importFile" type="file" accept="application/json,.json" class="hidden">
          <button class="btn flat" id="importLS" type="button">Import (localStorage)</button>
          <button class="btn flat" id="importTestJson" type="button">Import (test.json)</button>
        </div>
        <div class="flex">
          <button class="btn flat" id="expandAll" type="button">Barchasini yoyish</button>
          <button class="btn flat" id="collapseAll" type="button">Barchasini yig'ish</button>
          <button class="btn ghost" id="toggleDrawer" type="button">Math klaviatura</button>
        </div>
      </div>
    </div>

    <!-- Questions -->
    <div id="questionsArea" class="grid"></div>

    <!-- Footer actions -->
    <div class="card flex" style="justify-content:space-between;align-items:center">
      <div class="flex">
        <button class="btn" id="exportBtn" type="button">Export JSON</button>
        <button class="btn ghost" id="previewBtn" type="button">Preview (test.html)</button>
      </div>
      <div class="muted">"Preview" — <code>localStorage['testData']</code>ga yozadi va <code>test.html</code>ni ochadi.</div>
    </div>

    <div class="card">
      <div class="help"><strong>Eslatma:</strong> Har bir savol uchun <b>birinchi variant</b> avtomatik to'g'ri javob deb belgilanadi (correctIndex = 0).</div>
    </div>
  </div>

  <!-- Drawer keypad -->
  <div id="keypadDrawer" class="drawer" aria-hidden="true">
    <div class="rowbar">
      <div class="title">Math klaviatura</div>
      <div class="pin"><input type="checkbox" id="pinDrawer"><label for="pinDrawer" class="toolbar-note">Doim ochiq</label></div>
    </div>
    <div id="keypadGrid" class="kgrid"></div>
  </div>

<script>
/* ========= Utilities ========= */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const typeset = async (el)=>{ if(window.MathJax?.typesetPromise){ try{ await MathJax.typesetPromise([el]); }catch(_){} } };

// HTML escape (regexsiz)
function escapeHtml(t){
  return t.split('&').join('&amp;').split('<').join('&lt;').split('>').join('&gt;');
}
function looksLikeTeX(s){
  if (!s) return false;
  const needles = ['\\frac','\\sqrt','\\sum','\\int','\\log','\\ln','\\sin','\\cos','\\tan','\\vec','\\pi','\\le','\\ge','\\ne','\\pm','\\cdot','\\times','\\left','\\right'];
  for(const k of needles){ if(s.indexOf(k) !== -1) return true; }
  for(const ch of ['^','_','{','}','\\']){ if(s.indexOf(ch) !== -1) return true; }
  return false;
}
function hasDollarPair(s){
  const i = s.indexOf('$'); if(i === -1) return false;
  return s.indexOf('$', i+1) !== -1;
}
function renderLineForMath(s){
  const safe = escapeHtml(s);
  if (hasDollarPair(s)) return safe;
  if (looksLikeTeX(s)) return '\\(' + safe + '\\)';
  return safe;
}

// Caret insert with '▮' marker
function insertAtCursor(textarea, template){
  textarea.focus();
  const start  = textarea.selectionStart ?? textarea.value.length;
  const end    = textarea.selectionEnd   ?? textarea.value.length;
  const before = textarea.value.slice(0,start);
  const after  = textarea.value.slice(end);
  let out = before + template + after;
  const markerPos = (before + template).indexOf('▮');
  if(markerPos >= 0){ out = out.replace('▮',''); }
  textarea.value = out;
  const pos = markerPos >= 0 ? markerPos : (start + template.length);
  textarea.setSelectionRange(pos, pos);
  textarea.dispatchEvent(new Event('input', { bubbles:true }));
}
function setDrawer(open){
  const d = $('#keypadDrawer');
  d.classList.toggle('open', open);
  d.setAttribute('aria-hidden', open ? 'false' : 'true');
}

/* ========= Keypad ========= */
const KEYS = [
  { show:'x^n',             insert:'^{▮}' },
  { show:'x_n',             insert:'_{▮}' },
  { show:'\\sqrt{}',        insert:'\\sqrt{▮}' },
  { show:'\\sqrt[n]{}',     insert:'\\sqrt[▮]{ }' },
  { show:'\\frac{a}{b}',    insert:'\\frac{▮}{ }' },
  { show:'\\log_a()',       insert:'\\log_{▮}()' },
  { show:'\\ln()',          insert:'\\ln(▮)' },
  { show:'e^{x}',           insert:'e^{▮}' },
  { show:'\\sin()',         insert:'\\sin(▮)' },
  { show:'\\cos()',         insert:'\\cos(▮}' },
  { show:'\\tan()',         insert:'\\tan(▮)' },
  { show:'\\pi',            insert:'\\pi' },
  { show:'\\cdot',          insert:'\\cdot' },
  { show:'\\times',         insert:'\\times' },
  { show:'\\le',            insert:'\\le' },
  { show:'\\ge',            insert:'\\ge' },
  { show:'\\ne',            insert:'\\ne' },
  { show:'\\pm',            insert:'\\pm' },
  { show:'\\sum_{i=1}^{n}', insert:'\\sum_{i=1}^{▮}' },
  { show:'\\int',           insert:'\\int_{▮}^{ }' },
  { show:'\\vec{v}',        insert:'\\vec{▮}' },
  { show:'\\left(\\right)', insert:'\\left(▮\\right)' },
  { show:'\\left[\\right]', insert:'\\left[▮\\right]' },
  { show:'\\left\\{\\right\\}', insert:'\\left\\{▮\\right\\}' }
];
function buildKeypad(){
  const grid = $('#keypadGrid'); grid.innerHTML = '';
  KEYS.forEach(k=>{
    const btn = document.createElement('button');
    btn.type='button'; btn.className='kbtn';
    btn.innerHTML = `$${k.show}$`;
    btn.addEventListener('mousedown', e=>e.preventDefault());
    btn.addEventListener('click', ()=>{
      const targetTA = ACTIVE_TEXTAREA || LAST_ACTIVE_TEXTAREA;
      if(targetTA){ insertAtCursor(targetTA, k.insert); targetTA.focus(); }
    });
    grid.appendChild(btn);
  });
  typeset(grid);
}

/* ========= Sections editor ========= */
function rebuildSectionsUI(){
  const secN = Math.max(0, Number($('#secCount').value||0));
  const list = $('#secList'); list.innerHTML = '';
  if(secN===0){
    list.innerHTML = `<div class="mini warn">Bo'limlar JSON'ga yozilmaydi (test.html default bo'limlardan foydalanadi).</div>`;
    return;
  }
  const hdr = document.createElement('div');
  hdr.className = 'sec-row';
  hdr.innerHTML = `
    <div><label>Bo'lim nomi</label></div>
    <div><label>Boshlanish (1-indeks)</label></div>
    <div><label>Tugash</label></div>
    <div><label>Izoh</label></div>`;
  list.appendChild(hdr);

  for(let i=0;i<secN;i++){
    const row = document.createElement('div'); row.className='sec-row sec-item';
    row.innerHTML = `
      <input type="text" class="sec-name" placeholder="Masalan: Algebra">
      <input type="number" min="1" class="sec-start" placeholder="1">
      <input type="number" min="1" class="sec-end" placeholder="12">
      <div class="mini">Qamrab olgan savollar diapazoni</div>`;
    list.appendChild(row);
  }
}
function collectSections(totalQ){
  const n = Math.max(0, Number($('#secCount').value||0));
  if(n===0) return [];
  const names = $$('#secList .sec-name');
  const starts = $$('#secList .sec-start');
  const ends = $$('#secList .sec-end');
  const out = [];
  for(let i=0;i<n;i++){
    const name = (names[i]?.value || `Bo'lim ${i+1}`).trim();
    const start = Math.max(1, Number(starts[i]?.value||1));
    const end = Math.min(totalQ, Number(ends[i]?.value||totalQ));
    if(start<=end) out.push({ name, start, end });
  }
  return out;
}

/* ========= Question template / logic ========= */
function qTemplate(i){
  return `
  <div class="card qbox" data-index="${i}">
    <div class="flex" style="justify-content:space-between;align-items:center">
      <div class="badge">#${i} — rasm: <code>${i}.jpg</code> / <code>${i}.png</code></div>
      <div class="flex">
        <button class="btn flat" data-minitoggle type="button">Yig'ish</button>
        <button class="btn danger" data-remove type="button">O'chirish</button>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Ball (#${i})</label>
        <input type="number" min="1" value="1" class="points">
      </div>
      <div>
        <label>Javob turi</label>
        <select class="mode" disabled>
          <option value="single">Bir javobli</option>
        </select>
        <div class="mini">Har doim <b>birinchi variant</b> to'g'ri javob.</div>
      </div>
    </div>

    <div class="row">
      <div class="side">
        <div>
          <label class="miniLocal">Variantlar (har satr — bitta, LaTeX uchun $ ... $)</label>
          <textarea class="options" placeholder="A varianti&#10;B varianti&#10;$x^2-1$&#10;$\\sqrt{a^2+b^2}$"></textarea>
          <div class="mini">Focus shu maydonda bo'lsa, pastdagi klaviatura avtomatik ochiladi.</div>
        </div>
        <div style="display:none">
          <label>To'g'ri javob(lar)</label>
          <div class="answers"></div>
          <div class="mini">Variantlar o'zgarganda ro'yxat yangilanadi.</div>
        </div>
      </div>

      <div class="side">
        <label>Jonli preview</label>
        <div class="preview">
          <div class="mini">Savol #${i} — rasm (matn yo'q):</div>
          <div style="margin:6px 0 10px;padding:8px;border:1px solid #eef4f0;border-radius:10px;background:#fff">
            <em>${i}.jpg/png — test.html'da ko'rsatiladi.</em>
          </div>
          <div class="hr"></div>
          <div class="mini">Variantlar:</div>
          <div class="pvOptions"></div>
          <div class="hr"></div>
          <div class="mini">To'g'ri javoblar: ✓ (birinchi varianti)</div>
        </div>
      </div>
    </div>
  </div>`;
}
function updatePreviewFlags(qbox){
  const pv = qbox.querySelector('.pvOptions');
  [...pv.children].forEach((node, idx)=>{
    const flag = node.querySelector('.flag');
    const on = (idx === 0);
    flag.textContent = on ? ' ✓' : '';
    flag.className = 'flag';
  });
}
function rebuildAnswerPickers(qbox){
  const ta = qbox.querySelector('.options');
  const ansBox = qbox.querySelector('.answers');
  const pv = qbox.querySelector('.pvOptions');
  const lines = (ta.value || '').split('\n').map(s=>s.trim()).filter(Boolean);

  ansBox.innerHTML = '';
  lines.forEach((txt, idx)=>{
    const id = `q${qbox.dataset.index}_opt${idx}`;
    const inp = document.createElement('input');
    inp.type = 'radio';
    inp.name = `ans_${qbox.dataset.index}`;
    inp.value = String(idx);
    inp.id = id;
    inp.checked = (idx === 0);

    const lab = document.createElement('label');
    lab.setAttribute('for', id);
    lab.innerHTML = `${idx+1}) <span class="mj">${renderLineForMath(txt)}</span>`;

    const row = document.createElement('div');
    row.className = 'answers opt';
    row.appendChild(inp); row.appendChild(lab);
    ansBox.appendChild(row);
  });

  pv.innerHTML = '';
  lines.forEach((txt, idx)=>{
    const line = document.createElement('div');
    line.innerHTML = `${idx+1}) <span class="mj">${renderLineForMath(txt)}</span> <span class="flag"></span>`;
    pv.appendChild(line);
  });

  typeset(ansBox); typeset(pv); updatePreviewFlags(qbox);
}
function attachQEvents(qbox){
  const ta = qbox.querySelector('.options');
  ta.addEventListener('focus', ()=>{
    ACTIVE_TEXTAREA = ta;
    LAST_ACTIVE_TEXTAREA = ta;
    setDrawer(true);
  });
  ta.addEventListener('blur', ()=>{
    setTimeout(()=>{
      const ae = document.activeElement;
      const isOverDrawer = $('#keypadDrawer').contains(ae);
      if(!$('#pinDrawer').checked && !isOverDrawer){ setDrawer(false); }
    }, 0);
  });
  ta.addEventListener('input', ()=>rebuildAnswerPickers(qbox));

  qbox.querySelector('[data-remove]').addEventListener('click', ()=>qbox.remove());
  qbox.querySelector('[data-minitoggle]').addEventListener('click', (e)=>{
    const collapsed = qbox.classList.toggle('collapsed');
    e.target.textContent = collapsed ? 'Yoyish' : "Yig'ish";
  });

  rebuildAnswerPickers(qbox);
}
function buildForms(){
  const n = Math.max(1, Number($('#qcount').value||1));
  const area = $('#questionsArea'); area.innerHTML = '';
  for(let i=1;i<=n;i++){
    const holder = document.createElement('div');
    holder.innerHTML = qTemplate(i);
    const el = holder.firstElementChild;
    area.appendChild(el);
    attachQEvents(el);
  }
}

/* ========= Export / Import / Preview ========= */
function collectJson(){
  const title = $('#title').value || 'Rasm-Only Test';
  const description = $('#desc').value || 'Rasm + variant';
  const id   = ($('#tid')?.value || '').trim();
  const code = ($('#tcode')?.value || '').trim();
  const durationMinutes = Number($('#dur').value||0);
  const qcount = Math.max(1, Number($('#qcount').value||1));

  const questions = [];
  $$('#questionsArea .qbox').forEach(qbox=>{
    const points = Math.max(1, Number(qbox.querySelector('.points').value||1));
    const opts = (qbox.querySelector('.options').value||'').split('\n').map(s=>s.trim()).filter(Boolean);
    questions.push({ points, options: opts, correctIndex: 0 });
  });

  const sections = collectSections(qcount);

  const out = { title, description, durationMinutes, sections, questions };
  if(id) out.id = id;
  if(code) out.code = code;
  return out;
}
function download(filename, blob){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}
function setAllCollapsed(state){
  $$('#questionsArea .qbox').forEach(qb=>{
    const btn = qb.querySelector('[data-minitoggle]');
    const collapsed = qb.classList.contains('collapsed');
    if(state && !collapsed){ btn.click(); }
    if(!state && collapsed){ btn.click(); }
  });
}
function normalizeImported(data){
  if(!data) throw new Error("Fayl bo'sh yoki o'qilmadi");
  if(Array.isArray(data)) data = { questions: data };
  if(!Array.isArray(data.questions)){
    const candidate = data.items || data.qs || data.list || data.data;
    if(Array.isArray(candidate)) data.questions = candidate;
  }
  if(!Array.isArray(data.questions)) throw new Error("JSON format mos emas. 'questions' massiv topilmadi.");
  if(data.totalTime && !data.durationMinutes) data.durationMinutes = Number(data.totalTime);

  data.title = data.title || 'Rasm-Only Test';
  data.description = data.description || 'Rasm + variant';

  data.questions = data.questions.map(q=>{
    if(typeof q === 'string'){
      return { points: 1, options: q.split(/\r?\n/).map(s=>s.trim()).filter(Boolean), correctIndex: 0 };
    }
    const qq = { ...q };
    if(!Array.isArray(qq.options) && typeof qq.opts === 'string'){
      qq.options = qq.opts.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    }
    if(!Array.isArray(qq.options) && Array.isArray(qq.opts)) qq.options = qq.opts;
    if(typeof qq.correctOption==='number' && qq.correctIndex===undefined) qq.correctIndex = Number(qq.correctOption);
    qq.points = Number(qq.points||1);
    if(!Array.isArray(qq.options)) qq.options = [];
    return qq;
  });

  if(!Array.isArray(data.sections)) data.sections = [];
  return data;
}
function applyTestData(data){
  const d = normalizeImported(data);

  $('#title').value = d.title || '';
  $('#desc').value  = d.description || '';
  $('#tid').value   = d.id || '';
  $('#tcode').value = d.code || '';
  $('#dur').value   = Number(d.durationMinutes||0);

  $('#secCount').value = (d.sections && d.sections.length) ? d.sections.length : 0;
  rebuildSectionsUI();
  if(d.sections && d.sections.length){
    const names  = $$('#secList .sec-name');
    const starts = $$('#secList .sec-start');
    const ends   = $$('#secList .sec-end');
    d.sections.forEach((s, i)=>{
      if(names[i])  names[i].value  = s.name  || `Bo'lim ${i+1}`;
      if(starts[i]) starts[i].value = s.start ?? '';
      if(ends[i])   ends[i].value   = s.end   ?? '';
    });
  }

  $('#qcount').value = d.questions.length;
  buildForms();

  $$('#questionsArea .qbox').forEach((qbox, idx)=>{
    const q = d.questions[idx];
    if(!q) return;
    qbox.querySelector('.points').value = Number(q.points||1);
    const ta = qbox.querySelector('.options');
    ta.value = (q.options||[]).join('\n');
    rebuildAnswerPickers(qbox);
    const inp = qbox.querySelector('.answers input[value="0"]');
    if(inp){ inp.checked = true; }
    updatePreviewFlags(qbox);
  });

  typeset($('#questionsArea'));
}
async function importFromFile(file){
  try{
    let text = await file.text();
    if(text.charCodeAt(0)===0xFEFF) text = text.slice(1);
    const json = JSON.parse(text);
    applyTestData(json);
  }catch(err){
    alert('Import xatosi: ' + (err?.message||err) + "\n\nTekshiring: fayl JSON va unda 'questions' massiv bor.");
  }
}
async function importFromLocalStorage(){
  try{
    const raw = localStorage.getItem('testData');
    if(!raw) throw new Error("localStorage['testData'] topilmadi.");
    const data = JSON.parse(raw);
    applyTestData(data);
  }catch(e){
    alert('localStorage import xatosi: ' + e.message);
  }
}
async function importFromTestJson(){
  try{
    const r = await fetch('test.json', { cache: 'no-store' });
    if(!r.ok) throw new Error('test.json o\'qilmadi');
    const data = await r.json();
    applyTestData(data);
  }catch(e){
    alert('test.json o\'qishda xatolik: ' + e.message + "\n\nEslatma: file:// bilan ochilganda fetch ishlamasligi mumkin. Kichik lokal serverda ishga tushiring.");
  }
}

/* ========= Global keypad & init ========= */
let ACTIVE_TEXTAREA = null;
let LAST_ACTIVE_TEXTAREA = null;

function renderLineForMath(s){ // (uses escapeHtml/looksLikeTeX/hasDollarPair)
  const safe = escapeHtml(s);
  if (hasDollarPair(s)) return safe;
  if (looksLikeTeX(s)) return '\\(' + safe + '\\)';
  return safe;
}

buildKeypad();
$('#toggleDrawer').addEventListener('click', ()=>{
  const open = !$('#keypadDrawer').classList.contains('open');
  setDrawer(open);
});
$('#keypadGrid').addEventListener('mousedown', e=>e.preventDefault());

document.addEventListener('focusin', (e)=>{
  if(e.target && e.target.tagName==='TEXTAREA'){
    ACTIVE_TEXTAREA = e.target;
    LAST_ACTIVE_TEXTAREA = e.target;
  }
});

document.addEventListener('DOMContentLoaded', ()=>{
  $('#buildBtn').addEventListener('click', buildForms);
  $('#exportBtn').addEventListener('click', ()=>{
    const data = collectJson();
    download('test.json', new Blob([JSON.stringify(data, null, 2)], {type:'application/json'}));
  });
  $('#previewBtn').addEventListener('click', ()=>{
    const data = collectJson();
    localStorage.setItem('testData', JSON.stringify(data));
    window.location.href = 'test.html';
  });
  $('#expandAll').addEventListener('click', ()=>setAllCollapsed(false));
  $('#collapseAll').addEventListener('click', ()=>setAllCollapsed(true));

  $('#importBtn').addEventListener('click', ()=>$('#importFile').click());
  $('#importFile').addEventListener('change', (e)=>{
    const file = e.target.files?.[0];
    if(file) importFromFile(file);
    e.target.value = '';
  });
  $('#importLS').addEventListener('click', importFromLocalStorage);
  $('#importTestJson').addEventListener('click', importFromTestJson);

  $('#secCount').addEventListener('input', rebuildSectionsUI);

  rebuildSectionsUI();
  buildForms();
});
</script>
</body>
</html>
<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Rasm-Only Test — Admin (ID/Kod + Sections + Import)</title>

  <!-- MathJax (preview va keypad tugmalarini render qilish uchun) -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$','$'],['\\(','\\)']], displayMath: [['$$','$$'],['\\[','\\]']], processEscapes: true, packages:{'[+]':['noerrors']} },
      options: { renderActions: { addMenu: [] } }, loader: { load: ['[tex]/noerrors'] }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root{--g:#2E8B57;--gd:#1F6B45;--bd:#e9f2ec;--muted:#64748b;--ring:rgba(46,139,87,.18)}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#f6faf8;color:#0f172a}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{display:flex;align-items:center;gap:10px;margin:0 0 16px}
    .pi{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,var(--g),var(--gd));color:#fff;font-weight:800}

    .grid{display:grid;gap:12px}
    .card{background:#fff;border:1px solid var(--bd);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(31,107,69,.06)}
    .row{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    label{font-size:12px;color:#475569}
    input[type="text"],input[type="number"],textarea,select{width:100%;padding:10px 12px;border:1px solid #dfeae3;border-radius:10px;background:#fbfdfc}
    textarea{min-height:92px;resize:vertical}
    .qbox{border:1px dashed #cfe4d7;border-radius:14px;padding:12px;display:grid;gap:12px}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:700;color:#fff;background:linear-gradient(135deg,var(--g),var(--gd));cursor:pointer}
    .btn.ghost{background:#fff;color:#1F6B45;border:1px solid #cfe4d7}
    .btn.danger{background:linear-gradient(135deg,#d32f2f,#b71c1c)}
    .btn.flat{background:#f8fbf9;color:#1F6B45;border:1px solid #cfe4d7}
    .muted{color:#64748b;font-size:13px}
    .flex{display:flex;gap:10px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#f1f8f4;border:1px solid #dfeae3;border-radius:999px;padding:6px 10px;font-size:12px}
    .mini{font-size:12px;color:#64748b}
    .help{font-size:12px;color:#6b7280}
    .answers .opt{display:flex;align-items:center;gap:8px}
    .answers .opt input{transform:translateY(2px)}
    .hr{height:1px;background:#eef4f0;margin:8px 0}
    .side{display:grid;gap:10px}
    .preview{border:1px dashed #dfeae3;border-radius:12px;padding:12px;background:#fbfdfc}
    .warn{color:#b45309}

    /* Drawer keypad */
    .drawer{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);transition:transform .25s ease;background:#fffffff2;backdrop-filter:saturate(1.2) blur(6px);border-top:1px solid #dfeae3;box-shadow:0 -10px 24px rgba(31,107,69,.12);padding:12px 14px;z-index:9999}
    .drawer.open{transform:translateY(0%)}
    .drawer .rowbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .kgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(72px,1fr));gap:8px}
    .kbtn{appearance:none;cursor:pointer;padding:8px 10px;border:1px solid #dfeae3;background:#fff;border-radius:10px;display:flex;align-items:center;justify-content:center;min-height:44px;transition:box-shadow .15s,border-color .15s,background .15s}
    .kbtn:hover{border-color:#b9dfc8;box-shadow:0 0 0 4px var(--ring);background:#fff}
    .pin{display:flex;align-items:center;gap:8px}
    .pin input{transform:translateY(1px)}
    .drawer .title{font-weight:700}
    .toolbar-note{font-size:12px;color:#64748b}

    .qbox.collapsed .row, .qbox.collapsed .side, .qbox.collapsed .preview, .qbox.collapsed .miniLocal {display:none}
    .sec-row{display:grid;gap:10px;grid-template-columns:260px 1fr 1fr 1fr}
    .sec-item{display:contents}
    .sec-list{display:grid;gap:8px}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1><span class="pi">π</span> Rasm-Only Test — Admin</h1>

    <!-- Test meta -->
    <div class="card grid">
      <div class="row">
        <div><label>Sarlavha</label><input id="title" type="text" placeholder="Algebra — Rasm test"></div>
        <div><label>Ta'rif</label><input id="desc" type="text" placeholder="Savol matnisiz, rasm + variantlar"></div>
        <div><label>Test ID (slug)</label><input id="tid" type="text" placeholder="bsb-alg-geo-20"></div>
        <div><label>Test kodi (Firestore uchun)</label><input id="tcode" type="text" placeholder="bsb-a1-2025-10"></div>
        <div><label>Vaqt (daqiqada)</label><input id="dur" type="number" min="0" value="30"></div>
        <div><label>Nechta savol (rasmlar soni)</label><input id="qcount" type="number" min="1" value="20"></div>
      </div>

      <!-- Sections editor -->
      <div class="row">
        <div>
          <label>Nechta bo'lim?</label>
          <input id="secCount" type="number" min="0" value="2">
          <div class="mini">0 bo'lsa — <b>test.html</b> default bo'limlardan foydalanadi.</div>
        </div>
        <div class="sec-list" id="secList"></div>
      </div>

      <!-- Import/Export/Preview -->
      <div class="flex" style="align-items:center;justify-content:space-between">
        <div class="flex" style="gap:8px">
          <button class="btn" id="buildBtn" type="button">Savol shakllarini yarat</button>
          <button class="btn flat" id="importBtn" type="button">Import JSON (fayldan)</button>
          <input id="importFile" type="file" accept="application/json,.json" class="hidden">
          <button class="btn flat" id="importLS" type="button">Import (localStorage)</button>
          <button class="btn flat" id="importTestJson" type="button">Import (test.json)</button>
        </div>
        <div class="flex">
          <button class="btn flat" id="expandAll" type="button">Barchasini yoyish</button>
          <button class="btn flat" id="collapseAll" type="button">Barchasini yig'ish</button>
          <button class="btn ghost" id="toggleDrawer" type="button">Math klaviatura</button>
        </div>
      </div>
    </div>

    <!-- Questions -->
    <div id="questionsArea" class="grid"></div>

    <!-- Footer actions -->
    <div class="card flex" style="justify-content:space-between;align-items:center">
      <div class="flex">
        <button class="btn" id="exportBtn" type="button">Export JSON</button>
        <button class="btn ghost" id="previewBtn" type="button">Preview (test.html)</button>
      </div>
      <div class="muted">"Preview" — <code>localStorage['testData']</code>ga yozadi va <code>test.html</code>ni ochadi.</div>
    </div>

    <div class="card">
      <div class="help"><strong>Eslatma:</strong> Har bir savol uchun <b>birinchi variant</b> avtomatik to'g'ri javob deb belgilanadi (correctIndex = 0).</div>
    </div>
  </div>

  <!-- Drawer keypad -->
  <div id="keypadDrawer" class="drawer" aria-hidden="true">
    <div class="rowbar">
      <div class="title">Math klaviatura</div>
      <div class="pin"><input type="checkbox" id="pinDrawer"><label for="pinDrawer" class="toolbar-note">Doim ochiq</label></div>
    </div>
    <div id="keypadGrid" class="kgrid"></div>
  </div>

<script>
/* ========= Utilities ========= */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const typeset = async (el)=>{ if(window.MathJax?.typesetPromise){ try{ await MathJax.typesetPromise([el]); }catch(_){} } };

// HTML escape (regexsiz)
function escapeHtml(t){
  return t.split('&').join('&amp;').split('<').join('&lt;').split('>').join('&gt;');
}
function looksLikeTeX(s){
  if (!s) return false;
  const needles = ['\\frac','\\sqrt','\\sum','\\int','\\log','\\ln','\\sin','\\cos','\\tan','\\vec','\\pi','\\le','\\ge','\\ne','\\pm','\\cdot','\\times','\\left','\\right'];
  for(const k of needles){ if(s.indexOf(k) !== -1) return true; }
  for(const ch of ['^','_','{','}','\\']){ if(s.indexOf(ch) !== -1) return true; }
  return false;
}
function hasDollarPair(s){
  const i = s.indexOf('$'); if(i === -1) return false;
  return s.indexOf('$', i+1) !== -1;
}
function renderLineForMath(s){
  const safe = escapeHtml(s);
  if (hasDollarPair(s)) return safe;
  if (looksLikeTeX(s)) return '\\(' + safe + '\\)';
  return safe;
}

// Caret insert with '▮' marker
function insertAtCursor(textarea, template){
  textarea.focus();
  const start  = textarea.selectionStart ?? textarea.value.length;
  const end    = textarea.selectionEnd   ?? textarea.value.length;
  const before = textarea.value.slice(0,start);
  const after  = textarea.value.slice(end);
  let out = before + template + after;
  const markerPos = (before + template).indexOf('▮');
  if(markerPos >= 0){ out = out.replace('▮',''); }
  textarea.value = out;
  const pos = markerPos >= 0 ? markerPos : (start + template.length);
  textarea.setSelectionRange(pos, pos);
  textarea.dispatchEvent(new Event('input', { bubbles:true }));
}
function setDrawer(open){
  const d = $('#keypadDrawer');
  d.classList.toggle('open', open);
  d.setAttribute('aria-hidden', open ? 'false' : 'true');
}

/* ========= Keypad ========= */
const KEYS = [
  { show:'x^n',             insert:'^{▮}' },
  { show:'x_n',             insert:'_{▮}' },
  { show:'\\sqrt{}',        insert:'\\sqrt{▮}' },
  { show:'\\sqrt[n]{}',     insert:'\\sqrt[▮]{ }' },
  { show:'\\frac{a}{b}',    insert:'\\frac{▮}{ }' },
  { show:'\\log_a()',       insert:'\\log_{▮}()' },
  { show:'\\ln()',          insert:'\\ln(▮)' },
  { show:'e^{x}',           insert:'e^{▮}' },
  { show:'\\sin()',         insert:'\\sin(▮)' },
  { show:'\\cos()',         insert:'\\cos(▮}' },
  { show:'\\tan()',         insert:'\\tan(▮)' },
  { show:'\\pi',            insert:'\\pi' },
  { show:'\\cdot',          insert:'\\cdot' },
  { show:'\\times',         insert:'\\times' },
  { show:'\\le',            insert:'\\le' },
  { show:'\\ge',            insert:'\\ge' },
  { show:'\\ne',            insert:'\\ne' },
  { show:'\\pm',            insert:'\\pm' },
  { show:'\\sum_{i=1}^{n}', insert:'\\sum_{i=1}^{▮}' },
  { show:'\\int',           insert:'\\int_{▮}^{ }' },
  { show:'\\vec{v}',        insert:'\\vec{▮}' },
  { show:'\\left(\\right)', insert:'\\left(▮\\right)' },
  { show:'\\left[\\right]', insert:'\\left[▮\\right]' },
  { show:'\\left\\{\\right\\}', insert:'\\left\\{▮\\right\\}' }
];
function buildKeypad(){
  const grid = $('#keypadGrid'); grid.innerHTML = '';
  KEYS.forEach(k=>{
    const btn = document.createElement('button');
    btn.type='button'; btn.className='kbtn';
    btn.innerHTML = `$${k.show}$`;
    btn.addEventListener('mousedown', e=>e.preventDefault());
    btn.addEventListener('click', ()=>{
      const targetTA = ACTIVE_TEXTAREA || LAST_ACTIVE_TEXTAREA;
      if(targetTA){ insertAtCursor(targetTA, k.insert); targetTA.focus(); }
    });
    grid.appendChild(btn);
  });
  typeset(grid);
}

/* ========= Sections editor ========= */
function rebuildSectionsUI(){
  const secN = Math.max(0, Number($('#secCount').value||0));
  const list = $('#secList'); list.innerHTML = '';
  if(secN===0){
    list.innerHTML = `<div class="mini warn">Bo'limlar JSON'ga yozilmaydi (test.html default bo'limlardan foydalanadi).</div>`;
    return;
  }
  const hdr = document.createElement('div');
  hdr.className = 'sec-row';
  hdr.innerHTML = `
    <div><label>Bo'lim nomi</label></div>
    <div><label>Boshlanish (1-indeks)</label></div>
    <div><label>Tugash</label></div>
    <div><label>Izoh</label></div>`;
  list.appendChild(hdr);

  for(let i=0;i<secN;i++){
    const row = document.createElement('div'); row.className='sec-row sec-item';
    row.innerHTML = `
      <input type="text" class="sec-name" placeholder="Masalan: Algebra">
      <input type="number" min="1" class="sec-start" placeholder="1">
      <input type="number" min="1" class="sec-end" placeholder="12">
      <div class="mini">Qamrab olgan savollar diapazoni</div>`;
    list.appendChild(row);
  }
}
function collectSections(totalQ){
  const n = Math.max(0, Number($('#secCount').value||0));
  if(n===0) return [];
  const names = $$('#secList .sec-name');
  const starts = $$('#secList .sec-start');
  const ends = $$('#secList .sec-end');
  const out = [];
  for(let i=0;i<n;i++){
    const name = (names[i]?.value || `Bo'lim ${i+1}`).trim();
    const start = Math.max(1, Number(starts[i]?.value||1));
    const end = Math.min(totalQ, Number(ends[i]?.value||totalQ));
    if(start<=end) out.push({ name, start, end });
  }
  return out;
}

/* ========= Question template / logic ========= */
function qTemplate(i){
  return `
  <div class="card qbox" data-index="${i}">
    <div class="flex" style="justify-content:space-between;align-items:center">
      <div class="badge">#${i} — rasm: <code>${i}.jpg</code> / <code>${i}.png</code></div>
      <div class="flex">
        <button class="btn flat" data-minitoggle type="button">Yig'ish</button>
        <button class="btn danger" data-remove type="button">O'chirish</button>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Ball (#${i})</label>
        <input type="number" min="1" value="1" class="points">
      </div>
      <div>
        <label>Javob turi</label>
        <select class="mode" disabled>
          <option value="single">Bir javobli</option>
        </select>
        <div class="mini">Har doim <b>birinchi variant</b> to'g'ri javob.</div>
      </div>
    </div>

    <div class="row">
      <div class="side">
        <div>
          <label class="miniLocal">Variantlar (har satr — bitta, LaTeX uchun $ ... $)</label>
          <textarea class="options" placeholder="A varianti&#10;B varianti&#10;$x^2-1$&#10;$\\sqrt{a^2+b^2}$"></textarea>
          <div class="mini">Focus shu maydonda bo'lsa, pastdagi klaviatura avtomatik ochiladi.</div>
        </div>
        <div style="display:none">
          <label>To'g'ri javob(lar)</label>
          <div class="answers"></div>
          <div class="mini">Variantlar o'zgarganda ro'yxat yangilanadi.</div>
        </div>
      </div>

      <div class="side">
        <label>Jonli preview</label>
        <div class="preview">
          <div class="mini">Savol #${i} — rasm (matn yo'q):</div>
          <div style="margin:6px 0 10px;padding:8px;border:1px solid #eef4f0;border-radius:10px;background:#fff">
            <em>${i}.jpg/png — test.html'da ko'rsatiladi.</em>
          </div>
          <div class="hr"></div>
          <div class="mini">Variantlar:</div>
          <div class="pvOptions"></div>
          <div class="hr"></div>
          <div class="mini">To'g'ri javoblar: ✓ (birinchi varianti)</div>
        </div>
      </div>
    </div>
  </div>`;
}
function updatePreviewFlags(qbox){
  const pv = qbox.querySelector('.pvOptions');
  [...pv.children].forEach((node, idx)=>{
    const flag = node.querySelector('.flag');
    const on = (idx === 0);
    flag.textContent = on ? ' ✓' : '';
    flag.className = 'flag';
  });
}
function rebuildAnswerPickers(qbox){
  const ta = qbox.querySelector('.options');
  const ansBox = qbox.querySelector('.answers');
  const pv = qbox.querySelector('.pvOptions');
  const lines = (ta.value || '').split('\n').map(s=>s.trim()).filter(Boolean);

  ansBox.innerHTML = '';
  lines.forEach((txt, idx)=>{
    const id = `q${qbox.dataset.index}_opt${idx}`;
    const inp = document.createElement('input');
    inp.type = 'radio';
    inp.name = `ans_${qbox.dataset.index}`;
    inp.value = String(idx);
    inp.id = id;
    inp.checked = (idx === 0);

    const lab = document.createElement('label');
    lab.setAttribute('for', id);
    lab.innerHTML = `${idx+1}) <span class="mj">${renderLineForMath(txt)}</span>`;

    const row = document.createElement('div');
    row.className = 'answers opt';
    row.appendChild(inp); row.appendChild(lab);
    ansBox.appendChild(row);
  });

  pv.innerHTML = '';
  lines.forEach((txt, idx)=>{
    const line = document.createElement('div');
    line.innerHTML = `${idx+1}) <span class="mj">${renderLineForMath(txt)}</span> <span class="flag"></span>`;
    pv.appendChild(line);
  });

  typeset(ansBox); typeset(pv); updatePreviewFlags(qbox);
}
function attachQEvents(qbox){
  const ta = qbox.querySelector('.options');
  ta.addEventListener('focus', ()=>{
    ACTIVE_TEXTAREA = ta;
    LAST_ACTIVE_TEXTAREA = ta;
    setDrawer(true);
  });
  ta.addEventListener('blur', ()=>{
    setTimeout(()=>{
      const ae = document.activeElement;
      const isOverDrawer = $('#keypadDrawer').contains(ae);
      if(!$('#pinDrawer').checked && !isOverDrawer){ setDrawer(false); }
    }, 0);
  });
  ta.addEventListener('input', ()=>rebuildAnswerPickers(qbox));

  qbox.querySelector('[data-remove]').addEventListener('click', ()=>qbox.remove());
  qbox.querySelector('[data-minitoggle]').addEventListener('click', (e)=>{
    const collapsed = qbox.classList.toggle('collapsed');
    e.target.textContent = collapsed ? 'Yoyish' : "Yig'ish";
  });

  rebuildAnswerPickers(qbox);
}
function buildForms(){
  const n = Math.max(1, Number($('#qcount').value||1));
  const area = $('#questionsArea'); area.innerHTML = '';
  for(let i=1;i<=n;i++){
    const holder = document.createElement('div');
    holder.innerHTML = qTemplate(i);
    const el = holder.firstElementChild;
    area.appendChild(el);
    attachQEvents(el);
  }
}

/* ========= Export / Import / Preview ========= */
function collectJson(){
  const title = $('#title').value || 'Rasm-Only Test';
  const description = $('#desc').value || 'Rasm + variant';
  const id   = ($('#tid')?.value || '').trim();
  const code = ($('#tcode')?.value || '').trim();
  const durationMinutes = Number($('#dur').value||0);
  const qcount = Math.max(1, Number($('#qcount').value||1));

  const questions = [];
  $$('#questionsArea .qbox').forEach(qbox=>{
    const points = Math.max(1, Number(qbox.querySelector('.points').value||1));
    const opts = (qbox.querySelector('.options').value||'').split('\n').map(s=>s.trim()).filter(Boolean);
    questions.push({ points, options: opts, correctIndex: 0 });
  });

  const sections = collectSections(qcount);

  const out = { title, description, durationMinutes, sections, questions };
  if(id) out.id = id;
  if(code) out.code = code;
  return out;
}
function download(filename, blob){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}
function setAllCollapsed(state){
  $$('#questionsArea .qbox').forEach(qb=>{
    const btn = qb.querySelector('[data-minitoggle]');
    const collapsed = qb.classList.contains('collapsed');
    if(state && !collapsed){ btn.click(); }
    if(!state && collapsed){ btn.click(); }
  });
}
function normalizeImported(data){
  if(!data) throw new Error("Fayl bo'sh yoki o'qilmadi");
  if(Array.isArray(data)) data = { questions: data };
  if(!Array.isArray(data.questions)){
    const candidate = data.items || data.qs || data.list || data.data;
    if(Array.isArray(candidate)) data.questions = candidate;
  }
  if(!Array.isArray(data.questions)) throw new Error("JSON format mos emas. 'questions' massiv topilmadi.");
  if(data.totalTime && !data.durationMinutes) data.durationMinutes = Number(data.totalTime);

  data.title = data.title || 'Rasm-Only Test';
  data.description = data.description || 'Rasm + variant';

  data.questions = data.questions.map(q=>{
    if(typeof q === 'string'){
      return { points: 1, options: q.split(/\r?\n/).map(s=>s.trim()).filter(Boolean), correctIndex: 0 };
    }
    const qq = { ...q };
    if(!Array.isArray(qq.options) && typeof qq.opts === 'string'){
      qq.options = qq.opts.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    }
    if(!Array.isArray(qq.options) && Array.isArray(qq.opts)) qq.options = qq.opts;
    if(typeof qq.correctOption==='number' && qq.correctIndex===undefined) qq.correctIndex = Number(qq.correctOption);
    qq.points = Number(qq.points||1);
    if(!Array.isArray(qq.options)) qq.options = [];
    return qq;
  });

  if(!Array.isArray(data.sections)) data.sections = [];
  return data;
}
function applyTestData(data){
  const d = normalizeImported(data);

  $('#title').value = d.title || '';
  $('#desc').value  = d.description || '';
  $('#tid').value   = d.id || '';
  $('#tcode').value = d.code || '';
  $('#dur').value   = Number(d.durationMinutes||0);

  $('#secCount').value = (d.sections && d.sections.length) ? d.sections.length : 0;
  rebuildSectionsUI();
  if(d.sections && d.sections.length){
    const names  = $$('#secList .sec-name');
    const starts = $$('#secList .sec-start');
    const ends   = $$('#secList .sec-end');
    d.sections.forEach((s, i)=>{
      if(names[i])  names[i].value  = s.name  || `Bo'lim ${i+1}`;
      if(starts[i]) starts[i].value = s.start ?? '';
      if(ends[i])   ends[i].value   = s.end   ?? '';
    });
  }

  $('#qcount').value = d.questions.length;
  buildForms();

  $$('#questionsArea .qbox').forEach((qbox, idx)=>{
    const q = d.questions[idx];
    if(!q) return;
    qbox.querySelector('.points').value = Number(q.points||1);
    const ta = qbox.querySelector('.options');
    ta.value = (q.options||[]).join('\n');
    rebuildAnswerPickers(qbox);
    const inp = qbox.querySelector('.answers input[value="0"]');
    if(inp){ inp.checked = true; }
    updatePreviewFlags(qbox);
  });

  typeset($('#questionsArea'));
}
async function importFromFile(file){
  try{
    let text = await file.text();
    if(text.charCodeAt(0)===0xFEFF) text = text.slice(1);
    const json = JSON.parse(text);
    applyTestData(json);
  }catch(err){
    alert('Import xatosi: ' + (err?.message||err) + "\n\nTekshiring: fayl JSON va unda 'questions' massiv bor.");
  }
}
async function importFromLocalStorage(){
  try{
    const raw = localStorage.getItem('testData');
    if(!raw) throw new Error("localStorage['testData'] topilmadi.");
    const data = JSON.parse(raw);
    applyTestData(data);
  }catch(e){
    alert('localStorage import xatosi: ' + e.message);
  }
}
async function importFromTestJson(){
  try{
    const r = await fetch('test.json', { cache: 'no-store' });
    if(!r.ok) throw new Error('test.json o\'qilmadi');
    const data = await r.json();
    applyTestData(data);
  }catch(e){
    alert('test.json o\'qishda xatolik: ' + e.message + "\n\nEslatma: file:// bilan ochilganda fetch ishlamasligi mumkin. Kichik lokal serverda ishga tushiring.");
  }
}

/* ========= Global keypad & init ========= */
let ACTIVE_TEXTAREA = null;
let LAST_ACTIVE_TEXTAREA = null;

function renderLineForMath(s){ // (uses escapeHtml/looksLikeTeX/hasDollarPair)
  const safe = escapeHtml(s);
  if (hasDollarPair(s)) return safe;
  if (looksLikeTeX(s)) return '\\(' + safe + '\\)';
  return safe;
}

buildKeypad();
$('#toggleDrawer').addEventListener('click', ()=>{
  const open = !$('#keypadDrawer').classList.contains('open');
  setDrawer(open);
});
$('#keypadGrid').addEventListener('mousedown', e=>e.preventDefault());

document.addEventListener('focusin', (e)=>{
  if(e.target && e.target.tagName==='TEXTAREA'){
    ACTIVE_TEXTAREA = e.target;
    LAST_ACTIVE_TEXTAREA = e.target;
  }
});

document.addEventListener('DOMContentLoaded', ()=>{
  $('#buildBtn').addEventListener('click', buildForms);
  $('#exportBtn').addEventListener('click', ()=>{
    const data = collectJson();
    download('test.json', new Blob([JSON.stringify(data, null, 2)], {type:'application/json'}));
  });
  $('#previewBtn').addEventListener('click', ()=>{
    const data = collectJson();
    localStorage.setItem('testData', JSON.stringify(data));
    window.location.href = 'test.html';
  });
  $('#expandAll').addEventListener('click', ()=>setAllCollapsed(false));
  $('#collapseAll').addEventListener('click', ()=>setAllCollapsed(true));

  $('#importBtn').addEventListener('click', ()=>$('#importFile').click());
  $('#importFile').addEventListener('change', (e)=>{
    const file = e.target.files?.[0];
    if(file) importFromFile(file);
    e.target.value = '';
  });
  $('#importLS').addEventListener('click', importFromLocalStorage);
  $('#importTestJson').addEventListener('click', importFromTestJson);

  $('#secCount').addEventListener('input', rebuildSectionsUI);

  rebuildSectionsUI();
  buildForms();
});
</script>
</body>
</html>
