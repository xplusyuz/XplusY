<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LeaderMath — Test</title>

  <!-- MathJax -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$','$'],['\\(','\\)']], displayMath: [['$$','$$'],['\\[','\\]']], processEscapes:true, packages:{'[+]':['noerrors']} },
      options: { renderActions: { addMenu: [] } }, loader: { load: ['[tex]/noerrors'] }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root{ --brand:#2E8B57; --brand2:#1F6B45; --bg:#f6faf8; --text:#0f172a; --muted:#667a72; --frame:#e3efe8; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--frame);z-index:10}
    .wrap{max-width:960px;margin:0 auto;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{border:1px solid #d8e9df;background:#f4fbf7;padding:6px 10px;border-radius:999px}
    .chip.good{background:#e8f5ee;border-color:#c7ead6;color:#0f5132}
    .chip.warn{background:#fff4e5;border-color:#ffe0b2;color:#8a4b03}
    .chip.bad{ background:#fdecea;border-color:#f5c2c7;color:#842029}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--brand);background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;cursor:pointer;font-weight:700;text-decoration:none;display:inline-block}
    .btn.ghost{background:#fff;color:var(--brand)}
    .card{background:#fff;border:1px solid var(--frame);border-radius:16px;padding:16px;margin:16px 0}
    .opt{display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border:1px solid #edf3ee;border-radius:12px;background:#fbfdfc;margin:8px 0}
    .navdots{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .dot{min-width:36px;height:36px;border-radius:10px;border:1px solid var(--frame);display:grid;place-items:center;background:#fff;cursor:pointer;padding:0 10px}
    .dot.active{border-color:var(--brand)}
    .dot.answered{background:#1F6B45;color:#fff;border-color:#0f3c28}
    #qImage{width:min(860px,100%);max-height:80vh;display:block;margin:10px auto;border-radius:12px;border:1px solid #edf3ee}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
    .stat{border:1px solid var(--frame);border-radius:12px;padding:10px}
    .tbl{width:100%;border-collapse:separate;border-spacing:0 8px}
    .tbl th{font-weight:700;text-align:left;color:#64748b;font-size:14px}
    .tbl td,.tbl th{padding:8px 10px;background:#fff}
    @media print{body{display:none}}
  </style>
</head>
<body>
  <header>
    <div class="wrap row" style="justify-content:space-between">
      <div class="row">
        <b>LeaderMath — Test</b>
        <span class="chip">BSB / CHSB sinov</span>
      </div>
      <div class="row">
        <span id="authInfo" class="chip">Kirish: aniqlanmoqda…</span>
        <span id="saveStatusTop" class="chip hidden"></span>
        <a class="btn ghost" href="https://xplusy.netlify.app/index">HOME</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Intro -->
    <section id="introCard" class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 id="testTitle" style="margin:6px 0 10px">Test</h2>
          <div class="row" style="gap:8px;margin:6px 0 8px">
            <span id="codeChip" class="chip hidden">Kod: —</span>
          </div>
          <div id="testDesc" style="color:#667a72">Rasm + variantlar.</div>
          <div class="row" style="gap:8px;margin-top:8px">
            <span id="metaCount" class="chip">Savollar: —</span>
            <span id="metaPoints" class="chip">Umumiy ball: —</span>
            <span id="metaTimer" class="chip hidden">00:00</span>
          </div>
        </div>
        <button id="startBtn" class="btn">Boshlash</button>
      </div>
    </section>

    <!-- Questions -->
    <section id="questionsCard" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <div><b id="qIndex">1</b>/<span id="qTotal">—</span> <span id="qSect" class="chip"></span></div>
        <div class="row">
          <span id="qTimer" class="chip hidden">00:00</span>
          <button id="prevBtn" class="btn ghost">← Oldingi</button>
          <button id="nextBtn" class="btn">Keyingi →</button>
        </div>
      </div>
      <div style="margin-top:10px">
        <div id="qText"></div>
        <img id="qImage" alt="Savol rasmi">
        <div id="opts"></div>
      </div>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <div id="navDots" class="navdots"></div>
        <button id="finishBtn" class="btn">Yakunlash</button>
      </div>
    </section>

    <!-- Results -->
    <section id="resultCard" class="card hidden">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div style="font-size:20px;font-weight:800">Natija: <span id="scoreTotal">0</span>/<span id="scoreMax">0</span></div>
          <div id="scoreNote" style="color:#667a72;margin-top:6px"></div>
          <div id="timeNote" style="color:#667a72;margin-top:4px"></div>
        </div>
        <div class="row">
          <span id="saveStatus" class="chip hidden"></span>
          <a class="btn ghost" href="https://xplusy.netlify.app/index">HOME</a>
          <button id="againBtn" class="btn ghost">Savollarga qaytish</button>
        </div>
      </div>

      <div class="stats-grid" style="margin-top:12px">
        <div class="stat"><div style="color:#667a72;font-size:12px">To‘g‘ri</div><div style="font-weight:800;font-size:20px" id="stCorrect">0</div></div>
        <div class="stat"><div style="color:#667a72;font-size:12px">Noto‘g‘ri</div><div style="font-weight:800;font-size:20px" id="stWrong">0</div></div>
        <div class="stat"><div style="color:#667a72;font-size:12px">Foiz</div><div style="font-weight:800;font-size:20px" id="stPct">0%</div></div>
        <div class="stat"><div style="color:#667a72;font-size:12px">Umumiy ball</div><div style="font-weight:800;font-size:20px" id="stPoints">0</div></div>
      </div>

      <div class="card" style="margin:14px 0">
        <h3 style="margin:0 0 8px">Bo‘limlar kesimida</h3>
        <div id="sectionStats"></div>
      </div>

      <div class="card" style="margin:14px 0">
        <h3 style="margin:0 0 8px">Javoblar tahlili</h3>
        <div id="detailTable"></div>
      </div>
    </section>

    <section id="emptyCard" class="card hidden" style="text-align:center">
      <h3>Test topilmadi</h3>
      <p class="muted">Shu papkaga <code>test.json</code> qo‘ying yoki <code>localStorage['testData']</code>ga yozing.</p>
    </section>
  </main>

  <script type="module">
    /* Firebase */
    import { auth, db, onAuthStateChanged } from "/lib/firebase.client.js";
    import { requireAuth } from "/lib/auth-guard.js";
    import { doc, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    /* ===== Helpers ===== */
    const $ = (s)=>document.querySelector(s);
    const pad2 = (n)=>String(Math.max(0,n)).padStart(2,'0');
    const sum = (a)=>a.reduce((x,y)=>x+y,0);
    const isMulti = (q)=>Array.isArray(q.correctIndices);
    const normalize = (arr)=>Array.from(new Set((arr||[]).map(Number))).sort((a,b)=>a-b);
    const arraysEqual = (a,b)=>a.length===b.length && a.every((v,i)=>v===b[i]);
    const fmt = (x)=>{ const r=Math.round((+x+Number.EPSILON)*100)/100; return (Math.abs(r)%1===0)? String(Math.trunc(r)) : String(r); };
    const slug = (s)=>(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');

    function showSaveStatus(msg, kind='good'){
      const top = $('#saveStatusTop'); const bot = $('#saveStatus');
      [top,bot].forEach(el=>{
        if(!el) return;
        el.textContent = msg;
        el.classList.remove('hidden','good','bad','warn');
        el.classList.add(kind);
      });
    }

    // MathJax wrap
    const TEX_TOKENS=['\\frac','\\sqrt','\\sum','\\int','\\pi','\\alpha','\\beta','\\gamma','\\le','\\ge','\\cdot','\\times','\\pm','\\ln','\\log','\\sin','\\cos','\\tan','^','_'];
    function looksLikeTeX(s){
      if(typeof s!=='string') return false;
      if(s.includes('$')||s.includes('\\(')||s.includes('\\[')) return false;
      for(const t of TEX_TOKENS){ if(s.indexOf(t)!==-1) return true; }
      return false;
    }
    const wrapTeX = (s)=> looksLikeTeX(s) ? `\\(${s}\\)` : s;
    const mjReady = ()=> new Promise(res=>{
      const tick=()=> (window.MathJax&&window.MathJax.typesetPromise)?res():setTimeout(tick,30);
      tick();
    });
    async function typeset(el){ await mjReady(); try{ await MathJax.typesetPromise([el]); }catch{} }

    /* ===== State ===== */
    let testData=null, currentIndex=0, answers=[], startedAt=null, timeLeftSec=0, timerId=null, spentSeconds=0;

    const params = new URLSearchParams(location.search);
    const rawIdFromUrl = params.get('id');
    let currentTestId = rawIdFromUrl || (location.pathname.split('/').pop().replace(/\..*$/,'') || 'test');
    let currentTestCode = params.get('code') || null;

    /* ===== Auth ===== */
    await requireAuth();
    onAuthStateChanged(auth, (user)=>{
      $('#authInfo').textContent = user ? `Kirish: ${user.displayName || user.email}` : 'Kirish: mehmon';
    });

    /* ===== Load test data ===== */
    function applySectionRanges(data){
      if(!Array.isArray(data.questions)) return;
      if(Array.isArray(data.sections)){
        data.sections.forEach((sec)=>{
          const name=sec.name||'Umumiy';
          const s=Math.max(1,Number(sec.start||1));
          const e=Math.min(data.questions.length,Number(sec.end||data.questions.length));
          for(let i=s-1;i<e;i++){ data.questions[i].section = data.questions[i].section || name; }
        });
      }
      data.questions.forEach(q=>{ if(!q.section) q.section='Umumiy'; });
    }
    function normalizeTestData(data){
      if(!data || !Array.isArray(data.questions)) return data;
      data.title = data.title || 'Test';
      data.description = data.description || 'Rasm + variantlar';
      data.questions = data.questions.map(q=>({ ...q, points:Number(q.points||1)}));
      if(data.totalTime && !data.durationMinutes) data.durationMinutes=Number(data.totalTime);
      applySectionRanges(data);
      data.id = data.id || slug(data.title);
      data.code = data.code || slug(data.title);
      return data;
    }
    async function loadTestData(){
      const stored = localStorage.getItem('testData');
      if(stored){ try{ testData = normalizeTestData(JSON.parse(stored)); return; }catch{} }
      try{
        const r = await fetch('./test.json',{cache:'no-store'});
        if(!r.ok) throw new Error('no test.json');
        testData = normalizeTestData(await r.json());
      }catch{
        testData = normalizeTestData({
          title:'Demo test', description:'Fallback ma’lumotlar', durationMinutes:1, code:'demo-001',
          questions:[
            {section:'Algebra', text:'1) $2+2$ nechiga teng?', options:['2','3','4','5'], correctIndex:2, points:1},
            {section:'Sonlar nazariyasi', text:'2) \\(\\text{Tub son(lar)}\\)', options:['2','4','5','9'], correctIndices:[0,2], points:2},
            {section:'Geometriya', text:'3) Nisbatni toping.', options:['1:1','1:2','2:3','3:4'], correctIndex:0, points:1}
          ]
        });
      }
      // shuffle
      testData.questions.forEach(q=>{
        const idxs=[...Array(q.options.length).keys()];
        for(let i=idxs.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); const t=idxs[i]; idxs[i]=idxs[j]; idxs[j]=t; }
        q._perm=idxs;
      });
    }

    /* ===== UI ===== */
    function buildNavDots(){
      const n=testData.questions.length, root=$('#navDots'); root.innerHTML='';
      for(let i=0;i<n;i++){
        const b=document.createElement('button'); b.className='dot'; b.dataset.idx=String(i); b.textContent=String(i+1);
        b.addEventListener('click', ()=>{ currentIndex=i; renderQuestion(); });
        root.appendChild(b);
      }
      refreshDotsState(); highlightDot(0);
    }
    function highlightDot(i){ [...document.querySelectorAll('.dot')].forEach((el,idx)=>el.classList.toggle('active', idx===i)); }
    function refreshDotsState(){ [...document.querySelectorAll('.dot')].forEach((el)=>{ const i=Number(el.dataset.idx); const hasAns=!!(answers[i]&&answers[i].length); el.classList.toggle('answered',hasAns); }); }

    async function resolveImageSrc(idx1){
      const q=testData.questions[idx1-1]||{};
      const cand=[`./${idx1}.jpg`,`./${idx1}.png`,`./${idx1}.jpeg`,`./${idx1}.webp`, q.image||''].filter(Boolean);
      for(const u of cand){
        const ok = await new Promise(r=>{ const img=new Image(); img.onload=()=>r(true); img.onerror=()=>r(false); img.src=u+(u.includes('?')?'':`?t=${Date.now()}`); });
        if(ok) return u;
      }
      return '';
    }

    function renderQuestion(){
      const q=testData.questions[currentIndex];
      $('#qIndex').textContent=String(currentIndex+1);
      $('#qTotal').textContent=String(testData.questions.length);
      $('#qText').innerHTML = wrapTeX(q.text||'');
      $('#qSect').textContent = q.section||'Umumiy';
      $('#opts').innerHTML='';

      const multi=isMulti(q);
      const chosen=new Set(answers[currentIndex]||[]);
      const order=q._perm&&q._perm.length===q.options.length?q._perm:[...Array(q.options.length).keys()];
      order.forEach((orig)=>{
        const row=document.createElement('label'); row.className='opt';
        const inp=document.createElement('input'); inp.type=multi?'checkbox':'radio'; inp.name='q'+currentIndex+(multi?'[]':''); inp.value=String(orig); inp.checked=chosen.has(orig);
        inp.addEventListener('change', ()=>{
          if(multi){ if(inp.checked) chosen.add(orig); else chosen.delete(orig); answers[currentIndex]=normalize([...chosen]); }
          else { answers[currentIndex]=inp.checked?[orig]:[]; }
          refreshDotsState();
        });
        const span=document.createElement('span'); span.innerHTML=wrapTeX(q.options[orig]);
        row.appendChild(inp); row.appendChild(span); $('#opts').appendChild(row);
      });
      resolveImageSrc(currentIndex+1).then(src=>{ $('#qImage').src=src; });
      highlightDot(currentIndex); typeset($('#questionsCard'));
    }

    function startTimerIfNeeded(){
      const minutes=Number(testData.durationMinutes||0);
      const both=(txt,show)=>{ $('#metaTimer').textContent=txt; $('#qTimer').textContent=txt; $('#metaTimer').classList.toggle('hidden',!show); $('#qTimer').classList.toggle('hidden',!show); };
      if(!minutes){ both('00:00',false); return; }
      timeLeftSec=Math.round(minutes*60); both(`${pad2(Math.floor(timeLeftSec/60))}:${pad2(timeLeftSec%60)}`,true);
      timerId=setInterval(()=>{
        timeLeftSec--; spentSeconds++;
        const m=Math.max(0,Math.floor(timeLeftSec/60)), s=Math.max(0,timeLeftSec%60);
        both(`${pad2(m)}:${pad2(s)}`,true);
        if(timeLeftSec<=0){ clearInterval(timerId); onFinish(); }
      },1000);
    }

    function computeTotals(){
      let total=0, max=0; const perQuestion=[]; const sectionAgg=new Map();
      testData.questions.forEach((q,i)=>{
        const sect=q.section||'Umumiy'; const pts=Number(q.points||1); max+=pts;
        const picked=normalize(answers[i]||[]);
        const correct=isMulti(q)?normalize(q.correctIndices||[]):[Number(q.correctIndex??-1)];
        const ok=isMulti(q)?arraysEqual(picked,correct):(picked.length===1 && picked[0]===correct[0]);
        if(ok) total+=pts;
        if(!sectionAgg.has(sect)) sectionAgg.set(sect,{q:0,ok:0,pts:0,ptsMax:0});
        const a=sectionAgg.get(sect); a.q+=1; a.ptsMax+=pts; if(ok){ a.ok+=1; a.pts+=pts; }
        perQuestion.push({i,section:sect,pts:Number(pts||0),ok:!!ok,picked:Array.isArray(picked)?picked:[],correct:Array.isArray(correct)?correct:[],text:String(q.text||''),options:Array.isArray(q.options)?q.options.map(v=>String(v??'')):[]});
      });
      return { total, max, perQuestion, sectionAgg };
    }

    async function addPointsOnce({ uid, testCode, delta }){
      if(!uid || !testCode) return { skipped:true };
      const add=Number(delta||0); if(!(add>0)) return { skipped:true };
      const markRef=doc(db,'points_marks',uid,'tests',testCode);
      const totalRef=doc(db,'points',uid);
      return runTransaction(db, async (tx)=>{
        const mark=await tx.get(markRef); if(mark.exists()) return { skipped:true };
        const tot=await tx.get(totalRef); const cur=tot.exists()?Number(tot.data()?.points||0):0; const next=cur+add;
        tx.set(totalRef,{points:next},{merge:true});
        tx.set(markRef,{added:add,testCode,at:serverTimestamp()});
        return { skipped:false, added:add, total:next };
      });
    }

    async function saveFirstResultOnly({ testCode, uid, total, max, detail }){
      const ref=doc(db,'results',testCode,'users',uid);
      return runTransaction(db, async (tx)=>{
        const snap=await tx.get(ref); const computedBall=Number(total||0);
        if(snap.exists()){
          const data=snap.data()||{}; const hasValidBall=(typeof data.ball==='number' && data.ball>0);
          if(!hasValidBall){
            const fromFirst= (typeof data.firstTotal==='number')? data.firstTotal : 0;
            const patched = (computedBall>0?computedBall:fromFirst);
            tx.update(ref,{ ball: Number(patched) });
            return { skipped:true, patched:true, ball:Number(patched) };
          }
          return { skipped:true, patched:false, already:data };
        }
        tx.set(ref,{
          uid, testCode, testId:(testData.id||currentTestId), title:(testData.title||''),
          ball:Number(computedBall), firstTotal:Number(computedBall), max:Number(max||0),
          percent:(max?Math.round((computedBall/max)*100):0),
          detail:Array.isArray(detail)?detail:[], createdAt:serverTimestamp(), spentSeconds:Number(spentSeconds||0)
        });
        return { skipped:false, patched:false, ball:Number(computedBall) };
      });
    }

    function renderSectionStats(sectionAgg){
      const container=document.createElement('div'); container.className='stats-grid';
      for(const [name,a] of sectionAgg.entries()){
        const pct=a.q?Math.round((a.ok/a.q)*100):0;
        const card=document.createElement('div'); card.className='stat';
        card.innerHTML=`<div style="font-weight:700;margin-bottom:4px">${name}</div>
                        <div style="color:#667a72;font-size:12px">Savollar: ${a.q}</div>
                        <div style="margin-top:6px"><b>${fmt(a.pts)}</b>/<b>${fmt(a.ptsMax)}</b> · <b>${pct}%</b></div>`;
        container.appendChild(card);
      }
      const root=$('#sectionStats'); root.innerHTML=''; root.appendChild(container);
    }

    function renderDetail(perQuestion){
      const table=document.createElement('table'); table.className='tbl';
      table.innerHTML=`<thead class="rowbox">
        <tr><th>#</th><th>Bo‘lim</th><th>Savol</th><th>Tanlangan</th><th>To‘g‘ri</th><th style="text-align:right">Ball</th></tr>
      </thead><tbody id="detailBody"></tbody>`;
      const body=table.querySelector('#detailBody');
      perQuestion.forEach((r)=>{
        const picked=r.picked.length? r.picked.map(x=>x+1).join(', ') : '—';
        const correct=r.correct.map(x=>x+1).join(', ');
        const tr=document.createElement('tr'); tr.className='rowbox';
        tr.innerHTML=`<td>${r.i+1}</td>
                      <td><span class="chip">${r.section}</span></td>
                      <td style="max-width:360px">${wrapTeX(r.text||'')}</td>
                      <td>${picked} ${r.ok?'✓':'✗'}</td>
                      <td>${correct}</td>
                      <td style="text-align:right"><b>${r.ok?fmt(r.pts):0}</b>/<b>${fmt(r.pts)}</b></td>`;
        body.appendChild(tr);
      });
      const root=$('#detailTable'); root.innerHTML=''; root.appendChild(table); typeset(root);
    }

    async function onFinish(){
      if(timerId){ clearInterval(timerId); timerId=null; }
      if(startedAt){ const now=new Date(); spentSeconds=Math.max(spentSeconds, Math.floor((now-startedAt)/1000)); }

      const { total, max, perQuestion, sectionAgg } = computeTotals();
      $('#questionsCard').classList.add('hidden'); $('#resultCard').classList.remove('hidden');
      $('#scoreTotal').textContent=fmt(total); $('#scoreMax').textContent=fmt(max);
      $('#scoreNote').textContent=`To‘g‘ri: ${perQuestion.filter(x=>x.ok).length} / ${perQuestion.length}`;
      $('#timeNote').textContent=`Sarflangan vaqt: ${pad2(Math.floor(spentSeconds/60))}:${pad2(spentSeconds%60)}`;
      $('#stCorrect').textContent=String(perQuestion.filter(x=>x.ok).length);
      $('#stWrong').textContent=String(perQuestion.length - perQuestion.filter(x=>x.ok).length);
      $('#stPct').textContent=(max?Math.round((total/max)*100):0) + '%';
      $('#stPoints').textContent=`${fmt(total)}/${fmt(max)}`;
      renderSectionStats(sectionAgg);
      renderDetail(perQuestion);

      const safeDetail = perQuestion.map(r=>({ i:r.i, section:r.section||'Umumiy', pts:Number(r.pts||0), ok:!!r.ok,
        picked:Array.isArray(r.picked)?r.picked:[], correct:Array.isArray(r.correct)?r.correct:[],
        text:String(r.text||''), options:Array.isArray(r.options)?r.options.map(v=>String(v??'')):[] }));

      const user=auth.currentUser;
      if(!currentTestCode){ showSaveStatus('Kod topilmadi — saqlanmadi','warn'); return; }
      if(!user){ showSaveStatus('Kirmagansiz — saqlanmadi','warn'); return; }

      try{
        const res = await saveFirstResultOnly({ testCode:currentTestCode, uid:user.uid, total, max, detail:safeDetail });
        if(!res.skipped || res.patched){
          try{
            const p = await addPointsOnce({ uid:user.uid, testCode:currentTestCode, delta:res.ball });
            if(!p.skipped){ showSaveStatus(`Saqlandi (ball=${res.ball}) · Points +${p.added} → ${p.total}`,'good'); }
            else { showSaveStatus(`Saqlandi (ball=${res.ball}) · Points o‘zgarmadi`,'good'); }
          }catch(e){
            console.error('points add error:', e);
            showSaveStatus(`Saqlandi (ball=${res.ball}), lekin points qo‘shilmadi: ${e?.message||e}`,'warn');
          }
        } else {
          showSaveStatus('Oldin saqlangan (ball bor) — qayta yozilmadi','warn');
        }
      }catch(e){
        console.error('save error:', e);
        showSaveStatus('Saqlashda xatolik: ' + (e?.message||e), 'bad');
      }
    }

    async function boot(){
      await loadTestData();
      if(!testData || !testData.questions?.length){
        $('#introCard').classList.add('hidden'); $('#questionsCard').classList.add('hidden'); $('#emptyCard').classList.remove('hidden'); return;
      }
      currentTestId = rawIdFromUrl || testData.id || currentTestId;
      currentTestCode = currentTestCode || testData.code || currentTestId;

      $('#testTitle').textContent=testData.title||'Test';
      if(currentTestCode){ $('#codeChip').textContent=`Kod: ${currentTestCode}`; $('#codeChip').classList.remove('hidden'); }
      document.title = `${testData.title||'Test'} — ${currentTestCode?('#'+currentTestCode):''} | LeaderMath`;
      $('#testDesc').textContent=testData.description||'';
      $('#metaCount').textContent=`Savollar: ${testData.questions.length}`;
      $('#metaPoints').textContent=`Umumiy ball: ${fmt(sum(testData.questions.map(q=>q.points)))}`;

      const minutes=Number(testData.durationMinutes||0);
      if(minutes>0){ $('#metaTimer').textContent=`${pad2(minutes)}:00`; $('#metaTimer').classList.remove('hidden'); }

      answers=Array.from({length:testData.questions.length},()=>[]);
      buildNavDots();

      $('#startBtn').onclick=()=>{ startedAt=new Date(); spentSeconds=0; $('#introCard').classList.add('hidden'); $('#questionsCard').classList.remove('hidden'); renderQuestion(); startTimerIfNeeded(); };
      $('#prevBtn').onclick=()=>{ if(currentIndex>0){ currentIndex--; renderQuestion(); } };
      $('#nextBtn').onclick=()=>{ if(currentIndex<testData.questions.length-1){ currentIndex++; renderQuestion(); } };
      $('#finishBtn').onclick=onFinish;
      $('#againBtn').onclick=()=>{ $('#resultCard').classList.add('hidden'); $('#questionsCard').classList.remove('hidden'); renderQuestion(); };
    }
    boot();
  </script>
</body>
</html>
