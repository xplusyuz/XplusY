<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LeaderMath — Test</title>

  <!-- MathJax -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$','$'],['\\(','\\)']], displayMath: [['$$','$$'],['\\[','\\]']], processEscapes:true, packages:{'[+]':['noerrors']} },
      options: { renderActions: { addMenu: [] } }, loader: { load: ['[tex]/noerrors'] }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root{ --brand:#2E8B57; --brand2:#1F6B45; --bg:#f6faf8; --text:#0f172a; --muted:#667a72; --frame:#e3efe8; --dark:#0f3c28; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--frame);z-index:10}
    .wrap{max-width:960px;margin:0 auto;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .pi{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;display:grid;place-items:center;font-weight:900}
    .chip{border:1px solid #d8e9df;background:#f4fbf7;padding:6px 10px;border-radius:999px}
    .chip.good{background:#e8f5ee;border-color:#c7ead6;color:#0f5132}
    .chip.warn{background:#fff4e5;border-color:#ffe0b2;color:#8a4b03}
    .chip.bad{ background:#fdecea;border-color:#f5c2c7;color:#842029}
    .card{background:#fff;border:1px solid var(--frame);border-radius:16px;padding:16px;margin:16px 0;box-shadow:0 8px 24px rgba(20,40,30,.06)}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--brand);background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;cursor:pointer;font-weight:700;text-decoration:none;display:inline-block}
    .btn.ghost{background:#fff;color:var(--brand)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .hidden{display:none!important}

    /* Savol UI */
    .qtext{font-size:18px;margin-bottom:10px}
    .opt{display:flex;gap:10px;align-items:flex-start;padding:10px 12px;border:1px solid #edf3ee;border-radius:12px;background:#fbfdfc;margin:8px 0;transition: box-shadow .2s ease, background .2s ease, border-color .2s ease;}
    .opt:hover{border-color:var(--brand);box-shadow:0 0 0 4px rgba(46,139,87,.15);background:#fff}
    .navdots{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .dot{min-width:36px;height:36px;border-radius:10px;border:1px solid var(--frame);display:grid;place-items:center;background:#fff;cursor:pointer;padding:0 10px}
    .dot.active{border-color:var(--brand);box-shadow:0 0 0 3px rgba(46,139,87,.15)}
    .dot.answered{background:var(--brand2); color:#fff; border-color:var(--dark); box-shadow:0 0 0 2px rgba(31,107,69,.25)}
    .score{font-size:20px;font-weight:800}
    .ok{color:#1F6B45} .bad{color:#b91c1c}
    #qImage{width:min(860px,100%);max-height:80vh;display:block;margin:10px auto;border-radius:12px;border:1px solid #edf3ee;box-shadow:0 6px 18px rgba(31,107,69,.06);-webkit-user-drag:none;user-select:none}

    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
    .stat{border:1px solid var(--frame);border-radius:12px;padding:10px}
    .tbl{width:100%;border-collapse:separate;border-spacing:0 8px}
    .tbl th{font-weight:700;text-align:left;color:var(--muted);font-size:14px}
    .tbl td,.tbl th{padding:8px 10px;background:#fff}
    .rowbox{border:1px solid var(--frame);border-radius:12px;overflow:hidden}
    .sect{display:inline-block;margin:0 6px 6px 0;padding:4px 8px;border:1px solid var(--frame);border-radius:999px;background:#f8fcfa;font-size:12px;color:#0b3a25}

    @media print { body{display:none} }
  </style>
</head>
<body>
  <header>
    <div class="wrap row" style="justify-content:space-between">
      <div class="brand">
        <div class="pi">π</div>
        <div>
          <div style="font-weight:800">LeaderMath — Test</div>
          <small style="color:var(--muted)">BSB / CHSB sinov</small>
        </div>
      </div>
      <div class="row">
        <span id="authInfo" class="chip">Kirish: aniqlanmoqda…</span>
        <span id="saveStatusTop" class="chip hidden"></span>
        <a href="https://xplusy.netlify.app/index" class="btn ghost" id="homeBtn">HOME</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Intro -->
    <section id="introCard" class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 style="margin:6px 0 10px" id="testTitle">Test</h2>
          <div class="row" style="gap:8px; margin:6px 0 8px">
            <span id="codeChip" class="chip hidden">Kod: —</span>
          </div>
          <div id="testDesc" style="color:var(--muted)">Rasm + variantlar.</div>
          <div class="row" style="gap:8px;margin-top:8px">
            <span id="metaCount" class="chip">Savollar: —</span>
            <span id="metaPoints" class="chip">Umumiy ball: —</span>
            <span id="metaTimer" class="chip hidden">00:00</span>
          </div>
        </div>
        <div class="row">
          <button id="startBtn" class="btn">Boshlash</button>
        </div>
      </div>
    </section>

    <!-- Questions -->
    <section id="questionsCard" class="card hidden">
      <div class="row" style="justify-content:space-between">
        <div><b id="qIndex">1</b>/<span id="qTotal">—</span> <span id="qSect" class="sect"></span></div>
        <div class="row">
          <span id="qTimer" class="chip hidden">00:00</span>
          <button id="prevBtn" class="btn ghost">← Oldingi</button>
          <button id="nextBtn" class="btn">Keyingi →</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <div id="qText" class="qtext"></div>
        <img id="qImage" alt="Savol rasmi">
        <div id="opts"></div>
      </div>

      <div class="row" style="justify-content:space-between;margin-top:8px">
        <div id="navDots" class="navdots"></div>
        <div class="row">
          <button id="finishBtn" class="btn">Yakunlash</button>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section id="resultCard" class="card hidden">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div>
          <div class="score">Natija: <span id="scoreTotal">0</span>/<span id="scoreMax">0</span></div>
          <div id="scoreNote" style="color:var(--muted);margin-top:6px"></div>
          <div id="timeNote" style="color:var(--muted);margin-top:4px"></div>
        </div>
        <div class="row">
          <span id="saveStatus" class="chip hidden"></span>
          <a href="https://ixplusy.netlify.app/index" class="btn ghost">HOME</a>
          <button id="againBtn" class="btn ghost">Savollarga qaytish</button>
        </div>
      </div>

      <div class="stats-grid" style="margin-top:12px">
        <div class="stat"><div style="color:var(--muted);font-size:12px">To‘g‘ri javoblar</div><div style="font-weight:800;font-size:20px" id="stCorrect">0</div></div>
        <div class="stat"><div style="color:var(--muted);font-size:12px">Noto‘g‘ri javoblar</div><div style="font-weight:800;font-size:20px" id="stWrong">0</div></div>
        <div class="stat"><div style="color:var(--muted);font-size:12px">Foiz</div><div style="font-weight:800;font-size:20px" id="stPct">0%</div></div>
        <div class="stat"><div style="color:var(--muted);font-size:12px">Umumiy ball</div><div style="font-weight:800;font-size:20px" id="stPoints">0</div></div>
      </div>

      <div class="card" style="margin:14px 0">
        <h3 style="margin:0 0 8px">Bo‘limlar kesimida natija</h3>
        <div id="sectionStats"></div>
      </div>

      <div class="card" style="margin:14px 0">
        <h3 style="margin:0 0 8px">Javoblar tahlili</h3>
        <div id="detailTable"></div>
      </div>
    </section>

    <section id="emptyCard" class="card hidden" style="text-align:center">
      <h3>Test topilmadi</h3>
      <p class="muted">Shu papkaga <code>test.json</code> qo‘ying yoki <code>localStorage['testData']</code>ga yozing.</p>
    </section>
  </main>

  <script type="module">
    /* Firebase importlari */
    import { auth, db, onAuthStateChanged } from "/lib/firebase.client.js";
    import { requireAuth } from "/lib/auth-guard.js";
    import { doc, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    /* === UTIL === */
    const $ = s=>document.querySelector(s);
    const pad2 = n => String(Math.max(0,n)).padStart(2,'0');
    const sum = a => a.reduce((x,y)=>x+y,0);
    const isMulti = q => Array.isArray(q.correctIndices);
    const normalize = arr => Array.from(new Set((arr||[]).map(Number))).sort((a,b)=>a-b);
    const arraysEqual = (a,b)=> a.length===b.length && a.every((v,i)=>v===b[i]);
    const fmt = (x)=>{ const r = Math.round((+x + Number.EPSILON)*100)/100; return (Math.abs(r)%1===0)? String(Math.trunc(r)) : String(r); };
    const slug = s => (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');

    /* Status chip helper */
    function showSaveStatus(msg, kind='good'){
      const el1 = document.getElementById('saveStatus');
      const el2 = document.getElementById('saveStatusTop');
      [el1, el2].forEach(el=>{
        if(!el) return;
        el.textContent = msg;
        el.classList.remove('hidden','good','bad','warn');
        el.classList.add(kind);
      });
    }

    /* MathJax ready + auto-wrap */
    const mjReady = ()=> new Promise(res=>{
      const wait=()=> (window.MathJax && window.MathJax.typesetPromise) ? res() : setTimeout(wait,30);
      wait();
    });
    const needsWrap = (s)=>{
      if (typeof s !== 'string') return false;
      if (s.includes('$') || s.includes('\\(') || s.includes('\\[')) return false;
      return /\\frac|\\sqrt|\\sum|\\int|\\pi|\\alpha|\\beta|\\gamma|\\le|\\ge|\\cdot|\\times|\\circ|\\angle|\\deg|\\binom|\\pm|\\infty|\\ln|\\log|\\sin|\\cos|\\tan|\\lim|\\to|\\rightarrow|\\vec|\\hat|\\bar|\\over|\\mathbf|\\mathbb|\^|_/.test(s);
    };
    const wrapTeX = (s)=> needsWrap(s) ? `\\(${s}\\)` : s;
    const typeset = async (el)=>{ await mjReady(); try{ await MathJax.typesetPromise([el]); }catch{} };

    /* UX cheklovlar */
    document.addEventListener('contextmenu', e=> e.preventDefault());
    document.addEventListener('dragstart', e=> e.preventDefault());
    document.addEventListener('keydown', (e)=>{ const k=(e.key||'').toLowerCase(); if((e.ctrlKey||e.metaKey)&&['s','p','u'].includes(k)) e.preventDefault(); });

    /* STATE */
    let testData = null;
    let currentIndex = 0;
    let answers = []; // each: ORIGINAL indices
    let startedAt = null;
    let timeLeftSec = 0, timerId = null;
    let spentSeconds = 0;

    const url = new URLSearchParams(location.search);
    const rawIdFromUrl = url.get('id');
    let currentTestId = rawIdFromUrl || (location.pathname.split('/').pop().replace(/\..*$/,'') || 'test');

    // Test kodi — URL ?code= ; bo‘lmasa JSON "code" ; bo‘lmasa slug
    let currentTestCode = url.get('code') || null;

    /* Auth */
    await requireAuth();
    onAuthStateChanged(auth, (user)=>{ $('#authInfo').textContent = user ? `Kirish: ${user.displayName || user.email}` : 'Kirish: mehmon'; });

    /* Sections diapazonlarini savollarga qo‘llash */
    function applySectionRanges(data){
      if(!Array.isArray(data.questions)) return;
      if(Array.isArray(data.sections)){
        data.sections.forEach(sec=>{
          const name = sec.name || 'Umumiy';
          const s = Math.max(1, Number(sec.start||1));
          const e = Math.min(data.questions.length, Number(sec.end||data.questions.length));
          for(let i=s-1;i<e;i++){ data.questions[i].section = data.questions[i].section || name; }
        });
      }
      data.questions.forEach(q=>{ if(!q.section) q.section = 'Umumiy'; });
    }

    function normalizeTestData(data){
      if(!data || !Array.isArray(data.questions)) return data;
      data.title = data.title || 'Test';
      data.description = data.description || 'Rasm + variantlar';
      data.questions = data.questions.map(q=>({ ...q, points: Number(q.points || 1) }));
      if (data.totalTime && !data.durationMinutes) data.durationMinutes = Number(data.totalTime);
      applySectionRanges(data);
      data.id = data.id || slug(data.title);
      data.code = data.code || slug(data.title);
      return data;
    }

    async function loadTestData(){
      const stored = localStorage.getItem('testData');
      if(stored){ try{ testData = normalizeTestData(JSON.parse(stored)); return; }catch{} }
      try{
        const r = await fetch('./test.json',{cache:'no-store'});
        if(!r.ok) throw new Error('no test.json');
        testData = normalizeTestData(await r.json());
      }catch{
        // fallback
        testData = normalizeTestData({
          title: 'Demo test', description: 'Fallback ma’lumotlar', durationMinutes: 1, code: 'demo-001',
          questions: [
            { section:'Algebra', text: "1) $2+2$ nechiga teng?", options:["2","3","4","5"], correctIndex:2, points:1 },
            { section:'Sonlar nazariyasi', text: "2) \\(\\text{Tub son(lar)}\\)", options:["2","4","5","9"], correctIndices:[0,2], points:2 },
            { section:'Geometriya', text: "3) Nisbatni toping.", options:["1:1","1:2","2:3","3:4"], correctIndex:0, points:1 }
          ]
        });
      }
      // variantlarni random qilish (Fisher–Yates)
      testData.questions.forEach(q=>{
        const idxs = [...Array(q.options.length).keys()];
        for(let i=idxs.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [idxs[i],idxs[j]]=[idxs[j],idxs[i]]; }
        q._perm = idxs;
      });
    }

    /* Nav dots */
    function buildNavDots(){
      const n = testData.questions.length;
      const root = $('#navDots'); root.innerHTML='';
      for(let i=0;i<n;i++){
        const b=document.createElement('button');
        b.className='dot'; b.dataset.idx = String(i);
        b.textContent = i+1;
        b.addEventListener('click', ()=>{ currentIndex=i; renderQuestion(); });
        root.appendChild(b);
      }
      refreshDotsState();
      highlightDot(0);
    }
    function highlightDot(i){
      [...document.querySelectorAll('.dot')].forEach((el,idx)=> el.classList.toggle('active', idx===i));
    }
    function refreshDotsState(){
      [...document.querySelectorAll('.dot')].forEach((el)=>{
        const i = Number(el.dataset.idx);
        const hasAns = (answers[i] && answers[i].length>0);
        el.classList.toggle('answered', !!hasAns);
      });
    }

    // Rasmni topish: jpg → png → jpeg → webp → q.image
    async function resolveImageSrc(idx1){
      const q = testData.questions[idx1-1] || {};
      const candidates = [
        `./${idx1}.jpg`,
        `./${idx1}.png`,
        `./${idx1}.jpeg`,
        `./${idx1}.webp`,
        q.image || ''
      ].filter(Boolean);

      for (const url of candidates) {
        const ok = await new Promise(r=>{
          const img = new Image();
          img.onload = ()=>r(true);
          img.onerror = ()=>r(false);
          img.src = url + (url.includes('?') ? '' : `?t=${Date.now()}`);
        });
        if (ok) return url;
      }
      return '';
    }

    function renderQuestion(){
      const q = testData.questions[currentIndex];
      $('#qIndex').textContent = String(currentIndex+1);
      $('#qTotal').textContent = String(testData.questions.length);
      $('#qText').innerHTML = wrapTeX(q.text || '');
      $('#qSect').textContent = q.section || 'Umumiy';
      $('#opts').innerHTML = '';

      const multi = isMulti(q);
      const nameAttr = `q${currentIndex}` + (multi?'[]':'');
      const chosen = new Set(answers[currentIndex] || []);

      const order = q._perm && q._perm.length===q.options.length ? q._perm : [...Array(q.options.length).keys()];
      order.forEach((origIndex)=>{
        const row = document.createElement('label'); row.className='opt';
        const inp = document.createElement('input');
        inp.type = multi ? 'checkbox' : 'radio';
        inp.name = nameAttr;
        inp.value = String(origIndex);
        inp.checked = chosen.has(origIndex);
        inp.addEventListener('change', ()=>{
          if(multi){ if(inp.checked) chosen.add(origIndex); else chosen.delete(origIndex); answers[currentIndex] = normalize([...chosen]); }
          else { answers[currentIndex] = inp.checked ? [origIndex] : []; }
          refreshDotsState();
        });
        const span = document.createElement('span'); span.innerHTML = wrapTeX(q.options[origIndex]);
        row.appendChild(inp); row.appendChild(span);
        $('#opts').appendChild(row);
      });

      resolveImageSrc(currentIndex+1).then(src=>{ $('#qImage').src = src; });
      highlightDot(currentIndex);
      typeset($('#questionsCard'));
    }

    /* Timer */
    function startTimerIfNeeded(){
      const minutes = Number(testData.durationMinutes || 0);
      const both = (txt,show)=>{ $('#metaTimer').textContent=txt; $('#qTimer').textContent=txt; $('#metaTimer').classList.toggle('hidden',!show); $('#qTimer').classList.toggle('hidden',!show); };
      if(!minutes){ both('00:00', false); return; }
      timeLeftSec = Math.round(minutes*60);
      both(`${pad2(Math.floor(timeLeftSec/60))}:${pad2(timeLeftSec%60)}`, true);
      timerId = setInterval(()=>{
        timeLeftSec--; spentSeconds++;
        const m=Math.max(0,Math.floor(timeLeftSec/60)), s=Math.max(0,timeLeftSec%60);
        both(`${pad2(m)}:${pad2(s)}`, true);
        if(timeLeftSec<=0){ clearInterval(timerId); onFinish(); }
      }, 1000);
    }

    /* Scoring */
    function computeTotals(){
      let total=0, max=0;
      const perQuestion=[];
      const sectionAgg = new Map();
      testData.questions.forEach((q,i)=>{
        const sect = q.section || 'Umumiy';
        const pts = Number(q.points||1); max+=pts;
        const picked = normalize(answers[i] || []);
        const correct = isMulti(q) ? normalize(q.correctIndices||[]) : [Number(q.correctIndex??-1)];
        const ok = isMulti(q) ? arraysEqual(picked, correct) : (picked.length===1 && picked[0]===correct[0]);
        if(ok) total+=pts;
        if(!sectionAgg.has(sect)) sectionAgg.set(sect,{q:0,ok:0,pts:0,ptsMax:0});
        const a = sectionAgg.get(sect); a.q+=1; a.ptsMax+=pts; if(ok){ a.ok+=1; a.pts+=pts; }
        // SANITIZED row (Firestore undefined bo‘lmasin)
        perQuestion.push({
          i,
          section: sect,
          pts: Number(pts||0),
          ok: !!ok,
          picked: Array.isArray(picked)? picked : [],
          correct: Array.isArray(correct)? correct : [],
          text: String(q.text || ''),
          options: Array.isArray(q.options) ? q.options.map(v=>String(v ?? '')) : []
        });
      });
      return { total, max, perQuestion, sectionAgg };
    }

    /* Firestore: natijani TEST KODI bo‘yicha faqat bir marta yozish */
    async function saveFirstResultOnly({testCode, uid, total, max, detail}){
      const ref = doc(db, 'results', testCode, 'users', uid);
      return runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        if (snap.exists()) return { skipped:true, already:snap.data() };
        tx.set(ref, {
          uid,
          testCode,
          testId: testData.id || currentTestId,
          title: testData.title || '',
          firstTotal: Number(total||0),
          max: Number(max||0),
          detail: Array.isArray(detail) ? detail : [],
          createdAt: serverTimestamp(),
          spentSeconds: Number(spentSeconds||0)
        });
        return { skipped:false };
      });
    }

    /* Tahlil rendererlar */
    function renderSectionStats(sectionAgg){
      const container = document.createElement('div'); container.className = 'stats-grid';
      [...sectionAgg.entries()].forEach(([name, a])=>{
        const pct = a.q ? Math.round((a.ok/a.q)*100) : 0;
        const card = document.createElement('div'); card.className = 'stat';
        card.innerHTML = `
          <div style="font-weight:700;margin-bottom:4px">${name}</div>
          <div style="color:var(--muted);font-size:12px">Savollar: ${a.q}</div>
          <div style="margin-top:6px"><b>${fmt(a.pts)}</b>/<b>${fmt(a.ptsMax)}</b> ball · <b>${pct}%</b> to‘g‘ri</div>`;
        container.appendChild(card);
      });
      const root = $('#sectionStats'); root.innerHTML=''; root.appendChild(container);
    }

    function renderDetail(perQuestion){
      const wrapper = document.createElement('div');
      const table = document.createElement('table'); table.className='tbl';
      table.innerHTML = `
        <thead class="rowbox">
          <tr>
            <th style="border-top-left-radius:12px">#</th>
            <th>Bo‘lim</th>
            <th>Savol</th>
            <th>Tanlangan</th>
            <th>To‘g‘ri javob(lar)</th>
            <th style="text-align:right;border-top-right-radius:12px">Ball</th>
          </tr>
        </thead>
        <tbody id="detailBody"></tbody>`;
      wrapper.appendChild(table);
      const body = table.querySelector('#detailBody');

      perQuestion.forEach(row=>{
        const pickedDisp = row.picked.length? row.picked.map(x=>x+1).join(', ') : '—';
        const correctDisp = row.correct.map(x=>x+1).join(', ');
        const tr = document.createElement('tr'); tr.className='rowbox';
        tr.innerHTML = `
          <td style="width:40px">${row.i+1}</td>
          <td><span class="sect">${row.section}</span></td>
          <td style="max-width:360px">${wrapTeX(row.text||'')}</td>
          <td>${pickedDisp} ${row.ok?'<span class="ok">✓</span>':'<span class="bad">✗</span>'}</td>
          <td>${correctDisp}</td>
          <td style="text-align:right"><b>${row.ok?fmt(row.pts):0}</b>/<b>${fmt(row.pts)}</b></td>`;
        body.appendChild(tr);
      });

      const root = $('#detailTable');
      root.innerHTML=''; root.appendChild(wrapper);
      typeset(root);
    }

    /* Finish */
    async function onFinish(){
      if(timerId){ clearInterval(timerId); timerId=null; }
      if(startedAt){ const now=new Date(); spentSeconds = Math.max(spentSeconds, Math.floor((now - startedAt)/1000)); }

      const { total, max, perQuestion, sectionAgg } = computeTotals();
      $('#questionsCard').classList.add('hidden');
      $('#resultCard').classList.remove('hidden');
      $('#scoreTotal').textContent = fmt(total);
      $('#scoreMax').textContent = fmt(max);
      $('#scoreNote').textContent = `To‘g‘ri: ${perQuestion.filter(x=>x.ok).length} ta / ${perQuestion.length} ta`;
      $('#timeNote').textContent = `Sarflangan vaqt: ${pad2(Math.floor(spentSeconds/60))}:${pad2(spentSeconds%60)}`;
      $('#stCorrect').textContent = String(perQuestion.filter(x=>x.ok).length);
      $('#stWrong').textContent = String(perQuestion.length - perQuestion.filter(x=>x.ok).length);
      $('#stPct').textContent = (max? Math.round((total/max)*100):0) + '%';
      $('#stPoints').textContent = `${fmt(total)}/${fmt(max)}`;
      renderSectionStats(sectionAgg);
      renderDetail(perQuestion);

      // SANITIZE detail (Firestore undefined bo‘lmasin)
      const safeDetail = perQuestion.map(row => ({
        i: row.i,
        section: row.section || 'Umumiy',
        pts: Number(row.pts || 0),
        ok: !!row.ok,
        picked: Array.isArray(row.picked) ? row.picked : [],
        correct: Array.isArray(row.correct) ? row.correct : [],
        text: String(row.text || ''),
        options: Array.isArray(row.options) ? row.options.map(v => String(v ?? '')) : []
      }));

      const user = auth.currentUser;
      if(!currentTestCode){
        showSaveStatus('Kod topilmadi — natija saqlanmadi', 'warn');
      } else if(!user){
        showSaveStatus('Kirmagansiz — natija saqlanmadi', 'warn');
      } else {
        try{
          const res = await saveFirstResultOnly({
            testCode: currentTestCode,
            uid: user.uid,
            total, max,
            detail: safeDetail
          });
          if(res?.skipped){
            showSaveStatus(`Oldin saqlangan (#${currentTestCode}) — qayta yozilmadi`, 'warn');
          }else{
            showSaveStatus(`Saqlandi (#${currentTestCode})`, 'good');
          }
        }catch(e){
          console.error('save error:', e);
          showSaveStatus('Saqlashda xatolik: ' + (e?.message || e), 'bad');
        }
      }
    }

    /* Boot */
    async function boot(){
      await loadTestData();
      if(!testData || !testData.questions?.length){
        $('#introCard').classList.add('hidden'); $('#questionsCard').classList.add('hidden'); $('#emptyCard').classList.remove('hidden'); return;
      }

      // Test ID & CODE ni yakuniy aniqlash
      currentTestId = rawIdFromUrl || testData.id || currentTestId;
      currentTestCode = currentTestCode || testData.code || currentTestId;

      // UI: title + code chip + <title> yangilash
      $('#testTitle').textContent = testData.title || 'Test';
      const codeChip = $('#codeChip');
      if(currentTestCode){
        codeChip.textContent = `Kod: ${currentTestCode}`;
        codeChip.classList.remove('hidden');
      } else {
        codeChip.classList.add('hidden');
      }
      document.title = `${testData.title || 'Test'} — ${currentTestCode ? ('#'+currentTestCode) : ''} | LeaderMath`;

      $('#testDesc').textContent = testData.description || '';
      $('#metaCount').textContent = `Savollar: ${testData.questions.length}`;
      $('#metaPoints').textContent = `Umumiy ball: ${fmt(sum(testData.questions.map(q=>q.points)))}`;

      // Introda taymer ko‘rinishi
      const minutes = Number(testData.durationMinutes || 0);
      if (minutes > 0) {
        $('#metaTimer').textContent = `${pad2(minutes)}:00`;
        $('#metaTimer').classList.remove('hidden');
      } else {
        $('#metaTimer').classList.add('hidden');
      }

      answers = Array.from({length:testData.questions.length}, ()=>[]);
      buildNavDots();

      $('#startBtn').onclick = ()=>{
        startedAt = new Date(); spentSeconds = 0;
        $('#introCard').classList.add('hidden'); $('#questionsCard').classList.remove('hidden');
        renderQuestion(); startTimerIfNeeded();
      };
      $('#prevBtn').onclick = ()=>{ if(currentIndex>0){ currentIndex--; renderQuestion(); } };
      $('#nextBtn').onclick = ()=>{ if(currentIndex<testData.questions.length-1){ currentIndex++; renderQuestion(); } };
      $('#finishBtn').onclick = onFinish;
      $('#againBtn').onclick = ()=>{ $('#resultCard').classList.add('hidden'); $('#questionsCard').classList.remove('hidden'); renderQuestion(); };
    }

    boot();
  </script>
</body>
</html>
