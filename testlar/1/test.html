<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Test yechish</title>
  <style>
    :root{
      --bg:#041f12;--panel:#0a2e1b;--panel2:#0e3a22;--text:#f2fff7;--muted:#b8e4cb;
      --accent:#21c26e;--accent2:#29e07d;--danger:#ff4d4f;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);background:linear-gradient(160deg,#04160e 0%, #062616 60%, #052012 100%)}
    .wrap{display:grid;grid-template-columns:300px 1fr;gap:16px;height:100vh;padding:16px}
    @media(max-width:900px){ .wrap{grid-template-columns:1fr; height:auto; min-height:100vh} }
    .panel{background:var(--panel);border:1px solid #0b3a23;border-radius:16px;overflow:hidden}
    .p-head{padding:12px 14px;border-bottom:1px solid #0d4328;display:flex;align-items:center;gap:10px;justify-content:space-between}
    .timer{font-weight:800;font-size:22px}
    .p-body{padding:12px 14px}
    .qnav{display:grid;grid-template-columns:repeat(auto-fill,minmax(46px,1fr));gap:8px}
    .qnav button{height:46px;border-radius:12px;border:1px solid #104a2e;background:var(--panel2);color:var(--text);font-weight:700;cursor:pointer}
    .qnav button.active{outline:2px solid var(--accent)}
    .qnav button.answered{background:#135333}
    .qnav button.wrong{background:#4d1a1a;border-color:#7a2323}
    .qnav button.correct{background:#184d1a;border-color:#2b7a2e}
    .content{display:flex;flex-direction:column;gap:12px}
    .question{background:var(--panel);border:1px solid #0b3a23;border-radius:16px;padding:16px}
    .qtext{font-size:18px;line-height:1.55}
    .qimg{max-width:100%;max-height:240px;display:block;margin:12px auto;border-radius:10px;border:1px solid #0d4328}
    .options{display:grid;gap:10px;margin-top:8px}
    .opt{display:flex;gap:10px;align-items:flex-start;background:var(--panel2);border:1px solid #104a2e;border-radius:12px;padding:10px}
    .opt input{margin-top:3px;transform:scale(1.2)}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    .btn{cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid #115132;background:var(--panel2);color:var(--text);}
    .btn.primary{background:linear-gradient(180deg,var(--accent),var(--accent2));color:#072e18;border:none;font-weight:700}
    .btn.danger{background:linear-gradient(180deg,#ff6767,#ff4343);color:#2b0000;border:none;font-weight:800}
    .muted{color:var(--muted)}
    .result{background:var(--panel);border:1px solid #0b3a23;border-radius:16px;padding:16px}
    .block{background:rgba(10,46,27,.8);backdrop-filter:blur(3px);border:1px solid #155a37;border-radius:14px;padding:14px;margin:10px 0}
  </style>
  <script>
    // MathJax config (LaTeX/MathTex)
    window.MathJax = {
      tex: { inlineMath: [['\\(','\\)'], ['$', '$']], displayMath: [['\\[','\\]'], ['$$','$$']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
</head>
<body>
  <div class="wrap">
    <aside class="panel">
      <div class="p-head">
        <div style="font-weight:800" id="title">Test</div>
        <div class="timer" id="timer">00:00</div>
      </div>
      <div class="p-body" id="sidePanel">
        <div class="muted" style="margin-bottom:8px">Savollar navigatsiyasi</div>
        <div class="qnav" id="qnav"></div>
      </div>
    </aside>

    <main class="content">
      <section class="question">
        <div class="qtext" id="qtext">Yuklanmoqda...</div>
        <img id="qimg" class="qimg" src="" alt="" style="display:none" />
        <div class="options" id="options"></div>
        <div id="alerts"></div>
      </section>

      <section class="controls">
        <button id="btnPrev" class="btn">⬅ Oldingi</button>
        <button id="btnNext" class="btn">Keyingi ➡</button>
        <div class="grow" style="flex:1"></div>
        <button id="btnFinish" class="btn danger">Yakunlash ⏹</button>
      </section>

      <section id="result" class="result" style="display:none"></section>
    </main>
  </div>

  <script type="module">
    import { db, auth, attachAuthUI } from './common.js';
    import { runTransaction, doc, collection } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // --- URL params ---
    const url = new URL(location.href);
    const SRC = url.searchParams.get('src') || './test.csv';   // CSV manzili
    const TITLE = url.searchParams.get('title') || 'Test';     // sarlavha
    const PRICE = Number(url.searchParams.get('price') || 5000); // 1 urinish narxi
    const PREVIEW = url.searchParams.get('preview') === '1';   // charge yo'q, natija saqlanmaydi

    // UI refs
    const els = {
      title: document.getElementById('title'),
      timer: document.getElementById('timer'),
      nav: document.getElementById('qnav'),
      qtext: document.getElementById('qtext'),
      qimg: document.getElementById('qimg'),
      options: document.getElementById('options'),
      result: document.getElementById('result'),
      alerts: document.getElementById('alerts'),
      btnPrev: document.getElementById('btnPrev'),
      btnNext: document.getElementById('btnNext'),
      btnFinish: document.getElementById('btnFinish'),
    };
    els.title.textContent = TITLE + (PREVIEW ? " (ko‘rish rejimi)" : "");

    // State
    let questions = [];
    let answers = [];
    let idx = 0;
    let timerSec = 0;
    let timerId = null;
    let attemptId = null;
    let finished = false;

    // Ensure signed-in (uses your site's common.js overlay if available)
    try { attachAuthUI && attachAuthUI({ requireSignIn: true }); } catch(_) {}

    // --- CSV loader ---
    async function loadCSV(){
      const res = await fetch(SRC, {cache:'no-store'});
      const text = await res.text();
      const rows = text.trim().split(/\\r?\\n/).filter(Boolean).map(l=>l.split('|').map(s=>s.trim()));
      rows.shift(); // drop header
      questions = rows.map(r => ({
        img: r[0] || '',
        text: r[1] || '',
        opts: [r[2], r[3], r[4], r[5]].map(x=>x||''),
        plus: Number(r[6] || 0),
        minus: Number(r[7] || 0),
      }));
      answers = new Array(questions.length).fill(-1);
      timerSec = questions.length * 120; // 2 daqiqa per savol
    }

    // --- Payment + attempt creation (only once, on open) ---
    async function chargeAndStart(){
      if(PREVIEW) return;
      const u = auth.currentUser;
      if(!u){ throw new Error("Avval tizimga kiring."); }
      await runTransaction(db, async (tx)=>{
        const userRef = doc(db, 'users', u.uid);
        const userSnap = await tx.get(userRef);
        if(!userSnap.exists()) throw new Error("Profil topilmadi.");
        const bal = Number(userSnap.data().balance || 0);
        if(bal < PRICE) throw new Error("Balans yetarli emas (5 000 so‘m kerak).");
        tx.update(userRef, { balance: bal - PRICE });
        const attemptRef = doc(collection(db, 'attempts'));
        attemptId = attemptRef.id;
        tx.set(attemptRef, {
          uid: u.uid, title: TITLE, src: SRC, price: PRICE,
          status: 'in_progress', startedAt: new Date(), totalSeconds: timerSec
        });
      });
    }

    // --- UI helpers ---
    function fmtTime(s){ const m=Math.floor(s/60), ss=s%60; return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`; }
    async function typeset(){ if(window.MathJax?.typesetPromise) await MathJax.typesetPromise(); }

    function buildNav(){
      els.nav.innerHTML = '';
      questions.forEach((_,i)=>{
        const b = document.createElement('button');
        b.textContent = i+1;
        b.addEventListener('click', ()=> showQ(i));
        els.nav.appendChild(b);
      });
      highlightNav();
    }
    function highlightNav(){
      [...els.nav.children].forEach((b,i)=>{
        b.classList.toggle('active', i===idx);
        b.classList.toggle('answered', answers[i] !== -1);
      });
    }
    async function showQ(i){
      idx = Math.max(0, Math.min(i, questions.length-1));
      const q = questions[idx];
      els.qtext.innerHTML = q.text;
      if(q.img){ els.qimg.src=q.img; els.qimg.style.display='block'; } else { els.qimg.style.display='none'; }
      els.options.innerHTML='';
      q.opts.forEach((o,k)=>{
        const row = document.createElement('label');
        row.className='opt';
        row.innerHTML = `<input type="radio" name="q${idx}" ${answers[idx]===k?'checked':''}>
                         <div><div><strong>${"ABCD"[k]}.</strong> ${o}</div>
                         <div class="muted">✅ +${q.plus}  ❌ -${q.minus}</div></div>`;
        row.querySelector('input').addEventListener('change', ()=>{ answers[idx]=k; highlightNav(); });
        els.options.appendChild(row);
      });
      await typeset();
      highlightNav();
    }

    function startTimer(){
      els.timer.textContent = fmtTime(timerSec);
      timerId = setInterval(()=>{
        if(finished) return;
        timerSec--; els.timer.textContent = fmtTime(Math.max(0,timerSec));
        if(timerSec<=0){ clearInterval(timerId); finalize(true); }
      }, 1000);
    }

    async function finalize(auto=false){
      if(finished) return;
      if(!auto && !confirm("Yakunlaymizmi?")) return;
      finished = true; clearInterval(timerId);

      // Score: Javob1 doimo to‘g‘ri
      let correct=0, wrong=0, gemsDelta=0;
      questions.forEach((q,i)=>{
        const a = answers[i];
        if(a===-1) return;
        if(a===0){ correct++; gemsDelta += q.plus; } else { wrong++; gemsDelta -= q.minus; }
      });

      // Save results (skip in preview)
      if(!PREVIEW){
        const u = auth.currentUser;
        if(u && attemptId){
          try{
            await runTransaction(db, async (tx)=>{
              const userRef = doc(db, 'users', u.uid);
              const userSnap = await tx.get(userRef);
              if(!userSnap.exists()) throw new Error("Profil topilmadi.");
              const gems = Number(userSnap.data().gems || 0);
              tx.update(userRef, { gems: gems + gemsDelta });
              const attRef = doc(db, 'attempts', attemptId);
              tx.update(attRef, {
                status:'finished', finishedAt:new Date(),
                correct, wrong, total: questions.length, gemsDelta, answers
              });
            });
          }catch(e){ console.error(e); addAlert("Natijani saqlashda xato: "+(e.message||"")); }
        }
      }

      // Show result
      els.result.style.display='block';
      els.result.innerHTML = `
        <h3>Natija</h3>
        <p>To‘g‘ri: <b>${correct}</b> | Noto‘g‘ri: <b>${wrong}</b> | Jami: <b>${questions.length}</b></p>
        <p>💎 Olmos o‘zgarishi: <b>${gemsDelta>0?'+':''}${gemsDelta}</b></p>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <button class="btn primary" onclick="history.back()">Orqaga qaytish</button>
        </div>
      `;

      // Lock buttons
      els.btnPrev.disabled = true; els.btnNext.disabled = true; els.btnFinish.disabled = true;

      // Color nav
      [...els.nav.children].forEach((b,i)=>{
        if(answers[i]===-1) return;
        if(answers[i]===0) b.classList.add('correct'); else b.classList.add('wrong');
      });
    }

    function addAlert(msg){
      const div = document.createElement('div');
      div.className='block';
      div.textContent = msg;
      els.alerts.appendChild(div);
    }

    // Prevent closing
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ e.preventDefault(); e.stopImmediatePropagation(); }}, true);
    window.addEventListener('beforeunload', (e)=>{
      if(!finished && !PREVIEW){ e.preventDefault(); e.returnValue=''; }
    });

    // Buttons
    els.btnPrev.addEventListener('click', ()=> showQ(idx-1));
    els.btnNext.addEventListener('click', ()=> showQ(idx+1));
    els.btnFinish.addEventListener('click', ()=> finalize(false));

    // Boot
    (async function init(){
      try{
        await loadCSV();
        await chargeAndStart(); // charges 5000 so'm and creates attempt
        buildNav();
        showQ(0);
        startTimer();
      }catch(e){
        console.error(e);
        addAlert(e.message || "Xatolik.");
        // Disable controls if not started
        els.btnPrev.disabled = true; els.btnNext.disabled = true; els.btnFinish.disabled = true;
      }
    })();
  </script>
</body>
</html>
