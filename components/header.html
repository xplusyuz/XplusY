<div class="header-wrap">
  <nav class="nav container">
    <div class="brand">
      <span class="dot"></span>
      <span>KiberMath</span>
    </div>

    <button class="burger" aria-label="Menu">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M3 12h18M3 18h18" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/></svg>
    </button>

    <button class="btn btn-ghost" id="panelOpen" aria-label="Touch panel">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
        <rect x="3" y="4" width="18" height="6" rx="2" stroke="rgba(255,255,255,.85)" stroke-width="2"/>
        <rect x="3" y="14" width="18" height="6" rx="2" stroke="rgba(255,255,255,.85)" stroke-width="2"/>
        <circle cx="8" cy="17" r="1.5" fill="rgba(32,242,143,.9)"/>
        <circle cx="12" cy="7" r="1.5" fill="rgba(32,242,143,.9)"/>
      </svg>
    </button>

    <div class="nav-actions">
      <div class="user-pill" data-anon>
        <span>Kirish qilmagansiz</span>
        <a class="btn btn-primary" href="registor.html">Kirish / Ro'yxatdan o'tish</a>
      </div>
      <div class="user-pill" data-authed style="display:none">
        <span>👋 Salom, <strong data-username>—</strong></span>
        <span class="kpi">ID: <b data-userid>—</b></span>
        <span class="kpi">Balans: <b data-balance>0</b> so'm</span>
        <a class="plus-btn" href="balance.html">+</a>
        <span class="kpi">Ball: <b data-points>0</b></span>
        <span class="kpi">Unvon: <b data-title>—</b></span>
        <button class="btn btn-ghost" data-logout>Chiqish</button>
      </div>
    </div>
  </nav>
</div>


<!-- Touch Panel Overlay -->
<div class="panel-backdrop" id="panelBackdrop"></div>
<aside class="touch-panel" id="touchPanel" role="dialog" aria-modal="true" aria-labelledby="panelTitle">
  <div class="swipe-bar"></div>
  <div class="panel-header">
    <div class="panel-title"><span class="dot"></span><span id="panelTitle">Kiber Panel</span><span class="chip" data-title>—</span></div>
    <button class="btn btn-ghost" id="panelClose">Yopish</button>
  </div>
  <div class="panel-body">
    <div class="user-pill" data-authed style="display:none">
        <span>👋 Salom, <strong data-username>—</strong></span>
        <span class="kpi">ID: <b data-userid>—</b></span>
        <span class="kpi">Balans: <b data-balance>0</b> so'm</span>
        <a class="plus-btn" href="balance.html">+</a>
        <span class="kpi">Ball: <b data-points>0</b></span>
        <span class="kpi">Unvon: <b data-title>—</b></span>
    </div>

    <div class="panel-grid">
      <a class="panel-item" href="index.html">
        <svg width="24" height="24" viewBox="0 0 24 24"><path d="M3 11l9-7 9 7v9a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-9z" fill="rgba(32,242,143,.6)" /></svg>
        <div class="label">Asosiy</div><div class="note">Bosh sahifa</div>
      </a>
      <a class="panel-item" href="#testlar">
        <svg width="24" height="24" viewBox="0 0 24 24"><path d="M4 4h16v4H4zM4 10h16v4H4zM4 16h10v4H4z" fill="rgba(32,242,143,.6)"/></svg>
        <div class="label">Testlar</div><div class="note">Onlayn sinovlar</div>
      </a>
      <a class="panel-item" href="#kurslar">
        <svg width="24" height="24" viewBox="0 0 24 24"><path d="M3 7l9-4 9 4-9 4-9-4zm0 6l9 4 9-4" fill="rgba(32,242,143,.6)"/></svg>
        <div class="label">Kurslar</div><div class="note">Video darslar</div>
      </a>
      <a class="panel-item" href="#simulyator">
        <svg width="24" height="24" viewBox="0 0 24 24"><path d="M6 4h12v4H6zM4 10h16v10H4z" fill="rgba(32,242,143,.6)"/></svg>
        <div class="label">Simulyator</div><div class="note">Mashq rejimi</div>
      </a>
      <a class="panel-item" href="#oyinlar">
        <svg width="24" height="24" viewBox="0 0 24 24"><path d="M8 7h8l3 10H5L8 7zm2-3h4v2h-4z" fill="rgba(32,242,143,.6)"/></svg>
        <div class="label">O'yinlar</div><div class="note">Gamifikatsiya</div>
      </a>
      <a class="panel-item" href="profil.html">
        <svg width="24" height="24" viewBox="0 0 24 24"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4zm0 2c-4 0-8 2-8 4v2h16v-2c0-2-4-4-8-4z" fill="rgba(32,242,143,.6)"/></svg>
        <div class="label">Profil</div><div class="note">Ma'lumotlar</div>
      </a>
      <a class="panel-item" href="balance.html">
        <svg width="24" height="24" viewBox="0 0 24 24"><path d="M3 6h18v12H3z M7 10h10v2H7z M7 14h10v2H7z" fill="rgba(32,242,143,.6)"/></svg>
        <div class="label">Balans</div><div class="note">To'ldirish</div>
      </a>
      <a class="panel-item" href="#" data-logout>
        <svg width="24" height="24" viewBox="0 0 24 24"><path d="M10 17l5-5-5-5v3H3v4h7v3zM20 5h-6v2h6v10h-6v2h6a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2z" fill="rgba(255,84,112,.8)"/></svg>
        <div class="label">Chiqish</div><div class="note">Hisobdan chiqish</div>
      </a>
    </div>

    <div class="panel-quick">
      <a class="btn btn-primary" href="#online">⚡ Online Olimpiada</a>
      <a class="btn" href="#top">🏆 Reyting</a>
      <a class="btn" href="#help">❓ Yordam</a>
    </div>
  </div>
</aside>

<script>
(function(){
  function waitFor(sel, timeout=10000){
    return new Promise((resolve, reject)=>{
      const el = document.querySelector(sel);
      if (el) return resolve(el);
      const obs = new MutationObserver(()=>{
        const e = document.querySelector(sel);
        if (e){ obs.disconnect(); resolve(e); }
      });
      obs.observe(document.documentElement, {childList:true, subtree:true});
      setTimeout(()=>{ obs.disconnect(); reject(new Error("timeout waiting for "+sel)); }, timeout);
    });
  }

  function cloneIntoPanel(headerPill){
    const panel = document.getElementById('touchPanel');
    const panelBody = panel?.querySelector('.panel-body');
    if (!panelBody) return;

    // remove old clone if any
    const existing = panelBody.querySelector('.user-pill[data-authed]');
    if (existing) existing.remove();

    // clone and insert
    const clone = headerPill.cloneNode(true);
    // ensure visible (header markup has inline style="display:none")
    clone.style.display = getComputedStyle(headerPill).display !== 'none' ? 'block' : 'none';
    panelBody.insertBefore(clone, panelBody.firstChild);

    // sync the "Unvon" chip in panel header
    const srcTitle = headerPill.querySelector('[data-title]') || document.querySelector('.nav [data-title]');
    const chip = panel.querySelector('.panel-header .chip[data-title]');
    const copyTitle = () => {
      if (srcTitle && chip) chip.textContent = (srcTitle.textContent || '—').trim();
    };
    copyTitle();

    if (srcTitle){
      const moChip = new MutationObserver(copyTitle);
      moChip.observe(srcTitle, { childList:true, characterData:true, subtree:true });
    }
  }

  function mirrorChanges(headerPill){
    const panel = document.getElementById('touchPanel');
    const panelBody = panel?.querySelector('.panel-body');
    if (!panelBody) return;
    const target = () => panelBody.querySelector('.user-pill[data-authed]');

    // When header data changes, copy text to clone
    const copyAll = () => {
      const clone = target();
      if (!clone) return;
      ['username','userid','balance','points','title'].forEach(key=>{
        const src = headerPill.querySelector('[data-'+key+']');
        const dst = clone.querySelector('[data-'+key+']');
        if (src && dst) dst.textContent = src.textContent;
      });
      // mirror visibility (anon/authed)
      const visible = getComputedStyle(headerPill).display !== 'none';
      clone.style.display = visible ? 'block' : 'none';
    };
    copyAll();

    const mo = new MutationObserver(copyAll);
    mo.observe(headerPill, { attributes:true, attributeFilter:['style','class','hidden'], childList:true, characterData:true, subtree:true });
  }

  document.addEventListener('DOMContentLoaded', () => {
    waitFor('.nav .user-pill[data-authed]').then(headerPill => {
      cloneIntoPanel(headerPill);
      mirrorChanges(headerPill);
    }).catch(()=>{
      // Even if we timed out, try once if element exists later
      const tryLater = () => {
        const hp = document.querySelector('.nav .user-pill[data-authed]');
        if (!hp) return;
        cloneIntoPanel(hp);
        mirrorChanges(hp);
        document.removeEventListener('click', tryLater);
      };
      document.addEventListener('click', tryLater);
    });

    // Logout handling via delegation (works for header and clone)
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-logout]');
      if (!btn) return;
      if (typeof window.logout === 'function') window.logout();
    });
  });
})();
</script>
