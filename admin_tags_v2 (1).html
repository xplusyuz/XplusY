<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MathCenter Admin — Banner • Best • Oddiy</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --p:#2E8B57; --p2:#1F6B45; --bd:#e5e7eb; --muted:#6b7280; --bg:#fff;
      --r:14px; --sh:0 10px 30px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Inter,system-ui;color:#111}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--bd);z-index:10}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0;color:var(--p);font-weight:800}
    .sub{color:var(--muted);font-size:13px}
    .row{display:flex;align-items:center;gap:10px}
    .tools{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    button{cursor:pointer;border:1px solid var(--bd);background:#fff;border-radius:10px;padding:8px 12px}
    .primary{background:var(--p);border-color:var(--p);color:#fff;font-weight:700}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .tab{padding:10px 14px;border:1px solid var(--bd);border-radius:999px;cursor:pointer}
    .tab.active{background:#E8F5E9;border-color:#86efac;color:#14532d;font-weight:700}
    main{padding:16px 0}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px}
    .card{background:#fff;border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--sh);padding:14px}
    .list-item{border:1px solid var(--bd);border-radius:12px;padding:10px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .title{font-weight:700}
    .mini{font-size:12px;color:#374151}
    .muted{color:var(--muted)}
    .split{display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
    @media (max-width:900px){ .split{grid-template-columns:1fr} }
    label{display:block;font-size:12px;color:#374151;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px;border:1px solid var(--bd);border-radius:10px}
    .form{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .full{grid-column:1/-1}
    .hidden{display:none!important}
    .pill{display:inline-flex;align-items:center;padding:6px 10px;border:1px solid var(--bd);border-radius:999px;font-size:12px;background:#fff;margin-right:6px;margin-bottom:6px}
    .pill.best{background:#0b3d2c;color:#fff;border-color:#0b3d2c}
    .toolbar{display:flex;align-items:center;gap:8px;margin:12px 0}
  </style>
</head>
<body>
<header>
  <div class="container row" style="justify-content:space-between">
    <div>
      <h1>Admin Panel</h1>
      <div class="sub">Banner • Best • Oddiy — Asosiy taglar va Mayda taglar bilan</div>
    </div>
    <div class="tools">
      <button id="btnImport">JSON Import</button>
      <button id="btnExport">JSON Export</button>
      <button id="btnLocal">Local Preview</button>
      <span id="status" class="muted mini"></span>
    </div>
  </div>
  <div class="container">
    <div class="tabs">
      <div class="tab active" data-tab="banners">Banner</div>
      <div class="tab" data-tab="best">Best card</div>
      <div class="tab" data-tab="ordinary">Oddiy card</div>
    </div>
  </div>
</header>

<main class="container">
  <div class="split">
    <section>
      <div class="toolbar">
        <button id="btnNew" class="primary">Yangi qo‘shish</button>
        <span id="count" class="mini muted"></span>
      </div>
      <div id="list" class="grid"></div>
    </section>

    <section>
      <div id="editor" class="card hidden">
        <h3 id="editorTitle" style="margin-top:0">Yangi element</h3>
        <div class="form">
          <div class="full">
            <label>Bo‘lim</label>
            <select id="sec">
              <option value="banners">Banner</option>
              <option value="best">Best card</option>
              <option value="ordinary">Oddiy card</option>
            </select>
          </div>

          <div><label>ID</label><input id="id" placeholder="Bo‘sh qoldirsangiz avtomatik"/></div>
          <div><label>Title</label><input id="title"/></div>
          <div><label>Subtitle</label><input id="subtitle"/></div>
          <div class="full"><label>Image URL</label><input id="image" placeholder="https://..."/></div>
          <div class="full"><label>Link</label><input id="link" placeholder="/tests/... yoki to‘liq URL"/></div>

          <!-- BEST/ODDIY umumiy -->
          <div class="onlyCards"><label>HOME belgisi</label>
            <select id="home">
              <option value="no">Yo‘q</option>
              <option value="yes">Ha</option>
            </select>
          </div>
          <div class="onlyCards"><label>Asosiy teglar (katta)</label><input id="mainTags" placeholder="algebra, geometriya, test..."/></div>
          <div class="onlyCards"><label>Mayda teglar</label><input id="tags" placeholder="7-sinf, tenglama, integral..."/></div>

          <!-- Faqat BEST -->
          <div class="onlyBest"><label>StartAt</label><input id="startAt" type="datetime-local"/></div>
          <div class="onlyBest"><label>EndAt</label><input id="endAt" type="datetime-local"/></div>
          <div class="onlyBest full"><label>Prize / Qo‘shimcha</label><input id="prize"/></div>
          <div class="onlyBest full">
            <label>Qaysi bo‘limlarda ko‘rinsin?</label>
            <div class="row">
              <label><input type="checkbox" id="tTests"/> Testlar</label>
              <label><input type="checkbox" id="tCourses"/> Kurslar</label>
              <label><input type="checkbox" id="tSims"/> Simulyatorlar</label>
              <label><input type="checkbox" id="tHome"/> Bosh sahifa</label>
            </div>
          </div>

          <!-- Faqat ODDIY -->
          <div class="onlyOrd full">
            <label>Qaysi bo‘limga saqlaymiz?</label>
            <select id="ordSec">
              <option value="tests">Testlar</option>
              <option value="courses">Kurslar</option>
              <option value="simulators">Simulyatorlar</option>
            </select>
          </div>
          <div class="onlyOrd"><label>CTA matni</label><input id="cta" placeholder="Boshlash / Batafsil"/></div>

          <!-- Faqat BANNER -->
          <div class="onlyBanner"><label>Banner aktiv?</label>
            <select id="bnActive">
              <option value="yes">Ha</option>
              <option value="no">Yo‘q</option>
            </select>
          </div>
          <div class="onlyBanner"><label>CTA (banner)</label><input id="bnCta" placeholder="Boshlash"/></div>
          <div class="onlyBanner"><label>Mobil rasm URL</label><input id="bnMobile" placeholder="https://..."/></div>
          <div class="onlyBanner"><label>Tartib (order)</label><input id="bnOrder" type="number" min="0" value="0"/></div>

          <div class="full"><label>Details HTML</label><textarea id="details" rows="5" placeholder="&lt;p&gt;Matn...&lt;/p&gt;"></textarea></div>
        </div>

        <div class="row" style="justify-content:flex-end;margin-top:8px">
          <button id="cancel">Bekor qilish</button>
          <button id="save" class="primary">Saqlash</button>
        </div>
      </div>
    </section>
  </div>
</main>

<script>
"use strict";

const $ = (sel)=>document.querySelector(sel);
const list = $("#list");
const editor = $("#editor");
const statusEl = $("#status");
const countEl = $("#count");

const state = {
  tab: "banners",
  editing: null,
  data: {
    meta: { updatedAt: new Date().toISOString() },
    banners: [],
    cards: { tests: [], courses: [], simulators: [] }
  }
};

// ---------- Helpers ----------
function setStatus(m){ if(statusEl) statusEl.textContent = m || ""; }
function loadLocal(){
  try{ const t = localStorage.getItem("__ADMIN_JSON"); return t? JSON.parse(t) : null; }
  catch{ return null; }
}
function saveLocal(d){
  try{ localStorage.setItem("__ADMIN_JSON", JSON.stringify(d, null, 2)); setStatus("Local saqlandi"); }
  catch{ setStatus("Saqlash xatosi"); }
}
function download(name, txt){
  const a = document.createElement("a");
  a.href = "data:application/json;charset=utf-8," + encodeURIComponent(txt);
  a.download = name; document.body.appendChild(a); a.click(); a.remove();
}
function pickFile(){
  return new Promise(res=>{
    const i = document.createElement("input");
    i.type = "file"; i.accept = ".json,application/json";
    i.onchange = ()=>{ const f = i.files[0]; const r = new FileReader(); r.onload = ()=> res(r.result); r.readAsText(f); };
    i.click();
  });
}
function makeId(){ return "id-" + Math.random().toString(36).slice(2); }

// ---------- Tabs & List ----------
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=> t.classList.remove("active"));
    tab.classList.add("active");
    state.tab = tab.dataset.tab;
    closeEditor();
    render();
  });
});

function itemsForTab(){
  const d = state.data;
  if (state.tab === "banners"){
    return d.banners.map((it,idx)=>({sec:"banners", idx, it}));
  }
  // merge from cards
  const wantBest = (state.tab === "best");
  const out = [];
  const seen = new Set();
  ["tests","courses","simulators"].forEach(sec=>{
    (d.cards[sec]||[]).forEach((it,idx)=>{
      const isBest = !!it.best;
      if (wantBest === isBest){
        const key = it.id || `${sec}-${idx}`;
        if (wantBest){
          if (!seen.has(key)){
            seen.add(key);
            out.push({sec, idx, it});
          }
        } else {
          out.push({sec, idx, it});
        }
      }
    });
  });
  return out;
}

function render(){
  const views = itemsForTab();
  list.innerHTML = "";
  if (countEl) countEl.textContent = `${views.length} ta`;

  views.forEach(v => {
    const wrap = document.createElement("div"); wrap.className = "list-item";
    const left = document.createElement("div");
    const right = document.createElement("div"); right.className="row";

    // LEFT
    const ttl = document.createElement("div"); ttl.className="title"; ttl.textContent = v.it.title || "";
    const sub = document.createElement("div"); sub.className="mini muted";
    if (v.sec === "banners"){
      sub.textContent = (v.it.subtitle || "") + (v.it.active ? " • aktiv" : "");
    } else {
      const parts = [];
      if (v.it.best) parts.push("BEST");
      if (v.it.home) parts.push("HOME");
      const secName = v.it.sec || v.sec;
      sub.textContent = `${parts.join(" ")} ${parts.length? "• " : ""}${secName}`;
      const tagRow = document.createElement("div"); tagRow.className="mini";
      tagRow.innerHTML = "<b>Asosiy:</b> " + (v.it.mainTags||[]).map(t=>`<span class="pill">${t}</span>`).join(" ");
      const tagRow2 = document.createElement("div"); tagRow2.className="mini";
      tagRow2.innerHTML = "<b>Mayda:</b> " + (v.it.tags||[]).map(t=>`<span class="pill">${t}</span>`).join(" ");
      left.appendChild(ttl); left.appendChild(sub); left.appendChild(tagRow); left.appendChild(tagRow2);
    }
    if (v.sec === "banners"){ left.appendChild(ttl); left.appendChild(sub); }
    // RIGHT
    const bEdit = document.createElement("button"); bEdit.textContent = "Tahrirlash";
    const bDel = document.createElement("button"); bDel.textContent = "O‘chirish";
    bEdit.addEventListener("click", ()=> openEditor(v));
    bDel.addEventListener("click", ()=>{
      if (!confirm("O‘chirishni tasdiqlaysizmi?")) return;
      if (v.sec === "banners") {
        state.data.banners.splice(v.idx,1);
      } else if (v.it.best) {
        const id = v.it.id;
        ["tests","courses","simulators"].forEach(sec=>{
          state.data.cards[sec] = (state.data.cards[sec]||[]).filter(x=> x.id !== id);
        });
      } else {
        state.data.cards[v.sec].splice(v.idx,1);
      }
      state.data.meta.updatedAt = new Date().toISOString();
      saveLocal(state.data);
      render();
    });
    right.appendChild(bEdit); right.appendChild(bDel);

    wrap.appendChild(left); wrap.appendChild(right);
    list.appendChild(wrap);
  });
}

// ---------- Editor ----------
const fields = {
  sec: $("#sec"), id: $("#id"), title: $("#title"), subtitle: $("#subtitle"),
  image: $("#image"), link: $("#link"),
  home: $("#home"),
  mainTags: $("#mainTags"), tags: $("#tags"),
  startAt: $("#startAt"), endAt: $("#endAt"), prize: $("#prize"),
  tTests: $("#tTests"), tCourses: $("#tCourses"), tSims: $("#tSims"), tHome: $("#tHome"),
  ordSec: $("#ordSec"), cta: $("#cta"),
  bnActive: $("#bnActive"), bnCta: $("#bnCta"), bnMobile: $("#bnMobile"), bnOrder: $("#bnOrder"),
  details: $("#details")
};

function showGroups(){
  const sec = fields.sec.value;
  const isBanner = (sec === "banners");
  const isBest = (sec === "best");
  const isOrd = (sec === "ordinary");

  document.querySelectorAll(".onlyBanner").forEach(el=> el.classList.toggle("hidden", !isBanner));
  document.querySelectorAll(".onlyBest").forEach(el=> el.classList.toggle("hidden", !isBest));
  document.querySelectorAll(".onlyOrd").forEach(el=> el.classList.toggle("hidden", !isOrd));
  document.querySelectorAll(".onlyCards").forEach(el=> el.classList.toggle("hidden", isBanner));
}
fields.sec.addEventListener("change", showGroups);

function openEditor(ref){
  $("#editorTitle").textContent = ref && ref.it ? "Tahrirlash" : "Yangi element";
  editor.classList.remove("hidden");
  state.editing = ref || null;

  // default
  const view = ref?.it || {};
  const sec = ref?.sec || (state.tab==="best" ? "best" : state.tab==="ordinary" ? "ordinary" : "banners");
  fields.sec.value = sec;

  fields.id.value = view.id || "";
  fields.title.value = view.title || "";
  fields.subtitle.value = view.subtitle || "";
  fields.image.value = view.image || "";
  fields.link.value = view.link || "";

  // cards
  fields.home.value = view.home ? "yes" : "no";
  fields.mainTags.value = (view.mainTags||[]).join(", ");
  fields.tags.value = (view.tags||[]).join(", ");

  // best
  fields.startAt.value = view.startAt || "";
  fields.endAt.value = view.endAt || "";
  fields.prize.value = view.prize || "";
  // infer target sections by scanning arrays for same id
  if ((ref?.sec || "") !== "banners" && (view.best || fields.sec.value==="best")){
    const id = view.id;
    const has = (sec)=> (state.data.cards[sec]||[]).some(x=> x.best && x.id===id);
    fields.tTests.checked = has("tests");
    fields.tCourses.checked = has("courses");
    fields.tSims.checked = has("simulators");
    // home flag: if ANY copy has home
    const anyHome = ["tests","courses","simulators"].some(sec=> (state.data.cards[sec]||[]).some(x=> x.best && x.id===id && x.home));
    fields.tHome.checked = anyHome;
  } else {
    fields.tTests.checked = !!(view.targetSections||[]).includes("tests");
    fields.tCourses.checked = !!(view.targetSections||[]).includes("courses");
    fields.tSims.checked = !!(view.targetSections||[]).includes("simulators");
    fields.tHome.checked = !!(view.targetSections||[]).includes("home");
  }

  // ordinary
  fields.ordSec.value = view.sec || "tests";
  fields.cta.value = view.cta || "Boshlash";

  // banner
  fields.bnActive.value = view.active ? "yes" : "no";
  fields.bnCta.value = view.cta || "Boshlash";
  fields.bnMobile.value = view.mobile || "";
  fields.bnOrder.value = (view.order!=null ? view.order : 0);

  // details
  fields.details.value = view.details || "";

  showGroups();
}
function closeEditor(){ editor.classList.add("hidden"); state.editing = null; }

$("#btnNew").addEventListener("click", ()=> openEditor({sec: state.tab}));
$("#cancel").addEventListener("click", closeEditor);

function parseTags(txt){ return (txt||"").split(",").map(s=>s.trim()).filter(Boolean); }

$("#save").addEventListener("click", ()=>{
  const d = state.data;
  const sec = fields.sec.value;

  if (sec === "banners"){
    const obj = {
      id: fields.id.value || makeId(),
      title: fields.title.value, subtitle: fields.subtitle.value,
      image: fields.image.value, link: fields.link.value,
      active: (fields.bnActive.value === "yes"),
      cta: fields.bnCta.value, mobile: fields.bnMobile.value,
      order: Number(fields.bnOrder.value||0),
      details: fields.details.value
    };
    if (state.editing && state.editing.sec==="banners"){
      d.banners[state.editing.idx] = obj;
    } else {
      d.banners.push(obj);
    }
  } else if (sec === "best"){
    const id = fields.id.value || makeId();
    const target = {
      tests: fields.tTests.checked,
      courses: fields.tCourses.checked,
      simulators: fields.tSims.checked,
      home: fields.tHome.checked
    };
    // Base object for copies
    const base = {
      id,
      title: fields.title.value, subtitle: fields.subtitle.value,
      image: fields.image.value, link: fields.link.value,
      best: true, home: (fields.home.value==="yes") || target.home,
      startAt: fields.startAt.value, endAt: fields.endAt.value, prize: fields.prize.value,
      mainTags: parseTags(fields.mainTags.value),
      tags: parseTags(fields.tags.value)
    };
    // Remove previous copies of this best from all sections
    ["tests","courses","simulators"].forEach(sec2=>{
      d.cards[sec2] = (d.cards[sec2]||[]).filter(x=> !(x.best && x.id===id));
    });
    // Insert into each selected section
    ["tests","courses","simulators"].forEach(sec2=>{
      if (target[sec2]){
        const objCopy = Object.assign({}, base, { sec: sec2 });
        (d.cards[sec2] = d.cards[sec2]||[]).push(objCopy);
      }
    });
  } else { // ordinary
    const obj = {
      id: fields.id.value || makeId(),
      title: fields.title.value, subtitle: fields.subtitle.value,
      image: fields.image.value, link: fields.link.value,
      best: false, home: (fields.home.value==="yes"),
      cta: fields.cta.value,
      mainTags: parseTags(fields.mainTags.value),
      tags: parseTags(fields.tags.value),
      sec: fields.ordSec.value,
      details: fields.details.value
    };
    const arr = d.cards[obj.sec] || (d.cards[obj.sec]=[]);
    if (state.editing && state.editing.sec!=="banners"){
      d.cards[state.editing.sec][state.editing.idx] = obj;
    } else {
      arr.push(obj);
    }
  }

  d.meta.updatedAt = new Date().toISOString();
  saveLocal(d);
  closeEditor();
  render();
});

// ---------- Import/Export/Local ----------
$("#btnExport").addEventListener("click", ()=>{
  download("admin.json", JSON.stringify(state.data, null, 2));
});
$("#btnLocal").addEventListener("click", ()=>{
  const t = loadLocal();
  if (t){ state.data = t; setStatus("Localdan yuklandi"); render(); }
  else setStatus("Localda topilmadi");
});
$("#btnImport").addEventListener("click", async ()=>{
  const txt = await pickFile(); if(!txt) return;
  try{
    const json = JSON.parse(txt);
    // migrate missing structures
    json.banners = json.banners || [];
    json.cards = json.cards || { tests:[], courses:[], simulators:[] };
    ["tests","courses","simulators"].forEach(k=> json.cards[k] = (json.cards[k]||[]));
    state.data = json;
    saveLocal(state.data);
    setStatus("Import qilindi");
    render();
  }catch(e){ alert("JSON xato yoki buzilgan"); }
});

// Init
(function init(){
  const t = loadLocal();
  if (t) state.data = t;
  render();
})();
</script>
</body>
</html>
