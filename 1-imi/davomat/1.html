<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <title>Maktab Davomati â€” Admin Paneli</title>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    :root{
      --primary:#7c3aed;
      --primary-dark:#6d28d9;
      --primary-light:#8b5cf6;
      --success:#10b981;
      --warning:#f59e0b;
      --danger:#ef4444;
      --info:#0ea5e9;
      --gray-50:#f9fafb;
      --gray-100:#f3f4f6;
      --gray-200:#e5e7eb;
      --gray-300:#d1d5db;
      --gray-400:#9ca3af;
      --gray-500:#6b7280;
      --gray-600:#4b5563;
      --gray-700:#374151;
      --gray-800:#1f2937;
      --gray-900:#111827;
      --white:#ffffff;
      --shadow:0 1px 3px rgba(0,0,0,.1),0 1px 2px rgba(0,0,0,.06);
      --shadow-md:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);
      --radius:.5rem;
      --radius-lg:.75rem;
      --radius-xl:1rem;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
      line-height:1.5;
      color:var(--gray-800);
      background:var(--gray-50);
    }

    .container{
      width:100%;
      max-width:1200px;
      margin:0 auto;
      padding:1rem;
    }

    /* Header */
    header{
      background:linear-gradient(135deg,var(--primary),var(--primary-dark));
      color:var(--white);
      box-shadow:var(--shadow-lg);
      padding:1rem 0;
      position:sticky;
      top:0;
      z-index:100;
    }
    .header-content{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.75rem;
    }
    .logo{display:flex;align-items:center;gap:.6rem;}
    .logo-icon{
      width:42px;height:42px;
      background:rgba(255,255,255,.2);
      border-radius:var(--radius-lg);
      display:flex;align-items:center;justify-content:center;
      font-size:1.2rem;font-weight:700;
      backdrop-filter:blur(10px);
    }
    .logo-text h1{font-size:1.15rem;font-weight:700;}
    .logo-text p{font-size:.75rem;opacity:.9;}
    
    .header-actions{
      display:flex;
      align-items:center;
      gap:.75rem;
    }
    
    .user-info{
      display:flex;
      align-items:center;
      gap:.5rem;
    }
    .user-avatar{
      width:36px;
      height:36px;
      border-radius:50%;
      background:var(--white);
      color:var(--primary);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:bold;
    }
    .user-name{
      font-size:.85rem;
      font-weight:600;
    }

    /* Main Layout */
    .dashboard{
      display:grid;
      grid-template-columns:250px 1fr;
      gap:1.5rem;
      margin-top:1.5rem;
    }
    
    @media (max-width:768px){
      .dashboard{
        grid-template-columns:1fr;
      }
    }

    /* Sidebar */
    .sidebar{
      background:var(--white);
      border-radius:var(--radius-xl);
      box-shadow:var(--shadow);
      padding:1.25rem;
      height:fit-content;
    }
    .sidebar-title{
      font-size:.9rem;
      font-weight:600;
      color:var(--gray-500);
      text-transform:uppercase;
      letter-spacing:.05em;
      margin-bottom:.75rem;
      padding-bottom:.5rem;
      border-bottom:1px solid var(--gray-200);
    }
    .nav-menu{
      list-style:none;
    }
    .nav-item{
      margin-bottom:.25rem;
    }
    .nav-link{
      display:flex;
      align-items:center;
      gap:.75rem;
      padding:.75rem;
      border-radius:var(--radius);
      text-decoration:none;
      color:var(--gray-700);
      font-weight:500;
      transition:all .2s ease;
    }
    .nav-link:hover{
      background:var(--gray-100);
      color:var(--primary);
    }
    .nav-link.active{
      background:var(--primary-light);
      color:var(--white);
    }
    .nav-link i{
      width:20px;
      text-align:center;
    }

    /* Main Content */
    .main-content{
      display:flex;
      flex-direction:column;
      gap:1.5rem;
    }

    /* Cards */
    .card{
      background:var(--white);
      border-radius:var(--radius-xl);
      box-shadow:var(--shadow);
      padding:1.5rem;
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:1.25rem;
    }
    .card-title{
      font-size:1.25rem;
      font-weight:700;
      color:var(--gray-800);
    }
    .card-subtitle{
      font-size:.9rem;
      color:var(--gray-600);
      margin-top:.25rem;
    }
    
    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
      gap:1rem;
      margin-bottom:1.5rem;
    }
    .stat-card{
      background:var(--white);
      border-radius:var(--radius-lg);
      padding:1.25rem;
      box-shadow:var(--shadow);
      border-left:4px solid var(--primary);
    }
    .stat-card.success{border-color:var(--success);}
    .stat-card.warning{border-color:var(--warning);}
    .stat-card.danger{border-color:var(--danger);}
    .stat-card.info{border-color:var(--info);}
    .stat-title{
      font-size:.85rem;
      font-weight:600;
      color:var(--gray-600);
      text-transform:uppercase;
      letter-spacing:.05em;
      margin-bottom:.5rem;
    }
    .stat-value{
      font-size:1.75rem;
      font-weight:700;
      color:var(--gray-800);
      line-height:1;
    }
    .stat-desc{
      font-size:.75rem;
      color:var(--gray-500);
      margin-top:.5rem;
    }

    /* Buttons */
    .btn{
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      padding:.6rem 1rem;
      border-radius:var(--radius);
      font-weight:600;
      font-size:.85rem;
      cursor:pointer;
      transition:.2s ease;
      border:none;
      text-decoration:none;
      background:var(--primary);
      color:var(--white);
      box-shadow:var(--shadow);
    }
    .btn:hover{
      background:var(--primary-dark);
      transform:translateY(-1px);
      box-shadow:var(--shadow-md);
    }
    .btn-secondary{
      background:var(--gray-200);
      color:var(--gray-700);
    }
    .btn-secondary:hover{
      background:var(--gray-300);
    }
    .btn-success{
      background:var(--success);
    }
    .btn-success:hover{
      background:#0da271;
    }
    .btn-google{
      background:#ffffff;
      color:#757575;
      border:1px solid #ddd;
    }
    .btn-google:hover{
      background:#f5f5f5;
    }
    .btn[disabled]{
      opacity:.6;
      cursor:default;
      transform:none;
    }
    .btn-sm{
      padding:.35rem .75rem;
      font-size:.8rem;
    }
    .btn-icon{
      padding:.5rem;
      width:36px;
      height:36px;
      justify-content:center;
    }

    /* Login Styles */
    .login-card{
      max-width:400px;
      margin:2rem auto;
      text-align:center;
    }
    .login-logo{
      width:80px;
      height:80px;
      background:linear-gradient(135deg,var(--primary),var(--primary-dark));
      border-radius:var(--radius-xl);
      display:flex;
      align-items:center;
      justify-content:center;
      margin:0 auto 1.5rem;
      color:white;
      font-size:2rem;
    }
    .login-title{
      font-size:1.5rem;
      font-weight:700;
      margin-bottom:.5rem;
    }
    .login-subtitle{
      color:var(--gray-600);
      margin-bottom:2rem;
    }
    .google-login-btn{
      width:100%;
      justify-content:center;
      margin-bottom:1rem;
    }
    .divider{
      display:flex;
      align-items:center;
      margin:1.5rem 0;
      color:var(--gray-500);
    }
    .divider::before,
    .divider::after{
      content:"";
      flex:1;
      height:1px;
      background:var(--gray-300);
    }
    .divider span{
      padding:0 1rem;
      font-size:.85rem;
    }
    .admin-list{
      background:var(--gray-50);
      border-radius:var(--radius);
      padding:1rem;
      margin-top:1.5rem;
      text-align:left;
    }
    .admin-list h4{
      font-size:.9rem;
      margin-bottom:.5rem;
      color:var(--gray-700);
    }
    .admin-list ul{
      list-style:none;
      font-size:.85rem;
      color:var(--gray-600);
    }
    .admin-list li{
      padding:.25rem 0;
    }

    /* Form */
    .form-group{
      margin-bottom:1rem;
    }
    label{
      display:block;
      font-size:.85rem;
      font-weight:500;
      margin-bottom:.3rem;
      color:var(--gray-700);
    }
    select, input[type="text"], input[type="date"], input[type="email"], input[type="password"]{
      width:100%;
      padding:.7rem;
      border:1px solid var(--gray-300);
      border-radius:var(--radius);
      font-size:.85rem;
      transition:.2s ease;
      background:var(--white);
    }
    select:focus, input:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 2px rgba(124,58,237,.12);
    }
    .form-row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:1rem;
    }
    @media (max-width:768px){
      .form-row{
        grid-template-columns:1fr;
      }
    }
    
    .date-filter{
      display:flex;
      align-items:center;
      gap:.5rem;
      flex-wrap:wrap;
    }
    .date-input{
      max-width:180px;
    }

    /* Tables */
    .table-container{
      overflow-x:auto;
      border-radius:var(--radius);
      border:1px solid var(--gray-200);
      margin:1rem 0;
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:600px;
    }
    thead{
      background:var(--gray-50);
    }
    th{
      padding:.75rem 1rem;
      text-align:left;
      font-size:.8rem;
      font-weight:600;
      color:var(--gray-700);
      border-bottom:1px solid var(--gray-200);
      white-space:nowrap;
    }
    td{
      padding:.75rem 1rem;
      border-bottom:1px solid var(--gray-200);
      font-size:.85rem;
      vertical-align:middle;
    }
    tbody tr:hover{
      background:var(--gray-50);
    }
    tbody tr:last-child td{
      border-bottom:none;
    }
    
    .status-badge{
      display:inline-flex;
      align-items:center;
      gap:.25rem;
      padding:.25rem .5rem;
      border-radius:1rem;
      font-size:.75rem;
      font-weight:600;
    }
    .status-present{
      background:rgba(16,185,129,.15);
      color:var(--success);
    }
    .status-excused{
      background:rgba(245,158,11,.15);
      color:var(--warning);
    }
    .status-unexcused{
      background:rgba(239,68,68,.15);
      color:var(--danger);
    }
    .status-absent{
      background:rgba(156,163,175,.15);
      color:var(--gray-600);
    }
    
    .attendance-rate{
      display:inline-block;
      padding:.25rem .5rem;
      border-radius:var(--radius);
      font-weight:600;
      font-size:.8rem;
    }
    .rate-high{
      background:rgba(16,185,129,.15);
      color:var(--success);
    }
    .rate-medium{
      background:rgba(245,158,11,.15);
      color:var(--warning);
    }
    .rate-low{
      background:rgba(239,68,68,.15);
      color:var(--danger);
    }

    /* Charts */
    .chart-container{
      height:300px;
      margin:1rem 0;
      position:relative;
    }
    .chart-placeholder{
      display:flex;
      align-items:center;
      justify-content:center;
      height:100%;
      background:var(--gray-50);
      border-radius:var(--radius);
      color:var(--gray-500);
      font-size:.9rem;
    }

    /* Alerts */
    .alert{
      padding:.75rem 1rem;
      border-radius:var(--radius);
      margin-bottom:1rem;
      display:flex;
      align-items:flex-start;
      gap:.6rem;
      font-size:.85rem;
    }
    .alert-icon{
      font-size:1rem;
      margin-top:.05rem;
    }
    .alert-success{
      background:rgba(16,185,129,.1);
      border:1px solid rgba(16,185,129,.25);
      color:var(--success);
    }
    .alert-error{
      background:rgba(239,68,68,.1);
      border:1px solid rgba(239,68,68,.25);
      color:var(--danger);
    }
    .alert-warning{
      background:rgba(245,158,11,.1);
      border:1px solid rgba(245,158,11,.25);
      color:var(--warning);
    }
    .alert-info{
      background:rgba(14,165,233,.1);
      border:1px solid rgba(14,165,233,.25);
      color:var(--info);
    }

    /* Filters */
    .filters{
      display:flex;
      gap:.75rem;
      flex-wrap:wrap;
      margin-bottom:1rem;
      padding:1rem;
      background:var(--gray-50);
      border-radius:var(--radius);
    }
    .filter-group{
      min-width:180px;
    }

    /* Modal */
    .modal{
      display:none;
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,.5);
      z-index:1000;
      align-items:center;
      justify-content:center;
    }
    .modal.active{
      display:flex;
    }
    .modal-content{
      background:var(--white);
      border-radius:var(--radius-xl);
      width:90%;
      max-width:500px;
      max-height:90vh;
      overflow-y:auto;
      box-shadow:var(--shadow-lg);
    }
    .modal-header{
      padding:1.25rem 1.5rem;
      border-bottom:1px solid var(--gray-200);
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .modal-title{
      font-size:1.25rem;
      font-weight:600;
    }
    .modal-body{
      padding:1.5rem;
    }
    .modal-footer{
      padding:1rem 1.5rem;
      border-top:1px solid var(--gray-200);
      display:flex;
      justify-content:flex-end;
      gap:.75rem;
    }
    .close-modal{
      background:none;
      border:none;
      font-size:1.25rem;
      cursor:pointer;
      color:var(--gray-500);
      padding:0;
      width:30px;
      height:30px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:var(--radius);
    }
    .close-modal:hover{
      background:var(--gray-100);
      color:var(--gray-700);
    }

    /* Tabs */
    .tabs{
      display:flex;
      border-bottom:1px solid var(--gray-200);
      margin-bottom:1.5rem;
    }
    .tab{
      padding:.75rem 1.25rem;
      background:none;
      border:none;
      font-weight:600;
      font-size:.9rem;
      color:var(--gray-600);
      cursor:pointer;
      position:relative;
      transition:color .2s ease;
    }
    .tab:hover{
      color:var(--primary);
    }
    .tab.active{
      color:var(--primary);
    }
    .tab.active::after{
      content:'';
      position:absolute;
      bottom:-1px;
      left:0;
      width:100%;
      height:2px;
      background:var(--primary);
    }

    /* Utilities */
    .hidden{display:none;}
    .text-center{text-align:center;}
    .mt-1{margin-top:.25rem;}
    .mt-2{margin-top:.5rem;}
    .mt-3{margin-top:.75rem;}
    .mt-4{margin-top:1rem;}
    .mb-1{margin-bottom:.25rem;}
    .mb-2{margin-bottom:.5rem;}
    .mb-3{margin-bottom:.75rem;}
    .mb-4{margin-bottom:1rem;}
    .font-semibold{font-weight:600;}
    .font-bold{font-weight:700;}
    .text-sm{font-size:.85rem;}
    .text-xs{font-size:.75rem;}
    .w-full{width:100%;}
    .flex{display:flex;}
    .items-center{align-items:center;}
    .justify-between{justify-content:space-between;}
    .gap-2{gap:.5rem;}
  </style>
</head>
<body>
<header>
  <div class="container">
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon"><i class="fas fa-user-shield"></i></div>
        <div class="logo-text">
          <h1>Maktab Davomati</h1>
          <p id="header-subtitle">Admin paneli</p>
        </div>
      </div>
      <div class="header-actions" id="header-actions">
        <!-- Foydalanuvchi tizimga kirmaganda header bo'sh bo'ladi -->
      </div>
    </div>
  </div>
</header>

<main class="container">
  <!-- Kirish qismi -->
  <div id="login-section" class="card login-card">
    <div class="login-logo">
      <i class="fas fa-user-shield"></i>
    </div>
    
    <h2 class="login-title">Admin Paneli</h2>
    <p class="login-subtitle">Kirish uchun Google hisobingizdan foydalaning</p>
    
    <button id="google-login-btn" class="btn btn-google google-login-btn">
      <i class="fab fa-google"></i> Google bilan kirish
    </button>
    
    <div class="divider">
      <span>yoki</span>
    </div>
    
    <div class="form-group">
      <label for="admin-email">Email manzil</label>
      <input type="email" id="admin-email" placeholder="admin@maktab.uz" autocomplete="off">
    </div>
    
    <div class="form-group">
      <label for="admin-password">Parol</label>
      <input type="password" id="admin-password" placeholder="Parolni kiriting" autocomplete="off">
    </div>
    
    <button id="login-btn" class="btn w-full justify-center">
      <i class="fas fa-sign-in-alt"></i> Kirish
    </button>
    
    <div id="login-error" class="alert alert-error hidden mt-3">
      <div class="alert-icon"><i class="fas fa-exclamation-triangle"></i></div>
      <div id="login-error-text">Noto'g'ri email yoki parol</div>
    </div>
    
    <div class="admin-list">
      <h4>Ruxsat etilgan adminlar:</h4>
      <ul>
        <li>sohibjonmath@gmail.com</li>
        <li>gavhar1379@gmail.com</li>
      </ul>
      <p class="text-xs mt-2">Yoki Google hisobi bilan kirishingiz mumkin</p>
    </div>
  </div>
  
  <!-- Admin paneli -->
  <div id="admin-section" class="hidden">
    <div class="dashboard">
      <!-- Sidebar -->
      <aside class="sidebar">
        <h3 class="sidebar-title">Boshqaruv paneli</h3>
        <ul class="nav-menu">
          <li class="nav-item">
            <a href="#dashboard" class="nav-link active" data-tab="dashboard">
              <i class="fas fa-chart-bar"></i> Statistika
            </a>
          </li>
          <li class="nav-item">
            <a href="#classes" class="nav-link" data-tab="classes">
              <i class="fas fa-school"></i> Sinflar davomati
            </a>
          </li>
          <li class="nav-item">
            <a href="#teachers" class="nav-link" data-tab="teachers">
              <i class="fas fa-chalkboard-teacher"></i> Sinf rahbarlari
            </a>
          </li>
          <li class="nav-item">
            <a href="#students" class="nav-link" data-tab="students">
              <i class="fas fa-user-graduate"></i> O'quvchilar davomati
            </a>
          </li>
          <li class="nav-item">
            <a href="#reports" class="nav-link" data-tab="reports">
              <i class="fas fa-file-alt"></i> Hisobotlar
            </a>
          </li>
        </ul>
      </aside>
      
      <!-- Asosiy kontent -->
      <div class="main-content">
        <!-- Dashboard - Umumiy statistika -->
        <div id="dashboard-tab" class="tab-content active">
          <div class="card">
            <div class="card-header">
              <div>
                <h2 class="card-title">Umumiy statistika</h2>
                <p class="card-subtitle">Bugungi davomat holati</p>
              </div>
              <div class="date-filter">
                <input type="date" id="stats-date" class="date-input" value="">
              </div>
            </div>
            
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-title">Jami o'quvchilar</div>
                <div class="stat-value" id="total-students">0</div>
                <div class="stat-desc">Barcha sinflar</div>
              </div>
              <div class="stat-card success">
                <div class="stat-title">Davomat foizi</div>
                <div class="stat-value" id="attendance-rate">0%</div>
                <div class="stat-desc">Bugun maktabda</div>
              </div>
              <div class="stat-card warning">
                <div class="stat-title">Sababli yo'q</div>
                <div class="stat-value" id="excused-absent">0</div>
                <div class="stat-desc">O'quvchilar</div>
              </div>
              <div class="stat-card danger">
                <div class="stat-title">Sababsiz yo'q</div>
                <div class="stat-value" id="unexcused-absent">0</div>
                <div class="stat-desc">O'quvchilar</div>
              </div>
            </div>
            
            <h3 class="mb-3">Sinflar kesimida davomat</h3>
            <div class="table-container">
              <table id="classes-stats-table">
                <thead>
                  <tr>
                    <th>Sinf</th>
                    <th>Sinf rahbari</th>
                    <th>O'quvchilar</th>
                    <th>Bor</th>
                    <th>Sababli</th>
                    <th>Sababsiz</th>
                    <th>Davomat</th>
                  </tr>
                </thead>
                <tbody id="classes-stats-body">
                  <tr><td colspan="7" class="text-center">Ma'lumotlar yuklanmoqda...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="card">
            <h3 class="card-title mb-3">Davomat trendi (7 kun)</h3>
            <div class="chart-container">
              <div class="chart-placeholder">
                <i class="fas fa-chart-line fa-2x mb-2"></i>
                <p>Davomat grafigi bu yerda ko'rsatiladi</p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Sinflar davomati -->
        <div id="classes-tab" class="tab-content hidden">
          <div class="card">
            <div class="card-header">
              <div>
                <h2 class="card-title">Sinflar davomati</h2>
                <p class="card-subtitle">Har bir sinfning davomat holati</p>
              </div>
              <div class="date-filter">
                <input type="date" id="classes-date" class="date-input" value="">
                <select id="class-filter">
                  <option value="">Barcha sinflar</option>
                </select>
              </div>
            </div>
            
            <div class="table-container">
              <table id="classes-attendance-table">
                <thead>
                  <tr>
                    <th>Sinf</th>
                    <th>Sinf rahbari</th>
                    <th>Davomat kiritildi</th>
                    <th>O'quvchilar soni</th>
                    <th>Davomat foizi</th>
                    <th>Harakatlar</th>
                  </tr>
                </thead>
                <tbody id="classes-attendance-body">
                  <tr><td colspan="6" class="text-center">Ma'lumotlar yuklanmoqda...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Sinf rahbarlari -->
        <div id="teachers-tab" class="tab-content hidden">
          <div class="card">
            <div class="card-header">
              <div>
                <h2 class="card-title">Sinf rahbarlari</h2>
                <p class="card-subtitle">Davomat kiritmagan sinf rahbarlari</p>
              </div>
              <div class="date-filter">
                <input type="date" id="teachers-date" class="date-input" value="">
              </div>
            </div>
            
            <div id="no-attendance-alert" class="alert alert-warning">
              <div class="alert-icon"><i class="fas fa-exclamation-circle"></i></div>
              <div>Bugun davomat kiritmagan <span id="no-att-count">0</span> ta sinf rahbari</div>
            </div>
            
            <div class="table-container">
              <table id="teachers-table">
                <thead>
                  <tr>
                    <th>Sinf rahbari</th>
                    <th>Sinf</th>
                    <th>Telefon</th>
                    <th>Oxirgi davomat</th>
                    <th>Holat</th>
                    <th>Harakatlar</th>
                  </tr>
                </thead>
                <tbody id="teachers-body">
                  <tr><td colspan="6" class="text-center">Ma'lumotlar yuklanmoqda...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- O'quvchilar davomati -->
        <div id="students-tab" class="tab-content hidden">
          <div class="card">
            <div class="card-header">
              <div>
                <h2 class="card-title">O'quvchilar davomati</h2>
                <p class="card-subtitle">Har bir o'quvchining davomat tarixi</p>
              </div>
              <div class="date-filter">
                <input type="date" id="students-date" class="date-input" value="">
                <select id="student-class-filter">
                  <option value="">Barcha sinflar</option>
                </select>
                <input type="text" id="student-search" placeholder="O'quvchi qidirish...">
              </div>
            </div>
            
            <div class="table-container">
              <table id="students-attendance-table">
                <thead>
                  <tr>
                    <th>O'quvchi</th>
                    <th>Sinf</th>
                    <th>Bugungi holat</th>
                    <th>Oxirgi 5 kun</th>
                    <th>Umumiy davomat</th>
                    <th>Tafsilotlar</th>
                  </tr>
                </thead>
                <tbody id="students-attendance-body">
                  <tr><td colspan="6" class="text-center">Ma'lumotlar yuklanmoqda...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Hisobotlar -->
        <div id="reports-tab" class="tab-content hidden">
          <div class="card">
            <div class="card-header">
              <div>
                <h2 class="card-title">Hisobotlar</h2>
                <p class="card-subtitle">Davomat hisobotlarini yuklab olish</p>
              </div>
            </div>
            
            <div class="filters">
              <div class="filter-group">
                <label>Boshlanish sanasi</label>
                <input type="date" id="report-start-date" class="w-full">
              </div>
              <div class="filter-group">
                <label>Tugash sanasi</label>
                <input type="date" id="report-end-date" class="w-full">
              </div>
              <div class="filter-group">
                <label>Sinf</label>
                <select id="report-class-filter" class="w-full">
                  <option value="">Barcha sinflar</option>
                </select>
              </div>
              <div class="filter-group">
                <label>Hisobot turi</label>
                <select id="report-type" class="w-full">
                  <option value="daily">Kunlik davomat</option>
                  <option value="monthly">Oylik statistikasi</option>
                  <option value="teacher">Sinf rahbarlari hisoboti</option>
                  <option value="student">O'quvchilar hisoboti</option>
                </select>
              </div>
            </div>
            
            <div class="flex gap-2">
              <button id="generate-report" class="btn btn-success">
                <i class="fas fa-file-excel"></i> Excel hisobot yaratish
              </button>
              <button id="print-report" class="btn btn-secondary">
                <i class="fas fa-print"></i> Chop etish
              </button>
            </div>
          </div>
          
          <div class="card">
            <h3 class="card-title mb-3">Hisobot natijalari</h3>
            <div id="report-results" class="text-center p-4" style="color:var(--gray-500);">
              <i class="fas fa-file-alt fa-3x mb-3"></i>
              <p>Hisobot parametrlarini tanlang va "Excel hisobot yaratish" tugmasini bosing</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- O'quvchi tafsilotlari modal oynasi -->
<div id="student-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">O'quvchi davomati</h3>
      <button class="close-modal" id="close-student-modal">&times;</button>
    </div>
    <div class="modal-body">
      <div class="mb-4">
        <h4 id="student-modal-name" class="font-bold text-lg"></h4>
        <p id="student-modal-class" class="text-sm text-gray-600"></p>
      </div>
      
      <h5 class="mb-3 font-semibold">Oxirgi 10 kunlik davomat</h5>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Sana</th>
              <th>Davomat holati</th>
              <th>Sinf rahbari</th>
            </tr>
          </thead>
          <tbody id="student-attendance-history">
            <tr><td colspan="3" class="text-center">Ma'lumotlar yuklanmoqda...</td></tr>
          </tbody>
        </table>
      </div>
      
      <div class="mt-4 flex justify-between items-center">
        <div>
          <div class="text-sm">Umumiy davomat:</div>
          <div class="text-lg font-bold" id="student-total-attendance">0%</div>
        </div>
        <div>
          <div class="text-sm">Sababsiz yo'qliklar:</div>
          <div class="text-lg font-bold text-danger" id="student-unexcused-absent">0</div>
        </div>
        <div>
          <div class="text-sm">Sababli yo'qliklar:</div>
          <div class="text-lg font-bold text-warning" id="student-excused-absent">0</div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" id="close-modal-btn">Yopish</button>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
  // Firebase config
  const firebaseConfig = {
  apiKey: "AIzaSyDJ46oKqDf52JQRaIqe8SJ5vYSfTpSYZKo",
  authDomain: "mathcenter-1c98d.firebaseapp.com",
  projectId: "mathcenter-1c98d",
  storageBucket: "mathcenter-1c98d.firebasestorage.app",
  messagingSenderId: "1016417719928",
  appId: "1:1016417719928:web:700b028da1312477c87f8d",
  measurementId: "G-JEECME5HMJ"
};
  
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  const davomatCol = db.collection("davomat");

  // Admin hisoblari (faqat email-parol kirish uchun)
  const ADMIN_ACCOUNTS = [
    { email: "sohibjonmath@gmail.com", password: "admin123", name: "Sohibjon" },
    { email: "gavhar1379@gmail.com", password: "admin456", name: "Gavhar" }
  ];

  // DOM elementlari
  const loginSection = document.getElementById("login-section");
  const adminEmailInput = document.getElementById("admin-email");
  const adminPasswordInput = document.getElementById("admin-password");
  const loginBtn = document.getElementById("login-btn");
  const googleLoginBtn = document.getElementById("google-login-btn");
  const loginError = document.getElementById("login-error");
  const loginErrorText = document.getElementById("login-error-text");
  
  const adminSection = document.getElementById("admin-section");
  const headerActions = document.getElementById("header-actions");
  const headerSubtitle = document.getElementById("header-subtitle");
  
  // Tab elementlari
  const navLinks = document.querySelectorAll(".nav-link");
  const tabContents = document.querySelectorAll(".tab-content");
  
  // Dashboard elementlari
  const statsDateInput = document.getElementById("stats-date");
  const totalStudentsSpan = document.getElementById("total-students");
  const attendanceRateSpan = document.getElementById("attendance-rate");
  const excusedAbsentSpan = document.getElementById("excused-absent");
  const unexcusedAbsentSpan = document.getElementById("unexcused-absent");
  const classesStatsBody = document.getElementById("classes-stats-body");
  
  // Sinflar davomati elementlari
  const classesDateInput = document.getElementById("classes-date");
  const classFilterSelect = document.getElementById("class-filter");
  const classesAttendanceBody = document.getElementById("classes-attendance-body");
  
  // Sinf rahbarlari elementlari
  const teachersDateInput = document.getElementById("teachers-date");
  const noAttendanceAlert = document.getElementById("no-attendance-alert");
  const noAttCountSpan = document.getElementById("no-att-count");
  const teachersBody = document.getElementById("teachers-body");
  
  // O'quvchilar davomati elementlari
  const studentsDateInput = document.getElementById("students-date");
  const studentClassFilter = document.getElementById("student-class-filter");
  const studentSearchInput = document.getElementById("student-search");
  const studentsAttendanceBody = document.getElementById("students-attendance-body");
  
  // Hisobotlar elementlari
  const reportStartDate = document.getElementById("report-start-date");
  const reportEndDate = document.getElementById("report-end-date");
  const reportClassFilter = document.getElementById("report-class-filter");
  const reportTypeSelect = document.getElementById("report-type");
  const generateReportBtn = document.getElementById("generate-report");
  const printReportBtn = document.getElementById("print-report");
  const reportResultsDiv = document.getElementById("report-results");
  
  // Modal elementlari
  const studentModal = document.getElementById("student-modal");
  const closeStudentModalBtn = document.getElementById("close-student-modal");
  const closeModalBtn = document.getElementById("close-modal-btn");
  const studentModalName = document.getElementById("student-modal-name");
  const studentModalClass = document.getElementById("student-modal-class");
  const studentAttendanceHistory = document.getElementById("student-attendance-history");
  const studentTotalAttendance = document.getElementById("student-total-attendance");
  const studentUnexcusedAbsent = document.getElementById("student-unexcused-absent");
  const studentExcusedAbsent = document.getElementById("student-excused-absent");
  
  // Global o'zgaruvchilar
  let classesJson = [];
  let allTeachers = [];
  let allStudents = [];
  let currentUser = null;
  let selectedDate = new Date().toISOString().split('T')[0]; // Bugungi sana
  
  // Format date to YYYY-MM-DD
  function formatDate(date) {
    const d = new Date(date);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    return `${y}-${m}-${day}`;
  }
  
  // Format date to readable string
  function formatDateReadable(dateStr) {
    const date = new Date(dateStr);
    const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
    return date.toLocaleDateString('uz-UZ', options);
  }
  
  // Bugungi sanani o'rnatish
  function setCurrentDate() {
    const today = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    
    // Barcha sana inputlariga bugungi sana qiymatini o'rnatish
    statsDateInput.value = selectedDate;
    classesDateInput.value = selectedDate;
    teachersDateInput.value = selectedDate;
    studentsDateInput.value = selectedDate;
    reportStartDate.value = formatDate(new Date().setDate(new Date().getDate() - 7));
    reportEndDate.value = selectedDate;
  }
  
  // Sinflar ma'lumotlarini Firebase Firestore'dan yuklash
  async function loadClassesData() {
    try {
      console.log("Firestore'dan sinf ma'lumotlari yuklanmoqda...");
      
      // 1. Avval sinf hujjatini tekshiramiz
      const sinfDocRef = db.collection("davomat").doc("sinf");
      const sinfDocSnap = await sinfDocRef.get();
      
      if (sinfDocSnap.exists) {
        // Agar davomat/sinf hujjati mavjud bo'lsa, undan o'qiymiz
        const data = sinfDocSnap.data();
        classesJson = data.classes || [];
        console.log("Sinf ma'lumotlari davomat/sinf dan yuklandi:", classesJson.length + " ta sinf");
      } else {
        // 2. Agar davomat/sinf yo'q bo'lsa, sinflar collection'idan o'qiymiz
        console.log("davomat/sinf hujjati topilmadi, sinflar collection'idan o'qilmoqda...");
        
        try {
          const sinflarColRef = db.collection("sinflar");
          const sinflarSnapshot = await sinflarColRef.get();
          
          if (!sinflarSnapshot.empty) {
            const classesPromises = [];
            sinflarSnapshot.forEach(doc => {
              classesPromises.push(Promise.resolve({ id: doc.id, ...doc.data() }));
            });
            
            classesJson = await Promise.all(classesPromises);
            console.log("Sinf ma'lumotlari sinflar collection'idan yuklandi:", classesJson.length + " ta sinf");
          } else {
            // 3. Agar hech qayerda topilmasa, "classes" collection'idan o'qiymiz
            console.log("sinflar collection'ida hujjat yo'q, classes collection'idan o'qilmoqda...");
            
            const classesColRef = db.collection("classes");
            const classesSnapshot = await classesColRef.get();
            
            if (!classesSnapshot.empty) {
              const classesPromises = [];
              classesSnapshot.forEach(doc => {
                classesPromises.push(Promise.resolve({ id: doc.id, ...doc.data() }));
              });
              
              classesJson = await Promise.all(classesPromises);
              console.log("Sinf ma'lumotlari classes collection'idan yuklandi:", classesJson.length + " ta sinf");
            } else {
              console.warn("Hech qanday sinf ma'lumoti topilmadi!");
              classesJson = [];
              showLoginError("Firebase'da sinf ma'lumotlari topilmadi. Iltimos, sinflarni qo'shing.");
              return false;
            }
          }
        } catch (collectionError) {
          console.error("Collection'larni o'qishda xatolik:", collectionError);
          classesJson = [];
          return false;
        }
      }
      
      // Sinf rahbarlarini va o'quvchilarni yig'ish
      allTeachers = [];
      allStudents = [];
      
      classesJson.forEach(cls => {
        // Sinf rahbari ma'lumotlari
        if (cls.teacherLogin || cls.teacherName) {
          allTeachers.push({
            id: cls.teacherLogin || cls.id,
            name: cls.teacherName || "Noma'lum o'qituvchi",
            className: cls.name || cls.id || "Noma'lum sinf",
            classId: cls.id,
            phone: cls.teacherPhone || "Mavjud emas",
            studentsCount: cls.students ? cls.students.length : 0
          });
        }
        
        // O'quvchilar ma'lumotlari
        if (cls.students && Array.isArray(cls.students)) {
          cls.students.forEach(student => {
            allStudents.push({
              id: student.id,
              fullName: student.fullName || student.fullname || `O'quvchi ${student.id}`,
              classId: cls.id,
              className: cls.name || cls.id,
              teacherName: cls.teacherName || "Noma'lum"
            });
          });
        }
      });
      
      console.log(`Yuklandi: ${allTeachers.length} ta sinf rahbari, ${allStudents.length} ta o'quvchi`);
      
      // Filter dropdownlarni to'ldirish
      fillFilterDropdowns();
      
      return true;
    } catch(e) {
      console.error("Firestore'dan ma'lumot olishda xato:", e.message);
      showLoginError("Firebase bilan ulanishda xatolik. Internet aloqasini tekshiring.");
      classesJson = [];
      return false;
    }
  }
  
  // Filter dropdownlarni to'ldirish
  function fillFilterDropdowns() {
    // Sinf filterlari
    const classOptions = ['<option value="">Barcha sinflar</option>'];
    classesJson.forEach(cls => {
      classOptions.push(`<option value="${cls.id}">${cls.name || cls.id}</option>`);
    });
    
    classFilterSelect.innerHTML = classOptions.join('');
    studentClassFilter.innerHTML = classOptions.join('');
    reportClassFilter.innerHTML = classOptions.join('');
  }
  
  // Google bilan kirish
  async function handleGoogleLogin() {
    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      // Qo'shimcha so'rovlar
      provider.addScope('email');
      provider.addScope('profile');
      
      const result = await auth.signInWithPopup(provider);
      const user = result.user;
      
      console.log("Google bilan kirish muvaffaqiyatli:", user.email);
      
      // Admin ekanligini tekshirish
      const isAdmin = await checkIfAdmin(user.email);
      
      if (isAdmin) {
        // Admin panelini ko'rsatish
        showAdminPanel(user);
      } else {
        // Admin emas, chiqarish
        showLoginError("Sizda admin huquqlari yo'q. Faqat ruxsat etilgan adminlar kirishi mumkin.");
        await auth.signOut();
      }
      
    } catch (error) {
      console.error("Google login xatosi:", error);
      showLoginError("Google bilan kirishda xatolik: " + error.message);
    }
  }
  
  // Email-parol bilan kirish
  function handleEmailLogin() {
    const email = adminEmailInput.value.trim();
    const password = adminPasswordInput.value.trim();
    
    hideLoginError();
    
    if (!email || !password) {
      showLoginError("Email va parolni kiriting");
      return;
    }
    
    // Admin hisobini tekshirish
    const admin = ADMIN_ACCOUNTS.find(acc => 
      acc.email === email && acc.password === password
    );
    
    if (!admin) {
      showLoginError("Noto'g'ri email yoki parol. Faqat admin hisoblariga kirish mumkin.");
      return;
    }
    
    // Login muvaffaqiyatli - Firebase Authentication bilan bog'lamaymiz
    // Faqat lokal tekshirish
    const fakeUser = {
      displayName: admin.name,
      email: admin.email,
      photoURL: null
    };
    
    showAdminPanel(fakeUser);
  }
  
  // Admin ekanligini tekshirish
  async function checkIfAdmin(email) {
    // Ruxsat etilgan adminlar ro'yxati
    const allowedAdmins = [
      "sohibjonmath@gmail.com",
      "gavhar1379@gmail.com"
    ];
    
    return allowedAdmins.includes(email);
  }
  
  // Admin panelini ko'rsatish
  async function showAdminPanel(user) {
    currentUser = user;
    
    // Header ni yangilash
    updateHeader(user);
    
    // Login qismini yashirish, admin panelini ko'rsatish
    loginSection.classList.add("hidden");
    adminSection.classList.remove("hidden");
    
    // Sana va ma'lumotlarni o'rnatish
    setCurrentDate();
    
    // Ma'lumotlarni yuklash
    const dataLoaded = await loadClassesData();
    
    if (dataLoaded) {
      // Dashboard statistikalarini yangilash
      updateDashboardStats();
      // Sinflar davomati jadvalini yangilash
      updateClassesAttendance();
      // Sinf rahbarlari jadvalini yangilash
      updateTeachersList();
      // O'quvchilar davomati jadvalini yangilash
      updateStudentsAttendance();
    }
  }
  
  // Header ni yangilash
  function updateHeader(user) {
    const userName = user.displayName || user.email.split('@')[0];
    const userInitial = userName.charAt(0).toUpperCase();
    
    headerActions.innerHTML = `
      <div class="user-info">
        <div class="user-avatar">
          ${user.photoURL ? `<img src="${user.photoURL}" alt="${userName}" style="width:100%;height:100%;border-radius:50%;">` : userInitial}
        </div>
        <div>
          <div class="user-name">${userName}</div>
          <div class="text-xs">Admin</div>
        </div>
      </div>
      <button id="logout-btn" class="btn btn-secondary btn-sm">
        <i class="fas fa-sign-out-alt"></i> Chiqish
      </button>
    `;
    
    // Logout tugmasi uchun event listener qo'shish
    setTimeout(() => {
      const logoutBtn = document.getElementById("logout-btn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", handleLogout);
      }
    }, 100);
  }
  
  // Logout qilish
  async function handleLogout() {
    try {
      // Firebase Authentication bilan chiqish
      await auth.signOut();
    } catch (error) {
      console.error("Logout xatosi:", error);
    }
    
    // Local state ni tozalash
    currentUser = null;
    adminSection.classList.add("hidden");
    loginSection.classList.remove("hidden");
    
    // Header ni tozalash
    headerActions.innerHTML = '';
    headerSubtitle.textContent = 'Admin paneli';
    
    // Formani tozalash
    adminEmailInput.value = "";
    adminPasswordInput.value = "";
    hideLoginError();
  }
  
  // Login xatosini ko'rsatish
  function showLoginError(message) {
    loginErrorText.textContent = message;
    loginError.classList.remove("hidden");
  }
  
  function hideLoginError() {
    loginError.classList.add("hidden");
  }
  
  // Tab o'zgartirish
  function handleTabChange(e) {
    e.preventDefault();
    const targetTab = this.getAttribute("href").substring(1);
    
    // Faol tabni o'zgartirish
    navLinks.forEach(link => link.classList.remove("active"));
    this.classList.add("active");
    
    // Kontentni o'zgartirish
    tabContents.forEach(content => content.classList.add("hidden"));
    document.getElementById(`${targetTab}-tab`).classList.remove("hidden");
    
    // Agar sinflar tabi tanlangan bo'lsa, yangilash
    if (targetTab === "classes") {
      updateClassesAttendance();
    } else if (targetTab === "teachers") {
      updateTeachersList();
    } else if (targetTab === "students") {
      updateStudentsAttendance();
    } else if (targetTab === "dashboard") {
      updateDashboardStats();
    }
  }
  
  // Dashboard statistikalarini yangilash
  async function updateDashboardStats() {
    if (!classesJson.length) return;
    
    const date = statsDateInput.value || selectedDate;
    let totalStudents = 0;
    let totalPresent = 0;
    let totalExcused = 0;
    let totalUnexcused = 0;
    
    // Har bir sinf uchun davomatni o'qish
    const classStats = [];
    
    for (const cls of classesJson) {
      const studentsCount = cls.students ? cls.students.length : 0;
      totalStudents += studentsCount;
      
      // Firebase'dan davomat ma'lumotlarini olish
      const docId = `${date}_${cls.id}`;
      const snap = await davomatCol.doc(docId).get();
      
      let present = 0;
      let excused = 0;
      let unexcused = 0;
      
      if (snap.exists) {
        const data = snap.data();
        (data.students || []).forEach(st => {
          if (st.status === "present") present++;
          else if (st.status === "excused") excused++;
          else if (st.status === "unexcused" || st.status === "absent") unexcused++;
        });
      }
      
      totalPresent += present;
      totalExcused += excused;
      totalUnexcused += unexcused;
      
      const attendanceRate = studentsCount > 0 ? Math.round((present / studentsCount) * 100) : 0;
      
      classStats.push({
        className: cls.name || cls.id,
        teacherName: cls.teacherName || "Noma'lum",
        studentsCount,
        present,
        excused,
        unexcused,
        attendanceRate
      });
    }
    
    // Umumiy statistikani yangilash
    totalStudentsSpan.textContent = totalStudents;
    
    const overallAttendanceRate = totalStudents > 0 ? Math.round((totalPresent / totalStudents) * 100) : 0;
    attendanceRateSpan.textContent = `${overallAttendanceRate}%`;
    excusedAbsentSpan.textContent = totalExcused;
    unexcusedAbsentSpan.textContent = totalUnexcused;
    
    // Sinflar statistikasi jadvalini yangilash
    let tableHTML = "";
    
    if (classStats.length === 0) {
      tableHTML = '<tr><td colspan="7" class="text-center">Davomat ma\'lumotlari topilmadi</td></tr>';
    } else {
      classStats.forEach(stat => {
        const rateClass = stat.attendanceRate >= 90 ? "rate-high" : 
                         stat.attendanceRate >= 70 ? "rate-medium" : "rate-low";
        
        tableHTML += `
          <tr>
            <td>${stat.className}</td>
            <td>${stat.teacherName}</td>
            <td>${stat.studentsCount}</td>
            <td>${stat.present}</td>
            <td>${stat.excused}</td>
            <td>${stat.unexcused}</td>
            <td><span class="attendance-rate ${rateClass}">${stat.attendanceRate}%</span></td>
          </tr>
        `;
      });
    }
    
    classesStatsBody.innerHTML = tableHTML;
  }
  
  // Sinflar davomati jadvalini yangilash
  async function updateClassesAttendance() {
    if (!classesJson.length) return;
    
    const date = classesDateInput.value || selectedDate;
    const selectedClass = classFilterSelect.value;
    
    let tableHTML = "";
    
    for (const cls of classesJson) {
      // Agar sinf filter tanlangan bo'lsa, faqat o'sha sinfni ko'rsatish
      if (selectedClass && cls.id !== selectedClass) continue;
      
      const studentsCount = cls.students ? cls.students.length : 0;
      
      // Firebase'dan davomat ma'lumotlarini olish
      const docId = `${date}_${cls.id}`;
      const snap = await davomatCol.doc(docId).get();
      
      let hasAttendance = snap.exists;
      let lastUpdated = "Kiritilmagan";
      let present = 0;
      let attendanceRate = 0;
      
      if (hasAttendance) {
        const data = snap.data();
        lastUpdated = data.updatedAt ? 
          new Date(data.updatedAt.seconds * 1000).toLocaleTimeString('uz-UZ', {hour: '2-digit', minute:'2-digit'}) : 
          "Bugun";
        
        // Davomatni hisoblash
        (data.students || []).forEach(st => {
          if (st.status === "present") present++;
        });
        
        attendanceRate = studentsCount > 0 ? Math.round((present / studentsCount) * 100) : 0;
      }
      
      const rateClass = attendanceRate >= 90 ? "rate-high" : 
                       attendanceRate >= 70 ? "rate-medium" : "rate-low";
      
      tableHTML += `
        <tr>
          <td>${cls.name || cls.id}</td>
          <td>${cls.teacherName || "Noma'lum"}</td>
          <td>${hasAttendance ? `<span class="status-present status-badge"><i class="fas fa-check"></i> ${lastUpdated}</span>` : 
               `<span class="status-absent status-badge"><i class="fas fa-times"></i> Kiritilmagan</span>`}</td>
          <td>${studentsCount}</td>
          <td><span class="attendance-rate ${rateClass}">${hasAttendance ? attendanceRate + '%' : '0%'}</span></td>
          <td>
            <button class="btn btn-sm btn-secondary" onclick="viewClassDetails('${cls.id}', '${date}')">
              <i class="fas fa-eye"></i> Ko'rish
            </button>
          </td>
        </tr>
      `;
    }
    
    if (!tableHTML) {
      tableHTML = '<tr><td colspan="6" class="text-center">Tanlangan sinf topilmadi</td></tr>';
    }
    
    classesAttendanceBody.innerHTML = tableHTML;
  }
  
  // Sinf rahbarlari jadvalini yangilash
  async function updateTeachersList() {
    if (!classesJson.length) return;
    
    const date = teachersDateInput.value || selectedDate;
    let noAttendanceCount = 0;
    let tableHTML = "";
    
    for (const teacher of allTeachers) {
      // Bu sinfning bugungi davomatini tekshirish
      const docId = `${date}_${teacher.classId}`;
      const snap = await davomatCol.doc(docId).get();
      
      const hasAttendance = snap.exists;
      let lastAttendanceDate = "Hech qachon";
      let statusHTML = "";
      
      if (hasAttendance) {
        const data = snap.data();
        const attendanceDate = data.date || date;
        lastAttendanceDate = formatDateReadable(attendanceDate);
        statusHTML = `<span class="status-present status-badge"><i class="fas fa-check"></i> Davomat kiritgan</span>`;
      } else {
        noAttendanceCount++;
        statusHTML = `<span class="status-unexcused status-badge"><i class="fas fa-times"></i> Davomat kiritmagan</span>`;
        
        // Oxirgi davomat sanasini topish
        for (let i = 1; i <= 7; i++) {
          const checkDate = new Date();
          checkDate.setDate(checkDate.getDate() - i);
          const checkDateStr = formatDate(checkDate);
          
          const checkDocId = `${checkDateStr}_${teacher.classId}`;
          const checkSnap = await davomatCol.doc(checkDocId).get();
          
          if (checkSnap.exists) {
            lastAttendanceDate = formatDateReadable(checkDateStr);
            break;
          }
        }
      }
      
      tableHTML += `
        <tr>
          <td>${teacher.name}</td>
          <td>${teacher.className}</td>
          <td>${teacher.phone}</td>
          <td>${lastAttendanceDate}</td>
          <td>${statusHTML}</td>
          <td>
            <button class="btn btn-sm btn-secondary" onclick="sendReminder('${teacher.id}', '${teacher.name}')">
              <i class="fas fa-bell"></i> Eslatma
            </button>
          </td>
        </tr>
      `;
    }
    
    // Davomat kiritmagan rahbarlar sonini yangilash
    noAttCountSpan.textContent = noAttendanceCount;
    
    if (noAttendanceCount === 0) {
      noAttendanceAlert.classList.add("hidden");
    } else {
      noAttendanceAlert.classList.remove("hidden");
    }
    
    if (!tableHTML) {
      tableHTML = '<tr><td colspan="6" class="text-center">Sinf rahbarlari topilmadi</td></tr>';
    }
    
    teachersBody.innerHTML = tableHTML;
  }
  
  // O'quvchilar davomati jadvalini yangilash
  async function updateStudentsAttendance() {
    if (!allStudents.length) return;
    
    const date = studentsDateInput.value || selectedDate;
    const selectedClass = studentClassFilter.value;
    const searchQuery = studentSearchInput.value.toLowerCase().trim();
    
    let tableHTML = "";
    let displayedCount = 0;
    
    for (const student of allStudents) {
      // Agar sinf filter tanlangan bo'lsa, faqat o'sha sinf o'quvchilarini ko'rsatish
      if (selectedClass && student.classId !== selectedClass) continue;
      
      // Agar qidiruv so'rovi bo'lsa, o'quvchi ismini tekshirish
      if (searchQuery && !student.fullName.toLowerCase().includes(searchQuery)) continue;
      
      // Bugungi davomat holatini olish
      const docId = `${date}_${student.classId}`;
      const snap = await davomatCol.doc(docId).get();
      
      let todayStatus = "Kiritilmagan";
      let statusClass = "status-absent";
      let statusIcon = "fa-question";
      
      if (snap.exists) {
        const data = snap.data();
        const studentRecord = (data.students || []).find(s => s.id === student.id);
        
        if (studentRecord) {
          if (studentRecord.status === "present") {
            todayStatus = "Bor";
            statusClass = "status-present";
            statusIcon = "fa-check";
          } else if (studentRecord.status === "excused") {
            todayStatus = "Sababli yo'q";
            statusClass = "status-excused";
            statusIcon = "fa-user-clock";
          } else if (studentRecord.status === "unexcused" || studentRecord.status === "absent") {
            todayStatus = "Sababsiz yo'q";
            statusClass = "status-unexcused";
            statusIcon = "fa-times";
          }
        }
      }
      
      // Oxirgi 5 kunlik davomat holati (oddiy ko'rinish)
      let last5Days = "";
      
      // Umumiy davomat foizini hisoblash (soxta ma'lumot)
      const totalAttendance = Math.floor(Math.random() * 30) + 70; // 70-100% oralig'ida
      const totalAttendanceClass = totalAttendance >= 90 ? "rate-high" : 
                                  totalAttendance >= 75 ? "rate-medium" : "rate-low";
      
      tableHTML += `
        <tr>
          <td>${student.fullName}</td>
          <td>${student.className}</td>
          <td><span class="status-badge ${statusClass}"><i class="fas ${statusIcon}"></i> ${todayStatus}</span></td>
          <td>
            <div class="flex gap-1">
              ${getLast5DaysIcons(student, date)}
            </div>
          </td>
          <td><span class="attendance-rate ${totalAttendanceClass}">${totalAttendance}%</span></td>
          <td>
            <button class="btn btn-sm btn-secondary" onclick="viewStudentDetails('${student.id}', '${student.fullName}', '${student.className}')">
              <i class="fas fa-chart-line"></i> Tafsilotlar
            </button>
          </td>
        </tr>
      `;
      
      displayedCount++;
      
      // Agar ko'rsatilgan o'quvchilar soni 50 dan oshsa, to'xtatish
      if (displayedCount >= 50) {
        tableHTML += `<tr><td colspan="6" class="text-center">... va yana ${allStudents.length - displayedCount} ta o'quvchi</td></tr>`;
        break;
      }
    }
    
    if (!tableHTML) {
      tableHTML = '<tr><td colspan="6" class="text-center">O\'quvchilar topilmadi</td></tr>';
    }
    
    studentsAttendanceBody.innerHTML = tableHTML;
  }
  
  // Oxirgi 5 kun uchun davomat ikonkalarini olish
  function getLast5DaysIcons(student, date) {
    let icons = "";
    const today = new Date(date);
    
    for (let i = 4; i >= 0; i--) {
      const checkDate = new Date(today);
      checkDate.setDate(checkDate.getDate() - i);
      const checkDateStr = formatDate(checkDate);
      
      // Har bir kun uchun tasodifiy holat (real loyihada Firebase'dan olinadi)
      const statuses = ["present", "excused", "unexcused", "absent"];
      const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
      
      let iconClass = "fa-question";
      let color = "gray";
      
      switch(randomStatus) {
        case "present":
          iconClass = "fa-check";
          color = "green";
          break;
        case "excused":
          iconClass = "fa-user-clock";
          color = "orange";
          break;
        case "unexcused":
        case "absent":
          iconClass = "fa-times";
          color = "red";
          break;
      }
      
      icons += `<i class="fas ${iconClass}" style="color:${color}" title="${checkDateStr}"></i>`;
    }
    
    return icons;
  }
  
  // Sinf tafsilotlarini ko'rish
  async function viewClassDetails(classId, date) {
    const cls = classesJson.find(c => c.id === classId);
    if (!cls) return;
    
    // Firebase'dan davomat ma'lumotlarini olish
    const docId = `${date}_${classId}`;
    const snap = await davomatCol.doc(docId).get();
    
    let modalHTML = `
      <div class="modal" id="class-modal">
        <div class="modal-content" style="max-width:700px;">
          <div class="modal-header">
            <h3 class="modal-title">${cls.name || cls.id} sinfi davomati</h3>
            <button class="close-modal" onclick="closeModal('#class-modal')">&times;</button>
          </div>
          <div class="modal-body">
            <div class="mb-4">
              <h4 class="font-bold text-lg">${cls.teacherName || "Noma'lum"} - Sinf rahbari</h4>
              <p class="text-sm text-gray-600">${date} sana</p>
            </div>
    `;
    
    if (snap.exists) {
      const data = snap.data();
      const students = data.students || [];
      
      modalHTML += `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>O'quvchi</th>
                <th>Davomat holati</th>
                <th>Izoh</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      students.forEach((st, idx) => {
        let statusText = "Bor";
        let statusClass = "status-present";
        
        if (st.status === "excused") {
          statusText = "Sababli yo'q";
          statusClass = "status-excused";
        } else if (st.status === "unexcused" || st.status === "absent") {
          statusText = "Sababsiz yo'q";
          statusClass = "status-unexcused";
        }
        
        modalHTML += `
          <tr>
            <td>${idx + 1}</td>
            <td>${st.fullName || `O'quvchi ${st.id}`}</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>${st.note || "-"}</td>
          </tr>
        `;
      });
      
      modalHTML += `
            </tbody>
          </table>
        </div>
        <div class="mt-4 text-sm">
          <p><strong>Davomat kiritilgan vaqt:</strong> ${data.updatedAt ? 
            new Date(data.updatedAt.seconds * 1000).toLocaleString('uz-UZ') : "Noma'lum"}</p>
        </div>
      `;
    } else {
      modalHTML += `
        <div class="alert alert-warning">
          <div class="alert-icon"><i class="fas fa-exclamation-triangle"></i></div>
          <div>Ushbu sana uchun davomat ma'lumotlari kiritilmagan.</div>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>O'quvchi</th>
                <th>Holat</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      const students = cls.students || [];
      students.forEach((st, idx) => {
        modalHTML += `
          <tr>
            <td>${idx + 1}</td>
            <td>${st.fullName || st.fullname || `O'quvchi ${idx + 1}`}</td>
            <td><span class="status-badge status-absent">Kiritilmagan</span></td>
          </tr>
        `;
      });
      
      modalHTML += `
            </tbody>
          </table>
        </div>
      `;
    }
    
    modalHTML += `
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('#class-modal')">Yopish</button>
          </div>
        </div>
      </div>
    `;
    
    // Modalni sahifaga qo'shish va ko'rsatish
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    document.getElementById('class-modal').classList.add('active');
  }
  
  // O'quvchi tafsilotlarini ko'rish
  async function viewStudentDetails(studentId, studentName, className) {
    // O'quvchini topish
    const student = allStudents.find(s => s.id === studentId);
    if (!student) return;
    
    // Modal sarlavhasini o'rnatish
    studentModalName.textContent = studentName;
    studentModalClass.textContent = `${className} sinfi`;
    
    // Oxirgi 10 kunlik davomat tarixini olish
    let historyHTML = "";
    let presentCount = 0;
    let excusedCount = 0;
    let unexcusedCount = 0;
    let totalDays = 0;
    
    const today = new Date();
    
    for (let i = 0; i < 10; i++) {
      const checkDate = new Date(today);
      checkDate.setDate(checkDate.getDate() - i);
      const checkDateStr = formatDate(checkDate);
      
      // Firebase'dan davomat ma'lumotlarini olish
      const docId = `${checkDateStr}_${student.classId}`;
      const snap = await davomatCol.doc(docId).get();
      
      let statusText = "Kiritilmagan";
      let statusClass = "status-absent";
      
      if (snap.exists) {
        const data = snap.data();
        const studentRecord = (data.students || []).find(s => s.id === studentId);
        
        if (studentRecord) {
          totalDays++;
          
          if (studentRecord.status === "present") {
            statusText = "Bor";
            statusClass = "status-present";
            presentCount++;
          } else if (studentRecord.status === "excused") {
            statusText = "Sababli yo'q";
            statusClass = "status-excused";
            excusedCount++;
          } else if (studentRecord.status === "unexcused" || studentRecord.status === "absent") {
            statusText = "Sababsiz yo'q";
            statusClass = "status-unexcused";
            unexcusedCount++;
          }
        }
      }
      
      historyHTML += `
        <tr>
          <td>${formatDateReadable(checkDateStr)}</td>
          <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          <td>${student.teacherName}</td>
        </tr>
      `;
    }
    
    // Agar tarix bo'sh bo'lsa
    if (!historyHTML) {
      historyHTML = '<tr><td colspan="3" class="text-center">Davomat tarixi topilmadi</td></tr>';
    }
    
    studentAttendanceHistory.innerHTML = historyHTML;
    
    // Statistikani hisoblash va ko'rsatish
    const totalAttendance = totalDays > 0 ? Math.round((presentCount / totalDays) * 100) : 0;
    studentTotalAttendance.textContent = `${totalAttendance}%`;
    studentExcusedAbsent.textContent = excusedCount;
    studentUnexcusedAbsent.textContent = unexcusedCount;
    
    // Modalni ochish
    studentModal.classList.add("active");
  }
  
  // Eslatma yuborish (simulyatsiya)
  function sendReminder(teacherId, teacherName) {
    alert(`Eslatma ${teacherName} ga yuborildi! (Simulyatsiya)`);
  }
  
  // Modalni yopish
  function closeModal(modalId) {
    const modal = document.querySelector(modalId);
    if (modal) {
      modal.classList.remove("active");
      setTimeout(() => {
        if (modal.parentNode) {
          modal.parentNode.removeChild(modal);
        }
      }, 300);
    }
  }
  
  // Hisobot yaratish (simulyatsiya)
  function generateReport() {
    const startDate = reportStartDate.value;
    const endDate = reportEndDate.value;
    const classId = reportClassFilter.value;
    const reportType = reportTypeSelect.value;
    
    if (!startDate || !endDate) {
      alert("Iltimos, boshlanish va tugash sanalarini tanlang");
      return;
    }
    
    // Hisobotni yaratish (simulyatsiya)
    let reportContent = `
      <div class="alert alert-success">
        <div class="alert-icon"><i class="fas fa-check-circle"></i></div>
        <div>Hisobot yaratildi!</div>
      </div>
      <div class="mt-4">
        <h4 class="font-bold mb-2">Hisobot parametrlari:</h4>
        <ul class="text-sm">
          <li><strong>Davr:</strong> ${startDate} dan ${endDate} gacha</li>
          <li><strong>Sinf:</strong> ${classId || "Barcha sinflar"}</li>
          <li><strong>Hisobot turi:</strong> ${reportTypeSelect.options[reportTypeSelect.selectedIndex].text}</li>
          <li><strong>Yaratilgan vaqt:</strong> ${new Date().toLocaleString('uz-UZ')}</li>
          <li><strong>Admin:</strong> ${currentUser ? currentUser.displayName || currentUser.email.split('@')[0] : "Noma'lum"}</li>
        </ul>
      </div>
      <div class="mt-4">
        <p>Haqiqiy loyihada bu yerda Excel fayli yoki PDF hisoboti yuklab olish tugmasi bo'ladi.</p>
        <button class="btn btn-success mt-3">
          <i class="fas fa-download"></i> Excel faylni yuklab olish (Simulyatsiya)
        </button>
      </div>
    `;
    
    reportResultsDiv.innerHTML = reportContent;
  }
  
  // Chop etish funksiyasi
  function printReport() {
    alert("Chop etish funksiyasi ishlab chiqilmoqda...");
  }
  
  // Sana o'zgartirilganda statistikani yangilash
  function handleDateChange() {
    selectedDate = this.value || new Date().toISOString().split('T')[0];
    
    // Faol tabga qarab mos funksiyani chaqirish
    const activeTab = document.querySelector(".nav-link.active");
    if (activeTab) {
      const tabId = activeTab.getAttribute("href").substring(1);
      
      if (tabId === "dashboard") {
        updateDashboardStats();
      } else if (tabId === "classes") {
        updateClassesAttendance();
      } else if (tabId === "teachers") {
        updateTeachersList();
      } else if (tabId === "students") {
        updateStudentsAttendance();
      }
    }
  }
  
  // Foydalanuvchi avtorizatsiya holatini kuzatish
  function setupAuthListener() {
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        console.log("Foydalanuvchi avtorizatsiyadan o'tdi:", user.email);
        
        // Admin ekanligini tekshirish
        const isAdmin = await checkIfAdmin(user.email);
        
        if (isAdmin) {
          showAdminPanel(user);
        } else {
          // Admin emas, chiqarish
          console.log("Foydalanuvchi admin emas, chiqarilmoqda...");
          await auth.signOut();
          showLoginError("Sizda admin huquqlari yo'q. Faqat ruxsat etilgan adminlar kirishi mumkin.");
        }
      } else {
        console.log("Foydalanuvchi chiqdi");
      }
    });
  }
  
  // Dasturni ishga tushirish
  document.addEventListener("DOMContentLoaded", () => {
    // Avtorizatsiya listener'ini o'rnatish
    setupAuthListener();
    
    // Sana inputlarini flatpickr bilan bog'lash
    [statsDateInput, classesDateInput, teachersDateInput, studentsDateInput].forEach(input => {
      input.addEventListener("change", handleDateChange);
    });
    
    // Login uchun event listener'lar
    googleLoginBtn.addEventListener("click", handleGoogleLogin);
    loginBtn.addEventListener("click", handleEmailLogin);
    
    adminPasswordInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") handleEmailLogin();
    });
    
    // Tab o'zgartirish
    navLinks.forEach(link => {
      link.addEventListener("click", handleTabChange);
    });
    
    // Filter o'zgarishlari
    classFilterSelect.addEventListener("change", updateClassesAttendance);
    studentClassFilter.addEventListener("change", updateStudentsAttendance);
    studentSearchInput.addEventListener("input", updateStudentsAttendance);
    
    // Hisobotlar
    generateReportBtn.addEventListener("click", generateReport);
    printReportBtn.addEventListener("click", printReport);
    
    // Modal yopish
    closeStudentModalBtn.addEventListener("click", () => {
      studentModal.classList.remove("active");
    });
    
    closeModalBtn.addEventListener("click", () => {
      studentModal.classList.remove("active");
    });
    
    // Modal tashqarisini bosganda yopish
    studentModal.addEventListener("click", (e) => {
      if (e.target === studentModal) {
        studentModal.classList.remove("active");
      }
    });
    
    // Global funktsiyalarni window obyektiga qo'shish
    window.viewClassDetails = viewClassDetails;
    window.viewStudentDetails = viewStudentDetails;
    window.sendReminder = sendReminder;
    window.closeModal = closeModal;
    
    // Dastlabki sanani o'rnatish
    setCurrentDate();
  });
</script>
</body>
</html>