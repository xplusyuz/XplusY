<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <title>Maktab Davomati — Sinf rahbari</title>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --primary:#2563eb;
      --primary-dark:#1d4ed8;
      --primary-light:#3b82f6;
      --success:#10b981;
      --warning:#f59e0b;
      --danger:#ef4444;
      --gray-50:#f9fafb;
      --gray-100:#f3f4f6;
      --gray-200:#e5e7eb;
      --gray-300:#d1d5db;
      --gray-400:#9ca3af;
      --gray-500:#6b7280;
      --gray-600:#4b5563;
      --gray-700:#374151;
      --gray-800:#1f2937;
      --white:#ffffff;
      --shadow:0 1px 3px rgba(0,0,0,.1),0 1px 2px rgba(0,0,0,.06);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);
      --radius-lg:.75rem;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
      line-height:1.5;
      color:var(--gray-800);
      background:var(--gray-50);
    }

    .container{
      width:100%;
      max-width:480px;
      margin:0 auto;
      padding:1rem .75rem;
    }

    /* Header */
    header{
      background:linear-gradient(135deg,var(--primary),var(--primary-dark));
      color:var(--white);
      box-shadow:var(--shadow-lg);
      padding:1rem 0;
    }
    .header-content{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.75rem;
    }
    .logo{display:flex;align-items:center;gap:.6rem;}
    .logo-icon{
      width:36px;height:36px;
      background:rgba(255,255,255,.2);
      border-radius:var(--radius-lg);
      display:flex;align-items:center;justify-content:center;
      font-size:1.1rem;font-weight:700;
      backdrop-filter:blur(10px);
    }
    .logo-text h1{font-size:1.05rem;font-weight:700;}
    .logo-text p{font-size:.7rem;opacity:.9;}

    /* Buttons */
    .btn{
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      padding:.6rem 1rem;
      border-radius:var(--radius-lg);
      font-weight:600;
      font-size:.85rem;
      cursor:pointer;
      transition:.2s ease;
      border:none;
      text-decoration:none;
      background:var(--white);
      color:var(--primary);
      box-shadow:var(--shadow);
    }
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-lg);}
    .btn[disabled]{opacity:.6;cursor:default;transform:none;}

    /* Cards */
    .card{
      background:var(--white);
      border-radius:var(--radius-lg);
      box-shadow:var(--shadow);
      margin-top:1rem;
      padding:1.25rem;
    }
    .card-title{
      font-size:1rem;
      font-weight:700;
      margin-bottom:.5rem;
    }

    /* Form */
    .form-group{margin-bottom:1rem;}
    label{
      display:block;
      font-size:.85rem;
      font-weight:500;
      margin-bottom:.3rem;
      color:var(--gray-700);
    }
    select{
      width:100%;
      padding:.7rem;
      border:1px solid var(--gray-300);
      border-radius:var(--radius-lg);
      font-size:.85rem;
      transition:.2s ease;
      background:var(--white);
    }
    select:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 2px rgba(37,99,235,.12);
    }

    /* Table */
    .table-container{
      overflow-x:auto;
      margin:1rem 0;
    }
    table{
      width:100%;
      border-collapse:collapse;
    }
    th{
      background:var(--gray-100);
      padding:.6rem .5rem;
      text-align:left;
      font-size:.8rem;
      font-weight:600;
      color:var(--gray-700);
      border-bottom:1px solid var(--gray-200);
    }
    td{
      padding:.6rem .5rem;
      border-bottom:1px solid var(--gray-200);
      font-size:.85rem;
    }
    tr:hover{background:var(--gray-50);}

    /* Alerts */
    .alert{
      padding:.75rem;
      border-radius:var(--radius-lg);
      margin-bottom:1rem;
      display:flex;
      align-items:flex-start;
      gap:.55rem;
      font-size:.85rem;
    }
    .alert-icon{font-size:1rem;margin-top:.05rem;}
    .alert-success{
      background:rgba(16,185,129,.08);
      border:1px solid rgba(16,185,129,.25);
      color:var(--success);
    }
    .alert-error{
      background:rgba(239,68,68,.08);
      border:1px solid rgba(239,68,68,.25);
      color:var(--danger);
    }
    .alert-warning{
      background:rgba(245,158,11,.08);
      border:1px solid rgba(245,158,11,.25);
      color:var(--warning);
    }

    .hidden{display:none;}
    .text-center{text-align:center;}
    .mt-2{margin-top:.5rem;}
    .mt-3{margin-top:.75rem;}
    .mb-3{margin-bottom:.75rem;}
    .font-semibold{font-weight:600;}
  </style>
</head>
<body>
<header>
  <div class="container">
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon"><i class="fas fa-school"></i></div>
        <div class="logo-text">
          <h1>Maktab Davomati</h1>
          <p>Sinf rahbari paneli</p>
        </div>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <!-- Login qismi -->
  <div id="login-section" class="card">
    <h2 class="card-title">Tizimga kirish</h2>
    
    <div class="form-group">
      <label for="login-select">Sinf rahbarini tanlang</label>
      <select id="login-select">
        <option value="">Sinf rahbarini tanlang</option>
        <!-- Loginlar avtomatik to'ldiriladi -->
      </select>
    </div>
    
    <button id="start-btn" class="btn" style="width:100%;justify-content:center;">
      <i class="fas fa-sign-in-alt"></i> Kirish
    </button>
    
    <div id="error-alert" class="alert alert-error hidden mt-3">
      <div class="alert-icon"><i class="fas fa-exclamation-triangle"></i></div>
      <div id="error-text">Sinf rahbarini tanlang</div>
    </div>
  </div>
  
  <!-- Davomat qismi -->
  <div id="attendance-section" class="card hidden">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
      <div>
        <h2 class="card-title" id="teacher-name">Sinf rahbari</h2>
        <p style="font-size:.85rem;color:var(--gray-600);" id="class-info"></p>
      </div>
      <button id="logout-btn" class="btn" style="padding:.4rem .7rem;font-size:.8rem;">
        <i class="fas fa-sign-out-alt"></i> Chiqish
      </button>
    </div>
    
    <div id="info-alert" class="alert alert-success">
      <div class="alert-icon">✅</div>
      <div>Davomatni har qanday vaqtda kiritishingiz mumkin</div>
    </div>
    
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>F.I.Sh.</th>
            <th>Holat</th>
          </tr>
        </thead>
        <tbody id="students-tbody"></tbody>
      </table>
    </div>
    
    <button id="save-btn" class="btn" style="width:100%;justify-content:center;">
      <i class="fas fa-save"></i> Davomatni saqlash
    </button>
  </div>
</main>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
    authDomain: "xplusy-760fa.firebaseapp.com",
    projectId: "xplusy-760fa",
    storageBucket: "xplusy-760fa.firebasestorage.app",
    messagingSenderId: "992512966017",
    appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const davomatCol = db.collection("davomat");

  // DOM elements
  const loginSection = document.getElementById("login-section");
  const loginSelect = document.getElementById("login-select");
  const startBtn = document.getElementById("start-btn");
  const errorAlert = document.getElementById("error-alert");
  const errorText = document.getElementById("error-text");
  const attendanceSection = document.getElementById("attendance-section");
  const teacherName = document.getElementById("teacher-name");
  const classInfo = document.getElementById("class-info");
  const logoutBtn = document.getElementById("logout-btn");
  const infoAlert = document.getElementById("info-alert");
  const studentsTbody = document.getElementById("students-tbody");
  const saveBtn = document.getElementById("save-btn");

  let classesJson = [];
  let currentTeacher = null;

  // Format date to YYYY-MM-DD
  function toDateStr() {
    const today = new Date();
    const y = today.getFullYear();
    const m = String(today.getMonth() + 1).padStart(2, "0");
    const d = String(today.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
  }

  // Load classes data from sinf.json
  async function loadClassesData() {
  try {
    const docRef = db.collection("davomat").doc("sinf");
    const docSnap = await docRef.get();

    if (!docSnap.exists) {
      console.error("davomat/sinf hujjati topilmadi");
      classesJson = [];
      return;
    }

    const data = docSnap.data();
    classesJson = data.classes || []; // classes massivini olish

    console.log("Sinflar yuklandi:", classesJson);

  } catch (error) {
    console.error("Xatolik:", error);
  }
}

  // Fill login select with teachers from sinf.json
  function fillLoginSelect() {
    loginSelect.innerHTML = '<option value="">Sinf rahbarini tanlang</option>';
    
    if (!classesJson.length) {
      loginSelect.innerHTML += '<option value="" disabled>sinf.json bo\'sh yoki xato</option>';
      return;
    }
    
    classesJson.forEach(cls => {
      const login = cls.teacherLogin || "";
      const name = cls.teacherName || "Noma'lum";
      const className = cls.name || cls.id || "Noma'lum sinf";
      
      if (login) {
        const option = document.createElement("option");
        option.value = login;
        option.textContent = `${name} (${className})`;
        loginSelect.appendChild(option);
      }
    });
  }

  // Show/hide error
  function showError(msg) {
    errorText.textContent = msg;
    errorAlert.classList.remove("hidden");
  }
  
  function hideError() {
    errorAlert.classList.add("hidden");
  }

  // Login with selected teacher
  async function handleLogin() {
    hideError();
    const selectedLogin = loginSelect.value;
    
    if (!selectedLogin) {
      showError("Sinf rahbarini tanlang");
      return;
    }
    
    // Find teacher by login
    const cls = classesJson.find(c => c.teacherLogin === selectedLogin);
    
    if (!cls) {
      showError("Tanlangan login bilan sinf topilmadi");
      return;
    }
    
    currentTeacher = {
      login: selectedLogin,
      teacherName: cls.teacherName || selectedLogin,
      classObj: cls
    };
    
    // Show attendance section
    teacherName.textContent = cls.teacherName || selectedLogin;
    classInfo.textContent = `${cls.name || cls.id} sinfi • ${cls.students?.length || 0} ta o'quvchi`;
    loginSection.classList.add("hidden");
    attendanceSection.classList.remove("hidden");
    
    // Load students
    await loadStudents();
  }

  // Load students for the class
  async function loadStudents() {
    if (!currentTeacher) return;
    
    const cls = currentTeacher.classObj;
    const students = cls.students || [];
    const today = toDateStr();
    
    if (!students.length) {
      studentsTbody.innerHTML = '<tr><td colspan="3" class="text-center">O\'quvchilar ro\'yxati topilmadi</td></tr>';
      return;
    }
    
    // Load existing attendance for today
    const docId = `${today}_${cls.id}`;
    const snap = await davomatCol.doc(docId).get();
    const existingMap = {};
    
    if (snap.exists) {
      (snap.data().students || []).forEach(st => {
        existingMap[st.id] = st.status;
      });
    }
    
    // Render students table
    studentsTbody.innerHTML = "";
    students.forEach((st, idx) => {
      const tr = document.createElement("tr");
      const status = existingMap[st.id] || "present";
      
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${st.fullName || `O'quvchi ${idx + 1}`}</td>
        <td>
          <select class="status-select" data-student-id="${st.id}">
            <option value="present">Bor</option>
            <option value="excused">Sababli yo'q</option>
            <option value="unexcused">Sababsiz yo'q</option>
          </select>
        </td>
      `;
      
      studentsTbody.appendChild(tr);
      const sel = tr.querySelector("select");
      sel.value = (status === "absent" ? "unexcused" : status);
    });
  }

  // Save attendance
  async function saveAttendance() {
    if (!currentTeacher) return;
    
    const cls = currentTeacher.classObj;
    const students = cls.students || [];
    const today = toDateStr();
    
    if (!students.length) {
      alert("O'quvchilar ro'yxati yo'q");
      return;
    }
    
    const rows = studentsTbody.querySelectorAll("tr");
    const resStudents = [];
    
    students.forEach((st, idx) => {
      const row = rows[idx];
      const sel = row.querySelector("select");
      let status = sel.value;
      if (status === "absent") status = "unexcused";
      resStudents.push({ 
        id: st.id, 
        fullName: st.fullName || `O'quvchi ${idx + 1}`,
        status 
      });
    });
    
    const docId = `${today}_${cls.id}`;
    
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saqlanmoqda...';
    
    try {
      await davomatCol.doc(docId).set({
        date: today,
        classId: cls.id,
        className: cls.name || cls.id,
        teacherLogin: currentTeacher.login,
        teacherName: currentTeacher.teacherName,
        students: resStudents,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      
      alert("Davomat saqlandi!");
    } catch(e) {
      console.error(e);
      alert("Saqlashda xatolik: " + e.message);
    } finally {
      saveBtn.disabled = false;
      saveBtn.innerHTML = '<i class="fas fa-save"></i> Davomatni saqlash';
    }
  }

  // Logout
  function logout() {
    currentTeacher = null;
    attendanceSection.classList.add("hidden");
    loginSection.classList.remove("hidden");
    hideError();
    loginSelect.value = "";
  }

  // Initialize
  document.addEventListener("DOMContentLoaded", async () => {
    await loadClassesJson();
    
    // Event listeners
    startBtn.addEventListener("click", handleLogin);
    
    loginSelect.addEventListener("keydown", e => {
      if (e.key === "Enter") handleLogin();
    });
    
    logoutBtn.addEventListener("click", logout);
    saveBtn.addEventListener("click", saveAttendance);
    
    // Auto-login from localStorage if exists
    const savedLogin = localStorage.getItem("davomat_last_login");
    if (savedLogin) {
      loginSelect.value = savedLogin;
      // Auto-login after a short delay
      setTimeout(() => {
        if (loginSelect.value === savedLogin) {
          handleLogin();
        }
      }, 100);
    }
    
    // Save login to localStorage on successful login
    startBtn.addEventListener("click", () => {
      if (loginSelect.value) {
        localStorage.setItem("davomat_last_login", loginSelect.value);
      }
    });
  });
</script>
</body>
</html>