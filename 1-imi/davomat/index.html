<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <title>Maktab Davomati — Sinf rahbari paneli</title>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* =================== THEME =================== */
    :root{
      --primary:#2563eb;
      --primary-dark:#1d4ed8;
      --primary-light:#3b82f6;
      --secondary:#10b981;
      --secondary-dark:#059669;
      --accent:#8b5cf6;
      --success:#10b981;
      --warning:#f59e0b;
      --danger:#ef4444;
      --gray-50:#f9fafb;
      --gray-100:#f3f4f6;
      --gray-200:#e5e7eb;
      --gray-300:#d1d5db;
      --gray-400:#9ca3af;
      --gray-500:#6b7280;
      --gray-600:#4b5563;
      --gray-700:#374151;
      --gray-800:#1f2937;
      --gray-900:#111827;
      --white:#ffffff;
      --shadow-sm:0 1px 2px rgba(0,0,0,.05);
      --shadow:0 1px 3px rgba(0,0,0,.1),0 1px 2px rgba(0,0,0,.06);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);
      --radius-sm:.25rem;
      --radius:.375rem;
      --radius-md:.5rem;
      --radius-lg:.75rem;
      --radius-xl:1rem;
      --radius-2xl:1.5rem;
      --radius-full:999px;
    }

    /* ========== RESET & BASE ========== */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{
      height:100%;
      font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
      line-height:1.5;
      color:var(--gray-800);
      background:var(--gray-50);
    }
    body{font-size:14px;}

    .container{
      width:100%;
      max-width:480px;      /* mobil fokus */
      margin:0 auto;
      padding:0 .75rem 1.5rem;
    }

    /* ========== HEADER ========== */
    header{
      background:linear-gradient(135deg,var(--primary),var(--primary-dark));
      color:var(--white);
      box-shadow:var(--shadow-lg);
      position:sticky;
      top:0;
      z-index:20;
    }
    .header-content{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:.75rem 0 .5rem;
      gap:.75rem;
    }
    .logo{display:flex;align-items:center;gap:.6rem;}
    .logo-icon{
      width:36px;height:36px;
      background:rgba(255,255,255,.2);
      border-radius:var(--radius-lg);
      display:flex;align-items:center;justify-content:center;
      font-size:1.1rem;font-weight:700;
      backdrop-filter:blur(10px);
    }
    .logo-text h1{font-size:1.05rem;font-weight:700;}
    .logo-text p{font-size:.7rem;opacity:.9;}

    .header-actions{
      display:flex;
      justify-content:center;
      padding:0 0 .7rem;
    }
    .date-chip{
      background:rgba(255,255,255,.15);
      border-radius:var(--radius-xl);
      padding:.35rem .7rem;
      font-size:.75rem;
      font-weight:500;
      backdrop-filter:blur(10px);
      display:inline-flex;
      align-items:center;
      gap:.4rem;
    }

    /* ========== BUTTONS ========== */
    .btn{
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      padding:.5rem 1rem;
      border-radius:var(--radius-lg);
      font-weight:600;
      font-size:.78rem;
      cursor:pointer;
      transition:.2s ease;
      border:none;
      text-decoration:none;
      white-space:nowrap;
    }
    .btn-primary{
      background:var(--white);
      color:var(--primary);
      box-shadow:var(--shadow);
    }
    .btn-primary:hover{transform:translateY(-1px);box-shadow:var(--shadow-lg);}
    .btn-ghost{
      background:transparent;
      color:var(--gray-600);
      border:1px solid var(--gray-300);
    }
    .btn-ghost:hover{background:var(--gray-100);color:var(--gray-800);}
    .btn-sm{padding:.4rem .7rem;font-size:.72rem;}
    .btn[disabled]{opacity:.6;cursor:default;transform:none;box-shadow:none;}

    /* ========== CARDS ========== */
    .card{
      background:var(--white);
      border-radius:var(--radius-xl);
      box-shadow:var(--shadow);
      margin-top:1rem;
      overflow:hidden;
    }
    .card-header{
      padding:1rem 1.1rem;
      border-bottom:1px solid var(--gray-200);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:.75rem;
    }
    .card-title{font-size:.95rem;font-weight:700;margin-bottom:.2rem;}
    .card-subtitle{font-size:.78rem;color:var(--gray-600);}
    .card-body{padding:1.1rem;}

    /* ========== STATS ========== */
    .stats-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:.75rem;
      margin-bottom:1rem;
    }
    .stat-card{
      border-radius:var(--radius-lg);
      padding:.9rem;
      box-shadow:var(--shadow-sm);
      border-left:3px solid var(--primary);
      background:var(--white);
    }
    .stat-card.success{border-left-color:var(--success);}
    .stat-card.warning{border-left-color:var(--warning);}
    .stat-card.danger{border-left-color:var(--danger);}
    .stat-label{font-size:.78rem;color:var(--gray-600);margin-bottom:.3rem;}
    .stat-value{font-size:1.3rem;font-weight:700;margin-bottom:.3rem;}
    .stat-detail{font-size:.7rem;color:var(--gray-500);}

    /* progress bars */
    .progress-bar{
      height:7px;
      background:var(--gray-200);
      border-radius:var(--radius-full);
      overflow:hidden;
      margin-top:.45rem;
    }
    .progress-fill{height:100%;border-radius:var(--radius-full);transition:width .25s ease;}
    /* multi-segment bar (yashil / sariq / qizil) */
    .progress-multi{display:flex;}
    .seg-present{background:var(--success);}
    .seg-excused{background:var(--warning);}
    .seg-unexcused{background:var(--danger);}

    /* legend */
    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:.6rem;
      margin:.5rem 0 0;
      font-size:.72rem;
    }
    .legend-item{display:flex;align-items:center;gap:.35rem;}
    .legend-color{
      width:10px;height:10px;border-radius:50%;
    }
    .legend-present{background:var(--success);}
    .legend-excused{background:var(--warning);}
    .legend-unexcused{background:var(--danger);}

    /* ========== FORM / TEACHER PANEL ========== */
    .form-group{margin-bottom:.75rem;}
    label{
      display:block;
      font-size:.78rem;
      font-weight:500;
      margin-bottom:.3rem;
      color:var(--gray-700);
    }
    input,select{
      width:100%;
      padding:.55rem .7rem;
      border:1px solid var(--gray-300);
      border-radius:var(--radius-lg);
      font-size:.78rem;
      transition:.2s ease;
      background:var(--white);
    }
    input:focus,select:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 2px rgba(37,99,235,.12);
    }

    .login-card{max-width:360px;margin:0 auto;}
    .teacher-header{
      display:flex;
      flex-wrap:wrap;
      gap:.6rem;
      align-items:center;
      margin-bottom:1rem;
    }
    .teacher-badge{
      background:var(--primary-light);
      color:var(--white);
      padding:.35rem .7rem;
      border-radius:999px;
      font-size:.75rem;
      font-weight:500;
    }

    .grid-2{
      display:grid;
      grid-template-columns:1fr;
      gap:1rem;
    }

    /* alerts */
    .alert{
      padding:.6rem .7rem;
      border-radius:var(--radius-lg);
      margin-bottom:.7rem;
      display:flex;
      align-items:flex-start;
      gap:.55rem;
      font-size:.75rem;
    }
    .alert-icon{font-size:1rem;margin-top:.05rem;}
    .alert-success{
      background:rgba(16,185,129,.08);
      border:1px solid rgba(16,185,129,.25);
      color:var(--success);
    }
    .alert-error{
      background:rgba(239,68,68,.08);
      border:1px solid rgba(239,68,68,.25);
      color:var(--danger);
    }
    .alert-warning{
      background:rgba(245,158,11,.08);
      border:1px solid rgba(245,158,11,.25);
      color:var(--warning);
    }

    /* ========== MODAL (kelmaganlar ro'yxati) ========== */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.5);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
      padding:1rem;
    }
    .modal{
      background:var(--white);
      border-radius:var(--radius-xl);
      max-width:420px;
      width:100%;
      max-height:80vh;
      overflow-y:auto;
      box-shadow:var(--shadow-lg);
      padding:1rem 1.1rem 1rem;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:.6rem;
    }
    .modal-title{font-size:.95rem;font-weight:700;}
    .modal-close{
      border:none;
      background:transparent;
      font-size:1.1rem;
      cursor:pointer;
      color:var(--gray-500);
    }

    /* ========== FULLSCREEN DAVOMAT MODAL ========== */
    .fs-modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.75);
      display:none;
      z-index:60;
      justify-content:center;
      align-items:stretch;
    }
    .fs-modal{
      width:100%;
      max-width:480px;
      margin:0 auto;
      background:var(--gray-50);
      display:flex;
      flex-direction:column;
      padding:0 .75rem 1rem;
    }
    .fs-modal-header-bar{
      padding:.75rem 0 .5rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.75rem;
    }
    .fs-modal-title{
      font-size:.95rem;
      font-weight:700;
      color:var(--gray-800);
      display:flex;
      align-items:center;
      gap:.4rem;
    }
    .fs-modal-close-btn{
      border:none;
      background:var(--gray-100);
      border-radius:999px;
      padding:.35rem .7rem;
      font-size:.8rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:.3rem;
      color:var(--gray-700);
    }
    .fs-modal-close-btn:hover{
      background:var(--gray-200);
    }
    .fs-modal-scroll{
      flex:1;
      overflow-y:auto;
      padding-top:.25rem;
      min-height: 0;
    }

    /* ========== UTILS ========== */
    .hidden{display:none;}
    .text-sm{font-size:.78rem;}
    .text-xs{font-size:.7rem;}
    .font-semibold{font-weight:600;}
    .mt-4{margin-top:1rem;}
    .mb-4{margin-bottom:1rem;}
    .ml-auto{margin-left:auto;}
    .flex{display:flex;}
    .items-center{align-items:center;}
    .justify-between{justify-content:space-between;}
    .gap-4{gap:1rem;}

    /* Mobile tweaks */
    @media (max-width:420px){
      body{font-size:13px;}
      .card-header{padding:.85rem .9rem;}
      .card-body{padding:.9rem;}
      .logo-text h1{font-size:.95rem;}
    }

    /* =================== DESKTOP / PC VERSIYA =================== */
    @media (min-width:768px){
      body{
        font-size:15px;
      }

      .container{
        max-width:960px;
        padding:0 1.5rem 2rem;
      }

      header .header-content{
        padding:1rem 0 .75rem;
      }

      .header-actions{
        justify-content:flex-end;
      }

      .logo-text h1{
        font-size:1.15rem;
      }
      .logo-text p{
        font-size:.8rem;
      }

      /* O'qituvchi paneli chap/ong ustunlarga bo'linadi */
      .grid-2{
        grid-template-columns:1.35fr 1fr;
        gap:1.25rem;
      }

      /* Fullscreen modal PC da haqiqatan "keng" bo'lsin */
      .fs-modal-backdrop{
        align-items:center;
      }
      .fs-modal{
        max-width:960px;
        border-radius:var(--radius-2xl);
        margin:1.5rem auto;
        padding:1rem 1.5rem 1.5rem;
        max-height: 90vh;
      }

      .login-card{
        max-width:420px;
      }
    }

    @media (min-width:1200px){
      .container{
        max-width:1180px;
      }
    }
  </style>
</head>
<body>
<header>
  <div class="container">
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon"><i class="fas fa-school"></i></div>
        <div class="logo-text">
          <h1>Maktab Davomati</h1>
          <p>Namangan shahar 1-imi</p>
        </div>
      </div>
      <button id="open-login-btn" class="btn btn-primary">
        <i class="fas fa-sign-in-alt"></i>
        Davomat berish
      </button>
    </div>
    <div class="header-actions">
      <div class="date-chip">
        <i class="far fa-calendar-alt"></i>
        <span id="today-label">Bugun: …</span>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <!-- Minimal statistikani faqat shu yerga qo'shdik -->
  <section class="card">
    <div class="card-header">
      <div>
        <h2 class="card-title">Sinf rahbari paneli</h2>
        <p class="card-subtitle">Davomatni faqat 07:30 dan 09:00 gacha kiritish mumkin</p>
      </div>
      <a href="stats.html" class="btn btn-ghost btn-sm">
        <i class="fas fa-chart-bar"></i>
        Statistika
      </a>
    </div>
    <div class="card-body">
      <div class="alert alert-success">
        <div class="alert-icon"><i class="fas fa-info-circle"></i></div>
        <div>
          <strong>Diqqat!</strong> Davomatni faqat o'sha kuni 07:30 dan 09:00 gacha kiritish mumkin.
          O'tib ketgan kunlarni tahrirlash mumkin emas.
        </div>
      </div>
      
      <div class="alert alert-warning">
        <div class="alert-icon"><i class="fas fa-exclamation-triangle"></i></div>
        <div>
          <strong>Reyting tizimi:</strong> Sinf rahbarlari reytingi va batafsil statistikani 
          <a href="stats.html" style="color: inherit; text-decoration: underline;">Statistika sahifasida</a> ko'rishingiz mumkin.
        </div>
      </div>
    </div>
  </section>
</main>

<!-- FULLSCREEN MODAL: DAVOMAT BERISH -->
<div id="attendance-modal-backdrop" class="fs-modal-backdrop">
  <div class="fs-modal">
    <div class="fs-modal-header-bar">
      <div class="fs-modal-title">
        <i class="fas fa-clipboard-check"></i> Davomat berish
      </div>
      <button id="attendance-modal-close" class="fs-modal-close-btn">
        <i class="fas fa-times"></i> Yopish
      </button>
    </div>
    <div class="fs-modal-scroll">
      <section class="card">
        <div class="card-header">
          <div>
            <h2 class="card-title">Sinf rahbari paneli</h2>
          </div>
          <button id="toggle-login-card" class="btn btn-ghost btn-sm">
            Kirish
          </button>
        </div>
        <div class="card-body">
          <!-- LOGIN -->
          <div id="login-card" class="hidden login-card">
            <div id="login-alert" class="alert alert-error hidden">
              <div class="alert-icon"><i class="fas fa-exclamation-triangle"></i></div>
              <div id="login-alert-text">
                Login/parol mos kelmadi.
              </div>
            </div>
            <div class="form-group">
              <label for="login-input">Login</label>
              <input id="login-input" type="text" placeholder="">
            </div>
            <div class="form-group">
              <label for="password-input">Parol</label>
              <input id="password-input" type="password" placeholder="••••••">
            </div>
            <button id="login-btn" class="btn btn-primary" style="width:100%;justify-content:center;">
              <i class="fas fa-sign-in-alt"></i> Kirish
            </button>
          </div>

          <!-- TEACHER INNER -->
          <div id="teacher-inner" class="hidden">
            <div class="teacher-header">
              <div class="teacher-badge" id="t-teacher-pill">
                <i class="fas fa-user-tie"></i> Sinf rahbari • …
              </div>
              <div class="form-group" style="min-width:160px;">
                <label for="date-input">Sana</label>
                <input id="date-input" type="date">
              </div>
              <button id="logout-btn" class="btn btn-ghost btn-sm ml-auto">
                <i class="fas fa-sign-out-alt"></i> Chiqish
              </button>
            </div>

            <div id="day-alerts"></div>

            <div class="grid-2">
              <div>
                <h3 class="text-sm font-semibold mb-4" id="class-info-sub">
                  Sinf va o'quvchilar
                </h3>

                <div id="students-empty" class="alert alert-warning">
                  <div class="alert-icon"><i class="fas fa-info-circle"></i></div>
                  <div>Bu sinf uchun o'quvchilar ro'yxati topilmadi.</div>
                </div>

                <div id="students-table-wrap" class="table-container hidden">
                  <table>
                    <thead>
                    <tr>
                      <th>#</th>
                      <th>F.I.Sh.</th>
                      <th>Holat</th>
                    </tr>
                    </thead>
                    <tbody id="students-tbody"></tbody>
                  </table>
                </div>

                <button id="save-btn" class="btn btn-primary mt-4" style="width:100%;justify-content:center;">
                  <i class="fas fa-save"></i> Davomatni saqlash
                </button>
              </div>

              <div>
                <h3 class="text-sm font-semibold mb-4">Sinf statistikasi</h3>

                <div class="stat-card success mb-4">
                  <div class="stat-label">Bugun</div>
                  <div class="stat-value" id="t-today-value">—</div>
                  <div class="stat-detail" id="t-today-detail"></div>
                  <div class="progress-bar progress-multi">
                    <div class="progress-fill seg-present"   id="t-today-bar-p"></div>
                    <div class="progress-fill seg-excused"   id="t-today-bar-e"></div>
                    <div class="progress-fill seg-unexcused" id="t-today-bar-u"></div>
                  </div>
                </div>

                <div class="stats-grid">
                  <div class="stat-card warning">
                    <div class="stat-label">Joriy hafta</div>
                    <div class="stat-value" id="t-week-value">—</div>
                    <div class="stat-detail" id="t-week-detail"></div>
                    <div class="progress-bar progress-multi">
                      <div class="progress-fill seg-present"   id="t-week-bar-p"></div>
                      <div class="progress-fill seg-excused"   id="t-week-bar-e"></div>
                      <div class="progress-fill seg-unexcused" id="t-week-bar-u"></div>
                    </div>
                  </div>
                  <div class="stat-card danger">
                    <div class="stat-label">Joriy oy</div>
                    <div class="stat-value" id="t-month-value">—</div>
                    <div class="stat-detail" id="t-month-detail"></div>
                    <div class="progress-bar progress-multi">
                      <div class="progress-fill seg-present"   id="t-month-bar-p"></div>
                      <div class="progress-fill seg-excused"   id="t-month-bar-e"></div>
                      <div class="progress-fill seg-unexcused" id="t-month-bar-u"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div> <!-- grid-2 -->
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

<script>
  // ============== FIREBASE INIT ==============  
  const firebaseConfig = {
    apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
    authDomain: "xplusy-760fa.firebaseapp.com",
    projectId: "xplusy-760fa",
    storageBucket: "xplusy-760fa.firebasestorage.app",
    messagingSenderId: "992512966017",
    appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
    measurementId: "G-459PLJ7P7L"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const davomatCol = db.collection("davomat");

  // ============== CALENDAR CONFIG (weekend/holiday) ==============
  let calendarConfig = {
    extraSchoolDays: [], // bu sanalarda dars bor (hatto hafta oxiri bo'lsa ham)
    holidays: []         // bu sanalarda ta'til (dars yo'q)
  };

  async function loadCalendarConfig(){
    try{
      const snap = await davomatCol.doc("calendar").get();
      if(snap.exists){
        const data = snap.data() || {};
        calendarConfig.extraSchoolDays = Array.isArray(data.extraSchoolDays) ? data.extraSchoolDays : [];
        calendarConfig.holidays       = Array.isArray(data.holidays)       ? data.holidays       : [];
      }
    }catch(e){
      console.warn("Calendar config o'qishda xato:", e);
      calendarConfig = {extraSchoolDays:[], holidays:[]};
    }
  }

  function isSchoolDay(dateStr){
    if(!dateStr) return false;
    const d = new Date(dateStr);
    if(isNaN(d)) return false;

    // Agar extraSchoolDays ichida bo'lsa - doim o'qish kuni
    if(calendarConfig.extraSchoolDays.includes(dateStr)) return true;
    // Agar ta'til bo'lsa - o'qish yo'q
    if(calendarConfig.holidays.includes(dateStr)) return false;

    const dow = d.getDay(); // 0 yakshanba, 6 shanba
    const isWeekend = (dow === 0 || dow === 6);
    if(isWeekend) return false; // dam olish kuni
    return true;
  }

  function toDateStr(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function formatDateLabel(dateStr){
    const d = new Date(dateStr);
    return d.toLocaleDateString("uz-UZ",{
      weekday:"long",year:"numeric",month:"long",day:"numeric"
    });
  }

  function weekRangeFor(dateStr){
    const d = new Date(dateStr);
    const day = d.getDay(); // 0-yakshanba
    const diffToMon = (day === 0 ? -6 : 1 - day);
    const s = new Date(d);
    s.setDate(d.getDate() + diffToMon);
    const e = new Date(s);
    e.setDate(s.getDate() + 6);
    return {start:toDateStr(s), end:toDateStr(e)};
  }
  function monthRangeFor(dateStr){
    const d = new Date(dateStr);
    const s = new Date(d.getFullYear(), d.getMonth(), 1);
    const e = new Date(d.getFullYear(), d.getMonth()+1, 0);
    return {start:toDateStr(s), end:toDateStr(e)};
  }

  // Bugungi vaqtga qarab qulflash qoidasi
  function getLockInfo(dateStr){
    if(!dateStr) return null;

    const today = new Date();
    const todayStr = toDateStr(today);
    const d = new Date(dateStr);
    if(isNaN(d)) return {
      type: "invalid",
      message: "Sana noto'g'ri."
    };

    const isSchool = isSchoolDay(dateStr);
    const dow = d.getDay(); // 0 yakshanba, 6 shanba
    const isWeekend = (dow === 0 || dow === 6);

    // Ta'til yoki oddiy dam olish kunlari - har doim yopiq
    if(!isSchool){
      if(calendarConfig.holidays.includes(dateStr)){
        return {
          type: "holiday",
          message: "Bu sana ta'til kuni. Bu kunda davomat olinmaydi."
        };
      }
      if(isWeekend){
        return {
          type: "weekend",
          message: "Bu sana dam olish kuni (shanba/yakshanba). Davomat olinmaydi."
        };
      }
    }

    // O'TGAN kunlar: faqat ko'rish, tahrirlash taqiqlanadi
    if(dateStr < todayStr){
      return {
        type: "past",
        message: "O'tib ketgan kunlar uchun davomatni tahrirlash mumkin emas. " +
                 "Davomatni faqat o'sha kuni 07:30-09:00 oralig'ida kiritish mumkin."
      };
    }

    // KELAJAK kunlar: umuman mumkin emas
    if(dateStr > todayStr){
      return {
        type: "future",
        message: "Hali kelmagan (kelajakdagi) kunlar uchun oldindan davomat berib bo'lmaydi."
      };
    }

    // Shu KUN (bugun) - vaqt oynasini tekshiramiz: 07:30-09:00
    const hour = today.getHours();
    const minute = today.getMinutes();

    const beforeWindow = (hour < 7) || (hour === 7 && minute < 30);
    const afterWindow  = (hour > 9) || (hour === 9 && minute >= 0);

    if(beforeWindow){
      return {
        type: "too-early",
        message: "Davomat oynasi 07:30 dan keyin ochiladi. Hozircha kiritib bo'lmaydi."
      };
    }

    if(afterWindow){
      return {
        type: "today-locked",
        message: "Davomatni faqat 07:30 dan 09:00 gacha kiritish mumkin edi. " +
                 "Hozir faqat ko'rish rejimi mavjud."
      };
    }

    // Bugun va vaqt 07:30-09:00 oralig'ida - hammasi OK, tahrirlash mumkin
    return null;
  }

  // stacked bar (yashil/sariq/qizil)
  function setStackedBar(pEl,eEl,uEl,present,excused,unexcused,total){
    const T = total || (present+excused+unexcused);
    if(!T){
      if(pEl) pEl.style.width = "0%";
      if(eEl) eEl.style.width = "0%";
      if(uEl) uEl.style.width = "0%";
      return;
    }
    const pW = Math.round(present*100/T);
    const eW = Math.round(excused*100/T);
    const uW = Math.max(0,100 - pW - eW); // qolganini qizil
    if(pEl) pEl.style.width = pW + "%";
    if(eEl) eEl.style.width = eW + "%";
    if(uEl) uEl.style.width = uW + "%";
  }

  // YANGI: XP hisoblash (7:30 = 90, 7:31 = 89, ..., 8:59 = 1)
  function computeXPFromTimestamp(ts){
    if(!ts || !ts.toDate) return 0;
    const d = ts.toDate();
    const h = d.getHours();
    const m = d.getMinutes();
    const totalMin = h*60 + m;
    const windowStart = 7*60 + 30; // 07:30
    const diff = totalMin - windowStart;
    if(diff < 0 || diff >= 90) return 0; // 90 daqiqa oynadan tashqarida
    return 90 - diff;
  }

  // ============== DOM ==============
  const todayLabel = document.getElementById("today-label");

  const openLoginBtn = document.getElementById("open-login-btn");
  const toggleLoginCardBtn = document.getElementById("toggle-login-card");
  const loginCard = document.getElementById("login-card");
  const loginAlert = document.getElementById("login-alert");
  const loginAlertText = document.getElementById("login-alert-text");
  const loginInput = document.getElementById("login-input");
  const passwordInput = document.getElementById("password-input");
  const loginBtn = document.getElementById("login-btn");
  const teacherInner = document.getElementById("teacher-inner");
  const logoutBtn = document.getElementById("logout-btn");
  const tTeacherPill = document.getElementById("t-teacher-pill");
  const dateInput = document.getElementById("date-input");
  const dayAlerts = document.getElementById("day-alerts");
  const classInfoSub = document.getElementById("class-info-sub");
  const studentsEmpty = document.getElementById("students-empty");
  const studentsTableWrap = document.getElementById("students-table-wrap");
  const studentsTbody = document.getElementById("students-tbody");
  const saveBtn = document.getElementById("save-btn");

  const tTodayValue = document.getElementById("t-today-value");
  const tTodayDetail= document.getElementById("t-today-detail");
  const tTodayBarP  = document.getElementById("t-today-bar-p");
  const tTodayBarE  = document.getElementById("t-today-bar-e");
  const tTodayBarU  = document.getElementById("t-today-bar-u");

  const tWeekValue = document.getElementById("t-week-value");
  const tWeekDetail= document.getElementById("t-week-detail");
  const tWeekBarP  = document.getElementById("t-week-bar-p");
  const tWeekBarE  = document.getElementById("t-week-bar-e");
  const tWeekBarU  = document.getElementById("t-week-bar-u");

  const tMonthValue = document.getElementById("t-month-value");
  const tMonthDetail= document.getElementById("t-month-detail");
  const tMonthBarP  = document.getElementById("t-month-bar-p");
  const tMonthBarE  = document.getElementById("t-month-bar-e");
  const tMonthBarU  = document.getElementById("t-month-bar-u");

  // Fullscreen modal DOM
  const attendanceModalBackdrop = document.getElementById("attendance-modal-backdrop");
  const attendanceModalClose = document.getElementById("attendance-modal-close");

  // sinf.json ma'lumotlari
  let classesJson = [];
  let currentTeacher = null;
  let currentDateStr = null;

  // ============== sinf.json o'qish ==============
  async function loadClassesJson(){
    try{
      const res = await fetch("sinf.json?v=" + Date.now());
      if(!res.ok) throw new Error("sinf.json topilmadi");
      const data = await res.json();
      classesJson = (data && data.classes) ? data.classes : [];
    }catch(e){
      console.warn("sinf.json o'qishda xato:", e.message);
      classesJson = [];
    }
  }

  // ============== LOGIN ==============
  function showLoginError(msg){
    loginAlertText.textContent = msg;
    loginAlert.classList.remove("hidden");
  }
  function clearLoginError(){
    loginAlert.classList.add("hidden");
  }
  function toggleLoginCard(){
    const isHidden = loginCard.classList.contains("hidden");
    if(isHidden){
      loginCard.classList.remove("hidden");
      toggleLoginCardBtn.textContent = "Kirish oynasini yashirish";
    }else{
      loginCard.classList.add("hidden");
      toggleLoginCardBtn.textContent = "Kirish";
    }
  }
  async function handleLogin(){
    clearLoginError();
    const login = loginInput.value.trim();
    const pw = passwordInput.value;
    if(!login || !pw){
      showLoginError("Login va parolni kiriting.");
      return;
    }
    const cls = classesJson.find(
      c => c.teacherLogin===login && c.teacherPassword===pw
    );
    if(!cls){
      showLoginError("Login/parol mos kelmadi yoki sinf.json noto'g'ri.");
      return;
    }
    currentTeacher = {
      login,
      teacherName: cls.teacherName || cls.teacherLogin || login,
      classObj: cls
    };
    localStorage.setItem("davomat_teacher_login", login);
    localStorage.setItem("davomat_teacher_class", cls.id);

    tTeacherPill.innerHTML =
      '<i class="fas fa-user-tie"></i> ' +
      (cls.teacherName || "Sinf rahbari") +
      " • " + (cls.name || cls.id);

    teacherInner.classList.remove("hidden");
    loginCard.classList.add("hidden");
    toggleLoginCardBtn.textContent = "Kirish";

    const today = toDateStr(new Date());
    currentDateStr = today;
    dateInput.value = today;

    await renderDayState();
    await renderStudents();
    await refreshTeacherStats();
  }
  function restoreTeacherSession(){
    const login = localStorage.getItem("davomat_teacher_login");
    const classId = localStorage.getItem("davomat_teacher_class");
    if(!login || !classId) return;
    const cls = classesJson.find(
      c => c.id===classId && c.teacherLogin===login
    );
    if(!cls) return;
    currentTeacher = {
      login,
      teacherName: cls.teacherName || cls.teacherLogin || login,
      classObj: cls
    };
    tTeacherPill.innerHTML =
      '<i class="fas fa-user-tie"></i> ' +
      (cls.teacherName || "Sinf rahbari") +
      " • " + (cls.name || cls.id);
    // modal avtomatik ochilmaydi, faqat tugma bilan
    teacherInner.classList.add("hidden");
    loginCard.classList.remove("hidden");
    toggleLoginCardBtn.textContent = "Kirish oynasini yashirish";
  }
  function logoutTeacher(){
    currentTeacher = null;
    teacherInner.classList.add("hidden");
    loginCard.classList.remove("hidden");
    toggleLoginCardBtn.textContent = "Kirish oynasini yashirish";
    localStorage.removeItem("davomat_teacher_login");
    localStorage.removeItem("davomat_teacher_class");
  }

  // ============== TEACHER: KUN HOLATI ==============
  async function renderDayState(){
    dayAlerts.innerHTML = "";
    if(!currentTeacher || !currentDateStr) return;

    const lock = getLockInfo(currentDateStr);

    if(lock){
      const alertEl = document.createElement("div");
      alertEl.className = (lock.type === "future" || lock.type === "today-locked")
        ? "alert alert-warning"
        : "alert alert-error";
      alertEl.innerHTML =
        '<div class="alert-icon"><i class="fas fa-info-circle"></i></div>' +
        `<div>${lock.message}</div>`;
      dayAlerts.appendChild(alertEl);

      // Qulflangan kunda saqlash tugmasi o'chiriladi
      saveBtn.disabled = true;
      return;
    }

    const cls = currentTeacher.classObj;
    const docId = `${currentDateStr}_${cls.id}`;
    const snap = await davomatCol.doc(docId).get();
    const hasAttendance = snap.exists;

    const alertEl = document.createElement("div");
    alertEl.className = hasAttendance ? "alert alert-success" : "alert alert-error";
    alertEl.innerHTML =
      `<div class="alert-icon">${hasAttendance ? "✅" : "⚠️"}</div>`+
      `<div>${hasAttendance
        ? "Bu sana uchun davomat kiritilgan. Kerak bo'lsa tahrirlashingiz mumkin."
        : "Bu sana uchun davomat hali kiritilmagan."}</div>`;
    dayAlerts.appendChild(alertEl);

    // Ruxsat berilgan kunda saqlash tugmasi ishlaydi
    saveBtn.disabled = false;
  }

  // ============== TEACHER: O'QUVCHILAR JADVALI ==============
  async function renderStudents(){
    if(!currentTeacher || !currentDateStr) return;

    const lock = getLockInfo(currentDateStr);
    const cls = currentTeacher.classObj;
    const students = cls.students || [];

    if(!students.length){
      studentsEmpty.classList.remove("hidden");
      studentsTableWrap.classList.add("hidden");
      classInfoSub.textContent =
        (cls.name || cls.id) + " - o'quvchilar ro'yxati yo'q (sinf.json).";
      return;
    }

    classInfoSub.textContent =
      (cls.name || cls.id) + " - o'quvchilar soni: " + students.length;

    const docId = `${currentDateStr}_${cls.id}`;
    const snap = await davomatCol.doc(docId).get();
    const existingMap = {};
    if(snap.exists){
      (snap.data().students || []).forEach(st=>{
        existingMap[st.id] = st.status;
      });
    }

    studentsTbody.innerHTML = "";
    students.forEach((st,idx)=>{
      const tr = document.createElement("tr");
      const status = existingMap[st.id] || "present";
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${st.fullName || ""}</td>
        <td>
          <select class="status-select" data-student-id="${st.id}">
            <option value="present">Bor</option>
            <option value="excused">Sababli yo'q</option>
            <option value="unexcused">Sababsiz yo'q</option>
          </select>
        </td>
      `;
      studentsTbody.appendChild(tr);
      const sel = tr.querySelector("select");
      sel.value = (status==="absent" ? "unexcused" : status);

      // Agar qulflangan kun bo'lsa - select'larni ham bloklaymiz
      if(lock){
        sel.disabled = true;
      }
    });

    studentsEmpty.classList.add("hidden");
    studentsTableWrap.classList.remove("hidden");
  }

  // ============== TEACHER: SAQLASH ==============
  async function saveAttendance(){
    if(!currentTeacher || !currentDateStr) return;

    const lock = getLockInfo(currentDateStr);
    if(lock){
      alert(lock.message);
      return;
    }

    const cls = currentTeacher.classObj;
    const students = cls.students || [];
    if(!students.length){
      alert("Bu sinf uchun o'quvchilar ro'yxati sinf.json da yo'q.");
      return;
    }

    const rows = studentsTbody.querySelectorAll("tr");
    const resStudents = [];
    let present=0,excused=0,unexcused=0;

    students.forEach((st,idx)=>{
      const row = rows[idx];
      const sel = row.querySelector("select");
      let status = sel.value;
      if(status==="absent") status = "unexcused";
      resStudents.push({id:st.id, fullName:st.fullName, status});
      if(status==="present") present++;
      else if(status==="excused") excused++;
      else unexcused++;
    });

    const total = students.length;
    const docId = `${currentDateStr}_${cls.id}`;

    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saqlanmoqda…';

    try{
      await davomatCol.doc(docId).set({
        date: currentDateStr,
        classId: cls.id,
        className: cls.name || cls.id,
        teacherLogin: currentTeacher.login,
        teacherName: currentTeacher.teacherName,
        students: resStudents,
        stats:{
          total,
          presentCount:present,
          excusedCount:excused,
          unexcusedCount:unexcused,
          absentCount:excused+unexcused
        },
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      },{merge:true});

      await renderDayState();
      await refreshTeacherStats();
      alert("Davomat saqlandi.");
    }catch(e){
      console.error(e);
      alert("Saqlashda xatolik.");
    }finally{
      saveBtn.disabled = false;
      saveBtn.innerHTML = '<i class="fas fa-save"></i> Davomatni saqlash';
    }
  }

  // ============== TEACHER: STATISTIKA ==============
  async function refreshTeacherStats(){
    if(!currentTeacher || !currentDateStr) return;
    const cls = currentTeacher.classObj;

    // Bugun
    const todayDocId = `${currentDateStr}_${cls.id}`;
    const tSnap = await davomatCol.doc(todayDocId).get();
    let p=0,e=0,u=0,t=0;
    if(tSnap.exists){
      const s = tSnap.data().stats || {};
      p = s.presentCount || 0;
      e = s.excusedCount || 0;
      u = (s.unexcusedCount!=null ? s.unexcusedCount : (s.absentCount||0)) - e;
      t = s.total || (p+e+u);
    }
    if(t){
      const percent = Math.round(p*100/t);
      tTodayValue.textContent = percent + "%";
      tTodayDetail.textContent =
        `Bor: ${p}, Sababli: ${e}, Sababsiz: ${Math.max(u,0)}, Jami: ${t}`;
      setStackedBar(tTodayBarP,tTodayBarE,tTodayBarU,p,e,u,t);
    }else{
      tTodayValue.textContent = "-";
      tTodayDetail.textContent = "Bu sana uchun davomat kiritilmagan.";
      setStackedBar(tTodayBarP,tTodayBarE,tTodayBarU,0,0,0,0);
    }

    // Hafta - classId bo'yicha client-side filter
    const wr = weekRangeFor(currentDateStr);
    const wSnap = await davomatCol
      .where("date",">=",wr.start)
      .where("date","<=",wr.end)
      .get();
    let wP=0,wE=0,wU=0,wT=0, wCount=0;
    wSnap.forEach(doc=>{
      const data = doc.data();
      if(data.classId !== cls.id) return;
      const s = data.stats || {};
      const P = s.presentCount || 0;
      const E = s.excusedCount || 0;
      const U = (s.unexcusedCount!=null ? s.unexcusedCount : (s.absentCount||0)) - E;
      const T = s.total || (P+E+U);
      wP+=P; wE+=E; wU+=Math.max(U,0); wT+=T; wCount++;
    });
    if(wT){
      const percent = Math.round(wP*100/wT);
      tWeekValue.textContent = percent + "%";
      tWeekDetail.textContent = `Kunlar soni: ${wCount}`;
      setStackedBar(tWeekBarP,tWeekBarE,tWeekBarU,wP,wE,wU,wT);
    }else{
      tWeekValue.textContent = "-";
      tWeekDetail.textContent = "Hafta bo'yicha davomat yozilmagan.";
      setStackedBar(tWeekBarP,tWeekBarE,tWeekBarU,0,0,0,0);
    }

    // Oy
    const mr = monthRangeFor(currentDateStr);
    const mSnap = await davomatCol
      .where("date",">=",mr.start)
      .where("date","<=",mr.end)
      .get();
    let mP=0,mE=0,mU=0,mT=0, mCount=0;
    mSnap.forEach(doc=>{
      const data = doc.data();
      if(data.classId !== cls.id) return;
      const s = data.stats || {};
      const P = s.presentCount || 0;
      const E = s.excusedCount || 0;
      const U = (s.unexcusedCount!=null ? s.unexcusedCount : (s.absentCount||0)) - E;
      const T = s.total || (P+E+U);
      mP+=P; mE+=E; mU+=Math.max(U,0); mT+=T; mCount++;
    });
    if(mT){
      const percent = Math.round(mP*100/mT);
      tMonthValue.textContent = percent + "%";
      tMonthDetail.textContent = `Kunlar soni: ${mCount}`;
      setStackedBar(tMonthBarP,tMonthBarE,tMonthBarU,mP,mE,mU,mT);
    }else{
      tMonthValue.textContent = "-";
      tMonthDetail.textContent = "Oy bo'yicha davomat yozilmagan.";
      setStackedBar(tMonthBarP,tMonthBarE,tMonthBarU,0,0,0,0);
    }
  }

  // ============== INIT ==============
  document.addEventListener("DOMContentLoaded", async ()=>{
    const todayStr = toDateStr(new Date());
    todayLabel.textContent = "Bugun: " + formatDateLabel(todayStr);

    await loadClassesJson();
    await loadCalendarConfig();
    restoreTeacherSession();

    // headerdagi Davomat berish tugmasi: full screen modal
    openLoginBtn.addEventListener("click", ()=>{
      attendanceModalBackdrop.style.display = "flex";
      // sessiya yo'q bo'lsa login ko'rinsin
      if(!currentTeacher){
        loginCard.classList.remove("hidden");
        teacherInner.classList.add("hidden");
        toggleLoginCardBtn.textContent = "Kirish oynasini yashirish";
      }else{
        // sessiya bo'lsa, o'qituvchi paneli
        teacherInner.classList.remove("hidden");
        loginCard.classList.add("hidden");
        toggleLoginCardBtn.textContent = "Kirish";
        if(!currentDateStr){
          currentDateStr = todayStr;
          dateInput.value = todayStr;
        }
        renderDayState();
        renderStudents();
        refreshTeacherStats();
      }
    });

    attendanceModalClose.addEventListener("click", ()=>{
      attendanceModalBackdrop.style.display = "none";
    });
    attendanceModalBackdrop.addEventListener("click", (e)=>{
      if(e.target === attendanceModalBackdrop){
        attendanceModalBackdrop.style.display = "none";
      }
    });

    toggleLoginCardBtn.addEventListener("click", toggleLoginCard);
    loginBtn.addEventListener("click", handleLogin);
    passwordInput.addEventListener("keydown", e=>{
      if(e.key==="Enter") handleLogin();
    });
    logoutBtn.addEventListener("click", logoutTeacher);

    // sana
    dateInput.addEventListener("change", async ()=>{
      if(!dateInput.value) return;
      currentDateStr = dateInput.value;
      await renderDayState();
      await renderStudents();
      await refreshTeacherStats();
    });

    // saqlash
    saveBtn.addEventListener("click", saveAttendance);
  });
</script>
</body>
</html>