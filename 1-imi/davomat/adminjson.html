<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <title>Maktab Davomati — Sinflar Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root{
      --primary:#2563eb;
      --primary-dark:#1d4ed8;
      --primary-soft:#dbeafe;
      --bg:#f3f4f6;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#111827;
      --muted:#6b7280;
      --danger:#ef4444;
      --radius:14px;
      --shadow:0 12px 30px rgba(15,23,42,.12);
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:radial-gradient(circle at top,#e0f2fe,#f9fafb 45%,#eef2ff);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    .app-shell{
      max-width:1200px;
      margin:16px auto;
      padding:16px;
      border-radius:24px;
      background:rgba(255,255,255,0.86);
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:4px 4px 12px;
      border-bottom:1px solid var(--border);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-badge{
      width:36px;
      height:36px;
      border-radius:16px;
      background:linear-gradient(135deg,var(--primary),var(--primary-dark));
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:700;
      font-size:18px;
      box-shadow:0 10px 20px rgba(37,99,235,.45);
    }
    .brand-text span{
      display:block;
      font-size:13px;
      color:var(--muted);
    }
    .brand-text strong{
      font-size:16px;
    }

    .header-actions{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      padding:6px 10px;
      border-radius:999px;
      background:var(--primary-soft);
      font-size:12px;
      color:var(--primary-dark);
      display:flex;
      align-items:center;
      gap:6px;
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:7px 12px;
      font-size:13px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:#e5e7eb;
      color:var(--text);
      transition:.15s ease;
    }
    .btn-primary{
      background:var(--primary);
      color:#fff;
    }
    .btn-primary:hover{
      background:var(--primary-dark);
      transform:translateY(-1px);
      box-shadow:0 8px 18px rgba(37,99,235,.4);
    }
    .btn-ghost{
      background:transparent;
    }
    .btn-ghost:hover{
      background:rgba(15,23,42,.05);
    }
    .btn-danger{
      background:rgba(248,113,113,.12);
      color:var(--danger);
    }
    .btn-danger:hover{
      background:rgba(248,113,113,.2);
    }

    .layout{
      display:grid;
      grid-template-columns:260px minmax(0,1fr);
      gap:14px;
    }
    @media(max-width:900px){
      .layout{
        grid-template-columns:1fr;
      }
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid rgba(148,163,184,.35);
      padding:12px;
      box-shadow:0 6px 16px rgba(15,23,42,.08);
    }

    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
    }
    .card-header h2{
      font-size:14px;
      margin:0;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .card-header small{
      font-size:11px;
      color:var(--muted);
    }

    .class-list{
      display:flex;
      flex-direction:column;
      gap:4px;
      max-height:420px;
      overflow:auto;
      padding-right:4px;
    }

    .class-item{
      border-radius:12px;
      padding:8px 10px;
      border:1px solid transparent;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      cursor:pointer;
      font-size:13px;
    }
    .class-item span{
      display:block;
    }
    .class-item small{
      font-size:11px;
      color:var(--muted);
    }
    .class-item:hover{
      background:var(--primary-soft);
    }
    .class-item.active{
      background:var(--primary);
      color:#fff;
      border-color:var(--primary-dark);
    }
    .class-item.active small{
      color:rgba(239,246,255,.9);
    }

    .badge{
      border-radius:999px;
      font-size:11px;
      padding:2px 8px;
      background:rgba(15,23,42,.06);
      color:var(--muted);
      white-space:nowrap;
    }
    .badge-pill{
      border-radius:999px;
    }

    .editor-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
      margin-bottom:10px;
    }
    @media(max-width:700px){
      .editor-grid{
        grid-template-columns:1fr;
      }
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:13px;
    }
    .field label{
      font-size:12px;
      color:var(--muted);
    }
    .field input{
      border-radius:999px;
      border:1px solid var(--border);
      padding:6px 10px;
      font-size:13px;
      outline:none;
      background:#f9fafb;
    }
    .field input:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 1px rgba(37,99,235,.3);
      background:#fff;
    }

    .chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-top:4px;
    }

    .students-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin:4px 0 6px;
    }
    .students-header h3{
      font-size:13px;
      margin:0;
      color:var(--muted);
    }

    .table-wrap{
      border-radius:12px;
      border:1px solid var(--border);
      overflow:hidden;
      background:#f9fafb;
      max-height:360px;
      overflow:auto;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    thead{
      background:#e5e7eb;
      position:sticky;
      top:0;
      z-index:1;
    }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid #e5e7eb;
      text-align:left;
    }
    th{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.04em;
      color:#4b5563;
    }
    tbody tr:nth-child(even){
      background:#f3f4f6;
    }
    tbody tr:hover{
      background:#e0f2fe;
    }

    .student-input{
      width:100%;
      border-radius:999px;
      border:1px solid #d1d5db;
      padding:4px 8px;
      font-size:13px;
      outline:none;
    }
    .student-input:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 1px rgba(37,99,235,.25);
      background:#fff;
    }

    .empty-state{
      padding:20px;
      text-align:center;
      font-size:13px;
      color:var(--muted);
    }

    .footer-note{
      text-align:right;
      font-size:11px;
      color:var(--muted);
      margin-top:2px;
    }

    .status-bar{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    .status-ok{
      color:#16a34a;
    }
    .status-error{
      color:#dc2626;
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header class="app-header">
    <div class="brand">
      <div class="brand-badge">S</div>
      <div class="brand-text">
        <strong>Sinf boshqaruvi admin</strong>
        <span>sinf.json bilan ishlaydi (lokal fayl)</span>
      </div>
    </div>
    <div class="header-actions">
      <div class="pill">
        <i class="fa-solid fa-circle-info"></i>
        <span>Avval sinf.json shu papkada bo‘lsin</span>
      </div>
      <button id="reloadBtn" class="btn btn-ghost">
        <i class="fa-solid fa-rotate"></i> Qayta yuklash
      </button>
      <button id="downloadBtn" class="btn btn-primary">
        <i class="fa-solid fa-download"></i> sinf.json yuklab olish
      </button>
    </div>
  </header>

  <div class="layout">
    <!-- Sidebar: class list -->
    <aside class="card">
      <div class="card-header">
        <div>
          <h2><i class="fa-solid fa-layer-group"></i> Sinflar ro‘yxati</h2>
          <small>Birini bosib, o‘sha sinfni tahrirlaysiz</small>
        </div>
        <span class="badge" id="classCountBadge">0 ta sinf</span>
      </div>
      <div class="class-list" id="classList"></div>
    </aside>

    <!-- Main editor -->
    <main class="card">
      <div class="card-header">
        <div>
          <h2>
            <i class="fa-solid fa-pen-to-square"></i>
            <span id="editorTitle">Sinf tanlanmagan</span>
          </h2>
          <small id="editorSubtitle">Chapdan sinfni tanlang</small>
        </div>
        <div class="chip-row">
          <span class="badge" id="studentsCountBadge">0 o‘quvchi</span>
          <span class="badge" id="classIdBadge">ID: —</span>
        </div>
      </div>

      <div id="editorBody" style="display:none;">
        <div class="editor-grid">
          <div class="field">
            <label>Sinf ID (o‘zgarmaydi)</label>
            <input type="text" id="fieldId" readonly>
          </div>
          <div class="field">
            <label>Sinf nomi (masalan, 7-01)</label>
            <input type="text" id="fieldName">
          </div>
          <div class="field">
            <label>Login</label>
            <input type="text" id="fieldLogin">
          </div>
          <div class="field">
            <label>Parol</label>
            <input type="text" id="fieldPassword">
          </div>
          <div class="field" style="grid-column:1/-1;">
            <label>Sinf rahbari F.I.Sh.</label>
            <input type="text" id="fieldTeacherName" placeholder="Masalan: Sattorov Sohibjon">
          </div>
        </div>

        <div class="students-header">
          <h3>O‘quvchilar ro‘yxati</h3>
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <button id="addStudentBtn" class="btn btn-primary btn-sm">
              <i class="fa-solid fa-user-plus"></i> O‘quvchi qo‘shish
            </button>
            <button id="saveClassBtn" class="btn">
              <i class="fa-solid fa-floppy-disk"></i> Bu sinfni saqlash
            </button>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
            <tr>
              <th style="width:70px;">ID</th>
              <th>O‘quvchi F.I.Sh.</th>
              <th style="width:60px;text-align:center;">O‘chirish</th>
            </tr>
            </thead>
            <tbody id="studentsTbody">
            <!-- rows generated by JS -->
            </tbody>
          </table>
        </div>

        <div class="status-bar" id="statusBar"></div>
        <div class="footer-note">
          Eslatma: “sinf.json yuklab olish” tugmasi — <b>HAMMA sinflar</b> bilan yangilangan faylni beradi.
        </div>
      </div>

      <div id="emptyEditor" class="empty-state">
        <i class="fa-regular fa-circle-question"></i><br>
        Hali sinf tanlanmadi. Chapdagi ro‘yxatdan sinfni bosing.
      </div>
    </main>
  </div>
</div>

<script>
  let sinfData = { classes: [] };
  let currentIndex = null;

  const classListEl = document.getElementById('classList');
  const classCountBadge = document.getElementById('classCountBadge');
  const editorTitle = document.getElementById('editorTitle');
  const editorSubtitle = document.getElementById('editorSubtitle');
  const studentsCountBadge = document.getElementById('studentsCountBadge');
  const classIdBadge = document.getElementById('classIdBadge');
  const editorBody = document.getElementById('editorBody');
  const emptyEditor = document.getElementById('emptyEditor');
  const statusBar = document.getElementById('statusBar');

  const fieldId = document.getElementById('fieldId');
  const fieldName = document.getElementById('fieldName');
  const fieldLogin = document.getElementById('fieldLogin');
  const fieldPassword = document.getElementById('fieldPassword');
  const fieldTeacherName = document.getElementById('fieldTeacherName');
  const studentsTbody = document.getElementById('studentsTbody');

  const reloadBtn = document.getElementById('reloadBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const addStudentBtn = document.getElementById('addStudentBtn');
  const saveClassBtn = document.getElementById('saveClassBtn');

  async function loadSinfJson() {
    setStatus('sinf.json yuklanmoqda...', 'info');
    try {
      const res = await fetch('sinf.json?cache=' + Date.now());
      if (!res.ok) throw new Error('HTTP ' + res.status);
      sinfData = await res.json();
      if (!Array.isArray(sinfData.classes)) {
        throw new Error('"classes" massiv topilmadi');
      }
      renderClassList();
      setStatus('sinf.json muvaffaqiyatli yuklandi.', 'ok');
    } catch (e) {
      console.error(e);
      sinfData = { classes: [] };
      renderClassList();
      setStatus('sinf.json yuklab bo‘lmadi: ' + e.message, 'error');
    }
  }

  function renderClassList() {
    classListEl.innerHTML = '';
    currentIndex = null;
    editorBody.style.display = 'none';
    emptyEditor.style.display = 'block';
    editorTitle.textContent = 'Sinf tanlanmagan';
    editorSubtitle.textContent = 'Chapdan sinfni tanlang';
    studentsCountBadge.textContent = '0 o‘quvchi';
    classIdBadge.textContent = 'ID: —';

    const classes = sinfData.classes || [];
    classCountBadge.textContent = classes.length + ' ta sinf';

    if (!classes.length) {
      classListEl.innerHTML = '<div class="empty-state" style="padding:10px;font-size:12px;">sinf.json bo‘sh yoki topilmadi</div>';
      return;
    }

    classes.forEach((cls, idx) => {
      const div = document.createElement('div');
      div.className = 'class-item';
      if (idx === currentIndex) div.classList.add('active');

      const left = document.createElement('div');
      const spanId = document.createElement('span');
      spanId.textContent = cls.name || cls.id || 'Noma’lum';
      const spanTeacher = document.createElement('small');
      spanTeacher.textContent = cls.teacherName ? cls.teacherName : 'Rahbar: aniqlanmagan';
      left.appendChild(spanId);
      left.appendChild(spanTeacher);

      const badge = document.createElement('span');
      badge.className = 'badge';
      const count = Array.isArray(cls.students) ? cls.students.length : 0;
      badge.textContent = count + ' o‘quvchi';

      div.appendChild(left);
      div.appendChild(badge);

      div.addEventListener('click', () => {
        currentIndex = idx;
        document.querySelectorAll('.class-item').forEach(el => el.classList.remove('active'));
        div.classList.add('active');
        openClassEditor();
      });

      classListEl.appendChild(div);
    });
  }

  function openClassEditor() {
    const cls = sinfData.classes[currentIndex];
    if (!cls) return;

    editorBody.style.display = 'block';
    emptyEditor.style.display = 'none';

    fieldId.value = cls.id || '';
    fieldName.value = cls.name || '';
    fieldLogin.value = cls.teacherLogin || '';
    fieldPassword.value = cls.teacherPassword || '';
    fieldTeacherName.value = cls.teacherName || '';

    const count = Array.isArray(cls.students) ? cls.students.length : 0;

    editorTitle.textContent = 'Sinf: ' + (cls.name || cls.id);
    editorSubtitle.textContent = 'Rahbar: ' + (cls.teacherName || 'aniqlanmagan');
    studentsCountBadge.textContent = count + ' o‘quvchi';
    classIdBadge.textContent = 'ID: ' + (cls.id || '—');

    renderStudentsTable();
    setStatus('Sinf yuklandi. Tahrir qilishingiz mumkin.', 'info');
  }

  function renderStudentsTable() {
    const cls = sinfData.classes[currentIndex];
    const students = cls.students || [];
    studentsTbody.innerHTML = '';

    if (!students.length) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 3;
      td.style.textAlign = 'center';
      td.style.color = '#6b7280';
      td.textContent = 'Hali o‘quvchi kiritilmagan.';
      tr.appendChild(td);
      studentsTbody.appendChild(tr);
      return;
    }

    students.forEach((st, idx) => {
      const tr = document.createElement('tr');

      const tdId = document.createElement('td');
      tdId.textContent = st.id || ('st' + (idx + 1));
      tr.appendChild(tdId);

      const tdName = document.createElement('td');
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'student-input';
      input.value = st.fullName || '';
      input.addEventListener('change', () => {
        st.fullName = input.value;
      });
      tdName.appendChild(input);
      tr.appendChild(tdName);

      const tdActions = document.createElement('td');
      tdActions.style.textAlign = 'center';
      const btnDel = document.createElement('button');
      btnDel.className = 'btn btn-danger';
      btnDel.style.padding = '3px 8px';
      btnDel.innerHTML = '<i class="fa-solid fa-trash"></i>';
      btnDel.addEventListener('click', () => deleteStudent(idx));
      tdActions.appendChild(btnDel);
      tr.appendChild(tdActions);

      studentsTbody.appendChild(tr);
    });
  }

  function deleteStudent(idx) {
    if (currentIndex === null) return;
    const cls = sinfData.classes[currentIndex];
    if (!cls || !Array.isArray(cls.students)) return;
    if (!confirm('Bu o‘quvchini o‘chirishni xohlaysizmi?')) return;
    cls.students.splice(idx, 1);
    renderStudentsTable();
    studentsCountBadge.textContent = cls.students.length + ' o‘quvchi';
    setStatus('O‘quvchi o‘chirildi.', 'ok');
  }

  function addStudent() {
    if (currentIndex === null) return;
    const cls = sinfData.classes[currentIndex];
    if (!Array.isArray(cls.students)) cls.students = [];
    const nextIdNum = cls.students.length + 1;
    const newId = 'st' + nextIdNum;
    cls.students.push({ id: newId, fullName: '' });
    renderStudentsTable();
    studentsCountBadge.textContent = cls.students.length + ' o‘quvchi';
    setStatus('Yangi o‘quvchi qatori qo‘shildi. Ismini kiriting.', 'info');
  }

  function saveCurrentClass() {
    if (currentIndex === null) return;
    const cls = sinfData.classes[currentIndex];

    cls.name = fieldName.value.trim() || cls.id;
    cls.teacherLogin = fieldLogin.value.trim();
    cls.teacherPassword = fieldPassword.value.trim();
    cls.teacherName = fieldTeacherName.value.trim();

    // inputlarda turgan o‘zgarishlar allaqachon students massivida bor

    // sidebarni qayta chizamiz
    renderClassList();
    // tanlangan sinfni qayta aktiv qilamiz
    currentIndex = sinfData.classes.findIndex(c => c.id === cls.id);
    if (currentIndex !== -1) {
      const items = document.querySelectorAll('.class-item');
      if (items[currentIndex]) items[currentIndex].classList.add('active');
    }
    openClassEditor();
    setStatus('Sinf ma’lumotlari yangilandi (xotirada). Faylga tushirish uchun "sinf.json yuklab olish".', 'ok');
  }

  function downloadJson() {
    const blob = new Blob([JSON.stringify(sinfData, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sinf.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    setStatus('Yangi sinf.json yuklab olindi. Uni serverga/Firebasega joylashtiring.', 'ok');
  }

  function setStatus(text, type){
    statusBar.textContent = text;
    statusBar.classList.remove('status-ok','status-error');
    if(type === 'ok') statusBar.classList.add('status-ok');
    else if(type === 'error') statusBar.classList.add('status-error');
  }

  // Event listeners
  reloadBtn.addEventListener('click', loadSinfJson);
  downloadBtn.addEventListener('click', downloadJson);
  addStudentBtn.addEventListener('click', addStudent);
  saveClassBtn.addEventListener('click', saveCurrentClass);

  // Start
  loadSinfJson();
</script>
</body>
</html>
