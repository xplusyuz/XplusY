<!doctype html>
<html lang="uz">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Home Admin — sections & stories</title>
<link rel="icon" href="./logo.png">
<style>
  :root{--frame:#e5e7eb;--card:#fff;--bg:#f8fafc;--text:#0f172a}
  body{margin:0;background:var(--bg);color:var(--text);font:14px system-ui,Segoe UI,Roboto}
  .wrap{max-width:1100px;margin:auto;padding:16px;display:flex;flex-direction:column;gap:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid var(--frame);background:var(--card);border-radius:10px;padding:8px 12px;cursor:pointer}
  .sec{background:var(--card);border:1px solid var(--frame);border-radius:14px;padding:12px}
  .sec-head{display:flex;align-items:center;gap:8px;justify-content:space-between}
  .in{padding:8px 10px;border:1px solid var(--frame);border-radius:8px}
  .grid{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr;gap:8px}
  .card{border:1px dashed var(--frame);border-radius:10px;padding:8px;display:flex;flex-direction:column;gap:6px}
  .card img{width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:8px;background:#eef2f7}
  .muted{opacity:.7}
  .title{font-weight:800}
  textarea.in{min-height:120px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <button class="btn" id="newSec">+ Bo‘lim qo‘shish</button>
      <button class="btn" id="openJSON">JSON ochish</button>
      <input type="file" id="jsonFile" accept="application/json" hidden>
      <input class="in" id="jsonUrl" placeholder="https://.../home.json" style="flex:1 1 260px">
      <button class="btn" id="loadUrl">URL dan yuklash</button>
      <div style="flex:1"></div>
      <button class="btn" id="copyJSON">JSON ni nusxalash</button>
      <button class="btn" id="downloadJSON">home.json yuklab olish</button>
    </div>

    <div class="sec">
      <div class="row">
        <div class="title">Umumiy</div>
        <input class="in" id="updatedAt" style="flex:1" placeholder="updatedAt (ISO)">
        <button class="btn" id="nowBtn">Hozir</button>
      </div>
    </div>

    <div id="list" class="wrap" style="padding:0"></div>
  </div>

<script>
  const $ = s=>document.querySelector(s);
  const list = $('#list');
  let model = { updatedAt: new Date().toISOString(), sections: [] };

  function render(){
    $('#updatedAt').value = model.updatedAt||'';
    list.innerHTML = '';
    model.sections.forEach((sec, si)=>{
      const box = document.createElement('section');
      box.className = 'sec';
      box.innerHTML = `
        <div class="sec-head">
          <div class="row">
            <input class="in" placeholder="Bo‘lim ID" value="${sec.id||''}" data-k="id" style="width:160px">
            <input class="in" placeholder="Sarlavha" value="${sec.title||''}" data-k="title" style="width:220px">
            <select class="in" data-k="ratio">
              <option ${sec.ratio==='16:9'?'selected':''}>16:9</option>
              <option ${sec.ratio==='4:3'?'selected':''}>4:3</option>
              <option ${sec.ratio==='1:1'?'selected':''}>1:1</option>
            </select>
            <input class="in" placeholder="autoplayMs (ms)" value="${sec.autoplayMs||''}" data-k="autoplayMs" style="width:140px">
          </div>
          <div class="row">
            <button class="btn" data-act="addItem">+ Banner</button>
            <button class="btn" data-act="up">↑</button>
            <button class="btn" data-act="down">↓</button>
            <button class="btn" data-act="del" style="color:#ef4444">O‘chirish</button>
          </div>
        </div>
        <div class="grid"></div>
      `;
      list.appendChild(box);

      // update header fields
      box.querySelectorAll('[data-k]').forEach(inp=>{
        inp.oninput = (e)=>{
          const k = e.target.getAttribute('data-k');
          let v = e.target.value;
          if(k==='autoplayMs' && v) v = Number(v)||0;
          model.sections[si][k] = v;
          persist();
        };
      });

      // items grid
      const grid = box.querySelector('.grid');
      (sec.items||[]).forEach((it, ii)=>{
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <img src="${it.img||''}" alt="">
          <input class="in" placeholder="Banner ID" value="${it.id||''}" data-k="id">
          <input class="in" placeholder="Sarlavha" value="${it.title||''}" data-k="title">
          <input class="in" placeholder="Past sarlavha (ixtiyoriy)" value="${it.subtitle||''}" data-k="subtitle">
          <input class="in" placeholder="Rasm URL" value="${it.img||''}" data-k="img">
          <div class="row">
            <input type="file" accept="image/*" data-k="file">
            <span class="muted">yoki URL kiriting</span>
          </div>
          <input class="in" placeholder="Link (http..., yoki ?id=chip)" value="${it.link||''}" data-k="link">
          <div class="row">
            <input class="in" placeholder="Badge" value="${it.badge||''}" data-k="badge" style="width:160px">
            <input class="in" placeholder="Badge rang (#22c55e)" value="${it.badgeColor||''}" data-k="badgeColor" style="width:160px">
            <input class="in" placeholder="Until (ISO, ixtiyoriy)" value="${it.until||''}" data-k="until" style="width:200px">
          </div>
          <div class="row">
            <button class="btn" data-act="itemUp">↑</button>
            <button class="btn" data-act="itemDown">↓</button>
            <button class="btn" data-act="itemDel" style="color:#ef4444">O‘chirish</button>
          </div>
        `;
        grid.appendChild(card);

        // bindings
        card.querySelectorAll('[data-k]').forEach(inp=>{
          if(inp.type==='file'){
            inp.onchange = async (e)=>{
              const f = e.target.files?.[0]; if(!f) return;
              const url = await readAsDataURL(f);
              model.sections[si].items[ii].img = url;
              card.querySelector('img').src = url;
              card.querySelector('[data-k="img"]').value = url;
              persist();
            };
          }else{
            inp.oninput = (e)=>{
              const k = e.target.getAttribute('data-k');
              model.sections[si].items[ii][k] = e.target.value;
              if(k==='img') card.querySelector('img').src = e.target.value||'';
              persist();
            };
          }
        });

        // actions
        card.querySelector('[data-act="itemDel"]').onclick = ()=>{
          model.sections[si].items.splice(ii,1); render(); persist();
        };
        card.querySelector('[data-act="itemUp"]').onclick = ()=>{
          if(ii>0){ const arr=model.sections[si].items; [arr[ii-1],arr[ii]]=[arr[ii],arr[ii-1]]; render(); persist(); }
        };
        card.querySelector('[data-act="itemDown"]').onclick = ()=>{
          const arr=model.sections[si].items; if(ii<arr.length-1){ [arr[ii+1],arr[ii]]=[arr[ii],arr[ii+1]]; render(); persist(); }
        };
      });

      // section actions
      box.querySelector('[data-act="addItem"]').onclick = ()=>{
        sec.items = sec.items||[];
        sec.items.push({id:`${sec.id||'sec'}_${(sec.items.length+1)}`, title:'Yangi banner', img:'', link:''});
        render(); persist();
      };
      box.querySelector('[data-act="del"]').onclick = ()=>{
        model.sections.splice(si,1); render(); persist();
      };
      box.querySelector('[data-act="up"]').onclick = ()=>{
        if(si>0){ [model.sections[si-1],model.sections[si]]=[model.sections[si],model.sections[si-1]]; render(); persist(); }
      };
      box.querySelector('[data-act="down"]').onclick = ()=>{
        if(si<model.sections.length-1){ [model.sections[si+1],model.sections[si]]=[model.sections[si],model.sections[si+1]]; render(); persist(); }
      };
    });
  }

  // helpers
  function persist(){ localStorage.setItem('home-admin', JSON.stringify(model)); }
  function loadPersist(){ try{ const m=JSON.parse(localStorage.getItem('home-admin')||'null'); if(m) model=m; }catch{} }
  function readAsDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }
  function download(name, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'application/json'})); a.download=name; a.click(); URL.revokeObjectURL(a.href); }

  // toolbar
  $('#newSec').onclick = ()=>{ model.sections.push({id:`sec_${model.sections.length+1}`, title:'Yangi bo‘lim', ratio:'16:9', autoplayMs:3500, items:[]}); render(); persist(); };
  $('#openJSON').onclick = ()=> $('#jsonFile').click();
  $('#jsonFile').onchange = async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const txt = await f.text(); model = JSON.parse(txt); render(); persist();
  };
  $('#loadUrl').onclick = async ()=>{
    const url = $('#jsonUrl').value.trim(); if(!url) return;
    try{ const m = await fetch(url,{cache:'no-store'}).then(r=>r.json()); model = m; render(); persist(); }
    catch(e){ alert('Yuklab bo‘lmadi: '+e.message); }
  };
  $('#copyJSON').onclick = async ()=>{
    model.updatedAt = new Date().toISOString();
    await navigator.clipboard.writeText(JSON.stringify(model, null, 2));
    alert('JSON nusxalandi!');
  };
  $('#downloadJSON').onclick = ()=>{
    model.updatedAt = new Date().toISOString();
    download('home.json', JSON.stringify(model, null, 2));
  };
  $('#nowBtn').onclick = ()=>{
    model.updatedAt = new Date().toISOString(); $('#updatedAt').value = model.updatedAt; persist();
  };
  $('#updatedAt').oninput = (e)=>{ model.updatedAt = e.target.value; persist(); };

  // init
  loadPersist(); render();
</script>
</body>
</html>
