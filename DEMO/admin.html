<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LeaderMath ‚Äî Admin (Pro) ‚Ä¢ JSON Chip Editor</title>
  <meta name="theme-color" content="#2E8B57">
  <link rel="icon" href="./favicon.png">
  <style>
    :root{
      --brand:#2E8B57;--brand2:#1F6B45;--bg:#f6faf8;--text:#0f172a;--muted:#5b7a6a;
      --card:#fff;--frame:#d8e7dd;--ring:#8ad1b1;--danger:#d83a3a;--ok:#1F6B45;--warn:#c97c1a;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto}

    /* ===== Topbar ===== */
    header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.8);backdrop-filter:blur(12px) saturate(1.1);border-bottom:1px solid var(--frame)}
    .bar{max-width:1200px;margin:0 auto;padding:10px 14px;display:flex;align-items:center;gap:12px}
    .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;display:grid;place-items:center;font-weight:900}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-left:auto}
    .btn{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--frame);background:#fff;cursor:pointer;padding:8px 12px;border-radius:10px;transition:.15s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(0,0,0,.08)}
    .btn.pri{background:linear-gradient(135deg,#f3fbf7,#e7f9f0);border-color:var(--ring)}
    .btn.warn{background:#fff8eb;border-color:#ffe3b6;color:#7a4b00}
    .btn.danger{background:#fff0f0;border-color:#ffd5d5;color:#a30000}
    .btn:active{transform:scale(.98)}
    .counter{font-size:12px;color:var(--muted)}
    .dot{display:inline-block;width:8px;height:8px;border-radius:999px;background:#9aa6b2;margin-left:6px}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.dirty{background:#0077ff}

    /* ===== Layout ===== */
    main{max-width:1200px;margin:16px auto;padding:0 14px;display:grid;grid-template-columns:340px 1fr;gap:16px}
    @media (max-width:1024px){ main{grid-template-columns:1fr} }

    .panel{background:var(--card);border:1px solid var(--frame);border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.06);min-height:200px}
    .panel-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--frame)}
    .panel-body{padding:12px 14px}

    /* ===== Left list ===== */
    .search{width:100%;padding:9px 12px;border:1px solid var(--frame);border-radius:12px;margin-bottom:10px}
    .list{display:flex;flex-direction:column;gap:8px;max-height:70vh;overflow:auto}
    .item{display:grid;grid-template-columns:26px 30px 1fr auto;align-items:center;gap:8px;border:1px solid var(--frame);padding:8px;border-radius:12px;background:#fafdfb}
    .item[draggable="true"]{cursor:grab}
    .drag{user-select:none;opacity:.6}
    .meta{font-size:12px;color:var(--muted)}
    .item.active{outline:2px solid var(--ring);background:#f2fbf7}
    .tag{font-size:11px;padding:2px 6px;border-radius:999px;background:#eff9f4;border:1px solid var(--frame);margin-left:6px}
    .iconthumb{width:24px;height:24px;display:grid;place-items:center}
    .iconthumb img{max-width:24px;max-height:24px;display:block}

    /* ===== Right editor ===== */
    .editor-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:1000px){ .editor-grid{grid-template-columns:1fr} }
    .field{display:flex;flex-direction:column;gap:6px}
    .field input,.field textarea{padding:10px 12px;border:1px solid var(--frame);border-radius:12px;font:inherit}
    textarea.code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;min-height:320px}
    .hint{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .right{margin-left:auto}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#eff9f4;border:1px solid var(--frame)}

    /* Sticky sub-toolbar under editor head */
    .subbar{position:sticky;top:64px;z-index:5;background:rgba(255,255,255,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--frame);padding:8px 14px;display:flex;gap:8px;align-items:center}

    /* Preview + JSON */
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:1000px){ .split{grid-template-columns:1fr} }
    iframe.preview{width:100%;height:360px;border:1px solid var(--frame);border-radius:12px}
    pre.json{margin:0;border:1px solid var(--frame);border-radius:12px;padding:10px;overflow:auto;background:#fbfdfc;max-height:360px}

    /* Validation states */
    .invalid{border-color:var(--danger)!important; outline:1px solid var(--danger)!important}
    .warn-txt{color:var(--warn)} .ok-txt{color:var(--ok)} .danger-txt{color:var(--danger)}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="logo">L</div>
      <div>
        <div style="font-weight:800">LeaderMath ‚Äî Admin (Pro)</div>
        <div class="counter"><span id="count">0</span> ta chip ‚Ä¢ schema <span id="schema">2</span> <span id="saveDot" class="dot"></span></div>
      </div>
      <div class="toolbar">
        <button class="btn pri" id="new" title="Yangi (Ctrl+Alt+N)">‚ûï Yangi</button>
        <button class="btn" id="dup" title="Nusxa (Ctrl+D)">üìÑ Nusxa</button>
        <button class="btn warn" id="up" title="Yuqoriga (Alt+‚Üë)">‚¨ÜÔ∏è</button>
        <button class="btn warn" id="down" title="Pastga (Alt+‚Üì)">‚¨áÔ∏è</button>
        <button class="btn danger" id="del" title="O‚Äòchirish (Del)">üóëÔ∏è O'chirish</button>
        <button class="btn" id="import" title="Import JSON">üì• Import</button>
        <button class="btn pri" id="export" title="Export admin.json (Ctrl/‚åò+S)">üì§ Export</button>
      </div>
    </div>
  </header>

  <main>
    <!-- LEFT: list -->
    <aside class="panel">
      <div class="panel-head">
        <strong>Chiplar</strong>
        <input id="filter" class="search" placeholder="Qidirish (sarlavha / tag / id)"/>
      </div>
      <div class="panel-body">
        <div class="list" id="list"></div>
      </div>
    </aside>

    <!-- RIGHT: editor -->
    <section class="panel">
      <div class="panel-head">
        <strong>Chip tahriri</strong>
        <div class="row right">
          <span class="badge" id="status">‚Äî</span>
        </div>
      </div>

      <div class="subbar">
        <button class="btn" id="preview">üëÅÔ∏è Ko'rish</button>
        <button class="btn pri" id="saveLocal">üíæ Saqlash (Local)</button>
        <button class="btn" id="undo" title="Orqaga (Ctrl+Z)">‚Ü∂ Orqaga</button>
        <button class="btn" id="redo" title="Oldinga (Ctrl+Y)">‚Ü∑ Oldinga</button>
        <span id="valBadge" class="badge">Validatsiya: ‚Äî</span>
      </div>

      <div class="panel-body">
        <div class="editor-grid">
          <div>
            <div class="field">
              <label>ID <span class="hint">(lotin, bo'shliq yo‚Äòq, takrorlanmasin)</span></label>
              <input id="f_id" placeholder="masalan: algebra-1"/>
            </div>
            <div class="field">
              <label>Sarlavha</label>
              <input id="f_title" placeholder="Ko'rsatiladigan nom"/>
            </div>
            <div class="field">
              <label>Teglar (vergul bilan)</label>
              <input id="f_tags" placeholder="algebra, dars, video"/>
            </div>
            <div class="field">
              <label>Tavsif (ixtiyoriy)</label>
              <input id="f_desc" placeholder="Qisqa izoh"/>
            </div>
            <div class="field">
              <label>SVG / rasm manzili (ikonka, ixtiyoriy)</label>
              <input id="f_icon" placeholder="/assets/icon.svg yoki https://... yoki to'g'ridan-to'g'ri <svg>..."/>
              <div class="hint">.svg tavsiya etiladi. Inline <svg> ham qo‚Äòllanadi.</div>
              <div id="iconLive" style="margin-top:6px;display:flex;align-items:center;gap:8px">
                <div style="font-size:12px" class="muted">Ko‚Äòrinishi:</div>
                <div id="iconBox" style="width:28px;height:28px;display:grid;place-items:center;border:1px solid var(--frame);border-radius:8px;background:#fff"></div>
              </div>
            </div>
          </div>
          <div>
            <div class="field">
              <label>HTML kontent</label>
              <textarea id="f_html" class="code" placeholder="<h2>Sarlavha</h2>\n<p>Kontent...</p>\n<script>console.log('demo')</script>"></textarea>
              <div class="hint">Ctrl/‚åò+Enter ‚Üí tezkor preview ‚Ä¢ Ctrl/‚åò+S ‚Üí eksport fayl</div>
            </div>
          </div>
        </div>

        <div class="split" style="margin-top:12px">
          <div>
            <h3 style="margin:6px 0 8px">Tezkor preview</h3>
            <iframe class="preview" id="previewFrame" sandbox="allow-scripts" referrerpolicy="no-referrer"></iframe>
          </div>
          <div>
            <h3 style="margin:6px 0 8px">JSON ko‚Äòrinishi</h3>
            <pre id="jsonView" class="json">{}</pre>
            <div class="row" style="margin-top:8px">
              <button class="btn" id="copyJson">üìã Nusxa olish</button>
              <span id="jsonSize" class="hint"></span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <input type="file" id="fileInput" accept="application/json" hidden>

  <script type="module">
    const $ = (s, r=document) => r.querySelector(s);
    const esc = (s='') => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
    const slug = s => (s||'').toLowerCase().trim().replace(/[^a-z0-9-]+/g,'-').replace(/^-+|-+$/g,'');
    const debounce = (fn,ms=350)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};

    // ===== State =====
    let data = { schemaVersion: 2, chips: [] };
    let filtered = [];
    let sel = null;       // selected id
    let dirty = false;    // unsaved local state

    // History (undo/redo)
    const hist = { stack:[], idx:-1 };
    const pushHist = () => { hist.stack = hist.stack.slice(0, hist.idx+1); hist.stack.push(JSON.stringify(data)); hist.idx = hist.stack.length-1; };
    const canUndo = () => hist.idx>0; const canRedo = () => hist.idx<hist.stack.length-1;
    const doUndo = () => { if(!canUndo()) return; hist.idx--; data = JSON.parse(hist.stack[hist.idx]); onDataRebind(); };
    const doRedo = () => { if(!canRedo()) return; hist.idx++; data = JSON.parse(hist.stack[hist.idx]); onDataRebind(); };

    // Elements
    const listEl=$('#list'), filterEl=$('#filter'), countEl=$('#count'), schemaEl=$('#schema'), statusEl=$('#status'), saveDot=$('#saveDot'), valBadge=$('#valBadge');
    const f_id=$('#f_id'), f_title=$('#f_title'), f_tags=$('#f_tags'), f_desc=$('#f_desc'), f_icon=$('#f_icon'), f_html=$('#f_html');
    const prevFrame=$('#previewFrame'), jsonView=$('#jsonView'), jsonSize=$('#jsonSize'), iconBox=$('#iconBox');

    init();

    async function init(){
      const local = localStorage.getItem('lm-admin-json');
      if(local){ try{ data = JSON.parse(local); mark('Localdan yuklandi'); }catch{} }
      if(!data || !Array.isArray(data.chips) || !data.chips.length){
        try{ const j = await fetch('./admin.json',{cache:'no-store'}).then(r=>r.json()); data = j; mark('admin.json dan yuklandi'); }
        catch{ data = { schemaVersion: 2, chips:[ {id:'welcome', title:'Boshlash', tags:['info'], desc:'Starter', icon:'', html:'<h2>Xush kelibsiz</h2>'} ]}; mark('Bo\'sh shablon'); }
      }
      // Migrate to schema 2 (icon)
      if((data.schemaVersion||1)<2){ data.chips=(data.chips||[]).map(c=>({...c,icon:c.icon||''})); data.schemaVersion=2; }
      schemaEl.textContent = data.schemaVersion;
      pushHist();
      drawList();
      if(data.chips[0]) select(data.chips[0].id);
      bindUI();
      // Shortcuts
      window.addEventListener('keydown',e=>{
        if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='s'){ e.preventDefault(); doExport(); }
        if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){ e.preventDefault(); doPreview(); }
        if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='z'){ e.preventDefault(); doUndo(); }
        if((e.ctrlKey||e.metaKey)&& (e.key.toLowerCase()==='y' || (e.shiftKey&&e.key.toLowerCase()==='z'))){ e.preventDefault(); doRedo(); }
        if(e.key==='Delete'){ e.preventDefault(); doDelete(); }
        if(e.altKey && (e.key==='ArrowUp'||e.key==='ArrowDown')){ e.preventDefault(); moveBy(e.key==='ArrowUp'?-1:1); }
        if(e.ctrlKey && e.altKey && e.key.toLowerCase()==='n'){ e.preventDefault(); doNew(); }
        if(e.ctrlKey && e.key.toLowerCase()==='d'){ e.preventDefault(); doDuplicate(); }
      });
    }

    function mark(msg){ statusEl.textContent = msg; }
    function setDot(state){ saveDot.className = 'dot ' + (state||''); }

    function drawList(){
      const q=(filterEl.value||'').toLowerCase().trim();
      filtered=(data.chips||[]).filter(c=>!q||(c.title||'').toLowerCase().includes(q)||(c.tags||[]).join(' ').toLowerCase().includes(q)||(c.id||'').toLowerCase().includes(q));
      listEl.innerHTML='';
      filtered.forEach(c=>{
        const row=document.createElement('div'); row.className='item'; row.draggable=true; row.dataset.id=c.id;
        row.innerHTML = `
          <div class="drag">‚ò∞</div>
          <div class="iconthumb">${renderIconThumb(c.icon)}</div>
          <div>
            <div><strong>${esc(c.title||c.id)}</strong>${(c.tags||[]).map(t=>`<span class='tag'>${esc(t)}</span>`).join('')}</div>
            <div class="meta">${esc(c.id)}${c.desc?' ‚Äî '+esc(c.desc):''}</div>
          </div>
          <div><button class="btn" data-open>‚úèÔ∏è</button></div>`;
        row.querySelector('[data-open]').onclick=()=>select(c.id);
        // Drag
        row.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',c.id);row.classList.add('active');});
        row.addEventListener('dragend',()=>row.classList.remove('active'));
        row.addEventListener('dragover',e=>{e.preventDefault();row.style.outline='2px dashed var(--ring)';});
        row.addEventListener('dragleave',()=>{row.style.outline='';});
        row.addEventListener('drop',e=>{e.preventDefault();row.style.outline='';const fromId=e.dataTransfer.getData('text/plain');const toId=c.id;if(fromId===toId)return;moveChip(fromId,toId);});
        listEl.appendChild(row);
      });
      countEl.textContent = data.chips.length;
      [...listEl.children].forEach(n=> n.classList.toggle('active', n.dataset.id===sel));
    }

    function select(id){ sel=id; const c=data.chips.find(x=>x.id===id); if(!c) return;
      f_id.value=c.id||''; f_title.value=c.title||''; f_tags.value=(c.tags||[]).join(', '); f_desc.value=c.desc||''; f_icon.value=c.icon||''; f_html.value=c.html||'';
      renderIconLive(c.icon); drawList(); mark(`Tanlandi: ${id}`); validate(); renderJSON(); setDot(dirty?'dirty':'ok'); }

    function saveCurrentToState(){ if(!sel) return; const idx=data.chips.findIndex(x=>x.id===sel); if(idx<0) return;
      const newId=slug(f_id.value||''); if(!newId){ invalid(f_id,true); return alert('ID bo\'sh bo\'lmasin'); }
      const dup=data.chips.some((x,i)=> i!==idx && x.id===newId); if(dup){ invalid(f_id,true); return alert('Bunday ID allaqachon bor'); }
      const obj={ id:newId, title:f_title.value||'', tags:(f_tags.value||'').split(',').map(s=>s.trim()).filter(Boolean), desc:f_desc.value||'', icon:f_icon.value||'', html:f_html.value||'' };
      data.chips[idx]=obj; sel=newId; localSave(); drawList(); renderJSON(); validate(); }

    const debouncedSave = debounce(()=> saveCurrentToState(), 400);

    function localSave(){ localStorage.setItem('lm-admin-json', JSON.stringify(data)); dirty=false; setDot('ok'); mark('Localga saqlandi'); pushHist(); }
    function markDirty(){ dirty=true; setDot('dirty'); }

    function doPreview(){ saveCurrentToState(); const c=data.chips.find(x=>x.id===sel); if(!c) return;
      const html = `<!doctype html><html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
      <style>body{margin:0;font:14px/1.5 system-ui,Segoe UI,Roboto}.wrap{padding:12px}</style></head>
      <body><div class='wrap'><div class='note' style='font-size:12px;color:#6b7280;margin-bottom:8px'>Sandbox preview</div>${c.html||''}</div></body></html>`;
      prevFrame.srcdoc=html; mark('Preview yangilandi'); }

    function moveChip(fromId,toId){ const a=data.chips.findIndex(x=>x.id===fromId); const b=data.chips.findIndex(x=>x.id===toId); if(a<0||b<0)return; const [m]=data.chips.splice(a,1); data.chips.splice(b,0,m); drawList(); localSave(); }
    function moveBy(d){ if(!sel)return; const i=data.chips.findIndex(x=>x.id===sel); const j=i+d; if(i<0||j<0||j>=data.chips.length)return; const [m]=data.chips.splice(i,1); data.chips.splice(j,0,m); drawList(); localSave(); }

    function bindUI(){ filterEl.addEventListener('input', drawList);
      $('#new').onclick=doNew; $('#dup').onclick=doDuplicate; $('#del').onclick=doDelete; $('#up').onclick=()=>moveBy(-1); $('#down').onclick=()=>moveBy(1);
      $('#export').onclick=doExport; $('#import').onclick=()=>$('#fileInput').click(); $('#saveLocal').onclick=()=>saveCurrentToState(); $('#preview').onclick=doPreview; $('#undo').onclick=doUndo; $('#redo').onclick=doRedo; $('#copyJson').onclick=copyJSON;
      $('#fileInput').addEventListener('change', onImportFile);
      // autosave on blur / debounce on input
      [f_id,f_title,f_tags,f_desc,f_icon,f_html].forEach(el=>{
        el.addEventListener('input',()=>{ markDirty(); if(el===f_icon) renderIconLive(f_icon.value); renderJSON(); validate(); debouncedSave(); });
        el.addEventListener('blur', saveCurrentToState);
      });
      // auto slug id from title
      f_title.addEventListener('blur',()=>{ if(!f_id.value.trim()) { f_id.value = slug(f_title.value); markDirty(); debouncedSave(); } });
    }

    function doNew(){ const base={id:uniqueId('chip-'), title:'Yangi chip', tags:[], desc:'', icon:'', html:'<h2>Yangi</h2>'}; data.chips.push(base); drawList(); select(base.id); localSave(); }
    function doDuplicate(){ if(!sel) return; const c=data.chips.find(x=>x.id===sel); if(!c) return; const copy=JSON.parse(JSON.stringify(c)); copy.id=uniqueId(c.id+'-copy'); copy.title=(c.title||'')+' (nusxa)'; data.chips.splice(data.chips.findIndex(x=>x.id===sel)+1,0,copy); drawList(); select(copy.id); localSave(); }
    function doDelete(){ if(!sel) return; if(!confirm('Haqiqatan o\'chirilsinmi?')) return; const i=data.chips.findIndex(x=>x.id===sel); if(i<0)return; data.chips.splice(i,1); sel=null; drawList(); localSave(); if(data.chips[0]) select(data.chips[0].id); }

    function doExport(){ saveCurrentToState(); const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='admin.json'; a.click(); URL.revokeObjectURL(a.href); mark('Fayl: admin.json'); }

    async function onImportFile(e){ const file=e.target.files?.[0]; if(!file) return; const text=await file.text(); try{ const j=JSON.parse(text); if(!j||!Array.isArray(j.chips)) throw new Error('chips[] topilmadi'); data=j; if((data.schemaVersion||1)<2){ data.chips=(data.chips||[]).map(c=>({...c,icon:c.icon||''})); data.schemaVersion=2; } schemaEl.textContent=data.schemaVersion; sel=null; drawList(); if(data.chips[0]) select(data.chips[0].id); localSave(); mark('Import qilindi'); }catch(err){ alert('Noto\'g\'ri JSON: '+err.message); } e.target.value=''; }

    function renderIconThumb(icon){ if(!icon) return 'üü¢'; if(icon.trim().startsWith('<svg')) return '<span style="display:inline-block;width:20px;height:20px">'+icon+'</span>'; return `<img src="${esc(icon)}" alt="">`; }
    function renderIconLive(icon){ if(!icon){ iconBox.innerHTML=''; return; } if(icon.trim().startsWith('<svg')) iconBox.innerHTML=icon; else iconBox.innerHTML = `<img src="${esc(icon)}" alt="">`; }

    function renderJSON(){ const out = JSON.stringify(data,null,2); jsonView.textContent = out; jsonSize.textContent = (new Blob([out]).size/1024).toFixed(1)+' KB'; }
    function copyJSON(){ const txt=jsonView.textContent||''; navigator.clipboard.writeText(txt).then(()=>mark('JSON nusxalandi')); }

    function validate(){
      // Required: id, title; unique id
      [f_id,f_title].forEach(el=> invalid(el,false));
      let ok=true; const id=slug(f_id.value||''); const title=(f_title.value||'').trim();
      if(!id){ invalid(f_id,true); ok=false; }
      if(!title){ invalid(f_title,true); ok=false; }
      // Unique id check
      const dup = data.chips.filter(c=>c.id===id).length>1; if(dup){ invalid(f_id,true); ok=false; }
      // Length hint for HTML
      if((f_html.value||'').length>100000){ valBadge.textContent='Validatsiya: HTML juda katta'; valBadge.className='badge warn-txt'; return false; }
      valBadge.textContent = ok ? 'Validatsiya: ‚úî' : 'Validatsiya: xatolik';
      valBadge.className = 'badge ' + (ok?'ok-txt':'danger-txt');
      return ok;
    }
    function invalid(el,on){ el.classList.toggle('invalid', !!on); }

    function onDataRebind(){ schemaEl.textContent=data.schemaVersion??2; drawList(); if(data.chips[0]){ const id=data.chips.find(c=>c.id===sel)?.id || data.chips[0].id; select(id); } renderJSON(); mark('Tarixdan tiklandi'); setDot('ok'); }

    function uniqueId(base){ let i=1; let id=slug(base||'chip'); const exists=id=>data.chips.some(c=>c.id===id); while(exists(id)) id=`${slug(base||'chip')}-${i++}`; return id; }
  </script>
</body>
</html>