<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LeaderMath ‚Äî admin.html (JSON Chip Editor)</title>
  <meta name="theme-color" content="#2E8B57">
  <link rel="icon" href="./favicon.png">
  <style>
    :root{
      --brand:#2E8B57;--brand2:#1F6B45;--bg:#f6faf8;--text:#0f172a;--muted:#5b7a6a;
      --card:#fff;--frame:#d8e7dd;--ring:#8ad1b1;--danger:#c0392b;--ok:#1F6B45;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto}
    header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.75);backdrop-filter:blur(10px) saturate(1.15);
      border-bottom:1px solid var(--frame)}
    .bar{max-width:1200px;margin:0 auto;padding:10px 14px;display:flex;align-items:center;gap:10px}
    .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand2));
      color:#fff;display:grid;place-items:center;font-weight:900}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-left:auto}
    .btn{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--frame);background:#fff;cursor:pointer;
      padding:8px 12px;border-radius:10px;transition:.15s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(0,0,0,.08)}
    .btn.pri{background:linear-gradient(135deg,#f3fbf7,#e7f9f0);border-color:var(--ring)}
    .btn.danger{background:#fff0f0;border-color:#ffd5d5;color:#a30000}
    .btn:active{transform:scale(.98)}
    .counter{font-size:12px;color:var(--muted)}

    main{max-width:1200px;margin:16px auto;padding:0 14px;display:grid;grid-template-columns:320px 1fr;gap:16px}
    @media (max-width:1000px){ main{grid-template-columns:1fr} }

    .panel{background:var(--card);border:1px solid var(--frame);border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .panel-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--frame)}
    .panel-body{padding:12px 14px}

    /* List */
    .search{width:100%;padding:8px 12px;border:1px solid var(--frame);border-radius:12px;margin-bottom:10px}
    .list{display:flex;flex-direction:column;gap:8px;max-height:72vh;overflow:auto}
    .item{display:grid;grid-template-columns:26px 1fr auto;align-items:center;gap:8px;border:1px solid var(--frame);
      padding:8px;border-radius:12px;background:#fafdfb}
    .item[draggable="true"]{cursor:grab}
    .item .drag{user-select:none;opacity:.6}
    .item .meta{font-size:12px;color:var(--muted)}
    .item.active{outline:2px solid var(--ring);background:#f2fbf7}
    .tag{font-size:11px;padding:2px 6px;border-radius:999px;background:#eff9f4;border:1px solid var(--frame);margin-left:6px}

    /* Editor */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    .field{display:flex;flex-direction:column;gap:6px}
    .field input,.field textarea{padding:10px 12px;border:1px solid var(--frame);border-radius:12px;font:inherit}
    textarea.code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;min-height:320px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .hint{font-size:12px;color:var(--muted)}
    .right{margin-left:auto}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#eff9f4;border:1px solid var(--frame)}
    .danger-txt{color:var(--danger)}
    iframe.preview{width:100%;height:360px;border:1px solid var(--frame);border-radius:12px}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="logo">L</div>
      <div>
        <div style="font-weight:800">LeaderMath ‚Äî Admin Panel</div>
        <div class="counter"><span id="count">0</span> ta chip ‚Ä¢ schema <span id="schema">1</span></div>
      </div>
      <div class="toolbar">
        <button class="btn pri" id="new">‚ûï Yangi</button>
        <button class="btn" id="dup">üìÑ Nusxa</button>
        <button class="btn danger" id="del">üóëÔ∏è O'chirish</button>
        <button class="btn" id="up">‚¨ÜÔ∏è Yuqoriga</button>
        <button class="btn" id="down">‚¨áÔ∏è Pastga</button>
        <button class="btn" id="import">üì• Import JSON</button>
        <button class="btn pri" id="export">üì§ Export admin.json</button>
      </div>
    </div>
  </header>

  <main>
    <!-- LEFT: list -->
    <aside class="panel">
      <div class="panel-head">
        <strong>Chiplar</strong>
        <input id="filter" class="search" placeholder="Qidirish (sarlavha / tag)"/>
      </div>
      <div class="panel-body">
        <div class="list" id="list"></div>
      </div>
    </aside>

    <!-- RIGHT: editor -->
    <section class="panel">
      <div class="panel-head">
        <strong>Chip tahriri</strong>
        <div class="row right">
          <span class="badge" id="status">‚Äî</span>
          <button class="btn" id="preview">üëÅÔ∏è Ko'rish</button>
          <button class="btn pri" id="saveLocal">üíæ Saqlash (Local)</button>
        </div>
      </div>
      <div class="panel-body">
        <div class="grid">
          <div>
            <div class="field">
              <label>ID <span class="hint">(lotin, bo'shliq yo'q ‚Äî takrorlanmasin)</span></label>
              <input id="f_id" placeholder="masalan: algebra-1"/>
            </div>
            <div class="field">
              <label>Sarlavha</label>
              <input id="f_title" placeholder="Ko'rsatiladigan nom"/>
            </div>
            <div class="field">
              <label>Teglar (vergul bilan)</label>
              <input id="f_tags" placeholder="algebra, dars, video"/>
            </div>
            <div class="field">
              <label>Tavsif (ixtiyoriy)</label>
              <input id="f_desc" placeholder="Qisqa izoh"/>
            </div>
          </div>
          <div>
            <div class="field">
              <label>HTML kontent</label>
              <textarea id="f_html" class="code" placeholder="<h2>Sarlavha</h2>\n<p>Kontent...</p>\n<script>console.log('demo')</script>"></textarea>
              <div class="hint">Ctrl/‚åò+Enter ‚Üí tezkor preview ‚Ä¢ Ctrl/‚åò+S ‚Üí eksport fayl</div>
            </div>
          </div>
        </div>

        <h3>Tezkor preview</h3>
        <iframe class="preview" id="previewFrame" sandbox="allow-scripts" referrerpolicy="no-referrer"></iframe>
      </div>
    </section>
  </main>

  <input type="file" id="fileInput" accept="application/json" hidden>

  <script type="module">
    const $ = (s, r=document) => r.querySelector(s);
    const esc = (s='') => String(s).replace(/[&<>"]|'/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    const slug = s => (s||'').toLowerCase().trim().replace(/[^a-z0-9-]+/g,'-').replace(/^-+|-+$/g,'');

    // State
    let data = { schemaVersion: 1, chips: [] };
    let filtered = []; // view of list
    let sel = null;    // selected id

    // Elements
    const listEl = $('#list');
    const filterEl = $('#filter');
    const countEl = $('#count');
    const schemaEl = $('#schema');
    const statusEl = $('#status');

    const f_id = $('#f_id');
    const f_title = $('#f_title');
    const f_tags = $('#f_tags');
    const f_desc = $('#f_desc');
    const f_html = $('#f_html');

    const prevFrame = $('#previewFrame');

    // Load on start
    init();

    async function init(){
      // Try localStorage first
      const local = localStorage.getItem('lm-admin-json');
      if(local){
        try { data = JSON.parse(local); mark('Localdan yuklandi'); }
        catch{ /* ignore */ }
      }
      if(!data || !Array.isArray(data.chips) || !data.chips.length){
        try{
          const j = await fetch('./admin.json',{cache:'no-store'}).then(r=>r.json());
          data = j; mark('admin.json dan yuklandi');
        }catch(e){
          data = { schemaVersion: 1, chips:[
            {id:'welcome', title:'Boshlash', tags:['info'], desc:'Starter chip', html:'<h2>Xush kelibsiz</h2>'}
          ]};
          mark('Yangi bo\'sh shablon yaratildi');
        }
      }
      schemaEl.textContent = data.schemaVersion ?? 1;
      drawList();
      const first = data.chips[0]?.id; if(first) select(first);
      bindUI();
      // Shortcuts
      window.addEventListener('keydown',e=>{
        if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); doExport(); }
        if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); doPreview(); }
      });
    }

    function mark(msg){ statusEl.textContent = msg; }

    function drawList(){
      const q = (filterEl.value||'').toLowerCase().trim();
      filtered = data.chips.filter(c => !q || (c.title||'').toLowerCase().includes(q) || (c.tags||[]).join(' ').toLowerCase().includes(q));
      listEl.innerHTML = '';
      filtered.forEach((c, idx)=>{
        const row = document.createElement('div');
        row.className = 'item';
        row.draggable = true;
        row.dataset.id = c.id;
        row.innerHTML = `
          <div class="drag">‚ò∞</div>
          <div>
            <div><strong>${esc(c.title||c.id)}</strong>${(c.tags||[]).map(t=>`<span class='tag'>${esc(t)}</span>`).join('')}</div>
            <div class="meta">${esc(c.id)}${c.desc? ' ‚Äî '+esc(c.desc):''}</div>
          </div>
          <div><button class="btn" data-open>‚úèÔ∏è</button></div>
        `;
        row.querySelector('[data-open]').onclick = ()=> select(c.id);
        // Drag & drop
        row.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', c.id); row.classList.add('active'); });
        row.addEventListener('dragend', ()=> row.classList.remove('active'));
        row.addEventListener('dragover', e=>{ e.preventDefault(); row.style.outline='2px dashed var(--ring)'; });
        row.addEventListener('dragleave', ()=>{ row.style.outline=''; });
        row.addEventListener('drop', e=>{
          e.preventDefault(); row.style.outline='';
          const fromId = e.dataTransfer.getData('text/plain');
          const toId = c.id; if(fromId===toId) return;
          moveChip(fromId, toId);
        });
        listEl.appendChild(row);
      });
      countEl.textContent = data.chips.length;
      // Highlight selected
      [...listEl.children].forEach(n=> n.classList.toggle('active', n.dataset.id===sel));
    }

    function select(id){
      sel = id;
      const c = data.chips.find(x=>x.id===id); if(!c) return;
      f_id.value = c.id || '';
      f_title.value = c.title || '';
      f_tags.value = (c.tags||[]).join(', ');
      f_desc.value = c.desc || '';
      f_html.value = c.html || '';
      drawList();
      mark(`Tanlandi: ${id}`);
    }

    function saveCurrentToState(){
      if(!sel) return;
      const idx = data.chips.findIndex(x=>x.id===sel); if(idx<0) return;
      const newId = slug(f_id.value||'');
      if(!newId){ alert('ID bo\'sh bo\'lmasin'); return; }
      // unique id check
      const dup = data.chips.some((x,i)=> i!==idx && x.id===newId);
      if(dup){ alert('Bunday ID mavjud. O\'zgartiring.'); return; }
      const obj = {
        id: newId,
        title: f_title.value||'',
        tags: (f_tags.value||'').split(',').map(s=>s.trim()).filter(Boolean),
        desc: f_desc.value||'',
        html: f_html.value||''
      };
      data.chips[idx] = obj;
      sel = newId; // if id changed
      localSave();
      drawList();
    }

    function localSave(){
      localStorage.setItem('lm-admin-json', JSON.stringify(data));
      mark('Localga saqlandi');
    }

    function doPreview(){
      saveCurrentToState();
      const c = data.chips.find(x=>x.id===sel); if(!c) return;
      const html = `<!doctype html><html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
      <style>body{margin:0;font:14px/1.5 system-ui,Segoe UI,Roboto} .wrap{padding:12px}</style></head>
      <body><div class='wrap'><div class='note' style='font-size:12px;color:#6b7280;margin-bottom:8px'>Sandbox preview</div>${c.html||''}</div></body></html>`;
      prevFrame.srcdoc = html;
      mark('Preview yangilandi');
    }

    function moveChip(fromId, toId){
      const a = data.chips.findIndex(x=>x.id===fromId);
      const b = data.chips.findIndex(x=>x.id===toId);
      if(a<0||b<0) return;
      const [m] = data.chips.splice(a,1);
      data.chips.splice(b,0,m);
      drawList();
      localSave();
    }

    function moveBy(delta){
      if(!sel) return; const i = data.chips.findIndex(x=>x.id===sel); if(i<0) return;
      const j = i+delta; if(j<0||j>=data.chips.length) return;
      const [m] = data.chips.splice(i,1); data.chips.splice(j,0,m);
      drawList(); localSave();
    }

    // Toolbar actions
    function bindUI(){
      filterEl.addEventListener('input', drawList);
      $('#new').onclick = ()=>{
        const base = {id: uniqueId('chip-'), title:'Yangi chip', tags:[], desc:'', html:'<h2>Yangi</h2>'};
        data.chips.push(base); drawList(); select(base.id); localSave();
      };
      $('#dup').onclick = ()=>{
        if(!sel) return; const c = data.chips.find(x=>x.id===sel); if(!c) return;
        const copy = JSON.parse(JSON.stringify(c)); copy.id = uniqueId(c.id+'-copy'); copy.title = (c.title||'')+' (nusxa)';
        data.chips.splice(data.chips.findIndex(x=>x.id===sel)+1,0,copy);
        drawList(); select(copy.id); localSave();
      };
      $('#del').onclick = ()=>{
        if(!sel) return; if(!confirm('Haqiqatan o\'chirilsinmi?')) return;
        const i = data.chips.findIndex(x=>x.id===sel); if(i<0) return;
        data.chips.splice(i,1); sel=null; drawList(); localSave();
        if(data.chips[0]) select(data.chips[0].id);
      };
      $('#up').onclick = ()=> moveBy(-1);
      $('#down').onclick = ()=> moveBy(1);
      $('#export').onclick = doExport;
      $('#import').onclick = ()=> $('#fileInput').click();
      $('#fileInput').addEventListener('change', async (e)=>{
        const file = e.target.files?.[0]; if(!file) return;
        const text = await file.text();
        try{
          const j = JSON.parse(text);
          if(!j || !Array.isArray(j.chips)) throw new Error('chips[] topilmadi');
          data = j; schemaEl.textContent = data.schemaVersion ?? 1; sel=null; drawList();
          if(data.chips[0]) select(data.chips[0].id); localSave(); mark('Import qilindi');
        }catch(err){ alert('Noto\'g\'ri JSON: '+err.message); }
        e.target.value = '';
      });
      $('#saveLocal').onclick = ()=>{ saveCurrentToState(); };
      $('#preview').onclick = doPreview;

      // Auto slug for ID if user edits title first and id empty
      f_title.addEventListener('blur',()=>{ if(!f_id.value.trim()) f_id.value = slug(f_title.value); });
      // Persist form edits on blur
      [f_id,f_title,f_tags,f_desc,f_html].forEach(el=> el.addEventListener('blur', saveCurrentToState));
    }

    function doExport(){
      saveCurrentToState();
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = 'admin.json'; a.click(); URL.revokeObjectURL(a.href);
      mark('Fayl yuklab olindi: admin.json');
    }

    function uniqueId(base){
      let i=1; let id = slug(base||'chip');
      const exists = id => data.chips.some(c=>c.id===id);
      while(exists(id)) id = `${slug(base||'chip')}-${i++}`;
      return id;
    }
  </script>
</body>
</html>