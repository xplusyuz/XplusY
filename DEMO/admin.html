<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LeaderMath ‚Äî Home Admin (Nested Sections + Banners/Cards)</title>
  <style>
    :root{--brand:#2E8B57;--bg:#f4f8f6;--line:#dfe7e2;--card:#fff;--pill:#eef5f0}
    *{box-sizing:border-box}
    body{margin:0;font:15px/1.5 system-ui,Segoe UI,Arial;background:var(--bg);color:#0d1b14}
    header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--line);z-index:10}
    .row{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;gap:10px;align-items:center}
    .brand{font-weight:800;color:var(--brand)}
    main{max-width:1200px;margin:0 auto;padding:16px;display:grid;gap:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    button{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
    button.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{border:1px solid var(--line);border-radius:12px;background:var(--card);overflow:hidden}
    .card h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--line)}
    .card .body{padding:12px}
    .card .sub{padding:12px;border-top:1px dashed var(--line);background:#fafdfb}
    input,select,textarea{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
    textarea{min-height:150px;font-family:ui-monospace,Consolas,monospace}
    label{font-weight:600;font-size:13px;color:#2a4b3b;display:block;margin:6px 0 4px}
    .rowflex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef2ee;text-align:left;vertical-align:top}
    .small{font-size:12px;color:#4a6b5a}
    .pill{padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:var(--pill);font-size:12px}
    .danger{color:#b00020}
    .muted{opacity:.8}
    .help{font-size:12px;color:#3b5d4b}
    .ghost{opacity:.6}
    .divider{height:1px;background:var(--line);margin:8px 0}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    // ====== Firebase Config (sizniki) ======
    const firebaseConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.appspot.com",
      messagingSenderId: "992512966017",
      appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId: "G-459PLJ7P7L"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ADMIN_EMAILS = ["sohibjonmath@gmail.com"]; // kerak bo‚Äòlsa ko‚Äòpaytiring

    // ====== Guard ======
    function guard(u){
      const wrap = document.getElementById('guard');
      if(!u){
        wrap.innerHTML = '<button id="glogin">Google bilan kiring</button>';
        document.getElementById('glogin').onclick=()=>signInWithPopup(auth,new GoogleAuthProvider());
        return false;
      }
      if(ADMIN_EMAILS.indexOf(u.email)<0){
        wrap.innerHTML = '<div class="danger">Kirish taqiqlangan. Faqat admin.</div>';
        return false;
      }
      wrap.innerHTML = '<div>üëã '+(u.email||u.uid)+'</div>';
      return true;
    }

    // ====== State & helpers ======
    let state = { sections:[], sel:-1 }; // sel = tanlangan top-level bo‚Äòlim indeksi

    const $ = (s,el=document)=>el.querySelector(s);
    const el = (tag, attrs={}, html='')=>{
      const n=document.createElement(tag);
      for(const k in attrs){ n.setAttribute(k, attrs[k]); }
      if(html!==undefined) n.innerHTML=html;
      return n;
    };

    const ensureArrays = (s)=>{
      if(!Array.isArray(s.subsections)) s.subsections=[];
      if(!Array.isArray(s.items)) s.items=[];
    };

    // ====== Top-level sections jadvali ======
    function renderSectionTable(){
      const tb = document.querySelector('#tbl-sections tbody');
      tb.innerHTML='';
      state.sections.forEach((s,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML =
          `<td>${i+1}</td>
           <td>${s.id||''}</td>
           <td>${s.title||''}</td>
           <td><span class="pill">${s.fullBleed?'fullBleed':'standard'}</span></td>
           <td class="rowflex">
             <button data-i="${i}" class="sel">Tanlash</button>
             <button data-i="${i}" class="up">‚Üë</button>
             <button data-i="${i}" class="down">‚Üì</button>
             <button data-i="${i}" class="del">O‚Äòchirish</button>
           </td>`;
        tb.appendChild(tr);
      });
    }

    // ====== Section editor (meta + subsections + items) ======
    function openSectionEditor(idx){
      state.sel = idx;
      const s = state.sections[idx] || {};
      ensureArrays(s);
      const ed = document.getElementById('editor');
      ed.innerHTML = '';

      // Meta
      const meta = el('div',{class:'card'});
      meta.innerHTML = `
        <h3>Bo‚Äòlim ma‚Äôlumoti</h3>
        <div class="body">
          <div class="two">
            <div><label>ID</label><input id="sec_id" value="${s.id||''}"></div>
            <div><label>Sarlavha</label><input id="sec_title" value="${s.title||''}"></div>
          </div>
          <div class="two" style="margin-top:8px">
            <div>
              <label>fullBleed</label>
              <select id="sec_full">
                <option value="false"${!s.fullBleed?' selected':''}>false</option>
                <option value="true"${s.fullBleed?' selected':''}>true</option>
              </select>
            </div>
            <div>
              <label>baseHref (ixtiyoriy)</label>
              <input id="sec_base" value="${s.baseHref||''}">
            </div>
          </div>
          <div class="rowflex" style="margin-top:10px">
            <button id="save_section" class="primary">Bo‚Äòlim (meta) saqlash</button>
          </div>
        </div>`;
      ed.appendChild(meta);

      // Subsections
      const subs = el('div',{class:'card'});
      subs.innerHTML = `
        <h3>Sub-bo‚Äòlimlar</h3>
        <div class="body">
          <div class="rowflex">
            <button id="add_sub">+ Sub-bo‚Äòlim qo‚Äòshish</button>
            <span class="small">Sub-bo‚Äòlim ham bo‚Äòlimdek o‚Äòzining items (banner/card) lariga ega.</span>
          </div>
          <div class="divider"></div>
          <table id="tbl-subs">
            <thead><tr><th>#</th><th>ID</th><th>Sarlavha</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>`;
      ed.appendChild(subs);

      // Items
      const items = el('div',{class:'card'});
      items.innerHTML = `
        <h3>Itemlar (Bannerlar / Cardlar)</h3>
        <div class="body">
          <div class="rowflex">
            <button id="add_banner">+ Banner qo‚Äòshish</button>
            <button id="add_card">+ Card qo‚Äòshish</button>
            <span class="small">Banner: HTML/url. Card: oddiy/timed/coming soon, Info modal + Start tugma.</span>
          </div>
          <div class="divider"></div>
          <table id="tbl-items">
            <thead>
              <tr>
                <th>#</th><th>Kind</th><th>Title</th><th>Mode/Style</th><th>Info/Link</th><th>Vaqt</th><th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>`;
      ed.appendChild(items);

      // Render subs & items
      const renderSubs = ()=>{
        const tb = $('#tbl-subs tbody', subs); tb.innerHTML='';
        s.subsections.forEach((ss, j)=>{
          const tr = el('tr',{}, `
            <td>${j+1}</td>
            <td>${ss.id||''}</td>
            <td>${ss.title||''}</td>
            <td class="rowflex">
              <button data-j="${j}" class="edit_sub">Tahrirlash</button>
              <button data-j="${j}" class="up_sub">‚Üë</button>
              <button data-j="${j}" class="down_sub">‚Üì</button>
              <button data-j="${j}" class="del_sub">O‚Äòchirish</button>
            </td>`);
          tb.appendChild(tr);
        });
      };

      const renderItems = ()=>{
        const tb = $('#tbl-items tbody', items); tb.innerHTML='';
        s.items.forEach((it, k)=>{
          let modeOrStyle = '';
          if(it.kind==='banner') modeOrStyle = (it.mode||'html');
          if(it.kind==='card') modeOrStyle = (it.cardStyle||'simple');

          let infoLink = '';
          if(it.kind==='card'){
            const lbl = it.ctaLabel||'Start';
            const href = it.ctaHref||'';
            infoLink = `<span class="pill">${lbl}</span> <span class="muted">${href?href:''}</span>`;
          }else{
            infoLink = it.mode==='url' ? `<span class="muted">${it.src||''}</span>` : '<span class="muted">contentHtml</span>';
          }

          let timeStr = '';
          if(it.kind==='card' && it.cardStyle==='timed'){
            timeStr = `<span class="small">start: ${it.startAt||'-'}<br>end: ${it.endAt||'-'}</span>`;
          }else if(it.kind==='card' && it.cardStyle==='soon'){
            timeStr = `<span class="pill">coming soon</span>`;
          }else{
            timeStr = '-';
          }

          const tr = el('tr',{}, `
            <td>${k+1}</td>
            <td><span class="pill">${it.kind}</span></td>
            <td>${it.title||''}</td>
            <td>${modeOrStyle}</td>
            <td>${infoLink}</td>
            <td>${timeStr}</td>
            <td class="rowflex">
              <button data-k="${k}" class="edit_item">Tahrir</button>
              <button data-k="${k}" class="up_item">‚Üë</button>
              <button data-k="${k}" class="down_item">‚Üì</button>
              <button data-k="${k}" class="del_item">O‚Äòchirish</button>
            </td>`);
          tb.appendChild(tr);
        });
      };

      renderSubs();
      renderItems();

      // Meta save
      $('#save_section', meta).onclick = ()=>{
        s.id = $('#sec_id', meta).value.trim();
        s.title = $('#sec_title', meta).value.trim();
        s.fullBleed = $('#sec_full', meta).value==='true';
        const b = $('#sec_base', meta).value.trim(); if(b) s.baseHref=b; else delete s.baseHref;
        state.sections[idx]=s;
        renderSectionTable();
        alert('Bo‚Äòlim (meta) saqlandi ‚úÖ');
      };

      // Add sub
      $('#add_sub', subs).onclick = ()=>{
        const n = s.subsections.length+1;
        s.subsections.push({ id:`sub${n}`, title:`Sub ${n}`, items:[] });
        renderSubs();
      };

      // Sub actions (edit/basic modal)
      subs.addEventListener('click', (e)=>{
        const j = e.target.getAttribute('data-j');
        if(j===null) return;
        const jj = parseInt(j,10);
        if(e.target.classList.contains('up_sub') && jj>0){
          const t = s.subsections[jj-1]; s.subsections[jj-1]=s.subsections[jj]; s.subsections[jj]=t; renderSubs();
        }
        if(e.target.classList.contains('down_sub') && jj<s.subsections.length-1){
          const t = s.subsections[jj+1]; s.subsections[jj+1]=s.subsections[jj]; s.subsections[jj]=t; renderSubs();
        }
        if(e.target.classList.contains('del_sub')){
          if(confirm('Sub-bo‚Äòlimni o‚Äòchirishni tasdiqlaysizmi?')){
            s.subsections.splice(jj,1); renderSubs();
          }
        }
        if(e.target.classList.contains('edit_sub')){
          const ss = s.subsections[jj];
          const wrap = el('div',{}, `
            <div class="two">
              <div><label>ID</label><input id="sid" value="${ss.id||''}"></div>
              <div><label>Sarlavha</label><input id="stitle" value="${ss.title||''}"></div>
            </div>
            <div class="rowflex" style="margin-top:8px">
              <button id="sok" class="primary">Saqlash</button>
              <button id="scancel">Bekor</button>
            </div>
            <div class="help" style="margin-top:6px">Eslatma: Sub-bo‚Äòlimning itemlarini bu yerdan emas, sub-bo‚Äòlimning o‚Äòz editoridan qo‚Äòshish ham mumkin ‚Äî hozircha oddiy meta tahriri.</div>
          `);
          modal(`Sub-bo‚Äòlim tahriri ‚Äî ${ss.title||''}`, wrap);
          $('#sok', wrap).onclick=()=>{
            ss.id = $('#sid', wrap).value.trim();
            ss.title = $('#stitle', wrap).value.trim();
            renderSubs();
            closeModal();
          };
          $('#scancel', wrap).onclick=()=>closeModal();
        }
      });

      // Add banner
      $('#add_banner', items).onclick = ()=>{
        s.items.push({
          kind:'banner',
          title:'Banner',
          mode:'html', // html | url
          sandbox:'allow-scripts allow-forms',
          contentHtml:'<section style="padding:24px"><h2>Banner HTML</h2><p>Bu yerga banner HTML yozing.</p></section>'
        });
        renderItems();
      };
      // Add card
      $('#add_card', items).onclick = ()=>{
        s.items.push({
          kind:'card',
          title:'Yangi card',
          cardStyle:'simple', // simple | timed | soon
          infoHtml:'<p>Bu card haqida qisqacha ma‚Äôlumot.</p>',
          ctaLabel:'Boshlash',
          ctaHref:''
        });
        renderItems();
      };

      // Item actions
      items.addEventListener('click', (e)=>{
        const k = e.target.getAttribute('data-k');
        if(k===null) return;
        const kk = parseInt(k,10);
        if(e.target.classList.contains('up_item') && kk>0){
          const t = s.items[kk-1]; s.items[kk-1]=s.items[kk]; s.items[kk]=t; renderItems();
        }
        if(e.target.classList.contains('down_item') && kk<s.items.length-1){
          const t = s.items[kk+1]; s.items[kk+1]=s.items[kk]; s.items[kk]=t; renderItems();
        }
        if(e.target.classList.contains('del_item')){
          if(confirm('Itemni o‚Äòchirishni tasdiqlaysizmi?')){
            s.items.splice(kk,1); renderItems();
          }
        }
        if(e.target.classList.contains('edit_item')){
          const it = s.items[kk];
          if(it.kind==='banner') editBanner(it, renderItems);
          else editCard(it, renderItems);
        }
      });
    }

    // ====== Editors for item types ======
    function editBanner(it, onSave){
      const wrap = el('div');
      wrap.innerHTML = `
        <div class="two">
          <div><label>Title</label><input id="t" value="${it.title||''}"></div>
          <div>
            <label>Mode</label>
            <select id="mode">
              <option value="html"${it.mode==='html'?' selected':''}>html</option>
              <option value="url"${it.mode==='url'?' selected':''}>url</option>
            </select>
          </div>
        </div>
        <div class="two" style="margin-top:8px">
          <div><label>Sandbox</label><input id="sb" value="${it.sandbox||'allow-scripts allow-forms'}"></div>
          <div><label>baseHref (ixtiyoriy)</label><input id="bh" value="${it.baseHref||''}"></div>
        </div>
        <div id="htmlBlock" class="sub" style="${it.mode==='html'?'':'display:none'}">
          <label>contentHtml</label>
          <textarea id="html">${it.contentHtml?String(it.contentHtml).replace(/</g,'&lt;'):''}</textarea>
        </div>
        <div id="urlBlock" class="sub" style="${it.mode==='url'?'':'display:none'}">
          <label>src (URL)</label>
          <input id="src" value="${it.src||''}">
        </div>
        <div class="rowflex" style="margin-top:8px">
          <button id="ok" class="primary">Saqlash</button>
          <button id="cancel">Bekor</button>
        </div>
      `;
      modal('Banner tahriri', wrap);
      $('#mode', wrap).onchange = function(){
        const v=this.value;
        $('#htmlBlock', wrap).style.display=(v==='html'?'block':'none');
        $('#urlBlock', wrap).style.display=(v==='url'?'block':'none');
      };
      $('#ok', wrap).onclick=()=>{
        it.title = $('#t', wrap).value.trim();
        it.mode = $('#mode', wrap).value;
        it.sandbox = $('#sb', wrap).value.trim();
        const bh = $('#bh', wrap).value.trim(); if(bh) it.baseHref=bh; else delete it.baseHref;
        if(it.mode==='html'){ it.contentHtml = $('#html', wrap).value; delete it.src; }
        else { it.src = $('#src', wrap).value.trim(); delete it.contentHtml; }
        onSave(); closeModal();
      };
      $('#cancel', wrap).onclick=()=>closeModal();
    }

    function editCard(it, onSave){
      const wrap = el('div');
      const startAt = it.startAt || '';
      const endAt = it.endAt || '';
      wrap.innerHTML = `
        <div class="two">
          <div><label>Title</label><input id="t" value="${it.title||''}"></div>
          <div>
            <label>Card Style</label>
            <select id="style">
              <option value="simple"${it.cardStyle==='simple'?' selected':''}>simple</option>
              <option value="timed"${it.cardStyle==='timed'?' selected':''}>timed (start‚Äìend)</option>
              <option value="soon"${it.cardStyle==='soon'?' selected':''}>coming soon</option>
            </select>
          </div>
        </div>
        <div class="two" style="margin-top:8px">
          <div><label>Start tugma matni</label><input id="cl" value="${it.ctaLabel||'Boshlash'}"></div>
          <div><label>Start link (URL)</label><input id="ch" value="${it.ctaHref||''}"></div>
        </div>
        <div id="timers" class="sub" style="${it.cardStyle==='timed'?'':'display:none'}">
          <div class="two">
            <div><label>Start vaqti (YYYY-MM-DD HH:mm)</label><input id="sa" placeholder="2025-11-04 09:00" value="${startAt}"></div>
            <div><label>End vaqti (YYYY-MM-DD HH:mm)</label><input id="ea" placeholder="2025-11-05 18:00" value="${endAt}"></div>
          </div>
          <div class="help" style="margin-top:6px">Frontend karta statusini vaqtga qarab ko‚Äòrsatadi: startdan oldin ‚ÄúYaqinda‚Äù, oraliqda ‚ÄúFaol‚Äù, enddan keyin ‚ÄúTugagan‚Äù.</div>
        </div>
        <div class="sub">
          <label>Info modal (HTML)</label>
          <textarea id="info">${it.infoHtml?String(it.infoHtml).replace(/</g,'&lt;'):''}</textarea>
        </div>
        <div class="rowflex" style="margin-top:8px">
          <button id="ok" class="primary">Saqlash</button>
          <button id="cancel">Bekor</button>
        </div>
      `;
      modal('Card tahriri', wrap);
      $('#style', wrap).onchange=function(){
        $('#timers', wrap).style.display=(this.value==='timed'?'block':'none');
      };
      $('#ok', wrap).onclick=()=>{
        it.title = $('#t', wrap).value.trim();
        it.cardStyle = $('#style', wrap).value;
        it.ctaLabel = $('#cl', wrap).value.trim() || 'Boshlash';
        it.ctaHref = $('#ch', wrap).value.trim();
        it.infoHtml = $('#info', wrap).value;
        if(it.cardStyle==='timed'){
          it.startAt = $('#sa', wrap).value.trim();
          it.endAt = $('#ea', wrap).value.trim();
        }else{
          delete it.startAt; delete it.endAt;
        }
        onSave(); closeModal();
      };
      $('#cancel', wrap).onclick=()=>closeModal();
    }

    // ====== Modal helper ======
    let MODAL=null;
    function modal(title, contentEl){
      closeModal();
      MODAL = el('div',{style:'position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:9999'});
      const box = el('div',{style:'width:min(900px,96vw);max-height:90vh;overflow:auto;background:#fff;border-radius:14px;border:1px solid #dfe7e2;box-shadow:0 20px 60px rgba(0,0,0,.15)'} );
      box.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #dfe7e2">
        <div style="font-weight:700">${title}</div>
        <button id="mclose">‚úï</button>
      </div>`;
      const body = el('div',{style:'padding:12px'}); body.appendChild(contentEl);
      box.appendChild(body);
      MODAL.appendChild(box);
      document.body.appendChild(MODAL);
      $('#mclose', MODAL).onclick=()=>closeModal();
      MODAL.addEventListener('click', (e)=>{ if(e.target===MODAL) closeModal(); });
    }
    function closeModal(){ if(MODAL){ MODAL.remove(); MODAL=null; } }

    // ====== Table events (top-level) ======
    document.addEventListener('click', (e)=>{
      const i = e.target.getAttribute('data-i');
      if(i===null) return;
      const idx = parseInt(i,10);
      if(e.target.classList.contains('sel')) openSectionEditor(idx);
      if(e.target.classList.contains('up') && idx>0){
        const t=state.sections[idx-1]; state.sections[idx-1]=state.sections[idx]; state.sections[idx]=t; renderSectionTable();
      }
      if(e.target.classList.contains('down') && idx<state.sections.length-1){
        const t=state.sections[idx+1]; state.sections[idx+1]=state.sections[idx]; state.sections[idx]=t; renderSectionTable();
      }
      if(e.target.classList.contains('del')){
        if(confirm('Bo‚Äòlimni o‚Äòchirishni tasdiqlaysizmi?')){
          state.sections.splice(idx,1);
          renderSectionTable();
          document.getElementById('editor').innerHTML='<div class="small">Chapdan bo‚Äòlim tanlang.</div>';
        }
      }
    });

    // ====== Controls ======
    function addTopSection(){
      const n = state.sections.length+1;
      state.sections.push({ id:`sec${n}`, title:`Yangi bo‚Äòlim ${n}`, fullBleed:false, subsections:[], items:[] });
      renderSectionTable();
      openSectionEditor(state.sections.length-1);
    }
    function downloadJson(){
      const blob=new Blob([JSON.stringify({sections:state.sections},null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='home.json'; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href),1000);
    }
    async function publishToFirestore(){
      try{
        await setDoc(doc(db,'configs','home'), {sections:state.sections});
        alert('Firestore‚Äôga saqlandi ‚úÖ');
      }catch(e){ alert('Saqlash xatosi: '+e.message); }
    }
    async function loadFromFile(f){
      const txt=await f.text();
      try{
        const obj=JSON.parse(txt);
        if(Array.isArray(obj.sections)) {
          state.sections=obj.sections;
          renderSectionTable();
          if(state.sections[0]) openSectionEditor(0);
        } else alert('JSON: sections topilmadi');
      }catch(err){ alert('JSON parse xato: '+err.message); }
    }

    // ====== Example seed (siz so‚Äòragan misol struktura) ======
    function seedExample(){
      if(state.sections.length){ if(!confirm('Mavjud tarkib ustiga NAMUNA qo‚Äòshilsinmi?')) return; }
      const sample = {
        id:'home', title:'Bosh sahifa', fullBleed:false, baseHref:'',
        items:[],
        subsections:[
          {
            id:'ads', title:'Reklamalar',
            items:[
              { kind:'banner', title:'Reklama 1', mode:'html', sandbox:'allow-scripts allow-forms',
                contentHtml:'<section style="padding:24px;background:#fefbe7;border-radius:12px"><h2>Yangi kurs!</h2><p>Matematika intensiv kurslariga ro‚Äòyxatdan o‚Äòting.</p></section>'
              },
              { kind:'banner', title:'Partner url', mode:'url', src:'https://example.com/banner.html', sandbox:'allow-scripts' }
            ],
            subsections:[]
          },
          {
            id:'tests', title:'Online testlar',
            items:[
              { kind:'card', title:'Algebra ‚Äì 1-bosqich', cardStyle:'timed',
                startAt:'2025-11-05 09:00', endAt:'2025-11-10 23:59',
                infoHtml:'<p>Test 30 ta savoldan iborat. Vaqt chegaralangan.</p>',
                ctaLabel:'Boshlash', ctaHref:'https://leadermath.uz/tests/algebra1' },
              { kind:'card', title:'Geometriya ‚Äì Kirish testi', cardStyle:'simple',
                infoHtml:'<p>Oddiy demo test.</p>',
                ctaLabel:'Boshlash', ctaHref:'https://leadermath.uz/tests/geo-demo' },
              { kind:'card', title:'Kombinatorika maxsus', cardStyle:'soon',
                infoHtml:'<p>Yaqinda e‚Äôlon qilinadi. Tayyor bo‚Äòling!</p>',
                ctaLabel:'Batafsil', ctaHref:'' }
            ],
            subsections:[]
          },
          {
            id:'chsblar', title:'Chsblar',
            items:[
              { kind:'card', title:'Chsblar ‚Äî 1', cardStyle:'simple',
                infoHtml:'<p>Oddiy karta. Qisqa tavsif.</p>',
                ctaLabel:'Ko‚Äòrish', ctaHref:'#' },
              { kind:'card', title:'Chsblar ‚Äî 2', cardStyle:'simple',
                infoHtml:'<p>Yana bir oddiy card.</p>',
                ctaLabel:'Ko‚Äòrish', ctaHref:'#' }
            ],
            subsections:[]
          }
        ]
      };
      state.sections.push(sample);
      renderSectionTable();
      openSectionEditor(state.sections.length-1);
      alert('Namuna tuzilma qo‚Äòshildi ‚úÖ');
    }

    // ====== Init ======
    document.addEventListener('DOMContentLoaded', async ()=>{
      onAuthStateChanged(auth, async (u)=>{
        if(!guard(u)) return;
        const snap = await getDoc(doc(db,'configs','home'));
        state = snap.exists()? (snap.data()||{sections:[]}) : {sections:[]};
        if(!Array.isArray(state.sections)) state.sections=[];
        renderSectionTable();
        if(state.sections[0]) openSectionEditor(0);
      });

      document.getElementById('add_top').onclick = addTopSection;
      document.getElementById('download').onclick = downloadJson;
      document.getElementById('publish').onclick = publishToFirestore;
      document.getElementById('seed').onclick = seedExample;
      document.getElementById('loadfile').onchange = (e)=>{ const f=e.target.files[0]; if(f) loadFromFile(f); };
    });
  </script>
</head>
<body>
  <header>
    <div class="row">
      <div class="brand">LeaderMath ‚Äî Home Admin</div>
      <div class="rowflex" style="margin-left:auto" id="guard">
        <button id="glogin">Google bilan kiring</button>
      </div>
    </div>
  </header>

  <main>
    <div class="toolbar">
      <button id="add_top">+ Bo‚Äòlim qo‚Äòshish (top-level)</button>
      <label class="rowflex">JSON fayldan yuklash <input id="loadfile" type="file" accept="application/json"/></label>
      <button id="download">Yuklab olish (home.json)</button>
      <button id="publish" class="primary">Firestore‚Äôga chiqarish</button>
      <button id="seed">Namuna tuzilma qo‚Äòshish</button>
    </div>

    <div class="grid">
      <div class="card">
        <h3>Top-level bo‚Äòlimlar</h3>
        <div class="body">
          <table id="tbl-sections">
            <thead><tr><th>#</th><th>ID</th><th>Sarlavha</th><th>Ko‚Äòrinish</th><th>Actions</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="small" style="margin-top:8px">Eslatma: Har bir bo‚Äòlim ichida sub-bo‚Äòlimlar va itemlar (banner/card) bo‚Äòladi.</div>
        </div>
      </div>

      <div class="card">
        <h3>Tahrir</h3>
        <div class="body" id="editor">
          <div class="small">Chapdan bo‚Äòlim tanlang.</div>
        </div>
      </div>
    </div>
  </main>
</body>
</html>
