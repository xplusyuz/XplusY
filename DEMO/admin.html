<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LeaderMath — Chips Admin (PNG only)</title>
  <meta name="theme-color" content="#2E8B57"/>
  <style>
/* ===== THEME ===== */
:root[data-theme="light"]{
  --primary:#2E8B57;--accent:#6B8E23;
  --bg:#F6FBF8;--card:#FFFFFF;--bg-alt:#ECF5EF;
  --text:#102017;--muted:#5E7867;
  --line:#DFEAE3;--line2:#EAF3EE;
  --shadow:0 10px 30px rgba(46,139,87,.12);
  --shadow-sm:0 2px 8px rgba(46,139,87,.08);
  --gradient:linear-gradient(135deg,#2E8B57 0%,#6B8E23 100%);
}
:root[data-theme="dark"]{
  --primary:#4CBB7D;--accent:#8BCF5A;
  --bg:#0D1511;--card:#142019;--bg-alt:#111C16;
  --text:#EAF7EF;--muted:#A6C6B6;
  --line:#1E3329;--line2:#1B2B24;
  --shadow:0 28px 70px rgba(0,0,0,.55);
  --shadow-sm:0 2px 10px rgba(0,0,0,.35);
  --gradient:linear-gradient(135deg,#4CBB7D 0%,#8BCF5A 100%);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto;
  background:
    radial-gradient(1100px 800px at -5% -10%, rgba(46,139,87,.10), transparent 60%),
    radial-gradient(900px 700px at 110% 15%, rgba(107,142,35,.10), transparent 55%),
    var(--bg);
  color:var(--text);
  padding:22px; line-height:1.5;
}
h1{font-size:1.6rem;margin-bottom:12px}
h2{font-size:1.1rem;margin:14px 0 10px;color:var(--primary)}
p.muted{color:var(--muted);margin-bottom:18px}
.container{
  max-width:1200px;margin:0 auto;background:linear-gradient(180deg,var(--card), color-mix(in oklab, var(--card) 86%, var(--bg-alt) 14%));
  border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow); overflow:hidden;
}
.header{
  display:flex; align-items:center; justify-content:space-between; gap:14px;
  padding:16px 18px; border-bottom:1px solid var(--line);
}
.actions{display:flex;flex-wrap:wrap;gap:10px}
.btn{
  appearance:none; border:1px solid var(--line);
  background:linear-gradient(180deg,var(--card),color-mix(in oklab,var(--card) 74%, var(--bg-alt) 26%));
  color:var(--text); padding:.65rem .9rem; border-radius:10px; font-weight:800; cursor:pointer;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.35), var(--shadow-sm);
  transition:.2s;
}
.btn:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
.btn.pri{border:0;color:#fff;background:var(--gradient)}
.btn.warn{border-color:#e67e22;background:linear-gradient(180deg,#ffedd5,#ffe4c7)}
.btn.danger{border-color:#e74c3c;background:linear-gradient(180deg,#ffe0e0,#ffd6d6)}
.btn.ghost{background:transparent}
.switch{margin-left:auto}
.main{display:grid;grid-template-columns:1.3fr .7fr;gap:16px;padding:16px}
.panel{border:1px solid var(--line);border-radius:14px;padding:14px;background:var(--card)}
.row{display:grid;grid-template-columns:36px 150px 1fr 140px 40px;gap:10px;align-items:center;padding:8px;border-bottom:1px dashed var(--line2)}
.row:last-child{border-bottom:0}
.row.headerRow{font-weight:900;color:var(--muted);background:color-mix(in oklab, var(--card) 90%, var(--bg-alt) 10%);border-radius:10px}
.drag{cursor:grab;text-align:center;color:var(--muted)}
.iconPrev{width:34px;height:34px;border-radius:10px;border:1px solid var(--line);background:#fff center/contain no-repeat}
.inp,.sel,.ta{
  width:100%; padding:.6rem .7rem; border:1px solid var(--line); border-radius:10px;
  background:linear-gradient(180deg,var(--card),color-mix(in oklab,var(--card) 76%, var(--bg-alt) 24%));
  color:var(--text); font-weight:650; outline:none; transition:.15s;
}
.inp:focus,.sel:focus,.ta:focus{border-color:transparent; box-shadow:0 0 0 6px rgba(46,139,87,.12), inset 0 1px 0 rgba(255,255,255,.35)}
.small{font-size:.82rem;color:var(--muted)}
.ta{min-height:110px;resize:vertical}
.kv{display:flex;gap:8px;align-items:center}
.kv .file{display:none}
.kv .btn{padding:.45rem .7rem}
.del{color:#e74c3c;cursor:pointer;font-weight:900;text-align:center}
hr.sep{border:0;border-top:1px solid var(--line);margin:12px 0}
.previewHeader{display:flex;align-items:center;justify-content:space-between}
.iconChips{display:flex;gap:8px;flex-wrap:wrap;padding:8px}
.iconChip{
  --chip:56px;width:var(--chip);height:var(--chip);border-radius:50%;
  border:1px solid var(--line);
  background:radial-gradient(140% 140% at 20% 0%, rgba(255,255,255,.22) 0%, transparent 38%),
            linear-gradient(180deg, var(--card), color-mix(in oklab, var(--card) 72%, var(--bg-alt) 28%));
  display:flex;align-items:center;justify-content:center;box-shadow:inset 0 1px 0 rgba(255,255,255,.35),0 2px 8px rgba(46,139,87,.12);
}
.iconChips img{width:28px;height:28px;object-fit:contain}
.render{border:1px dashed var(--line);border-radius:12px;min-height:140px;padding:10px;margin-top:8px;background:linear-gradient(180deg,var(--card),color-mix(in oklab, var(--card) 86%, var(--bg-alt) 14%))}
.flex{display:flex;gap:8px;align-items:center}
.right{text-align:right}
footer{padding:10px 16px;border-top:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;color:var(--muted)}
.bad{color:#e74c3c;font-weight:800}
.good{color:#16a34a;font-weight:800}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>Chips Admin</h1>
        <p class="muted">Faqat <b>PNG</b> ikonli chiplar. JSON: <code>{ "chips": [...] }</code></p>
      </div>
      <div class="actions">
        <button id="btnTheme" class="btn">Kun/Tun</button>
        <button id="btnNew" class="btn pri">+ Yangi chip</button>
        <button id="btnImport" class="btn">Import JSON</button>
        <button id="btnExport" class="btn">Export JSON</button>
        <button id="btnSaveLS" class="btn">Saqlash (local)</button>
        <button id="btnReset" class="btn danger">Hammasini tozalash</button>
        <input id="fileImport" type="file" accept="application/json" style="display:none"/>
      </div>
    </div>

    <div class="main">
      <!-- Left: Editor -->
      <div class="panel" id="editor">
        <div class="row headerRow">
          <div class="drag">↕</div>
          <div>ID</div>
          <div>Ikon (PNG yo‘l yoki data URL)</div>
          <div>Fayl</div>
          <div>—</div>
        </div>
        <div id="rows"></div>
        <hr class="sep"/>
        <div>
          <h2>Tanlangan chip HTML</h2>
          <textarea id="htmlEditor" class="ta" placeholder="Bu yerga chip HTML yozing..."></textarea>
          <div class="right" style="margin-top:8px">
            <span id="pngCheck" class="small"></span>
          </div>
        </div>
      </div>

      <!-- Right: Preview -->
      <div class="panel">
        <div class="previewHeader">
          <h2>Preview</h2>
          <div class="flex">
            <span class="small">Aktiv chip:</span>
            <select id="selActive" class="sel"></select>
            <button id="btnRender" class="btn pri">Render</button>
          </div>
        </div>
        <div id="chipsPreview" class="iconChips"></div>
        <div id="renderArea" class="render"><div class="small">HTML natija shu yerda chiqadi</div></div>
      </div>
    </div>

    <footer>
      <div>Holat: <span id="status" class="small">—</span></div>
      <div><span class="small">Hotkeylar: <b>Ctrl/Cmd + S</b> — Local saqlash, <b>Ctrl/Cmd + B</b> — Render</span></div>
    </footer>
  </div>

<script>
/* ========= State ========= */
let model = { chips: [] };
let activeIndex = -1;

/* ========= Helpers ========= */
const $ = s => document.querySelector(s);
const esc = s => String(s||'').replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
const isPngPath = (p='') => /\.png(\?.*)?$/i.test(p.trim());
const isPngDataUrl = (p='') => /^data:image\/png;base64,/i.test(p.trim());
const isPng = p => isPngPath(p) || isPngDataUrl(p);
const uid = () => Math.random().toString(36).slice(2,9);

/* ========= UI Builders ========= */
function makeRow(c, i){
  const row = document.createElement('div');
  row.className = 'row';
  row.draggable = true;
  row.dataset.idx = i;

  row.innerHTML = `
    <div class="drag" title="Tartiblash">≡</div>
    <input class="inp id" placeholder="id (ixtiyoriy)" value="${esc(c.id||'')}"/>
    <div class="kv">
      <div class="iconPrev" style="background-image:url('${esc(c.icon||'')}')"></div>
      <input class="inp icon" placeholder="./icons/name.png yoki data:image/png;base64,..." value="${esc(c.icon||'')}"/>
    </div>
    <div class="kv">
      <input class="file" type="file" accept="image/png"/>
      <button class="btn pick">PNG yuklash</button>
      <button class="btn ghost paste">Paste (Ctrl+V)</button>
    </div>
    <div class="del" title="O'chirish">✕</div>
  `;

  // events
  row.querySelector('.id').addEventListener('input', e=>{
    model.chips[i].id = e.target.value.trim();
    refreshSelect();
    setStatus('ID yangilandi');
  });

  const iconInput = row.querySelector('.icon');
  const iconPrev = row.querySelector('.iconPrev');
  iconInput.addEventListener('input', e=>{
    model.chips[i].icon = e.target.value.trim();
    iconPrev.style.backgroundImage = `url('${model.chips[i].icon||''}')`;
    validateIcons();
  });

  const file = row.querySelector('.file');
  row.querySelector('.pick').onclick = ()=> file.click();
  file.onchange = async (e)=>{
    const f = e.target.files[0];
    if(!f) return;
    if(f.type!=='image/png'){ alert('Faqat PNG ruxsat'); return; }
    const dataUrl = await fileToDataUrl(f);
    model.chips[i].icon = dataUrl;
    iconInput.value = dataUrl;
    iconPrev.style.backgroundImage = `url('${dataUrl}')`;
    validateIcons();
  };
  row.querySelector('.paste').onclick = ()=> {
    navigator.clipboard.readText().then(txt=>{
      if(!txt) return;
      model.chips[i].icon = txt.trim();
      iconInput.value = model.chips[i].icon;
      iconPrev.style.backgroundImage = `url('${model.chips[i].icon}')`;
      validateIcons();
    }).catch(()=>alert('Clipboarddan o‘qib bo‘lmadi'));
  };

  row.querySelector('.del').onclick = ()=>{
    if(!confirm('Bu chipni o‘chirasizmi?')) return;
    model.chips.splice(i,1);
    if(activeIndex>=model.chips.length) activeIndex = model.chips.length-1;
    renderAll();
    setStatus('Chip o‘chirildi');
  };

  // drag and drop
  row.addEventListener('dragstart', (e)=>{
    row.classList.add('dragging');
    e.dataTransfer.setData('text/plain', i.toString());
  });
  row.addEventListener('dragend', ()=>{
    row.classList.remove('dragging');
  });
  row.addEventListener('dragover', (e)=>{
    e.preventDefault();
    const from = parseInt(document.querySelector('.row.dragging')?.dataset.idx||-1,10);
    const to = i;
    if(from<0 || from===to) return;
    // visual guide
  });
  row.addEventListener('drop', (e)=>{
    e.preventDefault();
    const from = parseInt(e.dataTransfer.getData('text/plain')||-1,10);
    const to = i;
    if(from<0 || to<0 || from===to) return;
    const [moved] = model.chips.splice(from,1);
    model.chips.splice(to,0,moved);
    if(activeIndex===from) activeIndex = to;
    else if(from<activeIndex && to>=activeIndex) activeIndex--;
    else if(from>activeIndex && to<=activeIndex) activeIndex++;
    renderAll();
    setStatus('Tartib o‘zgardi');
  });

  row.addEventListener('click', ()=>{
    activeIndex = i;
    refreshSelect();
    loadHtmlEditor();
    renderPreviewChips();
  });

  return row;
}

function renderRows(){
  const host = $('#rows');
  host.innerHTML = '';
  model.chips.forEach((c,i)=> host.appendChild(makeRow(c,i)));
}

function refreshSelect(){
  const sel = $('#selActive');
  const prev = sel.value;
  sel.innerHTML = model.chips.map((c,i)=>`<option value="${i}" ${i===activeIndex?'selected':''}>${esc(c.id||`chip-${i+1}`)}</option>`).join('');
  if(prev && sel.querySelector(`option[value="${prev}"]`)) sel.value = prev;
}

function renderPreviewChips(){
  const wrap = $('#chipsPreview');
  wrap.innerHTML = model.chips.map((c,i)=>`
    <button class="iconChip" data-i="${i}" title="${esc(c.id||c.icon||'chip')}">
      <img src="${esc(c.icon||'')}" alt="icon"/>
    </button>
  `).join('');

  wrap.querySelectorAll('button').forEach(b=>{
    b.onclick = ()=>{
      activeIndex = parseInt(b.dataset.i,10);
      refreshSelect();
      loadHtmlEditor();
      renderOne();
    };
  });
}

function loadHtmlEditor(){
  const ta = $('#htmlEditor');
  ta.value = (model.chips[activeIndex]?.html)||'';
  updatePngCheck(activeIndex);
}

function renderOne(){
  const area = $('#renderArea');
  const c = model.chips[activeIndex];
  area.innerHTML = c ? (c.html||'<div class="small">HTML yo‘q</div>') : '<div class="small">Chip tanlanmagan</div>';

  // scriptlarni qayta ishga tushirish
  if(c && c.html){
    const tmp = document.createElement('div');
    tmp.innerHTML = c.html;
    tmp.querySelectorAll('script').forEach(old=>{
      const s=document.createElement('script');
      for (const a of old.attributes) s.setAttribute(a.name,a.value);
      s.textContent=old.textContent; document.body.appendChild(s);
      setTimeout(()=>s.remove(),0);
    });
  }
}

/* ========= Actions ========= */
$('#btnNew').onclick = ()=>{
  model.chips.push({ id:'', icon:'', html:'' });
  activeIndex = model.chips.length-1;
  renderAll();
  setStatus('Yangi chip qo‘shildi');
};

$('#btnImport').onclick = ()=> $('#fileImport').click();
$('#fileImport').onchange = async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  try{
    const text = await f.text();
    const json = JSON.parse(text);
    if(!json || !Array.isArray(json.chips)) throw new Error('Noto‘g‘ri format');
    model = { chips: json.chips.map(sanitizeChip) };
    activeIndex = model.chips.length ? 0 : -1;
    renderAll();
    setStatus('JSON import qilindi');
  }catch(err){
    alert('Import xatosi: '+err.message);
  }finally{
    e.target.value = '';
  }
};

$('#btnExport').onclick = ()=>{
  const blob = new Blob([JSON.stringify({chips:model.chips}, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'admin.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  setStatus('admin.json yuklab olindi');
};

$('#btnSaveLS').onclick = ()=>{
  localStorage.setItem('admin-json', JSON.stringify({chips:model.chips}));
  setStatus('LocalStorage ga saqlandi');
};

$('#btnReset').onclick = ()=>{
  if(!confirm('Barcha chiplarni o‘chirishni tasdiqlaysizmi?')) return;
  model = { chips: [] };
  activeIndex = -1;
  renderAll();
  setStatus('Tozalandi');
};

$('#btnRender').onclick = ()=>{ saveHtmlFromEditor(); renderOne(); setStatus('Render qilindi'); };
$('#htmlEditor').addEventListener('input', ()=>{
  if(activeIndex>=0){ model.chips[activeIndex].html = $('#htmlEditor').value; }
});
$('#htmlEditor').addEventListener('blur', saveHtmlFromEditor);

function saveHtmlFromEditor(){
  if(activeIndex>=0){ model.chips[activeIndex].html = $('#htmlEditor').value; }
}

$('#selActive').onchange = (e)=>{
  activeIndex = parseInt(e.target.value,10);
  loadHtmlEditor();
  renderOne();
};

$('#btnTheme').onclick = ()=>{
  const cur = document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark';
  document.documentElement.setAttribute('data-theme',cur);
  setStatus('Tema o‘zgardi: '+cur);
};

document.addEventListener('keydown', (e)=>{
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); $('#btnSaveLS').click(); }
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='b'){ e.preventDefault(); $('#btnRender').click(); }
});

/* ========= Validatsiya ========= */
function sanitizeChip(c){
  const id = (c?.id||'').toString();
  const icon = (c?.icon||'').toString();
  const html = (c?.html||'').toString();
  return { id, icon, html };
}
function validateIcons(){
  const allOk = model.chips.every(c=>!c.icon || isPng(c.icon));
  const anyBad = model.chips.some(c=>c.icon && !isPng(c.icon));
  const lab = $('#pngCheck');
  if(anyBad){ lab.textContent = 'Ba’zi ikonlar PNG emas'; lab.className='small bad'; }
  else if(allOk){ lab.textContent = 'Barcha ikonlar PNG ✅'; lab.className='small good'; }
  else { lab.textContent=''; lab.className='small'; }
}
function updatePngCheck(i){
  const c = model.chips[i];
  const lab = $('#pngCheck');
  if(!c){ lab.textContent=''; lab.className='small'; return; }
  if(!c.icon){ lab.textContent='Ikon yo‘q'; lab.className='small'; return; }
  if(isPng(c.icon)){ lab.textContent='PNG ✅'; lab.className='small good'; }
  else{ lab.textContent='PNG emas'; lab.className='small bad'; }
}

/* ========= Files ========= */
function fileToDataUrl(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload = ()=>res(fr.result);
    fr.onerror = rej;
    fr.readAsDataURL(file);
  });
}

/* ========= Render all ========= */
function renderAll(){
  renderRows();
  refreshSelect();
  renderPreviewChips();
  loadHtmlEditor();
  renderOne();
  validateIcons();
}

/* ========= Init ========= */
(function init(){
  // 1) localStorage dan o‘qish
  try{
    const saved = JSON.parse(localStorage.getItem('admin-json')||'null');
    if(saved && Array.isArray(saved.chips)) model = { chips: saved.chips.map(sanitizeChip) };
  }catch{}
  // 2) serverdan admin.json ni yuklab ko‘rish (ixtiyoriy, 404 bo‘lsa e’tibor bermaydi)
  fetch('./admin.json', {cache:'no-store'}).then(r=>{
    if(!r.ok) return null; return r.json();
  }).then(json=>{
    if(json && Array.isArray(json.chips)) model = { chips: json.chips.map(sanitizeChip) };
  }).catch(()=>{}).finally(()=>{
    activeIndex = model.chips.length ? 0 : -1;
    renderAll();
    setStatus('Tayyor');
  });
})();

function setStatus(msg){ $('#status').textContent = msg; }
</script>
</body>
</html>
