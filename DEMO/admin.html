<!doctype html>
<html lang="uz">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>LeaderMath Admin â€” Premium Glass Panel (Pro)</title>
<meta name="theme-color" content="#2E8B57">
<link rel="icon" href="./favicon.png">
<!-- XLSX for Excel import/export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root{
  --brand:#2E8B57;--brand2:#1F6B45;
  --bg:#f4f8f6;--card:#fff;--text:#0d1b14;--muted:#375c4c;
  --frame:#d8e7dd;--ring:#8ad1b1;--radius:16px;
}
:root.dark{
  --bg:#0e1512;--card:#142018;--text:#EAF7EE;--muted:#A5C7B4;
  --frame:#1e4234;--ring:#2fbf7d;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
body{background:var(--bg);color:var(--text);padding-bottom:120px;}

/* HEADER */
header{
  position:sticky;top:0;z-index:50;
  background:linear-gradient(135deg,var(--brand),var(--brand2));
  color:#fff;display:flex;align-items:center;justify-content:space-between;
  padding:14px 20px;box-shadow:0 6px 16px rgba(0,0,0,.15);
}
header h1{font-size:18px;font-weight:900;margin:0;}
header .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.btn{border:none;border-radius:12px;padding:9px 14px;font-weight:800;cursor:pointer;transition:.15s;}
.btn:hover{opacity:.92;}
.btn.primary{background:#fff;color:var(--brand2);}
.btn.danger{background:#d9534f;color:#fff;}
.btn.ghost{background:transparent;border:1px solid #fff;color:#fff;}
.btn.line{border:1px solid var(--frame);background:var(--card);color:var(--text)}
#themeToggle{font-size:20px;cursor:pointer}

/* LAYOUT */
.container{max-width:1200px;margin:20px auto;padding:0 14px;display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
@media(max-width:1000px){.container{grid-template-columns:1fr}}
.card{
  background:var(--card);border:1px solid var(--frame);border-radius:var(--radius);
  box-shadow:0 8px 22px rgba(0,0,0,.08);padding:16px 18px;
}
.card h2{font-size:18px;margin-bottom:10px;font-weight:900;}
label{font-size:12px;opacity:.75;}
input,textarea,select{
  width:100%;padding:9px 10px;border-radius:10px;border:1px solid var(--frame);
  font:inherit;background:var(--bg);color:var(--text);
}
textarea{min-height:80px;resize:vertical;}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px}
.row>*{flex:1}
.list{margin:6px 0}
.item{
  border:1px dashed var(--frame);border-radius:12px;background:var(--card);
  padding:10px;display:flex;gap:10px;align-items:center;justify-content:space-between;margin:8px 0
}
.handle{cursor:grab;font-size:18px;user-select:none}
.small{font-size:12px;opacity:.75}
pre{
  background:#0b1b15;color:#d8ffe8;font-size:12.5px;padding:12px;
  border-radius:12px;overflow:auto;max-height:420px
}
.dark pre{background:#13261f;color:#d8ffe8}

/* PREVIEW */
.previewBox{display:flex;flex-direction:column;gap:12px}
.previewArea{
  border:1px solid var(--frame);border-radius:14px;overflow:hidden;background:var(--card)
}
.story{position:relative;border-radius:14px;overflow:hidden;background:linear-gradient(135deg,#f0fff6,#e7f6ee)}
.dark .story{background:linear-gradient(135deg,#122019,#0f1714)}
.story-track{display:flex;will-change:transform;transition:transform .25s ease}
.story-slide{min-width:100%;padding:20px}
.story-progress{position:absolute;top:8px;left:8px;right:8px;display:flex;gap:6px}
.story-bar{flex:1;height:4px;background:#ffffff66;border-radius:999px;overflow:hidden}
.story-bar>span{display:block;height:100%;width:0;background:#fff}

.cardPrev{padding:12px}
.cardPrev .cover{position:relative;aspect-ratio:16/9;display:grid;place-items:center;background:#000;color:#fff}
.cardPrev .cover img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.cardPrev .cover .title{position:relative;font-size:28px;font-weight:1000;text-shadow:0 10px 24px rgba(0,0,0,.5);padding:0 10px;text-align:center}
.cardPrev .veil{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,.05),rgba(0,0,0,.55));backdrop-filter:blur(6px);color:#fff;gap:8px}
.badge{display:inline-flex;gap:8px;border:1px solid #ffffff66;background:#ffffff22;color:#fff;border-radius:999px;padding:6px 10px;font-weight:900}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.btn-lite{border:1px solid var(--frame);border-radius:10px;background:linear-gradient(180deg,#fff,#f5faf7);color:var(--brand2);padding:8px 12px;font-weight:800;cursor:pointer;text-decoration:none}
.dark .btn-lite{background:linear-gradient(180deg,#17261f,#16241d);color:#c8f0dc;border-color:#2a5742}

/* FLOAT */
.floatR{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:10px;z-index:100}
.floatR .fab{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;border:none;border-radius:999px;padding:12px 14px;font-weight:900;box-shadow:0 10px 24px rgba(0,0,0,.25);cursor:pointer}
</style>
</head>
<body>
<header>
  <h1>LeaderMath â€” Admin Panel (Pro)</h1>
  <div class="actions">
    <button id="importXlsx" class="btn ghost">Import XLSX</button>
    <button id="exportXlsx" class="btn primary">Export XLSX</button>
    <button id="importCsv" class="btn ghost">Import CSV</button>
    <button id="exportCsv" class="btn line">Export CSV</button>
    <button id="exportJson" class="btn line">Export JSON</button>
    <span id="themeToggle">ğŸŒ™</span>
    <input id="fileXlsx" type="file" accept=".xlsx" hidden>
    <input id="fileCsvBanners" type="file" accept=".csv" hidden>
    <input id="fileCsvSections" type="file" accept=".csv" hidden>
  </div>
</header>

<div class="container">
  <!-- LEFT: Data editors -->
  <div class="leftCol">
    <!-- Banner Groups -->
    <div class="card">
      <h2>ğŸ¬ Banner Guruhlari (Story)</h2>
      <div class="row">
        <input id="bgTag" placeholder="Masalan: CHSB">
        <button id="bgAdd" class="btn">â• Guruh qoâ€˜shish</button>
      </div>
      <div id="bgList" class="list"></div>
    </div>

    <!-- Sections -->
    <div class="card">
      <h2>ğŸ“š Boâ€˜limlar & Cardâ€™lar</h2>
      <div class="row">
        <input id="secTitle" placeholder="Boâ€˜lim sarlavhasi (Masalan: Matematika testlar)">
        <input id="secTag" placeholder="Katta teg (Masalan: Algebra)">
        <button id="secAdd" class="btn">â• Boâ€˜lim qoâ€˜shish</button>
      </div>
      <div id="secList" class="list"></div>

      <!-- Card form -->
      <div class="row"><strong>Oxirgi tanlangan boâ€˜limga card qoâ€˜shish</strong></div>
      <div class="row">
        <input id="cName" placeholder="Card nomi">
        <input id="cDesc" placeholder="Tavsif">
      </div>
      <div class="row">
        <input id="cImg" placeholder="Rasm URL (ixtiyoriy)">
        <select id="cType">
          <option value="open">open</option>
          <option value="coming_soon">coming_soon</option>
          <option value="window">window</option>
        </select>
      </div>
      <div class="row">
        <input id="cStart" type="datetime-local">
        <input id="cEnd" type="datetime-local">
        <input id="cTags" placeholder="Teglar (vergul bilan)">
      </div>
      <div class="row">
        <button id="cAdd" class="btn">â• Card qoâ€˜shish</button>
      </div>

      <!-- Buttons to card -->
      <div class="row"><strong>Oxirgi cardâ€™ga tugma qoâ€˜shish</strong></div>
      <div class="row">
        <select id="bKind">
          <option value="link">link</option>
          <option value="modal">modal</option>
        </select>
        <input id="bLabel" placeholder="Label (Boshlash / Koâ€˜rsatma)">
      </div>
      <div class="row">
        <input id="bHref" placeholder="Href (link uchun)">
        <textarea id="bHtml" placeholder="HTML (modal uchun)"></textarea>
      </div>
      <div class="row">
        <button id="bAdd" class="btn">â• Tugma qoâ€˜shish</button>
      </div>
    </div>

    <!-- JSON Preview -->
    <div class="card">
      <h2>ğŸ§¾ JSON Preview</h2>
      <pre id="preview">{}</pre>
    </div>
  </div>

  <!-- RIGHT: Live preview -->
  <div class="rightCol">
    <div class="card">
      <h2>ğŸ‘ï¸ Live Preview â€” Banner (Story)</h2>
      <div class="row small">â€œTanlangan guruhâ€ tugmasini bosing â†’ story ishlaydi</div>
      <div id="bannerPreview" class="previewArea">
        <div class="story">
          <div class="story-progress" id="bpProg"></div>
          <div class="story-track" id="bpTrack"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>ğŸ§© Live Preview â€” Card</h2>
      <div id="cardPreview" class="previewArea cardPrev">
        <div class="cover">
          <div class="title">Card nomi</div>
        </div>
        <div style="padding:12px">
          <h3 style="margin:0 0 6px">Card nomi</h3>
          <p class="small">Tavsif</p>
          <div class="actions">
            <a class="btn-lite" href="#">Link</a>
            <button class="btn-lite" id="openModal">Modal</button>
          </div>
        </div>
      </div>
    </div>

    <!-- HTML modal viewer -->
    <div id="htmlModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000;align-items:center;justify-content:center">
      <div style="width:min(900px,96vw);max-height:90vh;background:var(--card);border:1px solid var(--frame);border-radius:14px;overflow:hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--frame)">
          <b>Modal Preview</b>
          <button id="closeModal" class="btn line">Yopish</button>
        </div>
        <iframe id="htmlFrame" sandbox="allow-forms allow-scripts allow-same-origin" style="width:100%;height:min(70vh,700px);border:0;background:#fff"></iframe>
        <div style="padding:10px;border-top:1px solid var(--frame);display:flex;justify-content:flex-end;gap:8px">
          <button id="copyModalHtml" class="btn">HTMLâ€™ni nusxalash</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Floating quick actions -->
<div class="floatR">
  <button id="toTop" class="fab">â†‘ Yuqoriga</button>
</div>

<script>
/* =========================
   STATE
========================= */
let DATA={ bannerGroups:[], sections:[] };
let lastSectionIndex = -1;  // oxirgi tahrirlangan boâ€˜lim
let lastCardIndex = -1;     // oxirgi tahrirlangan card (shu boâ€˜lim ichida)

/* =========================
   HELPERS
========================= */
const $ = sel => document.querySelector(sel);
const escapeHtml = s => String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
function toISO(dtLocal){ return dtLocal? new Date(dtLocal).toISOString(): undefined; }
function fmt(obj){ return JSON.stringify(obj,null,2); }
function download(filename, text, mime='text/plain'){
  const blob = new Blob([text], {type:mime});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href);
}
function parseCSV(text){
  // juda oddiy CSV parser ("" qoâ€˜shtirnoqni qisman qoâ€˜llab-quvvatlaydi)
  const rows=[]; let i=0, cur='', inQ=false; const push=()=>{ rows.at(-1).push(cur); cur=''; };
  rows.push([]);
  for(;i<text.length;i++){
    const c=text[i], n=text[i+1];
    if(inQ){
      if(c=='"' && n=='"'){ cur+='"'; i++; continue; }
      if(c=='"'){ inQ=false; continue; }
      cur+=c; continue;
    }else{
      if(c=='"'){ inQ=true; continue; }
      if(c==','){ push(); continue; }
      if(c=='\n'){ push(); rows.push([]); continue; }
      if(c=='\r') continue;
      cur+=c;
    }
  }
  push();
  // remove last empty row if present
  if(rows.at(-1).length===1 && rows.at(-1)[0]==='') rows.pop();
  return rows;
}
function toCSV(rows){
  return rows.map(r=> r.map(v=>{
    const s=String(v??'');
    return (s.includes(',')||s.includes('"')||s.includes('\n'))?('"'+s.replace(/"/g,'""')+'"'):s;
  }).join(',')).join('\n');
}

/* =========================
   RENDER â€” JSON PREVIEW
========================= */
function refreshPreview(){ $('#preview').textContent = fmt(DATA); }

/* =========================
   RENDER â€” BANNERS
========================= */
function renderBannerList(){
  const wrap = $('#bgList'); wrap.innerHTML='';
  DATA.bannerGroups.forEach((g,gi)=>{
    const item=document.createElement('div'); item.className='item'; item.draggable=true; item.dataset.type='bg'; item.dataset.index=gi;
    item.innerHTML=`
      <div class="handle">â ¿</div>
      <div style="flex:1">
        <div><b>${escapeHtml(g.tag||'â€”')}</b> <span class="small">(${(g.items||[]).length} banner)</span></div>
        <div class="row" style="margin-top:6px">
          <input placeholder="Banner HTML" id="bhtml${gi}">
          <input placeholder="durationMs (5000)" id="bdur${gi}" type="number" min="500" step="100">
          <button class="btn" id="badd${gi}">â• Banner qoâ€˜shish</button>
          <button class="btn line" id="bprev${gi}">â–¶ï¸ Tanlab preview</button>
        </div>
        <div class="list" id="bitems${gi}"></div>
      </div>
      <div>
        <button class="btn danger" id="bdel${gi}">ğŸ—‘</button>
      </div>
    `;
    wrap.appendChild(item);

    // bannerlar roâ€˜yxati (drag)
    const list = item.querySelector(`#bitems${gi}`);
    (g.items||[]).forEach((it,bi)=>{
      const row=document.createElement('div'); row.className='item'; row.draggable=true; row.dataset.type='bitem'; row.dataset.bg=gi; row.dataset.index=bi;
      row.innerHTML=`<div class="handle">â†•</div>
        <div style="flex:1"><span class="small">#${bi+1}</span> <span>(ms:${it.durationMs||5000})</span></div>
        <div>
          <button class="btn line" data-act="edit">âœï¸</button>
          <button class="btn danger" data-act="del">ğŸ—‘</button>
        </div>`;
      list.appendChild(row);
    });

    // qoâ€˜shish
    item.querySelector(`#badd${gi}`).onclick=()=>{
      const html=item.querySelector(`#bhtml${gi}`).value.trim();
      const ms=Number(item.querySelector(`#bdur${gi}`).value||5000);
      if(!html) return alert('HTML kerak');
      (g.items||(g.items=[])).push({html:html, durationMs:ms});
      renderBannerList(); refreshPreview();
    };
    // tanlab preview
    item.querySelector(`#bprev${gi}`).onclick=()=> mountBannerPreview(g);

    // guruhni oâ€˜chirish
    item.querySelector(`#bdel${gi}`).onclick=()=>{
      if(!confirm('Guruhni oâ€˜chirish?'))return;
      DATA.bannerGroups.splice(gi,1);
      renderBannerList(); refreshPreview();
    };

    // banner item edit/del
    list.onclick=(e)=>{
      const btn=e.target.closest('button'); if(!btn) return;
      const row=e.target.closest('.item'); if(!row) return;
      const bi=Number(row.dataset.index);
      if(btn.dataset.act==='del'){
        g.items.splice(bi,1); renderBannerList(); refreshPreview();
      }else{
        const it=g.items[bi];
        const newMs = prompt('durationMs', String(it.durationMs||5000));
        const newHtml= prompt('HTML', it.html||'');
        if(newHtml!=null){ it.html=newHtml; }
        if(newMs!=null){ const n=Number(newMs); if(!Number.isNaN(n)) it.durationMs=n; }
        renderBannerList(); refreshPreview();
      }
    };
  });

  bindDrag(wrap, (a,b)=>{
    // swap banner groups aâ†”b
    const tmp=DATA.bannerGroups[a]; DATA.bannerGroups[a]=DATA.bannerGroups[b]; DATA.bannerGroups[b]=tmp;
    renderBannerList(); refreshPreview();
  }, {selector:'.item[data-type="bg"]'});

  // drag for banner items per group
  DATA.bannerGroups.forEach((g,gi)=>{
    const list = document.querySelector(`#bitems${gi}`);
    if(!list) return;
    bindDrag(list, (from,to)=>{
      const arr=g.items; const el=arr.splice(from,1)[0]; arr.splice(to,0,el);
      renderBannerList(); refreshPreview();
    }, {selector:'.item[data-type="bitem"]', scope:'bitems'+gi});
  });
}

/* =========================
   RENDER â€” SECTIONS + CARDS
========================= */
function renderSections(){
  const wrap = $('#secList'); wrap.innerHTML='';
  DATA.sections.forEach((s,si)=>{
    const item=document.createElement('div'); item.className='item'; item.draggable=true; item.dataset.type='sec'; item.dataset.index=si;
    item.innerHTML=`
      <div class="handle">â ¿</div>
      <div style="flex:1">
        <div><b>${escapeHtml(s.title||'â€”')}</b> â€” <i>${escapeHtml(s.tag||'')}</i> <span class="small">(${(s.items||[]).length} card)</span></div>
        <div class="row" style="margin-top:6px">
          <button class="btn line" id="sel${si}">ğŸ¯ Tanlash</button>
          <button class="btn" id="ren${si}">âœï¸ Nomini oâ€˜zgartir</button>
        </div>
        <div class="list" id="cards${si}"></div>
      </div>
      <div>
        <button class="btn danger" id="sdel${si}">ğŸ—‘</button>
      </div>
    `;
    wrap.appendChild(item);

    // cards
    const list=item.querySelector(`#cards${si}`);
    (s.items||[]).forEach((c,ci)=>{
      const row=document.createElement('div'); row.className='item'; row.draggable=true; row.dataset.type='card'; row.dataset.sec=si; row.dataset.index=ci;
      row.innerHTML=`
        <div class="handle">â†•</div>
        <div style="flex:1"><b>${escapeHtml(c.name||'Card')}</b> <span class="small">(${escapeHtml(c.type||'open')})</span></div>
        <div>
          <button class="btn line" data-act="prev">ğŸ‘ï¸</button>
          <button class="btn line" data-act="edit">âœï¸</button>
          <button class="btn danger" data-act="del">ğŸ—‘</button>
        </div>`;
      list.appendChild(row);
    });

    // actions
    item.querySelector(`#sel${si}`).onclick=()=>{ lastSectionIndex=si; lastCardIndex=-1; alert('Tanlandi: '+(s.title||'Boâ€˜lim')); };
    item.querySelector(`#ren${si}`).onclick=()=>{
      const nt=prompt('Boâ€˜lim sarlavhasi', s.title||''); if(nt!=null) s.title=nt;
      const tg=prompt('Katta teg', s.tag||''); if(tg!=null) s.tag=tg;
      renderSections(); refreshPreview();
    };
    item.querySelector(`#sdel${si}`).onclick=()=>{
      if(!confirm('Boâ€˜limni oâ€˜chirish?'))return;
      DATA.sections.splice(si,1);
      if(lastSectionIndex===si){ lastSectionIndex=-1; lastCardIndex=-1; }
      renderSections(); refreshPreview();
    };

    // cards click
    list.onclick=(e)=>{
      const btn=e.target.closest('button'); if(!btn) return;
      const row=e.target.closest('.item'); const ci=Number(row.dataset.index);
      const card=s.items[ci];
      if(btn.dataset.act==='del'){
        if(!confirm('Cardni oâ€˜chirish?'))return; s.items.splice(ci,1);
        renderSections(); refreshPreview();
      }else if(btn.dataset.act==='edit'){
        editCardPrompt(card, ()=>{ renderSections(); refreshPreview(); });
      }else{
        previewCard(card);
        lastSectionIndex=si; lastCardIndex=ci;
      }
    };
  });

  // drag sections order
  bindDrag(wrap, (from,to)=>{
    const arr=DATA.sections; const x=arr.splice(from,1)[0]; arr.splice(to,0,x);
    renderSections(); refreshPreview();
  }, {selector:'.item[data-type="sec"]'});

  // drag cards inside each section
  DATA.sections.forEach((s,si)=>{
    const list=document.querySelector(`#cards${si}`); if(!list) return;
    bindDrag(list, (from,to)=>{
      const arr=s.items; const x=arr.splice(from,1)[0]; arr.splice(to,0,x);
      renderSections(); refreshPreview();
    }, {selector:'.item[data-type="card"]', scope:'cards'+si});
  });
}

/* =========================
   DRAG CORE (native DnD)
========================= */
function bindDrag(container, onSwap, {selector='.item', scope='global'}={}){
  let dragEl=null, startIndex=-1;
  container.querySelectorAll(selector).forEach((el,idx)=>{
    el.setAttribute('draggable','true');
    el.addEventListener('dragstart',(e)=>{ dragEl=el; startIndex=idx; e.dataTransfer.effectAllowed='move'; });
    el.addEventListener('dragover',(e)=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; });
    el.addEventListener('drop',(e)=>{
      e.preventDefault();
      const nodes=[...container.querySelectorAll(selector)];
      const from=nodes.indexOf(dragEl); const to=nodes.indexOf(el);
      if(from>=0 && to>=0 && from!==to) onSwap(from,to);
      dragEl=null; startIndex=-1;
    });
  });
}

/* =========================
   LIVE PREVIEW â€” Banner
========================= */
function mountBannerPreview(group){
  const track=$('#bpTrack'), prog=$('#bpProg');
  track.innerHTML=''; prog.innerHTML='';
  if(!group || !group.items || !group.items.length){ track.innerHTML='<div class="story-slide"><h3 style="margin:0">Banner yoâ€˜q</h3></div>'; return; }
  group.items.forEach(it=>{
    const s=document.createElement('div'); s.className='story-slide'; s.innerHTML=it.html||''; track.appendChild(s);
    const b=document.createElement('div'); b.className='story-bar'; b.innerHTML='<span></span>'; prog.appendChild(b);
  });
  let i=0, playing=true, raf=null, start=0;
  const spans=[...prog.querySelectorAll('span')];
  const dur=()=>Math.max(1200, Number(group.items[i]?.durationMs||4500));
  const setX=()=> track.style.transform=`translateX(${-i*100}%)`;
  const step=()=>{
    const p=Math.min(1,(performance.now()-start)/dur()); spans[i].style.width=(p*100)+'%';
    if(p<1 && playing) raf=requestAnimationFrame(step);
    else{ spans[i].style.width='100%'; if(i<group.items.length-1){ i++; setX(); start=performance.now(); raf=requestAnimationFrame(step);} }
  };
  setX(); start=performance.now(); raf=requestAnimationFrame(step);
}

/* =========================
   LIVE PREVIEW â€” Card
========================= */
function previewCard(c){
  const prev=$('#cardPreview'); prev.innerHTML='';
  const cover=document.createElement('div'); cover.className='cover';
  if(c.image){ cover.innerHTML=`<img src="${escapeHtml(c.image)}" alt="">`; }
  else{ cover.innerHTML=`<div class="title">${escapeHtml(c.name||'')}</div>`; }
  const veil=document.createElement('div'); veil.className='veil'; veil.style.display='none';
  veil.innerHTML=`<div class="badge">â³ Tez kunda</div><div style="font-weight:1000;font-size:22px">Qolgan vaqt</div>`;
  cover.appendChild(veil);

  const body=document.createElement('div'); body.style.padding='12px';
  body.innerHTML=`<h3 style="margin:0 0 6px">${escapeHtml(c.name||'')}</h3><p class="small">${escapeHtml(c.description||'')}</p>`;
  const acts=document.createElement('div'); acts.className='actions';

  (c.buttons||[]).forEach(btn=>{
    if(btn.kind==='link'){
      const a=document.createElement('a'); a.className='btn-lite'; a.href=btn.href||'#'; a.textContent=btn.label||'Link';
      acts.appendChild(a);
    }else{
      const b=document.createElement('button'); b.className='btn-lite'; b.textContent=btn.label||'Modal';
      b.onclick=()=>openModalHtml(btn.html||'');
      acts.appendChild(b);
    }
  });
  body.appendChild(acts);

  prev.appendChild(cover); prev.appendChild(body);

  // status overlay (coming_soon / window)
  const t=c.type||'open';
  if(t==='coming_soon'){ veil.style.display='flex'; veil.querySelector('.badge').textContent='â³ Tez kunda'; }
  else if(t==='window'){
    const start = c.startAt? new Date(c.startAt).getTime():0;
    const now=Date.now(); if(now<start){ veil.style.display='flex'; veil.querySelector('.badge').textContent='ğŸ”’ Boshlanishiga'; }
  }
}
function openModalHtml(html){
  $('#htmlModal').style.display='flex';
  $('#htmlFrame').srcdoc = `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>body{font:16px/1.5 system-ui;padding:14px}</style></head><body>${html||''}</body></html>`;
}
$('#closeModal').onclick=()=>{ $('#htmlModal').style.display='none'; $('#htmlFrame').srcdoc=''; };
$('#copyModalHtml').onclick=async()=>{
  const doc=$('#htmlFrame').contentDocument; const src=doc?.documentElement?.outerHTML||'';
  try{ await navigator.clipboard.writeText(src); alert('Nusxa olindi âœ“'); }catch{}
};

/* =========================
   CARD EDIT PROMPT
========================= */
function editCardPrompt(card, onDone){
  const name=prompt('Card nomi',card.name||''); if(name==null) return;
  const desc=prompt('Tavsif',card.description||''); if(desc==null) return;
  const img=prompt('Rasm URL (ixtiyoriy)',card.image||''); if(img==null) return;
  const type=prompt('Tur (open/coming_soon/window)',card.type||'open'); if(type==null) return;
  let startAt=card.startAt||'', endAt=card.endAt||'';
  if(type==='window'){
    startAt=prompt('startAt (ISO yoki boâ€˜sh)', startAt||'')||undefined;
    endAt=prompt('endAt (ISO yoki boâ€˜sh)', endAt||'')||undefined;
  }else{ startAt=undefined; endAt=undefined; }
  const tags=prompt('Teglar (vergul bilan)', (card.tags||[]).join(', '));
  card.name=name; card.description=desc; card.image=img||undefined; card.type=type;
  card.startAt=startAt; card.endAt=endAt; card.tags=(tags?tags.split(',').map(x=>x.trim()).filter(Boolean):[]);
  onDone&&onDone();
}

/* =========================
   UI EVENTS â€” ADD
========================= */
$('#bgAdd').onclick=()=>{ const tag=$('#bgTag').value.trim(); if(!tag) return alert('Tag kerak');
  DATA.bannerGroups.push({tag,items:[]}); $('#bgTag').value=''; renderBannerList(); refreshPreview();
};
$('#secAdd').onclick=()=>{ const t=$('#secTitle').value.trim(),g=$('#secTag').value.trim();
  if(!t) return alert('Boâ€˜lim sarlavhasi kerak');
  DATA.sections.push({title:t, tag:g, items:[]}); lastSectionIndex = DATA.sections.length-1; lastCardIndex=-1;
  $('#secTitle').value=''; $('#secTag').value=''; renderSections(); refreshPreview();
};
$('#cAdd').onclick=()=>{
  if(lastSectionIndex<0) return alert('Avval boâ€˜lim tanlang yoki qoâ€˜shing (ğŸ¯ Tanlash).');
  const s=DATA.sections[lastSectionIndex];
  const it={
    name:$('#cName').value.trim(),
    description:$('#cDesc').value.trim(),
    image:$('#cImg').value.trim()||undefined,
    type:$('#cType').value,
    startAt:$('#cStart').value? toISO($('#cStart').value): undefined,
    endAt:$('#cEnd').value? toISO($('#cEnd').value): undefined,
    tags:$('#cTags').value.split(',').map(x=>x.trim()).filter(Boolean),
    buttons:[]
  };
  if(!it.name) return alert('Card nomi kerak');
  s.items.push(it); lastCardIndex = s.items.length-1;
  ['cName','cDesc','cImg','cTags','cStart','cEnd'].forEach(id=>$('#'+id).value=''); $('#cType').value='open';
  renderSections(); refreshPreview(); previewCard(it);
};
$('#bAdd').onclick=()=>{
  if(lastSectionIndex<0) return alert('Boâ€˜lim tanlang');
  const s=DATA.sections[lastSectionIndex]; if(!s.items.length) return alert('Avval card qoâ€˜shing');
  const c=s.items[lastCardIndex>=0?lastCardIndex:s.items.length-1];
  const btn={kind:$('#bKind').value, label:$('#bLabel').value.trim()};
  if(btn.kind==='link'){ btn.href=$('#bHref').value.trim(); if(!btn.href) return alert('Href kerak'); }
  else { btn.html=$('#bHtml').value.trim(); if(!btn.html) return alert('HTML kerak'); }
  (c.buttons||(c.buttons=[])).push(btn);
  ['bLabel','bHref','bHtml'].forEach(id=>$('#'+id).value='');
  renderSections(); refreshPreview(); previewCard(c);
};

/* =========================
   THEME + SCROLL
========================= */
const root=document.documentElement, THEME_KEY='lm-admin-theme';
const setTheme=m=>{ root.classList.toggle('dark',m==='dark'); localStorage.setItem(THEME_KEY,m); $('#themeToggle').textContent=m==='dark'?'â˜€ï¸':'ğŸŒ™'; };
setTheme(localStorage.getItem(THEME_KEY)||'light');
$('#themeToggle').onclick=()=> setTheme(root.classList.contains('dark')?'light':'dark');
$('#toTop').onclick=()=> window.scrollTo({top:0,behavior:'smooth'});

/* =========================
   EXPORT â€” JSON/XLSX/CSV
========================= */
$('#exportJson').onclick=()=> download('index.json', fmt(DATA), 'application/json');

$('#exportXlsx').onclick=()=>{
  const wb = XLSX.utils.book_new();

  // Banners sheet
  // cols: tag, idx, durationMs, html
  const rowsB = [['tag','idx','durationMs','html']];
  DATA.bannerGroups.forEach(bg=>{
    (bg.items||[]).forEach((it,i)=>{
      rowsB.push([bg.tag||'', i+1, Number(it.durationMs||0), it.html||'']);
    });
  });
  const wsB = XLSX.utils.aoa_to_sheet(rowsB);
  XLSX.utils.book_append_sheet(wb, wsB, 'Banners');

  // Sections sheet
  // cols: sectionTitle, sectionTag, cardIndex, name, description, image, type, startAt, endAt, tags (|), buttonsJSON
  const rowsS = [['sectionTitle','sectionTag','cardIndex','name','description','image','type','startAt','endAt','tags','buttons']];
  DATA.sections.forEach(sec=>{
    (sec.items||[]).forEach((c,ci)=>{
      rowsS.push([
        sec.title||'', sec.tag||'', ci+1, c.name||'', c.description||'', c.image||'',
        c.type||'open', c.startAt||'', c.endAt||'',
        (c.tags||[]).join('|'),
        JSON.stringify(c.buttons||[])
      ]);
    });
    // agar boâ€˜lim boâ€˜sh boâ€˜lsa ham bir qator chiqsin
    if(!(sec.items||[]).length){
      rowsS.push([sec.title||'', sec.tag||'', '', '', '', '', '', '', '', '', '[]']);
    }
  });
  const wsS = XLSX.utils.aoa_to_sheet(rowsS);
  XLSX.utils.book_append_sheet(wb, wsS, 'Sections');

  XLSX.writeFile(wb, 'leader-index.xlsx');
};

$('#exportCsv').onclick=()=>{
  // banners.csv
  const rowsB=[['tag','idx','durationMs','html']];
  DATA.bannerGroups.forEach(bg=>{
    (bg.items||[]).forEach((it,i)=>{
      rowsB.push([bg.tag||'', i+1, Number(it.durationMs||0), it.html||'']);
    });
  });
  download('banners.csv', toCSV(rowsB), 'text/csv');

  // sections.csv
  const rowsS=[['sectionTitle','sectionTag','cardIndex','name','description','image','type','startAt','endAt','tags','buttons']];
  DATA.sections.forEach(sec=>{
    (sec.items||[]).forEach((c,ci)=>{
      rowsS.push([
        sec.title||'', sec.tag||'', ci+1, c.name||'', c.description||'', c.image||'',
        c.type||'open', c.startAt||'', c.endAt||'',
        (c.tags||[]).join('|'),
        JSON.stringify(c.buttons||[])
      ]);
    });
    if(!(sec.items||[]).length){
      rowsS.push([sec.title||'', sec.tag||'', '', '', '', '', '', '', '', '', '[]']);
    }
  });
  download('sections.csv', toCSV(rowsS), 'text/csv');
};

/* =========================
   IMPORT â€” XLSX/CSV
========================= */
$('#importXlsx').onclick=()=> $('#fileXlsx').click();
$('#fileXlsx').onchange = (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{
    const wb = XLSX.read(reader.result, {type:'array'});
    const bSheet = wb.Sheets['Banners'];
    const sSheet = wb.Sheets['Sections'];
    if(!bSheet || !sSheet){ alert('Banners va Sections varaq(lar)i topilmadi'); return; }

    // parse Banners
    const B = XLSX.utils.sheet_to_json(bSheet, {header:1}); // AOA
    const banners = B.slice(1).filter(r=>r.length>0);
    const bgMap = new Map(); // tag -> items[]
    banners.forEach(r=>{
      const tag = String(r[0]||'').trim(); if(!tag) return;
      const dur = Number(r[2]||0); const html= String(r[3]||'');
      if(!bgMap.has(tag)) bgMap.set(tag, []);
      bgMap.get(tag).push({durationMs:dur||5000, html});
    });
    const bannerGroups = [...bgMap.entries()].map(([tag,items])=>({tag,items}));

    // parse Sections
    const S = XLSX.utils.sheet_to_json(sSheet, {header:1});
    const secRows = S.slice(1).filter(r=>r.length>0);
    const secMap = new Map(); // key:title|tag -> {title,tag,items:[]}
    secRows.forEach(r=>{
      const st=String(r[0]||'').trim(), tg=String(r[1]||'').trim();
      const name=String(r[3]||'').trim(); const desc=String(r[4]||'').trim();
      const image=String(r[5]||'').trim(); const type=String(r[6]||'open').trim();
      const startAt=String(r[7]||'').trim()||undefined;
      const endAt=String(r[8]||'').trim()||undefined;
      const tags=String(r[9]||'').split('|').map(x=>x.trim()).filter(Boolean);
      let buttons=[];
      try{ buttons = JSON.parse(String(r[10]||'[]')); }catch{ buttons=[]; }

      const key=`${st}|${tg}`;
      if(!secMap.has(key)) secMap.set(key, {title:st, tag:tg, items:[]});
      if(name){ secMap.get(key).items.push({name, description:desc, image: image||undefined, type, startAt, endAt, tags, buttons}); }
    });
    const sections = [...secMap.values()];

    DATA = { bannerGroups, sections };
    lastSectionIndex = sections.length? 0 : -1; lastCardIndex=-1;
    renderBannerList(); renderSections(); refreshPreview();
    alert('XLSX import qabul qilindi âœ…');
  };
  reader.readAsArrayBuffer(f);
};

$('#importCsv').onclick=()=>{
  // ikki dialog: banners.csv va sections.csv
  if(!confirm('Avval banners.csv faylni tanlaysiz, keyin sections.csv faylni. Davom etamizmi?')) return;
  $('#fileCsvBanners').click();
};
$('#fileCsvBanners').onchange=(e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const text=r.result; const rows=parseCSV(text);
      const header=rows.shift()||[];
      const idxTag=header.indexOf('tag'), idxDur=header.indexOf('durationMs'), idxHtml=header.indexOf('html');
      const map=new Map();
      rows.forEach(r=>{
        const tag=(r[idxTag]||'').trim(); if(!tag) return;
        const d=Number(r[idxDur]||5000); const h=(r[idxHtml]||'');
        if(!map.has(tag)) map.set(tag,[]);
        map.get(tag).push({durationMs:d||5000, html:h});
      });
      const BG=[...map.entries()].map(([tag,items])=>({tag,items}));
      // temporarily stash banners, then ask for sections.csv
      window.__TMP_BG = BG;
      $('#fileCsvSections').click();
    }catch(err){ alert('banners.csv parse xato'); }
  };
  r.readAsText(f);
};
$('#fileCsvSections').onchange=(e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const text=r.result; const rows=parseCSV(text);
      const header=rows.shift()||[];
      const col = name=> header.indexOf(name);
      const C={
        st: col('sectionTitle'), tg: col('sectionTag'), nm: col('name'), ds: col('description'),
        img: col('image'), tp: col('type'), sa: col('startAt'), ea: col('endAt'), tgs: col('tags'), btn: col('buttons')
      };
      const map=new Map();
      rows.forEach(r=>{
        const st=(r[C.st]||'').trim(), tg=(r[C.tg]||'').trim();
        const name=(r[C.nm]||'').trim();
        const desc=(r[C.ds]||'').trim(); const image=(r[C.img]||'').trim(); const type=(r[C.tp]||'open').trim();
        const startAt=(r[C.sa]||'').trim()||undefined; const endAt=(r[C.ea]||'').trim()||undefined;
        const tags=(r[C.tgs]||'').split('|').map(x=>x.trim()).filter(Boolean);
        let buttons=[]; try{ buttons=JSON.parse(r[C.btn]||'[]'); }catch{}
        const key=`${st}|${tg}`;
        if(!map.has(key)) map.set(key, {title:st, tag:tg, items:[]});
        if(name){ map.get(key).items.push({name, description:desc, image:image||undefined, type, startAt, endAt, tags, buttons}); }
      });
      const sections=[...map.values()];
      DATA = { bannerGroups: (window.__TMP_BG||[]), sections };
      delete window.__TMP_BG;
      renderBannerList(); renderSections(); refreshPreview();
      alert('CSV import qabul qilindi âœ…');
    }catch(err){ alert('sections.csv parse xato'); }
  };
  r.readAsText(f);
};

/* =========================
   INIT
========================= */
function refreshAll(){ renderBannerList(); renderSections(); refreshPreview(); }
refreshAll();
</script>
</body>
</html>
