<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LeaderMath — Home Admin (JSON Editor)</title>
  <style>
    body{margin:0;font:15px/1.5 system-ui,Segoe UI,Arial;background:#f4f8f6;color:#0d1b14}
    header{position:sticky;top:0;background:#f4f8f6;border-bottom:1px solid #dfe7e2;z-index:10}
    .row{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;gap:10px;align-items:center}
    .brand{font-weight:800;color:#2E8B57}
    main{max-width:1100px;margin:0 auto;padding:16px;display:grid;gap:12px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    button{padding:8px 12px;border:1px solid #dfe7e2;border-radius:10px;background:#fff;cursor:pointer}
    button.primary{background:#2E8B57;color:#fff;border-color:#2E8B57}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .card{border:1px solid #dfe7e2;border-radius:12px;background:#fff}
    .card h3{margin:0;padding:10px 12px;border-bottom:1px solid #dfe7e2}
    .card .body{padding:12px}
    input,select,textarea{width:100%;padding:8px 10px;border:1px solid #dfe7e2;border-radius:10px}
    textarea{min-height:180px;font-family:ui-monospace,Consolas,monospace}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef2ee;text-align:left;vertical-align:top}
    tr:hover{background:#f7faf8}
    .small{font-size:12px;color:#4a6b5a}
    .pill{padding:4px 8px;border:1px solid #dfe7e2;border-radius:999px;background:#fff}
    .rowflex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  </style>
</head>
<body>
  <header><div class="row"><div class="brand">LeaderMath — Home Admin</div>
    <div class="rowflex">
      <button id="load">home.json ni yuklash</button>
      <button id="save" class="primary">Yuklab olish (download)</button>
      <button id="add">+ Bo‘lim qo‘shish</button>
    </div></div></header>
  <main>
    <div class="grid">
      <div class="card">
        <h3>Bo‘limlar</h3>
        <div class="body">
          <table id="tbl"><thead><tr><th>#</th><th>ID</th><th>Sarlavha</th><th>Mode</th><th>Actions</th></tr></thead><tbody></tbody></table>
        </div>
      </div>
      <div class="card">
        <h3>Tahrir</h3>
        <div class="body" id="editor">
          <div class="small">Chapdan biror bo‘limni tanlang.</div>
        </div>
      </div>
    </div>
  </main>
<script>
(function(){
  var state = {sections:[], sel:-1};

  function renderTable(){
    var tb = document.querySelector('#tbl tbody'); tb.innerHTML='';
    state.sections.forEach(function(s, i){
      var tr = document.createElement('tr');
      tr.innerHTML =
        '<td>'+ (i+1) +'</td>' +
        '<td>'+ (s.id||'') +'</td>' +
        '<td>'+ (s.title||'') +'</td>' +
        '<td><span class="pill">'+ (s.mode||'html') +'</span></td>' +
        '<td class="rowflex">'+
          '<button data-i="'+i+'" class="sel">Tanlash</button>'+
          '<button data-i="'+i+'" class="up">↑</button>'+
          '<button data-i="'+i+'" class="down">↓</button>'+
          '<button data-i="'+i+'" class="del">O‘chirish</button>'+
        '</td>';
      tb.appendChild(tr);
    });
  }

  function editCard(i){
    state.sel = i;
    var s = state.sections[i] || {};
    var ed = document.getElementById('editor');
    ed.innerHTML =
      '<div class="rowflex">'+
        '<div style="flex:1">'+
          '<label>ID</label><input id="eid" value="'+(s.id||'')+'"/>'+
        '</div>'+
        '<div style="flex:1">'+
          '<label>Sarlavha</label><input id="etitle" value="'+(s.title||'')+'"/>'+
        '</div>'+
      '</div>'+
      '<div class="rowflex">'+
        '<div style="flex:1">'+
          '<label>Mode</label>'+
          '<select id="emode">'+
            '<option value="html"'+(s.mode==='html'?' selected':'')+'>html</option>'+
            '<option value="url"'+(s.mode==='url'?' selected':'')+'>url</option>'+
          '</select>'+
        '</div>'+
        '<div style="flex:1">'+
          '<label>Sandbox</label><input id="esandbox" value="'+(s.sandbox||'allow-scripts allow-forms')+'"/>'+
        '</div>'+
      '</div>'+
      '<div class="rowflex">'+
        '<div style="flex:1">'+
          '<label>fullBleed</label>'+
          '<select id="efull">'+
            '<option value="false"'+(!s.fullBleed?' selected':'')+'>false</option>'+
            '<option value="true"'+(s.fullBleed?' selected':'')+'>true</option>'+
          '</select>'+
        '</div>'+
        '<div style="flex:1">'+
          '<label>baseHref (ixtiyoriy)</label><input id="ebase" value="'+(s.baseHref||'')+'"/>'+
        '</div>'+
      '</div>'+
      '<div id="htmlBlock" style="'+(s.mode==='html'?'':'display:none')+'">'+
        '<label>contentHtml</label><textarea id="ehtml">'+(s.contentHtml?String(s.contentHtml).replace(/</g,'&lt;'):'')+'</textarea>'+
      '</div>'+
      '<div id="urlBlock" style="'+(s.mode==='url'?'':'display:none')+'">'+
        '<label>src (URL yoki fayl yo‘li)</label><input id="esrc" value="'+(s.src||'')+'"/>'+
        '<div class="small">Eslatma: iframe balandligi uchun ichki sahifaga postMessage skriptini qo‘shing.</div>'+
      '</div>'+
      '<div class="rowflex" style="margin-top:8px"><button id="saveOne" class="primary">Saqlash</button></div>';

    ed.querySelector('#emode').onchange = function(){
      var v = this.value;
      ed.querySelector('#htmlBlock').style.display = (v==='html'?'block':'none');
      ed.querySelector('#urlBlock').style.display = (v==='url'?'block':'none');
    };
    ed.querySelector('#saveOne').onclick = function(){
      var id = ed.querySelector('#eid').value.trim();
      var title = ed.querySelector('#etitle').value.trim();
      var mode = ed.querySelector('#emode').value;
      var sandbox = ed.querySelector('#esandbox').value.trim();
      var fullBleed = ed.querySelector('#efull').value==='true';
      var baseHref = ed.querySelector('#ebase').value.trim();
      var obj = { id:id, title:title, mode:mode, sandbox:sandbox, fullBleed:fullBleed };
      if(baseHref) obj.baseHref = baseHref;
      if(mode==='html'){
        var html = ed.querySelector('#ehtml').value;
        obj.contentHtml = html;
      }else{
        obj.src = ed.querySelector('#esrc').value.trim();
      }
      state.sections[i] = obj;
      renderTable();
      alert('Bo‘lim saqlandi.');
    };
  }

  document.getElementById('add').onclick = function(){
    var n = state.sections.length+1;
    state.sections.push({ id:'sec'+n, title:'Yangi bo‘lim '+n, mode:'html', sandbox:'allow-scripts allow-forms', fullBleed:false, contentHtml:'<section style=\'padding:20px\'><h2>Yangi</h2></section>' });
    renderTable(); editCard(state.sections.length-1);
  };

  document.getElementById('load').onclick = async function(){
    try{
      var res = await fetch('./home.json', {cache:'no-store'});
      state = await res.json();
      if(!Array.isArray(state.sections)) state.sections = [];
      renderTable();
      if(state.sections[0]) editCard(0);
    }catch(e){ alert('home.json yuklashda xato: '+e.message); }
  };

  document.getElementById('save').onclick = function(){
    var data = {sections: state.sections};
    var blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    var a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'home.json'; a.click();
    setTimeout(function(){ URL.revokeObjectURL(a.href); }, 1000);
  };

  document.getElementById('tbl').addEventListener('click', function(e){
    var i = e.target.getAttribute('data-i'); if(i===null) return;
    i = parseInt(i,10);
    if(e.target.classList.contains('sel')) editCard(i);
    if(e.target.classList.contains('up') && i>0){
      var t=state.sections[i-1]; state.sections[i-1]=state.sections[i]; state.sections[i]=t; renderTable();
    }
    if(e.target.classList.contains('down') && i<state.sections.length-1){
      var t2=state.sections[i+1]; state.sections[i+1]=state.sections[i]; state.sections[i]=t2; renderTable();
    }
    if(e.target.classList.contains('del')){
      if(confirm('O‘chirishni tasdiqlaysizmi?')){ state.sections.splice(i,1); renderTable(); document.getElementById('editor').innerHTML='<div class="small">Chapdan biror bo‘limni tanlang.</div>'; }
    }
  });
})();
</script>
</body>
</html>
