<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LeaderMath.UZ â€” Bannerlar</title>
  <meta name="theme-color" content="#2E8B57" id="meta-theme-color"/>
  <link rel="icon" href="./logo.png"/>

  <style>
    /* =================== THEME =================== */
    :root{
      --brand:#2E8B57; --brand-2:#1F6B45; --accent:#7BD3A3;
      --bg:#F5FBF8; --bg-alt:#ECF5EF; --card:#FFFFFF;
      --text:#0D1B14; --muted:#557767;
      --line:#DDEAE3; --ring:#8AD1B1;
      --radius:16px; --radius-lg:22px; --pill:999px;
      --shadow-sm:0 6px 20px rgba(0,0,0,.06);
      --shadow-md:0 12px 30px rgba(0,0,0,.08);
      --glass:rgba(255,255,255,.55);
      --glass-stroke:rgba(255,255,255,.45);
      --scr: 16px; /* carousel scroll step fallback */
    }
    [data-theme="dark"]{
      --bg:#0E1512; --bg-alt:#0B120F; --card:#101C16;
      --text:#E7F5EC; --muted:#A1C3B4; --line:#1E3A2E; --glass:rgba(16,28,22,.55);
      --glass-stroke:rgba(255,255,255,.08); --shadow-sm:0 6px 20px rgba(0,0,0,.35);
      --shadow-md:0 12px 32px rgba(0,0,0,.45);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text); background:
        radial-gradient(1200px 600px at 10% -10%, #CFEDE0 0%, transparent 50%),
        radial-gradient(900px 500px at 110% 10%, #C7F3DE 0%, transparent 45%),
        var(--bg);
      min-height:100dvh;
    }

    /* =================== TOP BAR =================== */
    .topbar{
      position:sticky; top:0; z-index:50; backdrop-filter:saturate(140%) blur(10px);
      background:linear-gradient(180deg, var(--glass), transparent);
      border-bottom:1px solid var(--glass-stroke);
    }
    .topbar .inner{
      max-width:1100px; margin:0 auto; padding:14px 16px; display:flex; align-items:center; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; padding:8px 12px; border-radius:var(--pill);
      background:linear-gradient(135deg, rgba(46,139,87,.12), rgba(46,139,87,.03));
      border:1px solid var(--glass-stroke); box-shadow:var(--shadow-sm);
    }
    .brand img{width:28px;height:28px;border-radius:8px}
    .brand .t1{font-weight:800; letter-spacing:.3px}
    .brand .t2{font-weight:600; color:var(--brand); margin-left:2px}

    .spacer{flex:1}

    .theme-btn{
      border:1px solid var(--glass-stroke); background:var(--glass);
      padding:10px 12px; border-radius:12px; cursor:pointer; user-select:none;
      display:flex; align-items:center; gap:10px;
    }

    /* =================== FILTER CHIPS (boâ€˜limlar) =================== */
    .chips{
      max-width:1100px; margin:10px auto 0; padding:0 16px 8px; display:flex; gap:10px; flex-wrap:wrap;
    }
    .chip{
      border:1px solid var(--line); background:var(--card); color:var(--text);
      padding:10px 14px; border-radius:var(--pill); cursor:pointer; transition:.2s;
      box-shadow:var(--shadow-sm); font-weight:600; opacity:.92;
    }
    .chip:hover{ transform:translateY(-1px); opacity:1 }
    .chip.active{ background:linear-gradient(135deg, var(--brand), var(--brand-2)); color:#fff; border-color:transparent }

    /* =================== SECTION WRAPPER =================== */
    .section{
      max-width:1100px; margin:18px auto; padding:18px 16px 10px;
      background:linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.45));
      border:1px solid var(--glass-stroke); border-radius:var(--radius-lg);
      box-shadow:var(--shadow-md); position:relative; overflow:clip;
    }
    .section.darkish{ background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)) }
    .sec-header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;
    }
    .sec-title{
      font-weight:800; font-size:20px; display:flex; align-items:center; gap:8px;
      background:linear-gradient(135deg, var(--brand), var(--accent)); -webkit-background-clip:text; color:transparent;
    }
    .sec-controls{ display:flex; align-items:center; gap:8px }
    .btn{
      border:1px solid var(--line); background:var(--card); padding:8px 10px; border-radius:12px; cursor:pointer;
      display:inline-flex; align-items:center; gap:8px; box-shadow:var(--shadow-sm);
    }
    .btn:active{ transform:translateY(1px) }
    .btn.primary{ background:linear-gradient(135deg, var(--brand), var(--brand-2)); color:#fff; border-color:transparent }

    /* =================== CAROUSEL =================== */
    .carousel{
      position:relative; padding:8px 36px; /* leave space for arrows */
    }
    .rail{
      display:grid; grid-auto-flow:column; grid-auto-columns: minmax(280px, 1fr);
      gap:14px; overflow:auto; scroll-snap-type:x mandatory; scroll-padding:12px;
      scrollbar-width:thin; scrollbar-color: var(--brand) transparent;
    }
    .rail::-webkit-scrollbar{height:10px}
    .rail::-webkit-scrollbar-thumb{background:linear-gradient(135deg,var(--brand),var(--brand-2)); border-radius:6px}
    .rail::-webkit-scrollbar-track{background:transparent}

    .card{
      scroll-snap-align:center; background:var(--card); border:1px solid var(--line);
      border-radius:18px; padding:10px; box-shadow:var(--shadow-sm);
      display:flex; flex-direction:column; gap:10px; position:relative; overflow:hidden;
    }
    .badge{
      position:absolute; top:10px; left:10px; z-index:2;
      padding:6px 10px; border-radius:999px;
      background:rgba(0,0,0,.55); color:#fff; font-weight:700; font-size:12px; letter-spacing:.3px;
    }
    .frame{
      width:100%; aspect-ratio:16/9; border:0; border-radius:12px; background:var(--bg-alt);
      box-shadow: inset 0 0 0 1px var(--line);
    }
    .meta{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .meta .title{font-weight:700}
    .meta .open{
      border:1px solid var(--line); background:var(--bg); padding:8px 10px; border-radius:10px; font-weight:700; cursor:pointer;
    }

    /* arrows */
    .arrow{
      position:absolute; top:50%; transform:translateY(-50%);
      width:36px; height:36px; border-radius:12px; display:grid; place-items:center; cursor:pointer;
      border:1px solid var(--line); background:var(--card); box-shadow:var(--shadow-sm);
      z-index:5; user-select:none;
    }
    .arrow:hover{ filter:brightness(1.02) }
    .arrow.prev{ left:6px } .arrow.next{ right:6px }

    /* =================== EMPTY / ERRORS =================== */
    .empty{
      max-width:900px; margin:60px auto; text-align:center; opacity:.8
    }

    /* =================== MEDIA =================== */
    @media (max-width:720px){
      .rail{ grid-auto-columns: 84% }
      .sec-title{ font-size:18px }
    }
  </style>
</head>
<body>
  <!-- =================== TOPBAR =================== -->
  <div class="topbar">
    <div class="inner">
      <div class="brand">
        <img src="./logo.png" alt="LM">
        <div class="t1">LeaderMath.<span class="t2">UZ</span></div>
      </div>
      <div class="spacer"></div>
      <button class="theme-btn" id="themeToggle" title="Kun / Tun">
        <span id="themeIcon">ðŸŒž</span> <strong>Kun/Tun</strong>
      </button>
    </div>
  </div>

  <!-- =================== FILTER CHIPS =================== -->
  <div class="chips" id="chips"></div>

  <!-- =================== SECTIONS RENDER ZONE =================== -->
  <div id="sections"></div>

  <div class="empty" id="empty" style="display:none">
    <h2>Hozircha banner topilmadi</h2>
    <p><code>banner.json</code> fayliga boâ€˜limlar va bannerlar qoâ€˜shing.</p>
  </div>

  <script>
    /* ====== Light/Dark toggle ====== */
    const root = document.documentElement;
    const themeBtn = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const savedTheme = localStorage.getItem('lm-theme') || 'light';
    root.setAttribute('data-theme', savedTheme);
    themeIcon.textContent = savedTheme==='dark' ? 'ðŸŒ™' : 'ðŸŒž';
    themeBtn.onclick = () => {
      const t = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
      root.setAttribute('data-theme', t);
      themeIcon.textContent = t==='dark' ? 'ðŸŒ™' : 'ðŸŒž';
      localStorage.setItem('lm-theme', t);
      document.getElementById('meta-theme-color')?.setAttribute('content', t==='dark' ? '#0E1512' : '#2E8B57');
    };

    /* ====== Helpers ====== */
    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));
    const byId = id => document.getElementById(id);

    function scrollByOne(rail, dir=1){
      const card = rail.querySelector('.card');
      const delta = card ? (card.getBoundingClientRect().width + 14) : 320;
      rail.scrollBy({ left: dir*delta, behavior: 'smooth' });
    }

    function jumpTo(hash){
      const el = byId(hash);
      if(!el) return;
      window.scrollTo({ top: el.offsetTop - 70, behavior:'smooth' });
    }

    /* ====== Renderers ====== */
    function renderChips(sections){
      const chips = byId('chips');
      chips.innerHTML = '';
      sections.forEach((sec, idx) => {
        const c = document.createElement('button');
        c.className = 'chip' + (idx===0 ? ' active' : '');
        c.textContent = sec.title || sec.id || `Bo'lim ${idx+1}`;
        c.onclick = () => {
          $$('.chip').forEach(x => x.classList.remove('active'));
          c.classList.add('active');
          jumpTo(`sec-${sec.id}`);
        };
        chips.appendChild(c);
      });
    }

    function bannerIframeHTML(rawHtml, bg){
      // Iframe ichidagi minimal reset + yoqimli fon
      const safeBg = bg || '#ffffff';
      const css = `
        <style>
          *{box-sizing:border-box} html,body{margin:0;padding:0}
          body{background:${safeBg};font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
          a{text-decoration:none}
        </style>`;
      return css + rawHtml;
    }

    function renderSections(data){
      const wrap = byId('sections');
      wrap.innerHTML = '';
      if(!data?.sections?.length){ byId('empty').style.display='block'; return; }
      byId('empty').style.display='none';

      data.sections.forEach((sec, sIdx) => {
        const section = document.createElement('section');
        section.className = 'section';
        section.id = `sec-${sec.id}`;
        if(sec.darkish) section.classList.add('darkish');

        // header
        const header = document.createElement('div');
        header.className = 'sec-header';

        const title = document.createElement('div');
        title.className = 'sec-title';
        title.innerHTML = `${sec.icon || 'ðŸ“Œ'} ${sec.title || 'Boâ€˜lim'}`;

        const controls = document.createElement('div');
        controls.className = 'sec-controls';

        const btnAll = document.createElement('button');
        btnAll.className = 'btn';
        btnAll.textContent = 'Barchasi';
        btnAll.onclick = () => alert(`"${sec.title}" boâ€˜limi uchun "Barchasi" (keyinroq toâ€˜liq sahifa ulash mumkin).`);

        controls.appendChild(btnAll);
        header.appendChild(title);
        header.appendChild(controls);
        section.appendChild(header);

        // carousel
        const car = document.createElement('div');
        car.className = 'carousel';

        const rail = document.createElement('div');
        rail.className = 'rail';
        rail.setAttribute('data-sec', sec.id);

        (sec.banners || []).forEach((bn, i) => {
          const card = document.createElement('div');
          card.className = 'card';

          const badge = document.createElement('div');
          badge.className = 'badge';
          badge.textContent = bn.badge || (bn.tag || 'BANNER');
          card.appendChild(badge);

          const ifr = document.createElement('iframe');
          ifr.className = 'frame';
          ifr.loading = 'lazy';
          ifr.referrerPolicy = 'no-referrer';
          ifr.sandbox = 'allow-forms allow-pointer-lock allow-popups allow-same-origin allow-scripts';
          // srcdoc orqali banner HTML ni joylaymiz
          const bg = bn.bg || (sec.darkish ? '#111a15' : '#ffffff');
          ifr.srcdoc = bannerIframeHTML(bn.html || '<div style="padding:24px">Boâ€˜sh banner</div>', bg);
          card.appendChild(ifr);

          const meta = document.createElement('div');
          meta.className = 'meta';
          const t = document.createElement('div'); t.className='title'; t.textContent = bn.title || 'Banner';
          const open = document.createElement('a');
          open.className = 'open';
          open.textContent = 'Ochish';
          open.href = bn.link || '#';
          open.target = '_blank'; open.rel = 'noopener';
          meta.appendChild(t); meta.appendChild(open);
          card.appendChild(meta);

          rail.appendChild(card);
        });

        // arrows
        const prev = document.createElement('button');
        prev.className = 'arrow prev';
        prev.innerHTML = 'â€¹';
        prev.onclick = () => scrollByOne(rail, -1);

        const next = document.createElement('button');
        next.className = 'arrow next';
        next.innerHTML = 'â€º';
        next.onclick = () => scrollByOne(rail, +1);

        car.appendChild(prev);
        car.appendChild(rail);
        car.appendChild(next);

        section.appendChild(car);
        wrap.appendChild(section);
      });
    }

    /* ====== LOAD JSON ====== */
    async function loadBanners(){
      try{
        const res = await fetch('./banner.json', {cache:'no-store'});
        if(!res.ok) throw new Error('banner.json topilmadi yoki oâ€˜qilmadi');
        const data = await res.json();

        // chips + sections
        renderChips(data.sections || []);
        renderSections(data);
      }catch(err){
        console.error(err);
        byId('empty').style.display='block';
        byId('empty').innerHTML = `
          <h2>banner.json yuklanmadi</h2>
          <p>Xato: ${String(err.message||err)}</p>`;
      }
    }

    // Init
    loadBanners();
  </script>
</body>
</html>
