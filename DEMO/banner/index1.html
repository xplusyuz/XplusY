<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LeaderMath â€” Stories Bannerlar</title>
  <meta name="theme-color" content="#2E8B57" id="meta-theme-color"/>
  <link rel="icon" href="./logo.png"/>

  <style>
    :root{
      --brand:#2E8B57;--brand2:#1F6B45;--text:#0d1b14;--muted:#5c7669;
      --glass:rgba(255,255,255,.6);--glass-b:#E7F2EB;--ring:#8AD1B1;
      --radius:16px;
      --bar-bg:rgba(255,255,255,.35); --bar-fill:#ffffff; /* progress bars */
      --shade:linear-gradient(180deg, rgba(0,0,0,.6), rgba(0,0,0,.05));
    }
    [data-theme="dark"]{
      --text:#E7F5EC;--muted:#B7D3C6;
      --glass:rgba(16,28,22,.5);--glass-b:#1A2D24;
      --bar-bg:rgba(255,255,255,.25); --bar-fill:#EAF7EE;
      --shade:linear-gradient(180deg, rgba(0,0,0,.75), rgba(0,0,0,.2));
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);background:#0e1512}

    /* ==== Top overlay (brand + section chips + theme) ==== */
    .overlay-top{
      position:fixed; inset:0 0 auto 0; z-index:30; pointer-events:none;
      padding:10px 12px;
      background:linear-gradient(180deg, rgba(0,0,0,.35), transparent);
    }
    .row{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:10px}
    .brand{
      pointer-events:auto; display:flex;align-items:center;gap:10px;
      padding:8px 12px;border-radius:999px;background:var(--glass);
      border:1px solid var(--glass-b); backdrop-filter:saturate(140%) blur(10px);
      font-weight:900;
    }
    .brand img{width:22px;height:22px;border-radius:6px}
    .spacer{flex:1}
    .theme-btn{
      pointer-events:auto; border:1px solid var(--glass-b); background:var(--glass);
      padding:8px 10px;border-radius:12px;cursor:pointer;font-weight:700
    }
    .chips{
      margin-top:10px; display:flex; gap:8px; overflow:auto; padding-bottom:4px; pointer-events:auto;
      scrollbar-width:none;
    }
    .chip{
      white-space:nowrap; padding:8px 12px; border-radius:999px; cursor:pointer;
      border:1px solid var(--glass-b); background:var(--glass); color:#fff; font-weight:700; opacity:.9;
      backdrop-filter:saturate(140%) blur(10px);
    }
    .chip.active{ background:#2E8B57; border-color:transparent; opacity:1 }

    /* ==== Story stage (full screen) ==== */
    .stage{
      position:fixed; inset:0; display:grid; place-items:center; background:#000;
    }
    .story{
      position:relative; width:100%; height:100dvh; max-width:1100px; background:#000; border-radius:0;
      overflow:hidden;
    }
    /* Shade top/bottom for readability on any banner */
    .shade-top{
      position:absolute; inset:0 0 auto 0; height:140px; background:var(--shade); z-index:3; pointer-events:none;
    }
    .shade-bot{
      position:absolute; inset:auto 0 0 0; height:130px; background:linear-gradient(0deg, rgba(0,0,0,.6), rgba(0,0,0,0)); z-index:3; pointer-events:none;
    }

    /* ==== Progress bars (like stories) ==== */
    .progress{ position:absolute; left:8px; right:8px; top:12px; z-index:4; display:flex; gap:6px }
    .bar{ flex:1; height:4px; background:var(--bar-bg); border-radius:999px; overflow:hidden }
    .fill{ width:0%; height:100%; background:var(--bar-fill) }
    @keyframes fillAnim{ from{ width:0% } to{ width:100% } }
    .fill.active{ animation: fillAnim var(--dur,5s) linear forwards }
    .paused .fill{ animation-play-state: paused !important }

    /* ==== Tap zones ==== */
    .tap{
      position:absolute; inset:0; display:grid; grid-template-columns:1fr 1fr; z-index:5;
    }
    .tap div{ height:100%; }
    .tap .left{ cursor:w-resize }
    .tap .right{ cursor:e-resize }

    /* ==== Iframe ==== */
    .frame{
      position:absolute; inset:0; border:0; width:100%; height:100%;
      background:#111;
    }

    /* ==== Caption (optional meta) ==== */
    .caption{
      position:absolute; left:14px; right:14px; bottom:18px; z-index:6; color:#fff;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:700; text-shadow:0 2px 8px rgba(0,0,0,.45);
    }
    .open{
      border:0; background:rgba(255,255,255,.2); color:#fff; padding:10px 12px; border-radius:12px; cursor:pointer;
      backdrop-filter:blur(4px)
    }

    /* ==== Hints (swipe) ==== */
    .hint{
      position:fixed; left:50%; transform:translateX(-50%); bottom:16px; z-index:50;
      padding:6px 10px; border-radius:12px; font-weight:700; color:#fff;
      background:rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.25);
      display:none;
    }
    @media (max-width:720px){ .hint{ display:block } }
  </style>
</head>
<body>
  <!-- Top overlay -->
  <div class="overlay-top">
    <div class="row">
      <div class="brand"><img src="./logo.png" alt="LM"> LeaderMath.<span style="color:#bfe7d1">UZ</span></div>
      <div class="spacer"></div>
      <button class="theme-btn" id="themeToggle">ðŸŒž Kun/Tun</button>
    </div>
    <div class="row">
      <div id="chips" class="chips"></div>
    </div>
  </div>

  <!-- Story stage -->
  <div class="stage">
    <div class="story" id="story">
      <div class="shade-top"></div>
      <div class="shade-bot"></div>
      <div class="progress" id="progress"></div>
      <iframe class="frame" id="frame" loading="eager" referrerpolicy="no-referrer"
        sandbox="allow-forms allow-pointer-lock allow-popups allow-same-origin allow-scripts"></iframe>
      <div class="tap">
        <div class="left" id="tapLeft"></div>
        <div class="right" id="tapRight"></div>
      </div>
      <div class="caption"><div id="capTitle"></div><a class="open" id="capOpen" target="_blank" rel="noopener">Ochish</a></div>
    </div>
  </div>

  <div class="hint">â€¹ chap / oâ€˜ng â€º yoki bosing â€” ushlab tursangiz pauza</div>

  <script>
    /* ==== Theme ==== */
    const root=document.documentElement, mt=document.getElementById('meta-theme-color');
    const themeBtn=document.getElementById('themeToggle');
    const saved = localStorage.getItem('lm-theme') || 'dark';
    root.setAttribute('data-theme', saved); themeBtn.textContent = saved==='dark'?'ðŸŒ™ Tun':'ðŸŒž Kun';
    mt.setAttribute('content', saved==='dark' ? '#0E1512' : '#2E8B57');
    themeBtn.onclick=()=>{
      const t=root.getAttribute('data-theme')==='dark'?'light':'dark';
      root.setAttribute('data-theme',t);
      themeBtn.textContent=t==='dark'?'ðŸŒ™ Tun':'ðŸŒž Kun';
      localStorage.setItem('lm-theme',t);
      mt.setAttribute('content', t==='dark' ? '#0E1512' : '#2E8B57');
    };

    /* ==== State ==== */
    const DUR_MS = 5000; // 5s per story
    let DATA = { sections: [] };
    let secIdx = 0, slideIdx = 0;
    let timer = null, remaining = DUR_MS, lastTick = 0;
    let paused = false;

    const $ = (s,el=document)=>el.querySelector(s);
    const chips = $('#chips');
    const frame = $('#frame');
    const progress = $('#progress');
    const story = $('#story');
    const capTitle = $('#capTitle');
    const capOpen = $('#capOpen');

    /* ==== Helpers ==== */
    function buildChips(){
      chips.innerHTML='';
      DATA.sections.forEach((s,i)=>{
        const btn=document.createElement('button');
        btn.className='chip'+(i===secIdx?' active':'');
        btn.textContent=s.icon ? `${s.icon} ${s.title||s.id}` : (s.title||s.id);
        btn.onclick=()=>{ if(secIdx!==i){ secIdx=i; slideIdx=0; syncChips(); renderProgress(); showSlide(0,true); } };
        chips.appendChild(btn);
      });
    }
    function syncChips(){
      [...chips.children].forEach((c,i)=>c.classList.toggle('active', i===secIdx));
    }

    function bannerSrcdoc(bn, sec){
      const bg = bn.bg || (sec.darkish ? '#0f1814' : '#ffffff');
      const css = `<style>*{box-sizing:border-box}html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:${bg}}a{text-decoration:none}</style>`;
      return css + (bn.html||'<div style="display:grid;place-items:center;height:100%"><h1>Boâ€˜sh banner</h1></div>');
    }

    function renderProgress(){
      progress.classList.remove('paused');
      progress.innerHTML='';
      const sec = DATA.sections[secIdx] || {banners:[]};
      (sec.banners||[]).forEach((_,i)=>{
        const bar=document.createElement('div'); bar.className='bar';
        const fill=document.createElement('div'); fill.className='fill'; bar.appendChild(fill);
        progress.appendChild(bar);
      });
    }

    function activateBars(toIdx){
      const bars = [...progress.querySelectorAll('.fill')];
      bars.forEach((f,i)=>{
        f.style.animation = 'none'; f.offsetHeight; // reset
        if(i < toIdx){ f.style.width='100%'; f.classList.remove('active'); }
        else if(i === toIdx){ f.style.removeProperty('width'); f.style.setProperty('--dur', (remaining/1000)+'s'); f.classList.add('active'); }
        else{ f.style.width='0%'; f.classList.remove('active'); }
      });
      progress.classList.toggle('paused', paused);
    }

    function showSlide(i, resetDuration=false){
      const sec = DATA.sections[secIdx]; if(!sec) return;
      const banners = sec.banners||[]; if(!banners.length) return;

      slideIdx = Math.max(0, Math.min(i, banners.length-1));
      const bn = banners[slideIdx];

      frame.srcdoc = bannerSrcdoc(bn, sec);
      capTitle.textContent = bn.title || (sec.title||'Banner');
      capOpen.href = bn.link || '#';
      if(!bn.link){ capOpen.style.display='none' } else { capOpen.style.display='inline-flex' }

      remaining = resetDuration ? DUR_MS : remaining;
      activateBars(slideIdx);

      // timer
      clearTimeout(timer);
      if(!paused){
        lastTick = performance.now();
        timer = setTimeout(()=> nextSlide(), remaining);
      }
    }

    function nextSlide(){
      const sec = DATA.sections[secIdx]; if(!sec) return;
      if(slideIdx < (sec.banners.length-1)){ remaining = DUR_MS; showSlide(slideIdx+1,true); }
      else {
        // next section, if exists
        if(secIdx < DATA.sections.length-1){ secIdx++; syncChips(); renderProgress(); remaining=DUR_MS; showSlide(0,true); }
        else { // loop to first
          secIdx=0; syncChips(); renderProgress(); remaining=DUR_MS; showSlide(0,true); }
      }
    }
    function prevSlide(){
      const sec = DATA.sections[secIdx]; if(!sec) return;
      if(slideIdx > 0){ remaining=DUR_MS; showSlide(slideIdx-1,true); }
      else {
        if(secIdx>0){ secIdx--; const prev=DATA.sections[secIdx]; syncChips(); renderProgress(); remaining=DUR_MS; showSlide((prev.banners?.length||1)-1,true); }
        else { secIdx=DATA.sections.length-1; const last=DATA.sections[secIdx]; syncChips(); renderProgress(); remaining=DUR_MS; showSlide((last.banners?.length||1)-1,true); }
      }
    }

    /* ==== Pause/Resume (hold) ==== */
    function pause(){
      if(paused) return;
      paused = true; progress.classList.add('paused');
      clearTimeout(timer);
      // compute remaining
      const elapsed = performance.now() - lastTick;
      remaining = Math.max(0, remaining - elapsed);
    }
    function resume(){
      if(!paused) return;
      paused = false; progress.classList.remove('paused');
      lastTick = performance.now();
      activateBars(slideIdx); // refresh animation duration
      timer = setTimeout(()=> nextSlide(), remaining);
    }

    /* ==== Controls ==== */
    $('#tapLeft').addEventListener('click', ()=> prevSlide());
    $('#tapRight').addEventListener('click', ()=> nextSlide());

    // hold to pause (both sides)
    ['tapLeft','tapRight'].forEach(id=>{
      const el = document.getElementById(id);
      el.addEventListener('pointerdown', ()=> pause());
      el.addEventListener('pointerup',   ()=> resume());
      el.addEventListener('pointerleave',()=> resume());
    });

    // swipe
    let startX=0, startY=0;
    story.addEventListener('touchstart', e=>{ const t=e.touches[0]; startX=t.clientX; startY=t.clientY; pause(); }, {passive:true});
    story.addEventListener('touchend', e=>{
      resume();
      const t=e.changedTouches[0]; const dx=t.clientX-startX, dy=t.clientY-startY;
      if(Math.abs(dx)>40 && Math.abs(dx)>Math.abs(dy)){ dx<0 ? nextSlide() : prevSlide(); }
    }, {passive:true});

    // keyboard
    window.addEventListener('keydown', (e)=>{
      if(e.key==='ArrowRight') nextSlide();
      else if(e.key==='ArrowLeft') prevSlide();
      else if(e.code==='Space'){ paused?resume():pause(); e.preventDefault(); }
    });

    /* ==== Load JSON and init ==== */
    async function init(){
      try{
        const res = await fetch('./banner.json', {cache:'no-store'});
        DATA = await res.json();
        if(!Array.isArray(DATA.sections) || DATA.sections.length===0) throw new Error('Boâ€˜limlar topilmadi');
        secIdx=0; slideIdx=0;
        buildChips();
        renderProgress();
        showSlide(0,true);
      }catch(err){
        console.error(err);
        frame.srcdoc = `<style>html,body{height:100%;margin:0;display:grid;place-items:center;background:#111;color:#fff;font-family:system-ui}</style>
        <div>banner.json yuklanmadi: ${String(err.message||err)}</div>`;
        document.querySelector('.caption').style.display='none';
      }
    }
    init();
  </script>
</body>
</html>
