<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LeaderMath — Banners Only</title>
  <meta name="theme-color" content="#000"/>
  <link rel="icon" href="./logo.png"/>
  <style>
    /* Ekranni to'liq egallash */
    html,body{height:100%;margin:0;background:#000;overflow:hidden}
    .stage{position:fixed;inset:0;background:#000}
    .layer{position:absolute;inset:0;opacity:0;transition:opacity .35s ease;border:0;width:100%;height:100%}
    .layer.show{opacity:1}
    /* Tap/Swipe zonalari (ko'rinmas) */
    .tap{position:absolute;inset:0;display:grid;grid-template-columns:1fr 1fr;z-index:5}
    .tap>div{height:100%}
    .tap .left{cursor:w-resize}
    .tap .right{cursor:e-resize}
  </style>
</head>
<body>
  <div class="stage">
    <!-- Double buffer iframes -->
    <iframe id="A" class="layer show" loading="eager"
      sandbox="allow-forms allow-pointer-lock allow-popups allow-same-origin allow-scripts" referrerpolicy="no-referrer"></iframe>
    <iframe id="B" class="layer"
      sandbox="allow-forms allow-pointer-lock allow-popups allow-same-origin allow-scripts" referrerpolicy="no-referrer"></iframe>

    <!-- Ko'rinmas boshqaruv zonalari -->
    <div class="tap">
      <div id="left"  class="left"  aria-label="prev"></div>
      <div id="right" class="right" aria-label="next"></div>
    </div>
  </div>

  <script>
  // ===== Sozlamalar =====
  const DUR_MS = 5000;     // har slaydga 5s
  const WRAP   = true;     // oxiridan boshiga o'tsin

  // ===== Holat =====
  let DATA = {sections:[]};
  let playlist = [];       // {secIdx, idx, html, bg, link, title}
  let ptr = 0;             // joriy indeks
  let active = 'A';        // qaysi iframe ko'rinmoqda: 'A' | 'B'
  let timer = null;
  let lastTick = 0;
  let remaining = DUR_MS;
  let paused = false;

  // ===== Qisqa yordamchilar =====
  const $ = sel => document.querySelector(sel);
  const A = $('#A'), B = $('#B');
  const L = $('#left'), R = $('#right');

  function wrapHtml(bn, sec){
    const bg = bn.bg || (sec?.darkish ? '#0f1814' : '#ffffff');
    const css = `
      <style>
        *{box-sizing:border-box}
        html,body{height:100%;margin:0;background:${bg};font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
        a{text-decoration:none}
      </style>`;
    // Bannerning o'zi: bn.html
    return css + (bn.html || `<div style="display:grid;place-items:center;height:100%;color:#888">Bo‘sh banner</div>`);
  }

  function buildPlaylist(){
    playlist = [];
    DATA.sections.forEach((sec, sI)=>{
      (sec.banners||[]).forEach((bn, bI)=>{
        playlist.push({
          secIdx: sI, idx: bI,
          html: wrapHtml(bn, sec),
          bg: bn.bg, link: bn.link, title: bn.title
        });
      });
    });
  }

  // Double-buffer render
  function renderTo(target, html){
    target.srcdoc = html;
  }
  function show(idx, resetDur=false){
    if(!playlist.length) return;
    ptr = ((idx%playlist.length)+playlist.length)%playlist.length;
    const nextLayer = active === 'A' ? B : A;
    const curLayer  = active === 'A' ? A : B;

    renderTo(nextLayer, playlist[ptr].html);
    // cross-fade
    nextLayer.classList.add('show');
    curLayer.classList.remove('show');
    active = (active === 'A') ? 'B' : 'A';

    // timer
    remaining = resetDur ? DUR_MS : remaining;
    clearTimeout(timer);
    if(!paused){
      lastTick = performance.now();
      timer = setTimeout(()=> next(), remaining);
    }
  }
  function next(){
    if(!playlist.length) return;
    const nx = ptr + 1;
    if(nx >= playlist.length){
      if(!WRAP) return;
      show(0, true);
    }else{
      show(nx, true);
    }
  }
  function prev(){
    if(!playlist.length) return;
    const pv = ptr - 1;
    if(pv < 0){
      if(!WRAP) return;
      show(playlist.length-1, true);
    }else{
      show(pv, true);
    }
  }

  // Pauza/resume (ushlab turish)
  function pause(){
    if(paused) return;
    paused = true;
    clearTimeout(timer);
    const elapsed = performance.now() - lastTick;
    remaining = Math.max(0, remaining - elapsed);
  }
  function resume(){
    if(!paused) return;
    paused = false;
    lastTick = performance.now();
    timer = setTimeout(()=> next(), remaining);
  }

  // Controls
  L.addEventListener('click', prev);
  R.addEventListener('click', next);

  ['left','right'].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener('pointerdown', pause);
    el.addEventListener('pointerup', resume);
    el.addEventListener('pointerleave', resume);
  });

  // Swipe (mobil)
  let sx=0, sy=0;
  document.addEventListener('touchstart', e=>{
    if(!e.touches[0]) return;
    sx = e.touches[0].clientX; sy = e.touches[0].clientY; pause();
  }, {passive:true});
  document.addEventListener('touchend', e=>{
    resume();
    const t = e.changedTouches[0]; if(!t) return;
    const dx = t.clientX - sx, dy = t.clientY - sy;
    if(Math.abs(dx) > 40 && Math.abs(dx) > Math.abs(dy)){ dx < 0 ? next() : prev(); }
  }, {passive:true});

  // Klaviatura
  window.addEventListener('keydown', e=>{
    if(e.key === 'ArrowRight') next();
    else if(e.key === 'ArrowLeft') prev();
    else if(e.code === 'Space'){ paused ? resume() : pause(); e.preventDefault(); }
  });

  async function init(){
    try{
      const res = await fetch('./banner.json', {cache:'no-store'});
      DATA = await res.json();
      buildPlaylist();
      if(!playlist.length){
        // JSON bo'sh bo'lsa ham "faqat banner" falsafasini buzmaslik uchun banner ichida xabar
        const msg = `<div style="display:grid;place-items:center;height:100%;background:#111;color:#fff;font-family:system-ui">
          <div style="text-align:center;opacity:.9">banner.json bo'sh</div></div>`;
        A.srcdoc = msg; A.classList.add('show'); return;
      }
      // birinchi bannerlarni har ikkala qatlamga yuklab, keyin ko'rsatish
      A.srcdoc = playlist[0].html; A.classList.add('show'); active='A';
      // 2-chi oldindan bufferga (agar bo'lsa)
      if(playlist[1]) B.srcdoc = playlist[1].html;

      // avtomatik start
      remaining = DUR_MS; lastTick = performance.now();
      timer = setTimeout(()=> next(), remaining);
    }catch(err){
      const msg = `<div style="display:grid;place-items:center;height:100%;background:#111;color:#fff;font-family:system-ui">
        <div style="text-align:center;opacity:.9">banner.json yuklanmadi</div></div>`;
      A.srcdoc = msg; A.classList.add('show');
    }
  }
  init();
  </script>
</body>
</html>
