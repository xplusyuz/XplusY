<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>LeaderMath.uz — Bosh sahifa</title>
  <meta name="theme-color" content="#2E8B57"/>
  <link rel="icon" href="./favicon.png"/>
  <style>
    :root{
      --brand:#2E8B57;--brand2:#1F6B45;
      --bg:#f4f8f6;--text:#0d1b14;--muted:#375c4c;
      --card:#ffffff;--frame:#d8e7dd;--ring:#8ad1b1;
      --chip:#eaf6f0;--chip-b:#cfe7db;--radius:16px;
    }
    :root.dark{
      --bg:#0e1512;--text:#EAF7EE;--muted:#A5C7B4;
      --card:#142018;--frame:#1e4234;--chip:#0f221b;--chip-b:#173428;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    .app{display:flex;flex-direction:column;min-height:100dvh}

    /* Appbar */
    .appbar{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#f7fbf9,rgba(247,251,249,.6));backdrop-filter: blur(8px);border-bottom:1px solid var(--frame)}
    .bar{display:flex;align-items:center;gap:12px;padding:10px 14px;max-width:1120px;margin:0 auto}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#7fd6ad,#2E8B57);display:grid;place-items:center;color:#fff;font-weight:700}
    .title{font-weight:700;letter-spacing:.2px}
    .spacer{flex:1}

    /* User chip */
    .userchip{display:flex;align-items:center;gap:10px;padding:6px 10px;border:1px solid var(--frame);background:var(--card);border-radius:999px;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.04)}
    .ava{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#bfead3,#66c79a);display:grid;place-items:center;color:#0c3a2a;font-weight:700}
    .uname{font-weight:600;max-width:130px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .score{padding:2px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-b);font-weight:700}

    /* Popover */
    .popover{position:absolute;inset:auto 12px auto auto;top:58px;max-width:360px;border:1px solid var(--frame);background:var(--card);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:14px;display:none}
    .row{display:flex;gap:12px}
    .popava{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#bfead3,#66c79a);display:grid;place-items:center;color:#0c3a2a;font-weight:800;font-size:20px}
    .popmeta{flex:1}
    .muted{color:var(--muted);font-size:13px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--frame);background:var(--card);cursor:pointer}
    .btn.pri{background:linear-gradient(180deg,#8fe3b0,#2E8B57);border-color:#1F6B45;color:#fff}
    .btn.small{padding:6px 10px;border-radius:10px;font-size:13px}
    .grp{display:flex;flex-wrap:wrap;gap:8px}
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}

    /* Chip tabs */
    .chipbar{position:sticky;top:64px;z-index:40;background:linear-gradient(180deg,#f7fbf9,rgba(247,251,249,.6));backdrop-filter:blur(8px);border-bottom:1px solid var(--frame)}
    .chips{max-width:1120px;margin:0 auto;padding:10px 14px;display:flex;gap:8px;overflow-x:auto;scrollbar-width:thin}
    .chip{white-space:nowrap;padding:8px 12px;border-radius:12px;border:1px solid var(--chip-b);background:var(--chip);cursor:pointer}
    .chip.act{background:#2E8B57;color:#fff;border-color:#1F6B45;font-weight:600}

    /* Main */
    .main{max-width:1120px;margin:16px auto;padding:0 14px 60px}
    .card{border:1px solid var(--frame);background:var(--card);border-radius:var(--radius);box-shadow:0 8px 30px rgba(0,0,0,.06)}
    .viewer{height:calc(100dvh - 220px);min-height:420px;border:none;width:100%;border-radius:inherit}
    @media (max-width:720px){ .viewer{height:calc(100dvh - 260px)} }
  </style>
</head>
<body>
<div class="app">
  <!-- APPBAR -->
  <div class="appbar">
    <div class="bar">
      <div class="logo">L</div>
      <div class="title">LeaderMath.uz</div>
      <div class="spacer"></div>

      <!-- USER CHIP -->
      <div id="userChip" class="userchip" aria-haspopup="dialog" aria-expanded="false">
        <div id="chipAva" class="ava">LM</div>
        <div class="uname" id="chipName">Foydalanuvchi</div>
        <div class="score" id="chipScore">0</div>
      </div>
    </div>
  </div>

  <!-- USER POPOVER -->
  <div id="userPop" class="popover">
    <div class="row">
      <div id="popAva" class="popava">LM</div>
      <div class="popmeta">
        <div style="font-weight:700" id="popName">Foydalanuvchi</div>
        <div class="muted" id="popInfo">Maktab / Sinf</div>
        <div class="grp mt8">
          <button class="btn small" id="editProfileBtn">Profilni tahrirlash</button>
          <button class="btn small" id="addScoreBtn">+50 ball</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CHIP BAR -->
  <div class="chipbar">
    <div id="chipList" class="chips" role="tablist" aria-label="Bo‘limlar"></div>
  </div>

  <!-- MAIN -->
  <main class="main">
    <div class="card">
      <iframe id="viewer" class="viewer" sandbox="allow-scripts"></iframe>
    </div>
  </main>
</div>

<script>
/* ===== Helpers & State ===== */
const qs = (s, r=document)=>r.querySelector(s);
const qsa= (s, r=document)=>Array.from(r.querySelectorAll(s));
const store = {
  get(k, d=null){ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)) }
};
const PROFILE_KEY = "lm.profile.v1";
const LAST_CHIP_KEY = "lm.lastChip";
let CHIP_DATA = { chips: [] };

/* ===== User Panel ===== */
function initProfile(){
  let p = store.get(PROFILE_KEY, null);
  if(!p){ p={name:"Foydalanuvchi",school:"",klass:"",phone:"",score:0}; store.set(PROFILE_KEY,p); }
  renderUser(p);
}
function initials(name){
  const parts = String(name||"").trim().split(/\s+/);
  return ((parts[0]?.[0]||"L") + (parts[1]?.[0]||"M")).toUpperCase();
}
function renderUser(p){
  qs("#chipName").textContent = p.name || "Foydalanuvchi";
  qs("#chipScore").textContent = (p.score|0);
  qs("#chipAva").textContent = initials(p.name);
  qs("#popAva").textContent = initials(p.name);
  qs("#popName").textContent = p.name || "Foydalanuvchi";
  qs("#popInfo").textContent = [p.school, p.klass].filter(Boolean).join(" • ") || "Maktab / Sinf";
}
const userChip = qs("#userChip"), userPop = qs("#userPop");
userChip.addEventListener("click", ()=>{
  const open = userPop.style.display === "block";
  userPop.style.display = open ? "none" : "block";
  userChip.setAttribute("aria-expanded", String(!open));
});
document.addEventListener("click",(e)=>{
  if(!userPop.contains(e.target) && !userChip.contains(e.target)){
    userPop.style.display="none"; userChip.setAttribute("aria-expanded","false");
  }
});
qs("#editProfileBtn").onclick = ()=> openProfileModal();
qs("#addScoreBtn").onclick = ()=>{
  const p = store.get(PROFILE_KEY, {}); p.score = (p.score|0)+50; store.set(PROFILE_KEY,p); renderUser(p);
};
function openProfileModal(){
  const p = store.get(PROFILE_KEY, {});
  const html = `
    <div style="position:fixed;inset:0;background:rgba(0,0,0,.35);display:grid;place-items:center;z-index:60" id="mb">
      <div style="width:min(560px,96vw);border:1px solid var(--frame);background:var(--card);border-radius:16px;padding:16px">
        <h2 style="margin:4px 0 8px">Profil</h2>
        <div style="display:grid;gap:6px;margin:10px 0">
          <label>F.I.Sh <input id="pfName" value="${esc(p.name||"")}" style="width:100%;padding:10px;border:1px solid var(--frame);border-radius:12px;background:transparent;color:var(--text)"></label>
          <label>Maktab <input id="pfSchool" value="${esc(p.school||"")}" style="width:100%;padding:10px;border:1px solid var(--frame);border-radius:12px;background:transparent;color:var(--text)"></label>
          <label>Sinf (masalan: 9-A) <input id="pfKlass" value="${esc(p.klass||"")}" style="width:100%;padding:10px;border:1px solid var(--frame);border-radius:12px;background:transparent;color:var(--text)"></label>
          <label>Telefon <input id="pfPhone" value="${esc(p.phone||"")}" style="width:100%;padding:10px;border:1px solid var(--frame);border-radius:12px;background:transparent;color:var(--text)"></label>
          <label>Ball <input id="pfScore" type="number" value="${Number(p.score||0)}" style="width:100%;padding:10px;border:1px solid var(--frame);border-radius:12px;background:transparent;color:var(--text)"></label>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="pfSave" style="padding:10px 14px;border-radius:12px;border:1px solid #1F6B45;background:#2E8B57;color:#fff">Saqlash</button>
          <button id="pfCancel" style="padding:10px 14px;border-radius:12px;border:1px solid var(--frame);background:var(--card)">Bekor</button>
        </div>
      </div>
    </div>`;
  document.body.insertAdjacentHTML("beforeend", html);
  qs("#pfSave").onclick=()=>{
    const np = {
      name:qs("#pfName").value.trim(),
      school:qs("#pfSchool").value.trim(),
      klass:qs("#pfKlass").value.trim(),
      phone:qs("#pfPhone").value.trim(),
      score:Number(qs("#pfScore").value)||0
    };
    store.set(PROFILE_KEY,np); renderUser(np); qs("#mb").remove();
  };
  qs("#pfCancel").onclick=()=>qs("#mb").remove();
}

/* ===== Chips from admin.json ===== */
async function loadChips(){
  try{
    const res = await fetch("./admin.json",{cache:"no-store"});
    if(!res.ok) throw new Error("admin.json not found");
    CHIP_DATA = await res.json();
  }catch{
    CHIP_DATA = {chips:[{id:"welcome",label:"Bosh sahifa",order:1,visible:true,html:`<!doctype html>
<html><head><meta charset="utf-8"><title>Welcome</title>
<style>body{font:16px system-ui;margin:0;padding:24px} .h{font-weight:800;font-size:28px}</style></head>
<body>
  <div class="h">LeaderMath.uz — Xush kelibsiz!</div>
  <p>Bu kontent <b>admin.json</b> bo'lmasa ham, avtomatik namuna sifatida chiqadi.</p>
  <button id="b">+1</button> <span id="c">0</span>
  <script>let n=0; b.onclick=()=>{ c.textContent=++n };</script>
</body></html>`}]};
  }
  CHIP_DATA.chips=(CHIP_DATA.chips||[]).filter(c=>c && (c.visible!==false)).sort((a,b)=>(a.order||999)-(b.order||999));
  renderChipTabs();
}
function renderChipTabs(){
  const wrap = qs("#chipList"); wrap.innerHTML="";
  CHIP_DATA.chips.forEach(ch=>{
    const el = document.createElement("button");
    el.className="chip"; el.role="tab"; el.dataset.id=ch.id;
    el.textContent = ch.label || ch.id;
    el.onclick=()=> activateChip(ch.id);
    wrap.appendChild(el);
  });
  const last = store.get(LAST_CHIP_KEY, CHIP_DATA.chips[0]?.id);
  const exists = CHIP_DATA.chips.find(c=>c.id===last)?.id || CHIP_DATA.chips[0]?.id;
  if(exists) activateChip(exists);
}
function activateChip(id){
  const chip = CHIP_DATA.chips.find(c=>c.id===id); if(!chip) return;
  qsa(".chip").forEach(x=>x.classList.toggle("act", x.dataset.id===id));
  const iframe = qs("#viewer"); const doc = iframe.contentWindow.document;
  doc.open(); doc.write(chip.html || "<!doctype html><meta charset='utf-8'><body>Bo‘sh chip</body>"); doc.close();
  store.set(LAST_CHIP_KEY, id);
}

/* ===== Utils & Boot ===== */
function esc(x=''){return x.replace(/[&<>\"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
initProfile();
loadChips();
</script>
</body>
</html>
