<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>LeaderMath — Home Renderer</title>
  <meta name="theme-color" content="#2E8B57">
  <style>
    :root{
      --brand:#2E8B57; --bg:#f4f8f6; --text:#0d1b14; --muted:#446c59;
      --card:#ffffff; --line:#dfe7e2; --ring:#8ad1b1;
      --radius:14px; --radius-lg:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,Segoe UI,Arial}
    header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--line);z-index:50}
    .row{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px}
    .brand{font-weight:800;color:var(--brand);letter-spacing:.2px}
    main{max-width:1200px;margin:0 auto;padding:14px;display:grid;gap:14px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .ghost{opacity:.65}
    button,.btn{padding:8px 12px;border:1px solid var(--line);border-radius:999px;background:#fff;cursor:pointer}
    .btn-primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn-ghost{background:#fff}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .section{border:1px solid var(--line);background:var(--card);border-radius:var(--radius-lg);overflow:hidden}
    .section.fullBleed{border:none;border-radius:0;background:transparent}
    .sec-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
    .sec-title{font-weight:800}
    .sec-body{padding:12px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:960px){.grid{grid-template-columns:1fr 1fr}}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid var(--line);background:var(--card);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:10px}
    .card h4{margin:0;font-size:16px}
    .rowflex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .badge{padding:4px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#f0f7f3}
    .badge.soon{background:#fff8e5;border-color:#f2d48a}
    .badge.active{background:#eaf6ef;border-color:#84d1a8}
    .badge.ended{background:#f5f5f5}
    .muted{color:var(--muted)}
    .ratio{position:relative;width:100%;overflow:hidden;border:1px solid var(--line);border-radius:16px;background:#fff}
    .ratio[data-r="16-9"]::before{content:"";display:block;padding-top:56.25%}
    .ratio>iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
    /* fullBleed banner */
    .bleed{position:relative;width:100%;height:100vh}
    .bleed>iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
    /* modal */
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal-box{width:min(900px,96vw);max-height:90vh;overflow:auto;background:#fff;border-radius:16px;border:1px solid var(--line);box-shadow:0 30px 80px rgba(0,0,0,.25)}
    .modal-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
    .modal-body{padding:12px}
    .sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0 0 0 0);white-space:nowrap}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    // ==== Firebase (sizniki) ====
    const firebaseConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.appspot.com",
      messagingSenderId: "992512966017",
      appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId: "G-459PLJ7P7L"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // ==== Utilities ====
    const $  = (s,el=document)=>el.querySelector(s);
    const el = (tag,attrs={},html)=>{ const n=document.createElement(tag); for(const k in attrs) n.setAttribute(k,attrs[k]); if(html!==undefined) n.innerHTML=html; return n; };

    // Parse "YYYY-MM-DD HH:mm" as local
    function parseLocal(s){
      if(!s) return null;
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/);
      if(!m) return null;
      const [_,Y,M,D,h,mn] = m;
      return new Date(Number(Y), Number(M)-1, Number(D), Number(h), Number(mn), 0, 0);
    }
    function cardState(it){
      if(it.cardStyle==='soon') return 'soon';
      if(it.cardStyle==='timed'){
        const now = new Date();
        const s = parseLocal(it.startAt), e = parseLocal(it.endAt);
        if(s && now < s) return 'soon';
        if(s && e && now >= s && now <= e) return 'active';
        if(e && now > e) return 'ended';
        // Fallback
        return 'active';
      }
      return 'available';
    }
    function fmt(dt){
      if(!dt) return '-';
      const pad = n=>String(n).padStart(2,'0');
      return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    }

    // ==== Modal ====
    let MODAL=null;
    function openModal(title, html){
      const back = $('#modal');
      const box  = $('.modal-box', back);
      $('.modal-title', back).textContent = title || '';
      const body = $('.modal-body', back);
      body.innerHTML = html || '';
      back.style.display='flex';
      MODAL = back;
    }
    function closeModal(){ if(MODAL){ MODAL.style.display='none'; MODAL=null; } }

    // ==== Rendering ====
    function renderRoot(data){
      const wrap = $('#content');
      wrap.innerHTML = '';
      const sections = Array.isArray(data.sections)? data.sections: [];
      sections.forEach(sec=>{
        wrap.appendChild(renderSection(sec));
      });
    }

    function renderSection(sec){
      const box = el('section', {class:`section${sec.fullBleed?' fullBleed':''}`});
      const title = sec.title || sec.id || 'Bo‘lim';
      // Head (skip border for fullBleed)
      if(!sec.fullBleed){
        const head = el('div',{class:'sec-head'});
        head.appendChild(el('div',{class:'sec-title'}, title));
        head.appendChild(el('div',{class:'muted'}, sec.baseHref?`base: ${sec.baseHref}`:''));
        box.appendChild(head);
      }

      // Body
      const body = el('div',{class:'sec-body'});
      // Items first
      const items = Array.isArray(sec.items)? sec.items : [];

      // fullBleed → faqat bannerlarni to‘liq ekranda ko‘rsatamiz; cardlar bo‘lsa odatdagi konteynerda pastda
      const banners = items.filter(i=>i.kind==='banner');
      const cards   = items.filter(i=>i.kind==='card');

      if(sec.fullBleed && banners.length){
        banners.forEach(b=>{
          body.appendChild(renderBanner(b, true, sec.baseHref));
        });
      } else if(banners.length){
        // 16:9 konteynerlarda
        banners.forEach(b=>{
          body.appendChild(renderBanner(b, false, sec.baseHref));
        });
      }

      if(cards.length){
        const grid = el('div',{class:'grid'});
        cards.forEach(c=> grid.appendChild(renderCard(c)));
        body.appendChild(grid);
      }

      // Subsections (recursive, meta ko‘rinishda; fullBleed bo‘lsa ichki bo‘limlar oddiy ko‘rinishda)
      const subs = Array.isArray(sec.subsections)? sec.subsections: [];
      subs.forEach(ss=>{
        body.appendChild(renderSubSection(ss));
      });

      if(sec.fullBleed){
        // fullBleed bo‘limda body’ni section ichiga to‘g‘ridan kiritamiz (borderyoq)
        box.appendChild(body);
      }else{
        box.appendChild(body);
      }
      return box;
    }

    function renderSubSection(ss){
      const title = ss.title || ss.id || 'Sub-bo‘lim';
      const card = el('div',{class:'section'});
      const head = el('div',{class:'sec-head'});
      head.appendChild(el('div',{class:'sec-title'}, title));
      card.appendChild(head);
      const body = el('div',{class:'sec-body'});

      const items = Array.isArray(ss.items)? ss.items: [];
      const banners = items.filter(i=>i.kind==='banner');
      const cards   = items.filter(i=>i.kind==='card');

      banners.forEach(b=> body.appendChild(renderBanner(b, false)));
      if(cards.length){
        const grid = el('div',{class:'grid'});
        cards.forEach(c=> grid.appendChild(renderCard(c)));
        body.appendChild(grid);
      }

      const subs = Array.isArray(ss.subsections)? ss.subsections: [];
      subs.forEach(iii=> body.appendChild(renderSubSection(iii)));

      card.appendChild(body);
      return card;
    }

    function renderBanner(b, fullBleed=false, inheritedBaseHref=null){
      const baseHref = b.baseHref || inheritedBaseHref || '';
      if(b.mode==='url'){
        if(fullBleed){
          const r = el('div',{class:'bleed'});
          const f = el('iframe',{src:b.src||'', sandbox:b.sandbox||'allow-scripts allow-forms'});
          r.appendChild(f);
          return r;
        }else{
          const r = el('div',{class:'ratio','data-r':'16-9'});
          const f = el('iframe',{src:b.src||'', sandbox:b.sandbox||'allow-scripts allow-forms'});
          r.appendChild(f);
          return r;
        }
      }else{
        const srcdoc = (()=>{
          const html = String(b.contentHtml||'');
          // base qo‘llash
          const baseTag = baseHref ? `<base href="${baseHref}">` : '';
          return `<!doctype html><html><head>${baseTag}<meta charset="utf-8"></head><body style="margin:0">${html}</body></html>`;
        })();
        if(fullBleed){
          const r = el('div',{class:'bleed'});
          const f = el('iframe',{sandbox:b.sandbox||'allow-scripts allow-forms'});
          f.srcdoc = srcdoc;
          r.appendChild(f);
          return r;
        }else{
          const r = el('div',{class:'ratio','data-r':'16-9'});
          const f = el('iframe',{sandbox:b.sandbox||'allow-scripts allow-forms'});
          f.srcdoc = srcdoc;
          r.appendChild(f);
          return r;
        }
      }
    }

    function renderCard(it){
      const c = el('div',{class:'card'});
      const title = it.title || 'Card';
      const state = cardState(it);
      const row1 = el('div',{class:'rowflex'});
      row1.appendChild(el('h4',{}, title));
      const badge = el('span',{class:`badge ${state==='soon'?'soon':state==='active'?'active':state==='ended'?'ended':''}`},
        state==='soon' ? 'Yaqinda'
        : state==='active' ? 'Faol'
        : state==='ended' ? 'Tugagan'
        : 'Mavjud');
      row1.appendChild(badge);
      c.appendChild(row1);

      // Timers info
      if(it.cardStyle==='timed'){
        const s = parseLocal(it.startAt), e = parseLocal(it.endAt);
        const info = el('div',{class:'muted'}, `Vaqt: ${fmt(s)} — ${fmt(e)}`);
        c.appendChild(info);
      }

      // Actions
      const actions = el('div',{class:'rowflex'});
      const infoBtn = el('button',{class:'btn'}, 'ℹ️ Info');
      infoBtn.onclick = ()=> openModal(title, it.infoHtml || '<p class="muted">Ma’lumot yo‘q.</p>');
      actions.appendChild(infoBtn);

      const label = it.ctaLabel || 'Boshlash';
      const href  = it.ctaHref  || '';
      const startBtn = el('a',{class:`btn btn-primary${(state==='soon' || state==='ended')?' btn-ghost':''}`, href: href || '#', target: href?'_blank':'_self'}, label);
      if(state==='soon' || state==='ended' || !href){ startBtn.setAttribute('disabled',''); startBtn.removeAttribute('href'); }
      actions.appendChild(startBtn);

      c.appendChild(actions);
      return c;
    }

    // ==== Load order ====
    async function tryLoadFromFirestore(){
      const snap = await getDoc(doc(db,'configs','home'));
      if(snap.exists()){
        return snap.data();
      }
      return null;
    }

    async function boot(){
      const data = await tryLoadFromFirestore();
      if(data && Array.isArray(data.sections) && data.sections.length){
        renderRoot(data);
        $('.ghost', $('#fallback')).textContent='(Firestore’dan yuklandi)';
      }else{
        // Fallback: local file upload
        $('#fallback').style.display='block';
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      // Modal close
      $('#modal').addEventListener('click', (e)=>{ if(e.target.id==='modal' || e.target.id==='mclose') closeModal(); });
      // Local upload
      $('#loadfile').addEventListener('change', async (e)=>{
        const f = e.target.files[0]; if(!f) return;
        try{
          const txt = await f.text();
          const obj = JSON.parse(txt);
          renderRoot(obj);
          $('.ghost', $('#fallback')).textContent='(home.json’dan yuklandi)';
        }catch(err){
          alert('JSON xato: '+err.message);
        }
      });
      boot();
    });
  </script>
</head>
<body>
  <header>
    <div class="row">
      <div class="brand">LeaderMath — Home</div>
      <div style="margin-left:auto" class="ghost" id="srcnote"></div>
    </div>
  </header>

  <main id="content"></main>

  <!-- Firestore bo'sh bo'lsa: local JSON yuklash -->
  <section id="fallback" class="section" style="display:none;max-width:1200px;margin:12px auto">
    <div class="sec-head">
      <div class="sec-title">Home.json yuklash</div>
      <div class="ghost">(manba aniqlanmoqda)</div>
    </div>
    <div class="sec-body">
      <div class="toolbar">
        <label class="btn">JSON tanlang <input id="loadfile" type="file" accept="application/json" style="display:none"></label>
        <span class="muted">Admin panelingizdan eksport qilingan <code>home.json</code> ni tanlang.</span>
      </div>
    </div>
  </section>

  <!-- Modal -->
  <div id="modal" class="modal-back" aria-hidden="true">
    <div class="modal-box" role="dialog" aria-modal="true" aria-labelledby="mtitle">
      <div class="modal-head">
        <div id="mtitle" class="modal-title">Info</div>
        <button id="mclose" class="btn">✕</button>
      </div>
      <div class="modal-body"></div>
    </div>
  </div>

  <span class="sr-only">Renderer loaded</span>
</body>
</html>
