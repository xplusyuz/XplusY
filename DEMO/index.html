<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LeaderMath.UZ — Home + Profil</title>

  <!-- Favicon / logo -->
  <link rel="icon" href="./logo.png" sizes="any">
  <link rel="apple-touch-icon" href="./logo.png">
  <meta name="theme-color" content="#2E8B57"/>

  <style>
  /* =========================================
     LeaderMath.UZ — High-end UI Theme (v2)
     ========================================= */
  :root{
    --brand:#2E8B57; --brand-600:#25724a; --brand-700:#1f6240;
    --bg:#F7FAF8; --bg-2:#EEF4F0; --card:#FFFFFF; --text:#0f1b15;
    --muted:#5b7467; --line:#E3EBE6;
    --shadow-sm:0 4px 18px rgba(20,40,30,.06);
    --shadow-md:0 12px 40px rgba(16,32,23,.08);
    --blur:saturate(1.1) blur(8px);
    --radius-sm:12px; --radius:16px; --radius-lg:22px; --speed:.22s;
    --ring:0 0 0 3px color-mix(in srgb, var(--brand) 40%, transparent);
    --font:system-ui, Segoe UI, Inter, Arial;
  }
  html[data-theme="dark"]{
    --bg:#0c1110; --bg-2:#111815; --card:#111816; --text:#EBF4EF; --muted:#96a79f; --line:#1d2a25;
    --shadow-sm:0 6px 20px rgba(0,0,0,.35); --shadow-md:0 18px 60px rgba(0,0,0,.45);
    --ring:0 0 0 3px color-mix(in srgb, var(--brand) 60%, transparent);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,var(--bg) 0%,var(--bg-2) 100%);
    color:var(--text); font:16px/1.55 var(--font);
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  }

  /* Header (glass) */
  .hdr{
    position:sticky; top:0; z-index:50; backdrop-filter:var(--blur);
    background:linear-gradient(180deg,
      color-mix(in srgb, var(--card) 80%, transparent) 0%,
      color-mix(in srgb, var(--card) 40%, transparent) 70%,
      transparent 100%);
    border-bottom:1px solid color-mix(in srgb, var(--line) 60%, transparent);
  }
  .row{max-width:1180px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:14px}
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px}
  .brand b{color:var(--brand)}
  .grow{flex:1}

  /* === New: contact bar in header === */
  .contactbar{
    max-width:1180px; margin:0 auto; padding:8px 16px 12px;
    display:flex; align-items:center; gap:14px; flex-wrap:wrap;
  }
  .contactbar a{
    display:inline-flex; align-items:center; gap:8px;
    color:var(--muted); text-decoration:none; font-weight:600;
    border:1px solid var(--line); background:var(--card);
    padding:8px 10px; border-radius:999px; box-shadow:var(--shadow-sm);
  }
  .contactbar a:hover{ color:var(--brand); box-shadow:var(--shadow-md); transform:translateY(-1px); }
  .ico{ width:20px; height:20px; display:inline-block; }

  /* Chips (tabs) */
  .chipbar{max-width:1180px;margin:6px auto 0;padding:0 16px 14px;display:flex;flex-wrap:wrap;gap:10px}
  .chip{
    appearance:none;border:1px solid var(--line);background:var(--card);
    border-radius:999px;padding:10px 14px;cursor:pointer;transition:all var(--speed) ease;
    box-shadow:var(--shadow-sm);font-weight:600;color:var(--text)
  }
  .chip:hover{transform:translateY(-1px);box-shadow:var(--shadow-md)}
  .chip:focus-visible{outline:var(--ring)}
  .chip.active{
    background:linear-gradient(180deg,color-mix(in srgb, var(--brand) 90%, #fff) 0%, var(--brand) 100%);
    color:#fff;border-color:transparent;transform:translateY(-1px)
  }

  /* Sections */
  main{max-width:1180px;margin:0 auto;padding:12px 16px 44px}
  .section{
    background:var(--card);border:1px solid var(--line);border-radius:var(--radius-lg);
    box-shadow:var(--shadow-md);overflow:hidden;transition:transform var(--speed),box-shadow var(--speed)
  }
  .section:not(.h-bleed):hover{transform:translateY(-2px);box-shadow:0 16px 70px rgba(16,32,23,.12)}
  .section-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,color-mix(in srgb, var(--card) 85%, transparent),transparent)}
  .section-hdr h3{margin:0;font-size:18px;letter-spacing:.2px}
  .iframe-wrap{position:relative}
  iframe.sbx{display:block;width:100%;min-height:640px;border:0;background:#fff}

  /* Auth modal */
  .lock{position:fixed;inset:0;display:grid;place-items:center;background:color-mix(in srgb, var(--bg) 70%, #0000);backdrop-filter:blur(2px)}
  .card{width:min(520px,96vw);background:var(--card);border:1px solid var(--line);border-radius:20px;box-shadow:var(--shadow-md);padding:22px}
  .title{display:flex;align-items:center;gap:10px;font-weight:800}
  .hint{color:var(--muted);font-size:14px;margin:6px 0 12px}

  .btn{
    appearance:none;border:1px solid var(--line);background:var(--card);color:var(--text);
    padding:12px 16px;border-radius:14px;cursor:pointer;transition:all var(--speed);
    display:inline-flex;align-items:center;justify-content:center;gap:8px;font-weight:700;box-shadow:var(--shadow-sm)
  }
  .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-md)}
  .btn:active{transform:translateY(0)}
  .btn:focus-visible{outline:var(--ring)}
  .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
  .btn.full{width:100%}

  .fld{display:grid;gap:8px;margin:10px 0}
  .fld input,.fld select,.fld textarea{
    width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--line);
    background:linear-gradient(180deg,var(--card),color-mix(in srgb, var(--card) 92%, #000));
    color:var(--text);transition:border-color var(--speed),box-shadow var(--speed),background var(--speed);outline:none
  }
  .fld input::placeholder,.fld textarea::placeholder{color:color-mix(in srgb, var(--muted) 70%, transparent)}
  .fld input:focus,.fld select:focus,.fld textarea:focus{border-color:color-mix(in srgb, var(--brand) 50%, var(--line));box-shadow:var(--ring)}

  .rowx{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  #err{color:#c62828;min-height:18px}

  /* User chip + menu */
  .userchip{
    border:1px solid var(--line);background:var(--card);padding:6px 10px;border-radius:999px;box-shadow:var(--shadow-sm);
    display:flex;align-items:center;gap:10px;cursor:pointer;position:relative;transition:box-shadow var(--speed),transform var(--speed)
  }
  .userchip:hover{box-shadow:var(--shadow-md);transform:translateY(-1px)}
  .avatar{width:32px;height:32px;border-radius:50%;overflow:hidden;background:linear-gradient(135deg,#dcefe5,#f1faf5)}
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .menu{position:absolute;right:0;top:46px;min-width:240px;background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow-md);display:none;overflow:hidden}
  .menu.open{display:block;animation:pop .12s ease-out}
  .menu a{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px 14px;color:inherit;text-decoration:none;border-bottom:1px solid var(--line);transition:background var(--speed)}
  .menu a:last-child{border-bottom:none}
  .menu a:hover{background:color-mix(in srgb, var(--brand) 10%, transparent)}

  /* Overlay / profile */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.18);display:none;place-items:center;z-index:60}
  .overlay.show{display:grid;animation:fade .16s ease-out}
  .profile-card{width:min(820px,96vw);background:var(--card);border:1px solid var(--line);border-radius:20px;box-shadow:var(--shadow-md);padding:22px;animation:pop .14s ease-out}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
  .muted{color:var(--muted);font-size:13px}
  .divider{height:1px;background:var(--line);margin:12px 0}
  .hide{display:none}

  /* Responsive */
  @media (max-width:900px){
    .grid2,.grid3{grid-template-columns:1fr}
    iframe.sbx{min-height:520px}
    .contactbar{justify-content:center}
  }
  @media (hover:none){.chip:hover,.btn:hover,.userchip:hover{transform:none;box-shadow:var(--shadow-sm)}}

  @keyframes pop{from{transform:translateY(6px) scale(.98);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
  @keyframes fade{from{opacity:0}to{opacity:1}}
  </style>
</head>
<body>
  <header class="hdr">
    <div class="row">
      <div class="brand">
        <!-- Logo kattaroq: 52px -->
        <img src="./logo.png" alt="LM" width="52" height="52" style="border-radius:12px"/>
        <div style="display:grid;line-height:1.1">
          <span style="font-size:18px;font-weight:800">LeaderMath.<b style="color:var(--brand)">UZ</b></span>
          <small style="color:var(--muted)">Matematika platformasi</small>
        </div>
      </div>
      <div class="grow"></div>
      <div id="user-slot"></div>
    </div>

    <!-- Aloqa bloklari -->
    <div class="contactbar">
      <a href="tel:+998901234567"><svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M6.6 10.2c1.5 2.9 3.9 5.2 6.8 6.8l2.3-2.3c.3-.3.8-.4 1.2-.3 1 .3 2 .4 3 .4.7 0 1.1.5 1.1 1.1V20c0 .7-.5 1.1-1.1 1.1C10.6 21.1 2.9 13.4 2.9 3.1 2.9 2.5 3.4 2 4.1 2h3.1c.7 0 1.1.5 1.1 1.1 0 1 .1 2 .4 3 .1.4 0 .9-.3 1.2L6.6 10.2z"/></svg> +998 90 123 45 67</a>
      <a href="mailto:info@leadermath.uz"><svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5L4 8V6l8 5 8-5v2z"/></svg> info@leadermath.uz</a>
      <a href="https://t.me/LeaderMathUZ" target="_blank"><svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M9.4 15.6 9.1 19c.4 0 .6-.2.9-.4l2-1.8 4.2 3.1c.8.5 1.4.2 1.6-.7l2.9-13.7c.3-1.3-.5-1.8-1.3-1.5L2.6 9.6c-1.3.5-1.3 1.2-.2 1.5l4.8 1.5 11.3-7c.5-.3 1-.1.6.2"/></svg> Telegram</a>
      <a href="https://t.me/LeaderMathBot" target="_blank"><svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M9.4 15.6 9.1 19c.4 0 .6-.2.9-.4l2-1.8 4.2 3.1c.8.5 1.4.2 1.6-.7l2.9-13.7c.3-1.3-.5-1.8-1.3-1.5L2.6 9.6c-1.3.5-1.3 1.2-.2 1.5l4.8 1.5 11.3-7c.5-.3 1-.1.6.2"/></svg> Bot</a>
      <a href="https://instagram.com/leadermath.uz" target="_blank"><svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm5 5a5 5 0 1 0 .001 10.001A5 5 0 0 0 12 7zm0 2.5a2.5 2.5 0 1 1-.001 5.001A2.5 2.5 0 0 1 12 9.5zm5.2-3a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/></svg> Instagram</a>
      <a href="https://www.youtube.com/@leadermathuz" target="_blank"><svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M23.5 6.2s-.2-1.6-.9-2.3c-.9-.9-1.8-.9-2.2-1C16.9 2.5 12 2.5 12 2.5h-.1s-4.9 0-8.4.4c-.4.1-1.3.1-2.2 1-.7.7-.9 2.3-.9 2.3S0 8.1 0 10v1.9c0 1.9.5 3.8.5 3.8s.2 1.6.9 2.3c.9.9 2.1.9 2.6 1 1.9.2 8 .4 8 .4s4.9 0 8.4-.4c.4-.1 1.3-.1 2.2-1 .7-.7.9-2.3.9-2.3S24 13.8 24 12V10c0-1.9-.5-3.8-.5-3.8zM9.5 14.6V7.9l6.4 3.3-6.4 3.4z"/></svg> YouTube</a>
    </div>

    <nav id="chipbar" class="chipbar"></nav>
  </header>

  <main id="app"><div id="sections"></div></main>
  <div id="overlay" class="overlay"></div>

  <script type="module">
  /* ================== Firebase ================== */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import {
    getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, setPersistence,
    browserLocalPersistence, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword
  } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getStorage, ref as sRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
    authDomain: "xplusy-760fa.firebaseapp.com",
    projectId: "xplusy-760fa",
    storageBucket: "xplusy-760fa.appspot.com",
    messagingSenderId: "992512966017",
    appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
    measurementId: "G-459PLJ7P7L"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const st   = getStorage(app);
  try { await setPersistence(auth, browserLocalPersistence); } catch {}

  /* ===== Helpers / State ===== */
  const q  = (s, r=document) => r.querySelector(s);
  const qa = (s, r=document) => [...r.querySelectorAll(s)];
  const ALWAYS_REQ = ['firstName','lastName','birthDate','region','district','role']; // O‘quvchi bo‘lsa class ham

  let REGIONS = [];
  let CURRENT_USER = null;
  let PROFILE = null;
  let USER_POINTS = 0;

  const calcAge = iso => { try{const b=new Date(iso), t=new Date(); let a=t.getFullYear()-b.getFullYear(); const m=t.getMonth()-b.getMonth(); if(m<0||(m===0&&t.getDate()<b.getDate())) a--; return a;}catch{return '';} };
  async function getProfile(uid){ const s=await getDoc(doc(db,'profiles',uid)); return s.exists()? s.data(): null; }
  async function saveProfile(uid,data){ data.updatedAt=serverTimestamp(); if(!PROFILE) data.createdAt=serverTimestamp(); await setDoc(doc(db,'profiles',uid),data,{merge:false}); PROFILE=data; }
  async function getUserPoints(uid){ try{ const s=await getDoc(doc(db,'users',uid)); return s.exists()? (s.data().points||0):0; }catch{return 0;} }

  async function loadRegions(){
    try{
      const r=await fetch('./region.json',{cache:'no-store'}); if(!r.ok) throw 0;
      const j=await r.json(); return j?.regions||[];
    }catch{
      return [
        { name:"Toshkent", districts:[{name:"Chilonzor",schools:["1-maktab","12-maktab"]},{name:"Olmazor",schools:["5-maktab","14-maktab"]}]},
        { name:"Samarqand", districts:[{name:"Urgut",schools:["3-maktab","28-maktab"]}]}
      ];
    }
  }

  /* -------------------- Header chip -------------------- */
  function renderUserChip(u, profile){
    const slot = q('#user-slot'); if(!slot) return;
    const age  = profile?.birthDate ? calcAge(profile.birthDate) : '';
    const name = profile?.firstName ? (profile.firstName + (profile.lastName? ' ' + profile.lastName : '')) : (u.displayName || u.email || 'Foydalanuvchi');
    const avatar = profile?.avatarUrl || u.photoURL || '';
    const role = profile?.role || '—';
    slot.innerHTML = `
      <div class="userchip" id="userchip">
        <div class="avatar">${avatar? `<img src="${avatar}" alt="">`:''}</div>
        <div style="display:grid;line-height:1">
          <b style="font-size:14px">${name}</b>
          <small class="mini">${role} • ${age? age+' yosh • ':''}${USER_POINTS} points</small>
        </div>
        <div class="menu" id="usermenu">
          <a href="#" id="mProfile">Profil</a>
          <a href="#" id="mEdit">Profilni tahrirlash</a>
          <a href="#" id="mLogout">Chiqish</a>
        </div>
      </div>`;
    const chip = q('#userchip',slot), menu=q('#usermenu',slot);
    chip.onclick = ()=> menu.classList.toggle('open');
    q('#mLogout',slot).onclick = (e)=>{ e.preventDefault(); menu.classList.remove('open'); signOut(auth); };
    q('#mProfile',slot).onclick = (e)=>{ e.preventDefault(); menu.classList.remove('open'); openProfileView(); };
    q('#mEdit',slot).onclick    = (e)=>{ e.preventDefault(); menu.classList.remove('open'); openProfileEditor(); };
  }

  /* -------------------- Profile VIEW -------------------- */
  function openProfileView(){
    const d = PROFILE || {};
    const name = (d.firstName||'') + (d.lastName? ' '+d.lastName:'');
    const age  = d.birthDate? calcAge(d.birthDate): '';
    const avatar = d.avatarUrl || (CURRENT_USER?.photoURL||'');
    const html = `
      <div class="profile-card">
        <div class="rowx" style="align-items:center">
          <div class="avatar" style="width:56px;height:56px;border-radius:14px;overflow:hidden;background:#f2f6f3">${avatar?`<img src="${avatar}" alt="">`:''}</div>
          <div style="display:grid"><b style="font-size:18px">${name||'—'}</b>
            <span class="muted">${(d.role||'—')} • ${age? age+' yosh • ':''}${USER_POINTS} points</span>
          </div>
          <div class="grow"></div>
          <button class="btn" id="toEdit">Tahrirlash</button>
          <button class="btn" id="closeView">Yopish</button>
        </div>
        <div class="divider"></div>
        <div class="grid3">
          <div><div class="muted">Viloyat</div><b>${d.region||'—'}</b></div>
          <div><div class="muted">Tuman</div><b>${d.district||'—'}</b></div>
          <div><div class="muted">Tug‘ilgan sana</div><b>${d.birthDate||'—'}</b></div>
        </div>
        ${d.role==='O‘quvchi'?`
        <div style="height:6px"></div>
        <div class="grid3">
          <div><div class="muted">Sinf</div><b>${d.class||'—'}</b></div>
          <div><div class="muted">Maktab</div><b>${d.school||d.schoolCustom||'—'}</b></div>
          <div></div>
        </div>`:''}
      </div>`;
    showOverlay(html);
    q('#toEdit').onclick=()=>{ closeOverlay(); openProfileEditor(); };
    q('#closeView').onclick=closeOverlay;
  }

  /* -------------------- Profile EDIT -------------------- */
  function openProfileEditor(){
    const d = PROFILE || {};
    const avatar = d.avatarUrl || (CURRENT_USER?.photoURL||'');
    const html = `
      <div class="profile-card">
        <div class="rowx" style="align-items:center">
          <div class="avatar" style="width:56px;height:56px;border-radius:14px;overflow:hidden;background:#f2f6f3" id="pAvatar">${avatar?`<img src="${avatar}" alt="">`:''}</div>
          <div class="grow"></div>
          <label class="btn"><input type="file" id="avatarFile" accept="image/*" style="display:none"> Fayldan avatar</label>
          <button class="btn" id="avatarUrlBtn">URLdan o‘rnatish</button>
        </div>

        <div class="divider"></div>

        <div class="grid2">
          <div class="fld"><label>Ism</label><input id="firstName" value="${d.firstName||''}" placeholder="Ismingiz"></div>
          <div class="fld"><label>Familiya</label><input id="lastName" value="${d.lastName||''}" placeholder="Familiyangiz"></div>
        </div>

        <div class="grid2">
          <div class="fld"><label>Tug‘ilgan kun</label><input type="date" id="birthDate" value="${d.birthDate||''}"></div>
          <div class="fld"><label>Roli</label>
            <select id="roleSel">
              ${['O‘quvchi','O‘qituvchi','Talaba','Abituriyent'].map(r=>`<option ${ (d.role||'O‘quvchi')===r?'selected':''}>${r}</option>`).join('')}
            </select>
          </div>
        </div>

        <!-- O‘quvchi bo‘lsa: faqat sinf + maktab -->
        <div id="stuBlock">
          <div class="grid2">
            <div class="fld"><label>Sinf</label>
              <select id="class">
                ${Array.from({length:11},(_,i)=>i+1).map(n=>`<option value="${n}" ${d.class==n?'selected':''}>${n}-sinf</option>`).join('')}
              </select>
            </div>
            <div class="fld"><label>Maktab</label>
              <select id="schoolSel"></select>
              <small class="muted">Ro‘yxatdan tanlang yoki “Boshqa…”ni tanlang.</small>
            </div>
          </div>
          <div class="fld"><label>Boshqa maktab (ixtiyoriy)</label><input id="schoolCustom" value="${d.schoolCustom||''}" placeholder="Masalan: 12-maktab filiali"></div>
        </div>

        <div class="grid2">
          <div class="fld"><label>Viloyat</label><select id="regionSel"></select></div>
          <div class="fld"><label>Tuman</label><select id="districtSel"></select></div>
        </div>

        <div class="divider"></div>
        <div class="rowx">
          <button class="btn" id="cancelEdit">Bekor qilish</button>
          <div class="grow"></div>
          <button class="btn primary" id="saveProfile">Saqlash</button>
        </div>
      </div>`;
    showOverlay(html);

    // Chained selects
    const rSel=q('#regionSel'), dSel=q('#districtSel'), sSel=q('#schoolSel');
    function fillRegions(){
      rSel.innerHTML=`<option value="">Tanlang...</option>`+REGIONS.map(r=>`<option value="${r.name}">${r.name}</option>`).join('');
      if(d.region) rSel.value=d.region; fillDistricts(); fillSchools();
    }
    function fillDistricts(){
      const r=REGIONS.find(x=>x.name===rSel.value);
      const districts=(r?.districts||[]).map(x=>typeof x==='string'?{name:x,schools:[]}:x);
      dSel.innerHTML=`<option value="">Tanlang...</option>`+districts.map(t=>`<option value="${t.name}">${t.name}</option>`).join('');
      if(d.district) dSel.value=d.district;
    }
    function fillSchools(){
      const r=REGIONS.find(x=>x.name===rSel.value);
      const t=(r?.districts||[]).map(x=>typeof x==='string'?{name:x,schools:[]}:x).find(x=>x.name===dSel.value);
      const schools=t?.schools||[];
      sSel.innerHTML=schools.map(s=>`<option value="${s}">${s}</option>`).join('')+`<option value="__other__">Boshqa…</option>`;
      sSel.value=schools.includes(d.school)?d.school:"__other__";
    }
    rSel.onchange=()=>{fillDistricts();fillSchools();};
    dSel.onchange=fillSchools;
    fillRegions();

    // Role toggle
    const roleSel=q('#roleSel'); const stuBlock=q('#stuBlock');
    function toggleRoleFields(){ stuBlock.classList.toggle('hide', roleSel.value!=='O‘quvchi'); }
    roleSel.onchange=toggleRoleFields; toggleRoleFields();

    // Avatar — uploadString(data_url)
    q('#avatarFile').onchange=async (e)=>{
      const f=e.target.files?.[0]; if(!f||!CURRENT_USER) return;
      const fr=new FileReader();
      fr.onload = async () => {
        try{
          const dataUrl = fr.result; // data:image/...;base64,....
          const ref = sRef(st, `avatars/${CURRENT_USER.uid}/${Date.now()}.jpg`);
          await uploadString(ref, dataUrl, 'data_url');
          const url=await getDownloadURL(ref);
          const bust=url+(url.includes('?')?'&':'?')+'v='+Date.now();
          q('#pAvatar').innerHTML=`<img src="${bust}" alt="">`;
          PROFILE={...(PROFILE||{}),avatarUrl:bust};
        }catch(err){ alert('Avatar yuklashda xatolik: '+(err?.message||err)); }
      };
      fr.readAsDataURL(f);
    };
    // Avatar — URLdan
    q('#avatarUrlBtn').onclick=()=>{
      const url=prompt("Avatar rasm URL manzilini kiriting:");
      if(!url) return;
      PROFILE={...(PROFILE||{}),avatarUrl:url};
      q('#pAvatar').innerHTML=`<img src="${url}" alt="">`;
    };

    q('#cancelEdit').onclick=closeOverlay;
    q('#saveProfile').onclick=async ()=>{
      if(!CURRENT_USER) return;
      const roleVal=q('#roleSel').value;
      const v={
        firstName:q('#firstName').value.trim(),
        lastName:q('#lastName').value.trim(),
        birthDate:q('#birthDate').value,
        role:roleVal,
        region:rSel.value,
        district:dSel.value,
        class: roleVal==='O‘quvchi' ? q('#class').value : '',
        school: roleVal==='O‘quvchi' ? (sSel.value==="__other__"?'':sSel.value) : '',
        schoolCustom: roleVal==='O‘quvchi' ? q('#schoolCustom').value.trim() : '',
        avatarUrl: PROFILE?.avatarUrl || (CURRENT_USER.photoURL || '')
      };
      for(const k of ALWAYS_REQ){ if(!v[k]){ alert('Majburiy maydonlarni to‘ldiring.'); return; } }
      if(roleVal==='O‘quvchi' && !v.class){ alert('Sinfni tanlang.'); return; }
      await saveProfile(CURRENT_USER.uid, v);
      closeOverlay();
      renderUserChip(CURRENT_USER, PROFILE);
      setLocked(false);
    };
  }

  /* -------------------- Overlay helpers -------------------- */
  const showOverlay = html => { const ov=q('#overlay'); ov.innerHTML=html; ov.classList.add('show'); };
  const closeOverlay = ()=>{ const ov=q('#overlay'); ov.classList.remove('show'); ov.innerHTML=''; };

  /* -------------------- Home (chips/sections) -------------------- */
  async function fetchHome(){
    try{
      const s=await getDoc(doc(db,'configs','home'));
      if(s.exists()){const d=s.data(); if(Array.isArray(d.sections)) return d;}
    }catch(e){console.warn('home load failed',e);}
    const r=await fetch('./home.json',{cache:'no-store'});
    if(!r.ok) return {sections:[]};
    return await r.json();
  }
  const state={sections:[],activeId:null};
  async function loadHome(){ const d=await fetchHome(); state.sections=Array.isArray(d.sections)?d.sections:[]; renderChips(); renderSections(); if(state.sections.length) activate(state.sections[0].id||'sec0'); }
  function renderChips(){ const bar=q('#chipbar'); bar.innerHTML=''; state.sections.forEach((s,i)=>{ const b=document.createElement('button'); b.className='chip'+(i===0?' active':''); b.textContent=s.title||s.id||('Bo‘lim '+(i+1)); b.dataset.target=s.id||('sec'+i); b.onclick=()=>activate(b.dataset.target); bar.appendChild(b);});}
  function renderSections(){ const host=q('#sections'); host.innerHTML=''; state.sections.forEach((s,i)=>{ const id=s.id||('sec'+i); const outer=document.createElement('section'); outer.className='section'+(s.fullBleed?' h-bleed':''); outer.dataset.section=id; const sh=document.createElement('div'); sh.className='section-hdr'+(s.fullBleed?' bleed':''); sh.innerHTML='<h3>'+(s.title||'')+'</h3>'; if(!s.title) sh.style.display='none'; const cont=document.createElement('div'); cont.className='iframe-wrap'+(s.fullBleed?' bleed':''); const ifr=document.createElement('iframe'); ifr.className='sbx'; ifr.setAttribute('sandbox', s.sandbox||'allow-scripts allow-forms'); if(s.mode==='url'&&s.src){ifr.src=s.src;} else { const base=s.baseHref?'<base href="'+s.baseHref+'">':''; ifr.srcdoc='<!doctype html><html><head>'+base+'<meta charset="utf-8"></head><body>'+(s.contentHtml||'')+'</body></html>'; } cont.appendChild(ifr); outer.appendChild(sh); outer.appendChild(cont); host.appendChild(outer);});}
  function activate(id){ state.activeId=id; qa('.chip').forEach(c=>c.classList.toggle('active',c.dataset.target===id)); qa('[data-section]').forEach(s=>s.style.display=(s.dataset.section===id)?'block':'none'); const vis=q('[data-section="'+id+'"]'); if(vis) vis.scrollIntoView({behavior:'smooth',block:'start'}); }

  /* -------------------- Auth lock -------------------- */
  function setLocked(b){ const a=q('#app'); if(a) a.hidden=b; }
  function buildAuthLock(){
    if(q('#auth-lock')) return q('#auth-lock');
    const lock=document.createElement('div'); lock.id='auth-lock'; lock.className='lock'; lock.hidden=true;
    lock.innerHTML = `
      <div class="card">
        <div class="title"><img src="./logo.png" width="28" height="28" style="border-radius:8px"/><span>LeaderMath.<b>UZ</b></span></div>
        <div class="hint">Ro‘yxatdan o‘ting yoki kiring — tizimga kirmaguncha kontent ko‘rinmaydi.</div>
        <div class="fld"><label>Email</label><input type="email" id="eml" placeholder="email@example.com"/></div>
        <div class="fld"><label>Parol</label><input type="password" id="pwd" placeholder="••••••••"/></div>
        <div id="err"></div>
        <div class="rowx"><button id="login" class="btn primary">Kirish</button><button id="signup" class="btn">Ro‘yxatdan o‘tish</button></div>
        <div style="height:10px"></div>
        <button id="google" class="btn full"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"/> Google bilan kirish</button>
      </div>`;
    document.body.appendChild(lock);
    lock.addEventListener('click', async (e)=>{
      const id=e.target.id; const errEl=q('#err',lock);
      const busy=b=>qa('button',lock).forEach(x=>x.disabled=b);
      try{
        busy(true);
        if(id==='google') await signInWithPopup(auth,new GoogleAuthProvider());
        if(id==='login'){ const eml=q('#eml',lock).value.trim(), pwd=q('#pwd',lock).value; await signInWithEmailAndPassword(auth,eml,pwd); }
        if(id==='signup'){ const eml=q('#eml',lock).value.trim(), pwd=q('#pwd',lock).value; await createUserWithEmailAndPassword(auth,eml,pwd); }
      }catch(err){ if(errEl) errEl.textContent = err?.message || String(err); }
      finally{ busy(false); }
    });
    return lock;
  }

  onAuthStateChanged(auth, async (u)=>{
    const lock=buildAuthLock();
    CURRENT_USER = u || null;

    if(!u){
      setLocked(true);
      lock.style.removeProperty('display'); lock.hidden=false;
      q('#user-slot').innerHTML='';
      return;
    }

    setLocked(false); lock.style.display='none'; setTimeout(()=>{ try{ lock.remove(); }catch{} }, 0);

    if(!REGIONS.length) REGIONS = await loadRegions();

    // profil + points
    [PROFILE, USER_POINTS] = await Promise.all([
      getProfile(u.uid),
      getUserPoints(u.uid)
    ]);

    if(PROFILE && !PROFILE.role){ PROFILE.role='O‘quvchi'; await saveProfile(u.uid, PROFILE); }

    // Validatsiya
    const baseOk = ALWAYS_REQ.every(k=>PROFILE && PROFILE[k]);
    let ok = baseOk;
    if(PROFILE?.role==='O‘quvchi'){ ok = ok && !!PROFILE.class; }

    if(!ok){ setLocked(true); openProfileEditor(); }
    else{ renderUserChip(u, PROFILE); }
  });

  // Chips
  await loadHome();
  </script>
</body>
</html>
