<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LeaderMath.UZ — Isolated Pages + Firebase Auth</title>
  <meta name="theme-color" content="#2E8B57"/>
  <link rel="icon" href="./logo.png"/>
  <style>
    :root{
      --brand:#2E8B57; --brand-2:#1F6B45;
      --bg:#F6FBF8; --text:#0d1b14; --muted:#4a6b5a; --card:#ffffff; --frame:#dfe7e2;
      --radius:16px; --pill:999px; --shadow:0 8px 30px rgba(16,32,23,.08);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.55 system-ui,Segoe UI,Arial}

    header.hdr{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#F6FBF8 65%,#F6FBF8c0 80%,transparent);
      border-bottom:1px solid var(--frame);backdrop-filter:saturate(1.1) blur(6px)}
    .row{max-width:1180px;margin:0 auto;display:flex;align-items:center;gap:14px;padding:10px 16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .brand b{color:var(--brand)}
    .grow{flex:1}

    .chipbar{max-width:1180px;margin:12px auto 0;display:flex;gap:8px;flex-wrap:wrap;padding:0 16px 12px}
    .chip{padding:8px 12px;border:1px solid var(--frame);border-radius:var(--pill);cursor:pointer;background:#fff}
    .chip.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .chip:disabled{opacity:.6;cursor:not-allowed}

    main{max-width:1180px;margin:0 auto;padding:12px 16px 40px}
    section.section{background:var(--card);border:1px solid var(--frame);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow)}
    .section.h-bleed{border:none;border-radius:0;box-shadow:none}
    .section-hdr{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--frame)}
    .section-hdr h3{margin:0;font-size:18px}
    .iframe-wrap{position:relative}
    iframe.sbx{display:block;width:100%;border:0;background:#fff;min-height:600px}

    .bleed{width:100vw;margin-left:50%;transform:translateX(-50%)}

    .lock{position:fixed;inset:0;background:linear-gradient(180deg,#F6FBF8ee,#F6FBF8ff);display:grid;place-items:center;z-index:50}
    .card{width:min(420px,94vw);background:#fff;border:1px solid var(--frame);border-radius:18px;box-shadow:var(--shadow);padding:18px}
    .title{display:flex;align-items:center;gap:10px;font-weight:800;margin-bottom:10px}
    .hint{color:var(--muted);font-size:14px;margin-bottom:12px}

    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--frame);background:#fff;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .btn.full{width:100%}
    .fld{display:grid;gap:6px;margin:8px 0}
    .fld input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--frame);outline:none}
    .rowx{display:flex;gap:8px;align-items:center;justify-content:space-between}

    .userchip{display:flex;gap:10px;align-items:center;border:1px solid var(--frame);padding:6px 10px;border-radius:999px;background:#fff}
    .avatar{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,#cfe7db,#eaf6f0)}
    .logout{background:#fff;border:1px solid var(--frame);border-radius:10px;padding:6px 10px;cursor:pointer}
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider,
      setPersistence, browserLocalPersistence, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

    async function boot(){
      // --- Firebase config (o'zingizniki bilan almashtiring) ---
      const firebaseConfig = {
  apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  authDomain: "xplusy-760fa.firebaseapp.com",
  projectId: "xplusy-760fa",
  storageBucket: "xplusy-760fa.firebasestorage.app",
  messagingSenderId: "992512966017",
  appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
  measurementId: "G-459PLJ7P7L"
};
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      try{ await setPersistence(auth, browserLocalPersistence); }catch(e){ console.warn('setPersistence:', e); }

      // --- Auth overlay ---
      const lock = document.createElement('div'); lock.className='lock'; lock.hidden = true;
      lock.innerHTML = `
        <div class="card">
          <div class="title"><img src="./logo.png" width="28" height="28" style="border-radius:8px"/><span>LeaderMath.<b>UZ</b></span></div>
          <div class="hint">Ro‘yxatdan o‘ting yoki kiring — tizimga kirmaguncha kontent ko‘rinmaydi.</div>

          <div class="fld"><label>Email</label><input type="email" id="eml" placeholder="email@example.com"/></div>
          <div class="fld"><label>Parol</label><input type="password" id="pwd" placeholder="••••••••"/></div>
          <div class="rowx">
            <button id="login"  class="btn primary">Kirish</button>
            <button id="signup" class="btn">Ro‘yxatdan o‘tish</button>
          </div>
          <div style="height:10px"></div>
          <button id="google" class="btn full"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"/> Google bilan kirish</button>
        </div>`;
      document.body.appendChild(lock);

      const userSlot = () => document.getElementById('user-slot');
      const setLocked = (locked) => { lock.hidden = !locked; document.getElementById('app').hidden = locked; };

      onAuthStateChanged(auth, (u)=>{
        if(!u){
          setLocked(true);
          document.querySelectorAll('.chip').forEach(c=>c.disabled=true);
          const slot = userSlot(); if(slot) slot.innerHTML = '';
        }else{
          setLocked(false);
          document.querySelectorAll('.chip').forEach(c=>c.disabled=false);
          const slot = userSlot();
          if(slot){
            slot.innerHTML = `
              <div class="userchip">
                <div class="avatar"></div>
                <div style="display:grid;line-height:1">
                  <b style="font-size:14px">${u.displayName||u.email||'Foydalanuvchi'}</b>
                  <small style="color:var(--muted)">${u.email||''}</small>
                </div>
                <button id="logout" class="logout">Chiqish</button>
              </div>`;
            slot.querySelector('#logout').onclick = ()=>signOut(auth);
          }
        }
      });

      lock.addEventListener('click', async (e)=>{
        const id = e.target.id;
        try{
          if(id==='google'){
            await signInWithPopup(auth, new GoogleAuthProvider());
          }else if(id==='login'){
            const eml = lock.querySelector('#eml').value.trim();
            const pwd = lock.querySelector('#pwd').value;
            await signInWithEmailAndPassword(auth, eml, pwd);
          }else if(id==='signup'){
            const eml = lock.querySelector('#eml').value.trim();
            const pwd = lock.querySelector('#pwd').value;
            await createUserWithEmailAndPassword(auth, eml, pwd);
          }
        }catch(err){ alert(err && err.message ? err.message : err); }
      });

      const state = { sections:[], activeId:null };
      async function loadHome(){
        let data = null;
        try{
          const res = await fetch('./home.json', {cache:'no-store'});
          if(!res.ok){ throw new Error('home.json topilmadi yoki 404.'); }
          data = await res.json();
        }catch(e){
          console.error('home.json parse error:', e);
          alert('home.json xatosi: ' + e.message);
          data = { sections: [] };
        }
        state.sections = Array.isArray(data.sections)? data.sections : [];
        renderChips(); renderSections();
        if(state.sections[0]) activate(state.sections[0].id||('sec0'));
      }

      function renderChips(){
        const bar = document.getElementById('chipbar'); bar.innerHTML='';
        state.sections.forEach((s,i)=>{
          const btn = document.createElement('button');
          btn.className='chip'+(i===0?' active':''); btn.textContent = s.title || s.id || ('Bo‘lim '+(i+1));
          btn.dataset.target = s.id||('sec'+i); btn.onclick = ()=> activate(btn.dataset.target);
          bar.appendChild(btn);
        });
      }

      function renderSections(){
        const host = document.getElementById('sections'); host.innerHTML = '';
        state.sections.forEach((s,i)=>{
          const secId = s.id || ('sec'+i);
          const outer = document.createElement('section');
          outer.className = 'section'+(s.fullBleed?' h-bleed':''); outer.dataset.section = secId;

          const sh = document.createElement('div');
          sh.className = 'section-hdr'+(s.fullBleed?' bleed':''); sh.innerHTML = `<h3>${s.title||''}</h3>`;
          if(!s.title) sh.style.display='none';

          const cont = document.createElement('div');
          cont.className = 'iframe-wrap'+(s.fullBleed?' bleed':'');
          const ifr = document.createElement('iframe');
          ifr.className='sbx';
          ifr.setAttribute('sandbox', s.sandbox || 'allow-scripts allow-forms');
          if(s.mode==='url' && s.src){
            ifr.src = s.src;
          }else{
            const base = s.baseHref ? `<base href="${s.baseHref}">` : '';
            ifr.srcdoc = `<!doctype html><html><head>${base}<meta charset='utf-8'></head><body>${s.contentHtml||''}</body></html>`;
          }
          if(s.fullBleed) ifr.style.background='transparent';
          cont.appendChild(ifr);

          outer.appendChild(sh); outer.appendChild(cont);
          host.appendChild(outer);
        });
      }

      function activate(id){
        state.activeId = id;
        document.querySelectorAll('.chip').forEach(c=>{ c.classList.toggle('active', c.dataset.target===id); });
        document.querySelectorAll('[data-section]').forEach(x=>{ x.style.display = (x.dataset.section===id)? 'block':'none'; });
        const vis = document.querySelector(`[data-section="${id}"]`);
        if(vis){ vis.scrollIntoView({behavior:'smooth',block:'start'}); }
      }

      window.addEventListener('message', (ev)=>{
        const msg = ev.data || {}; if(!msg.__lmResize) return;
        const { id, height } = msg;
        const sec = document.querySelector(`[data-section="${id}"]`);
        if(!sec) return;
        const ifr = sec.querySelector('iframe'); if(!ifr) return;
        const h = Math.max(parseInt(height,10)||0, 200);
        ifr.style.height = h + 'px';
      });

      await loadHome();
    }

    // start safely (no top-level await issues)
    boot().catch(e=>console.error('boot error:', e));
  </script>
</head>
<body>
  <header class="hdr">
    <div class="row">
      <div class="brand">
        <img src="./logo.png" alt="LM" width="28" height="28" style="border-radius:8px"/>
        <span>LeaderMath.<b>UZ</b></span>
      </div>
      <div class="grow"></div>
      <div id="user-slot"></div>
    </div>
    <nav id="chipbar" class="chipbar"></nav>
  </header>

  <main id="app">
    <div id="sections"></div>
  </main>
</body>
</html>
