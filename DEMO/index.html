<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>LeaderMath.uz — Bosh sahifa (Userpanel + Chip menyu)</title>
  <meta name="theme-color" content="#2E8B57" id="meta-theme-color"/>
  <link rel="icon" href="./favicon.png">
  <style>
    :root{
      --brand:#2E8B57;--brand2:#1F6B45;
      --bg:#f4f8f6;--text:#0d1b14;--muted:#375c4c;--card:#ffffff;
      --frame:#d8e7dd;--frame-strong:#b7d6c5;--chip:#eaf6f0;--chip-b:#cfe7db;
      --radius:16px; --ring:#8ad1b1;
    }
    :root.dark{ --bg:#0e1512; --text:#EAF7EE; --muted:#A5C7B4; --card:#141e19; --frame:#1c3a2d; --frame-strong:#14553a; --chip:#0f1e18; --chip-b:#174534; --ring:#1ea971; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"}
    a{color:inherit}
    .app{min-height:100%;display:flex;flex-direction:column}
    .appbar{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.6);backdrop-filter:blur(12px);border-bottom:1px solid var(--frame);}
    :root.dark .appbar{background:rgba(17,24,21,.6)}
    .bar-inner{display:flex;align-items:center;gap:10px;max-width:1152px;margin:0 auto;padding:10px 16px}
    .logo{display:flex;align-items:center;gap:10px;font-weight:800}
    .logo .pi{width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand2));display:grid;place-items:center;color:white;font-weight:900;box-shadow:0 6px 14px rgba(46,139,87,.3)}
    .logo small{opacity:.7;font-weight:600}

    .chips{flex:1;display:flex;gap:8px;overflow:auto hidden;padding:4px 6px}
    .chip{flex:0 0 auto;display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-b);cursor:pointer;user-select:none;white-space:nowrap;transition:transform .15s ease, background .15s}
    .chip:hover{transform:translateY(-1px)}
    .chip.active{background:linear-gradient(180deg, #fff, var(--chip)); border-color:var(--ring); box-shadow:0 0 0 3px rgba(138,209,177,.25)}
    :root.dark .chip.active{background:linear-gradient(180deg, #18241e, var(--chip));}

    .userchip{margin-left:auto;display:flex;align-items:center;gap:10px;padding:6px 8px;border-radius:999px;background:var(--card);border:1px solid var(--frame);cursor:pointer;min-width:0}
    .userchip .ava{width:32px;height:32px;border-radius:50%;background:#d9eadf;overflow:hidden;display:grid;place-items:center;font-weight:800;color:#1F6B45}
    .userchip .meta{display:flex;flex-direction:column;min-width:0}
    .userchip .name{font-weight:700;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .userchip .points{font-size:12px;color:var(--muted)}

    .popover{position:absolute;inset:auto 16px auto auto;top:56px;right:16px;max-width:360px;background:var(--card);border:1px solid var(--frame);border-radius:16px;box-shadow:0 12px 36px rgba(0,0,0,.15);padding:12px;display:none}
    .popover.show{display:block}
    .pop-row{display:flex;gap:12px;align-items:center}
    .pop-row .ava{width:56px;height:56px;border-radius:50%;background:#d9eadf;display:grid;place-items:center;font-weight:900}
    .pop-info{flex:1}
    .pop-info b{display:block}
    .pop-info small{color:var(--muted)}
    .pop-actions{display:flex;gap:8px;margin-top:10px}
    button.btn{appearance:none;border:1px solid var(--frame);background:var(--chip);padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer}
    button.btn.primary{border-color:var(--ring);background:linear-gradient(180deg,#e8f7f0,#d0efe1)}

    .main{flex:1;max-width:1152px;margin:10px auto;padding:10px 16px}
    .viewer{width:100%;height:calc(100dvh - 120px);border-radius:16px;border:1px solid var(--frame-strong);background:var(--card);overflow:hidden}
    .viewer iframe{width:100%;height:100%;border:0;background:white}

    .login-card{max-width:420px;margin:8vh auto;padding:18px;border-radius:16px;border:1px solid var(--frame);background:var(--card);box-shadow:0 10px 28px rgba(0,0,0,.08)}
    .login-card h1{margin:0 0 8px}
    .login-actions{display:flex;flex-direction:column;gap:10px}
    input[type=email]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--frame);background:var(--bg)}

    .mode{margin-left:8px}
  </style>
</head>
<body>
<div class="app" id="app">
  <div class="appbar">
    <div class="bar-inner">
      <div class="logo"><div class="pi">π</div> LeaderMath <small>Premium</small></div>
      <div class="chips" id="chips"></div>
      <label class="mode"><input type="checkbox" id="modeToggle"> Dark</label>
      <div class="userchip" id="userChip" title="Profil">
        <div class="ava" id="userAva">L</div>
        <div class="meta">
          <div class="name" id="userName">Guest</div>
          <div class="points" id="userPoints">Ball: 0</div>
        </div>
      </div>
    </div>
  </div>

  <div class="popover" id="pop">
    <div class="pop-row">
      <div class="ava" id="popAva">L</div>
      <div class="pop-info">
        <b id="popName">Guest</b>
        <small id="popEmail">—</small>
      </div>
    </div>
    <div class="pop-actions">
      <button class="btn" id="editProfile">Profil</button>
      <button class="btn" id="signOutBtn">Chiqish</button>
    </div>
  </div>

  <main class="main">
    <div class="viewer">
      <iframe id="viewer" sandbox="allow-scripts allow-forms allow-modals allow-popups" referrerpolicy="no-referrer"></iframe>
    </div>
  </main>
</div>

<!-- ======= Login Screen (shown when signed-out) ======= -->
<div class="login-card" id="loginCard" style="display:none">
  <h1>LeaderMath hisobingizga kiring</h1>
  <p style="color:var(--muted)">Google yoki e‑pochta orqali kirish mumkin.</p>
  <div class="login-actions">
    <button class="btn primary" id="googleBtn">Google orqali kirish</button>
    <div>
      <input type="email" id="emailInput" placeholder="email@example.com">
      <button class="btn" id="emailLinkBtn">E‑pochtaga kirish havolasi yuborish</button>
    </div>
  </div>
  <small style="display:block;margin-top:8px;color:var(--muted)">Eslatma: e‑pochtadagi havola uchun Firebase Console’da <b>Authorized domains</b> va <b>linkDomain</b> sozlangan bo‘lishi shart.</small>
</div>

<!-- ======= Profil modal (oddiy prompt bilan) ======= -->
<template id="profileTemplate">
  <dialog id="profileDlg" style="border:1px solid var(--frame);border-radius:16px;padding:0;max-width:520px">
    <form method="dialog" style="padding:16px;background:var(--card)">
      <h3 style="margin:0 0 12px">Profil ma’lumotlari</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <label>Ism familiya<input id="f_name" style="width:100%"/></label>
        <label>Telefon<input id="f_phone" style="width:100%"/></label>
        <label>Maktab<input id="f_school" style="width:100%"/></label>
        <label>Sinf (raqam)<input id="f_class" type="number" min="1" max="11" style="width:100%"/></label>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="btn" value="cancel">Bekor</button>
        <button class="btn primary" id="saveProfile" value="default">Saqlash</button>
      </div>
    </form>
  </dialog>
</template>

<script type="module">
  // ======= Theme toggle =======
  const rt=document.documentElement; const modeT=document.getElementById('modeToggle');
  const savedMode=localStorage.getItem('lm-theme'); if(savedMode==='dark'){ rt.classList.add('dark'); modeT.checked=true; }
  modeT.onchange=()=>{ rt.classList.toggle('dark'); localStorage.setItem('lm-theme', rt.classList.contains('dark')?'dark':'light'); };

  // ======= Firebase =======
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, signOut } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
    authDomain: "xplusy-760fa.firebaseapp.com",
    projectId: "xplusy-760fa",
    storageBucket: "xplusy-760fa.firebasestorage.app",
    messagingSenderId: "992512966017",
    appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
    measurementId: "G-459PLJ7P7L"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // Email-link (magic link) kirish sozlamalari — <IMPORTANT: linkDomain & url ni loyihangizga moslang>
  const actionCodeSettings = {
    url: 'https://leadermath.uz/auth-finish',
    handleCodeInApp: true,
    iOS: { bundleId: 'uz.leadermath.pwa' },
    android: { packageName: 'uz.leadermath.pwa', installApp: true, minimumVersion: '12' },
    linkDomain: 'xplusy-760fa.firebaseapp.com'
  };

  // ======= UI refs =======
  const userChip   = document.getElementById('userChip');
  const pop        = document.getElementById('pop');
  const userAva    = document.getElementById('userAva');
  const userNameEl = document.getElementById('userName');
  const userPtsEl  = document.getElementById('userPoints');
  const popAva     = document.getElementById('popAva');
  const popName    = document.getElementById('popName');
  const popEmail   = document.getElementById('popEmail');
  const editBtn    = document.getElementById('editProfile');
  const logoutBtn  = document.getElementById('signOutBtn');
  const viewer     = document.getElementById('viewer');
  const chipsEl    = document.getElementById('chips');
  const loginCard  = document.getElementById('loginCard');
  const googleBtn  = document.getElementById('googleBtn');
  const emailIn    = document.getElementById('emailInput');
  const emailBtn   = document.getElementById('emailLinkBtn');

  // ======= Chip loader (from admin.json) =======
  let CHIP_DATA = [];
  async function loadChips(){
    const res = await fetch('./admin.json?_=' + Date.now());
    const json = await res.json();
    CHIP_DATA = (json.chips||[]);
    chipsEl.innerHTML = '';
    CHIP_DATA.forEach((c,i)=>{
      const el=document.createElement('button');
      el.className='chip'; el.dataset.id=c.id; el.innerHTML = `${c.icon||''}<span>${c.label}</span>`;
      el.onclick=()=>openChip(c.id);
      chipsEl.appendChild(el);
    });
  }

  function setActiveChip(id){
    [...chipsEl.children].forEach(ch=>ch.classList.toggle('active', ch.dataset.id===id));
  }

  function openChip(id){
    const c = CHIP_DATA.find(x=>x.id===id) || CHIP_DATA[0];
    if(!c) return;
    setActiveChip(c.id);
    // Render HTML (and JS) securely into sandboxed iframe via srcdoc
    const src = c.html || `<!doctype html><html><head><meta charset='utf-8'><title>${c.label}</title></head><body><h1>${c.label}</h1><p>Kontent tayyorlanmoqda.</p></body></html>`;
    viewer.srcdoc = src;
    localStorage.setItem('lm-last-chip', c.id);
  }

  // ======= User panel popover =======
  let popOpen=false; userChip.onclick=()=>{ popOpen=!popOpen; pop.classList.toggle('show', popOpen); };
  document.addEventListener('click', (e)=>{ if(!e.target.closest('#userChip') && !e.target.closest('#pop')){ popOpen=false; pop.classList.remove('show'); } });

  // ======= Auth flows =======
  googleBtn.onclick = async () => {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
  };
  emailBtn.onclick = async () => {
    const email = (emailIn.value||'').trim();
    if(!email) return alert('E‑pochta kiriting');
    await sendSignInLinkToEmail(auth, email, actionCodeSettings);
    window.localStorage.setItem('lm-email-for-signin', email);
    alert('Havola yuborildi. E‑pochtani tekshiring.');
  };
  // If opened via email link
  if (isSignInWithEmailLink(auth, window.location.href)) {
    let email = window.localStorage.getItem('lm-email-for-signin');
    if (!email) email = window.prompt('E‑pochtangizni kiriting');
    try { await signInWithEmailLink(auth, email, window.location.href); window.localStorage.removeItem('lm-email-for-signin'); }
    catch(e){ console.error(e); alert('Email-link orqali kirishda xatolik'); }
  }

  logoutBtn.onclick = async ()=>{ await signOut(auth); };

  // ======= Profile modal =======
  function openProfileDialog(current){
    const tpl = document.getElementById('profileTemplate');
    const node = tpl.content.cloneNode(true);
    document.body.appendChild(node);
    const dlg = document.getElementById('profileDlg');
    dlg.showModal();
    const nameI = document.getElementById('f_name');
    const phoneI= document.getElementById('f_phone');
    const schoolI=document.getElementById('f_school');
    const classI =document.getElementById('f_class');
    nameI.value = current.name||''; phoneI.value=current.phone||''; schoolI.value=current.school||''; classI.value=current.class||'';
    document.getElementById('saveProfile').onclick = async (e)=>{
      e.preventDefault(); dlg.close();
      if(!auth.currentUser) return;
      const ref = doc(db, 'users', auth.currentUser.uid);
      await setDoc(ref, { name:nameI.value.trim(), phone:phoneI.value.trim(), school:schoolI.value.trim(), class:Number(classI.value||0)||null, updatedAt:serverTimestamp() }, { merge:true });
    };
    dlg.addEventListener('close', ()=> dlg.remove());
  }

  editBtn.onclick = ()=> openProfileDialog(CURRENT_PROFILE||{});

  // ======= Auth state & profile sync =======
  let CURRENT_PROFILE=null;
  onAuthStateChanged(auth, async (u)=>{
    if(!u){
      document.getElementById('app').style.display='none';
      loginCard.style.display='block';
      return;
    }
    loginCard.style.display='none';
    document.getElementById('app').style.display='flex';

    const ref = doc(db,'users',u.uid);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref,{ uid:u.uid, email:u.email||null, name:u.displayName||'Foydalanuvchi', photoURL:u.photoURL||null, points:0, createdAt:serverTimestamp() },{merge:true});
    }
    const data = (await getDoc(ref)).data();
    CURRENT_PROFILE = data;

    // fill userchip
    userAva.textContent = (data.name||u.displayName||'L').trim().charAt(0).toUpperCase();
    userNameEl.textContent = data.name||u.displayName||'Foydalanuvchi';
    userPtsEl.textContent = `Ball: ${Number(data.points||0)}`;
    popAva.textContent = userAva.textContent;
    popName.textContent = userNameEl.textContent;
    popEmail.textContent = u.email||'—';

    // load chips then open last one
    await loadChips();
    const last = localStorage.getItem('lm-last-chip');
    openChip(last || (CHIP_DATA[0] && CHIP_DATA[0].id));
  });
</script>
</body>
</html>