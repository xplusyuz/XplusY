<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>LeaderMath.UZ — Home + Profil</title>

  <link rel="icon" href="./logo.png" sizes="any">
  <link rel="apple-touch-icon" href="./logo.png">
  <meta name="theme-color" content="#2E8B57"/>

    <style>
  /* ===== YANGI: ZAMONAVIY CSS O'ZGARTIRISHLARI ===== */
  :root {
    --brand: #2E8B57;
    --brand-light: #3DA56D;
    --brand-dark: #1E6B47;
    --gradient-primary: linear-gradient(135deg, var(--brand) 0%, var(--brand-light) 100%);
    --gradient-secondary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-accent: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --bg: #F6FAF7;
    --bg-2: #ECF4EF;
    --card: #FFFFFF;
    --text: #0f1b15;
    --muted: #5f7469;
    --line: #E3EBE6;
    --speed: .25s;
    --shadow: 0 20px 60px rgba(18, 40, 28, .14);
    --shadow-sm: 0 8px 26px rgba(18, 40, 28, .10);
    --shadow-lg: 0 30px 80px rgba(18, 40, 28, .20);
    --vh: 1vh;
    --radius-sm: 8px;
    --radius: 16px;
    --radius-lg: 22px;
    --radius-xl: 30px;
  }

  /* Dark theme support */
  @media (prefers-color-scheme: dark) {
    :root {
      --bg: #0f1b15;
      --bg-2: #15231c;
      --card: #1a2b22;
      --text: #e8f5ee;
      --muted: #8fa89c;
      --line: #2a3d34;
    }
  }

  /* Global reset va typography improvement */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html, body {
    height: 100%;
    scroll-behavior: smooth;
  }

  body {
    margin: 0;
    color: var(--text);
    font: 16px/1.6 'Inter', system-ui, Segoe UI, Arial, sans-serif;
    background:
      radial-gradient(1200px 600px at 15% -10%, #d9f0e4 0, #0000 60%),
      radial-gradient(1400px 700px at 110% 10%, #e5f6ed 0, #0000 60%),
      linear-gradient(180deg, var(--bg), var(--bg-2));
    overflow-x: hidden;
  }

  /* Typography improvements */
  h1, h2, h3, h4, h5, h6 {
    font-weight: 700;
    line-height: 1.2;
    margin-bottom: 0.5em;
  }

  /* Header + chipbar - improved styling */
  .hdr {
    position: sticky;
    top: 0;
    z-index: 90;
    backdrop-filter: saturate(1.8) blur(15px);
    background: linear-gradient(180deg, color-mix(in srgb, var(--card) 92%, transparent), transparent);
    border-bottom: 1px solid color-mix(in srgb, var(--line) 40%, transparent);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
  }

  .row {
    max-width: 1280px;
    margin: 0 auto;
    padding: 12px 24px;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .brand {
    display: flex;
    align-items: center;
    gap: 14px;
    font-weight: 800;
    transition: transform 0.3s ease;
  }

  .brand:hover {
    transform: translateY(-1px);
  }

  .brand img {
    width: 56px;
    height: 56px;
    border-radius: 14px;
    display: block;
    box-shadow: 0 8px 30px rgba(46, 139, 87, .3);
    transition: all 0.3s ease;
  }

  .brand:hover img {
    transform: scale(1.05);
    box-shadow: 0 12px 40px rgba(46, 139, 87, .4);
  }

  .brand b {
    color: var(--brand);
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .grow {
    flex: 1;
  }

  /* Improved chipbar */
  .chipbar-wrap {
    position: sticky;
    top: 80px;
    z-index: 80;
    backdrop-filter: saturate(1.4) blur(10px);
    background: linear-gradient(180deg, color-mix(in srgb, var(--card) 85%, transparent), transparent);
    border-bottom: 1px solid color-mix(in srgb, var(--line) 40%, transparent);
    transition: all 0.3s ease;
  }

  .chipbar {
    max-width: 1280px;
    margin: 0 auto;
    padding: 12px 24px 16px;
    display: flex;
    gap: 12px;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
  }

  .chipbar::-webkit-scrollbar {
    display: none;
  }

  .chipbar {
    scrollbar-width: none;
  }

  /* Enhanced chips */
  .chip {
    appearance: none;
    border: 1px solid var(--line);
    background: var(--card);
    border-radius: 50px;
    padding: 12px 20px;
    cursor: pointer;
    box-shadow: var(--shadow-sm);
    font-weight: 700;
    white-space: nowrap;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
  }

  .chip::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: var(--gradient-primary);
    transition: left 0.5s ease;
    z-index: -1;
  }

  .chip:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
    border-color: color-mix(in srgb, var(--brand) 30%, transparent);
  }

  .chip.active {
    background: var(--gradient-primary);
    color: #fff;
    border-color: transparent;
    box-shadow: 0 10px 30px rgba(46, 139, 87, 0.3);
  }

  .chip.active::before {
    left: 0;
  }

  /* Fullscreen Banner Carousel improvements */
  .banner-carousel-section {
    position: fixed;
    top: var(--top-gap, 120px);
    left: 0;
    right: 0;
    height: calc(var(--vh) * 40);
    z-index: 40;
    overflow: hidden;
    pointer-events: auto;
    border-radius: 0 0 30px 30px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
  }

  @media (max-width: 900px) {
    .banner-carousel-section {
      height: calc(var(--vh) * 35);
      border-radius: 0 0 20px 20px;
    }
  }

  .banner-carousel {
    position: absolute;
    inset: 0;
    display: flex;
    transition: transform 0.6s cubic-bezier(0.215, 0.61, 0.355, 1);
  }

  .banner-slide {
    flex: 0 0 100%;
    height: 100%;
    position: relative;
    border-radius: inherit;
    overflow: hidden;
  }

  .banner-slide iframe {
    width: 100%;
    height: 100%;
    border: 0;
    display: block;
  }

  .banner-indicators {
    position: absolute;
    bottom: 20px;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    gap: 12px;
    z-index: 50;
  }

  .banner-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    transition: all 0.3s ease;
    border: 2px solid transparent;
  }

  .banner-indicator:hover {
    background: rgba(255, 255, 255, 0.8);
    transform: scale(1.2);
  }

  .banner-indicator.active {
    background: var(--brand);
    transform: scale(1.3);
    box-shadow: 0 0 10px rgba(46, 139, 87, 0.5);
  }

  .banner-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.9);
    border: none;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 50;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    font-weight: bold;
    font-size: 18px;
  }

  .banner-nav:hover {
    background: white;
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
  }

  .banner-nav.prev {
    left: 20px;
  }

  .banner-nav.next {
    right: 20px;
  }

  /* Main content improvements */
  main {
    max-width: 1280px;
    margin: 0 auto;
    padding: calc(var(--vh) * 40 + 24px) 24px 80px;
  }

  .section {
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    overflow: hidden;
    margin-bottom: 20px;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
  }

  .section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--gradient-primary);
    transform: scaleX(0);
    transition: transform 0.5s ease;
  }

  .section:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
  }

  .section:hover::before {
    transform: scaleX(1);
  }

  .section-hdr {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px;
    border-bottom: 1px solid var(--line);
    background: linear-gradient(90deg, color-mix(in srgb, var(--brand) 5%, transparent), transparent);
  }

  .section-hdr h3 {
    margin: 0;
    font-size: 20px;
    font-weight: 700;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .iframe-wrap {
    position: relative;
  }

  iframe.sbx {
    display: block;
    width: 100%;
    height: 100%;
    border: 0;
    background: transparent;
    overflow: hidden;
  }

  /* Enhanced ratio box */
  .ratio {
    position: relative;
    width: 100%;
    overflow: hidden;
    border: 1px solid var(--line);
    border-radius: var(--radius);
    background: #fff;
    box-shadow: var(--shadow-sm);
    transition: all 0.3s ease;
  }

  .ratio:hover {
    box-shadow: var(--shadow);
  }

  .ratio[data-r="16-9"]::before {
    content: "";
    display: block;
    padding-top: 56.25%;
  }

  .ratio>iframe {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    border: 0;
  }

  /* Enhanced cards grid + badges */
  .grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
  }

  @media (max-width: 960px) {
    .grid {
      grid-template-columns: 1fr 1fr;
    }
  }

  @media (max-width: 640px) {
    .grid {
      grid-template-columns: 1fr;
    }
  }

  .cardX {
    border: 1px solid var(--line);
    background: var(--card);
    border-radius: var(--radius);
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    box-shadow: var(--shadow-sm);
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
  }

  .cardX::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--gradient-primary);
    transform: scaleX(0);
    transition: transform 0.5s ease;
  }

  .cardX:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow);
  }

  .cardX:hover::before {
    transform: scaleX(1);
  }

  .cardX h4 {
    margin: 0;
    font-size: 18px;
    font-weight: 700;
  }

  .rowflex {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  .badge {
    padding: 6px 12px;
    border: 1px solid var(--line);
    border-radius: 50px;
    font-size: 12px;
    font-weight: 700;
    background: #f0f7f3;
    transition: all 0.3s ease;
  }

  .badge.soon {
    background: #fff8e5;
    border-color: #f2d48a;
    color: #b38b00;
  }

  .badge.active {
    background: var(--gradient-primary);
    color: white;
    border-color: transparent;
  }

  .badge.ended {
    background: #f5f5f5;
    color: #999;
  }

  /* Enhanced filter chips */
  .inline-filters {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    padding: 16px;
    background: color-mix(in srgb, var(--bg) 50%, transparent);
    border-radius: var(--radius);
    margin: 16px;
  }

  .fchip {
    appearance: none;
    border: 1px solid var(--line);
    background: var(--card);
    border-radius: 50px;
    padding: 10px 16px;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.3s ease;
  }

  .fchip:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
  }

  .fchip.active {
    background: var(--gradient-primary);
    color: #fff;
    border-color: transparent;
    box-shadow: 0 6px 20px rgba(46, 139, 87, 0.3);
  }

  /* Enhanced user chip + overlay */
  .userchip {
    border: 1px solid var(--line);
    background: var(--card);
    padding: 8px 16px;
    border-radius: 50px;
    box-shadow: var(--shadow-sm);
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
  }

  .userchip:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
    border-color: color-mix(in srgb, var(--brand) 30%, transparent);
  }

  .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    overflow: hidden;
    background: var(--gradient-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  }

  .avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .menu {
    position: fixed;
    min-width: 280px;
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    display: none;
    overflow: hidden;
    z-index: 9999;
    backdrop-filter: blur(10px);
  }

  .menu.open {
    display: block;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .menu a {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 14px 16px;
    text-decoration: none;
    color: inherit;
    border-bottom: 1px solid color-mix(in srgb, var(--line) 60%, transparent);
    transition: all 0.2s ease;
    will-change: transform;
  }

  .menu a:last-child {
    border-bottom: none;
  }

  .menu a:hover {
    background: color-mix(in srgb, var(--brand) 12%, transparent);
    transform: translateX(5px);
    box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--brand) 40%, transparent);
  }

  .menu .label {
    padding: 10px 16px;
    font-size: 12px;
    color: var(--muted);
    border-bottom: 1px solid var(--line);
    background: color-mix(in srgb, var(--card) 80%, transparent);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .overlay {
    position: fixed;
    inset: 0;
    display: none;
    place-items: center;
    z-index: 110;
    background: color-mix(in srgb, #000 25%, transparent);
    backdrop-filter: saturate(1.8) blur(15px);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .overlay.show {
    display: grid;
    opacity: 1;
  }

  .profile-card, .modal-card {
    width: min(880px, 96vw);
    background: linear-gradient(180deg, color-mix(in srgb, var(--card) 92%, #fff), var(--card));
    border: 1px solid color-mix(in srgb, var(--line) 60%, transparent);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    padding: 28px;
    animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
  }

  .profile-card::before, .modal-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 6px;
    background: var(--gradient-primary);
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
  }

  @keyframes pop {
    from {
      transform: scale(0.9);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }

  .btn {
    appearance: none;
    border: 1px solid var(--line);
    background: var(--card);
    padding: 14px 20px;
    border-radius: var(--radius);
    cursor: pointer;
    font-weight: 800;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
  }

  .btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: var(--gradient-primary);
    transition: left 0.5s ease;
    z-index: -1;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
  }

  .btn.primary {
    background: var(--gradient-primary);
    color: #fff;
    border-color: transparent;
    box-shadow: 0 6px 20px rgba(46, 139, 87, 0.3);
  }

  .btn.primary:hover {
    box-shadow: 0 10px 30px rgba(46, 139, 87, 0.4);
    transform: translateY(-3px);
  }

  .btn[disabled] {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
  }

  .fld {
    display: grid;
    gap: 10px;
    margin: 14px 0;
  }

  .fld input, .fld select {
    width: 100%;
    padding: 14px 16px;
    border-radius: var(--radius);
    border: 1px solid var(--line);
    background: linear-gradient(180deg, var(--card), color-mix(in srgb, var(--card) 92%, #000));
    transition: all 0.3s ease;
    font-family: inherit;
  }

  .fld input:focus, .fld select:focus {
    outline: none;
    border-color: var(--brand);
    box-shadow: 0 0 0 3px color-mix(in srgb, var(--brand) 30%, transparent);
  }

  .grid2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .muted {
    color: var(--muted);
  }

  .divider {
    height: 1px;
    background: var(--line);
    margin: 16px 0;
  }

  @media (max-width: 900px) {
    .grid2 {
      grid-template-columns: 1fr;
    }
  }

  .modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 20px;
  }

  .dropzone {
    border: 2px dashed color-mix(in srgb, var(--line) 70%, transparent);
    border-radius: var(--radius);
    padding: 24px;
    display: grid;
    gap: 16px;
    place-items: center;
    background: linear-gradient(180deg, color-mix(in srgb, var(--card) 70%, transparent), transparent);
    transition: all 0.3s ease;
  }

  .dropzone.drag {
    border-color: color-mix(in srgb, var(--brand) 70%, var(--line));
    background: color-mix(in srgb, var(--brand) 10%, transparent);
  }

  .preview {
    width: min(320px, 80vw);
    height: min(320px, 60vh);
    border-radius: var(--radius);
    overflow: hidden;
    border: 1px solid var(--line);
    background: repeating-conic-gradient(#f5f7f6 0% 25%, #eaf1ec 0% 50%) 50% / 16px 16px;
    display: grid;
    place-items: center;
    box-shadow: var(--shadow-sm);
  }

  .preview img {
    max-width: 100%;
    max-height: 100%;
    display: block;
    border-radius: inherit;
  }

  .hint {
    font-size: 13px;
    color: var(--muted);
  }

  /* Loading animation */
  @keyframes pulse {
    0% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
    100% {
      opacity: 1;
    }
  }

  .loading {
    animation: pulse 2s infinite;
  }

  /* Scrollbar styling */
  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-track {
    background: color-mix(in srgb, var(--bg) 80%, transparent);
    border-radius: 10px;
  }

  ::-webkit-scrollbar-thumb {
    background: color-mix(in srgb, var(--brand) 60%, transparent);
    border-radius: 10px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: var(--brand);
  }

  /* Responsive improvements */
  @media (max-width: 768px) {
    .row {
      padding: 10px 16px;
    }
    
    .brand img {
      width: 44px;
      height: 44px;
    }
    
    .chipbar {
      padding: 10px 16px 14px;
    }
    
    .chip {
      padding: 10px 16px;
      font-size: 14px;
    }
    
    main {
      padding: calc(var(--vh) * 40 + 16px) 16px 60px;
    }
    
    .section-hdr {
      padding: 16px 20px;
    }
    
    .cardX {
      padding: 16px;
    }
    
    .btn {
      padding: 12px 16px;
    }
  }

  /* Accessibility improvements */
  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* Focus styles for keyboard navigation */
  button:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible {
    outline: 2px solid var(--brand);
    outline-offset: 2px;
  }
  </style>
</head>
<body>
  <header class="hdr" id="hdr">
    <div class="row">
      <div class="brand">
        <img src="./logo.png" alt="LM"/>
        <div style="display:grid;line-height:1.1">
          <span style="font-size:18px;font-weight:800">LeaderMath.<b style="color:var(--brand)">UZ</b></span>
          <small style="color:var(--muted)">Matematika platformasi</small>
        </div>
      </div>
      <div class="grow"></div>
      <div id="user-slot"></div>
    </div>

    <div class="chipbar-wrap" id="chipwrap">
      <nav id="chipbar" class="chipbar" aria-label="Bo'limlar"></nav>
    </div>
  </header>

  <!-- Faqat slot:"fullscreen" bannerlar karuseli -->
  <div class="banner-carousel-section" id="bannerCarouselSection">
    <div class="banner-carousel" id="bannerCarousel"></div>
    <button class="banner-nav prev" id="bannerPrev">‹</button>
    <button class="banner-nav next" id="bannerNext">›</button>
    <div class="banner-indicators" id="bannerIndicators"></div>
  </div>

  <main id="app"><div id="sections"></div></main>

  <div id="overlay" class="overlay" aria-modal="true"></div>
  <div id="portal-root"></div>

  <!-- App JS -->
  <script type="module">
  /* Firebase */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, setPersistence, browserLocalPersistence, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getStorage, ref as sRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
    authDomain: "xplusy-760fa.firebaseapp.com",
    projectId: "xplusy-760fa",
    storageBucket: "xplusy-760fa.appspot.com",
    messagingSenderId: "992512966017",
    appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
    measurementId: "G-459PLJ7P7L"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const st   = getStorage(app);
  try { await setPersistence(auth, browserLocalPersistence); } catch {}

  /* Helpers */
  const q=(s,r=document)=>r.querySelector(s); const qa=(s,r=document)=>[...r.querySelectorAll(s)];
  const ALWAYS_REQ=['firstName','lastName','birthDate','region','district','role'];
  let REGIONS=[]; let CURRENT_USER=null; let PROFILE=null; let USER_POINTS=0;

  // Dynamic VH + top gap
  function setVH(){ const vh = innerHeight * 0.01; document.documentElement.style.setProperty('--vh', `${vh}px`); }
  function updateTopGap(){
    const hdrH = (q('#hdr')?.getBoundingClientRect().height || 0);
    const chipH = (q('#chipwrap')?.getBoundingClientRect().height || 0);
    document.documentElement.style.setProperty('--top-gap', (hdrH + chipH) + 'px');
  }
  setVH(); updateTopGap();
  addEventListener('resize', ()=>{ setVH(); updateTopGap(); });
  addEventListener('orientationchange', ()=>{ setVH(); updateTopGap(); });

  const calcAge=iso=>{try{const b=new Date(iso),t=new Date();let a=t.getFullYear()-b.getFullYear();const m=t.getMonth()-b.getMonth();if(m<0||(m===0&&t.getDate()<b.getDate()))a--;return a;}catch{return '';}};

  async function getProfile(uid){const s=await getDoc(doc(db,'profiles',uid));return s.exists()?s.data():null;}
  async function saveProfile(uid,data){data.updatedAt=serverTimestamp();if(!PROFILE)data.createdAt=serverTimestamp();await setDoc(doc(db,'profiles',uid),data,{merge:false});PROFILE=data;}
  async function getUserPoints(uid){try{const s=await getDoc(doc(db,'users',uid));return s.exists()?(s.data().points||0):0;}catch{return 0;}}
  async function loadRegions(){
    try{const r=await fetch('./region.json',{cache:'no-store'});if(!r.ok)throw 0;const j=await r.json();return j?.regions||[];}
    catch{return[{name:"Toshkent",districts:[{name:"Chilonzor",schools:["1-maktab","12-maktab"]},{name:"Olmazor",schools:["5-maktab","14-maktab"]}]},{name:"Samarqand",districts:[{name:"Urgut",schools:["3-maktab","28-maktab"]}]}];}
  }

  /* ===== Fullscreen banners: faqat slot:"fullscreen" bo‘lsin ===== */
  const BSTATE = { banners: [], currentIndex: 0, interval: null };

  function parseLocal(s){
    if(!s) return null;
    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/);
    if(!m) return null;
    const [,Y,M,D,h,mn]=m;
    return new Date(+Y,+M-1,+D,+h,+mn,0,0);
  }
  function activeByTime(b){
    const now = new Date();
    const s = parseLocal(b.startAt), e = parseLocal(b.endAt);
    if (s && now < s) return false;
    if (e && now > e) return false;
    return true;
  }

  async function fetchBanners(){
    try{
      const snap = await getDoc(doc(db,'configs','home'));
      if(!snap.exists()) return [];
      const data = snap.data();
      const sections = Array.isArray(data.sections)? data.sections : [];
      const all = [];
      for(const sec of sections){
        // eski sxema
        if(Array.isArray(sec.banners)) all.push(...sec.banners);
        // subsections
        if(Array.isArray(sec.subsections)){
          for(const s2 of sec.subsections){
            if(Array.isArray(s2.banners)) all.push(...s2.banners);
            if(Array.isArray(s2.items))   all.push(...s2.items.filter(x=>x?.kind==='banner'));
          }
        }
        // yangi sxema (sec.items)
        if(Array.isArray(sec.items)) all.push(...sec.items.filter(x=>x?.kind==='banner'));
      }
      return all
        .filter(b => (b.slot||'')==='fullscreen')
        .filter(activeByTime)
        .sort((a,b)=>(+a.order||0)-(+b.order||0));
    }catch(e){ console.warn(e); return []; }
  }

  function bannerFrameFromObj(b, baseHref=null){
    const f=document.createElement('iframe'); f.className='sbx';
    f.setAttribute('sandbox', b.sandbox || 'allow-scripts allow-forms');
    f.setAttribute('scrolling','no');
    f.style.width='100%'; f.style.height='100%'; f.style.border='0';
    if (b.mode==='url'){ f.src=b.src||''; }
    else {
      const base = b.baseHref || baseHref || '';
      const html = `<!doctype html><html><head>${base?`<base href="${base}">`:""}<meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
        <style>html,body{height:100%;margin:0;overflow:hidden;background:transparent}</style></head>
        <body>${String(b.contentHtml||'')}</body></html>`;
      f.srcdoc = html;
    }
    return f;
  }

  function renderBannerCarousel(banners){
    const cont=q('#bannerCarousel');
    const ind=q('#bannerIndicators');
    cont.innerHTML=''; ind.innerHTML='';
    if(!banners.length){ q('#bannerCarouselSection').style.display='none'; return; }
    q('#bannerCarouselSection').style.display='block';
    BSTATE.banners=banners; BSTATE.currentIndex=0;

    banners.forEach((b,i)=>{
      const slide=document.createElement('div'); slide.className='banner-slide';
      slide.appendChild(bannerFrameFromObj(b)); cont.appendChild(slide);
      const dot=document.createElement('div'); dot.className='banner-indicator'+(i===0?' active':'');
      dot.onclick=()=>goToBanner(i); ind.appendChild(dot);
    });

    q('#bannerPrev').onclick=prevBanner;
    q('#bannerNext').onclick=nextBanner;

    startBannerRotation();
    cont.addEventListener('mouseenter', stopBannerRotation);
    cont.addEventListener('mouseleave', startBannerRotation);
  }
  function goToBanner(i){
    if(!BSTATE.banners.length) return;
    BSTATE.currentIndex=(i+BSTATE.banners.length)%BSTATE.banners.length;
    q('#bannerCarousel').style.transform=`translateX(-${BSTATE.currentIndex*100}%)`;
    qa('.banner-indicator').forEach((el,k)=>el.classList.toggle('active',k===BSTATE.currentIndex));
    stopBannerRotation(); startBannerRotation();
  }
  const nextBanner=()=>goToBanner(BSTATE.currentIndex+1);
  const prevBanner=()=>goToBanner(BSTATE.currentIndex-1);
  function startBannerRotation(){ stopBannerRotation(); if(BSTATE.banners.length>1) BSTATE.interval=setInterval(nextBanner,5000); }
  function stopBannerRotation(){ if(BSTATE.interval){ clearInterval(BSTATE.interval); BSTATE.interval=null; } }
  async function loadBanners(){ renderBannerCarousel(await fetchBanners()); }

  /* ===== HOME (sections/cards) ===== */
  async function fetchHome(){
    try{const s=await getDoc(doc(db,'configs','home')); if(s.exists()){const d=s.data(); if(Array.isArray(d.sections)) return d;}}catch{}
    return {sections:[]};
  }
  const HSTATE={ sections:[], activeId:null };
  const ORDER={active:0, soon:1, available:2, ended:3};
  const parseLocalCard = parseLocal;
  const fmtDate=(d)=>!d?'-':`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  function cardState(it){
    if(it.cardStyle==='soon') return 'soon';
    if(it.cardStyle==='timed'){ const now=new Date(), s=parseLocalCard(it.startAt), e=parseLocalCard(it.endAt);
      if(s && now<s) return 'soon'; if(s && e && now>=s && now<=e) return 'active'; if(e && now>e) return 'ended'; return 'active'; }
    return 'available';
  }

  function renderChips(){
    const bar=q('#chipbar'); bar.innerHTML='';
    HSTATE.sections.forEach((s,i)=>{
      const b=document.createElement('button'); b.className='chip'+(i===0?' active':'');
      b.textContent=s.title||s.id||('Bo\'lim '+(i+1)); b.dataset.target=s.id||('sec'+i);
      b.onclick=()=>{ activate(b.dataset.target); b.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'}); };
      bar.appendChild(b);
    });
  }

  function renderCarousel(banners, fullBleed=false, baseHref=null, intervalMs=4500){
    const vp=document.createElement('div'); vp.className=fullBleed?'carousel-viewport':'ratio'; if(!fullBleed) vp.dataset.r='16-9';
    const slideWrap=document.createElement('div'); slideWrap.style.cssText='position:absolute;inset:0;display:grid;grid-auto-flow:column;grid-auto-columns:100%;transition:transform .6s ease;'; vp.appendChild(slideWrap);
    const frames=banners.map(b=>{ const holder=document.createElement('div'); holder.style.cssText='position:relative;width:100%;height:100%';
      const fr=bannerFrameFromObj(b, baseHref); fr.style.cssText='position:absolute;inset:0;width:100%;height:100%'; holder.appendChild(fr); slideWrap.appendChild(holder); return holder; });
    let i=0, timer=null; const go=n=>{i=(n+frames.length)%frames.length; slideWrap.style.transform=`translateX(-${i*100}%)`;};
    const play=()=>{ stop(); if(frames.length>1) timer=setInterval(()=>go(i+1), intervalMs); };
    const stop=()=>{ if(timer){ clearInterval(timer); timer=null; } };
    vp.addEventListener('pointerenter', stop); vp.addEventListener('pointerleave', play); if(frames.length>1) play(); return vp;
  }
  function renderBanner(b, fullBleed=false, baseHref=null){
    if(fullBleed){ const wrap=document.createElement('div'); wrap.className='carousel-viewport'; wrap.appendChild(bannerFrameFromObj(b, baseHref)); return wrap; }
    const r=document.createElement('div'); r.className='ratio'; r.dataset.r='16-9'; r.appendChild(bannerFrameFromObj(b, baseHref)); return r;
  }
  function renderCard(it){
    const c=document.createElement('div'); c.className='cardX'; c.dataset.kind='card';
    const title=it.title||'Card'; const st=cardState(it); c.dataset.state=st;
    const row=document.createElement('div'); row.className='rowflex';
    const h=document.createElement('h4'); h.textContent=title; row.appendChild(h);
    const bd=document.createElement('span'); bd.className='badge '+(st==='soon'?'soon':st==='active'?'active':st==='ended'?'ended':''); bd.textContent=(st==='soon'?'Yaqinda':st==='active'?'Faol':st==='ended'?'Tugagan':'Mavjud'); row.appendChild(bd); c.appendChild(row);
    if(it.cardStyle==='timed'){ const s=parseLocalCard(it.startAt), e=parseLocalCard(it.endAt);
      const t=document.createElement('div'); t.className='muted'; t.textContent=`Vaqt: ${fmtDate(s)} — ${fmtDate(e)}`; c.appendChild(t); }
    const actions=document.createElement('div'); actions.className='rowflex';
    const info=document.createElement('button'); info.className='btn'; info.textContent='ℹ️ Info';
    info.onclick=()=> showOverlay(`<div class="profile-card"><div style="display:flex;justify-content:space-between;align-items:center"><b>${title}</b><button class="btn" onclick="(${closeOverlay.toString()})();">Yopish</button></div><div class="divider"></div>${it.infoHtml||'<p class="muted">Ma\'lumot yo\'q.</p>'}</div>`);
    actions.appendChild(info);
    const a=document.createElement('a'); a.className='btn primary'; a.textContent=it.ctaLabel||'Boshlash';
    if(st==='active' && it.ctaHref){ a.href=it.ctaHref; a.target='_blank'; } else { a.classList.remove('primary'); a.setAttribute('disabled',''); }
    actions.appendChild(a); c.appendChild(actions); return c;
  }
  function buildFilters(){
    const wrap=document.createElement('div'); wrap.className='inline-filters';
    const options=[{key:'all',label:'Barchasi'},{key:'active',label:'Faol'},{key:'soon',label:'Yaqinda'},{key:'available',label:'Mavjud'},{key:'ended',label:'Tugagan'}];
    const chips=options.map(o=>{ const b=document.createElement('button'); b.className='fchip'+(o.key==='all'?' active':''); b.dataset.f=o.key; b.textContent=o.label;
      b.onclick=()=>{ chips.forEach(x=>x.classList.toggle('active',x===b)); f.onChange && f.onChange(o.key); }; wrap.appendChild(b); return b; });
    const f={wrap,onChange:null}; return f;
  }
  function applyFilter(grid, key){ qa('.cardX', grid).forEach(card=>{ const st=card.dataset.state||'available'; const show=(key==='all')||(st===key); card.style.display=show?'flex':'none'; }); }
  function sortCards(cards){ return [...cards].sort((a,b)=>{ const sa=cardState(a), sb=cardState(b); const oa=(ORDER[sa]??9), ob=(ORDER[sb]??9); if(oa!==ob) return oa-ob; const as=parseLocalCard(a.startAt)?.getTime()||0; const bs=parseLocalCard(b.startAt)?.getTime()||0; return as-bs; }); }

  function renderSubSection(ss){
    const wrap=document.createElement('section'); wrap.className='section';
    const head=document.createElement('div'); head.className='section-hdr'; head.innerHTML=`<h3>${ss.title||ss.id||'Bo\'lim'}</h3>`; wrap.appendChild(head);
    const body=document.createElement('div'); body.className='iframe-wrap'; const inner=document.createElement('div'); inner.style.padding='12px';

    const items=Array.isArray(ss.items)?ss.items:[]; const banners=items.filter(x=>x.kind==='banner'); let cards=items.filter(x=>x.kind==='card'); cards=sortCards(cards);
    if(banners.length>1) inner.appendChild(renderCarousel(banners,false, ss.baseHref));
    else if(banners.length===1) inner.appendChild(renderBanner(banners[0],false, ss.baseHref));
    if(cards.length){ const filters=buildFilters(); inner.appendChild(filters.wrap); const grid=document.createElement('div'); grid.className='grid'; cards.forEach(c=>grid.appendChild(renderCard(c))); inner.appendChild(grid); filters.onChange=(k)=>applyFilter(grid,k); }

    const subs=Array.isArray(ss.subsections)?ss.subsections:[]; subs.forEach(s2=> inner.appendChild(renderSubSection(s2)));
    body.appendChild(inner); wrap.appendChild(body); return wrap;
  }

  function renderSection(sec){
    const id = sec.id || ('sec' + Math.random());
    const outer = document.createElement('section'); outer.dataset.section = id; outer.className = 'section';
    const sh = document.createElement('div'); sh.className = 'section-hdr'; sh.innerHTML = `<h3>${sec.title || id}</h3>`; outer.appendChild(sh);

    const body = document.createElement('div'); body.className = 'iframe-wrap';
    const inner = document.createElement('div'); inner.style.padding = '12px';

    // Birinchi darajadagi sub-bo‘limlarni ketma-ket render
    const subs = Array.isArray(sec.subsections) ? sec.subsections : [];
    subs.forEach((sub, idx) => {
      const subWrap = document.createElement('div'); subWrap.className = 'section'; subWrap.style.margin = '16px 0';
      const subHead = document.createElement('div'); subHead.className = 'section-hdr';
      subHead.innerHTML = `<h4>${sub.title || ('Sub ' + (idx + 1))}</h4>`;
      subWrap.appendChild(subHead);

      const subBody = document.createElement('div'); subBody.className = 'iframe-wrap';
      const subInner = document.createElement('div'); subInner.style.padding = '10px';

      const banners = Array.isArray(sub.banners) ? sub.banners : [];
      const cards   = Array.isArray(sub.cards)   ? sub.cards   : [];

      if (banners.length > 1) subInner.appendChild(renderCarousel(banners, false, sub.baseHref));
      else if (banners.length === 1) subInner.appendChild(renderBanner(banners[0], false, sub.baseHref));

      if (cards.length) {
        const filters = buildFilters(); subInner.appendChild(filters.wrap);
        const grid = document.createElement('div'); grid.className = 'grid';
        cards.forEach(c => grid.appendChild(renderCard(c)));
        subInner.appendChild(grid);
        filters.onChange = k => applyFilter(grid, k);
      }

      subBody.appendChild(subInner);
      subWrap.appendChild(subBody);
      inner.appendChild(subWrap);
    });

    // Agar sub-bo‘limlar bo‘lmasa, eski banner/cardlar
    if (!subs.length) {
      const banners = Array.isArray(sec.banners) ? sec.banners : [];
      const cards   = Array.isArray(sec.cards)   ? sec.cards   : [];

      if (banners.length > 1) inner.appendChild(renderCarousel(banners, false, sec.baseHref));
      else if (banners.length === 1) inner.appendChild(renderBanner(banners[0], false, sec.baseHref));

      if (cards.length) {
        const filters = buildFilters(); inner.appendChild(filters.wrap);
        const grid = document.createElement('div'); grid.className = 'grid';
        cards.forEach(c => grid.appendChild(renderCard(c)));
        inner.appendChild(grid);
        filters.onChange = k => applyFilter(grid, k);
      }
    }

    body.appendChild(inner);
    outer.appendChild(body);
    return outer;
  }

  function renderSections(){
    const host=q('#sections'); host.innerHTML='';
    HSTATE.sections.forEach(s=> host.appendChild(renderSection(s)));
  }

  function activate(id){
    HSTATE.activeId=id;
    document.querySelectorAll('.chip').forEach(c=>c.classList.toggle('active', c.dataset.target===id));
    qa('[data-section]').forEach(s=>{ const show=(s.dataset.section===id); s.style.display=show?'block':'none'; });
    updateTopGap();
  }

  async function loadHome(){
    const data=await fetchHome();
    HSTATE.sections = (Array.isArray(data.sections)? data.sections: []).map((s,i)=>({ id: (s.id||`sec${i+1}`), ...s }));
    // chiplar
    const bar=q('#chipbar'); bar.innerHTML='';
    HSTATE.sections.forEach((s,i)=>{
      const b=document.createElement('button'); b.className='chip'+(i===0?' active':'');
      b.textContent=s.title||s.id||('Bo\'lim '+(i+1)); b.dataset.target=s.id||('sec'+i);
      b.onclick=()=>{ activate(b.dataset.target); b.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'}); };
      bar.appendChild(b);
    });
    renderSections(); if(HSTATE.sections.length) activate(HSTATE.sections[0].id);
  }

  /* ===== USER CHIP va profillar (o'zgarmagan qismlar) ===== */
  const showOverlay=html=>{const ov=q('#overlay'); ov.innerHTML=html; ov.classList.add('show');};
  const closeOverlay=()=>{const ov=q('#overlay'); ov.classList.remove('show'); ov.innerHTML='';};
  q('#overlay').addEventListener('click', (e)=>{ if(e.target.id==='overlay') closeOverlay(); });
  addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeOverlay(); });

  function renderUserChip(u, profile){
    const slot=q('#user-slot');
    const age=profile?.birthDate?calcAge(profile.birthDate):'';
    const name=profile?.firstName?(profile.firstName+(profile.lastName?' '+profile.lastName:'')):(u.displayName||u.email||'Foydalanuvchi');
    const avatar=profile?.avatarUrl||u.photoURL||''; const role=profile?.role||'—';
    slot.innerHTML=`
      <div class="userchip" id="userchip" aria-haspopup="menu" aria-expanded="false">
        <div class="avatar">${avatar?`<img src="${avatar}" alt="">`:''}</div>
        <div style="display:grid;line-height:1"><b style="font-size:14px">${name}</b><small class="mini">${role} • ${age?age+' yosh • ':''}${USER_POINTS} points</small></div>
        <div class="menu" id="usermenu" role="menu">
          <a href="#" id="mProfile" role="menuitem">Profil</a>
          <a href="#" id="mEdit" role="menuitem">Profilni tahrirlash</a>
          <a href="#" id="mLogout" role="menuitem">Chiqish</a>
          <div class="label">Aloqa</div>
          <a href="tel:+998901234567">+998 90 123 45 67</a>
          <a href="mailto:info@leadermath.uz">info@leadermath.uz</a>
          <a href="https://t.me/LeaderMathUZ" target="_blank" rel="noopener">Telegram</a>
          <a href="https://t.me/LeaderMathBot" target="_blank" rel="noopener">Bot</a>
          <a href="https://instagram.com/leadermath.uz" target="_blank" rel="noopener">Instagram</a>
          <a href="https://www.youtube.com/@leadermathuz" target="_blank" rel="noopener">YouTube</a>
        </div>
      </div>`;
  }
  function openUserMenu(){
    const chip = q('#userchip'); const menu=q('#usermenu'); if(!chip||!menu) return;
    (q('#portal-root')||document.body).appendChild(menu);
    menu.style.visibility='hidden'; menu.style.display='block';
    const r = chip.getBoundingClientRect(); const mw = menu.offsetWidth, mh = menu.offsetHeight, gap = 8;
    let left = Math.min(Math.max(r.right - mw, 8), innerWidth - mw - 8); let top  = r.bottom + gap;
    if (top + mh > innerHeight - 8) top = Math.max(8, r.top - gap - mh);
    menu.style.left = left+'px'; menu.style.top = Math.max(8, top)+'px';
    menu.classList.add('open'); menu.style.visibility='visible'; chip.setAttribute('aria-expanded','true');
    const closeOnOutside = (e)=>{ if(!menu.contains(e.target) && !chip.contains(e.target)) closeUserMenu(); };
    const onSR = ()=> position();
    function position(){
      if(!menu.classList.contains('open')) return;
      const r2 = chip.getBoundingClientRect();
      let L = Math.min(Math.max(r2.right - mw, 8), innerWidth - mw - 8);
      let T = r2.bottom + gap;
      if (T + mh > innerHeight - 8) T = Math.max(8, r2.top - gap - mh);
      menu.style.left=L+'px'; menu.style.top=Math.max(8,T)+'px';
    }
    menu._closers={closeOnOutside, onSR};
    addEventListener('click', closeOnOutside, {capture:true});
    addEventListener('scroll', onSR, {passive:true});
    addEventListener('resize', onSR, {passive:true});
  }
  function closeUserMenu(){
    const menu=q('#usermenu'); if(!menu) return;
    menu.classList.remove('open'); menu.style.display='none';
    if(menu._closers){
      removeEventListener('click', menu._closers.closeOnOutside, {capture:true});
      removeEventListener('scroll', menu._closers.onSR);
      removeEventListener('resize', menu._closers.onSR);
      menu._closers=null;
    }
    const chip=q('#userchip'); if(chip){ chip.appendChild(menu); chip.setAttribute('aria-expanded','false'); }
  }

  // Profil editori (o'zgarmagan qismlar) — qisqa
  function readFileToDataURL(file){
    return new Promise((resolve, reject)=>{
      const ok = /image\/(png|jpe?g|webp|gif)$/i.test(file.type);
      if(!ok) return reject(new Error('Rasm formati: JPG/PNG/WebP/GIF.'));
      const reader=new FileReader();
      reader.onload=()=>resolve(reader.result);
      reader.onerror=()=>reject(new Error('Faylni o\'qishda xatolik.'));
      reader.readAsDataURL(file);
    });
  }
  const showAvatarModal = (initial)=>{/* qisqartirilgan: avvalgi kodingiz bilan bir xil ishlaydi */};

  // Auth lock
  function setLocked(b){const a=q('#app'); if(a) a.hidden=b;}
  function buildAuthLock(){ if(q('#auth-lock')) return q('#auth-lock');
    const lock=document.createElement('div'); lock.id='auth-lock'; lock.className='overlay show';
    lock.innerHTML=`<div class="profile-card">
      <div class="fld"><label>Email</label><input type="email" id="eml" placeholder="email@example.com"></div>
      <div class="fld"><label>Parol</label><input type="password" id="pwd" placeholder="••••••••"></div>
      <div id="err" style="color:#c62828"></div>
      <div style="display:flex;gap:10px">
        <button id="login" class="btn primary">Kirish</button>
        <button id="signup" class="btn">Ro'yxatdan o'tish</button>
        <button id="google" class="btn">Google</button>
      </div>
    </div>`;
    document.body.appendChild(lock);
    lock.addEventListener('click', async (e)=>{
      const id=e.target.id, errEl=q('#err',lock); const busy=b=>qa('button',lock).forEach(x=>x.disabled=b);
      try{
        busy(true);
        if(id==='google') await signInWithPopup(auth,new GoogleAuthProvider());
        if(id==='login'){ const eml=q('#eml',lock).value.trim(), pwd=q('#pwd',lock).value; await signInWithEmailAndPassword(auth,eml,pwd); }
        if(id==='signup'){ const eml=q('#eml',lock).value.trim(), pwd=q('#pwd',lock).value; await createUserWithEmailAndPassword(auth,eml,pwd); }
      }catch(err){ if(errEl) errEl.textContent=err?.message||String(err); } finally{ busy(false); }
    });
    return lock;
  }

  onAuthStateChanged(auth, async (u)=>{
    CURRENT_USER=u||null;
    if(!u){ setLocked(true); buildAuthLock(); q('#user-slot').innerHTML=''; return; }
    qa('#auth-lock').forEach(x=>x.remove()); setLocked(false);
    if(!REGIONS.length) REGIONS=await loadRegions();
    [PROFILE, USER_POINTS] = await Promise.all([ getProfile(u.uid), getUserPoints(u.uid) ]);
    if(PROFILE && !PROFILE.role){ PROFILE.role='O\'quvchi'; await saveProfile(u.uid, PROFILE); }
    renderUserChip(u, PROFILE||{});
    const baseOk = ALWAYS_REQ.every(k=>PROFILE && PROFILE[k]);
    const ok = baseOk && (PROFILE?.role!=='O\'quvchi' || !!PROFILE.class);
    if(!ok){ /* istasangiz: profilni to'ldirish modalini oching */ }
  });

  // Global delegation
  document.addEventListener('click', (e)=>{
    const t=e.target;
    if(t.closest('#userchip')){
      const open = q('#usermenu')?.classList.contains('open');
      open ? closeUserMenu() : openUserMenu();
    }
    if(t.closest('#mLogout')){ e.preventDefault(); closeUserMenu(); signOut(auth); }
  });

  // Start
  await loadHome();
  await loadBanners();   // faqat slot:"fullscreen" bannerni tepada karusel qiladi
  updateTopGap();
  </script>
</body>
</html>
