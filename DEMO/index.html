<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>LeaderMath — Premium Glass PWA</title>
  <meta name="theme-color" content="#2E8B57" id="meta-theme-color"/>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./favicon.png">
  <style>
/* === THEME === */
:root{
  --brand:#2E8B57;--brand2:#1F6B45;
  --bg:#f4f8f6;--text:#0d1b14;--muted:#375c4c;--card:#ffffff;
  --frame:#d8e7dd;--frame-strong:#b7d6c5;--chip:#eaf6f0;--chip-b:#cfe7db;
  --radius:16px; --ring:#8ad1b1;
}
:root.dark{
  --bg:#0e1512; --text:#EAF7EE; --muted:#A5C7B4; --card:#142018;
  --frame:#244b39; --frame-strong:#2f6b52; --chip:#132a20; --chip-b:#2a5742; --ring:#2fbf7d;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

/* -------- AUTH GUARD -------- */
html.auth-checking #app{display:none}
html.auth-checking #authGate{display:flex}
#authGate{
  position:fixed; inset:0; z-index:9999; display:none;
  align-items:center; justify-content:center; padding:24px;
  background:linear-gradient(135deg, rgba(14,21,18,.85), rgba(31,107,69,.85));
  backdrop-filter: blur(10px);
}
#authCard{
  width:min(560px,96vw);
  background:var(--card);
  border:1px solid var(--frame-strong);
  border-radius:18px;
  padding:20px;
  box-shadow:0 24px 64px rgba(0,0,0,.35);
}
#authCard h2{ margin:0 0 6px; font-size:22px }
#authCard p{ margin:0 0 14px; color:var(--muted) }
.auth-row{ display:flex; gap:10px; justify-content:flex-end; margin-top:8px }

/* ====== PREMIUM GLASS BUTTONS ====== */
.btn{
  position:relative; display:inline-flex; align-items:center; justify-content:center; gap:8px;
  padding:10px 14px; border:none; border-radius:12px; cursor:pointer; text-decoration:none;
  font-weight:800; color:#fff; isolation:isolate;
  background:linear-gradient(135deg,var(--brand),var(--brand2));
  box-shadow:0 6px 18px rgba(46,139,87,.25), inset 0 0 0 1px #ffffff22;
  transition:transform .12s ease, box-shadow .12s ease, filter .12s ease;
  backdrop-filter:saturate(120%);
}
.btn:hover{ transform:translateY(-1px); box-shadow:0 10px 28px rgba(46,139,87,.32), inset 0 0 0 1px #ffffff33 }
.btn:active{ transform:translateY(0); filter:saturate(1.05) }
.btn:focus-visible{ outline:none; box-shadow:0 0 0 4px color-mix(in srgb, var(--ring) 30%, transparent) }
.btn.ghost{
  background:linear-gradient(180deg,#fff,#f5faf7); color:var(--brand2); border:1px solid var(--frame);
}
.dark .btn.ghost{ background:linear-gradient(180deg,#1a2a21,#17261f); color:#c8f0dc; border-color:#2a5742 }

/* Small pill */
.uc-pill{display:inline-flex;align-items:center;gap:6px;padding:7px 12px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-b);font-size:13px}
.uc-pill .uc-pill-label{opacity:.7}
body:not(.dark) .uc-pill b { color:#000; }

/* Ichki UI helpers */
.glass{background:rgba(255,255,255,.6);backdrop-filter:blur(12px)}
.dark .glass{background:rgba(20,32,24,.55)}
.grad-border{position:relative}
.grad-border::before{
  content:""; position:absolute; inset:0; padding:1px; border-radius:14px;
  background:linear-gradient(135deg, #9ce8c0, #2E8B57 40%, #39B6FF);
  -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
  -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none;
}

/* Appbar */
.appbar{position:sticky;top:0;z-index:90;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:10px 12px;display:flex;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
.logo{width:60px;height:60px;border-radius:14px;background:#fff2;display:grid;place-items:center;font-weight:800;overflow:hidden}
.logo img{width:100%;height:100%;object-fit:contain}
.title{font-weight:800;font-size:18px}
.sub{font-size:12px;opacity:.9}
.spacer{flex:1}
.iconbtn{background:#ffffff22;border:1px solid #ffffff33;color:#fff;border-radius:12px;padding:8px 10px;font-weight:700;cursor:pointer}

@media (max-width:600px){
  .logo{width:60px;height:60px;border-radius:10px}
  .title{font-size:16px}
  .sub{font-size:10px}
  .uc-chip{scale:.9}
}

/* === Compact User Chip === */
.uc-chip{display:flex;align-items:center;gap:10px;background:var(--card);border:1px solid var(--frame);border-radius:20px;padding:6px 8px 6px 6px;box-shadow:0 10px 24px rgba(0,0,0,.1);transition:.15s ease}
.uc-chip:hover{transform:translateY(-1px);box-shadow:0 16px 36px rgba(0,0,0,.12)}
.uc-ava{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;font-weight:900;display:grid;place-items:center;overflow:hidden;box-shadow:inset 0 0 0 2px #ffffff22}
.uc-ava img{width:100%;height:100%;object-fit:cover}
.uc-more{width:32px;height:32px;border-radius:10px;border:1px solid var(--frame);background:linear-gradient(180deg,#fff,#f5faf7);cursor:pointer;display:grid;place-items:center;font-size:20px;font-weight:900;color:var(--brand)}

/* === Popover === */
.uc-popover-mask{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:998}
.uc-popover{
  position:fixed;right:14px;top:84px;z-index:999;width:min(520px,94vw);
  background:var(--card);border:1px solid var(--frame-strong);
  border-radius:18px;padding:16px;box-shadow:0 24px 64px rgba(0,0,0,.25);
  display:none;
  background-image:
    radial-gradient(1200px 600px at 10% -20%, rgba(46,139,87,.08), transparent 55%),
    radial-gradient(1200px 600px at 110% 120%, rgba(57,182,255,.08), transparent 55%);
}
.uc-pop-head{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.uc-ava.lg{width:56px;height:56px}
.uc-namebox .uc-fullname{font-weight:900;font-size:18px}
.uc-namebox .uc-sub{color:var(--muted);font-size:12px}
.uc-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0 12px}
@media(max-width:560px){.uc-grid{grid-template-columns:1fr}}
.uc-kv{background:var(--chip);border:1px solid var(--chip-b);border-radius:12px;padding:10px 12px}
.uc-kv .k{font-size:12px;color:var(--muted);margin-bottom:4px}
.uc-kv .v{font-weight:700}
.uc-actions{display:flex;gap:10px;justify-content:flex-end}
.btn-primary{padding:10px 14px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;font-weight:800;cursor:pointer}
.btn-ghost{padding:10px 14px;border:1px solid var(--frame);border-radius:12px;background:#fff;cursor:pointer}
.dark .uc-chip{background:rgba(20,32,24,.65)}
.dark .uc-popover{background:rgba(20,32,24,.85)}

/* Filters (TOP) */
.filters{margin:10px 12px;padding:10px;background:var(--card);border:1px solid var(--frame);border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.06)}
.filters h4{margin:0 0 8px;font-size:14px;opacity:.75}
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-b);font-size:12px;cursor:pointer}
.chip[aria-pressed="true"]{background:linear-gradient(135deg,var(--brand),var(--brand2));border-color:#0000;color:#fff}
.chip.sm{font-size:11px;padding:5px 8px}

/* ====== BANNERS — STORY/CAROUSEL ====== */
.banner-area{margin:14px 12px}
.banner-group{margin-bottom:12px}
.banner-head{display:flex;align-items:center;justify-content:space-between;padding:8px 10px}
.banner-head h2{margin:0;font-size:16px;opacity:.85}
.story{position:relative;border-radius:18px;border:1px solid var(--frame);overflow:hidden;box-shadow:0 10px 24px rgba(0,0,0,.08);background:linear-gradient(135deg,#f0fff6,#e7f6ee);touch-action:pan-y}
.dark .story{background:linear-gradient(135deg,#122019,#0f1714)}
.story-track{display:flex;will-change:transform}
.story-slide{min-width:100%;padding:20px}
.story-progress{position:absolute;top:8px;left:8px;right:8px;display:flex;gap:6px}
.story-bar{flex:1;height:4px;background:#ffffff66;border-radius:999px;overflow:hidden}
.story-bar > span{display:block;height:100%;width:0;background:#fff;}

/* ====== LEADERBOARD (saqlandi) ====== */
.board{background:var(--card);border:1px solid var(--frame);border-radius:16px;margin:10px 12px;padding:12px;border:none}
.board h3{margin:0 0 8px;font-size:16px}
.group{border:none;border-radius:14px;overflow:hidden;margin:10px 0;box-shadow:0 8px 24px rgba(0,0,0,.06)}
.groupBody{padding:12px}
.groupHead{border:none;border-radius:14px;padding:14px 16px;color:var(--muted);font-weight:900;display:flex;align-items:center;justify-content:space-between;gap:10px}
.dark .groupHead{color:#c7ffe7}
.groupHead.tier-bronze{background:linear-gradient(135deg,#fff1e6,#ffd9c2)}
.groupHead.tier-silver{background:linear-gradient(135deg,#f4f7fb,#dfe7f4)}
.groupHead.tier-gold{background:linear-gradient(135deg,#fff4cc,#ffe48a)}
.groupHead.tier-emerald{background:linear-gradient(135deg,#e3f8ee,#c9f1df)}
.groupHead.tier-diamond{background:linear-gradient(135deg,#e8f8ff,#d8f1ff)}
.tier-badge{font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--frame);background:rgba(255,255,255,.4)}
.rank{display:grid;grid-template-columns:54px 1fr auto;gap:12px;align-items:center;padding:10px;border-radius:12px;border:1px solid var(--frame);margin-bottom:8px;background:var(--card);box-shadow:0 2px 6px rgba(0,0,0,.04);transition:.2s;border:none;position:relative}
.rank:hover{transform:scale(1.02);box-shadow:0 10px 28px rgba(46,139,87,.28)}
.rnk{font-weight:900;background:var(--chip);border:1px solid var(--frame);padding:6px 10px;border-radius:10px}
.medal{font-size:22px;line-height:1}
.m1,.m2,.m3{display:inline-block;width:40px;text-align:center;animation:pulse 1.8s ease-in-out infinite alternate}
@keyframes pulse{0%{filter:drop-shadow(0 0 0 rgba(255,200,0,.0))}100%{filter:drop-shadow(0 0 8px rgba(255,200,0,.35))}}
.stars{display:inline-flex;gap:3px;vertical-align:middle}
.tier-bronze .stars{--s:16}.tier-silver .stars{--s:17}.tier-gold .stars{--s:18}.tier-emerald .stars{--s:20}.tier-diamond .stars{--s:24}
.stars svg{width:calc(var(--s)*1px);height:calc(var(--s)*1px)}
.pager{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:8px 0}
.pbtn{background:var(--chip);border:1px solid var(--frame);border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer}
.pbtn[disabled]{opacity:.5;cursor:not-allowed}
.pinfo{font-size:12px;color:var(--muted)}

/* ====== CARDS — YANGI BETAKROR DIZAYN ====== */
.container{padding:6px 12px 90px}
.grid{display:grid;grid-template-columns:1fr;gap:14px}
@media(min-width:560px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(min-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}

.card{
  position:relative; border-radius:16px; overflow:hidden;
  border:1px solid var(--frame); background:var(--card);
  box-shadow:0 10px 26px rgba(0,0,0,.08);
  transition:transform .18s ease, box-shadow .18s ease, filter .18s ease;
}
.card:hover{ transform:translateY(-3px); box-shadow:0 16px 36px rgba(0,0,0,.14) }

/* Cover — rasm yoki tipografik title */
.cover{
  position:relative; aspect-ratio:16/9; display:grid; place-items:center;
  background:linear-gradient(135deg,#e9f5ef,#f6fbf8);
}
.dark .cover{ background:linear-gradient(135deg,#0f1714,#142018) }
.cover.has-img{ background:#000 }
.cover img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; filter:contrast(1.05) saturate(1.05)}
.cover .big-title{
  position:relative; z-index:1; padding:0 10px; text-align:center;
  font-weight:1000; letter-spacing:.3px; line-height:1.05;
  font-size: clamp(20px, 5.8vw, 40px);
  color: #ffffff;
  text-shadow: 0 12px 28px rgba(0,0,0,.45);
}

/* Overlay — Tez kunda / Qolgan vaqt */
.cover .veil{
  position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;
  background:linear-gradient(180deg, rgba(0,0,0,.05), rgba(0,0,0,.55));
  backdrop-filter: blur(6px) saturate(120%);
  -webkit-backdrop-filter: blur(6px) saturate(120%);
  color:#fff; text-align:center; gap:12px; padding:12px;
}
.veil .badge{
  display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
  border:1px solid #ffffff55; background:#ffffff22; font-weight:900
}
.veil .big{
  font-size: clamp(22px, 6vw, 38px); font-weight:1000; letter-spacing:.4px; text-shadow:0 8px 20px rgba(0,0,0,.45)
}
.veil .timer{font-size: clamp(16px, 4.8vw, 22px); font-weight:900; opacity:.95}

/* Card body */
.body{padding:12px 12px 14px}
.name{font-size:16px;font-weight:900;margin:0 0 6px}
.desc{font-size:13px;color:var(--muted);margin:0 0 10px}

/* Dynamic buttons */
.actions{display:flex;flex-wrap:wrap;gap:8px}
.btn-lite{
  appearance:none; border:1px solid var(--frame); background:linear-gradient(180deg,#fff,#f5faf7);
  color:var(--brand2); padding:9px 12px; border-radius:10px; font-weight:800; cursor:pointer; text-decoration:none
}
.dark .btn-lite{ background:linear-gradient(180deg,#17261f,#16241d); color:#c8f0dc; border-color:#2a5742 }
.btn-lite.outline{ background:transparent }

/* Meta line */
.meta{font-size:12px;color:var(--muted);margin-top:8px;display:flex;gap:10px;align-items:center}
.countdown{font-weight:800}

/* Modal (HTML viewer) */
.mmask{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:1000}
.mbox{width:min(900px,96vw);max-height:90vh;overflow:auto;border-radius:16px;border:1px solid var(--frame-strong);background:var(--card);box-shadow:0 24px 64px rgba(0,0,0,.45)}
.mhd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--frame)}
.mtitle{font-weight:900}
.mbd{padding:0;height:min(70vh,800px)}
.mbd iframe{display:block;border:0;width:100%;height:100%;background:#fff}
.mft{display:flex;gap:10px;justify-content:flex-end;padding:10px;border-top:1px solid var(--frame)}
  </style>
</head>
<body>
  <!-- ===== AUTH GATE ===== -->
  <div id="authGate">
    <div id="authCard" class="grad-border glass">
      <h2>Davom etish uchun kirish talab qilinadi</h2>
      <p>LeaderMath resurslaridan foydalanish uchun Google orqali tizimga kiring.</p>
      <div class="meta-why">🔒 Siz kirgunga qadar asosiy kontent ko‘rsatilmaydi.</div>
      <div class="auth-row"><a id="goLogin" class="btn">🔑 Kirish</a></div>
    </div>
  </div>

  <!-- ===== APP ===== -->
  <div id="app">
    <header class="appbar">
      <div class="logo"><img src="./icon-512.png" alt="LeaderMath Logo"></div>
      <div>
        <div class="title">LeaderMath</div>
        <div class="sub">BSB / CHSB / ONLINE OLIMPIADA / DTM / dars-resurslar</div>
      </div>
      <div class="spacer"></div>
      <button id="themeBtn" class="iconbtn" title="Dark/Light">🌙</button>
      <div class="uc-chip" id="ucChip" aria-haspopup="dialog" aria-expanded="false">
        <div class="uc-ava" id="ucAva">LM</div>
        <div class="uc-pill"><span class="uc-pill-label">⭐</span><b id="ucPointsVal">—</b></div>
        <button class="uc-more" id="ucMore" aria-label="Profil">⋯</button>
      </div>
    </header>

    <!-- Popover -->
    <div class="uc-popover-mask" id="ucMask"></div>
    <div class="uc-popover grad-border glass" id="ucPopover" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="uc-pop-head">
        <div class="uc-ava lg" id="ucAvaLg">LM</div>
        <div class="uc-namebox">
          <div class="uc-fullname" id="ucName">Foydalanuvchi</div>
          <div class="uc-sub" id="ucNumeric">ID: —</div>
        </div>
      </div>
      <div class="uc-grid">
        <div class="uc-kv"><div class="k">Viloyat</div><div class="v" id="ucRegion">—</div></div>
        <div class="uc-kv"><div class="k">Tuman</div><div class="v" id="ucDistrict">—</div></div>
        <div class="uc-kv"><div class="k">Maktab</div><div class="v" id="ucSchool">—</div></div>
        <div class="uc-kv"><div class="k">Sinf</div><div class="v" id="ucClass">—</div></div>
        <div class="uc-kv"><div class="k">Telefon</div><div class="v" id="ucPhone">—</div></div>
      </div>
      <div class="uc-actions">
        <button class="btn-primary" id="ucOpenProfile">📝 Profil</button>
        <button class="btn-ghost" id="ucSignOut">⬅️ Chiqish</button>
      </div>
    </div>

    <!-- TOP FILTERS -->
    <section class="filters grad-border glass" id="filtersMain">
      <h4>BO‘LIMLAR:</h4>
      <div id="mainTags" class="chips"></div>
    </section>

    <!-- ====== BANNERLAR: BO‘LIMLI STORY/CAROUSEL ====== -->
    <section id="bannerArea" class="banner-area"></section>

    <!-- ====== LEADERBOARD ====== -->
    <section class="board grad-border glass" id="board">
      <h3>League</h3>
      <div class="pager">
        <button id="decilePrev" class="pbtn">⬅️ Oldingi (10)</button>
        <div class="pinfo" id="decileInfo">10–1 (Diamond)</div>
        <button id="decileNext" class="pbtn">Keyingi (10) ➡️</button>
      </div>
      <div id="boardList"></div>
    </section>

    <!-- ====== SECTIONS / CARDS ====== -->
    <div class="container"><div id="sections"></div></div>

    <!-- ====== PROFILE MODAL (saqlangan) ====== -->
    <div id="profileModal" class="modal-mask" aria-modal="true" role="dialog">
      <!-- ... (profil modal kodi o‘zgarmagan; senga yuqoridagi versiyang mos) ... -->
    </div>

    <!-- ====== UNIVERSAL HTML VIEWER MODAL ====== -->
    <div id="htmlModal" class="mmask" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="mbox grad-border glass">
        <div class="mhd">
          <div class="mtitle" id="htmlModalTitle">Ko‘rinish</div>
          <button class="btn-lite outline" id="htmlModalClose">Yopish ✖</button>
        </div>
        <div class="mbd"><iframe id="htmlFrame" sandbox="allow-forms allow-scripts allow-same-origin"></iframe></div>
        <div class="mft">
          <button class="btn-lite" id="htmlModalCopy">HTML’ni nusxalash</button>
        </div>
      </div>
    </div>
  </div>

<!-- =========================== JS =========================== -->
<script type="module">
/* PWA SW */
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./service-worker.js'); }

/* Firebase imports (sening oldingi fayling bilan mos) */
import { auth, db, signOut } from './lib/firebase.client.js';
import { watchAuth } from './lib/auth-guard.js';
import { doc, getDoc, setDoc, runTransaction, collection, query, orderBy, limit, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

/* THEME */
const root=document.documentElement, themeBtn=document.getElementById('themeBtn'), THEME_KEY='lm-theme';
const setTheme=m=>{root.classList.toggle('dark',m==='dark');localStorage.setItem(THEME_KEY,m);themeBtn.textContent=m==='dark'?'☀️':'🌙'};
setTheme(localStorage.getItem(THEME_KEY)||(matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
themeBtn.onclick=()=>setTheme(root.classList.contains('dark')?'light':'dark');

/* EL refs */
const el={
  bannersArea:document.getElementById('bannerArea'),
  sections:document.getElementById('sections'),
  mainTags:document.getElementById('mainTags'),
  boardList:document.getElementById('boardList'),
  decilePrev:document.getElementById('decilePrev'),
  decileNext:document.getElementById('decileNext'),
  decileInfo:document.getElementById('decileInfo'),
  pointsVal:document.getElementById('ucPointsVal'),
  htmlModal:document.getElementById('htmlModal'),
  htmlTitle:document.getElementById('htmlModalTitle'),
  htmlFrame:document.getElementById('htmlFrame'),
  htmlClose:document.getElementById('htmlModalClose'),
  htmlCopy:document.getElementById('htmlModalCopy')
};

/* Helpers */
const toMs=v=> v? (new Date(v)).getTime():null;
const fmtTime=(ms)=>{ if(ms<=0) return '00:00:00';
  const s=Math.floor(ms/1000), h=String(Math.floor(s/3600)).padStart(2,'0'), m=String(Math.floor((s%3600)/60)).padStart(2,'0'), ss=String(s%60).padStart(2,'0');
  return `${h}:${m}:${ss}`; };
const escapeHtml=(s)=>String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const fmtPoints=v=> (Number(v)||0).toLocaleString('uz-UZ',{maximumFractionDigits:1});
const initials=n=>n?(n.trim().split(/\s+/).map(x=>x[0]).join('').slice(0,2).toUpperCase()):'LM';

/* ====== BANNER STORY/CAROUSEL ======
index.json -> { "bannerGroups":[ { "tag":"CHSB", "items":[ { "html":"...", "durationMs":5000 }, ... ] }, ... ] }
*/
function mountBannerGroups(groups=[]){
  el.bannersArea.innerHTML='';
  groups.forEach(g=>{
    const box=document.createElement('div'); box.className='banner-group';
    box.innerHTML=`<div class="banner-head"><h2>${escapeHtml(g.tag||'Bannerlar')}</h2>
      <div class="chips"><span class="chip sm">Story</span><span class="chip sm">Swipe</span><span class="chip sm">Auto</span></div></div>
      <div class="story grad-border glass">
        <div class="story-progress"></div>
        <div class="story-track"></div>
      </div>`;
    const track=box.querySelector('.story-track'), prog=box.querySelector('.story-progress');
    const slides=(g.items||[]).map(it=> String(it.html||''));
    slides.forEach((html,idx)=>{
      const s=document.createElement('div'); s.className='story-slide'; s.innerHTML=html; track.appendChild(s);
      const bar=document.createElement('div'); bar.className='story-bar'; bar.innerHTML='<span></span>'; prog.appendChild(bar);
    });
    el.bannersArea.appendChild(box);

    // Controls: auto-advance + swipe
    let i=0, playing=true, tId=null, startTs=0, dur=()=>Math.max(1500, Number((g.items?.[i]?.durationMs)||4500));
    const bars=[...prog.querySelectorAll('.story-bar span')];
    const setX=()=> track.style.transform=`translateX(${-i*100}%)`;
    const tick=()=>{
      startTs=performance.now();
      const step=()=>{
        const now=performance.now(), p=Math.min(1,(now-startTs)/dur());
        bars[i].style.width=(p*100)+'%';
        if(p<1 && playing){ tId=requestAnimationFrame(step); }
        else { bars[i].style.width='100%'; next(); }
      };
      tId=requestAnimationFrame(step);
    };
    const next=()=>{ cancelAnimationFrame(tId); i=Math.min(i+1, slides.length-1);
      setX(); if(i<slides.length-1){ tick(); } };
    const prev=()=>{ cancelAnimationFrame(tId); i=Math.max(i-1, 0);
      setX(); tick(); };

    // swipe / tap zones
    let sx=0, dx=0, dragging=false;
    track.addEventListener('pointerdown',e=>{ dragging=true; sx=e.clientX; dx=0; track.setPointerCapture(e.pointerId); playing=false; cancelAnimationFrame(tId); });
    track.addEventListener('pointermove',e=>{ if(!dragging)return; dx=e.clientX-sx; track.style.transition='none'; track.style.transform=`translateX(calc(${-i*100}% + ${dx}px))`; });
    const end=()=>{ if(!dragging)return; dragging=false; track.style.transition='transform .2s ease';
      if(Math.abs(dx)>60){ if(dx<0) next(); else prev(); } else { setX(); tick(); } playing=true; };
    track.addEventListener('pointerup',end); track.addEventListener('pointercancel',end);
    // start
    setX(); if(slides.length){ tick(); }
  });
}

/* ====== CARDS ======
index.json -> sections[].items[]:
{
  "name":"Algebra — Test-1",
  "description":"20 ta savol, 30 daqiqa",
  "image":"./img/algebra1.jpg",   // ixtiyoriy
  "type":"open" | "coming_soon" | "window",
  "startAt":"2025-10-30T10:00:00+05:00", "endAt":"2025-10-31T23:59:00+05:00",  // type=window
  "best": true,
  "tags":["Algebra","Demo"],
  "buttons":[
    { "kind":"link",  "label":"Boshlash", "href":"./test.html?id=algebra1" },
    { "kind":"modal", "label":"Ko‘rsatma", "html":"<div style='padding:16px'><h2>Ko‘rsatma</h2><p>...</p></div>" }
  ]
}
*/
function computeState(it, now){
  const t=it.type||'open', start=toMs(it.startAt), end=toMs(it.endAt);
  if(t==='open') return {status:'open'};
  if(t==='coming_soon') return {status:'soon'};
  if(t==='window'){
    if(!start||!end) return {status:'open'};
    if(now<start) return {status:'locked_until', left:start-now};
    if(now<=end)  return {status:'open', until:end-now};
    return {status:'closed'};
  }
  return {status:'open'};
}

function renderButtons(arr=[], slug){
  const wrap=document.createElement('div'); wrap.className='actions';
  arr.forEach((btn,idx)=>{
    const kind=(btn.kind||'link');
    const el=document.createElement(kind==='link'?'a':'button');
    el.className='btn-lite'; el.textContent=btn.label||'Action';
    if(kind==='link'){ el.href=btn.href||'#'; el.target=btn.target||''; }
    else{
      el.type='button';
      el.addEventListener('click', ()=> openHtmlModal(btn.label||'Ko‘rinish', String(btn.html||'')) );
    }
    wrap.appendChild(el);
  });
  return wrap;
}

function openHtmlModal(title, html){
  el.htmlTitle.textContent=title||'Ko‘rinish';
  // iframe srcdoc orqali sandbox
  el.htmlFrame.srcdoc = `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <style>body{font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial; padding:14px}</style></head><body>${html}</body></html>`;
  el.htmlModal.style.display='flex';
}
function closeHtmlModal(){ el.htmlModal.style.display='none'; el.htmlFrame.srcdoc=''; }
el.htmlClose.addEventListener('click', closeHtmlModal);
el.htmlModal.addEventListener('click', e=>{ if(e.target===el.htmlModal) closeHtmlModal(); });
el.htmlCopy.addEventListener('click', async()=>{
  const doc = el.htmlFrame?.contentDocument; const src = doc?.documentElement?.outerHTML || '';
  try{ await navigator.clipboard.writeText(src); el.htmlCopy.textContent='Nusxa olindi ✓'; setTimeout(()=>el.htmlCopy.textContent='HTML’ni nusxalash',1200); }catch{}
});

function makeCard(it){
  const card=document.createElement('article'); card.className='card grad-border glass';
  const slug=(it.name||'').toLowerCase().replace(/\W+/g,'-');

  // COVER
  const cover=document.createElement('div'); cover.className='cover';
  if(it.image){ cover.classList.add('has-img'); cover.innerHTML=`<img src="${escapeHtml(it.image)}" alt="${escapeHtml(it.name||'')}">`; }
  else{
    cover.innerHTML=`<div class="big-title">${escapeHtml(it.name||'')}</div>`;
  }

  // OVERLAY (Tez kunda / Qolgan vaqt)
  const veil=document.createElement('div'); veil.className='veil'; veil.style.display='none';
  const badge=document.createElement('div'); badge.className='badge'; const big=document.createElement('div'); big.className='big'; const timer=document.createElement('div'); timer.className='timer';
  veil.append(badge,big,timer); cover.appendChild(veil);

  // BODY
  const body=document.createElement('div'); body.className='body';
  body.innerHTML = `
    <h3 class="name">${escapeHtml(it.name||'')}</h3>
    ${it.description?`<p class="desc">${escapeHtml(it.description)}</p>`:''}
  `;
  const btns=renderButtons(it.buttons||[], slug);
  const meta=document.createElement('div'); meta.className='meta';
  meta.innerHTML=`${(it.tags||[]).map(t=>`<span class="chip sm">${escapeHtml(t)}</span>`).join('')}`;

  body.appendChild(btns); body.appendChild(meta);
  card.appendChild(cover); card.appendChild(body);

  // TICK status
  const refresh=()=>{
    const st=computeState(it, Date.now());
    if(st.status==='open'){
      veil.style.display='none';
      [...btns.querySelectorAll('a,button')].forEach(b=>{ b.removeAttribute('disabled'); });
    }else if(st.status==='soon'){
      veil.style.display='flex'; badge.textContent='⏳ Tez kunda'; big.textContent='Tez kunda';
      timer.textContent='';
      [...btns.querySelectorAll('a,button')].forEach(b=> b.setAttribute('disabled','1'));
    }else if(st.status==='locked_until'){
      veil.style.display='flex'; badge.textContent='🔒 Rejalashtirilgan'; big.textContent='Boshlanishiga:';
      timer.textContent = fmtTime(st.left);
      [...btns.querySelectorAll('a,button')].forEach(b=> b.setAttribute('disabled','1'));
    }else{ // closed
      veil.style.display='flex'; badge.textContent='⏱ Tugadi'; big.textContent='Tugadi';
      timer.textContent='';
      [...btns.querySelectorAll('a,button')].forEach(b=> b.setAttribute('disabled','1'));
    }
  };
  refresh(); if(it.type==='coming_soon' || it.type==='window') setInterval(refresh,1000);
  return card;
}

function renderSection(sec){
  const title=document.createElement('h3');
  title.style.margin='10px 6px'; title.style.fontSize='15px'; title.style.opacity='.8';
  title.innerHTML = escapeHtml(sec.title||'Bo‘lim') + (sec.tag ? ` — <span style="font-weight:600;opacity:.9">${escapeHtml(sec.tag)}</span>` : '');

  // sub-teglar (ixtiyoriy, mavjud bo‘lsa)
  const chips=document.createElement('div'); chips.className='chips'; const subWrap=document.createElement('section'); subWrap.className='filters grad-border glass';
  subWrap.innerHTML='<h4>Bu bo‘lim uchun kichik teglar:</h4>'; subWrap.appendChild(chips);
  const tags = [...new Set((sec.items||[]).flatMap(it=>it.tags||[]).map(String))].sort();
  if(tags.length===0) chips.innerHTML='<span class="chip sm" style="opacity:.7">Teglar yo‘q</span>';

  const grid=document.createElement('div'); grid.className='grid';
  (sec.items||[]).forEach(it=> grid.appendChild(makeCard(it)));

  const frag=document.createDocumentFragment();
  frag.appendChild(title); frag.appendChild(subWrap); frag.appendChild(grid);
  return frag;
}

function renderCards(data){
  el.sections.innerHTML='';
  const sections=(data.sections||[]);
  if(sections.length===0){ el.sections.innerHTML='<div class="desc" style="margin:10px 6px;opacity:.75">Bo‘limlar yo‘q.</div>'; return; }
  sections.forEach(sec=> el.sections.appendChild(renderSection(sec)));
}

/* TOP chips */
function renderMainChips(tags){
  const wrap=el.mainTags; wrap.innerHTML='';
  const mk=(label, on, cb)=>{ const b=document.createElement('button'); b.className='chip'; b.type='button'; b.textContent=label; b.setAttribute('aria-pressed', on?'true':'false'); b.onclick=()=>cb(b); wrap.appendChild(b); };
  mk('📰 Bannerlar', true, ()=>{ document.getElementById('bannerArea').scrollIntoView({behavior:'smooth'}); });
  mk('🏆 League', false, ()=>{ document.getElementById('board').scrollIntoView({behavior:'smooth'}); });
  tags.forEach(t=> mk(t,false, ()=>{ const h=[...document.querySelectorAll('#sections h3')].find(x=>x.textContent.includes(t)); if(h) h.scrollIntoView({behavior:'smooth'}); }));
}

/* ==== CONTENT LOAD ==== */
async function initContent(){
  try{
    const r=await fetch('./index.json',{cache:'no-store'});
    const data=await r.json();
    // Banner groups
    mountBannerGroups(data.bannerGroups||[]);
    // Main chips (sections tag’lari)
    const main = [...new Set((data.sections||[]).map(s=> String(s.tag||'Bo‘lim')))];
    renderMainChips(main);
    // Cards
    renderCards(data);
    window.__LM_DATA=data;
  }catch(e){ console.error(e); }
}

/* ====== LEADERBOARD (sening avvalgi kodi bilan mos) ====== */
const GROUPS = [
  {label:'💎 Diamond League',start:1,end:10,tier:'diamond',grad:['#9FE3FF','#39B6FF','#0077FF']},
  {label:'💚 Emerald League',start:11,end:20,tier:'emerald',grad:['#8FE3B0','#2E8B57','#1F6B45']},
  {label:'🥇 Gold League',start:21,end:30,tier:'gold',grad:['#FFE082','#FFC107','#FF8F00']},
  {label:'🥈 Silver League',start:31,end:40,tier:'silver',grad:['#DDE3EC','#BFC6D4','#9AA6B2']},
  {label:'🥉 Bronze League',start:41,end:50,tier:'bronze',grad:['#C69462','#9A6B3F','#7C4F2E']}
];
let CURRENT_DECILE=0, latestUsers=[];
function starSVG(fillPct,colors=['#9FE3FF','#39B6FF','#0077FF']){
  const [c1,c2,c3]=colors, gid='g'+Math.random().toString(36).slice(2,8), cid='c'+Math.random().toString(36).slice(2,8);
  const p='M12 2.3l2.9 5.9 6.5.9-4.7 4.5 1.1 6.4L12 17.8l-5.8 3.1 1.1-6.4L2.6 9.1l6.5-.9L12 2.3z';
  return `<svg viewBox="0 0 24 24"><defs><linearGradient id="${gid}" x1="0" x2="1"><stop offset="0%" stop-color="${c1}"/><stop offset="50%" stop-color="${c2}"/><stop offset="100%" stop-color="${c3}"/></linearGradient><clipPath id="${cid}"><rect x="0" y="0" width="${fillPct}%" height="100%"/></clipPath></defs><path d="${p}" fill="#d0dbd5"/><path d="${p}" fill="url(#${gid})" clip-path="url(#${cid})"/></svg>`;
}
function drawDecile(users,ix){
  const g=GROUPS[ix]; if(!g){ el.boardList.innerHTML='<div class="desc">Hali ma’lumot yo‘q</div>'; return; }
  const arr=users.slice(0,50), rows=[];
  for(let r=g.start;r<=g.end;r++){
    const u=arr[r-1]; if(!u) continue; const isTop3=r<=3;
    const left=isTop3?`<span class="medal ${r===1?'m1':r===2?'m2':'m3'}">${r===1?'🏆':r===2?'🥈':'🥉'}</span>`:`<span class="rnk">#${r}</span>`;
    rows.push(`<div class="rank grad-border glass tier-${g.tier}">
      <div>${left}</div>
      <div><b>${escapeHtml(u.name || 'Foydalanuvchi')}</b><div class="desc">${escapeHtml(u.class || '—')} · ${escapeHtml(u.school || '—')}</div></div>
      <div style="text-align:right"><b>⭐ ${fmtPoints(u.points)}</b></div>
    </div>`);
  }
  el.boardList.innerHTML=`<div class="group grad-border glass"><div class="groupHead tier-${g.tier}"><span class="tier-badge">${g.label}</span><span class="stars">${starSVG(100,g.grad)}</span></div><div class="groupBody">${rows.join('')}</div></div>`;
  el.decileInfo.textContent=g.label;
  el.decilePrev.disabled=(ix<=0); el.decileNext.disabled=(ix>=GROUPS.length-1);
}
el.decilePrev.onclick=()=>{ if(CURRENT_DECILE>0){ CURRENT_DECILE--; drawDecile(latestUsers,CURRENT_DECILE); } };
el.decileNext.onclick=()=>{ if(CURRENT_DECILE<GROUPS.length-1){ CURRENT_DECILE++; drawDecile(latestUsers,CURRENT_DECILE); } };

/* ====== AUTH + PROFILE (sening mavjud oqim) ====== */
const html=document.documentElement, gate=document.getElementById('authGate'), app=document.getElementById('app'), goLogin=document.getElementById('goLogin');
html.classList.add('auth-checking'); if(goLogin){ const ret=encodeURIComponent(location.pathname.replace(/\\/g,'/')+location.search); goLogin.href=`./login.html?return=${ret}`; }
function showApp(){ gate.style.display='none'; app.style.display='block'; html.classList.remove('auth-checking'); }
function lockToLogin(){ app.style.display='none'; gate.style.display='flex'; html.classList.remove('auth-checking'); }
let currentUserId=null, CURRENT_PROFILE=null;
function profileIsComplete(u){ const must=!!(u&&u.name&&/\s/.test(u.name)&&u.region&&u.district&&u.school&&u.phone&&u.role); if(!must) return false; return u.role==='teacher'||!!u.class; }
function fillChip(u){ const nv=document.getElementById('ucName'), idv=document.getElementById('ucNumeric'), rg=document.getElementById('ucRegion'), ds=document.getElementById('ucDistrict'), sc=document.getElementById('ucSchool'), cl=document.getElementById('ucClass'), ph=document.getElementById('ucPhone');
  nv.textContent=u?.name||'Foydalanuvchi'; idv.textContent='ID: '+(u?.numericId||'—'); rg.textContent=u?.region||'—'; ds.textContent=u?.district||'—'; sc.textContent=u?.school||'—'; cl.textContent=(u?.role==='teacher')?'— (o‘qituvchi)':(u?.class?`${u.class}-sinf`:'—'); ph.textContent=u?.phone||'—'; el.pointsVal.textContent=fmtPoints(u?.points??0);
}
async function ensureUser(user){
  const ref=doc(db,'users',user.uid);
  await runTransaction(db, async(tx)=>{
    const snap=await tx.get(ref);
    if(!snap.exists()){
      tx.set(ref,{name:user.displayName||(user.email?user.email.split('@')[0]:'Foydalanuvchi'), email:user.email||null, photoURL:user.photoURL||null, role:'student', numericId:Math.floor(1000+Math.random()*9000), points:0, region:null, district:null, school:null, class:null, phone:null, createdAt:Date.now()});
    }
  });
  const data=(await getDoc(ref)).data(); return data;
}
function resetChip(){ document.getElementById('ucAva').textContent='LM'; el.pointsVal.textContent='—'; document.getElementById('ucName').textContent='Mehmon'; document.getElementById('ucNumeric').textContent='ID: —'; ['ucRegion','ucDistrict','ucSchool','ucClass'].forEach(id=>document.getElementById(id).textContent='—'); }
watchAuth(async(user)=>{
  if(!user){ currentUserId=null; CURRENT_PROFILE=null; resetChip(); lockToLogin(); return; }
  currentUserId=user.uid;
  const u=await ensureUser(user); CURRENT_PROFILE=u; showApp(); fillChip(u);

  onSnapshot(query(collection(db,'users'), orderBy('points','desc'), limit(100)), (snap)=>{
    latestUsers = snap.docs.map(d=>({ id:d.id, uid:d.id, ...d.data() }))
      .sort((a,b)=> (Number(b.points)||0) - (Number(a.points)||0) || (a.numericId??0)-(b.numericId??0));
    drawDecile(latestUsers, CURRENT_DECILE);
  }, ()=>{ el.boardList.innerHTML='<div class="desc">Leaderboard hozircha yopiq</div>'; });
});

/* ====== BOOT ====== */
function securePage(){
  const isEditable = (el) => el && (el.isContentEditable || ['INPUT','TEXTAREA','SELECT'].includes(el.tagName));
  document.addEventListener('contextmenu', e => e.preventDefault(), {capture:true});
  document.addEventListener('keydown', e=>{
    if (isEditable(e.target)) return;
    const k=e.key.toUpperCase();
    const blocked = k==='F12' || (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(k)) || (e.ctrlKey && (k==='U'||k==='S'));
    if (blocked){ e.preventDefault(); e.stopPropagation(); }
  });
}
if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', ()=>{ initContent(); securePage(); }); }
else { initContent(); securePage(); }
</script>
</body>
</html>
