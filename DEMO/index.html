<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>LeaderMath.UZ — Home + Profil</title>

  <link rel="icon" href="./logo.png" sizes="any">
  <link rel="apple-touch-icon" href="./logo.png">
  <meta name="theme-color" content="#2E8B57"/>

  <style>
  :root{
    --brand:#2E8B57; --bg:#F6FAF7; --bg-2:#ECF4EF; --card:#FFFFFF; --text:#0f1b15;
    --muted:#5f7469; --line:#E3EBE6; --speed:.25s;
    --shadow:0 20px 60px rgba(18,40,28,.14);
    --shadow-sm:0 8px 26px rgba(18,40,28,.10);
    --vh: 1vh; /* mobile 100vh fix */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font:16px/1.55 system-ui,Segoe UI,Inter,Arial;
    background:
      radial-gradient(1200px 600px at 15% -10%, #d9f0e4 0, #0000 60%),
      radial-gradient(1400px 700px at 110% 10%, #e5f6ed 0, #0000 60%),
      linear-gradient(180deg,var(--bg),var(--bg-2));
  }

  /* Header + chipbar */
  .hdr{ position:sticky; top:0; z-index:90; backdrop-filter:saturate(1.1) blur(10px);
    background:linear-gradient(180deg, color-mix(in srgb, var(--card) 85%, transparent), transparent);
    border-bottom:1px solid color-mix(in srgb, var(--line) 60%, transparent);}
  .row{max-width:1180px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:14px}
  .brand{display:flex;align-items:center;gap:12px;font-weight:800}
  .brand img{width:52px;height:52px;border-radius:12px;display:block;box-shadow:0 6px 24px rgba(46,139,87,.25)}
  .brand b{color:var(--brand)} .grow{flex:1}

  .chipbar-wrap{ position:sticky; top:66px; z-index:80; backdrop-filter:saturate(1.05) blur(6px);
    background:linear-gradient(180deg, color-mix(in srgb, var(--card) 72%, transparent), transparent);
    border-bottom:1px solid color-mix(in srgb,var(--line) 60%, transparent);}
  .chipbar{ max-width:1180px; margin:0 auto; padding:8px 16px 12px; display:flex; gap:10px;
    overflow-x:auto; overflow-y:hidden; -webkit-overflow-scrolling:touch; scroll-behavior:smooth; }
  .chipbar::-webkit-scrollbar{display:none} .chipbar{scrollbar-width:none}
  .chip{ appearance:none; border:1px solid var(--line); background:var(--card); border-radius:999px;
    padding:10px 14px; cursor:pointer; box-shadow:var(--shadow-sm); font-weight:700; white-space:nowrap;
    transition:transform .2s, box-shadow .2s, background .2s, color .2s;}
  .chip:hover{transform:translateY(-1px); box-shadow:var(--shadow)}
  .chip.active{background:linear-gradient(180deg, color-mix(in srgb, var(--brand) 92%, #fff), var(--brand)); color:#fff; border-color:transparent}

  /* Fullscreen Banner Carousel (faqat slot:"fullscreen") */
  .banner-carousel-section {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 40; overflow: hidden; pointer-events: none;
  }
  .banner-carousel { position:absolute; inset:0; display:flex; transition: transform 0.6s ease; }
  .banner-slide { flex: 0 0 100%; height:100%; position: relative; }
  .banner-slide iframe{ width:100%; height:100%; border:0; display:block; }

  .banner-indicators{ position:absolute; bottom:20px; left:0; right:0; display:flex; justify-content:center; gap:10px; z-index:50; pointer-events:auto; }
  .banner-indicator{ width:10px; height:10px; border-radius:50%; background:rgba(255,255,255,.5); cursor:pointer; transition:background .3s }
  .banner-indicator.active{ background: var(--brand); }

  .banner-nav{ position:absolute; top:50%; transform:translateY(-50%); background:rgba(255,255,255,.85);
    border:none; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center;
    cursor:pointer; z-index:50; pointer-events:auto; transition: background .3s; }
  .banner-nav:hover{ background:#fff; }
  .banner-nav.prev{ left:20px } .banner-nav.next{ right:20px }

  /* Sections / banner */
  main{max-width:1180px;margin:0 auto;padding:14px 16px 56px}
  .section{ background:var(--card); border:1px solid var(--line); border-radius:22px;
    box-shadow:var(--shadow); overflow:hidden; margin-bottom:14px; transition:transform .2s }
  .section:hover{transform:translateY(-2px)}
  .section-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
  .section-hdr h3{margin:0;font-size:18px}
  .iframe-wrap{position:relative}
  iframe.sbx{display:block;width:100%;height:100%;border:0;background:transparent;overflow:hidden}

  /* Fullscreen (fullBleed) */
  .full-banner{ position:fixed; left:0; right:0; bottom:0; top:calc(var(--top-gap,120px)); border:none; border-radius:0; background:transparent; z-index:60 }
  .full-banner .iframe-wrap{ width:100%; height:100% }

  /* dynamic full height with safe area */
  .carousel-viewport{ width:100%; height:calc(var(--vh) * 100 - var(--top-gap, 0px)); position:relative; overflow:hidden; background:transparent; }

  /* Ratio box (non-full banners) */
  .ratio{position:relative;width:100%;overflow:hidden;border:1px solid var(--line);border-radius:16px;background:#fff}
  .ratio[data-r="16-9"]::before{content:"";display:block;padding-top:56.25%}
  .ratio>iframe{position:absolute;inset:0;width:100%;height:100%;border:0}

  /* Cards grid + badges */
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  @media (max-width:960px){.grid{grid-template-columns:1fr 1fr}}
  @media (max-width:640px){.grid{grid-template-columns:1fr}}
  .cardX{border:1px solid var(--line);background:var(--card);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:10px;box-shadow:var(--shadow-sm)}
  .cardX h4{margin:0;font-size:16px}
  .rowflex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badge{padding:4px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#f0f7f3}
  .badge.soon{background:#fff8e5;border-color:#f2d48a}
  .badge.active{background:#eaf6ef;border-color:#84d1a8}
  .badge.ended{background:#f5f5f5}

  /* Filter chips */
  .inline-filters{display:flex;gap:8px;flex-wrap:wrap;padding:12px}
  .fchip{appearance:none;border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:700}
  .fchip.active{background:var(--brand);color:#fff;border-color:transparent}

  /* User chip + menu */
  .userchip{border:1px solid var(--line);background:var(--card);padding:6px 10px;border-radius:999px;box-shadow:var(--shadow-sm);display:flex;align-items:center;gap:10px;cursor:pointer}
  .avatar{width:32px;height:32px;border-radius:50%;overflow:hidden;background:linear-gradient(135deg,#dcefe5,#f1faf5)}
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}

  .menu{ position:fixed; min-width:280px; background:var(--card); border:1px solid var(--line); border-radius:16px;
    box-shadow:0 16px 50px rgba(16,32,24,.18), 0 2px 10px rgba(16,32,24,.06); display:none; overflow:hidden; z-index:9999 }
  .menu.open{display:block}
  .menu a{ display:flex;align-items:center;gap:10px;padding:12px 14px;text-decoration:none;color:inherit;
    border-bottom:1px solid color-mix(in srgb,var(--line) 80%, transparent);
    transition: transform .18s ease, background .18s ease, box-shadow .18s ease; will-change: transform; }
  .menu a:last-child{border-bottom:none}
  .menu a:hover{ background:color-mix(in srgb, var(--brand) 12%, transparent); transform:translateX(3px);
    box-shadow:inset 0 0 0 1px color-mix(in srgb, var(--brand) 40%, transparent); }
  .menu .label{padding:8px 14px;font-size:12px;color:var(--muted);border-bottom:1px solid var(--line);background:color-mix(in srgb,var(--card) 60%, transparent)}

  /* Overlay / modals */
  .overlay{ position:fixed; inset:0; display:none; place-items:center; z-index:110;
    background:color-mix(in srgb, #000 18%, transparent); backdrop-filter:saturate(1.1) blur(8px); opacity:0; transition:opacity .2s ease; }
  .overlay.show{ display:grid; opacity:1; }
  .profile-card, .modal-card{ width:min(880px,96vw); background:linear-gradient(180deg, color-mix(in srgb, var(--card) 92%, #fff), var(--card));
    border:1px solid color-mix(in srgb, var(--line) 80%, transparent); border-radius:22px; box-shadow:var(--shadow); padding:22px; animation:pop .18s ease; }
  @keyframes pop{ from{ transform:scale(.98); opacity:.6 } to{ transform:scale(1); opacity:1 } }
  .btn{appearance:none;border:1px solid var(--line);background:var(--card);padding:12px 16px;border-radius:14px;cursor:pointer;font-weight:800}
  .btn.primary{background:linear-gradient(180deg, #7fd1a5, var(--brand));color:#fff;border-color:transparent}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .fld{display:grid;gap:8px;margin:10px 0}
  .fld input,.fld select{width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--line);background:linear-gradient(180deg,var(--card),color-mix(in srgb,var(--card) 92%,#000))}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .muted{color:var(--muted)} .divider{height:1px;background:var(--line);margin:12px 0}
  @media (max-width:900px){.grid2{grid-template-columns:1fr}}

  .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:14px}
  .dropzone{ border:2px dashed color-mix(in srgb, var(--line) 70%, transparent); border-radius:16px; padding:16px; display:grid; gap:12px; place-items:center;
    background:linear-gradient(180deg, color-mix(in srgb, var(--card) 70%, transparent), transparent); transition:border-color .2s, background .2s; }
  .dropzone.drag{ border-color: color-mix(in srgb, var(--brand) 70%, var(--line)); background:color-mix(in srgb, var(--brand) 6%, transparent); }
  .preview{ width:min(320px, 80vw); height:min(320px, 60vh); border-radius:14px; overflow:hidden; border:1px solid var(--line);
    background:repeating-conic-gradient(#f5f7f6 0% 25%, #eaf1ec 0% 50%) 50% / 16px 16px; display:grid; place-items:center; }
  .preview img{max-width:100%; max-height:100%; display:block}
  .hint{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <header class="hdr" id="hdr">
    <div class="row">
      <div class="brand">
        <img src="./logo.png" alt="LM"/>
        <div style="display:grid;line-height:1.1">
          <span style="font-size:18px;font-weight:800">LeaderMath.<b style="color:var(--brand)">UZ</b></span>
          <small style="color:var(--muted)">Matematika platformasi</small>
        </div>
      </div>
      <div class="grow"></div>
      <div id="user-slot"></div>
    </div>

    <div class="chipbar-wrap" id="chipwrap">
      <nav id="chipbar" class="chipbar" aria-label="Bo'limlar"></nav>
    </div>
  </header>

  <!-- Faqat slot:"fullscreen" bannerlar karuseli -->
  <div class="banner-carousel-section" id="bannerCarouselSection">
    <div class="banner-carousel" id="bannerCarousel"></div>
    <button class="banner-nav prev" id="bannerPrev">‹</button>
    <button class="banner-nav next" id="bannerNext">›</button>
    <div class="banner-indicators" id="bannerIndicators"></div>
  </div>

  <main id="app"><div id="sections"></div></main>

  <div id="overlay" class="overlay" aria-modal="true"></div>
  <div id="portal-root"></div>

  <!-- App JS -->
<script type="module">
/* Firebase */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, setPersistence, browserLocalPersistence, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { getStorage, ref as sRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  authDomain: "xplusy-760fa.firebaseapp.com",
  projectId: "xplusy-760fa",
  storageBucket: "xplusy-760fa.appspot.com",
  messagingSenderId: "992512966017",
  appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
  measurementId: "G-459PLJ7P7L"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const st   = getStorage(app);
try { await setPersistence(auth, browserLocalPersistence); } catch {}

const q=(s,r=document)=>r.querySelector(s);
const qa=(s,r=document)=>[...r.querySelectorAll(s)];
let REGIONS=[], CURRENT_USER=null, PROFILE=null, USER_POINTS=0;

function setVH(){ const vh=innerHeight*0.01; document.documentElement.style.setProperty('--vh', `${vh}px`); }
setVH(); addEventListener('resize', setVH);

function parseLocal(s){
  if(!s)return null;
  const m=s.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/);
  if(!m)return null;
  const [,Y,M,D,h,mn]=m;
  return new Date(+Y,+M-1,+D,+h,+mn,0,0);
}
function activeByTime(b){
  const now=new Date();
  const s=parseLocal(b.startAt), e=parseLocal(b.endAt);
  if(s&&now<s)return false;
  if(e&&now>e)return false;
  return true;
}

/* ===== HOME SECTIONS ===== */
async function fetchHome(){
  try{const s=await getDoc(doc(db,'configs','home'));if(s.exists()){const d=s.data();if(Array.isArray(d.sections))return d;}}catch{}
  return {sections:[]};
}

const HSTATE={sections:[],activeId:null};
const ORDER={active:0,soon:1,available:2,ended:3};

function parseLocalCard(s){return parseLocal(s);}
function fmtDate(d){return!d?'-':`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;}
function cardState(it){
  if(it.cardStyle==='soon')return'soon';
  if(it.cardStyle==='timed'){
    const now=new Date(),s=parseLocalCard(it.startAt),e=parseLocalCard(it.endAt);
    if(s&&now<s)return'soon';
    if(s&&e&&now>=s&&now<=e)return'active';
    if(e&&now>e)return'ended';
    return'active';
  }
  return'available';
}

function bannerFrameFromObj(b, baseHref=null){
  const f=document.createElement('iframe');f.className='sbx';
  f.setAttribute('sandbox',b.sandbox||'allow-scripts allow-forms');
  f.setAttribute('scrolling','no');
  const base=b.baseHref||baseHref||'';
  const html=`<!doctype html><html><head>${base?`<base href="${base}">`:""}<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><style>html,body{height:100%;margin:0;overflow:hidden;background:transparent}</style></head><body>${String(b.contentHtml||'')}</body></html>`;
  if(b.mode==='url')f.src=b.src||'';else f.srcdoc=html;
  f.style.width='100%';f.style.height='auto';f.style.minHeight='250px';f.style.border='0';f.style.display='block';
  return f;
}

function renderCarousel(banners,fullBleed=false,baseHref=null,intervalMs=4500){
  const vp=document.createElement('div');
  vp.className='carousel-viewport';
  vp.style.position='relative';
  vp.style.height='auto';
  vp.style.overflow='hidden';
  const slideWrap=document.createElement('div');
  slideWrap.style.cssText='display:flex;transition:transform .6s ease;width:100%';
  vp.appendChild(slideWrap);
  banners.forEach(b=>{
    const holder=document.createElement('div');
    holder.style.cssText='flex:0 0 100%;position:relative';
    const fr=bannerFrameFromObj(b,baseHref);
    holder.appendChild(fr);
    slideWrap.appendChild(holder);
  });
  let i=0,timer=null;
  const go=n=>{i=(n+banners.length)%banners.length;slideWrap.style.transform=`translateX(-${i*100}%)`;};
  const play=()=>{stop();if(banners.length>1)timer=setInterval(()=>go(i+1),intervalMs);};
  const stop=()=>{if(timer){clearInterval(timer);timer=null;}};
  vp.addEventListener('mouseenter',stop);
  vp.addEventListener('mouseleave',play);
  if(banners.length>1)play();
  return vp;
}
function renderBanner(b,fullBleed=false,baseHref=null){
  const r=document.createElement('div');
  r.className='ratio';
  r.dataset.r='16-9';
  r.appendChild(bannerFrameFromObj(b,baseHref));
  return r;
}

function renderCard(it){
  const c=document.createElement('div');c.className='cardX';c.dataset.kind='card';
  const title=it.title||'Card';const st=cardState(it);c.dataset.state=st;
  const row=document.createElement('div');row.className='rowflex';
  const h=document.createElement('h4');h.textContent=title;row.appendChild(h);
  const bd=document.createElement('span');bd.className='badge '+(st==='soon'?'soon':st==='active'?'active':st==='ended'?'ended':'');bd.textContent=(st==='soon'?'Yaqinda':st==='active'?'Faol':st==='ended'?'Tugagan':'Mavjud');row.appendChild(bd);c.appendChild(row);
  if(it.cardStyle==='timed'){const s=parseLocalCard(it.startAt),e=parseLocalCard(it.endAt);const t=document.createElement('div');t.className='muted';t.textContent=`Vaqt: ${fmtDate(s)} — ${fmtDate(e)}`;c.appendChild(t);}
  const actions=document.createElement('div');actions.className='rowflex';
  const a=document.createElement('a');a.className='btn primary';a.textContent=it.ctaLabel||'Boshlash';
  if(st==='active'&&it.ctaHref){a.href=it.ctaHref;a.target='_blank';}else{a.classList.remove('primary');a.setAttribute('disabled','');}
  actions.appendChild(a);c.appendChild(actions);
  return c;
}

function buildFilters(){
  const wrap=document.createElement('div');
  wrap.className='inline-filters';
  const options=[{key:'all',label:'Barchasi'},{key:'active',label:'Faol'},{key:'soon',label:'Yaqinda'},{key:'available',label:'Mavjud'},{key:'ended',label:'Tugagan'}];
  const chips=options.map(o=>{
    const b=document.createElement('button');
    b.className='fchip'+(o.key==='all'?' active':'');
    b.dataset.f=o.key;
    b.textContent=o.label;
    b.onclick=()=>{chips.forEach(x=>x.classList.toggle('active',x===b));f.onChange&&f.onChange(o.key);};
    wrap.appendChild(b);
    return b;
  });
  const f={wrap,onChange:null};
  return f;
}

function applyFilter(grid,key){
  qa('.cardX',grid).forEach(card=>{
    const st=card.dataset.state||'available';
    const show=(key==='all')||(st===key);
    card.style.display=show?'flex':'none';
  });
}

function sortCards(cards){
  return [...cards].sort((a,b)=>{
    const sa=cardState(a),sb=cardState(b);
    const oa=(ORDER[sa]??9),ob=(ORDER[sb]??9);
    if(oa!==ob)return oa-ob;
    const as=parseLocalCard(a.startAt)?.getTime()||0;
    const bs=parseLocalCard(b.startAt)?.getTime()||0;
    return as-bs;
  });
}

function renderSection(sec){
  const id=sec.id||('sec'+Math.random());
  const outer=document.createElement('section');
  outer.dataset.section=id;
  outer.className='section';
  const sh=document.createElement('div');
  sh.className='section-hdr';
  sh.innerHTML=`<h3>${sec.title||id}</h3>`;
  outer.appendChild(sh);
  const body=document.createElement('div');
  body.className='iframe-wrap';
  const inner=document.createElement('div');
  inner.style.padding='12px';
  const subs=Array.isArray(sec.subsections)?sec.subsections:[];
  subs.forEach((sub,idx)=>{
    const subWrap=document.createElement('div');
    subWrap.className='section';
    subWrap.style.margin='16px 0';
    const subHead=document.createElement('div');
    subHead.className='section-hdr';
    subHead.innerHTML=`<h4>${sub.title||('Sub '+(idx+1))}</h4>`;
    subWrap.appendChild(subHead);
    const subBody=document.createElement('div');
    subBody.className='iframe-wrap';
    const subInner=document.createElement('div');
    subInner.style.padding='10px';
    const banners=Array.isArray(sub.banners)?sub.banners.filter(b=>b.slot!=='fullscreen'):[];
    const cards=Array.isArray(sub.cards)?sub.cards:[];
    if(banners.length>1)subInner.appendChild(renderCarousel(banners,false,sub.baseHref));
    else if(banners.length===1)subInner.appendChild(renderBanner(banners[0],false,sub.baseHref));
    if(cards.length){
      const filters=buildFilters();
      subInner.appendChild(filters.wrap);
      const grid=document.createElement('div');
      grid.className='grid';
      cards.forEach(c=>grid.appendChild(renderCard(c)));
      subInner.appendChild(grid);
      filters.onChange=k=>applyFilter(grid,k);
    }
    subBody.appendChild(subInner);
    subWrap.appendChild(subBody);
    inner.appendChild(subWrap);
  });
  if(!subs.length){
    const banners=Array.isArray(sec.banners)?sec.banners.filter(b=>b.slot!=='fullscreen'):[];
    const cards=Array.isArray(sec.cards)?sec.cards:[];
    if(banners.length>1)inner.appendChild(renderCarousel(banners,false,sec.baseHref));
    else if(banners.length===1)inner.appendChild(renderBanner(banners[0],false,sec.baseHref));
    if(cards.length){
      const filters=buildFilters();
      inner.appendChild(filters.wrap);
      const grid=document.createElement('div');
      grid.className='grid';
      cards.forEach(c=>grid.appendChild(renderCard(c)));
      inner.appendChild(grid);
      filters.onChange=k=>applyFilter(grid,k);
    }
  }
  body.appendChild(inner);
  outer.appendChild(body);
  return outer;
}

function renderChips(){
  const bar=q('#chipbar');bar.innerHTML='';
  HSTATE.sections.forEach((s,i)=>{
    const b=document.createElement('button');
    b.className='chip'+(i===0?' active':'');
    b.textContent=s.title||s.id||('Bo\'lim '+(i+1));
    b.dataset.target=s.id||('sec'+i);
    b.onclick=()=>{activate(b.dataset.target);b.scrollIntoView({behavior:'smooth',inline:'center'});};
    bar.appendChild(b);
  });
}

function renderSections(){
  const host=q('#sections');
  host.innerHTML='';
  HSTATE.sections.forEach(s=>host.appendChild(renderSection(s)));
}

function activate(id){
  HSTATE.activeId=id;
  document.querySelectorAll('.chip').forEach(c=>c.classList.toggle('active',c.dataset.target===id));
  qa('[data-section]').forEach(s=>s.style.display=(s.dataset.section===id)?'block':'none');
}

async function loadHome(){
  const data=await fetchHome();
  HSTATE.sections=(Array.isArray(data.sections)?data.sections:[]).map((s,i)=>({id:s.id||`sec${i+1}`,...s}));
  renderChips();
  renderSections();
  if(HSTATE.sections.length)activate(HSTATE.sections[0].id);
}

/* USER / AUTH qisqa */
onAuthStateChanged(auth, async (u)=>{
  CURRENT_USER=u||null;
  if(!u){ q('#user-slot').innerHTML='<button class="btn">Kirish</button>'; return; }
  [PROFILE,USER_POINTS]=await Promise.all([getDoc(doc(db,'profiles',u.uid)).then(s=>s.data()||{}),0]);
  q('#user-slot').innerHTML=`<div class="userchip"><div class="avatar">${u.photoURL?`<img src="${u.photoURL}">`:''}</div><b>${u.displayName||'Foydalanuvchi'}</b></div>`;
});

await loadHome();
</script>
</body>
</html>
