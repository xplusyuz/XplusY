<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LeaderMath — Micro-CMS (JSON → HTML chips)</title>
  <style>
    :root{
      --brand:#2E8B57; --bg:#f6faf8; --text:#0f172a; --muted:#5b7a6a;
      --card:#fff; --frame:#d8e7dd; --radius:16px; --ring:#8ad1b1;
    }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,Segoe UI,Roboto}
    header{position:sticky;top:0;background:rgba(255,255,255,.6);backdrop-filter:saturate(1.5) blur(10px);
      border-bottom:1px solid var(--frame); padding:10px 16px; display:flex; gap:10px; align-items:center}
    .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,#2E8B57,#1F6B45); color:#fff;
      display:grid;place-items:center;font-weight:900}
    h1{font-size:16px;margin:0} .muted{color:var(--muted)}
    main{max-width:1200px;margin:16px auto;padding:0 16px;display:grid;grid-template-columns:280px 1fr;gap:16px}
    .panel{background:var(--card);border:1px solid var(--frame);border-radius:var(--radius);box-shadow:0 6px 20px rgba(0,0,0,.05)}
    .chips{padding:12px}
    .search{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--frame);outline:0}
    .chip{width:100%; text-align:left; margin:8px 0; padding:10px 12px; border-radius:12px; border:1px solid var(--frame);
      background:#fafdfb; cursor:pointer; transition:.15s}
    .chip:hover{transform:translateY(-1px); box-shadow:0 6px 14px rgba(0,0,0,.08)}
    .chip.active{outline:2px solid var(--ring); background:#f2fbf7}
    .viewer-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--frame)}
    .viewer{height:72vh;border:0;width:100%;border-radius:0 0 var(--radius) var(--radius)}
    .badgelite{font-size:12px;padding:4px 8px;border-radius:999px;background:#eff9f4;border:1px solid var(--frame)}
    @media (max-width:900px){ main{grid-template-columns:1fr} .viewer{height:66vh} }
  </style>
</head>
<body>
  <header>
    <div class="logo">L</div>
    <div>
      <h1>LeaderMath Micro-CMS</h1>
      <div class="muted">JSON ichidagi HTML bo‘laklari bilan modul platforma</div>
    </div>
  </header>

  <main>
    <!-- CHIPS PANEL -->
    <aside class="panel">
      <div class="chips">
        <input id="q" class="search" placeholder="Chip qidirish..." autocomplete="off"/>
        <div id="chipList" style="margin-top:10px"></div>
      </div>
    </aside>

    <!-- VIEWER -->
    <section class="panel">
      <div class="viewer-head">
        <div>
          <strong id="title">Chip tanlang</strong>
          <span id="meta" class="badgelite" hidden></span>
        </div>
        <div class="muted" id="hint">Bosilganda kontent ochiladi</div>
      </div>
      <iframe id="viewer" class="viewer"
        sandbox="allow-scripts"
        referrerpolicy="no-referrer"></iframe>
    </section>
  </main>

  <script type="module">
    // ===== Helpers
    const $ = (s, r=document) => r.querySelector(s);
    const esc = (s='') => String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    const setQS = (id) => history.replaceState(null,'',`?id=${encodeURIComponent(id)}`);
    const getQS = () => new URLSearchParams(location.search).get('id');

    // ===== Load admin.json
    const admin = await fetch('./admin.json',{cache:'no-store'}).then(r=>r.json()).catch(()=>({chips:[]}));
    const chips = Array.isArray(admin.chips) ? admin.chips : [];

    // ===== Render chip list
    const chipList = $('#chipList');
    function drawList(filter=''){
      const f = filter.trim().toLowerCase();
      chipList.innerHTML = chips
        .filter(c => !f || (c.title||'').toLowerCase().includes(f) || (c.tags||[]).join(' ').toLowerCase().includes(f))
        .map(c=>`<button class="chip" data-id="${esc(c.id)}">${esc(c.title||c.id)}${c.tags?.length?`<div class="muted" style="font-size:12px">${c.tags.join(' · ')}</div>`:''}</button>`)
        .join('') || `<div class="muted">Hech narsa topilmadi</div>`;
      chipList.querySelectorAll('.chip').forEach(b=>b.onclick=()=>openChip(b.dataset.id));
      highlightActive();
    }
    $('#q').addEventListener('input', e => drawList(e.target.value));

    // ===== Open chip (safe sandboxed iframe via srcdoc)
    const viewer = $('#viewer'), titleEl = $('#title'), meta = $('#meta'), hint = $('#hint');
    function openChip(id){
      const c = chips.find(x=>x.id===id); if(!c){return}
      titleEl.textContent = c.title || c.id;
      meta.hidden = !c.tags?.length; if(!meta.hidden) meta.textContent = c.tags.join(' · ');
      const html = `
<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{margin:0;font:15px/1.5 system-ui,Segoe UI,Roboto; color:#0f172a; background:#fff}
  .wrap{padding:16px 14px}
  .note{font-size:12px;color:#6b7280;margin:8px 0 14px}
  .wrap > *{max-width:900px}
</style>
</head><body>
  <div class="wrap">
    <div class="note">Isolated sandbox — bu bo‘lak boshqa modullarni buzmaydi.</div>
    ${c.html||''}
  </div>
</body></html>`;
      viewer.srcdoc = html; // kapsulaga yuklash
      localStorage.setItem('lm:lastChip', id);
      setQS(id);
      highlightActive();
      hint.textContent = c.desc ? c.desc : 'Sandbox ichida ishga tushdi';
    }

    function highlightActive(){
      const id = getQS() || localStorage.getItem('lm:lastChip');
      chipList.querySelectorAll('.chip').forEach(b=>b.classList.toggle('active', b.dataset.id===id));
    }

    // ===== Init
    drawList();
    const initial = getQS() || localStorage.getItem('lm:lastChip') || chips[0]?.id;
    if (initial) openChip(initial);
  </script>
</body>
</html>
