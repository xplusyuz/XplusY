<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>LeaderMath.UZ — Home + Profil</title>

  <link rel="icon" href="./logo.png" sizes="any">
  <link rel="apple-touch-icon" href="./logo.png">
  <meta name="theme-color" content="#2E8B57"/>

  <style>
  :root{
    --brand:#2E8B57; --bg:#F6FAF7; --bg-2:#ECF4EF; --card:#FFFFFF; --text:#0f1b15;
    --muted:#5f7469; --line:#E3EBE6; --speed:.25s;
    --shadow:0 20px 60px rgba(18,40,28,.14);
    --shadow-sm:0 8px 26px rgba(18,40,28,.10);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font:16px/1.55 system-ui,Segoe UI,Inter,Arial;
    background:
      radial-gradient(1200px 600px at 15% -10%, #d9f0e4 0, #0000 60%),
      radial-gradient(1400px 700px at 110% 10%, #e5f6ed 0, #0000 60%),
      linear-gradient(180deg,var(--bg),var(--bg-2));
  }

  /* Header + chipbar */
  .hdr{ position:sticky; top:0; z-index:90; backdrop-filter:saturate(1.1) blur(10px);
    background:linear-gradient(180deg, color-mix(in srgb, var(--card) 85%, transparent), transparent);
    border-bottom:1px solid color-mix(in srgb, var(--line) 60%, transparent);}
  .row{max-width:1180px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:14px}
  .brand{display:flex;align-items:center;gap:12px;font-weight:800}
  .brand img{width:52px;height:52px;border-radius:12px;display:block;box-shadow:0 6px 24px rgba(46,139,87,.25)}
  .brand b{color:var(--brand)} .grow{flex:1}

  .chipbar-wrap{ position:sticky; top:66px; z-index:80; backdrop-filter:saturate(1.05) blur(6px);
    background:linear-gradient(180deg, color-mix(in srgb, var(--card) 72%, transparent), transparent);
    border-bottom:1px solid color-mix(in srgb,var(--line) 60%, transparent);}
  .chipbar{ max-width:1180px; margin:0 auto; padding:8px 16px 12px; display:flex; gap:10px;
    overflow-x:auto; overflow-y:hidden; -webkit-overflow-scrolling:touch; scroll-behavior:smooth; }
  .chipbar::-webkit-scrollbar{display:none} .chipbar{scrollbar-width:none}
  .chip{ appearance:none; border:1px solid var(--line); background:var(--card); border-radius:999px;
    padding:10px 14px; cursor:pointer; box-shadow:var(--shadow-sm); font-weight:700; white-space:nowrap;
    transition:transform .2s, box-shadow .2s, background .2s, color .2s;}
  .chip:hover{transform:translateY(-1px); box-shadow:var(--shadow)}
  .chip.active{background:linear-gradient(180deg, color-mix(in srgb, var(--brand) 92%, #fff), var(--brand)); color:#fff; border-color:transparent}

  /* Sections */
  main{max-width:1180px;margin:0 auto;padding:14px 16px 56px}
  .section{ background:var(--card); border:1px solid var(--line); border-radius:22px;
    box-shadow:var(--shadow); overflow:hidden; margin-bottom:14px; transition:transform .2s }
  .section:hover{transform:translateY(-2px)}
  .section-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
  .section-hdr h3{margin:0;font-size:18px}
  .iframe-wrap{position:relative}
  iframe.sbx{display:block;width:100%;border:0;background:transparent}

  /* FULL-BLEED banner (scrollsiz 100vh) */
  .full-bleed{position:relative;width:100%;height:calc(100vh - var(--top-gap,0px));overflow:hidden}
  .full-bleed iframe{position:absolute;inset:0;width:100%;height:100%;border:0;overflow:hidden}
  /* 16:9 banner kontent */
  .ratio{position:relative;width:100%;overflow:hidden;border-radius:16px;border:1px solid var(--line);background:#fff}
  .ratio[data-r="16-9"]::before{content:"";display:block;padding-top:56.25%}
  .ratio>iframe{position:absolute;inset:0;width:100%;height:100%;border:0}

  /* Carousel */
  .carousel{position:relative;overflow:hidden;background:transparent}
  .slides{display:flex;transition:transform .5s ease}
  .slide{min-width:100%}
  .car-ctrl{position:absolute;top:50%;transform:translateY(-50%);z-index:5;background:rgba(255,255,255,.9);
    border:1px solid var(--line);border-radius:999px;padding:8px;cursor:pointer}
  .car-prev{left:10px} .car-next{right:10px}
  .dots{position:absolute;left:0;right:0;bottom:10px;display:flex;gap:8px;justify-content:center;z-index:6}
  .dot{width:10px;height:10px;border-radius:50%;background:#cfe3d8;border:1px solid var(--line);cursor:pointer}
  .dot.active{background:#2E8B57}

  /* Cards grid + badges */
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
  @media (min-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (min-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media (min-width:1180px){.grid{grid-template-columns:repeat(4,1fr)}}

  .cardX{border:1px solid var(--line);background:var(--card);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:10px;box-shadow:var(--shadow-sm)}
  .cardX h4{margin:0;font-size:16px}
  .rowflex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .badge{padding:4px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#f0f7f3}
  .badge.soon{background:#fff8e5;border-color:#f2d48a}
  .badge.active{background:#eaf6ef;border-color:#84d1a8}
  .badge.ended{background:#f5f5f5}

  /* Filter chips */
  .inline-filters{display:flex;gap:8px;flex-wrap:wrap;padding:12px}
  .fchip{appearance:none;border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:700}
  .fchip.active{background:var(--brand);color:#fff;border-color:transparent}

  /* Overlay / modallar (profil/avatarmodal/infomodal) */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.18);display:none;place-items:center;z-index:110;opacity:0;transition:opacity .2s}
  .overlay.show{display:grid;opacity:1}
  .profile-card{width:min(880px,96vw);background:var(--card);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);padding:22px}
  .btn{appearance:none;border:1px solid var(--line);background:var(--card);padding:12px 16px;border-radius:14px;cursor:pointer;font-weight:800}
  .btn.primary{background:linear-gradient(180deg,#7fd1a5,var(--brand));color:#fff;border-color:transparent}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .muted{color:var(--muted)}
  .avatar{width:32px;height:32px;border-radius:50%;overflow:hidden;background:linear-gradient(135deg,#dcefe5,#f1faf5)}
  .menu{display:none}
  </style>
</head>
<body>
  <header class="hdr" id="hdr">
    <div class="row">
      <div class="brand">
        <img src="./logo.png" alt="LM"/>
        <div style="display:grid;line-height:1.1">
          <span style="font-size:18px;font-weight:800">LeaderMath.<b style="color:var(--brand)">UZ</b></span>
          <small style="color:var(--muted)">Matematika platformasi</small>
        </div>
      </div>
      <div class="grow"></div>
      <div id="user-slot"></div>
    </div>

    <div class="chipbar-wrap" id="chipwrap">
      <nav id="chipbar" class="chipbar" aria-label="Bo‘limlar"></nav>
    </div>
  </header>

  <main id="app"><div id="sections"></div></main>

  <div id="overlay" class="overlay" aria-modal="true"></div>
  <div id="portal-root"></div>

  <script type="module">
  /* Firebase (profil/avatar uchun) */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, setPersistence, browserLocalPersistence, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getStorage, ref as sRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
    authDomain: "xplusy-760fa.firebaseapp.com",
    projectId: "xplusy-760fa",
    storageBucket: "xplusy-760fa.appspot.com",
    messagingSenderId: "992512966017",
    appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
    measurementId: "G-459PLJ7P7L"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const st   = getStorage(app);
  try { await setPersistence(auth, browserLocalPersistence); } catch {}

  /* Helpers */
  const q=(s,r=document)=>r.querySelector(s); const qa=(s,r=document)=>[...r.querySelectorAll(s)];
  const ALWAYS_REQ=['firstName','lastName','birthDate','region','district','role'];
  let REGIONS=[]; let CURRENT_USER=null; let PROFILE=null; let USER_POINTS=0;

  const calcAge=iso=>{try{const b=new Date(iso),t=new Date();let a=t.getFullYear()-b.getFullYear();const m=t.getMonth()-b.getMonth();if(m<0||(m===0&&t.getDate()<b.getDate()))a--;return a;}catch{return '';}};
  async function getProfile(uid){const s=await getDoc(doc(db,'profiles',uid));return s.exists()?s.data():null;}
  async function saveProfile(uid,data){data.updatedAt=serverTimestamp();if(!PROFILE)data.createdAt=serverTimestamp();await setDoc(doc(db,'profiles',uid),data,{merge:false});PROFILE=data;}
  async function getUserPoints(uid){try{const s=await getDoc(doc(db,'users',uid));return s.exists()?(s.data().points||0):0;}catch{return 0;}}

  async function loadRegions(){
    try{const r=await fetch('./region.json',{cache:'no-store'});if(!r.ok)throw 0;const j=await r.json();return j?.regions||[];}
    catch{return[{name:"Toshkent",districts:[{name:"Chilonzor",schools:["1-maktab","12-maktab"]},{name:"Olmazor",schools:["5-maktab","14-maktab"]}]},{name:"Samarqand",districts:[{name:"Urgut",schools:["3-maktab","28-maktab"]}]}];}
  }

  /* User chip + menu (portal) */
  function renderUserChip(u, profile){
    const slot=q('#user-slot');
    const age=profile?.birthDate?calcAge(profile.birthDate):'';
    const name=profile?.firstName?(profile.firstName+(profile.lastName?' '+profile.lastName:'')):(u.displayName||u.email||'Foydalanuvchi');
    const avatar=profile?.avatarUrl||u.photoURL||'';
    const role=profile?.role||'—';
    slot.innerHTML=`
      <div class="userchip" id="userchip" aria-haspopup="menu" aria-expanded="false">
        <div class="avatar">${avatar?`<img src="${avatar}" alt="">`:''}</div>
        <div style="display:grid;line-height:1"><b style="font-size:14px">${name}</b><small class="mini">${role} • ${age?age+' yosh • ':''}${USER_POINTS} points</small></div>
        <div class="menu" id="usermenu" role="menu">
          <a href="#" id="mProfile" role="menuitem">Profil</a>
          <a href="#" id="mEdit" role="menuitem">Profilni tahrirlash</a>
          <a href="#" id="mLogout" role="menuitem">Chiqish</a>
        </div>
      </div>`;
  }
  function openUserMenu(){
    const chip = q('#userchip'); const menu=q('#usermenu'); if(!chip||!menu) return;
    (q('#portal-root')||document.body).appendChild(menu);
    menu.style.visibility='hidden'; menu.style.display='block';
    const r = chip.getBoundingClientRect(); const mw=menu.offsetWidth, mh=menu.offsetHeight, gap=8;
    let left = Math.min(Math.max(r.right - mw, 8), innerWidth - mw - 8);
    let top  = r.bottom + gap; if (top + mh > innerHeight - 8) top = Math.max(8, r.top - gap - mh);
    menu.style.left = left+'px'; menu.style.top = Math.max(8, top)+'px';
    menu.classList.add('open'); menu.style.visibility='visible'; chip.setAttribute('aria-expanded','true');
    const closeOnOutside = (e)=>{ if(!menu.contains(e.target) && !chip.contains(e.target)) closeUserMenu(); };
    const onSR = ()=> position();
    function position(){
      if(!menu.classList.contains('open')) return;
      const r2 = chip.getBoundingClientRect();
      let L = Math.min(Math.max(r2.right - mw, 8), innerWidth - mw - 8);
      let T = r2.bottom + gap; if (T + mh > innerHeight - 8) T = Math.max(8, r2.top - gap - mh);
      menu.style.left=L+'px'; menu.style.top=Math.max(8,T)+'px';
    }
    menu._closers={closeOnOutside, onSR};
    addEventListener('click', closeOnOutside, {capture:true});
    addEventListener('scroll', onSR, {passive:true});
    addEventListener('resize', onSR, {passive:true});
  }
  function closeUserMenu(){
    const menu=q('#usermenu'); if(!menu) return;
    menu.classList.remove('open'); menu.style.display='none';
    if(menu._closers){
      removeEventListener('click', menu._closers.closeOnOutside, {capture:true});
      removeEventListener('scroll', menu._closers.onSR);
      removeEventListener('resize', menu._closers.onSR);
      menu._closers=null;
    }
    const chip=q('#userchip'); if(chip){ chip.appendChild(menu); chip.setAttribute('aria-expanded','false'); }
  }

  /* OVERLAY helpers */
  const showOverlay=html=>{const ov=q('#overlay'); ov.innerHTML=html; ov.classList.add('show');};
  const closeOverlay=()=>{const ov=q('#overlay'); ov.classList.remove('show'); ov.innerHTML='';};
  q('#overlay').addEventListener('click', (e)=>{ if(e.target.id==='overlay') closeOverlay(); });
  addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeOverlay(); });

  /* ===== Avatar modal (preview + upload to Storage) ===== */
  function readFileToDataURL(file){
    return new Promise((resolve, reject)=>{
      const ok = /image\/(png|jpe?g|webp|gif)$/i.test(file.type);
      if(!ok) return reject(new Error('Rasm formati: JPG/PNG/WebP/GIF.'));
      const reader=new FileReader();
      reader.onload=()=>resolve(reader.result);
      reader.onerror=()=>reject(new Error('Faylni o‘qishda xatolik.'));
      reader.readAsDataURL(file);
    });
  }
  function openAvatarModal(initialSrc){
    const html = `
      <div class="profile-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <b style="font-size:18px">Avatarni yangilash</b>
          <button class="btn" id="avClose">Yopish</button>
        </div>
        <div class="divider"></div>
        <div style="display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap">
          <div style="border:1px dashed var(--line);border-radius:16px;padding:14px;display:grid;gap:12px;place-items:center">
            <div id="preview" style="width:240px;height:240px;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#f3f7f4;display:grid;place-items:center">
              ${initialSrc?`<img src="${initialSrc}" style="max-width:100%;max-height:100%">`:'<small class="muted">Rasm hali tanlanmagan</small>'}
            </div>
            <input type="file" id="avFile" accept="image/*" style="display:none"/>
            <button class="btn" id="pick">Fayl tanlash</button>
          </div>
          <div class="muted">JPG/PNG/WebP, 2MB gacha. Saqlagach, darhol yangilanadi.</div>
        </div>
        <div id="avErr" style="color:#c62828;min-height:18px"></div>
        <div style="display:flex;gap:10px;justify-content:flex-end">
          <button class="btn" id="avCancel">Bekor</button>
          <button class="btn primary" id="avSave" disabled>Saqlash</button>
        </div>
      </div>`;
    showOverlay(html);
    const prev=q('#preview'), avFile=q('#avFile'); let dataURL=initialSrc||'';
    const setPreview=(src)=>{dataURL=src||''; prev.innerHTML=dataURL?`<img src="${dataURL}" style="max-width:100%;max-height:100%">`:'<small class="muted">Rasm hali tanlanmagan</small>'; q('#avSave').disabled=!dataURL;};
    q('#pick').onclick=()=>avFile.click();
    avFile.onchange=async e=>{ const f=e.target.files?.[0]; if(!f) return; if(f.size>2*1024*1024){ q('#avErr').textContent='2MB dan oshmasin.'; return; } setPreview(await readFileToDataURL(f)); };
    q('#avClose').onclick=closeOverlay; q('#avCancel').onclick=closeOverlay;
    q('#avSave').onclick=async ()=>{
      if(!CURRENT_USER||!dataURL) return; q('#avErr').textContent=''; q('#avSave').disabled=true;
      try{ const ref=sRef(st,`avatars/${CURRENT_USER.uid}.jpg`); await uploadString(ref,dataURL,'data_url'); const url=await getDownloadURL(ref);
        PROFILE={...(PROFILE||{}),avatarUrl:url}; await saveProfile(CURRENT_USER.uid, PROFILE); renderUserChip(CURRENT_USER, PROFILE); closeOverlay();
      }catch(ex){ q('#avErr').textContent=ex?.message||String(ex); q('#avSave').disabled=false; }
    };
  }

  /* Profile VIEW / EDIT (qisqartirilgan) */
  function openProfileView(){
    if(!CURRENT_USER) return;
    const p=PROFILE||{}; const age=p.birthDate?calcAge(p.birthDate):'';
    showOverlay(`<div class="profile-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;gap:12px;align-items:center">
          <div class="avatar" style="width:56px;height:56px">${(p.avatarUrl||CURRENT_USER.photoURL)?`<img src="${p.avatarUrl||CURRENT_USER.photoURL}">`:''}</div>
          <div><b style="font-size:18px">${p.firstName||''} ${p.lastName||''}</b><br>
          <small class="muted">${p.role||'—'} ${age?`• ${age} yosh`:''} • ${USER_POINTS} points</small></div>
        </div>
        <button class="btn" id="pvClose">Yopish</button>
      </div>
    </div>`); q('#pvClose').onclick=closeOverlay;
  }

  /* ======== HOME (banner carousel + cards + subsections) ========= */

  async function fetchHome(){
    // Firestore -> fallback: home.json -> empty
    try{const s=await getDoc(doc(db,'configs','home')); if(s.exists()){const d=s.data(); if(Array.isArray(d.sections)) return d;}}catch(e){}
    try{const r=await fetch('./home.json',{cache:'no-store'}); if(r.ok) return await r.json();}catch{}
    return {sections:[]};
  }

  const HSTATE={ sections:[], activeId:null };

  // time helpers
  const parseLocal=s=>{if(!s)return null; const m=s.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/); if(!m) return null; const [,Y,M,D,h,mn]=m; return new Date(+Y,+M-1,+D,+h,+mn,0,0);};
  const fmtDate=d=>!d?'-':`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  const msParts=ms=>{const sec=Math.max(0,Math.floor(ms/1000));const d=Math.floor(sec/86400),h=Math.floor((sec%86400)/3600),m=Math.floor((sec%3600)/60),s=sec%60;return {d,h,m,s}};
  const fmtParts=p=>{const z=n=>String(n).padStart(2,'0');return (p.d>0?`${p.d} kun `:'')+`${z(p.h)}:${z(p.m)}:${z(p.s)}`;};
  const cardState=it=>{ if(it.cardStyle==='soon') return 'soon'; if(it.cardStyle==='timed'){const now=new Date(), s=parseLocal(it.startAt), e=parseLocal(it.endAt); if(s&&now<s) return 'soon'; if(s&&e&&now>=s&&now<=e) return 'active'; if(e&&now>e) return 'ended'; return 'active'; } return 'available'; };
  const ORDER={active:0,soon:1,available:2,ended:3};
  const sortCards=arr=>[...arr].sort((a,b)=>{const oa=ORDER[cardState(a)]??9, ob=ORDER[cardState(b)]??9; if(oa!==ob) return oa-ob; const as=parseLocal(a.startAt)?.getTime()||0, bs=parseLocal(b.startAt)?.getTime()||0; return as-bs;});

  // chips
  function renderChips(){ const bar=q('#chipbar'); bar.innerHTML=''; HSTATE.sections.forEach((s,i)=>{ const b=document.createElement('button'); b.className='chip'+(i===0?' active':''); b.textContent=s.title||s.id||('Bo‘lim '+(i+1)); b.dataset.target=s.id||('sec'+i); b.onclick=()=>{activate(b.dataset.target); b.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'});}; bar.appendChild(b);});}

  // ==== Carousel builder (banners -> slides)
  function makeCarousel(banners,{full=false,baseHref=''}) {
    const root=document.createElement('div'); root.className='carousel';
    const slides=document.createElement('div'); slides.className='slides'; root.appendChild(slides);
    banners.forEach(b=>{
      const sli=document.createElement('div'); sli.className='slide';
      // iframe inside wrapper
      let wrap, ifr=document.createElement('iframe'); ifr.setAttribute('sandbox', b.sandbox||'allow-scripts allow-forms'); ifr.setAttribute('scrolling','no');
      if(b.mode==='url'){ ifr.src=b.src||''; }
      else{ const base=b.baseHref||baseHref||''; ifr.srcdoc=`<!doctype html><html><head>${base?`<base href="${base}">`:''}<meta charset="utf-8"><style>html,body{height:100%;margin:0;overflow:hidden;background:transparent}</style></head><body>${b.contentHtml||''}</body></html>`; }
      if(full){ wrap=document.createElement('div'); wrap.className='full-bleed'; }
      else { wrap=document.createElement('div'); wrap.className='ratio'; wrap.dataset.r='16-9'; }
      wrap.appendChild(ifr); sli.appendChild(wrap); slides.appendChild(sli);
    });

    if(banners.length>1){
      const prev=document.createElement('button'); prev.className='car-ctrl car-prev'; prev.textContent='‹';
      const next=document.createElement('button'); next.className='car-ctrl car-next'; next.textContent='›';
      const dots=document.createElement('div'); dots.className='dots';
      root.appendChild(prev); root.appendChild(next); root.appendChild(dots);
      let i=0, timer=null, W=()=>root.clientWidth;
      const set=(idx)=>{ i=(idx+banners.length)%banners.length; slides.style.transform=`translateX(${-i*W()}px)`; qa('.dot',dots).forEach((d,k)=>d.classList.toggle('active',k===i)); };
      const play=()=>{ stop(); timer=setInterval(()=>set(i+1),5000); };
      const stop=()=>{ if(timer){clearInterval(timer);timer=null;} };
      window.addEventListener('resize', ()=>set(i));
      prev.onclick=()=>{set(i-1); play();}; next.onclick=()=>{set(i+1); play();};
      banners.forEach((_,k)=>{ const d=document.createElement('div'); d.className='dot'+(k===0?' active':''); d.onclick=()=>{set(k); play();}; dots.appendChild(d); });
      set(0); play(); root.addEventListener('mouseenter',stop); root.addEventListener('mouseleave',play);
      // swipe
      let sx=0; slides.addEventListener('touchstart',e=>{sx=e.touches[0].clientX; stop();},{passive:true});
      slides.addEventListener('touchend',e=>{const dx=(e.changedTouches[0].clientX-sx); if(Math.abs(dx)>40) set(i+(dx<0?1:-1)); play();},{passive:true});
    }
    return root;
  }

  // filters
  function buildFilters(){
    const wrap=document.createElement('div'); wrap.className='inline-filters';
    const opts=[['all','Barchasi'],['active','Faol'],['soon','Yaqinda'],['available','Mavjud'],['ended','Tugagan']];
    const chips=opts.map(([k,l])=>{const b=document.createElement('button'); b.className='fchip'+(k==='all'?' active':''); b.textContent=l; b.dataset.f=k; wrap.appendChild(b); return b;});
    const api={onChange:null}; chips.forEach(b=>b.onclick=()=>{chips.forEach(x=>x.classList.toggle('active',x===b)); api.onChange && api.onChange(b.dataset.f);});
    return [wrap,api];
  }
  const fmtCountdown=it=>{const now=Date.now(), s=parseLocal(it.startAt)?.getTime(), e=parseLocal(it.endAt)?.getTime();
    if(!s||!e) return ''; if(now<s) return 'Boshlanishigacha: '+fmtParts(msParts(s-now)); if(now<=e) return 'Tugashigacha: '+fmtParts(msParts(e-now)); return 'Tugagan';};

  function renderCard(it){
    const c=document.createElement('div'); c.className='cardX'; c.dataset.state=cardState(it);
    const row=document.createElement('div'); row.className='rowflex';
    const h=document.createElement('h4'); h.textContent=it.title||'—'; row.appendChild(h);
    const st=cardState(it), bd=document.createElement('span'); bd.className='badge '+(st==='soon'?'soon':st==='active'?'active':st==='ended'?'ended':''); bd.textContent=(st==='soon'?'Yaqinda':st==='active'?'Faol':st==='ended'?'Tugagan':'Mavjud'); row.appendChild(bd);
    c.appendChild(row);
    if(it.cardStyle==='timed'){ const s=parseLocal(it.startAt), e=parseLocal(it.endAt);
      const t=document.createElement('div'); t.className='muted'; t.textContent=`Vaqt: ${fmtDate(s)} — ${fmtDate(e)}`; c.appendChild(t);
      const cd=document.createElement('div'); cd.className='muted'; cd.dataset.countdown=''; cd.textContent=fmtCountdown(it); c.appendChild(cd);
      c._timed={start:s?.getTime()||null,end:e?.getTime()||null};
    }
    const actions=document.createElement('div'); actions.className='rowflex';
    const info=document.createElement('button'); info.className='btn'; info.textContent='ℹ️ Info';
    info.onclick=()=>showOverlay(`<div class="profile-card"><div style="display:flex;justify-content:space-between;align-items:center"><b>${it.title||''}</b><button class="btn" onclick="(${closeOverlay.toString()})();">Yopish</button></div><div class="muted" style="margin-top:8px">${it.infoHtml||'<p>—</p>'}</div></div>`);
    actions.appendChild(info);
    const a=document.createElement('a'); a.textContent=it.ctaLabel||'Boshlash'; a.className='btn primary';
    if(it.ctaHref && st==='active'){ a.href=it.ctaHref; a.target='_blank'; a.dataset.href=it.ctaHref; a.setAttribute('data-enabled','1'); }
    else { a.classList.remove('primary'); a.setAttribute('disabled',''); }
    actions.appendChild(a); c.appendChild(actions); return c;
  }

  // renderers
  function renderSubsection(ss, inhBase){
    const box=document.createElement('section'); box.className='section';
    const hd=document.createElement('div'); hd.className='section-hdr'; hd.innerHTML=`<h3>${ss.title||ss.id||'Bo‘lim'}</h3>`; box.appendChild(hd);
    const body=document.createElement('div'); body.className='iframe-wrap';

    const items=Array.isArray(ss.items)?ss.items:[]; 
    const banners=items.filter(x=>x.kind==='banner'); 
    let cards=items.filter(x=>x.kind==='card');

    if(banners.length){
      const car = makeCarousel(banners,{full:!!ss.fullBleed, baseHref:(ss.baseHref||inhBase||'')});
      body.appendChild(car);
    }

    cards=sortCards(cards);
    if(cards.length){
      const pad=document.createElement('div'); pad.style.padding='12px';
      const [filters, api]=buildFilters(); pad.appendChild(filters);
      const grid=document.createElement('div'); grid.className='grid';
      cards.forEach(ci=>grid.appendChild(renderCard(ci))); pad.appendChild(grid);
      api.onChange=(key)=>{ qa('.cardX',grid).forEach(el=>{const st=el.dataset.state||'available'; el.style.display=(key==='all'||st===key)?'flex':'none';}); };
      body.appendChild(pad);
    }

    const subs=Array.isArray(ss.subsections)?ss.subsections:[]; 
    subs.forEach(s2=> body.appendChild(renderSubsection(s2, (ss.baseHref||inhBase||''))) );

    box.appendChild(body); return box;
  }

  function renderSection(sec){
    const outer=document.createElement('section'); outer.dataset.section=sec.id||'';
    outer.className='section';
    if(!sec.fullBleed){ const sh=document.createElement('div'); sh.className='section-hdr'; sh.innerHTML=`<h3>${sec.title||sec.id}</h3>`; outer.appendChild(sh); }
    const body=document.createElement('div'); body.className='iframe-wrap';

    const items=Array.isArray(sec.items)?sec.items:[]; 
    const banners=items.filter(x=>x.kind==='banner'); 
    let cards=items.filter(x=>x.kind==='card');

    if(banners.length){
      const car = makeCarousel(banners,{full:!!sec.fullBleed, baseHref:(sec.baseHref||'')});
      body.appendChild(car);
    }

    cards=sortCards(cards);
    if(cards.length){
      const pad=document.createElement('div'); pad.style.padding='12px';
      const [filters, api]=buildFilters(); pad.appendChild(filters);
      const grid=document.createElement('div'); grid.className='grid';
      cards.forEach(ci=>grid.appendChild(renderCard(ci))); pad.appendChild(grid);
      api.onChange=(key)=>{ qa('.cardX',grid).forEach(el=>{const st=el.dataset.state||'available'; el.style.display=(key==='all'||st===key)?'flex':'none';}); };
      body.appendChild(pad);
    }

    const subs=Array.isArray(sec.subsections)?sec.subsections:[]; 
    subs.forEach(ss=> body.appendChild(renderSubsection(ss, sec.baseHref||'')) );

    outer.appendChild(body); return outer;
  }

  // fullscreen banner yuqorisini header+chipbar’dan keyin boshlash
  function sizeBannerGap(){
    const hdrH=(q('#hdr')?.getBoundingClientRect().height||0);
    const chipH=(q('#chipwrap')?.getBoundingClientRect().height||0);
    document.documentElement.style.setProperty('--top-gap', (hdrH+chipH)+'px');
  }

  function activate(id){
    HSTATE.activeId=id;
    document.querySelectorAll('.chip').forEach(c=>c.classList.toggle('active', c.dataset.target===id));
    qa('[data-section]').forEach(s=>{ const show=(s.dataset.section===id); s.style.display=show?'block':'none'; });
    sizeBannerGap();
  }

  function renderSections(){
    const host=q('#sections'); host.innerHTML='';
    HSTATE.sections.forEach(sec=> host.appendChild(renderSection(sec)) );
  }

  // Countdown updater
  function tick(){ const now=Date.now(); qa('[data-countdown]').forEach(cd=>{ const card=cd.closest('.cardX'); const t=card?card._timed:null; if(!t) return; let text=''; if(t.start && now<t.start) text='Boshlanishigacha: '+fmtParts(msParts(t.start-now)); else if(t.end && now<=t.end) text='Tugashigacha: '+fmtParts(msParts(t.end-now)); else text='Tugagan'; cd.textContent=text;
    const old=card.dataset.state; const st=(t.start&&now<t.start)?'soon':(t.end&&now<=t.end)?'active':'ended'; if(st!==old){ card.dataset.state=st; const b=card.querySelector('.badge'); if(b){b.classList.remove('soon','active','ended'); if(st==='soon')b.classList.add('soon'); if(st==='active')b.classList.add('active'); if(st==='ended')b.classList.add('ended'); b.textContent=(st==='soon'?'Yaqinda':st==='active'?'Faol':'Tugagan'); } const a=card.querySelector('a'); if(a){ if(st==='active' && a.dataset.href){ a.classList.add('primary'); a.removeAttribute('disabled'); a.href=a.dataset.href; a.target='_blank'; } else { a.classList.remove('primary'); a.setAttribute('disabled',''); a.removeAttribute('href'); a.removeAttribute('target'); } } } }); }

  async function loadHome(){
    const data=await fetchHome();
    HSTATE.sections=(Array.isArray(data.sections)?data.sections:[]).map((s,i)=>({id:s.id||`sec${i+1}`,...s}));
    const bar=q('#chipbar'); bar.innerHTML=''; HSTATE.sections.forEach((s,i)=>{ const b=document.createElement('button'); b.className='chip'+(i===0?' active':''); b.textContent=s.title||s.id||('Bo‘lim '+(i+1)); b.dataset.target=s.id||('sec'+i); b.onclick=()=>{activate(b.dataset.target); b.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'});}; bar.appendChild(b);});
    renderSections();
    if(HSTATE.sections.length) activate(HSTATE.sections[0].id);
    setInterval(tick,1000); sizeBannerGap();
  }

  /* Auth lock (min) */
  function setLocked(b){const a=q('#app'); if(a) a.hidden=b;}
  function buildAuthLock(){ if(q('#auth-lock')) return q('#auth-lock');
    const lock=document.createElement('div'); lock.id='auth-lock'; lock.className='overlay show';
    lock.innerHTML=`<div class="profile-card">
      <div class="fld"><label>Email</label><input type="email" id="eml" placeholder="email@example.com"></div>
      <div class="fld"><label>Parol</label><input type="password" id="pwd" placeholder="••••••••"></div>
      <div id="err" style="color:#c62828"></div>
      <div style="display:flex;gap:10px">
        <button id="login" class="btn primary">Kirish</button>
        <button id="signup" class="btn">Ro‘yxatdan o‘tish</button>
        <button id="google" class="btn">Google</button>
      </div>
    </div>`;
    document.body.appendChild(lock);
    lock.addEventListener('click', async (e)=>{
      const id=e.target.id, errEl=q('#err',lock); const busy=b=>qa('button',lock).forEach(x=>x.disabled=b);
      try{
        busy(true);
        if(id==='google') await signInWithPopup(auth,new GoogleAuthProvider());
        if(id==='login'){ const eml=q('#eml',lock).value.trim(), pwd=q('#pwd',lock).value; await signInWithEmailAndPassword(auth,eml,pwd); }
        if(id==='signup'){ const eml=q('#eml',lock).value.trim(), pwd=q('#pwd',lock).value; await createUserWithEmailAndPassword(auth,eml,pwd); }
      }catch(err){ if(errEl) errEl.textContent=err?.message||String(err); } finally{ busy(false); }
    });
    return lock;
  }

  onAuthStateChanged(auth, async (u)=>{
    CURRENT_USER=u||null;
    if(!u){ setLocked(true); buildAuthLock(); q('#user-slot').innerHTML=''; return; }
    qa('#auth-lock').forEach(x=>x.remove()); setLocked(false);
    if(!REGIONS.length) REGIONS=await loadRegions();
    [PROFILE, USER_POINTS] = await Promise.all([ getProfile(u.uid), getUserPoints(u.uid) ]);
    if(PROFILE && !PROFILE.role){ PROFILE.role='O‘quvchi'; await saveProfile(u.uid, PROFILE); }
    renderUserChip(u, PROFILE||{});

    const baseOk = ALWAYS_REQ.every(k=>PROFILE && PROFILE[k]);
    const ok = baseOk && (PROFILE?.role!=='O‘quvchi' || !!PROFILE.class);
    if(!ok) openAvatarModal(PROFILE?.avatarUrl||u.photoURL||''); // tezkor: agar to‘liq emas bo‘lsa avatarni ham yangilashga taklif
  });

  // Global delegation
  document.addEventListener('click', (e)=>{
    const t=e.target;
    if(t.closest('#userchip')){
      const open = q('#usermenu')?.classList.contains('open');
      open ? closeUserMenu() : openUserMenu();
    }
    if(t.closest('#mProfile')){ e.preventDefault(); closeUserMenu(); openProfileView(); }
    if(t.closest('#mEdit')){ e.preventDefault(); closeUserMenu(); openAvatarModal(PROFILE?.avatarUrl||CURRENT_USER?.photoURL||''); }
    if(t.closest('#mLogout')){ e.preventDefault(); closeUserMenu(); signOut(auth); }
  });

  await loadHome();
  sizeBannerGap();
  addEventListener('resize', sizeBannerGap);
  addEventListener('orientationchange', sizeBannerGap);
  </script>
</body>
</html>
