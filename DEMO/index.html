<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>LeaderMath ‚Äî Premium Glass PWA</title>
  <meta name="theme-color" content="#2E8B57" id="meta-theme-color"/>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./favicon.png">
  <style>
  :root{ --brand:#2E8B57;--brand2:#1F6B45; --bg:#f4f8f6;--text:#0d1b14;--muted:#375c4c;--card:#ffffff; --frame:#d8e7dd;--frame-strong:#b7d6c5;--chip:#eaf6f0;--chip-b:#cfe7db; --radius:16px; --ring:#8ad1b1 }
  :root.dark{ --bg:#0e1512; --text:#EAF7EE; --muted:#A5C7B4; --card:#142018; --frame:#244b39; --frame-strong:#2f6b52; --chip:#132a20; --chip-b:#2a5742; --ring:#2fbf7d }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

  /* AUTH GATE */
  html.auth-checking #app{display:none}
  html.auth-checking #authGate{display:flex}
  #authGate{position:fixed;inset:0;z-index:9999;display:none;align-items:center;justify-content:center;padding:24px;background:linear-gradient(135deg, rgba(14,21,18,.85), rgba(31,107,69,.85));backdrop-filter: blur(10px)}
  #authCard{width:min(560px,96vw);background:var(--card);border:1px solid var(--frame-strong);border-radius:18px;padding:20px;box-shadow:0 24px 64px rgba(0,0,0,.35)}
  #authCard h2{margin:0 0 6px;font-size:22px}
  #authCard p{margin:0 0 14px;color:var(--muted)}
  .auth-row{display:flex;gap:10px;justify-content:flex-end;margin-top:8px}

  /* Buttons */
  .btn{position:relative;display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border:none;border-radius:12px;cursor:pointer;text-decoration:none;font-weight:800;color:#fff;isolation:isolate;background:linear-gradient(135deg,var(--brand),var(--brand2));box-shadow:0 6px 18px rgba(46,139,87,.25), inset 0 0 0 1px #ffffff22;transition:transform .12s ease, box-shadow .12s ease, filter .12s ease}
  .btn:hover{transform:translateY(-1px);box-shadow:0 10px 28px rgba(46,139,87,.32), inset 0 0 0 1px #ffffff33}
  .btn.ghost{background:linear-gradient(180deg,#fff,#f5faf7);color:var(--brand2);border:1px solid var(--frame);box-shadow:0 4px 12px rgba(0,0,0,.06)}
  .dark .btn.ghost{background:linear-gradient(180deg,#1a2a21,#17261f);color:#c8f0dc;border-color:#2a5742}
  .btn.sm{padding:8px 12px;border-radius:10px;font-weight:700}

  /* Appbar */
  .appbar{position:sticky;top:0;z-index:90;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:10px 12px;display:flex;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
  .logo{width:60px;height:60px;border-radius:14px;background:#fff2;display:grid;place-items:center;font-weight:800;overflow:hidden}
  .logo img{width:100%;height:100%;object-fit:contain}
  .title{font-weight:800;font-size:18px}
  .sub{font-size:12px;opacity:.9}
  .spacer{flex:1}
  .iconbtn{background:#ffffff22;border:1px solid #ffffff33;color:#fff;border-radius:12px;padding:8px 10px;font-weight:700;cursor:pointer}

  /* User chip */
  .uc-chip{display:flex;align-items:center;gap:10px;background:var(--card);border:1px solid var(--frame);border-radius:20px;padding:6px 8px 6px 6px;box-shadow:0 10px 24px rgba(0,0,0,.1)}
  .uc-ava{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;font-weight:900;display:grid;place-items:center;overflow:hidden;box-shadow:inset 0 0 0 2px #ffffff22}
  .uc-ava img{width:100%;height:100%;object-fit:cover}
  .uc-pill{display:inline-flex;align-items:center;gap:6px;padding:7px 12px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-b);font-size:13px}
  body:not(.dark) .uc-pill b{color:#000}

  /* Filters */
  .filters{margin:10px 12px;padding:10px;background:var(--card);border:1px solid var(--frame);border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.06)}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-b);font-size:12px;cursor:pointer}
  .chip[aria-pressed="true"]{background:linear-gradient(135deg,var(--brand),var(--brand2));border-color:#0000;color:#fff}

  /* ===== BANNERS (stories tarzida) ===== */
  .banner-group{margin:14px 12px;border-radius:18px;border:1px solid var(--frame);overflow:hidden;background:var(--card);box-shadow:0 10px 24px rgba(0,0,0,.08)}
  .banner-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;font-weight:900;color:var(--muted)}
  .stories{position:relative;display:grid;grid-template-areas:'stage';height:240px;background:linear-gradient(135deg,#f0fff6,#e7f6ee)}
  .story{grid-area:stage;position:relative;width:100%;height:100%;display:none}
  .story.active{display:block}
  .story img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:saturate(1.05)}
  .story .content{position:absolute;left:0;right:0;bottom:0;padding:14px;background:linear-gradient(180deg,transparent,rgba(0,0,0,.55));color:#fff}
  .progress{position:absolute;left:6px;right:6px;top:6px;display:grid;grid-auto-flow:column;gap:6px;z-index:2}
  .bar{height:4px;border-radius:999px;background:#ffffff77;overflow:hidden}
  .bar > i{display:block;height:100%;width:0%;background:#fff;transition:width .2s linear}

  /* ===== CARDS v2 (betakror) ===== */
  .container{padding:6px 12px 96px}
  .sec-title{margin:12px 6px;font-size:15px;font-weight:900;opacity:.9}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:560px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media(min-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}

  .cardX{position:relative;border-radius:18px;overflow:hidden;background:var(--card);border:1px solid var(--frame);box-shadow:0 14px 36px rgba(0,0,0,.08)}
  .cardX .hero{position:relative;aspect-ratio:16/9;background:#e9f5ef;display:grid;place-items:center}
  .dark .cardX .hero{background:#0f1714}
  .cardX .hero .title-fallback{font-size:28px;font-weight:900;opacity:.82;letter-spacing:.2px}
  .cardX .hero img{width:100%;height:100%;object-fit:cover}

  /* overlay states */
  .cx-badge{position:absolute;top:10px;left:10px;border-radius:999px;padding:8px 12px;font-weight:900;color:#fff;backdrop-filter: blur(6px);-webkit-backdrop-filter: blur(6px)}
  .cx-badge.best{background:linear-gradient(135deg,#2E8B57,#1F6B45)}
  .cx-badge.soon{background:linear-gradient(135deg,#111827AA,#1F2937AA)}
  .cx-badge.open{background:linear-gradient(135deg,#2563ebAA,#1d4ed8AA)}
  .cx-badge.closed{background:linear-gradient(135deg,#6b7280AA,#374151AA)}

  .cx-blurFlag{position:absolute;inset:0;display:flex;align-items:flex-end;justify-content:space-between;padding:14px;background:linear-gradient(180deg,transparent,rgba(0,0,0,.55));color:#fff}
  .cx-flagText{font-weight:900;font-size:18px}
  .cx-count{font-weight:900;font-size:18px}

  .cx-body{padding:14px}
  .cx-name{margin:0 0 6px;font-size:18px;font-weight:900}
  .cx-desc{margin:0 0 10px;font-size:13px;color:var(--muted)}
  .cx-tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .tag{font-size:11px;padding:5px 8px;border:1px solid var(--frame);border-radius:999px;background:var(--chip)}

  .cx-actions{display:flex;flex-wrap:wrap;gap:8px}
  .btn.modal{background:linear-gradient(135deg,#39B6FF,#0077FF)}

  /* Modal */
  .modal-mask{position:fixed;inset:0;background:linear-gradient(135deg, rgba(14,21,18,.35), rgba(31,107,69,.35));display:none;align-items:center;justify-content:center;z-index:1000;padding:20px;backdrop-filter: blur(8px)}
  .modal{background:rgba(255,255,255,.9);border:1px solid var(--frame-strong);border-radius:18px;box-shadow:0 24px 64px rgba(0,0,0,.35);padding:18px;width:min(760px,96vw);max-height:90vh;overflow:auto}
  .dark .modal{background:rgba(20,32,24,.92)}

  /* Leaderboard (unchanged core) */
  .board{background:var(--card);border:1px solid var(--frame);border-radius:16px;margin:10px 12px;padding:12px}
  .pager{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:8px 0}
  .pbtn{background:var(--chip);border:1px solid var(--frame);border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer}
  .pbtn[disabled]{opacity:.5;cursor:not-allowed}
  .desc{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div id="authGate"><div id="authCard"><h2>Davom etish uchun kirish talab qilinadi</h2><p>Google orqali tizimga kiring.</p><div class="auth-row"><a id="goLogin" class="btn">üîë Kirish</a></div></div></div>

  <div id="app">
    <header class="appbar">
      <div class="logo"><img src="./icon-512.png" alt="LeaderMath"></div>
      <div><div class="title">LeaderMath</div><div class="sub">BSB / CHSB / ONLINE OLIMPIADA / DTM / dars-resurslar</div></div>
      <div class="spacer"></div>
      <button id="themeBtn" class="iconbtn" title="Dark/Light">üåô</button>
      <div class="uc-chip" id="ucChip">
        <div class="uc-ava" id="ucAva">LM</div>
        <div class="uc-pill"><span>‚≠ê</span><b id="ucPointsVal">‚Äî</b></div>
      </div>
    </header>

    <!-- TOP FILTERS -->
    <section class="filters" id="filtersMain"><h4>BO‚ÄòLIMLAR:</h4><div id="mainTags" class="chips"></div></section>

    <!-- ===== Banner groups (stories) will mount here ===== -->
    <div id="bannerMount"></div>

    <!-- Leaderboard (existing) -->
    <section class="board" id="board"><h3>League</h3><div class="pager"><button id="decilePrev" class="pbtn">‚¨ÖÔ∏è Oldingi (10)</button><div class="pinfo" id="decileInfo">10‚Äì1 (Diamond)</div><button id="decileNext" class="pbtn">Keyingi (10) ‚û°Ô∏è</button></div><div id="boardList"></div></section>

    <!-- Sections (cards) -->
    <div class="container"><div id="sections"></div></div>
  </div>

  <!-- Modal for button type=modal -->
  <div id="modalMask" class="modal-mask"><div class="modal" id="modalBody"></div></div>

<script type="module">
/* ===== BOOTSTRAP / THEME ===== */
if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js');
import { auth, db, signOut } from './lib/firebase.client.js';
import { watchAuth } from './lib/auth-guard.js';
import { doc, getDoc, setDoc, runTransaction, collection, query, orderBy, limit, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

const root=document.documentElement, themeBtn=document.getElementById('themeBtn'), THEME_KEY='lm-theme';
const setTheme=m=>{root.classList.toggle('dark',m==='dark');localStorage.setItem(THEME_KEY,m); if(themeBtn) themeBtn.textContent=m==='dark'?'‚òÄÔ∏è':'üåô'};
setTheme(localStorage.getItem(THEME_KEY)||(matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));
if (themeBtn) themeBtn.onclick=()=>setTheme(root.classList.contains('dark')?'light':'dark');

/* ===== STATE ===== */
let TOP_VIEW='banners';
let FILTER={ main:null };
let latestUsers=[], CURRENT_DECILE=0; // leaderboard

/* ===== HELPERS ===== */
const toMs=v=> v? (new Date(v)).getTime():null;
const fmtTime=(ms)=>{ if(ms<=0) return '00:00:00'; const s=Math.floor(ms/1000); const h=String(Math.floor(s/3600)).padStart(2,'0'); const m=String(Math.floor((s%3600)/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${h}:${m}:${ss}`; };
const escapeHtml=s=>String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
const fmtPoints=v=> (Number(v)||0).toLocaleString('uz-UZ',{maximumFractionDigits:1});

/* ===== BANNERS: group -> stories carousel ===== */
function mountBannerGroups(banners){
  const byGroup=new Map();
  (banners||[]).forEach(b=>{ const g=b.group||'Umumiy'; if(!byGroup.has(g)) byGroup.set(g,[]); byGroup.get(g).push(b); });
  const mount=document.getElementById('bannerMount'); if(!mount) return; mount.innerHTML='';
  byGroup.forEach((items,groupName)=>{
    const id='bg_'+groupName.replace(/\W+/g,'_');
    const wrap=document.createElement('section'); wrap.className='banner-group';
    wrap.innerHTML=`<div class="banner-head"><span>${escapeHtml(groupName)}</span><div class="desc">${items.length} banner</div></div>
      <div class="stories" id="${id}">
        <div class="progress">${items.map(()=>'<span class="bar"><i></i></span>').join('')}</div>
        ${items.map((b,i)=>`
          <article class="story ${i===0?'active':''}" data-idx="${i}" data-dur="${Number(b.durationSec||5)}">
            ${b.image? `<img src="${b.image}" alt="">`:''}
            <div class="content">${b.html||''}</div>
          </article>`).join('')}
      </div>`;
    mount.appendChild(wrap);
    initStoriesCarousel(id);
  });
}
function initStoriesCarousel(id){
  const root=document.getElementById(id); if(!root) return; let idx=0, timer=null, touchX=0;
  const stories=[...root.querySelectorAll('.story')]; const bars=[...root.querySelectorAll('.bar > i')];
  const go=(n)=>{ stories.forEach(s=>s.classList.remove('active')); idx=(n+stories.length)%stories.length; stories[idx].classList.add('active'); bars.forEach(b=>b.style.width='0%'); start(); };
  const next=()=> go(idx+1); const prev=()=> go(idx-1);
  const start=()=>{ clearInterval(timer); const dur=(Number(stories[idx].dataset.dur)||5)*1000; let t0=performance.now();
    timer=setInterval(()=>{ const p=((performance.now()-t0)/dur)*100; bars[idx].style.width=Math.min(100,p)+'%'; if(p>=100){ clearInterval(timer); next(); } }, 60);
  };
  root.addEventListener('touchstart',e=>{ touchX=e.touches[0].clientX; });
  root.addEventListener('touchend',e=>{ const dx=(e.changedTouches[0].clientX - touchX); if(Math.abs(dx)>40){ if(dx<0) next(); else prev(); }});
  root.addEventListener('click',e=>{ const x=e.clientX; const w=root.clientWidth; if(x > w*0.6) next(); else if (x < w*0.4) prev(); });
  start();
}

/* ===== CARDS v2 ===== */
function computeState(it, now){
  const t=it.type||'open', start=toMs(it.startAt), end=toMs(it.endAt);
  if(t==='open') return {status:'open'};
  if(t==='coming_soon') return {status:'soon'};
  if(t==='window'){
    if(!start||!end) return {status:'open'};
    if(now<start) return {status:'locked_until', left:start-now};
    if(now<=end) return {status:'open'}; return {status:'closed'};
  }
  return {status:'open'};
}
function renderCard(it){
  const st=computeState(it, Date.now());
  const hasImg= !!it.image;
  const slug=(it.name||'').replace(/\W+/g,'-');
  const el=document.createElement('article'); el.className='cardX';
  el.innerHTML=`
    <div class="hero">
      ${hasImg? `<img src="${it.image}" alt="">` : `<div class="title-fallback">${escapeHtml(it.name||'')}</div>`}
      ${it.best? '<div class="cx-badge best">BEST</div>':''}
      <div class="cx-badge ${st.status==='open'?'open':st.status==='soon'?'soon':st.status==='locked_until'?'soon':'closed'}">${st.status==='open'?'Ochiq':st.status==='soon'?'Tez kunda':st.status==='locked_until'?'Tez kunda': 'Tugadi'}</div>
      <div class="cx-blurFlag">
        <div class="cx-flagText">${st.status==='soon'?'Tez kunda': st.status==='locked_until'?'Tez kunda': st.status==='closed'?'Yopildi':'Faol'}</div>
        <div class="cx-count" data-count="${slug}"></div>
      </div>
    </div>
    <div class="cx-body">
      <h3 class="cx-name">${escapeHtml(it.name||'')}</h3>
      ${it.description?`<p class="cx-desc">${escapeHtml(it.description)}</p>`:''}
      <div class="cx-actions" id="act-${slug}"></div>
      <div class="cx-tags">${(it.tags||[]).map(t=>`<span class="tag">${escapeHtml(String(t))}</span>`).join('')}</div>
    </div>`;

  // countdown tick
  const cd=el.querySelector(`[data-count='${slug}']`);
  const tick=()=>{ const st=computeState(it,Date.now()); if(st.status==='locked_until'){ cd.textContent=fmtTime(st.left); } else if(st.status==='open' && it.endAt){ const left=(toMs(it.endAt)-Date.now()); cd.textContent = left>0? ('Qolgan: '+fmtTime(left)) : 'Tugadi'; } else { cd.textContent=''; } };
  tick(); setInterval(tick,1000);

  // dynamic buttons
  const act=el.querySelector('#act-'+slug);
  (it.buttons||[]).forEach((b, i)=>{
    if((b.type||'link')==='modal'){
      const btn=document.createElement('button'); btn.className='btn modal sm'; btn.textContent=b.label||('Modal '+(i+1));
      btn.onclick=()=> openModal(b.html||'<p>Kontent yo\'q</p>');
      act.appendChild(btn);
    } else {
      const a=document.createElement('a'); a.className='btn sm'; a.textContent=b.label||('Boshlash '+(i+1));
      const st=computeState(it, Date.now());
      if(st.status==='open' && b.href){ a.href=b.href; a.target=b.target||'_self'; }
      else { a.removeAttribute('href'); a.setAttribute('aria-disabled','true'); a.style.opacity='.6'; }
      act.appendChild(a);
    }
  });

  return el;
}
function openModal(html){ const mask=document.getElementById('modalMask'); const body=document.getElementById('modalBody'); if(!mask||!body) return; body.innerHTML=html; mask.style.display='flex'; }
(function(){ const mask=document.getElementById('modalMask'); if(!mask) return; mask.addEventListener('click', e=>{ if(e.target===mask) mask.style.display='none'; }); })();

function sectionTags(sec){ const s=new Set(); (sec.items||[]).forEach(it=> (it.tags||[]).forEach(t=> s.add(String(t)))); return [...s].sort(); }
function renderSection(sec){
  const wrap=document.createElement('section');
  wrap.innerHTML=`<h3 class="sec-title">${escapeHtml(sec.title||'Bo\'lim')} ${sec.tag? ('‚Äî '+escapeHtml(sec.tag)) : ''}</h3>`;
  const grid=document.createElement('div'); grid.className='grid';
  (sec.items||[]).forEach(it=> grid.appendChild(renderCard(it)));
  wrap.appendChild(grid); return wrap;
}

function renderMainChips(data){
  const mainTags = [...new Set((data.sections||[]).map(s=>String(s.tag||'').trim()).filter(Boolean))].sort();
  const wrap=document.getElementById('mainTags'); if(!wrap) return; wrap.innerHTML='';
  const mk=(label,on,cb)=>{ const b=document.createElement('button'); b.className='chip'; b.type='button'; b.setAttribute('aria-pressed', on?'true':'false'); b.textContent=label; b.onclick=()=>cb(b); wrap.appendChild(b); };
  mk('üì∞ Bannerlar', TOP_VIEW==='banners', ()=>{TOP_VIEW='banners'; updateTop();});
  mk('üèÜ League', TOP_VIEW==='league', ()=>{TOP_VIEW='league'; updateTop();});
  mainTags.forEach(t=> mk(t, TOP_VIEW===t, ()=>{ TOP_VIEW=t; FILTER.main=t; updateTop(); }));
}

function updateTop(){
  const banners=document.getElementById('bannerMount'); const board=document.getElementById('board'); const cont=document.querySelector('.container');
  if(TOP_VIEW==='banners'){ banners.style.display=''; board.style.display='none'; cont.style.display='none'; }
  else if(TOP_VIEW==='league'){ banners.style.display='none'; board.style.display=''; cont.style.display='none'; }
  else { banners.style.display='none'; board.style.display='none'; cont.style.display=''; renderSectionsFiltered(); }
  // sync pressed state
  const wrap=document.getElementById('mainTags'); [...wrap.querySelectorAll('.chip')].forEach(b=>{
    const label=b.textContent.trim(); const on=(label.includes('Banner')&&TOP_VIEW==='banners')||(label.includes('League')&&TOP_VIEW==='league')||(label===TOP_VIEW); b.setAttribute('aria-pressed', on?'true':'false');
  });
}

function renderSectionsFiltered(){
  const container=document.getElementById('sections'); container.innerHTML='';
  const data=window.__LM_DATA||{}; const secs=(data.sections||[]).filter(s=> FILTER.main && String(s.tag)===FILTER.main);
  if(secs.length===0){ container.innerHTML='<div class="desc" style="margin:8px">Katta teg bo\'yicha bo\'lim topilmadi.</div>'; return; }
  secs.forEach(sec=> container.appendChild(renderSection(sec)));
}

/* ===== LOAD DATA ===== */
async function initContent(){
  try{
    const r=await fetch('./index.json',{cache:'no-store'}); const data=await r.json(); window.__LM_DATA=data;
    renderMainChips(data); mountBannerGroups(data.banners||[]); updateTop();
  }catch(e){ console.error(e); }
}

/* ===== Leaderboard minimal (reuse) ===== */
const GROUPS=[
  {label:'üíé Diamond League',start:1,end:10,tier:'diamond'},
  {label:'üíö Emerald League',start:11,end:20,tier:'emerald'},
  {label:'ü•á Gold League',start:21,end:30,tier:'gold'},
  {label:'ü•à Silver League',start:31,end:40,tier:'silver'},
  {label:'ü•â Bronze League',start:41,end:50,tier:'bronze'}
];
function drawDecile(users,ix){ const g=GROUPS[ix]; const list=document.getElementById('boardList'); if(!g||!list){return;} const arr=users.slice(0,50); const rows=[]; for(let r=g.start;r<=g.end;r++){ const u=arr[r-1]; if(!u) continue; rows.push(`<div style="display:flex;align-items:center;justify-content:space-between;border:1px solid var(--frame);border-radius:12px;padding:10px;margin:6px 0;background:var(--card)"><b>#${r} ${escapeHtml(u.name||'')}</b><span>‚≠ê ${fmtPoints(u.points||0)}</span></div>`); } list.innerHTML=rows.join(''); document.getElementById('decileInfo').textContent=g.label; document.getElementById('decilePrev').disabled=(ix<=0); document.getElementById('decileNext').disabled=(ix>=GROUPS.length-1); }
const prev=document.getElementById('decilePrev'), next=document.getElementById('decileNext'); if(prev) prev.onclick=()=>{ if(CURRENT_DECILE>0){ CURRENT_DECILE--; drawDecile(latestUsers,CURRENT_DECILE); } }; if(next) next.onclick=()=>{ if(CURRENT_DECILE<GROUPS.length-1){ CURRENT_DECILE++; drawDecile(latestUsers,CURRENT_DECILE); } };

/* ===== AUTH + PROFILE (short) ===== */
const html=document.documentElement, gate=document.getElementById('authGate'), app=document.getElementById('app'), goLogin=document.getElementById('goLogin');
html.classList.add('auth-checking'); const ret=encodeURIComponent(location.pathname.replace(/\\/g,'/')+location.search); if(goLogin) goLogin.href=`./login.html?return=${ret}`;
function showApp(){ gate.style.display='none'; app.style.display='block'; html.classList.remove('auth-checking'); }
function lockLogin(){ app.style.display='none'; gate.style.display='flex'; html.classList.remove('auth-checking'); }

let currentUserId=null;
async function ensureUser(user){ const ref=doc(db,'users',user.uid); await runTransaction(db, async(tx)=>{ const snap=await tx.get(ref); if(!snap.exists()){ tx.set(ref,{ name:user.displayName|| (user.email?user.email.split('@')[0]:'Foydalanuvchi'), email:user.email||null, photoURL:user.photoURL||null, role:'student', numericId:Math.floor(1000+Math.random()*9000), points:0, createdAt:Date.now() }); } }); const data=(await getDoc(ref)).data(); return data; }

watchAuth(async(user)=>{
  if(!user){ currentUserId=null; lockLogin(); return; }
  currentUserId=user.uid; showApp(); initContent();
  onSnapshot(query(collection(db,'users'), orderBy('points','desc'), limit(100)), (snap)=>{ latestUsers=snap.docs.map(d=>({id:d.id, ...d.data()})); drawDecile(latestUsers,CURRENT_DECILE); });
});

</script>
</body>
</html>
```