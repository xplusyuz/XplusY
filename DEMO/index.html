<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>LeaderMath.UZ — Home + Profil</title>

  <link rel="icon" href="./logo.png" sizes="any">
  <link rel="apple-touch-icon" href="./logo.png">
  <meta name="theme-color" content="#2E8B57"/>

  <style>
  :root{
    --brand:#2E8B57; --bg:#F6FAF7; --bg-2:#ECF4EF; --card:#FFFFFF; --text:#0f1b15;
    --muted:#5f7469; --line:#E3EBE6; --speed:.25s;
    --ring:0 0 0 3px color-mix(in srgb, var(--brand) 38%, transparent);
    --shadow:0 20px 60px rgba(18,40,28,.14);
    --shadow-sm:0 8px 26px rgba(18,40,28,.10);
  }
  *{box-sizing:border-box}
  html,body{height:100%; overscroll-behavior:contain}
  body{
    margin:0; color:var(--text);
    font:16px/1.55 system-ui,Segoe UI,Inter,Arial;
    background:
      radial-gradient(1200px 600px at 15% -10%, #d9f0e4 0, #0000 60%),
      radial-gradient(1400px 700px at 110% 10%, #e5f6ed 0, #0000 60%),
      linear-gradient(180deg,var(--bg),var(--bg-2));
  }

  /* ===== Header / Chipbar stacking ===== */
  .hdr{ position:sticky; top:0; z-index:90;
    backdrop-filter:saturate(1.1) blur(10px);
    background:linear-gradient(180deg, color-mix(in srgb, var(--card) 85%, transparent), transparent);
    border-bottom:1px solid color-mix(in srgb, var(--line) 60%, transparent);
  }
  .row{max-width:1180px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:14px}
  .brand{display:flex;align-items:center;gap:12px;font-weight:800; perspective:800px}
  .brand img{width:52px;height:52px;border-radius:12px;display:block;
    box-shadow:0 6px 24px rgba(46,139,87,.25); transform:rotateX(6deg) rotateY(-8deg);
    transition:transform .6s cubic-bezier(.2,.8,.2,1);}
  .brand:hover img{ transform:rotateX(0) rotateY(0) translateZ(4px) }
  .brand b{color:var(--brand)} .grow{flex:1}

  .chipbar-wrap{ position:sticky; top:66px; z-index:80;
    background:linear-gradient(180deg, color-mix(in srgb, var(--card) 72%, transparent), transparent);
    border-bottom:1px solid color-mix(in srgb,var(--line) 60%, transparent);
    backdrop-filter:saturate(1.05) blur(6px);
  }
  .chipbar{
    max-width:1180px; margin:0 auto; padding:8px 16px 12px;
    display:flex; gap:10px; overflow-x:auto; overflow-y:hidden; -webkit-overflow-scrolling:touch;
    scroll-behavior:smooth; scroll-snap-type:x proximity;
  }
  .chipbar::-webkit-scrollbar{display:none} .chipbar{scrollbar-width:none}
  .chip{
    appearance:none; border:1px solid var(--line); background:var(--card);
    border-radius:999px; padding:10px 14px; cursor:pointer; user-select:none;
    box-shadow:var(--shadow-sm);
    transition:transform var(--speed), box-shadow var(--speed), background var(--speed), color var(--speed);
    font-weight:700; scroll-snap-align:center; white-space:nowrap; transform-style:preserve-3d;
  }
  .chip:hover{transform:translateY(-1px) translateZ(8px) rotateX(2deg); box-shadow:var(--shadow)}
  .chip.active{background:linear-gradient(180deg, color-mix(in srgb, var(--brand) 92%, #fff), var(--brand));
    color:#fff; border-color:transparent; transform:translateY(-1px) translateZ(10px)}

  /* ===== Sections / Banner containers ===== */
  main{max-width:1180px;margin:0 auto;padding:14px 16px 56px}
  .section{
    background:var(--card); border:1px solid var(--line); border-radius:22px;
    box-shadow:var(--shadow); overflow:hidden;
    transition:transform var(--speed), box-shadow var(--speed), opacity var(--speed);
    margin-bottom:14px; transform-style:preserve-3d; animation:pop .5s cubic-bezier(.2,.8,.2,1);}
  @keyframes pop{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}
  .section:hover{transform:translateY(-2px)}
  .section-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
  .section-hdr h3{margin:0;font-size:18px}

  .iframe-wrap{position:relative}
  iframe.sbx{display:block;width:100%;border:0;background:transparent;contain:paint;transform:translateZ(0)}

  /* asBody util + fixed full-screen variant */
  .as-body{ background:transparent; border:none; box-shadow:none; border-radius:0; margin:0; }
  .asbody-fixed{
    position:fixed; left:0; right:0; bottom:0; margin:0; border:none; border-radius:0; box-shadow:none; background:transparent; z-index:70;
  }
  .asbody-fixed .iframe-wrap, .asbody-fixed .sbx{ width:100%; height:100%; }

  /* Aspect-fit (PC 16:9, mobile 9:16) */
  .fitbox{width:100%; display:grid; place-items:center}
  .fitbox::before{content:""; display:block; width:100%;}
  @media (min-width:900px){ .fitbox::before{ aspect-ratio:16/9 } }
  @media (max-width:899.9px){ .fitbox::before{ aspect-ratio:9/16 } }
  .fitbox > .sbx{ position:absolute; inset:0; width:100%; height:100% }

  /* ===== Auth + User chip ===== */
  .lock{position:fixed;inset:0;display:grid;place-items:center;background:color-mix(in srgb,var(--bg) 70%, #0000);z-index:100}
  .card{width:min(520px,96vw);background:var(--card);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);padding:22px}
  .btn{appearance:none;border:1px solid var(--line);background:var(--card);padding:12px 16px;border-radius:14px;cursor:pointer;transition:transform .16s,box-shadow .16s;background-clip:padding-box;font-weight:800}
  .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-sm)}
  .btn.primary{background:linear-gradient(180deg, #7fd1a5, var(--brand));color:#fff;border-color:transparent}
  .btn.full{width:100%}
  .fld{display:grid;gap:8px;margin:10px 0}
  .fld input,.fld select{width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--line);background:linear-gradient(180deg,var(--card),color-mix(in srgb,var(--card) 92%,#000))}
  .rowx{display:flex;align-items:center;gap:10px;flex-wrap:wrap} #err{color:#c62828;min-height:18px}

  .userchip{border:1px solid var(--line);background:var(--card);padding:6px 10px;border-radius:999px;box-shadow:var(--shadow-sm);display:flex;align-items:center;gap:10px;cursor:pointer;position:relative;transform-style:preserve-3d}
  .avatar{width:32px;height:32px;border-radius:50%;overflow:hidden;background:linear-gradient(135deg,#dcefe5,#f1faf5)}
  .avatar img{width:100%;height:100%;object-fit:cover;display:block;transform:translateZ(6px)}

  /* === PORTAL MENYU (bodyga ko‘tarilgan, fixed + yuqori z-index) === */
  .menu{
    position:fixed; min-width:280px; background:var(--card);
    border:1px solid var(--line); border-radius:16px;
    box-shadow:0 16px 50px rgba(16,32,24,.18), 0 2px 10px rgba(16,32,24,.06);
    display:none; overflow:hidden; z-index:9999;
  }
  .menu.open{display:block}
  .menu a{display:flex;align-items:center;gap:10px;padding:12px 14px;text-decoration:none;color:inherit;border-bottom:1px solid color-mix(in srgb,var(--line) 80%, transparent)}
  .menu a:last-child{border-bottom:none}
  .menu .label{padding:8px 14px;font-size:12px;color:var(--muted);border-bottom:1px solid var(--line);background:color-mix(in srgb,var(--card) 60%, transparent)}
  .ico{width:18px;height:18px;display:inline-block}

  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.18);display:none;place-items:center;z-index:110}
  .overlay.show{display:grid}
  .profile-card{width:min(820px,96vw);background:var(--card);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);padding:22px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px} .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
  .muted{color:var(--muted)} .divider{height:1px;background:var(--line);margin:12px 0}
  @media (max-width:900px){.grid2,.grid3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header class="hdr" id="hdr">
    <div class="row">
      <div class="brand">
        <img src="./logo.png" alt="LM"/>
        <div style="display:grid;line-height:1.1">
          <span style="font-size:18px;font-weight:800">LeaderMath.<b style="color:var(--brand)">UZ</b></span>
          <small style="color:var(--muted)">Matematika platformasi</small>
        </div>
      </div>
      <div class="grow"></div>
      <div id="user-slot"></div>
    </div>

    <div class="chipbar-wrap" id="chipwrap">
      <nav id="chipbar" class="chipbar" aria-label="Bo‘limlar"></nav>
    </div>
  </header>

  <main id="app"><div id="sections"></div></main>

  <!-- overlay va portal-root -->
  <div id="overlay" class="overlay"></div>
  <div id="portal-root"></div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, setPersistence, browserLocalPersistence, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getStorage } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
    authDomain: "xplusy-760fa.firebaseapp.com",
    projectId: "xplusy-760fa",
    storageBucket: "xplusy-760fa.appspot.com",
    messagingSenderId: "992512966017",
    appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
    measurementId: "G-459PLJ7P7L"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  getStorage(app);
  try { await setPersistence(auth, browserLocalPersistence); } catch {}

  const q=(s,r=document)=>r.querySelector(s); const qa=(s,r=document)=>[...r.querySelectorAll(s)];
  const ALWAYS_REQ=['firstName','lastName','birthDate','region','district','role'];
  let REGIONS=[]; let CURRENT_USER=null; let PROFILE=null; let USER_POINTS=0;

  const calcAge=iso=>{try{const b=new Date(iso),t=new Date();let a=t.getFullYear()-b.getFullYear();const m=t.getMonth()-b.getMonth();if(m<0||(m===0&&t.getDate()<b.getDate()))a--;return a;}catch{return '';}};
  async function getProfile(uid){const s=await getDoc(doc(db,'profiles',uid));return s.exists()?s.data():null;}
  async function saveProfile(uid,data){data.updatedAt=serverTimestamp();if(!PROFILE)data.createdAt=serverTimestamp();await setDoc(doc(db,'profiles',uid),data,{merge:false});PROFILE=data;}
  async function getUserPoints(uid){try{const s=await getDoc(doc(db,'users',uid));return s.exists()?(s.data().points||0):0;}catch{return 0;}}

  async function loadRegions(){
    try{const r=await fetch('./region.json',{cache:'no-store'});if(!r.ok)throw 0;const j=await r.json();return j?.regions||[];}
    catch{return[{name:"Toshkent",districts:[{name:"Chilonzor",schools:["1-maktab","12-maktab"]},{name:"Olmazor",schools:["5-maktab","14-maktab"]}]},{name:"Samarqand",districts:[{name:"Urgut",schools:["3-maktab","28-maktab"]}]}];}
  }

  /* ===== User chip & PORTAL menu ===== */
  const svgPhone='<svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M6.6 10.2c1.5 2.9 3.9 5.2 6.8 6.8l2.3-2.3c.3-.3.8-.4 1.2-.3 1 .3 2 .4 3 .4.7 0 1.1.5 1.1 1.1V20c0 .7-.5 1.1-1.1 1.1C10.6 21.1 2.9 13.4 2.9 3.1 2.9 2.5 3.4 2 4.1 2h3.1c.7 0 1.1.5 1.1 1.1 0 1 .1 2 .4 3 .1.4 0 .9-.3 1.2L6.6 10.2z"/></svg>';
  const svgMail ='<svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5L4 8V6l8 5 8-5v2z"/></svg>';
  const svgTg   ='<svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M9.4 15.6 9.1 19c.4 0 .6-.2.9-.4l2-1.8 4.2 3.1c.8.5 1.4.2 1.6-.7l2.9-13.7c.3-1.3-.5-1.8-1.3-1.5L2.6 9.6c-1.3.5-1.3 1.2-.2 1.5l4.8 1.5 11.3-7c.5-.3 1-.1 .6.2"/></svg>';
  const svgIg   ='<svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm5 5a5 5 0 1 0 .001 10.001A5 5 0 0 0 12 7zm0 2.5a2.5 2.5 0 1 1-.001 5.001A2.5 2.5 0 0 1 12 9.5zm5.2-3a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/></svg>';
  const svgYt   ='<svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M23.5 6.2s-.2-1.6-.9-2.3c-.9-.9-1.8-.9-2.2-1C16.9 2.5 12 2.5 12 2.5h-.1s-4.9 0-8.4.4c-.4.1-1.3.1-2.2 1-.7.7-.9 2.3-.9 2.3S0 8.1 0 10v1.9c0 1.9.5 3.8.5 3.8s.2 1.6.9 2.3c.9.9 2.1.9 2.6 1 1.9.2 8 .4 8 .4s4.9 0 8.4-.4c.4-.1 1.3-.1 2.2-1 .7-.7.9-2.3.9-2.3S24 13.8 24 12V10c0-1.9-.5-3.8-.5-3.8zM9.5 14.6V7.9l6.4 3.3-6.4 3.4z"/></svg>';

  function renderUserChip(u, profile){
    const slot=q('#user-slot');
    const age=profile?.birthDate?calcAge(profile.birthDate):'';
    const name=profile?.firstName?(profile.firstName+(profile.lastName?' '+profile.lastName:'')):(u.displayName||u.email||'Foydalanuvchi');
    const avatar=profile?.avatarUrl||u.photoURL||'';
    const role=profile?.role||'—';
    slot.innerHTML=`
      <div class="userchip" id="userchip">
        <div class="avatar">${avatar?`<img src="${avatar}" alt="">`:''}</div>
        <div style="display:grid;line-height:1"><b style="font-size:14px">${name}</b><small class="mini">${role} • ${age?age+' yosh • ':''}${USER_POINTS} points</small></div>
        <div class="menu" id="usermenu">
          <a href="#" id="mProfile">Profil</a>
          <a href="#" id="mEdit">Profilni tahrirlash</a>
          <a href="#" id="mLogout">Chiqish</a>
          <div class="label">Aloqa</div>
          <a href="tel:+998901234567">${svgPhone} +998 90 123 45 67</a>
          <a href="mailto:info@leadermath.uz">${svgMail} info@leadermath.uz</a>
          <a href="https://t.me/LeaderMathUZ" target="_blank" rel="noopener">${svgTg} Telegram</a>
          <a href="https://t.me/LeaderMathBot" target="_blank" rel="noopener">${svgTg} Bot</a>
          <a href="https://instagram.com/leadermath.uz" target="_blank" rel="noopener">${svgIg} Instagram</a>
          <a href="https://www.youtube.com/@leadermathuz" target="_blank" rel="noopener">${svgYt} YouTube</a>
        </div>
      </div>`;
    const chip=q('#userchip',slot), menu=q('#usermenu',slot);

    chip.onclick=(e)=>{ if(e.target.closest('a')) return;
      if(menu.classList.contains('open')) closeUserMenu(); else openUserMenu(); };

    q('#mLogout',slot).onclick=e=>{e.preventDefault();closeUserMenu();signOut(auth);};
    q('#mProfile',slot).onclick=e=>{e.preventDefault();closeUserMenu();openProfileView();};
    q('#mEdit',slot).onclick=e=>{e.preventDefault();closeUserMenu();openProfileEditor();};
  }

  /* ===== Portal menyu joylash ===== */
  function openUserMenu(){
    const chip = document.getElementById('userchip');
    const menu = document.getElementById('usermenu');
    if(!chip||!menu) return;

    const portal = document.getElementById('portal-root') || document.body;
    portal.appendChild(menu);

    // Avval ko'rinadigan holatga keltiramiz o'lcham olish uchun
    menu.style.visibility='hidden'; menu.style.display='block';

    const r = chip.getBoundingClientRect();
    const mw = menu.offsetWidth, mh = menu.offsetHeight, gap = 8;

    let left = Math.min(Math.max(r.right - mw, 8), window.innerWidth - mw - 8);
    let top  = r.bottom + gap;
    if (top + mh > window.innerHeight - 8) top = Math.max(8, r.top - gap - mh);

    menu.style.left = left+'px';
    menu.style.top  = Math.max(8, top) + 'px';
    menu.classList.add('open'); menu.style.visibility='visible';

    const closeOnOutside = (e)=>{ if(!menu.contains(e.target) && !chip.contains(e.target)) closeUserMenu(); };
    const onScrollResize = ()=> positionUserMenu();

    function positionUserMenu(){
      if(!menu.classList.contains('open')) return;
      const r2 = chip.getBoundingClientRect();
      let L = Math.min(Math.max(r2.right - mw, 8), window.innerWidth - mw - 8);
      let T = r2.bottom + gap;
      if (T + mh > window.innerHeight - 8) T = Math.max(8, r2.top - gap - mh);
      menu.style.left = L+'px'; menu.style.top = Math.max(8, T)+'px';
    }

    menu._closers = { closeOnOutside, onScrollResize };
    addEventListener('click', closeOnOutside, { capture:true });
    addEventListener('scroll', onScrollResize, { passive:true });
    addEventListener('resize', onScrollResize, { passive:true });
  }

  function closeUserMenu(){
    const menu = document.getElementById('usermenu');
    if(!menu) return;
    menu.classList.remove('open'); menu.style.display='none';
    if(menu._closers){
      removeEventListener('click', menu._closers.closeOnOutside, { capture:true });
      removeEventListener('scroll', menu._closers.onScrollResize);
      removeEventListener('resize', menu._closers.onScrollResize);
      menu._closers=null;
    }
    const chip = document.getElementById('userchip');
    if(chip) chip.appendChild(menu);
  }

  /* ===== Overlay placeholders ===== */
  const showOverlay=html=>{const ov=q('#overlay'); ov.innerHTML=html; ov.classList.add('show');};
  const closeOverlay=()=>{const ov=q('#overlay'); ov.classList.remove('show'); ov.innerHTML='';};
  function openProfileView(){ /* ... */ }
  function openProfileEditor(){ /* ... */ }

  /* ===== Home sections ===== */
  async function fetchHome(){
    try{const s=await getDoc(doc(db,'configs','home')); if(s.exists()){const d=s.data(); if(Array.isArray(d.sections)) return d;}}catch(e){}
    const r=await fetch('./home.json',{cache:'no-store'}); if(!r.ok) return {sections:[]}; return await r.json();
  }
  const state={sections:[],activeId:null};

  async function loadHome(){
    const d=await fetchHome();
    state.sections=Array.isArray(d.sections)?d.sections:[];
    renderChips(); renderSections();
    if(state.sections.length) activate(state.sections[0].id||'sec0');
  }

  function renderChips(){
    const bar=q('#chipbar'); bar.innerHTML='';
    state.sections.forEach((s,i)=>{
      const b=document.createElement('button');
      b.className='chip'+(i===0?' active':'');
      b.textContent=s.title||s.id||('Bo‘lim '+(i+1));
      b.dataset.target=s.id||('sec'+i);
      b.onclick=()=>{ activate(b.dataset.target);
        b.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'}); };
      bar.appendChild(b);
    });
  }

  function makeIframeForSection(s){
    const ifr=document.createElement('iframe');
    ifr.className='sbx';
    const sandbox = s.sandbox || 'allow-scripts allow-same-origin allow-forms';
    ifr.setAttribute('sandbox', sandbox);

    if(s.mode==='url' && s.src){
      ifr.src=s.src;
    }else{
      const base = s.baseHref ? `<base href="${s.baseHref}">` : '';
      ifr.srcdoc = `<!doctype html><html><head>${base}
        <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
        <style>html,body{height:100%;margin:0;overflow:hidden;background:transparent}</style>
      </head><body>${s.contentHtml||''}</body></html>`;
    }

    ifr.addEventListener('load', ()=>{ try{
      const d=ifr.contentDocument; d.documentElement.style.height='100%'; d.body.style.height='100%'; d.body.style.overflow='hidden';
    }catch{} });

    return ifr;
  }

  function renderSections(){
    const host=q('#sections'); host.innerHTML='';
    state.sections.forEach((s,i)=>{
      const id=s.id||('sec'+i), asBody=!!s.asBody;
      const outer=document.createElement('section');
      outer.className='section'+(asBody?' as-body':''); outer.dataset.section=id;

      if(s.title && !asBody){
        const sh=document.createElement('div'); sh.className='section-hdr';
        sh.innerHTML='<h3>'+(s.title||'')+'</h3>'; outer.appendChild(sh);
      }

      const wrap=document.createElement('div');
      wrap.className = asBody ? 'iframe-wrap' : 'iframe-wrap fitbox';
      const ifr = makeIframeForSection(s);
      wrap.appendChild(ifr); outer.appendChild(wrap); host.appendChild(outer);
    });
  }

  /* ===== Full-screen sizing for asBody (scrollsiz) ===== */
  function sizeActiveSection(){
    const active = document.querySelector('[data-section].showing');
    const asBody = active?.classList.contains('as-body');
    const hdrH   = (document.getElementById('hdr')?.getBoundingClientRect().height||0);
    const chipH  = (document.getElementById('chipwrap')?.getBoundingClientRect().height||0);
    const topH   = Math.round(hdrH + chipH);

    const vv = window.visualViewport?.height || window.innerHeight;
    const freeH = Math.max(0, vv - topH);

    if(asBody && active){
      document.documentElement.style.overflow='hidden';
      document.body.style.overflow='hidden';
      active.classList.add('asbody-fixed');
      active.style.top = topH + 'px';
      const ifr = active.querySelector('iframe.sbx');
      if(ifr){ ifr.style.height = freeH + 'px'; }
    }else{
      document.documentElement.style.overflow='';
      document.body.style.overflow='';
      document.querySelectorAll('.asbody-fixed').forEach(el=>{
        el.classList.remove('asbody-fixed'); el.style.top='';
        const f=el.querySelector('iframe.sbx'); if(f) f.style.height='';
      });
    }
  }

  function activate(id){
    state.activeId=id;
    document.querySelectorAll('.chip').forEach(c=>c.classList.toggle('active',c.dataset.target===id));
    document.querySelectorAll('[data-section]').forEach(s=>{
      const show=(s.dataset.section===id); s.style.display = show?'block':'none'; s.classList.toggle('showing', show);
    });
    sizeActiveSection();
  }
  addEventListener('resize', sizeActiveSection);
  addEventListener('orientationchange', sizeActiveSection);

  /* ===== Auth lock (simple) ===== */
  function setLocked(b){const a=q('#app'); if(a) a.hidden=b;}
  function buildAuthLock(){ if(q('#auth-lock')) return q('#auth-lock');
    const lock=document.createElement('div'); lock.id='auth-lock'; lock.className='lock'; lock.hidden=true;
    lock.innerHTML=`<div class="card">
      <div class="rowx" style="align-items:center"><img src="./logo.png" width="28" height="28" style="border-radius:8px"><b>LeaderMath.UZ</b></div>
      <div class="fld"><label>Email</label><input type="email" id="eml" placeholder="email@example.com" autocomplete="username"></div>
      <div class="fld"><label>Parol</label><input type="password" id="pwd" placeholder="••••••••" autocomplete="current-password"></div>
      <div id="err"></div>
      <div class="rowx"><button id="login" class="btn primary">Kirish</button><button id="signup" class="btn">Ro‘yxatdan o‘tish</button></div>
      <div style="height:10px"></div>
      <button id="google" class="btn full"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18" style="vertical-align:-3px"> Google bilan kirish</button>
    </div>`;
    document.body.appendChild(lock);
    lock.addEventListener('click', async (e)=>{
      const id=e.target.id; const errEl=q('#err',lock);
      const busy=b=>qa('button',lock).forEach(x=>x.disabled=b);
      try{
        busy(true);
        if(id==='google') await signInWithPopup(auth,new GoogleAuthProvider());
        if(id==='login'){ const eml=q('#eml',lock).value.trim(), pwd=q('#pwd',lock).value; await signInWithEmailAndPassword(auth,eml,pwd); }
        if(id==='signup'){ const eml=q('#eml',lock).value.trim(), pwd=q('#pwd',lock).value; await createUserWithEmailAndPassword(auth,eml,pwd); }
      }catch(err){ if(errEl) errEl.textContent=err?.message||String(err); }
      finally{ busy(false); }
    });
    return lock;
  }

  onAuthStateChanged(auth, async (u)=>{
    const lock=buildAuthLock(); CURRENT_USER=u||null;
    if(!u){ setLocked(true); lock.style.removeProperty('display'); lock.hidden=false; q('#user-slot').innerHTML=''; return; }
    setLocked(false); lock.style.display='none'; setTimeout(()=>{ try{ lock.remove(); }catch{} }, 0);

    if(!REGIONS.length) REGIONS=await loadRegions();
    [PROFILE, USER_POINTS] = await Promise.all([ getProfile(u.uid), getUserPoints(u.uid) ]);
    if(PROFILE && !PROFILE.role){ PROFILE.role='O‘quvchi'; await saveProfile(u.uid, PROFILE); }
    const baseOk = ALWAYS_REQ.every(k=>PROFILE && PROFILE[k]); let ok = baseOk; if(PROFILE?.role==='O‘quvchi'){ ok = ok && !!PROFILE.class; }
    if(!ok){ setLocked(true); openProfileEditor(); } else { renderUserChip(u, PROFILE); }
  });

  // chip scroll to center + tilt
  document.addEventListener('pointerdown', (e)=>{
    const t = e.target.closest('.chip'); if(!t) return;
    t.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'});
  });
  q('#chipbar').addEventListener('mousemove', (e)=>{
    const t=e.target.closest('.chip'); if(!t) return;
    const r=t.getBoundingClientRect(), x=(e.clientX-r.left)/r.width, y=(e.clientY-r.top)/r.height;
    const rx=(.5-y)*6, ry=(x-.5)*10;
    t.style.transform=`rotateX(${rx}deg) rotateY(${ry}deg) translateZ(10px)`;
  }, {passive:true});
  q('#chipbar').addEventListener('mouseleave', ()=>{ qa('.chip').forEach(c=>c.style.transform=''); });

  await loadHome();
  sizeActiveSection();
  </script>
</body>
</html>
