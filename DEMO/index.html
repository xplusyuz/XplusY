<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>LeaderMath.UZ — Home (PRO)</title>
  <link rel="icon" href="./logo.png" sizes="any">
  <meta name="theme-color" content="#2E8B57">

  <style>
  /* ====== DESIGN TOKENS ====== */
  :root{
    --brand:#2E8B57; --brand-2:#1e6b43;
    --bg:#F6FAF7; --bg-2:#ECF4EF; --card:#fff; --text:#0f1b15; --muted:#5f7469;
    --line:#E3EBE6; --radius:22px; --radius-sm:14px; --shadow:0 22px 70px rgba(18,40,28,.14);
    --shadow-sm:0 8px 24px rgba(18,40,28,.10); --speed:.25s;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0c1511; --bg-2:#0d1813; --card:#0f1b15; --text:#f3f7f4; --muted:#9cb5a7; --line:#20362b; }
    body{color-scheme:dark;}
  }

  /* ====== RESET ====== */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--text);font:16px/1.55 system-ui,Segoe UI,Inter,Arial;
    background:
      radial-gradient(1200px 600px at 15% -10%, #d9f0e4 0, #0000 60%),
      radial-gradient(1400px 700px at 110% 10%, #e5f6ed 0, #0000 60%),
      linear-gradient(180deg,var(--bg),var(--bg-2));
  }

  /* ====== APP SHELL ====== */
  header.hdr{position:sticky;top:0;z-index:50;backdrop-filter:saturate(1.05) blur(10px);
    background:linear-gradient(180deg, color-mix(in srgb,var(--card) 86%,transparent), transparent);
    border-bottom:1px solid color-mix(in srgb,var(--line) 70%, transparent);}
  .row{max-width:1180px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:14px}
  .brand{display:flex;align-items:center;gap:12px;font-weight:900}
  .brand img{width:52px;height:52px;border-radius:12px;display:block;box-shadow:0 6px 24px rgba(46,139,87,.25)}
  .brand b{color:var(--brand)}
  .grow{flex:1}

  .chipbar-wrap{position:sticky;top:66px;z-index:40;backdrop-filter:saturate(1.05) blur(6px);
    background:linear-gradient(180deg, color-mix(in srgb, var(--card) 72%, transparent), transparent);
    border-bottom:1px solid color-mix(in srgb,var(--line) 60%, transparent);}
  .chipbar{max-width:1180px;margin:0 auto;padding:8px 16px 12px;display:flex;gap:10px;overflow:auto hidden;scroll-behavior:smooth}
  .chipbar::-webkit-scrollbar{display:none}
  .chip{appearance:none;border:1px solid var(--line);background:var(--card);border-radius:999px;padding:10px 14px;
    cursor:pointer;box-shadow:var(--shadow-sm);font-weight:800;white-space:nowrap;transition:transform .18s, box-shadow .18s, background .18s}
  .chip:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
  .chip.active{background:linear-gradient(180deg, color-mix(in srgb, var(--brand) 92%, #fff), var(--brand)); color:#fff;border-color:transparent}

  main{max-width:1180px;margin:0 auto;padding:14px 16px 56px}
  section.block{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;margin-bottom:14px}
  .block__hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
  .block__hdr h3{margin:0;font-size:18px}
  .block__body{position:relative}

  /* ====== FULLBLEED BANNER (TRUE 100vh WITHOUT SCROLL) ====== */
  .fullbleed{position:relative;width:100%;height:calc(100vh - var(--top-gap,0px));overflow:hidden}
  .fullbleed iframe{position:absolute;inset:0;width:100%;height:100%;border:0;overflow:hidden;background:transparent}

  /* ====== 16:9 SURFACE ====== */
  .ratio{position:relative;width:100%;border-radius:16px;border:1px solid var(--line);overflow:hidden;background:transparent}
  .ratio[data-r="16-9"]::before{content:"";display:block;padding-top:56.25%}
  .ratio>iframe{position:absolute;inset:0;width:100%;height:100%;border:0;background:transparent}

  /* ====== CAROUSEL ====== */
  .carousel{position:relative;background:transparent;touch-action:pan-y pinch-zoom}
  .carousel__track{display:flex;will-change:transform;transition:transform .5s ease}
  @media (prefers-reduced-motion: reduce){ .carousel__track{transition:none} }
  .carousel__slide{min-width:100%;}

  .carousel__btn{position:absolute;top:50%;transform:translateY(-50%);z-index:6;border:1px solid var(--line);
    background:color-mix(in srgb, var(--card) 88%, #fff);border-radius:999px;padding:10px 12px;cursor:pointer;box-shadow:var(--shadow-sm)}
  .carousel__btn:hover{box-shadow:var(--shadow)}
  .carousel__btn--prev{left:10px} .carousel__btn--next{right:10px}

  .carousel__dots{position:absolute;left:0;right:0;bottom:10px;display:flex;gap:8px;justify-content:center;z-index:6}
  .dot{width:10px;height:10px;border-radius:50%;background:#cfe3d8;border:1px solid var(--line);cursor:pointer}
  .dot[aria-current="true"]{background:var(--brand)}

  /* ====== GRID (CARDS) ====== */
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
  @media (min-width:680px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (min-width:960px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media (min-width:1180px){.grid{grid-template-columns:repeat(4,1fr)}}

  .card{border:1px solid var(--line);background:var(--card);border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:10px;box-shadow:var(--shadow-sm)}
  .card h4{margin:0;font-size:16px}
  .row{display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted)}
  .badge{padding:4px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:#f0f7f3}
  .badge.soon{background:#fff8e5;border-color:#f2d48a}
  .badge.active{background:#eaf6ef;border-color:#84d1a8}
  .badge.ended{background:#f5f5f5}
  .btn{appearance:none;border:1px solid var(--line);background:var(--card);padding:10px 14px;border-radius:12px;font-weight:800;cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#7fd1a5,var(--brand));color:#fff;border-color:transparent}
  .btn[disabled]{opacity:.6;cursor:not-allowed}

  /* ====== FILTERS ====== */
  .filters{display:flex;gap:8px;flex-wrap:wrap;padding:12px}
  .fchip{appearance:none;border:1px solid var(--line);background:#fff;border-radius:999px;padding:8px 12px;cursor:pointer;font-weight:800}
  .fchip.active{background:var(--brand);color:#fff;border-color:transparent}

  /* ====== OVERLAY / MODAL (info uchun) ====== */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.18);display:none;place-items:center;z-index:80}
  .overlay.show{display:grid}
  .modal{width:min(820px,96vw);background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  </style>
</head>
<body>
  <!-- ====== HEADER + CHIPBAR ====== -->
  <header class="hdr" id="hdr">
    <div class="row">
      <div class="brand">
        <img src="./logo.png" alt="LeaderMath.UZ">
        <div style="display:grid;line-height:1.1">
          <span style="font-size:18px;font-weight:900">LeaderMath.<b style="color:var(--brand)">UZ</b></span>
          <small class="muted">Matematika platformasi</small>
        </div>
      </div>
      <div class="grow"></div>
      <div class="muted" style="font-weight:700">Bosh sahifa</div>
    </div>
    <div class="chipbar-wrap" id="chipwrap">
      <nav class="chipbar" id="chipbar" aria-label="Bo‘limlar"></nav>
    </div>
  </header>

  <!-- ====== CONTENT ====== -->
  <main id="app">
    <div id="sections"></div>
  </main>

  <div class="overlay" id="overlay" aria-modal="true" role="dialog"></div>

  <script>
  /* ================== DATA (demo) ==================
     Shu strukturani adminda ham yozganmiz: section -> items -> banners/cards + subsections
     time format: 'YYYY-MM-DD HH:MM' (local) */
  const DATA = {
    sections: [
      {
        id:"home",
        title:"Bosh Sahifa",
        fullBleed:true,
        items:[
          { kind:"banner", mode:"html", sandbox:"allow-scripts allow-forms",
            contentHtml: `
              <section style="height:100%;display:grid;place-items:center;background:
                radial-gradient(1200px 600px at 20% 10%, #e9f7ee 0, transparent 60%),
                radial-gradient(1400px 700px at 110% 10%, #e5f6ed 0, transparent 60%);">
                <div style="max-width:960px;padding:24px;text-align:center">
                  <img src="./logo.png" alt="" style="width:88px;height:88px;border-radius:20px;box-shadow:0 12px 40px rgba(46,139,87,.25);margin-bottom:16px">
                  <h1 style="font:900 40px/1.2 system-ui;margin:0 0 8px">Matematika — <span style="color:#2E8B57">oson va qiziqarli</span> bo‘lsin!</h1>
                  <p style="color:#4a6b5a;font-size:18px;margin:0 0 18px">Darslar, testlar, marafonlar va tanlovlar — barchasi LeaderMath.UZ’da.</p>
                  <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
                    <a href="#tests" style="text-decoration:none;border:0;border-radius:12px;padding:12px 18px;font-weight:900;
                      color:#fff;background:linear-gradient(180deg,#7fd1a5,#2E8B57);box-shadow:0 8px 26px rgba(46,139,87,.3)">Boshlash</a>
                    <a href="#about" style="text-decoration:none;border:1px solid #dfe7e2;border-radius:12px;padding:12px 18px;font-weight:900;color:#0f1b15;background:#fff">Batafsil</a>
                  </div>
                </div>
              </section>
            `
          },
          { kind:"banner", mode:"html",
            contentHtml: `
              <section style="height:100%;display:grid;place-items:center;background:
              radial-gradient(1100px 600px at 85% 15%, #eaf7f0 0, transparent 60%)">
                <div style="max-width:940px;padding:20px;text-align:center">
                  <h2 style="font:900 36px/1.2 system-ui;margin:0 0 8px">Premium glass dizayn</h2>
                  <p style="color:#4a6b5a">Mobil, planshet va kompyuterda bir xil sifat — 100% responsiv.</p>
                </div>
              </section>`
          }
        ],
        subsections:[
          {
            id:"ads",
            title:"Reklamalar",
            items:[
              {kind:"banner",mode:"html",
               contentHtml:`<div style="display:grid;place-items:center;height:240px;background:linear-gradient(90deg,#e8f6ef,#f7fbf9)">
                 <b style="font:900 24px/1 system-ui;color:#2E8B57">LeaderMath.UZ — super matematika platformasi!</b>
               </div>`}
            ]
          },
          {
            id:"tests",
            title:"Online testlar",
            items:[
              {kind:"card", title:"Algebra — 1-bosqich", cardStyle:"timed",
               startAt:"2025-11-04 08:00", endAt:"2025-11-10 23:59", ctaLabel:"Boshlash", ctaHref:"/test/alg1",
               infoHtml:"<p>30 ta savol • 45 daqiqa • 1 martalik urinish.</p>"},
              {kind:"card", title:"Geometriya — Express", cardStyle:"available",
               ctaLabel:"Boshlash", ctaHref:"/test/geoX", infoHtml:"<p>15 ta savol • 20 daqiqa.</p>"},
              {kind:"card", title:"Kombinatorika Max", cardStyle:"soon",
               ctaLabel:"Boshlash", infoHtml:"<p>Yaqin kunlarda ishga tushadi.</p>"}
            ]
          }
        ]
      },
      {
        id:"chsblar",
        title:"CHSBLAR (oddiy kartalar)",
        items:[
          {kind:"card", title:"CHSBL — 1", cardStyle:"available", ctaLabel:"Ko‘rish", ctaHref:"#"},
          {kind:"card", title:"CHSBL — 2", cardStyle:"available", ctaLabel:"Ko‘rish", ctaHref:"#"},
          {kind:"card", title:"CHSBL — 3", cardStyle:"available", ctaLabel:"Ko‘rish", ctaHref:"#"},
          {kind:"card", title:"CHSBL — 4", cardStyle:"available", ctaLabel:"Ko‘rish", ctaHref:"#"}
        ]
      }
    ]
  };

  /* ================== UTILS ================== */
  const $ = (sel,root=document)=>root.querySelector(sel);
  const $$ = (sel,root=document)=>[...root.querySelectorAll(sel)];
  const setTopGap = (()=> {
    const ro = new ResizeObserver(()=> {
      const h = $('#hdr')?.getBoundingClientRect().height||0;
      const c = $('#chipwrap')?.getBoundingClientRect().height||0;
      document.documentElement.style.setProperty('--top-gap', (h+c)+'px');
    });
    return ()=>{ ro.observe($('#hdr')); ro.observe($('#chipwrap')); };
  })();

  // time helpers
  const parseLocal=(s)=>{ if(!s) return null; const m=s.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/); if(!m) return null;
    const [,Y,M,D,h,mn]=m; return new Date(+Y,+M-1,+D,+h,+mn,0,0); };
  const fmtDate=(d)=>!d?'-':`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  const msParts=(ms)=>{const sec=Math.max(0,Math.floor(ms/1000)); const d=Math.floor(sec/86400),h=Math.floor((sec%86400)/3600),m=Math.floor((sec%3600)/60),s=sec%60; return {d,h,m,s};};
  const z=n=>String(n).padStart(2,'0');
  const fmtParts=p=>(p.d>0?`${p.d} kun `:'')+`${z(p.h)}:${z(p.m)}:${z(p.s)}`;
  const stateOf = (it)=> {
    if(it.cardStyle==='soon') return 'soon';
    if(it.cardStyle==='timed'){
      const now=new Date(), s=parseLocal(it.startAt), e=parseLocal(it.endAt);
      if(s && now < s) return 'soon';
      if(s && e && now >= s && now <= e) return 'active';
      if(e && now > e) return 'ended';
      return 'active';
    }
    return 'available';
  };
  const ORDER={active:0,soon:1,available:2,ended:3};

  /* ================== COMPONENTS ================== */

  // IframeRenderer (banner)
  function IframeRenderer(item, {full=false, baseHref=''}={}){
    const frame = document.createElement('iframe');
    frame.setAttribute('sandbox', item.sandbox||'allow-scripts allow-forms');
    frame.setAttribute('scrolling','no');
    if(item.mode==='url'){ frame.src = item.src||''; }
    else{
      const base=item.baseHref||baseHref||'';
      frame.srcdoc = `<!doctype html><html><head>${base?`<base href="${base}">`:''}<meta charset="utf-8">
        <style>html,body{height:100%;margin:0;overflow:hidden;background:transparent}</style></head>
        <body>${item.contentHtml||''}</body></html>`;
    }
    if(full){
      const wrap=document.createElement('div'); wrap.className='fullbleed'; wrap.appendChild(frame); return wrap;
    }
    const wrap=document.createElement('div'); wrap.className='ratio'; wrap.dataset.r='16-9'; wrap.appendChild(frame); return wrap;
  }

  // Carousel (banners[] -> slides)
  function Carousel(banners, {full=false, baseHref=''}={}){
    const root=document.createElement('div'); root.className='carousel'; root.setAttribute('role','region'); root.setAttribute('aria-roledescription','karusel');
    const track=document.createElement('div'); track.className='carousel__track'; root.appendChild(track);

    banners.forEach(b=>{
      const slide=document.createElement('div'); slide.className='carousel__slide';
      slide.appendChild(IframeRenderer(b,{full,baseHref}));
      track.appendChild(slide);
    });

    let i=0, timer=null;
    const count=banners.length;
    const set=(idx)=>{ i=(idx+count)%count; track.style.transform=`translateX(${-i*root.clientWidth}px)`; $$('.dot',root).forEach((d,k)=>d.setAttribute('aria-current', k===i?'true':'false')); };
    const play=()=>{ if(matchMedia('(prefers-reduced-motion: reduce)').matches) return; stop(); timer=setInterval(()=>set(i+1),5000); };
    const stop=()=>{ if(timer){clearInterval(timer); timer=null;} };

    if(count>1){
      const prev=document.createElement('button'); prev.className='carousel__btn carousel__btn--prev'; prev.setAttribute('aria-label','Oldingi slayd'); prev.textContent='‹';
      const next=document.createElement('button'); next.className='carousel__btn carousel__btn--next'; next.setAttribute('aria-label','Keyingi slayd'); next.textContent='›';
      const dots=document.createElement('div'); dots.className='carousel__dots'; dots.setAttribute('role','tablist');
      root.appendChild(prev); root.appendChild(next); root.appendChild(dots);

      banners.forEach((_,k)=>{ const dot=document.createElement('button'); dot.className='dot'; dot.setAttribute('role','tab'); dot.setAttribute('aria-label',`Slayd ${k+1}`); dot.onclick=()=>{set(k); play();}; dots.appendChild(dot); });
      prev.onclick=()=>{set(i-1); play();}; next.onclick=()=>{set(i+1); play();};

      // swipe
      let sx=0; track.addEventListener('touchstart',e=>{sx=e.touches[0].clientX; stop();},{passive:true});
      track.addEventListener('touchend',e=>{const dx=e.changedTouches[0].clientX-sx; if(Math.abs(dx)>40){set(i+(dx<0?1:-1));} play();},{passive:true});

      // keyboard
      root.tabIndex=0;
      root.addEventListener('keydown',(e)=>{ if(e.key==='ArrowLeft') {set(i-1); play();} if(e.key==='ArrowRight'){set(i+1); play();} if(e.key==='Home'){set(0); play();} if(e.key==='End'){set(count-1); play();} });

      root.addEventListener('mouseenter',stop);
      root.addEventListener('mouseleave',play);
      window.addEventListener('resize',()=>set(i));
      set(0); play();
    }else{
      set(0);
    }
    return root;
  }

  // Filters (cards)
  const Filters = ()=>{
    const wrap=document.createElement('div'); wrap.className='filters';
    const opts=[['all','Barchasi'],['active','Faol'],['soon','Yaqinda'],['available','Mavjud'],['ended','Tugagan']];
    const api={onChange:null};
    opts.forEach(([k,l],idx)=>{
      const b=document.createElement('button'); b.className='fchip'+(idx===0?' active':''); b.textContent=l; b.dataset.key=k;
      b.onclick=()=>{ $$('.fchip',wrap).forEach(x=>x.classList.toggle('active',x===b)); api.onChange && api.onChange(k); };
      wrap.appendChild(b);
    });
    return [wrap,api];
  };

  // Card
  function Card(it){
    const st=stateOf(it);
    const c=document.createElement('div'); c.className='card'; c.dataset.state=st;

    const row=document.createElement('div'); row.className='row';
    const h=document.createElement('h4'); h.textContent=it.title||'—'; row.appendChild(h);
    const bad=document.createElement('span'); bad.className='badge '+(st==='soon'?'soon':st==='active'?'active':st==='ended'?'ended':''); bad.textContent=(st==='soon'?'Yaqinda':st==='active'?'Faol':st==='ended'?'Tugagan':'Mavjud'); row.appendChild(bad);
    c.appendChild(row);

    if(it.cardStyle==='timed'){
      const s=parseLocal(it.startAt), e=parseLocal(it.endAt);
      const t=document.createElement('div'); t.className='muted'; t.textContent=`Vaqt: ${fmtDate(s)} — ${fmtDate(e)}`; c.appendChild(t);
      const cd=document.createElement('div'); cd.className='muted'; cd.dataset.countdown=''; cd.setAttribute('aria-live','polite'); c.appendChild(cd);
      c._timed={start:s?.getTime()||null,end:e?.getTime()||null};
    }

    const actions=document.createElement('div'); actions.className='row';
    const info=document.createElement('button'); info.className='btn'; info.textContent='ℹ️ Info';
    info.onclick=()=>OpenModal(`<h3 style="margin:0 0 8px">${it.title||''}</h3>${it.infoHtml||'<p class="muted">Ma’lumot tayyorlanmoqda.</p>'}`);
    actions.appendChild(info);

    const a=document.createElement('a'); a.textContent=it.ctaLabel||'Boshlash'; a.className='btn primary';
    if(it.ctaHref && st==='active'){ a.href=it.ctaHref; a.target='_blank'; a.dataset.href=it.ctaHref; a.setAttribute('data-enabled','1'); }
    else { a.classList.remove('primary'); a.setAttribute('disabled',''); }
    actions.appendChild(a);

    c.appendChild(actions);
    return c;
  }

  // Grids
  const CardGrid = (cards)=>{
    const grid=document.createElement('div'); grid.className='grid';
    cards.forEach(it=>grid.appendChild(Card(it)));
    return grid;
  };

  /* ================== RENDERERS ================== */

  function RenderSubSection(ss, inheritBase){
    const box=document.createElement('section'); box.className='block';
    const head=document.createElement('div'); head.className='block__hdr'; head.innerHTML=`<h3>${ss.title||ss.id||'Bo‘lim'}</h3>`;
    const body=document.createElement('div'); body.className='block__body';
    box.appendChild(head); box.appendChild(body);

    const items=Array.isArray(ss.items)?ss.items:[];
    const banners=items.filter(x=>x.kind==='banner');
    let cards=items.filter(x=>x.kind==='card');

    if(banners.length){ body.appendChild(Carousel(banners,{full:!!ss.fullBleed, baseHref:(ss.baseHref||inheritBase||'')})); }

    cards = [...cards].sort((a,b)=>{const oa=ORDER[stateOf(a)]??9, ob=ORDER[stateOf(b)]??9; if(oa!==ob) return oa-ob; const as=parseLocal(a.startAt)?.getTime()||0, bs=parseLocal(b.startAt)?.getTime()||0; return as-bs;});
    if(cards.length){
      const pad=document.createElement('div'); pad.style.padding='12px';
      const [filters,api]=Filters(); pad.appendChild(filters);
      const grid=CardGrid(cards); pad.appendChild(grid);
      api.onChange=(key)=>{ $$('.card',grid).forEach(el=>{const st=el.dataset.state||'available'; el.style.display=(key==='all'||st===key)?'flex':'none';}); };
      body.appendChild(pad);
    }

    const subs=Array.isArray(ss.subsections)?ss.subsections:[];
    subs.forEach(s2=> body.appendChild(RenderSubSection(s2, ss.baseHref||inheritBase||'')));

    return box;
  }

  function RenderSection(sec){
    const outer=document.createElement('section'); outer.className='block'; outer.dataset.section=sec.id||'';
    if(!sec.fullBleed){
      const sh=document.createElement('div'); sh.className='block__hdr'; sh.innerHTML=`<h3>${sec.title||sec.id}</h3>`;
      outer.appendChild(sh);
    }
    const body=document.createElement('div'); body.className='block__body';

    const items=Array.isArray(sec.items)?sec.items:[];
    const banners=items.filter(x=>x.kind==='banner');
    let cards=items.filter(x=>x.kind==='card');

    if(banners.length){ body.appendChild(Carousel(banners,{full:!!sec.fullBleed, baseHref:(sec.baseHref||'')})); }

    cards = [...cards].sort((a,b)=>{const oa=ORDER[stateOf(a)]??9, ob=ORDER[stateOf(b)]??9; if(oa!==ob) return oa-ob; const as=parseLocal(a.startAt)?.getTime()||0, bs=parseLocal(b.startAt)?.getTime()||0; return as-bs;});
    if(cards.length){
      const pad=document.createElement('div'); pad.style.padding='12px';
      const [filters,api]=Filters(); pad.appendChild(filters);
      const grid=CardGrid(cards); pad.appendChild(grid);
      api.onChange=(key)=>{ $$('.card',grid).forEach(el=>{const st=el.dataset.state||'available'; el.style.display=(key==='all'||st===key)?'flex':'none';}); };
      body.appendChild(pad);
    }

    const subs=Array.isArray(sec.subsections)?sec.subsections:[];
    subs.forEach(ss=> body.appendChild(RenderSubSection(ss, sec.baseHref||'')) );

    outer.appendChild(body);
    return outer;
  }

  function RenderChips(sections){
    const bar = $('#chipbar'); bar.innerHTML='';
    sections.forEach((s,i)=>{
      const b=document.createElement('button'); b.className='chip'+(i===0?' active':''); b.textContent=s.title||s.id||('Bo‘lim '+(i+1)); b.dataset.target=s.id;
      b.onclick=()=>{ Activate(s.id); b.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'}); };
      bar.appendChild(b);
    });
  }

  function Activate(id){
    $$('[data-section]').forEach(node=>{ node.style.display = (node.dataset.section===id)?'block':'none'; });
    $$('.chip').forEach(ch=>ch.classList.toggle('active', ch.dataset.target===id));
    // fullbleedlar 100vh olishida top-gap doim to‘g‘ri bo‘lsin:
    setTopGap();
  }

  // countdown tick
  setInterval(()=>{
    const now=Date.now();
    $$('[data-countdown]').forEach(node=>{
      const card=node.closest('.card'); if(!card || !card._timed) return;
      const {start,end}=card._timed;
      let txt='';
      if(start && now<start) txt='Boshlanishigacha: '+fmtParts(msParts(start-now));
      else if(end && now<=end) txt='Tugashigacha: '+fmtParts(msParts(end-now));
      else txt='Tugagan';
      node.textContent=txt;

      // state switch + CTA
      const old=card.dataset.state;
      const st=(start&&now<start)?'soon':(end&&now<=end)?'active':'ended';
      if(st!==old){
        card.dataset.state=st;
        const badge=card.querySelector('.badge'); if(badge){ badge.classList.remove('soon','active','ended'); if(st==='soon')badge.classList.add('soon'); if(st==='active')badge.classList.add('active'); if(st==='ended')badge.classList.add('ended'); badge.textContent=(st==='soon'?'Yaqinda':st==='active'?'Faol':'Tugagan'); }
        const cta=card.querySelector('a'); if(cta){
          if(st==='active' && cta.dataset.href){ cta.classList.add('primary'); cta.removeAttribute('disabled'); cta.href=cta.dataset.href; cta.target='_blank'; }
          else { cta.classList.remove('primary'); cta.setAttribute('disabled',''); cta.removeAttribute('href'); cta.removeAttribute('target'); }
        }
      }
    });
  },1000);

  // Info modal
  function OpenModal(html){ const ov=$('#overlay'); ov.innerHTML=`<div class="modal">${html}<div style="text-align:right;margin-top:10px"><button class="btn" id="mClose">Yopish</button></div></div>`; ov.classList.add('show'); $('#mClose',ov).onclick=()=>ov.classList.remove('show'); ov.onclick=(e)=>{if(e.target.id==='overlay') ov.classList.remove('show');}; document.addEventListener('keydown',function onEsc(ev){ if(ev.key==='Escape'){ ov.classList.remove('show'); document.removeEventListener('keydown',onEsc);} }); }

  /* ================== BOOT ================== */
  (function boot(){
    const host = $('#sections'); host.innerHTML='';
    const sections = (Array.isArray(DATA.sections)?DATA.sections:[]).map((s,i)=>({id:s.id||`sec${i+1}`, ...s}));
    RenderChips(sections);
    sections.forEach(s=> host.appendChild( RenderSection(s) ));
    if(sections.length) Activate(sections[0].id);
    setTopGap();
    addEventListener('resize', setTopGap);
    addEventListener('orientationchange', setTopGap);
  })();
  </script>
</body>
</html>
