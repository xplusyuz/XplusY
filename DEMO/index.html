<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>LeaderMath — Fullscreen Carousel + Progress</title>
  <meta name="theme-color" content="#2E8B57"/>
  <link rel="icon" href="./logo.png"/>

  <style>
    :root{ --vh:1vh; --brand:#2E8B57; }
    html,body{margin:0;height:100%;overflow:hidden;background:#000}
    *{box-sizing:border-box}

    .carousel{
      position:fixed; inset:0;
      width:100%; height:calc(var(--vh)*100);
      overflow:hidden; background:#000;
    }
    .slides{
      display:grid; grid-auto-flow:column; grid-auto-columns:100%;
      width:100%; height:100%;
      transition:transform .8s ease-in-out;
    }
    iframe{width:100%;height:100%;border:0;display:block;background:#000}

    /* ozgina vizual halqa */
    .gradient{position:absolute; inset:0; pointer-events:none;
      background:linear-gradient(180deg,rgba(0,0,0,.22),rgba(0,0,0,.08))}
    /* nav */
    .nav-btn{
      position:absolute; top:50%; transform:translateY(-50%);
      width:56px; height:56px; border:none; border-radius:50%;
      background:rgba(255,255,255,.16); color:#fff; font-size:34px; font-weight:900;
      display:grid; place-items:center; cursor:pointer; backdrop-filter:blur(8px);
      transition:background .25s; z-index:20;
    }
    .nav-btn:hover{ background:rgba(255,255,255,.26) }
    .nav-btn.left{ left:20px } .nav-btn.right{ right:20px }
    @media (max-width:700px){
      .nav-btn{ width:42px; height:42px; font-size:26px }
      .nav-btn.left{ left:10px } .nav-btn.right{ right:10px }
    }

    /* progress bar */
    .progress-wrap{
      position:absolute; left:50%; bottom:18px; transform:translateX(-50%);
      width:min(520px,76vw); height:6px; border-radius:999px;
      background:rgba(255,255,255,.18); overflow:hidden; z-index:22;
      backdrop-filter:blur(6px);
      box-shadow:0 2px 10px rgba(0,0,0,.35) inset, 0 1px 0 rgba(255,255,255,.08);
    }
    .progress{
      height:100%; width:0%;
      background:linear-gradient(90deg,#7fd1a5,var(--brand));
      transition:width .12s linear;
    }
  </style>
</head>
<body>
  <div class="carousel" id="carousel">
    <div class="slides" id="slides"></div>
    <div class="gradient"></div>
    <div class="progress-wrap" aria-hidden="true"><div class="progress" id="progress"></div></div>
    <button class="nav-btn left" id="prev">‹</button>
    <button class="nav-btn right" id="next">›</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.appspot.com",
      messagingSenderId: "992512966017",
      appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const q = s => document.querySelector(s);
    function setVH(){ document.documentElement.style.setProperty('--vh',(window.innerHeight*0.01)+'px'); }
    setVH(); addEventListener('resize',setVH); addEventListener('orientationchange',setVH);

    async function loadBanners(){
      try{
        const s = await getDoc(doc(db,'configs','home'));
        if(!s.exists()) throw new Error('home not found');
        const d = s.data();
        const banners = d.sections?.[0]?.subsections?.[0]?.banners || [];
        if(!banners.length) throw new Error('no banners');
        renderCarousel(banners);
      }catch(e){
        console.error(e);
        q('#slides').innerHTML=`<iframe srcdoc="<h1 style='color:white;text-align:center;margin-top:40vh'>Banner topilmadi</h1>"></iframe>`;
      }
    }

    function makeFrame(b){
      const f=document.createElement('iframe');
      f.sandbox=b.sandbox||'allow-scripts allow-forms';
      if(b.mode==='url' && b.src){
        f.src=b.src;
      }else{
        const html=`<!doctype html><html><head>
          <meta charset='utf-8'>
          <meta name='viewport' content='width=device-width,initial-scale=1,viewport-fit=cover'>
          <style>html,body{margin:0;height:100%;overflow:hidden;background:#000}</style>
        </head><body>${b.contentHtml||''}</body></html>`;
        f.srcdoc=html;
      }
      return f;
    }

    function renderCarousel(banners){
      const slides=q('#slides'); const progress=q('#progress'); const car=q('#carousel');
      slides.innerHTML='';
      banners.forEach(b=>{ const w=document.createElement('div'); w.appendChild(makeFrame(b)); slides.appendChild(w); });

      let idx=0, timer=null, raf=null;
      const total=banners.length, interval=5000; // ms
      let startTime=0, pausedAt=0, running=false;

      const setProgress = (p)=>{ progress.style.width = Math.max(0,Math.min(1,p))*100 + '%'; };

      const step = (t)=>{
        if(!running) return;
        if(!startTime) startTime=t;
        const elapsed = t - startTime;
        const p = elapsed / interval;
        setProgress(p);
        if (elapsed >= interval){
          go(idx+1);
          start();
          return;
        }
        raf = requestAnimationFrame(step);
      };

      const start = ()=>{
        stop(true);
        running=true;
        startTime=performance.now();
        raf = requestAnimationFrame(step);
        timer = setInterval(()=>{}, interval); // placeholder to keep symmetry (optional)
      };

      const stop = (keepBar=false)=>{
        running=false;
        if (timer){ clearInterval(timer); timer=null; }
        if (raf){ cancelAnimationFrame(raf); raf=null; }
        if(!keepBar) setProgress(0);
      };

      const go = (n)=>{
        idx = (n+total)%total;
        slides.style.transform = `translateX(-${idx*100}%)`;
        setProgress(0);
      };

      // initial
      if(total>1){ start(); } else { setProgress(1); }

      // hover/touch pause/resume
      const pause = ()=>{ if(!running) return; pausedAt = performance.now() - startTime; stop(true); };
      const resume = ()=>{ if(running) return; startTime = performance.now() - pausedAt; running=true; raf = requestAnimationFrame(step); };

      car.addEventListener('pointerenter', pause);
      car.addEventListener('pointerleave', resume);
      car.addEventListener('touchstart', pause, {passive:true});
      car.addEventListener('touchend', resume, {passive:true});

      // nav buttons
      q('#prev').onclick=()=>{ stop(); go(idx-1); start(); };
      q('#next').onclick=()=>{ stop(); go(idx+1); start(); };

      // swipe
      let sx=0;
      car.addEventListener('touchstart',e=>{ sx=e.touches[0].clientX; }, {passive:true});
      car.addEventListener('touchend',e=>{
        const dx = e.changedTouches[0].clientX - sx;
        if(Math.abs(dx)>50){ stop(); go(dx<0?idx+1:idx-1); start(); }
      }, {passive:true});
    }

    loadBanners();
  </script>
</body>
</html>
