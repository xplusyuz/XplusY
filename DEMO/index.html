<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>LeaderMath ‚Äî Matematika Platformasi</title>
  <meta name="theme-color" content="#2E8B57" id="meta-theme-color"/>
  <link rel="manifest" href="./manifest.webmanifest">
  <link rel="icon" href="./favicon.png">
  <style>
:root{
  --brand:#2E8B57;--brand2:#1F6B45;
  --bg:#f4f8f6;--text:#0d1b14;--muted:#375c4c;--card:#ffffff;
  --frame:#d8e7dd;--frame-strong:#b7d6c5;--chip:#eaf6f0;--chip-b:#cfe7db;
  --radius:16px; --ring:#8ad1b1;
}
:root.dark{
  --bg:#0e1512; --text:#EAF7EE; --muted:#A5C7B4; --card:#142018;
  --frame:#244b39; --frame-strong:#2f6b52; --chip:#132a20; --chip-b:#2a5742; --ring:#2fbf7d;
}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

/* -------- AUTH GUARD -------- */
html.auth-checking #app{display:none}
html.auth-checking #authGate{display:flex}

#authGate{
  position:fixed; inset:0; z-index:9999; display:none;
  align-items:center; justify-content:center; padding:24px;
  background:linear-gradient(135deg, rgba(14,21,18,.85), rgba(31,107,69,.85));
  backdrop-filter: blur(10px);
}
#authCard{
  width:min(560px,96vw);
  background:var(--card);
  border:1px solid var(--frame-strong);
  border-radius:18px;
  padding:20px;
  box-shadow:0 24px 64px rgba(0,0,0,.35);
  text-align:center;
}
#authCard h2{ margin:0 0 6px; font-size:22px }
#authCard p{ margin:0 0 14px; color:var(--muted) }
.auth-row{ display:flex; gap:10px; justify-content:center; margin-top:8px }

/* ====== PREMIUM GLASS BUTTONS ====== */
.btn{
  position:relative; display:inline-flex; align-items:center; justify-content:center; gap:8px;
  padding:10px 14px; border:none; border-radius:12px; cursor:pointer; text-decoration:none;
  font-weight:800; color:#fff; isolation:isolate;
  background:linear-gradient(135deg,var(--brand),var(--brand2));
  box-shadow:0 6px 18px rgba(46,139,87,.25), inset 0 0 0 1px #ffffff22;
  transition:transform .12s ease, box-shadow .12s ease, filter .12s ease;
  backdrop-filter:saturate(120%);
}
.btn::before{
  content:""; position:absolute; inset:0; border-radius:inherit; z-index:-1;
  background:radial-gradient(120% 120% at -10% -10%, rgba(255,255,255,.55), transparent 40%),
             radial-gradient(120% 120% at 110% 110%, rgba(255,255,255,.18), transparent 55%);
  opacity:.9; pointer-events:none;
}
.btn:hover{ transform:translateY(-1px); box-shadow:0 10px 28px rgba(46,139,87,.32), inset 0 0 0 1px #ffffff33 }
.btn:active{ transform:translateY(0); filter:saturate(1.05) }
.btn:focus-visible{ outline:none; box-shadow:0 0 0 4px color-mix(in srgb, var(--ring) 30%, transparent), 0 10px 28px rgba(46,139,87,.32) }
.btn[disabled]{opacity:.5;cursor:not-allowed}

/* Ghost (glass) button */
.btn.ghost{
  background:linear-gradient(180deg,#fff,#f5faf7);
  color:var(--brand2);
  border:1px solid var(--frame);
  box-shadow:0 4px 12px rgba(0,0,0,.06);
}
.dark .btn.ghost{
  background:linear-gradient(180deg,#1a2a21,#17261f);
  color:#c8f0dc; border-color:#2a5742;
}
.btn.ghost:hover{ box-shadow:0 8px 20px rgba(0,0,0,.12) }

/* Ichki UI */
.glass{background:rgba(255,255,255,.6);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)}
.dark .glass{background:rgba(20,32,24,.55)}
.grad-border{position:relative}
.grad-border::before{
  content:""; position:absolute; inset:0; padding:1px; border-radius:14px;
  background:linear-gradient(135deg, #9ce8c0, #2E8B57 40%, #39B6FF);
  -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
  -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none;
}

/* Appbar */
.appbar{position:sticky;top:0;z-index:90;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;padding:10px 12px;display:flex;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
.logo{width:60px;height:60px;border-radius:14px;background:#fff2;display:grid;place-items:center;font-weight:800;overflow:hidden}
.logo img{width:100%;height:100%;object-fit:contain}
.title{font-weight:800;font-size:18px}
.sub{font-size:12px;opacity:.9}
.spacer{flex:1}
.iconbtn{background:#ffffff22;border:1px solid #ffffff33;color:#fff;border-radius:12px;padding:8px 10px;font-weight:700;cursor:pointer}

/* MOBILE header tweaks */
@media (max-width:600px){
  .logo{width:60px;height:60px;border-radius:10px}
  .title{font-size:16px}
  .sub{font-size:10px}
  .uc-chip{scale:.9}
}

/* === Compact User Chip === */
.uc-chip{display:flex;align-items:center;gap:10px;background:var(--card);border:1px solid var(--frame);border-radius:20px;padding:6px 8px 6px 6px;box-shadow:0 10px 24px rgba(0,0,0,.1);transition:.15s ease}
.uc-chip:hover{transform:translateY(-1px);box-shadow:0 16px 36px rgba(0,0,0,.12)}
.uc-ava{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;font-weight:900;display:grid;place-items:center;overflow:hidden;box-shadow:inset 0 0 0 2px #ffffff22}
.uc-ava img{width:100%;height:100%;object-fit:cover}
.uc-more{width:32px;height:32px;border-radius:10px;border:1px solid #ffffff44;background:#ffffff22;cursor:pointer;display:grid;place-items:center;font-size:20px;font-weight:900;color:#fff}

/* === Popover === */
.uc-popover-mask{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:998}
.uc-popover{
  position:fixed;right:14px;top:84px;z-index:999;width:min(520px,94vw);
  background:var(--card);border:1px solid var(--frame-strong);
  border-radius:18px;padding:16px;box-shadow:0 24px 64px rgba(0,0,0,.25);
  display:none;
  background-image:
    radial-gradient(1200px 600px at 10% -20%, rgba(46,139,87,.08), transparent 55%),
    radial-gradient(1200px 600px at 110% 120%, rgba(57,182,255,.08), transparent 55%);
}
.uc-pop-head{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.uc-ava.lg{width:56px;height:56px}
.uc-namebox .uc-fullname{font-weight:900;font-size:18px}
.uc-namebox .uc-sub{color:var(--muted);font-size:12px}
.uc-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0 12px}
@media(max-width:560px){.uc-grid{grid-template-columns:1fr}}
.uc-kv{background:var(--chip);border:1px solid var(--chip-b);border-radius:12px;padding:10px 12px}
.uc-kv .k{font-size:12px;color:var(--muted);margin-bottom:4px}
.uc-kv .v{font-weight:700}
.uc-actions{display:flex;gap:10px;justify-content:flex-end}
.btn-primary{padding:10px 14px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;font-weight:800;cursor:pointer}
.btn-ghost{padding:10px 14px;border:1px solid var(--frame);border-radius:12px;background:#fff;cursor:pointer}
.dark .uc-chip{background:rgba(20,32,24,.65)}
.dark .uc-popover{background:rgba(20,32,24,.85)}

/* Filters (TOP) */
.filters{margin:10px 12px;padding:10px;background:var(--card);border:1px solid var(--frame);border-radius:14px;box-shadow:0 8px 18px rgba(0,0,0,.06)}
.filters h4{margin:0 0 8px;font-size:14px;opacity:.75}
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{display:inline-flex;align-items:center;gap:6px;padding:7px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-b);font-size:12px;cursor:pointer}
.chip[aria-pressed="true"]{background:linear-gradient(135deg,var(--brand),var(--brand2));border-color:#0000;color:#fff}
.chip.sm{font-size:11px;padding:5px 8px}

/* === STORY (banner) === */
.storyWrap{margin:14px 12px;border-radius:18px;overflow:hidden;border:1px solid var(--frame);box-shadow:0 8px 22px rgba(0,0,0,.08);background:linear-gradient(135deg,#f0fff6,#e7f6ee)}
.dark .storyWrap{background:linear-gradient(135deg,#122019,#0f1714)}
.story{position:relative;overflow:hidden}
.story-track{display:flex;will-change:transform;transition:transform .25s ease}
.story-slide{min-width:100%;padding:20px}
.story-progress{position:absolute;top:8px;left:8px;right:8px;display:flex;gap:6px}
.story-bar{flex:1;height:4px;background:#ffffff66;border-radius:999px;overflow:hidden}
.story-bar>span{display:block;height:100%;width:0;background:#fff}

/* === New Premium Card === */
.container{padding:6px 12px 90px}
.grid{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:560px){.grid{grid-template-columns:repeat(2,1fr)}}
@media(min-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}

.ucard{position:relative;border-radius:16px;overflow:hidden;border:1px solid var(--frame);box-shadow:0 12px 32px rgba(0,0,0,.08);background:var(--card);transition:.18s}
.ucard:hover{transform:translateY(-3px);box-shadow:0 18px 44px rgba(0,0,0,.14)}
.ucard .media{position:relative;aspect-ratio:16/9;background:linear-gradient(135deg,#e9f5ef,#f6fbf8);display:grid;place-items:center}
.dark .ucard .media{background:linear-gradient(135deg,#122019,#0f1714)}
.ucard .media img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.ucard .media .titleBig{position:relative;font-size:28px;font-weight:1000;letter-spacing:.2px;text-align:center;color:#fff;text-shadow:0 12px 32px rgba(0,0,0,.55), 0 0 2px rgba(0,0,0,.35)}
.ucard .veil{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;color:#fff;background:linear-gradient(180deg,rgba(0,0,0,.05),rgba(0,0,0,.55));backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px)}
.ucard .veil .badge{display:inline-flex;gap:8px;border:1px solid #ffffff66;background:#ffffff22;color:#fff;border-radius:999px;padding:6px 10px;font-weight:900}
.ucard .body{padding:12px}
.ucard .name{font-size:16px;font-weight:900;margin:0 0 6px}
.ucard .desc{font-size:13px;color:var(--muted);margin:0 0 10px}
.ucard .actions{display:flex;flex-wrap:wrap;gap:8px}
.ucard .meta{font-size:12px;color:var(--muted);margin-top:6px;display:flex;gap:10px;align-items:center}
.ucard .chipline{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.ucard .chipline .chip{background:var(--chip);border-color:var(--chip-b)}

/* PREMIUM MODAL for HTML preview buttons */
.modal-mask {
  position: fixed; inset: 0;
  background: linear-gradient(135deg, rgba(14,21,18,.35), rgba(31,107,69,.35));
  display: none; align-items: center; justify-content: center; z-index: 1000;
  padding: 20px; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
}
.modal {
  background: rgba(255,255,255,.58);
  border: 1px solid var(--frame-strong);
  border-radius: 18px; box-shadow: 0 24px 64px rgba(0,0,0,.35);
  padding: 0; width: min(900px, 96vw); max-height: 90vh; overflow: hidden;
  animation: glassPop .22s ease-out;
  backdrop-filter: saturate(140%) blur(16px); -webkit-backdrop-filter: saturate(140%) blur(16px);
}
.dark .modal{ background: rgba(20,32,24,.78) }
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--frame)}
.modal-body{background:#fff}
.modal-foot{padding:10px;border-top:1px solid var(--frame);display:flex;justify-content:flex-end;gap:8px}
@keyframes glassPop{ from{transform:translateY(8px) scale(.98); opacity:0} to{transform:translateY(0) scale(1); opacity:1} }

/* Leaderboard */
.board{background:var(--card);border:1px solid var(--frame);border-radius:16px;margin:10px 12px;padding:12px;border:none}
.board h3{margin:0 0 8px;font-size:16px}
.group{border:none;border-radius:14px;overflow:hidden;margin:10px 0;box-shadow:0 8px 24px rgba(0,0,0,.06)}
.groupBody{padding:12px}
.groupHead{border:none;border-radius:14px;padding:14px 16px;color:var(--muted);font-weight:900;display:flex;align-items:center;justify-content:space-between;gap:10px}
.dark .groupHead{color:#c7ffe7}
.groupHead.tier-bronze{background:linear-gradient(135deg,#fff1e6,#ffd9c2)}
.groupHead.tier-silver{background:linear-gradient(135deg,#f4f7fb,#dfe7f4)}
.groupHead.tier-gold{background:linear-gradient(135deg,#fff4cc,#ffe48a)}
.groupHead.tier-emerald{background:linear-gradient(135deg,#e3f8ee,#c9f1df)}
.groupHead.tier-diamond{background:linear-gradient(135deg,#e8f8ff,#d8f1ff)}
.tier-badge{font-weight:900;padding:6px 10px;border-radius:999px;border:1px solid var(--frame);background:rgba(255,255,255,.4)}
.rank{display:grid;grid-template-columns:54px 1fr auto;gap:12px;align-items:center;padding:10px;border-radius:12px;border:1px solid var(--frame);margin-bottom:8px;background:var(--card);box-shadow:0 2px 6px rgba(0,0,0,.04);transition:.2s;border:none;position:relative}
.rank:hover{transform:scale(1.02);box-shadow:0 10px 28px rgba(46,139,87,.28)}
.rnk{font-weight:900;background:var(--chip);border:1px solid var(--frame);padding:6px 10px;border-radius:10px}
.m1,.m2,.m3{display:inline-block;width:40px;text-align:center;animation:pulse 1.8s ease-in-out infinite alternate}
@keyframes pulse{0%{filter:drop-shadow(0 0 0 rgba(255,200,0,.0))}100%{filter:drop-shadow(0 0 8px rgba(255,200,0,.35))}}
.stars{display:inline-flex;gap:3px;vertical-align:middle}
.tier-bronze .stars{--s:16}.tier-silver .stars{--s:17}.tier-gold .stars{--s:18}.tier-emerald .stars{--s:20}.tier-diamond .stars{--s:24}
.stars svg{width:calc(var(--s)*1px);height:calc(var(--s)*1px)}
.pager{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:8px 0}
.pbtn{background:var(--chip);border:1px solid var(--frame);border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer}
.pbtn[disabled]{opacity:.5;cursor:not-allowed}
.pinfo{font-size:12px;color:var(--muted)}

/* Form controls */
.ctl {margin-bottom: 10px;}
.ctl label {display: block; margin-bottom: 5px; font-weight: 600; font-size: 14px;}
.ctl input, .ctl select {width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--frame); background: var(--card); color: var(--text); font-size: 14px;}
.hidden {display: none !important;}
.linklike {cursor: pointer; color: var(--brand2); text-decoration: underline; font-size: 12px;}

/* Loading spinner */
.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid rgba(46, 139, 87, 0.2);
  border-left: 4px solid var(--brand);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 20px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-text {
  text-align: center;
  color: var(--muted);
  margin: 10px 0;
}

/* Special section for banners and league */
.special-section {
  margin: 20px 0;
}

.special-section h3 {
  margin: 0 0 12px;
  font-size: 18px;
  color: var(--text);
  font-weight: 800;
}
  </style>
</head>
<body>
  <!-- ===== AUTH GATE ===== -->
  <div id="authGate">
    <div id="authCard" class="grad-border glass">
      <h2>LeaderMath ga xush kelibsiz!</h2>
      <p>Matematika platformasidan foydalanish uchun tizimga kiring</p>
      <div class="auth-row">
        <button id="googleSignIn" class="btn">üîë Google orqali kirish</button>
      </div>
    </div>
  </div>

  <!-- ===== APP ===== -->
  <div id="app">
    <header class="appbar">
      <div class="logo"><img src="./icon-512.png" alt="LeaderMath Logo"></div>
      <div>
        <div class="title">LeaderMath</div>
        <div class="sub">Matematika | Olimpiadalar | Testlar</div>
      </div>
      <div class="spacer"></div>
      <button id="themeBtn" class="iconbtn" title="Dark/Light">üåô</button>
      <div class="uc-chip" id="ucChip" aria-haspopup="dialog" aria-expanded="false">
        <div class="uc-ava" id="ucAva">LM</div>
        <div class="uc-pill"><span class="uc-pill-label">‚≠ê</span><b id="ucPointsVal">‚Äî</b></div>
        <button class="uc-more" id="ucMore" aria-label="Profil">‚ãØ</button>
      </div>
    </header>

    <!-- Popover -->
    <div class="uc-popover-mask" id="ucMask"></div>
    <div class="uc-popover grad-border glass" id="ucPopover" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="uc-pop-head">
        <div class="uc-ava lg" id="ucAvaLg">LM</div>
        <div class="uc-namebox">
          <div class="uc-fullname" id="ucName">Foydalanuvchi</div>
          <div class="uc-sub" id="ucNumeric">ID: ‚Äî</div>
        </div>
      </div>
      <div class="uc-grid">
        <div class="uc-kv"><div class="k">Viloyat</div><div class="v" id="ucRegion">‚Äî</div></div>
        <div class="uc-kv"><div class="k">Tuman</div><div class="v" id="ucDistrict">‚Äî</div></div>
        <div class="uc-kv"><div class="k">Maktab</div><div class="v" id="ucSchool">‚Äî</div></div>
        <div class="uc-kv"><div class="k">Sinf</div><div class="v" id="ucClass">‚Äî</div></div>
        <div class="uc-kv"><div class="k">Telefon</div><div class="v" id="ucPhone">‚Äî</div></div>
      </div>
      <div class="uc-actions">
        <button class="btn-primary" id="ucOpenProfile">üìù Profil</button>
        <button class="btn-ghost" id="ucSignOut">‚¨ÖÔ∏è Chiqish</button>
      </div>
    </div>

    <!-- TOP FILTERS -->
    <section class="filters grad-border glass" id="filtersMain">
      <h4>BO'LIMLAR:</h4>
      <div id="mainTags" class="chips"></div>
    </section>

    <!-- Story (Banner groups) -->
    <section id="storyWrap" class="storyWrap grad-border glass" style="display:none">
      <div style="padding:10px 10px 0"><div id="bannerGroupChips" class="chips"></div></div>
      <div class="story" id="story">
        <div class="story-progress" id="storyProg"></div>
        <div class="story-track" id="storyTrack"></div>
      </div>
    </section>

    <!-- Leaderboard -->
    <section class="board grad-border glass" id="board" style="display:none">
      <h3>Reyting</h3>
      <div class="pager">
        <button id="decilePrev" class="pbtn">‚¨ÖÔ∏è Oldingi</button>
        <div class="pinfo" id="decileInfo">10‚Äì1 (Diamond)</div>
        <button id="decileNext" class="pbtn">Keyingi ‚û°Ô∏è</button>
      </div>
      <div id="boardList"></div>
    </section>

    <div class="container">
      <div id="loadingContent" class="loading-text">
        <div class="spinner"></div>
        <p>Ma'lumotlar yuklanmoqda...</p>
      </div>
      <div id="sections"></div>
    </div>

    <!-- Profile modal -->
    <div id="profileModal" class="modal-mask" aria-modal="true" role="dialog">
      <div class="modal glass grad-border">
        <div class="modal-head">
          <b>Profil ma'lumotlari</b>
          <button id="pClose" class="btn ghost">Yopish</button>
        </div>
        <div class="modal-body" style="padding:14px">
          <div class="grid2" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px">
            <div class="ctl"><label>Ism *</label><input id="pFirst" autocomplete="given-name"></div>
            <div class="ctl"><label>Familiya *</label><input id="pLast" autocomplete="family-name"></div>
          </div>
          <div class="grid3" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px">
            <div class="ctl"><label>Roli *</label>
              <select id="pRole"><option value="student">O'quvchi</option><option value="teacher">O'qituvchi</option></select>
            </div>
            <div class="ctl"><label>Viloyat *</label><select id="pRegion"></select></div>
            <div class="ctl"><label>Tuman/Shahar *</label><select id="pDistrict"></select></div>
          </div>
          <div class="grid3" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px">
            <div class="ctl">
              <label>Maktab *</label>
              <div class="inline-actions" style="display:flex;gap:8px;align-items:center">
                <select id="pSchoolSel" style="flex:1 1 auto"></select>
                <span id="schoolToggle" class="linklike">Ro'yxatda yo'q</span>
              </div>
              <input id="pSchoolCustom" class="hidden" placeholder="Maktab nomini kiriting">
            </div>
            <div class="ctl" id="pGradeWrap"><label>Sinf *</label><select id="pGrade"></select></div>
            <div class="ctl"><label>Telefon *</label><input id="pPhone" placeholder="+998 XX XXX XX XX" autocomplete="tel"></div>
          </div>
          <div class="row" style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px">
            <div class="danger" id="pError" style="flex:1;color:#c62828;font-size:12px;display:flex;align-items:center"></div>
            <button id="pSave" class="btn">Saqlash</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // Firebase konfiguratsiyasi
    const firebaseConfig = {
  apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  authDomain: "xplusy-760fa.firebaseapp.com",
  projectId: "xplusy-760fa",
  storageBucket: "xplusy-760fa.firebasestorage.app",
  messagingSenderId: "992512966017",
  appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
  measurementId: "G-459PLJ7P7L"
};

    // Firebase importlari
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { 
      getAuth, 
      signInWithPopup, 
      GoogleAuthProvider, 
      signOut,
      onAuthStateChanged 
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { 
      getFirestore,
      doc,
      getDoc,
      setDoc,
      updateDoc,
      collection,
      query,
      orderBy,
      limit,
      onSnapshot,
      serverTimestamp,
      getDocs
    } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

    // Firebase ni ishga tushirish
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    /* ==== AUTH GUARD ==== */
    const html = document.documentElement;
    html.classList.add('auth-checking');
    const gate = document.getElementById('authGate');
    const appDiv = document.getElementById('app');

    /* ==== THEME ==== */
    const root = document.documentElement, themeBtn = document.getElementById('themeBtn'), THEME_KEY = 'lm-theme';
    const setTheme = m => {
      root.classList.toggle('dark', m === 'dark');
      localStorage.setItem(THEME_KEY, m);
      if (themeBtn) themeBtn.textContent = m === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    };
    setTheme(localStorage.getItem(THEME_KEY) || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));
    if (themeBtn) themeBtn.onclick = () => setTheme(root.classList.contains('dark') ? 'light' : 'dark');

    /* ==== DOM ELEMENTLARI ==== */
    const el = {
      chip: document.getElementById('ucChip'),
      ava: document.getElementById('ucAva'),
      avaLg: document.getElementById('ucAvaLg'),
      pointsVal: document.getElementById('ucPointsVal'),
      more: document.getElementById('ucMore'),
      mask: document.getElementById('ucMask'),
      pop: document.getElementById('ucPopover'),
      name: document.getElementById('ucName'),
      numeric: document.getElementById('ucNumeric'),
      region: document.getElementById('ucRegion'),
      district: document.getElementById('ucDistrict'),
      school: document.getElementById('ucSchool'),
      klass: document.getElementById('ucClass'),
      openProfile: document.getElementById('ucOpenProfile'),
      signOutBtn: document.getElementById('ucSignOut'),
      sections: document.getElementById('sections'),
      mainTags: document.getElementById('mainTags'),
      loadingContent: document.getElementById('loadingContent'),
      // story
      storyWrap: document.getElementById('storyWrap'),
      story: document.getElementById('story'),
      storyProg: document.getElementById('storyProg'),
      storyTrack: document.getElementById('storyTrack'),
      bannerChips: document.getElementById('bannerGroupChips'),
      // board
      board: document.getElementById('board'),
      boardList: document.getElementById('boardList'),
      decilePrev: document.getElementById('decilePrev'),
      decileNext: document.getElementById('decileNext'),
      decileInfo: document.getElementById('decileInfo'),
      // profile modal
      PM: {
        mask: document.getElementById('profileModal'),
        first: document.getElementById('pFirst'),
        last: document.getElementById('pLast'),
        role: document.getElementById('pRole'),
        rSel: document.getElementById('pRegion'),
        dSel: document.getElementById('pDistrict'),
        schoolSel: document.getElementById('pSchoolSel'),
        schoolCustom: document.getElementById('pSchoolCustom'),
        schoolToggle: document.getElementById('schoolToggle'),
        gradeWrap: document.getElementById('pGradeWrap'),
        grade: document.getElementById('pGrade'),
        ph: document.getElementById('pPhone'),
        err: document.getElementById('pError'),
        save: document.getElementById('pSave'),
        close: document.getElementById('pClose')
      },
      // auth
      googleSignIn: document.getElementById('googleSignIn')
    };

    /* ==== UTIL FUNCTIONS ==== */
    const escapeHtml = (s) => String(s ?? '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
    const initials = n => n ? (n.trim().split(/\s+/).map(x => x[0]).join('').slice(0, 2).toUpperCase()) : 'LM';
    function fmtPoints(v) { const n = Number(v) || 0; return n.toLocaleString('uz-UZ', { maximumFractionDigits: 1 }); }
    function setAvatar(txtOrUrl) {
      const set = n => {
        if (!n) return;
        if (txtOrUrl && /^https?:/.test(txtOrUrl)) n.innerHTML = `<img src="${txtOrUrl}" alt="ava">`;
        else n.textContent = (txtOrUrl || 'LM').slice(0, 2).toUpperCase();
      };
      set(el.ava);
      set(el.avaLg);
    }

    /* ==== APP STATE ==== */
    let MODE = 'story';
    let ACTIVE_BANNER_TAG = null;
    let APP_DATA = { bannerGroups: [], sections: [] };
    let CURRENT_USER = null;
    let CURRENT_PROFILE = null;

    /* ==== AUTHENTICATION ==== */
    // Google orqali kirish
    if (el.googleSignIn) {
      el.googleSignIn.onclick = async () => {
        try {
          const result = await signInWithPopup(auth, provider);
          console.log('Kirish muvaffaqiyatli:', result.user);
        } catch (error) {
          console.error('Kirishda xato:', error);
          alert('Kirishda xatolik: ' + error.message);
        }
      };
    }

    // Auth state changes
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        CURRENT_USER = user;
        await ensureUserProfile(user);
        showApp();
        loadAppData();
      } else {
        CURRENT_USER = null;
        CURRENT_PROFILE = null;
        resetChip();
        lockToLogin();
      }
    });

    // Foydalanuvchi profilini yaratish/yuklash
    async function ensureUserProfile(user) {
      const userRef = doc(db, 'users', user.uid);
      const userSnap = await getDoc(userRef);
      
      if (!userSnap.exists()) {
        // Yangi foydalanuvchi
        const userData = {
          name: user.displayName || 'Foydalanuvchi',
          email: user.email,
          photoURL: user.photoURL,
          role: 'student',
          numericId: Math.floor(1000 + Math.random() * 9000),
          points: 0,
          region: null,
          district: null,
          school: null,
          class: null,
          phone: null,
          createdAt: serverTimestamp(),
          lastLogin: serverTimestamp()
        };
        await setDoc(userRef, userData);
        CURRENT_PROFILE = userData;
      } else {
        // Mavjud foydalanuvchi
        CURRENT_PROFILE = userSnap.data();
        // Last login ni yangilash
        await updateDoc(userRef, {
          lastLogin: serverTimestamp()
        });
      }
      
      setAvatar(user.photoURL || initials(CURRENT_PROFILE.name));
      fillChip(CURRENT_PROFILE);
      
      // Agar profil to'liq emas bo'lsa, profil modalini ochish
      const seenKey = `lm-profile-seen:${user.uid}`;
      if (!profileIsComplete(CURRENT_PROFILE) && !localStorage.getItem(seenKey)) {
        const nm = (CURRENT_PROFILE.name || '').trim().split(/\s+/, 2);
        openProfileModal({
          first: nm[0] || '',
          last: nm[1] || '',
          role: CURRENT_PROFILE.role || 'student',
          region: CURRENT_PROFILE.region || '',
          district: CURRENT_PROFILE.district || '',
          school: CURRENT_PROFILE.school || '',
          klass: CURRENT_PROFILE.class || '',
          phone: CURRENT_PROFILE.phone || ''
        });
        localStorage.setItem(seenKey, '1');
      }
    }

    // Profil to'liqligini tekshirish
    function profileIsComplete(u) {
      const must = !!(u && u.name && /\s/.test(u.name) && u.region && u.district && u.school && u.phone && u.role);
      if (!must) return false;
      if (u.role === 'teacher') return true;
      return !!u.class;
    }

    // Chiqish
    if (el.signOutBtn) {
      el.signOutBtn.onclick = async (e) => {
        e.preventDefault();
        try {
          await signOut(auth);
          closePop();
        } catch (error) {
          console.error('Chiqishda xato:', error);
        }
      };
    }

    /* ==== UI FUNCTIONS ==== */
    function showApp() {
      if (!gate || !appDiv) return;
      gate.style.display = 'none';
      appDiv.style.display = 'block';
      html.classList.remove('auth-checking');
    }

    function lockToLogin() {
      if (!gate || !appDiv) return;
      appDiv.style.display = 'none';
      gate.style.display = 'flex';
      html.classList.remove('auth-checking');
    }

    function resetChip() {
      if (el.ava) el.ava.textContent = 'LM';
      if (el.pointsVal) el.pointsVal.textContent = '‚Äî';
      if (el.name) el.name.textContent = 'Mehmon';
      if (el.numeric) el.numeric.textContent = 'ID: ‚Äî';
      if (el.region) el.region.textContent = '‚Äî';
      if (el.district) el.district.textContent = '‚Äî';
      if (el.school) el.school.textContent = '‚Äî';
      if (el.klass) el.klass.textContent = '‚Äî';
      if (el.phone) el.phone.textContent = '‚Äî';
    }

    function fillChip(u) {
      if (el.name) el.name.textContent = u?.name || 'Foydalanuvchi';
      if (el.numeric) el.numeric.textContent = 'ID: ' + (u?.numericId || '‚Äî');
      if (el.region) el.region.textContent = u?.region || '‚Äî';
      if (el.district) el.district.textContent = u?.district || '‚Äî';
      if (el.school) el.school.textContent = u?.school || '‚Äî';
      if (el.klass) el.klass.textContent = (u?.role === 'teacher') ? '‚Äî (o\'qituvchi)' : (u?.class ? `${u.class}-sinf` : '‚Äî');
      if (el.phone) el.phone.textContent = u?.phone || '‚Äî';
      if (el.pointsVal) el.pointsVal.textContent = fmtPoints(u?.points ?? 0);
    }

    /* ==== DATA LOADING ==== */
    async function loadAppData() {
      try {
        // Banner guruhlarini yuklash
        const bannerQuery = query(collection(db, 'bannerGroups'), orderBy('order'));
        const bannerSnapshot = await getDocs(bannerQuery);
        APP_DATA.bannerGroups = bannerSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // Bo'limlarni yuklash
        const sectionsQuery = query(collection(db, 'sections'), orderBy('order'));
        const sectionsSnapshot = await getDocs(sectionsQuery);
        APP_DATA.sections = sectionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        // UI ni yangilash
        renderBannerChips();
        mountStory();
        renderMainChips();
        MODE = 'story';
        updateVisibility();
        
        // Loading ni yashirish
        if (el.loadingContent) el.loadingContent.style.display = 'none';
        
      } catch (error) {
        console.error('Ma\'lumotlarni yuklashda xato:', error);
        // Agar Firestore dan ma'lumot olinmasa, demo ma'lumotlarni ko'rsatish
        APP_DATA = {
          bannerGroups: [
            {
              tag: "Asosiy",
              items: [
                {
                  html: "<div style='text-align:center;padding:20px;'><h2>LeaderMath ga xush kelibsiz!</h2><p>Matematika bo'yicha qiziqarli materiallar va testlar</p></div>",
                  durationMs: 5000
                }
              ]
            }
          ],
          sections: [
            {
              title: "Matematika",
              tag: "Matematika",
              items: [
                {
                  name: "Algebra",
                  description: "Algebra bo'yicha darsliklar va masalalar",
                  tags: ["9-sinf", "10-sinf"],
                  type: "open",
                  buttons: [
                    { kind: "link", label: "Ochish", href: "#" }
                  ]
                },
                {
                  name: "Geometriya", 
                  description: "Geometriya bo'yicha darsliklar va masalalar",
                  tags: ["9-sinf", "10-sinf"],
                  type: "open",
                  buttons: [
                    { kind: "link", label: "Ochish", href: "#" }
                  ]
                }
              ]
            },
            {
              title: "Bannerlar",
              tag: "story",
              items: [
                {
                  name: "Bannerlar va Reklamalar",
                  description: "Eng so'nggi yangiliklar va e'lonlar",
                  type: "open",
                  buttons: [
                    { kind: "link", label: "Ko'rish", href: "#", action: "showBanners" }
                  ]
                }
              ]
            },
            {
              title: "Reyting",
              tag: "league", 
              items: [
                {
                  name: "O'quvchilar Reytingi",
                  description: "Eng yaxshi o'quvchilar reytingi",
                  type: "open",
                  buttons: [
                    { kind: "link", label: "Ko'rish", href: "#", action: "showLeaderboard" }
                  ]
                }
              ]
            }
          ]
        };
        
        renderBannerChips();
        mountStory();
        renderMainChips();
        MODE = 'story';
        updateVisibility();
        
        if (el.loadingContent) el.loadingContent.style.display = 'none';
      }
    }

    /* ==== MAIN TAGS CHIPS ==== */
    function chipEl(label, pressed = false, onClick = () => {}, extraClass = '') {
      const b = document.createElement('button');
      b.className = 'chip ' + extraClass;
      b.type = 'button';
      b.setAttribute('aria-pressed', pressed ? 'true' : 'false');
      b.appendChild(document.createTextNode(label));
      b.onclick = () => onClick(b);
      return b;
    }

    function collectSectionTags(data) {
      const s = new Set();
      (data.sections || []).forEach(sec => { 
        if (sec.tag && sec.tag !== 'story' && sec.tag !== 'league') {
          s.add(String(sec.tag)); 
        }
      });
      return [...s].sort();
    }

    function renderMainChips() {
      const wrap = el.mainTags;
      if (!wrap) return;
      wrap.innerHTML = '';
      
      // Doimiy bo'limlar (Bannerlar va Reyting)
      wrap.appendChild(chipEl('üé¨ Bannerlar', MODE === 'story', () => { 
        MODE = 'story'; 
        updateVisibility(); 
      }));
      
      wrap.appendChild(chipEl('üèÜ Reyting', MODE === 'league', () => { 
        MODE = 'league'; 
        updateVisibility(); 
      }));
      
      // Dinamik bo'lim teglari
      collectSectionTags(APP_DATA).forEach(t => {
        wrap.appendChild(chipEl(t, MODE === t, () => { 
          MODE = t; 
          updateVisibility(); 
        }));
      });
    }

    /* ==== VISIBILITY UPDATE ==== */
    function updateVisibility() {
      // Story (Bannerlar) mode
      if (el.storyWrap) {
        el.storyWrap.style.display = (MODE === 'story') ? '' : 'none';
      }
      
      // League (Reyting) mode  
      if (el.board) {
        el.board.style.display = (MODE === 'league') ? '' : 'none';
      }
      
      // Sections mode
      const cont = document.querySelector('.container');
      if (cont) {
        cont.style.display = (MODE !== 'story' && MODE !== 'league') ? '' : 'none';
      }
      
      if (MODE !== 'story' && MODE !== 'league') { 
        renderSectionsGrid(); 
      } else {
        // Agar bannerlar yoki reyting tanlangan bo'lsa, ularni maxsus ko'rsatish
        renderSpecialSections();
      }
    }

    /* ==== SPECIAL SECTIONS (Bannerlar va Reyting) ==== */
    function renderSpecialSections() {
      const wrap = el.sections;
      if (!wrap) return;
      wrap.innerHTML = '';
      
      if (MODE === 'story') {
        // Bannerlar bo'limi
        const bannerSection = document.createElement('div');
        bannerSection.className = 'special-section';
        bannerSection.innerHTML = `
          <h3>üé¨ Bannerlar va Reklamalar</h3>
          <p>Eng so'nggi yangiliklar va e'lonlar</p>
          <div class="storyWrap grad-border glass" style="margin-top: 15px;">
            <div class="story" id="mainStory">
              <div class="story-progress" id="mainStoryProg"></div>
              <div class="story-track" id="mainStoryTrack"></div>
            </div>
          </div>
        `;
        wrap.appendChild(bannerSection);
        
        // Asosiy bannerlarni ko'rsatish
        showMainBanners();
      } else if (MODE === 'league') {
        // Reyting bo'limi
        const leagueSection = document.createElement('div');
        leagueSection.className = 'special-section';
        leagueSection.innerHTML = `
          <h3>üèÜ O'quvchilar Reytingi</h3>
          <p>Eng yaxshi o'quvchilar reytingi</p>
          <div class="board grad-border glass" style="margin-top: 15px;">
            <div class="pager">
              <button id="mainDecilePrev" class="pbtn">‚¨ÖÔ∏è Oldingi</button>
              <div class="pinfo" id="mainDecileInfo">10‚Äì1 (Diamond)</div>
              <button id="mainDecileNext" class="pbtn">Keyingi ‚û°Ô∏è</button>
            </div>
            <div id="mainBoardList"></div>
          </div>
        `;
        wrap.appendChild(leagueSection);
        
        // Asosiy reytingni ko'rsatish
        showMainLeaderboard();
      }
    }

    function showMainBanners() {
      const track = document.getElementById('mainStoryTrack');
      const prog = document.getElementById('mainStoryProg');
      
      if (!track || !prog) return;
      
      track.innerHTML = '';
      prog.innerHTML = '';
      
      const grp = (APP_DATA.bannerGroups || [])[0];
      if (!grp || !grp.items || grp.items.length === 0) {
        track.innerHTML = '<div class="story-slide"><h3 style="margin:0">Bannerlar hozircha mavjud emas</h3></div>';
        return;
      }
      
      grp.items.forEach(() => {
        const bar = document.createElement('div');
        bar.className = 'story-bar';
        bar.innerHTML = '<span></span>';
        prog.appendChild(bar);
      });
      
      grp.items.forEach(it => {
        const s = document.createElement('div');
        s.className = 'story-slide';
        s.innerHTML = it.html || '';
        track.appendChild(s);
      });

      let i = 0, raf = null, start = 0, playing = true;
      const spans = [...prog.querySelectorAll('span')];
      const D = () => Math.max(1100, Number(grp.items[i]?.durationMs || 4500));
      const setX = () => track.style.transform = `translateX(${-i * 100}%)`;
      const step = () => {
        const p = Math.min(1, (performance.now() - start) / D());
        spans[i].style.width = (p * 100) + '%';
        if (p < 1 && playing) raf = requestAnimationFrame(step);
        else {
          spans[i].style.width = '100%';
          if (i < grp.items.length - 1) {
            i++;
            setX();
            start = performance.now();
            raf = requestAnimationFrame(step);
          }
        }
      };
      setX();
      start = performance.now();
      raf = requestAnimationFrame(step);
    }

    function showMainLeaderboard() {
      const boardList = document.getElementById('mainBoardList');
      if (!boardList) return;
      
      // Leaderboard ma'lumotlarini ko'rsatish
      drawMainDecile(latestUsers, CURRENT_DECILE);
      
      // Navigation tugmalarini sozlash
      const prevBtn = document.getElementById('mainDecilePrev');
      const nextBtn = document.getElementById('mainDecileNext');
      const info = document.getElementById('mainDecileInfo');
      
      if (prevBtn) {
        prevBtn.onclick = () => {
          if (CURRENT_DECILE > 0) {
            CURRENT_DECILE--;
            drawMainDecile(latestUsers, CURRENT_DECILE);
          }
        };
      }
      
      if (nextBtn) {
        nextBtn.onclick = () => {
          if (CURRENT_DECILE < GROUPS.length - 1) {
            CURRENT_DECILE++;
            drawMainDecile(latestUsers, CURRENT_DECILE);
          }
        };
      }
    }

    /* ==== LEADERBOARD ==== */
    const GROUPS = [
      { label: 'üíé Diamond League', start: 1, end: 10, tier: 'diamond', grad: ['#9FE3FF', '#39B6FF', '#0077FF'] },
      { label: 'üíö Emerald League', start: 11, end: 20, tier: 'emerald', grad: ['#8FE3B0', '#2E8B57', '#1F6B45'] },
      { label: 'ü•á Gold League', start: 21, end: 30, tier: 'gold', grad: ['#FFE082', '#FFC107', '#FF8F00'] },
      { label: 'ü•à Silver League', start: 31, end: 40, tier: 'silver', grad: ['#DDE3EC', '#BFC6D4', '#9AA6B2'] },
      { label: 'ü•â Bronze League', start: 41, end: 50, tier: 'bronze', grad: ['#C69462', '#9A6B3F', '#7C4F2E'] }
    ];
    let CURRENT_DECILE = 0;
    let latestUsers = [];

    // Leaderboard ni real-time kuzatish
    const leaderboardQuery = query(collection(db, 'users'), orderBy('points', 'desc'), limit(50));
    onSnapshot(leaderboardQuery, (snapshot) => {
      latestUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      drawDecile(latestUsers, CURRENT_DECILE);
      drawMainDecile(latestUsers, CURRENT_DECILE);
    });

    function drawDecile(users, ix) {
      const g = GROUPS[ix];
      if (!g) {
        if (el.boardList) el.boardList.innerHTML = '<div class="desc">Hali ma\'lumot yo\'q</div>';
        return;
      }
      const arr = users.slice(0, 50), rows = [];
      for (let r = g.start; r <= g.end; r++) {
        const u = arr[r - 1];
        if (!u) continue;
        const isTop3 = r <= 3;
        const left = isTop3 ? `<span class="medal ${r === 1 ? 'm1' : r === 2 ? 'm2' : 'm3'}">${r === 1 ? 'üèÜ' : r === 2 ? 'ü•à' : 'ü•â'}</span>` : `<span class="rnk">#${r}</span>`;
        rows.push(`<div class="rank grad-border glass tier-${g.tier} ${isTop3 ? ('top-' + r) : ''}">
          <div>${left}</div>
          <div><b>${escapeHtml(u.name || 'Foydalanuvchi')}</b><div class="desc">${escapeHtml(u.class || '‚Äî')} ¬∑ ${escapeHtml(u.school || '‚Äî')}</div></div>
          <div style="text-align:right"><b>‚≠ê ${fmtPoints(u.points)}</b></div>
        </div>`);
      }
      if (el.boardList) el.boardList.innerHTML = `<div class="group grad-border glass"><div class="groupHead tier-${g.tier}"><span class="tier-badge">${g.label}</span></div><div class="groupBody">${rows.join('')}</div></div>`;
      if (el.decileInfo) el.decileInfo.textContent = g.label;
      if (el.decilePrev) el.decilePrev.disabled = (ix <= 0);
      if (el.decileNext) el.decileNext.disabled = (ix >= GROUPS.length - 1);
    }

    function drawMainDecile(users, ix) {
      const g = GROUPS[ix];
      if (!g) {
        const boardList = document.getElementById('mainBoardList');
        if (boardList) boardList.innerHTML = '<div class="desc">Hali ma\'lumot yo\'q</div>';
        return;
      }
      const arr = users.slice(0, 50), rows = [];
      for (let r = g.start; r <= g.end; r++) {
        const u = arr[r - 1];
        if (!u) continue;
        const isTop3 = r <= 3;
        const left = isTop3 ? `<span class="medal ${r === 1 ? 'm1' : r === 2 ? 'm2' : 'm3'}">${r === 1 ? 'üèÜ' : r === 2 ? 'ü•à' : 'ü•â'}</span>` : `<span class="rnk">#${r}</span>`;
        rows.push(`<div class="rank grad-border glass tier-${g.tier} ${isTop3 ? ('top-' + r) : ''}">
          <div>${left}</div>
          <div><b>${escapeHtml(u.name || 'Foydalanuvchi')}</b><div class="desc">${escapeHtml(u.class || '‚Äî')} ¬∑ ${escapeHtml(u.school || '‚Äî')}</div></div>
          <div style="text-align:right"><b>‚≠ê ${fmtPoints(u.points)}</b></div>
        </div>`);
      }
      const boardList = document.getElementById('mainBoardList');
      const info = document.getElementById('mainDecileInfo');
      const prevBtn = document.getElementById('mainDecilePrev');
      const nextBtn = document.getElementById('mainDecileNext');
      
      if (boardList) boardList.innerHTML = `<div class="group grad-border glass"><div class="groupHead tier-${g.tier}"><span class="tier-badge">${g.label}</span></div><div class="groupBody">${rows.join('')}</div></div>`;
      if (info) info.textContent = g.label;
      if (prevBtn) prevBtn.disabled = (ix <= 0);
      if (nextBtn) nextBtn.disabled = (ix >= GROUPS.length - 1);
    }

    if (el.decilePrev) el.decilePrev.onclick = () => {
      if (CURRENT_DECILE > 0) {
        CURRENT_DECILE--;
        drawDecile(latestUsers, CURRENT_DECILE);
        drawMainDecile(latestUsers, CURRENT_DECILE);
      }
    };

    if (el.decileNext) el.decileNext.onclick = () => {
      if (CURRENT_DECILE < GROUPS.length - 1) {
        CURRENT_DECILE++;
        drawDecile(latestUsers, CURRENT_DECILE);
        drawMainDecile(latestUsers, CURRENT_DECILE);
      }
    };

    /* ==== SECTIONS GRID ==== */
    function renderSectionsGrid() {
      const wrap = el.sections;
      if (!wrap) return;
      wrap.innerHTML = '';
      
      const list = (APP_DATA.sections || []).filter(s => MODE && s.tag && String(s.tag) === MODE);
      
      if (list.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'desc';
        empty.style.margin = '10px 6px';
        empty.style.opacity = '.75';
        empty.textContent = 'Bu teg bo\'yicha bo\'lim topilmadi.';
        wrap.appendChild(empty);
        return;
      }
      
      list.forEach(sec => {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'special-section';
        sectionDiv.innerHTML = `<h3>${escapeHtml(sec.title || 'Bo\'lim')}</h3>`;
        
        const grid = document.createElement('div');
        grid.className = 'grid';
        
        if (sec.items && sec.items.length > 0) {
          sec.items.forEach(item => {
            const card = document.createElement('div');
            card.className = 'ucard grad-border glass';
            
            let mediaContent = '';
            if (item.image) {
              mediaContent = `<img src="${escapeHtml(item.image)}" alt="${escapeHtml(item.name || '')}">`;
            } else {
              mediaContent = `<div class="titleBig">${escapeHtml(item.name || '')}</div>`;
            }
            
            card.innerHTML = `
              <div class="media">${mediaContent}</div>
              <div class="body">
                <h3 class="name">${escapeHtml(item.name || '')}</h3>
                ${item.description ? `<p class="desc">${escapeHtml(item.description)}</p>` : ''}
                <div class="actions">
                  ${item.buttons && item.buttons.length > 0 ? 
                    item.buttons.map(btn => 
                      `<a href="${btn.href || '#'}" class="btn" ${btn.action ? `data-action="${btn.action}"` : ''}>${btn.label || 'Ochish'}</a>`
                    ).join('') : 
                    '<button class="btn" disabled>Tez orada</button>'
                  }
                </div>
                <div class="chipline">
                  ${(item.tags || []).map(tag => `<span class="chip sm">${escapeHtml(tag)}</span>`).join('')}
                </div>
              </div>
            `;
            
            // Maxsus harakatlar uchun event listener
            const actionBtn = card.querySelector('[data-action]');
            if (actionBtn) {
              actionBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const action = actionBtn.getAttribute('data-action');
                if (action === 'showBanners') {
                  MODE = 'story';
                  updateVisibility();
                  renderMainChips();
                } else if (action === 'showLeaderboard') {
                  MODE = 'league';
                  updateVisibility();
                  renderMainChips();
                }
              });
            }
            
            grid.appendChild(card);
          });
        } else {
          grid.innerHTML = '<div class="desc" style="grid-column: 1 / -1; text-align: center; padding: 20px;">Bu bo\'limda hali kontent mavjud emas</div>';
        }
        
        sectionDiv.appendChild(grid);
        wrap.appendChild(sectionDiv);
      });
    }

    /* ==== BANNER FUNCTIONS ==== */
    function renderBannerChips() {
      const w = el.bannerChips;
      if (!w) return;
      w.innerHTML = '';
      const tags = (APP_DATA.bannerGroups || []).map(g => String(g.tag));
      if (tags.length === 0) {
        const m = document.createElement('div');
        m.className = 'chip sm';
        m.style.opacity = .7;
        m.textContent = 'Banner guruhlari yo\'q';
        w.appendChild(m);
        return;
      }
      if (!ACTIVE_BANNER_TAG) ACTIVE_BANNER_TAG = tags[0];
      tags.forEach(t => {
        const pressed = (t === ACTIVE_BANNER_TAG);
        w.appendChild(chipEl(t, pressed, () => { ACTIVE_BANNER_TAG = t; mountStory(); }, 'sm'));
      });
    }

    function mountStory() {
      renderBannerChips();
      const track = el.storyTrack, prog = el.storyProg;
      if (!track || !prog) return;
      
      track.innerHTML = '';
      prog.innerHTML = '';
      const grp = (APP_DATA.bannerGroups || []).find(g => String(g.tag) === String(ACTIVE_BANNER_TAG));
      if (!grp || !grp.items || grp.items.length === 0) {
        track.innerHTML = '<div class="story-slide"><h3 style="margin:0">Banner yo\'q</h3></div>';
        return;
      }
      grp.items.forEach(() => {
        const bar = document.createElement('div');
        bar.className = 'story-bar';
        bar.innerHTML = '<span></span>';
        prog.appendChild(bar);
      });
      grp.items.forEach(it => {
        const s = document.createElement('div');
        s.className = 'story-slide';
        s.innerHTML = it.html || '';
        track.appendChild(s);
      });

      let i = 0, raf = null, start = 0, playing = true;
      const spans = [...prog.querySelectorAll('span')];
      const D = () => Math.max(1100, Number(grp.items[i]?.durationMs || 4500));
      const setX = () => track.style.transform = `translateX(${-i * 100}%)`;
      const step = () => {
        const p = Math.min(1, (performance.now() - start) / D());
        spans[i].style.width = (p * 100) + '%';
        if (p < 1 && playing) raf = requestAnimationFrame(step);
        else {
          spans[i].style.width = '100%';
          if (i < grp.items.length - 1) {
            i++;
            setX();
            start = performance.now();
            raf = requestAnimationFrame(step);
          }
        }
      };
      setX();
      start = performance.now();
      raf = requestAnimationFrame(step);

      // swipe / pointer
      let sx = 0, dx = 0, dragging = false;
      if (el.story) {
        el.story.addEventListener('pointerdown', e => { dragging = true; sx = e.clientX; dx = 0; el.story.setPointerCapture(e.pointerId); });
        el.story.addEventListener('pointermove', e => {
          if (!dragging) return;
          dx = e.clientX - sx;
          track.style.transition = 'none';
          track.style.transform = `translateX(${(-i * 100) + (dx / window.innerWidth * 100)}%)`;
        });
        const end = () => {
          if (!dragging) return;
          dragging = false;
          track.style.transition = 'transform .25s ease';
          if (Math.abs(dx) > 40) {
            if (dx < 0 && i < grp.items.length - 1) i++;
            if (dx > 0 && i > 0) i--;
          }
          setX();
          start = performance.now();
          spans.forEach((sp, idx) => sp.style.width = idx < i ? '100%' : '0');
        };
        el.story.addEventListener('pointerup', end);
        el.story.addEventListener('pointercancel', end);
      }
    }

    /* ==== PROFIL MODALI ==== */
    function openProfileModal(pref = {}) {
      if (!el.PM.mask) return;
      
      el.PM.first.value = pref.first || '';
      el.PM.last.value = pref.last || '';
      el.PM.ph.value = pref.phone || '';
      el.PM.err.textContent = '';
      el.PM.role.value = (pref.role === 'teacher' || pref.role === 'student') ? pref.role : 'student';
      setClassVisible(el.PM.role.value === 'student');

      // Region ma'lumotlarini yuklash
      loadRegions(pref.region || '', pref.district || '', pref.school || '');

      const gradePref = pref.klass || '';
      fillClassSelect(gradePref);

      el.PM.mask.style.display = 'flex';
      document.body.classList.add('modal-open');
    }

    function closeProfileModal() {
      if (!el.PM.mask) return;
      el.PM.mask.style.display = 'none';
      document.body.classList.remove('modal-open');
    }

    // Region ma'lumotlari
    let REGION_DATA = { regions: [] };
    async function loadRegions(selectedRegion = '', selectedDistrict = '', selectedSchool = '') {
      // Mock region ma'lumotlari
      REGION_DATA = {
        regions: [
          {
            name: "Toshkent shahri",
            districts: [
              {
                name: "Yunusobod tumani",
                schools: ["1-maktab", "2-maktab", "3-maktab"]
              },
              {
                name: "Mirzo Ulug'bek tumani", 
                schools: ["4-maktab", "5-maktab", "6-maktab"]
              }
            ]
          },
          {
            name: "Samarqand viloyati",
            districts: [
              {
                name: "Samarqand shahri",
                schools: ["7-maktab", "8-maktab", "9-maktab"]
              }
            ]
          }
        ]
      };
      
      fillRegionSelect(selectedRegion);
      fillDistrictSelect(selectedRegion, selectedDistrict);
      fillSchoolSelect(selectedRegion, selectedDistrict, selectedSchool);
    }

    function fillRegionSelect(selectedName = '') {
      if (!el.PM.rSel) return;
      const opts = REGION_DATA.regions.map(r => `<option value="${r.name}">${r.name}</option>`);
      el.PM.rSel.innerHTML = `<option value="" disabled ${selectedName ? '' : 'selected'}>‚Äî tanlang ‚Äî</option>` + opts.join('');
      if (selectedName && REGION_DATA.regions.find(r => r.name === selectedName)) el.PM.rSel.value = selectedName;
    }

    function findRegion(name) {
      return REGION_DATA.regions.find(r => r.name === name);
    }

    function fillDistrictSelect(regionName, selectedDistrict = '') {
      if (!el.PM.dSel) return;
      const reg = findRegion(regionName);
      const dlist = reg ? reg.districts : [];
      const opts = dlist.map(d => `<option value="${d.name}">${d.name}</option>`);
      el.PM.dSel.innerHTML = `<option value="" disabled ${selectedDistrict ? '' : 'selected'}>‚Äî tanlang ‚Äî</option>` + opts.join('');
      if (selectedDistrict && dlist.some(d => d.name === selectedDistrict)) el.PM.dSel.value = selectedDistrict;
    }

    function fillSchoolSelect(regionName, districtName, selectedSchool = '') {
      if (!el.PM.schoolSel) return;
      const reg = findRegion(regionName);
      const dist = reg ? reg.districts.find(d => d.name === districtName) : null;
      const schools = dist?.schools || [];
      const opts = schools.map(s => `<option value="${s}">${s}</option>`);
      el.PM.schoolSel.innerHTML = `<option value="" disabled ${selectedSchool ? '' : 'selected'}>‚Äî tanlang ‚Äî</option>` + opts.join('');
      if (selectedSchool && schools.includes(selectedSchool)) el.PM.schoolSel.value = selectedSchool;
    }

    const GRADE_LIST = Array.from({ length: 11 }, (_, i) => String(i + 1));
    function fillClassSelect(gradeValue) {
      if (!el.PM.grade) return;
      el.PM.grade.innerHTML =
        `<option value="" disabled ${gradeValue ? '' : 'selected'}>‚Äî</option>` +
        GRADE_LIST.map(g => `<option value="${g}">${g}</option>`).join('');
      if (gradeValue) el.PM.grade.value = String(gradeValue);
    }

    function setClassVisible(visible) {
      if (el.PM.gradeWrap) el.PM.gradeWrap.style.display = visible ? '' : 'none';
    }

    // Profilni saqlash
    if (el.PM.save) {
      el.PM.save.onclick = async () => {
        if (!el.PM.err) return;
        el.PM.err.textContent = '';

        const first = el.PM.first.value.trim(), last = el.PM.last.value.trim();
        const role = el.PM.role.value || 'student';
        const region = el.PM.rSel.value || '';
        const district = el.PM.dSel.value || '';
        const school = el.PM.schoolSel.value || el.PM.schoolCustom.value.trim() || '';
        const phone = el.PM.ph.value.trim();
        const klass = (role === 'teacher') ? '' : (el.PM.grade.value || '');

        if (!first || !last || !role || !region || !district || !school || !phone) {
          el.PM.err.textContent = 'Barcha maydonlar majburiy (o\'qituvchi uchun sinf majburiy emas).';
          return;
        }
        if (role === 'student' && !klass) {
          el.PM.err.textContent = 'Sinf raqamini tanlang.';
          return;
        }

        const name = `${first} ${last}`;
        try {
          const userRef = doc(db, 'users', CURRENT_USER.uid);
          await updateDoc(userRef, {
            name, role, region, district, school, class: (role === 'teacher' ? null : klass), phone
          });
          CURRENT_PROFILE = { ...CURRENT_PROFILE, name, role, region, district, school, class: (role === 'teacher' ? null : klass), phone };
          closeProfileModal();
          fillChip(CURRENT_PROFILE);
        } catch (error) {
          console.error('Profilni saqlashda xato:', error);
          el.PM.err.textContent = 'Saqlashda xatolik. Internetni tekshiring.';
        }
      };
    }

    // Modal event listenerlar
    if (el.PM.close) el.PM.close.onclick = closeProfileModal;
    if (el.PM.rSel) el.PM.rSel.addEventListener('change', () => fillDistrictSelect(el.PM.rSel.value, ''));
    if (el.PM.dSel) el.PM.dSel.addEventListener('change', () => fillSchoolSelect(el.PM.rSel.value, el.PM.dSel.value, ''));
    if (el.PM.role) el.PM.role.addEventListener('change', () => setClassVisible(el.PM.role.value === 'student'));

    // Maktab tanlash/o'zini kiritish
    if (el.PM.schoolToggle) {
      el.PM.schoolToggle.addEventListener('click', () => {
        const isCustom = el.PM.schoolCustom.classList.contains('hidden') === false;
        el.PM.schoolCustom.classList.toggle('hidden', !isCustom);
        el.PM.schoolSel.classList.toggle('hidden', isCustom);
        el.PM.schoolToggle.textContent = isCustom ? "Ro'yxatdan tanlash" : "Ro'yxatda yo'q";
      });
    }

    /* ==== POPOVER ==== */
    function openPop() {
      if (!el.mask || !el.pop || !el.chip) return;
      el.mask.style.display = 'block';
      el.pop.style.display = 'block';
      el.chip.setAttribute('aria-expanded', 'true');
    }

    function closePop() {
      if (!el.mask || !el.pop || !el.chip) return;
      el.mask.style.display = 'none';
      el.pop.style.display = 'none';
      el.chip.setAttribute('aria-expanded', 'false');
    }

    if (el.more) el.more.addEventListener('click', e => { e.stopPropagation(); openPop(); });
    if (el.mask) el.mask.addEventListener('click', closePop);
    document.addEventListener('click', e => {
      if (el.pop && el.chip && !el.pop.contains(e.target) && !el.chip.contains(e.target)) closePop();
    });
    window.addEventListener('keydown', e => { if (e.key === 'Escape') closePop(); });

    if (el.openProfile) {
      el.openProfile.onclick = (e) => {
        e.preventDefault();
        closePop();
        const u = CURRENT_PROFILE || {};
        const nm = (u.name || '').trim().split(/\s+/, 2);
        openProfileModal({
          first: nm[0] || '',
          last: nm[1] || '',
          role: u.role || 'student',
          region: u.region || '',
          district: u.district || '',
          school: u.school || '',
          klass: u.class || '',
          phone: u.phone || ''
        });
      };
    }

    // App ishga tushirish
    console.log('LeaderMath ilovasi yuklandi');
  </script>
</body>
</html>