<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>LeaderMath.UZ â€” Home + Profil</title>

  <link rel="icon" href="./logo.png" sizes="any">
  <link rel="apple-touch-icon" href="./logo.png">
  <meta name="theme-color" content="#2E8B57"/>

    <style>
/* ===================== LeaderMath â€” Premium Glass (Light/Dark) ===================== */
/* ---- DARK (default) ---- */
:root{
  --brand:#2E8B57; --brand-2:#1F6B45; --accent:#6B8E23;
  --bg:#0f1512; --bg-2:#0b120f;
  --card:#0f1814; --card-2:#121e18;
  --text:#EAF7EE; --muted:#9ec3b0;
  --line:#1f2d26; --line-2:#1a2a22;
  --ring:#86E7B5; --ring-2:#63D09A;
  --shadow:0 30px 80px rgba(10,30,20,.35), 0 2px 10px rgba(10,30,20,.25);
  --shadow-sm:0 10px 30px rgba(10,30,20,.25), 0 1px 6px rgba(10,30,20,.2);
  --glass:linear-gradient(180deg, rgba(22,35,29,.65), rgba(15,24,20,.55));
  --glass-2:linear-gradient(180deg, rgba(22,35,29,.7), rgba(15,24,20,.6));
  --grad:conic-gradient(from 220deg at 40% -10%, rgba(96,214,153,.25), transparent 30%),
         conic-gradient(from 120deg at 120% 0%, rgba(140,235,183,.20), transparent 25%);
  --speed:.25s; --curve:cubic-bezier(.22,.61,.36,1);
  --vh:1vh;
}
/* ---- LIGHT ---- */
:root[data-theme="light"]{
  --bg:#F6FAF7; --bg-2:#ECF4EF;
  --card:#FFFFFF; --card-2:#F9FCFA;
  --text:#0f1b15; --muted:#5f7469;
  --line:#E3EBE6; --line-2:#D7E5DC;
  --shadow:0 22px 60px rgba(18,40,28,.14), 0 2px 10px rgba(18,40,28,.08);
  --shadow-sm:0 8px 26px rgba(18,40,28,.10), 0 1px 6px rgba(18,40,28,.08);
  --glass:linear-gradient(180deg, rgba(255,255,255,.76), rgba(255,255,255,.58));
  --glass-2:linear-gradient(180deg, rgba(255,255,255,.80), rgba(255,255,255,.62));
  --grad:conic-gradient(from 220deg at 40% -10%, rgba(46,139,87,.08), transparent 30%),
         conic-gradient(from 120deg at 120% 0%, rgba(110,195,150,.06), transparent 25%);
  --ring:#2E8B57; --ring-2:#64BD8A;
}

/* Global */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text);
  font:16px/1.6 "Inter",system-ui,Segoe UI,Arial;
  background:
    radial-gradient(1400px 700px at 10% -10%, color-mix(in srgb, var(--ring) 14%, transparent), transparent 60%),
    radial-gradient(1200px 600px at 120% 10%, color-mix(in srgb, var(--ring) 10%, transparent), transparent 60%),
    var(--grad),
    linear-gradient(180deg,var(--bg),var(--bg-2));
  background-attachment: fixed;
}

/* ===== Header */
.hdr{
  position:sticky; top:0; z-index:90;
  -webkit-backdrop-filter:saturate(1.1) blur(14px);
  backdrop-filter:saturate(1.1) blur(14px);
  background:var(--glass);
  border-bottom:1px solid var(--line);
  box-shadow:0 6px 24px rgba(0,0,0,.10);
}
.row{max-width:1180px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:14px}
.brand{display:flex;align-items:center;gap:12px;font-weight:800}
.brand img{
  width:52px;height:52px;border-radius:14px;display:block;
  box-shadow:0 10px 28px color-mix(in srgb, var(--ring) 25%, transparent), inset 0 0 0 1px rgba(255,255,255,.06);
  outline:2px solid color-mix(in srgb, var(--ring) 12%, transparent);
  transition:transform .3s var(--curve);
}
/* >>> TUN (dark) rejimida logo oq fonda â€” faqat darkâ€™da qoâ€˜llanadi */
:root:not([data-theme="light"]) .brand img{
  background:#fff; padding:6px; border-radius:16px;
  box-shadow:0 10px 28px rgba(0,0,0,.28), inset 0 0 0 1px rgba(0,0,0,.06);
}
.brand img:hover{ transform:translateY(-1px) rotate(-2deg) }
.brand b{color:var(--ring)}
.grow{flex:1}

/* Tema tugmasi (JS yaratadi) */
.theme-switch{
  appearance:none; border:1px solid var(--line); background:linear-gradient(180deg, var(--card-2), var(--card));
  color:var(--text); border-radius:999px; padding:8px 12px; font-weight:800; cursor:pointer;
  display:flex; align-items:center; gap:8px; box-shadow:var(--shadow-sm);
  transition:transform .2s var(--curve), box-shadow .2s var(--curve), background .2s var(--curve);
}
.theme-switch:hover{ transform:translateY(-1px) }

/* ===== Chipbar */
.chipbar-wrap{
  position:sticky; top:66px; z-index:80;
  -webkit-backdrop-filter:saturate(1.05) blur(10px);
  backdrop-filter:saturate(1.05) blur(10px);
  background:var(--glass-2);
  border-bottom:1px solid var(--line);
}
.chipbar{
  max-width:1180px;margin:0 auto;padding:10px 16px 14px; display:flex; gap:12px;
  overflow-x:auto; overflow-y:hidden; -webkit-overflow-scrolling:touch; scroll-behavior:smooth; scrollbar-width:none;
}
.chipbar::-webkit-scrollbar{display:none}
.chip{
  appearance:none; border:1px solid var(--line); background:linear-gradient(180deg, var(--card-2), var(--card));
  color:var(--text); border-radius:999px; padding:10px 16px; cursor:pointer; font-weight:800; letter-spacing:.1px;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.04), var(--shadow-sm);
  transition:transform .2s var(--curve), box-shadow .2s var(--curve), background .2s var(--curve), color .2s;
}
.chip:hover{ transform:translateY(-1px) }
.chip.active{
  background:linear-gradient(180deg, color-mix(in srgb, var(--ring) 16%, var(--card-2)), var(--card));
  border-color:transparent; color:color-mix(in srgb, var(--ring) 18%, #0b150f);
  box-shadow:0 0 0 1px color-mix(in srgb, var(--ring) 25%, transparent), 0 18px 50px color-mix(in srgb, var(--ring) 22%, transparent);
}

/* ===== Fullscreen Banner (headerga yaqin) */
.banner-carousel-section{
  position:fixed; left:0; right:0; top:calc(var(--top-gap, 120px) - 10px);
  height:clamp(220px, calc(var(--vh)*42), 420px);
  z-index:40; overflow:hidden; pointer-events:auto; border-bottom:1px solid var(--line);
  background:linear-gradient(180deg, color-mix(in srgb, var(--card) 92%, transparent), color-mix(in srgb, var(--card) 68%, transparent));
}
@media (max-width:900px){
  .banner-carousel-section{ top:calc(var(--top-gap, 120px) - 8px); height:clamp(180px, calc(var(--vh)*38), 360px); }
}
.banner-carousel{ position:absolute; inset:0; display:flex; transition: transform .6s var(--curve); }
.banner-slide{ flex:0 0 100%; position:relative; overflow:hidden; }
.banner-slide::after{
  content:""; position:absolute; inset:0;
  background:radial-gradient(1200px 600px at 10% 0%, color-mix(in srgb, var(--ring) 12%, transparent), transparent 60%),
             radial-gradient(1200px 600px at 90% 100%, color-mix(in srgb, var(--ring) 8%, transparent), transparent 60%);
  pointer-events:none;
}
.banner-slide iframe{ width:100%; height:100%; border:0; display:block; }

.banner-indicators{ position:absolute; bottom:10px; left:0; right:0; display:flex; justify-content:center; gap:10px; z-index:50; }
.banner-indicator{ width:10px;height:10px;border-radius:50%; background:color-mix(in srgb, var(--text) 35%, transparent); cursor:pointer; transition:transform .2s var(--curve), background .2s var(--curve); box-shadow:0 6px 16px rgba(0,0,0,.1); }
.banner-indicator:hover{ transform:scale(1.08) }
.banner-indicator.active{ background:var(--ring) }

.banner-nav{
  position:absolute; top:50%; transform:translateY(-50%);
  background:color-mix(in srgb, var(--card) 92%, transparent); border:1px solid var(--line); color:var(--text);
  width:38px;height:38px;border-radius:999px; display:flex; align-items:center; justify-content:center;
  cursor:pointer; z-index:50; box-shadow:var(--shadow-sm);
  transition:transform .18s var(--curve), background .2s var(--curve), border-color .2s;
}
.banner-nav:hover{ transform:translateY(-50%) scale(1.05); border-color:color-mix(in srgb, var(--ring) 35%, var(--line)) }
.banner-nav.prev{ left:10px } .banner-nav.next{ right:10px }

/* ===== Main + Sections */
main{ max-width:1180px; margin:0 auto; padding: calc(var(--vh)*42 + 18px) 16px 64px; }
.section{
  background:linear-gradient(180deg, color-mix(in srgb, var(--card) 96%, #fff), var(--card));
  border:1px solid var(--line);
  border-radius:22px; box-shadow:var(--shadow); overflow:hidden; margin-bottom:16px;
  transition:transform .22s var(--curve), box-shadow .22s var(--curve), border-color .22s;
}
.section:hover{ transform:translateY(-2px); border-color:color-mix(in srgb, var(--ring) 22%, var(--line)); }

/* Section ichidagilar */
.section-hdr{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--line); background:linear-gradient(180deg, color-mix(in srgb, var(--card) 86%, transparent), color-mix(in srgb, var(--card) 72%, transparent)); }
.section-hdr h3,.section-hdr h4{margin:0}
.iframe-wrap{position:relative}
.ratio{position:relative;width:100%;overflow:hidden;border:1px solid var(--line);border-radius:16px;background:var(--card); box-shadow:var(--shadow-sm)}
.ratio[data-r="16-9"]::before{content:"";display:block;padding-top:56.25%}
.ratio>iframe{position:absolute;inset:0;width:100%;height:100%;border:0}

/* Cards */
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
@media (max-width:960px){.grid{grid-template-columns:1fr 1fr}}
@media (max-width:640px){.grid{grid-template-columns:1fr}}
.cardX{ border:1px solid var(--line); background:linear-gradient(180deg, var(--card-2), var(--card)); border-radius:16px; padding:12px; display:flex; flex-direction:column; gap:10px; box-shadow:var(--shadow-sm); transition:transform .2s var(--curve), box-shadow .2s var(--curve), border-color .2s; }
.cardX:hover{ transform:translateY(-2px) }
.badge{ padding:5px 10px;border:1px solid var(--line);border-radius:999px;font-size:12px; background:color-mix(in srgb, var(--card) 90%, transparent); color:var(--text); }
.badge.soon{ background:#fff8e5; border-color:#f2d48a; color:#8a6a1b }
.badge.active{ background:#eaf6ef; border-color:#84d1a8; color:#1b5a3b }
.badge.ended{ background:#f5f7f6; border-color:#dbe4de; color:#6a7a71 }

/* Filter chips */
.inline-filters{display:flex;gap:10px;flex-wrap:wrap;padding:12px}
.fchip{ appearance:none;border:1px solid var(--line);background:linear-gradient(180deg,var(--card-2),var(--card)); border-radius:999px;padding:8px 14px;cursor:pointer;font-weight:800;letter-spacing:.1px;color:var(--text); transition:transform .18s var(--curve), box-shadow .2s, border-color .2s; box-shadow:var(--shadow-sm); }
.fchip:hover{ transform:translateY(-1px) }
.fchip.active{ background:linear-gradient(180deg, color-mix(in srgb, var(--ring) 12%, var(--card-2)), var(--card)); border-color:transparent; box-shadow:0 12px 30px color-mix(in srgb, var(--ring) 18%, transparent) }

/* Buttons / Inputs / Overlay / Menu (oâ€˜zgarmagan uslubda) */
.btn{ appearance:none;border:1px solid var(--line);background:linear-gradient(180deg,var(--card-2),var(--card)); padding:12px 16px;border-radius:14px;cursor:pointer;font-weight:800;color:var(--text); box-shadow:var(--shadow-sm); transition:transform .18s var(--curve) }
.btn:hover{ transform:translateY(-1px) }
.btn.primary{ background:linear-gradient(180deg, color-mix(in srgb, var(--ring) 18%, #bfead3), var(--ring)); color:color-mix(in srgb, var(--ring) 8%, #05110c); border-color:transparent; text-shadow:0 1px 0 rgba(255,255,255,.25); box-shadow:0 18px 40px color-mix(in srgb, var(--ring) 24%, transparent); }
.btn[disabled]{opacity:.55;cursor:not-allowed}

.fld{display:grid;gap:8px;margin:10px 0}
.fld input,.fld select{ width:100%;padding:12px 14px;border-radius:14px;border:1px solid var(--line); background:linear-gradient(180deg,var(--card),var(--card-2)); color:var(--text); outline:none; transition:box-shadow .18s, border-color .18s; }
.fld input:focus,.fld select:focus{ border-color:color-mix(in srgb, var(--ring) 22%, var(--line)); box-shadow:0 0 0 3px color-mix(in srgb, var(--ring) 14%, transparent); }

.userchip{ border:1px solid var(--line); background:linear-gradient(180deg,var(--card),var(--card-2)); padding:6px 10px;border-radius:999px; box-shadow:var(--shadow-sm); display:flex;align-items:center;gap:10px;cursor:pointer; }
.avatar{ width:34px;height:34px;border-radius:50%;overflow:hidden;background:linear-gradient(135deg,var(--card),var(--card-2)); box-shadow:inset 0 0 0 1px rgba(0,0,0,.04) }
.menu{ position:fixed; min-width:300px; background:linear-gradient(180deg,var(--card),var(--card-2)); border:1px solid var(--line); border-radius:16px; box-shadow:0 20px 70px rgba(0,0,0,.10), inset 0 0 0 1px rgba(255,255,255,.04); display:none; overflow:hidden; z-index:9999 }
.menu.open{display:block}
.menu .label{ padding:8px 14px;font-size:12px;color:var(--muted); border-bottom:1px solid var(--line); background:linear-gradient(180deg, color-mix(in srgb, var(--card-2) 86%, transparent), color-mix(in srgb, var(--card) 72%, transparent)); }
.menu a{ display:flex;align-items:center;gap:10px;padding:12px 14px;text-decoration:none;color:inherit; border-bottom:1px solid color-mix(in srgb,var(--line) 75%, transparent); transition: transform .16s var(--curve), background .16s var(--curve) }
.menu a:last-child{border-bottom:none}
.menu a:hover{ background:color-mix(in srgb, var(--ring) 10%, transparent); transform:translateX(4px) }

.overlay{ position:fixed; inset:0; display:none; place-items:center; z-index:110; background:radial-gradient(900px 600px at 50% 10%, color-mix(in srgb, var(--card) 70%, transparent), transparent 60%), linear-gradient(180deg, color-mix(in srgb, var(--card) 65%, transparent), color-mix(in srgb, var(--card) 75%, transparent)); -webkit-backdrop-filter:saturate(1.1) blur(10px); backdrop-filter:saturate(1.1) blur(10px); opacity:0; transition:opacity .2s var(--curve) }
.overlay.show{ display:grid; opacity:1 }
.profile-card,.modal-card{ width:min(880px,96vw); background:linear-gradient(180deg, color-mix(in srgb, var(--card) 96%, #fff), var(--card)); border:1px solid color-mix(in srgb, var(--line) 65%, transparent); border-radius:22px; box-shadow:var(--shadow); padding:22px; animation:pop .18s var(--curve) }
@keyframes pop{ from{ transform:scale(.985); opacity:.6 } to{ transform:scale(1); opacity:1 } }

/* A11y */
@media (prefers-reduced-motion: reduce){
  .chip,.btn,.fchip,.menu a,.banner-carousel{ transition:none !important }
  .brand img,.section{ transition:none !important }
}
  </style>
</head>
<body>
  <header class="hdr" id="hdr">
    <div class="row">
      <div class="brand">
        <img src="./logo.png" alt="LM"/>
        <div style="display:grid;line-height:1.1">
          <span style="font-size:18px;font-weight:800">LeaderMath.<b style="color:var(--brand)">UZ</b></span>
          <small style="color:var(--muted)">Matematika platformasi</small>
        </div>
      </div>
      <div class="grow"></div>
      <div id="user-slot"></div>
    </div>

    <div class="chipbar-wrap" id="chipwrap">
      <nav id="chipbar" class="chipbar" aria-label="Bo'limlar"></nav>
    </div>
  </header>

  <!-- Faqat slot:"fullscreen" bannerlar karuseli -->
  <div class="banner-carousel-section" id="bannerCarouselSection">
    <div class="banner-carousel" id="bannerCarousel"></div>
    <button class="banner-nav prev" id="bannerPrev">â€¹</button>
    <button class="banner-nav next" id="bannerNext">â€º</button>
    <div class="banner-indicators" id="bannerIndicators"></div>
  </div>

  <main id="app"><div id="sections"></div></main>

  <div id="overlay" class="overlay" aria-modal="true"></div>
  <div id="portal-root"></div>

  <!-- App JS -->
  <script type="module">
 /* ================= LeaderMath â€” Optimized App + Theme Toggle ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider,
  setPersistence, browserLocalPersistence, signOut,
  signInWithEmailAndPassword, createUserWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
import { getStorage } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

/* ---------- Firebase ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  authDomain: "xplusy-760fa.firebaseapp.com",
  projectId: "xplusy-760fa",
  storageBucket: "xplusy-760fa.appspot.com",
  messagingSenderId: "992512966017",
  appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
  measurementId: "G-459PLJ7P7L"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const st   = getStorage(app);
try { await setPersistence(auth, browserLocalPersistence); } catch {}

/* ---------- Helpers / cache ---------- */
const $  = (s, r=document) => r.querySelector(s);
const qa = (s, r=document) => [...r.querySelectorAll(s)];
const els = {
  hdr: $('#hdr'),
  chipwrap: $('#chipwrap'),
  chipbar: $('#chipbar'),
  userSlot: $('#user-slot'),
  overlay: $('#overlay'),
  sectionsHost: $('#sections'),
  bannerSection: $('#bannerCarouselSection'),
  bannerTrack: $('#bannerCarousel'),
  bannerPrev: $('#bannerPrev'),
  bannerNext: $('#bannerNext'),
  bannerDots: $('#bannerIndicators'),
  portal: $('#portal-root')
};

const ALWAYS_REQ=['firstName','lastName','birthDate','region','district','role'];
let REGIONS=[], CURRENT_USER=null, PROFILE=null, USER_POINTS=0;

/* ---------- Theme (Light/Dark) ---------- */
const THEME_KEY = 'lm_theme';
const prefersDark = matchMedia('(prefers-color-scheme: dark)');
function applyTheme(t){
  const html = document.documentElement;
  if(t==='light'){ html.setAttribute('data-theme','light'); }
  else { html.removeAttribute('data-theme'); } // dark by default
  localStorage.setItem(THEME_KEY, t);
}
function initTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  const t = saved || (prefersDark.matches ? 'dark' : 'light');
  applyTheme(t);
  prefersDark.addEventListener('change', (e)=>{
    const cur = localStorage.getItem(THEME_KEY);
    if(!cur){ applyTheme(e.matches?'dark':'light'); }
  });
  injectThemeButton(t);
}
function injectThemeButton(cur){
  if($('#themeSwitch')) return;
  const btn = document.createElement('button');
  btn.id='themeSwitch'; btn.className='theme-switch';
  btn.innerHTML = (cur==='light' ? 'ðŸŒ™ Tun' : 'â˜€ï¸ Kun');
  const row = els.hdr?.querySelector('.row');
  (row||document.body).appendChild(btn);
  btn.addEventListener('click', ()=>{
    const now = (document.documentElement.getAttribute('data-theme')==='light') ? 'dark' : 'light';
    applyTheme(now);
    btn.innerHTML = (now==='light' ? 'ðŸŒ™ Tun' : 'â˜€ï¸ Kun');
  });
}

/* ---------- Perf utils ---------- */
const raf = (fn)=> requestAnimationFrame(fn);
const throttled = (fn, wait=100) => { let t=0, lastArgs=null, pending=false;
  return (...args)=>{ lastArgs=args; const now=Date.now();
    if(!pending && now-t>wait){ t=now; fn(...lastArgs); }
    else if(!pending){ pending=true; setTimeout(()=>{ pending=false; t=Date.now(); fn(...lastArgs); }, wait); }
  };
};
const parseLocal = (s)=>{ if(!s) return null; const m=s.match(/^(\d{4})-(\d{2})-(\d{2})\s+(\d{2}):(\d{2})$/); if(!m) return null; const [,Y,M,D,h,mn]=m; return new Date(+Y,+M-1,+D,+h,+mn,0,0); };
const fmtDate=(d)=>!d?'-':`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
const calcAge=iso=>{try{const b=new Date(iso),t=new Date();let a=t.getFullYear()-b.getFullYear();const m=t.getMonth()-b.getMonth();if(m<0||(m===0&&t.getDate()<b.getDate()))a--;return a;}catch{return '';}};
const activeByTime=(b)=>{ const now=new Date(); const s=parseLocal(b.startAt), e=parseLocal(b.endAt); if(s&&now<s) return false; if(e&&now>e) return false; return true; };

/* ---------- Dynamic VH + top-gap (headerga yaqin) ---------- */
function setVHAndTopGap(){
  raf(()=>{
    const vh = innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
    const hdrH  = (els.hdr?.getBoundingClientRect().height || 0);
    const chipH = (els.chipwrap?.getBoundingClientRect().height || 0);
    document.documentElement.style.setProperty('--top-gap', Math.max(0, hdrH + chipH - 10) + 'px');
  });
}
const resizeObs = new ResizeObserver(throttled(setVHAndTopGap, 80));
resizeObs.observe(document.documentElement);
addEventListener('resize', throttled(setVHAndTopGap, 80), {passive:true});
addEventListener('orientationchange', setVHAndTopGap, {passive:true});

/* ---------- Top fullscreen banners ---------- */
const BSTATE = { banners: [], i: 0, timer: null, playing: false, visible: true };
function bannerFrameFromObj(b, baseHref=null){
  const f=document.createElement('iframe'); f.className='sbx';
  f.setAttribute('sandbox', b.sandbox || 'allow-scripts allow-forms');
  f.setAttribute('scrolling','no'); f.style.width='100%'; f.style.height='100%'; f.style.border='0';
  if (b.mode==='url'){ f.src=b.src||''; }
  else {
    const base = b.baseHref || baseHref || '';
    const html = `<!doctype html><html><head>${base?`<base href="${base}">`:""}<meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
      <style>html,body{height:100%;margin:0;overflow:hidden;background:transparent}</style></head>
      <body>${String(b.contentHtml||'')}</body></html>`;
    f.srcdoc = html;
  }
  return f;
}
function goToBanner(idx){
  if(!BSTATE.banners.length) return;
  BSTATE.i = (idx + BSTATE.banners.length) % BSTATE.banners.length;
  els.bannerTrack.style.transform = `translateX(-${BSTATE.i*100}%)`;
  qa('.banner-indicator', els.bannerDots).forEach((d,k)=>d.classList.toggle('active', k===BSTATE.i));
}
const nextBanner = ()=> goToBanner(BSTATE.i+1);
const prevBanner = ()=> goToBanner(BSTATE.i-1);
function startBannerRotation(){ stopBannerRotation(); if(BSTATE.banners.length>1 && BSTATE.visible){ BSTATE.playing=true; BSTATE.timer=setInterval(nextBanner,5000); } }
function stopBannerRotation(){ BSTATE.playing=false; if(BSTATE.timer){ clearInterval(BSTATE.timer); BSTATE.timer=null; } }
addEventListener('visibilitychange', ()=>{ BSTATE.visible=!document.hidden; BSTATE.visible?startBannerRotation():stopBannerRotation(); }, {passive:true});
const bannerIO = new IntersectionObserver((e)=>{ BSTATE.visible=!!e[0]?.isIntersecting; BSTATE.visible?startBannerRotation():stopBannerRotation(); }, {threshold:.2});
if(els.bannerSection) bannerIO.observe(els.bannerSection);

async function fetchBanners(){
  try{
    const snap = await getDoc(doc(db,'configs','home'));
    if(!snap.exists()) return [];
    const data = snap.data();
    const sections = Array.isArray(data.sections)? data.sections : [];
    const all = [];
    for(const sec of sections){
      if(Array.isArray(sec.banners)) all.push(...sec.banners);
      if(Array.isArray(sec.subsections)){
        for(const s2 of sec.subsections){
          if(Array.isArray(s2.banners)) all.push(...s2.banners);
          if(Array.isArray(s2.items))   all.push(...s2.items.filter(x=>x?.kind==='banner'));
        }
      }
      if(Array.isArray(sec.items)) all.push(...sec.items.filter(x=>x?.kind==='banner'));
    }
    return all.filter(b => (b.slot||'')==='fullscreen').filter(activeByTime).sort((a,b)=>(+a.order||0)-(+b.order||0));
  }catch{ return []; }
}
function renderBannerCarousel(banners){
  els.bannerTrack.textContent=''; els.bannerDots.textContent='';
  if(!banners.length){ els.bannerSection.style.display='none'; return; }
  els.bannerSection.style.display='block';
  BSTATE.banners=banners; BSTATE.i=0;

  const slidesFrag=document.createDocumentFragment();
  const dotsFrag=document.createDocumentFragment();
  banners.forEach((b,i)=>{
    const s=document.createElement('div'); s.className='banner-slide';
    s.appendChild(bannerFrameFromObj(b)); slidesFrag.appendChild(s);
    const d=document.createElement('div'); d.className='banner-indicator'+(i===0?' active':''); d.onclick=()=>goToBanner(i); dotsFrag.appendChild(d);
  });
  els.bannerTrack.appendChild(slidesFrag);
  els.bannerDots.appendChild(dotsFrag);

  els.bannerPrev.onclick=prevBanner;
  els.bannerNext.onclick=nextBanner;
  els.bannerTrack.addEventListener('mouseenter', stopBannerRotation, {passive:true});
  els.bannerTrack.addEventListener('mouseleave', startBannerRotation, {passive:true});
  startBannerRotation();
}

/* ---------- Home (sections/cards) ---------- */
async function fetchHome(){
  try{ const s=await getDoc(doc(db,'configs','home')); if(s.exists()){ const d=s.data(); if(Array.isArray(d.sections)) return d; } }catch{}
  return {sections:[]};
}
const HSTATE={ sections:[], activeId:null };
const ORDER={active:0, soon:1, available:2, ended:3};
function cardState(it){
  if(it.cardStyle==='soon') return 'soon';
  if(it.cardStyle==='timed'){ const now=new Date(), s=parseLocal(it.startAt), e=parseLocal(it.endAt);
    if(s && now<s) return 'soon'; if(s && e && now>=s && now<=e) return 'active'; if(e && now>e) return 'ended'; return 'active'; }
  return 'available';
}
function buildFilters(){
  const wrap=document.createElement('div'); wrap.className='inline-filters';
  const opts=[{key:'all',label:'Barchasi'},{key:'active',label:'Faol'},{key:'soon',label:'Yaqinda'},{key:'available',label:'Mavjud'},{key:'ended',label:'Tugagan'}];
  const f={wrap,onChange:null};
  opts.forEach(o=>{ const b=document.createElement('button'); b.className='fchip'+(o.key==='all'?' active':''); b.dataset.f=o.key; b.textContent=o.label;
    b.onclick=()=>{ qa('.fchip',wrap).forEach(x=>x.classList.toggle('active',x===b)); f.onChange && f.onChange(o.key); }; wrap.appendChild(b); });
  return f;
}
function applyFilter(grid, key){ qa('.cardX', grid).forEach(card=>{ const st=card.dataset.state||'available'; card.hidden = !((key==='all')||(st===key)); }); }
function renderCard(it){
  const c=document.createElement('div'); c.className='cardX'; c.dataset.kind='card';
  const title=it.title||'Card'; const st=cardState(it); c.dataset.state=st;
  const row=document.createElement('div'); row.className='rowflex';
  const h=document.createElement('h4'); h.textContent=title; row.appendChild(h);
  const bd=document.createElement('span'); bd.className='badge '+(st==='soon'?'soon':st==='active'?'active':st==='ended'?'ended':''); bd.textContent=(st==='soon'?'Yaqinda':st==='active'?'Faol':st==='ended'?'Tugagan':'Mavjud'); row.appendChild(bd); c.appendChild(row);
  if(it.cardStyle==='timed'){ const s=parseLocal(it.startAt), e=parseLocal(it.endAt); const t=document.createElement('div'); t.className='muted'; t.textContent=`Vaqt: ${fmtDate(s)} â€” ${fmtDate(e)}`; c.appendChild(t); }
  const actions=document.createElement('div'); actions.className='rowflex';
  const info=document.createElement('button'); info.className='btn'; info.textContent='â„¹ï¸ Info';
  info.onclick=()=> showOverlay(`<div class="profile-card"><div style="display:flex;justify-content:space-between;align-items:center"><b>${title}</b><button class="btn" onclick="(${closeOverlay.toString()})();">Yopish</button></div><div class="divider"></div>${it.infoHtml||'<p class="muted">Ma\'lumot yo\'q.</p>'}</div>`);
  actions.appendChild(info);
  const a=document.createElement('a'); a.className='btn primary'; a.textContent=it.ctaLabel||'Boshlash';
  if(st==='active' && it.ctaHref){ a.href=it.ctaHref; a.target='_blank'; } else { a.classList.remove('primary'); a.setAttribute('disabled',''); }
  actions.appendChild(a); c.appendChild(actions);
  return c;
}
function renderBanner(b, fullBleed=false, baseHref=null){
  if(fullBleed){ const wrap=document.createElement('div'); wrap.className='carousel-viewport'; wrap.appendChild(bannerFrameFromObj(b, baseHref)); return wrap; }
  const r=document.createElement('div'); r.className='ratio'; r.dataset.r='16-9'; r.appendChild(bannerFrameFromObj(b, baseHref)); return r;
}
function renderCarousel(banners, fullBleed=false, baseHref=null, intervalMs=4500){
  const vp=document.createElement('div'); vp.className=fullBleed?'carousel-viewport':'ratio'; if(!fullBleed) vp.dataset.r='16-9';
  const slideWrap=document.createElement('div'); slideWrap.style.cssText='position:absolute;inset:0;display:grid;grid-auto-flow:column;grid-auto-columns:100%;transition:transform .6s ease;';
  vp.appendChild(slideWrap);
  const frag=document.createDocumentFragment();
  banners.forEach(b=>{ const holder=document.createElement('div'); holder.style.cssText='position:relative;width:100%;height:100%'; const fr=bannerFrameFromObj(b, baseHref); fr.style.cssText='position:absolute;inset:0;width:100%;height:100%'; holder.appendChild(fr); frag.appendChild(holder); });
  slideWrap.appendChild(frag);
  let i=0, timer=null, visible=true;
  const go=(n)=>{ i=(n+banners.length)%banners.length; slideWrap.style.transform=`translateX(-${i*100}%)`; };
  const play=()=>{ stop(); if(banners.length>1 && visible) timer=setInterval(()=>go(i+1), intervalMs); };
  const stop=()=>{ if(timer){ clearInterval(timer); timer=null; } };
  vp.addEventListener('pointerenter', stop, {passive:true});
  vp.addEventListener('pointerleave', play, {passive:true});
  const io=new IntersectionObserver((en)=>{ visible=en[0]?.isIntersecting; visible?play():stop(); },{threshold:.2});
  io.observe(vp); if(banners.length>1) play(); return vp;
}
function renderSubSection(ss){
  const wrap=document.createElement('section'); wrap.className='section';
  const head=document.createElement('div'); head.className='section-hdr'; head.innerHTML=`<h3>${ss.title||ss.id||'Bo\'lim'}</h3>`;
  const body=document.createElement('div'); body.className='iframe-wrap';
  const inner=document.createElement('div'); inner.style.padding='12px';

  const items=Array.isArray(ss.items)?ss.items:[]; const banners=items.filter(x=>x.kind==='banner'); const cards=items.filter(x=>x.kind==='card');
  if(banners.length>1) inner.appendChild(renderCarousel(banners,false, ss.baseHref));
  else if(banners.length===1) inner.appendChild(renderBanner(banners[0],false, ss.baseHref));
  if(cards.length){ const filters=buildFilters(); inner.appendChild(filters.wrap); const grid=document.createElement('div'); grid.className='grid'; const frag=document.createDocumentFragment(); cards.forEach(c=>frag.appendChild(renderCard(c))); grid.appendChild(frag); inner.appendChild(grid); filters.onChange=(k)=>applyFilter(grid,k); }

  const subs=Array.isArray(ss.subsections)?ss.subsections:[]; if(subs.length){ const f2=document.createDocumentFragment(); subs.forEach(s2=> f2.appendChild(renderSubSection(s2))); inner.appendChild(f2); }
  body.appendChild(inner); wrap.append(head, body); return wrap;
}
function renderSection(sec){
  const id = sec.id || ('sec' + Math.random());
  const outer = document.createElement('section'); outer.dataset.section = id; outer.className = 'section';
  const sh = document.createElement('div'); sh.className = 'section-hdr'; sh.innerHTML = `<h3>${sec.title || id}</h3>`;
  const body = document.createElement('div'); body.className = 'iframe-wrap';
  const inner = document.createElement('div'); inner.style.padding = '12px';
  const subs = Array.isArray(sec.subsections) ? sec.subsections : [];
  if(subs.length){
    const frag=document.createDocumentFragment();
    subs.forEach((sub, idx) => {
      const subWrap = document.createElement('div'); subWrap.className = 'section'; subWrap.style.margin = '16px 0';
      const subHead = document.createElement('div'); subHead.className = 'section-hdr';
      subHead.innerHTML = `<h4>${sub.title || ('Sub ' + (idx + 1))}</h4>`;
      const subBody = document.createElement('div'); subBody.className = 'iframe-wrap';
      const subInner = document.createElement('div'); subInner.style.padding = '10px';
      const banners = Array.isArray(sub.banners) ? sub.banners : [];
      const cards   = Array.isArray(sub.cards)   ? sub.cards   : [];
      if (banners.length > 1) subInner.appendChild(renderCarousel(banners, false, sub.baseHref));
      else if (banners.length === 1) subInner.appendChild(renderBanner(banners[0], false, sub.baseHref));
      if (cards.length) { const filters = buildFilters(); subInner.appendChild(filters.wrap); const grid = document.createElement('div'); grid.className = 'grid'; const frag2=document.createDocumentFragment(); cards.forEach(c => frag2.appendChild(renderCard(c))); grid.appendChild(frag2); subInner.appendChild(grid); filters.onChange = k => applyFilter(grid, k); }
      subBody.appendChild(subInner); subWrap.append(subHead, subBody); frag.appendChild(subWrap);
    });
    inner.appendChild(frag);
  } else {
    const banners = Array.isArray(sec.banners) ? sec.banners : [];
    const cards   = Array.isArray(sec.cards)   ? sec.cards   : [];
    if (banners.length > 1) inner.appendChild(renderCarousel(banners, false, sec.baseHref));
    else if (banners.length === 1) inner.appendChild(renderBanner(banners[0], false, sec.baseHref));
    if (cards.length) { const filters = buildFilters(); inner.appendChild(filters.wrap); const grid = document.createElement('div'); grid.className = 'grid'; const frag=document.createDocumentFragment(); cards.forEach(c => frag.appendChild(renderCard(c))); grid.appendChild(frag); inner.appendChild(grid); filters.onChange = k => applyFilter(grid, k); }
  }
  body.appendChild(inner); outer.append(sh, body); return outer;
}
function renderSections(){
  els.sectionsHost.textContent='';
  const frag=document.createDocumentFragment();
  HSTATE.sections.forEach(s=> frag.appendChild(renderSection(s)));
  els.sectionsHost.appendChild(frag);
}
function activate(id){
  HSTATE.activeId=id;
  qa('.chip', els.chipbar).forEach(c=>c.classList.toggle('active', c.dataset.target===id));
  qa('[data-section]', els.sectionsHost).forEach(s=>{ s.style.display = (s.dataset.section===id) ? 'block':'none'; });
  setVHAndTopGap();
}
async function loadHome(){
  const data=await fetchHome();
  HSTATE.sections = (Array.isArray(data.sections)? data.sections: []).map((s,i)=>({ id: (s.id||`sec${i+1}`), ...s }));
  els.chipbar.textContent=''; const frag=document.createDocumentFragment();
  HSTATE.sections.forEach((s,i)=>{ const b=document.createElement('button'); b.className='chip'+(i===0?' active':''); b.textContent=s.title||s.id||('Bo\'lim '+(i+1)); b.dataset.target=s.id||('sec'+i); b.onclick=()=>{ activate(b.dataset.target); b.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'}); }; frag.appendChild(b); });
  els.chipbar.appendChild(frag);
  renderSections(); if(HSTATE.sections.length) activate(HSTATE.sections[0].id);
}

/* ---------- Overlay / User chip / Auth lock ---------- */
const showOverlay=html=>{ els.overlay.innerHTML=html; els.overlay.classList.add('show'); };
const closeOverlay=()=>{ els.overlay.classList.remove('show'); els.overlay.innerHTML=''; };
els.overlay.addEventListener('click', (e)=>{ if(e.target.id==='overlay') closeOverlay(); }, {passive:true});
addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeOverlay(); });

function renderUserChip(u, profile){
  const age=profile?.birthDate?calcAge(profile.birthDate):'';
  const name=profile?.firstName?(profile.firstName+(profile.lastName?' '+profile.lastName:'')):(u.displayName||u.email||'Foydalanuvchi');
  const avatar=profile?.avatarUrl||u.photoURL||''; const role=profile?.role||'â€”';
  els.userSlot.innerHTML=`
    <div class="userchip" id="userchip" aria-haspopup="menu" aria-expanded="false">
      <div class="avatar">${avatar?`<img src="${avatar}" alt="">`:''}</div>
      <div style="display:grid;line-height:1"><b style="font-size:14px">${name}</b><small class="mini">${role} â€¢ ${age?age+' yosh â€¢ ':''}${USER_POINTS} points</small></div>
      <div class="menu" id="usermenu" role="menu">
        <a href="#" id="mProfile" role="menuitem">Profil</a>
        <a href="#" id="mEdit" role="menuitem">Profilni tahrirlash</a>
        <a href="#" id="mLogout" role="menuitem">Chiqish</a>
        <div class="label">Aloqa</div>
        <a href="tel:+998901234567">+998 90 123 45 67</a>
        <a href="mailto:info@leadermath.uz">info@leadermath.uz</a>
        <a href="https://t.me/LeaderMathUZ" target="_blank" rel="noopener">Telegram</a>
        <a href="https://t.me/LeaderMathBot" target="_blank" rel="noopener">Bot</a>
        <a href="https://instagram.com/leadermath.uz" target="_blank" rel="noopener">Instagram</a>
        <a href="https://www.youtube.com/@leadermathuz" target="_blank" rel="noopener">YouTube</a>
      </div>
    </div>`;
}
function openUserMenu(){
  const chip = $('#userchip'); const menu=$('#usermenu'); if(!chip||!menu) return;
  ( els.portal || document.body ).appendChild(menu);
  menu.style.visibility='hidden'; menu.style.display='block';
  const r = chip.getBoundingClientRect(); const mw = menu.offsetWidth, mh = menu.offsetHeight, gap = 8;
  let left = Math.min(Math.max(r.right - mw, 8), innerWidth - mw - 8); let top  = r.bottom + gap;
  if (top + mh > innerHeight - 8) top = Math.max(8, r.top - gap - mh);
  menu.style.left = left+'px'; menu.style.top = Math.max(8, top)+'px';
  menu.classList.add('open'); menu.style.visibility='visible'; chip.setAttribute('aria-expanded','true');

  const position = throttled(()=>{
    if(!menu.classList.contains('open')) return;
    const r2 = chip.getBoundingClientRect();
    let L = Math.min(Math.max(r2.right - mw, 8), innerWidth - mw - 8);
    let T = r2.bottom + gap;
    if (T + mh > innerHeight - 8) T = Math.max(8, r2.top - gap - mh);
    menu.style.left=L+'px'; menu.style.top=Math.max(8,T)+'px';
  }, 50);

  const closeOnOutside = (e)=>{ if(!menu.contains(e.target) && !chip.contains(e.target)) closeUserMenu(); };
  menu._closers={closeOnOutside, position};
  addEventListener('click', closeOnOutside, {capture:true});
  addEventListener('scroll', position, {passive:true});
  addEventListener('resize', position, {passive:true});
}
function closeUserMenu(){
  const menu=$('#usermenu'); if(!menu) return;
  menu.classList.remove('open'); menu.style.display='none';
  if(menu._closers){
    removeEventListener('click', menu._closers.closeOnOutside, {capture:true});
    removeEventListener('scroll', menu._closers.position);
    removeEventListener('resize', menu._closers.position);
    menu._closers=null;
  }
  const chip=$('#userchip'); if(chip){ chip.appendChild(menu); chip.setAttribute('aria-expanded','false'); }
}

/* Auth lock */
function setLocked(b){ const a=$('#app'); if(a) a.hidden=b; }
function buildAuthLock(){
  if($('#auth-lock')) return $('#auth-lock');
  const lock=document.createElement('div'); lock.id='auth-lock'; lock.className='overlay show';
  lock.innerHTML=`<div class="profile-card">
    <div class="fld"><label>Email</label><input type="email" id="eml" placeholder="email@example.com"></div>
    <div class="fld"><label>Parol</label><input type="password" id="pwd" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"></div>
    <div id="err" style="color:#c62828"></div>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button id="login" class="btn primary">Kirish</button>
      <button id="signup" class="btn">Ro'yxatdan o'tish</button>
      <button id="google" class="btn">Google</button>
    </div>
  </div>`;
  document.body.appendChild(lock);
  const busy=(b)=> qa('button',lock).forEach(x=>x.disabled=b);
  lock.addEventListener('click', async (e)=>{
    const id=e.target.id, errEl=$('#err',lock);
    try{
      busy(true);
      if(id==='google') await signInWithPopup(auth,new GoogleAuthProvider());
      if(id==='login'){ const eml=$('#eml',lock).value.trim(), pwd=$('#pwd',lock).value; await signInWithEmailAndPassword(auth,eml,pwd); }
      if(id==='signup'){ const eml=$('#eml',lock).value.trim(), pwd=$('#pwd',lock).value; await createUserWithEmailAndPassword(auth,eml,pwd); }
    }catch(err){ if(errEl) errEl.textContent=err?.message||String(err); } finally{ busy(false); }
  });
  return lock;
}

/* Profile API */
async function getProfile(uid){const s=await getDoc(doc(db,'profiles',uid));return s.exists()?s.data():null;}
async function saveProfile(uid,data){data.updatedAt=serverTimestamp();if(!PROFILE)data.createdAt=serverTimestamp();await setDoc(doc(db,'profiles',uid),data,{merge:false});PROFILE=data;}
async function getUserPoints(uid){try{const s=await getDoc(doc(db,'users',uid));return s.exists()?(s.data().points||0):0;}catch{return 0;}}
async function loadRegions(){
  try{const r=await fetch('./region.json',{cache:'no-store'});if(!r.ok)throw 0;const j=await r.json();return j?.regions||[];}
  catch{return[{name:"Toshkent",districts:[{name:"Chilonzor",schools:["1-maktab","12-maktab"]},{name:"Olmazor",schools:["5-maktab","14-maktab"]}]},{name:"Samarqand",districts:[{name:"Urgut",schools:["3-maktab","28-maktab"]}]}];}
}

/* Auth state */
onAuthStateChanged(auth, async (u)=>{
  CURRENT_USER=u||null;
  if(!u){ setLocked(true); buildAuthLock(); els.userSlot.innerHTML=''; return; }
  qa('#auth-lock').forEach(x=>x.remove()); setLocked(false);
  if(!REGIONS.length) REGIONS=await loadRegions();
  [PROFILE, USER_POINTS] = await Promise.all([ getProfile(u.uid), getUserPoints(u.uid) ]);
  if(PROFILE && !PROFILE.role){ PROFILE.role='O\'quvchi'; await saveProfile(u.uid, PROFILE); }
  renderUserChip(u, PROFILE||{});
  const baseOk = ALWAYS_REQ.every(k=>PROFILE && PROFILE[k]);
  const ok = baseOk && (PROFILE?.role!=='O\'quvchi' || !!PROFILE.class);
  if(!ok){ /* profilni toâ€˜ldirish modali joyi */ }
});

/* Delegation */
document.addEventListener('click', (e)=>{
  const t=e.target;
  if(t.closest('#userchip')){
    const open = $('#usermenu')?.classList.contains('open');
    open ? closeUserMenu() : openUserMenu();
  }
  if(t.closest('#mLogout')){ e.preventDefault(); closeUserMenu(); signOut(auth); }
});

/* Start */
initTheme();
await loadHome();
await (async()=>{ renderBannerCarousel(await fetchBanners()); })();
setVHAndTopGap();

  </script>
</body>
</html>
