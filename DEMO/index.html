<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>LeaderMath.UZ — Home</title>

  <link rel="icon" href="./logo.png" sizes="any">
  <link rel="apple-touch-icon" href="./logo.png">
  <meta name="theme-color" content="#2E8B57"/>

  <style>
  /* ===============================
     LeaderMath.UZ — Neo 3D (v3)
     =============================== */
  :root{
    --brand:#2E8B57; --brand-600:#1f6a41; --brand-700:#145935;
    --bg:#F6FAF7; --bg-2:#ECF4EF; --card:#FFFFFF; --text:#0f1b15;
    --muted:#647c70; --line:#E2ECE6;
    --e1:0 6px 18px rgba(18,40,28,.08);
    --e2:0 14px 40px rgba(18,40,28,.12);
    --e3:0 28px 90px rgba(18,40,28,.18);
    --blur:saturate(1.12) blur(10px);
    --speed:.28s; --speed-fast:.16s;
    --ring:0 0 0 3px color-mix(in srgb, var(--brand) 50%, transparent);
    --gbrand:linear-gradient(180deg, #7fd1a5, var(--brand));
  }
  html,body{height:100%}
  body{
    margin:0;color:var(--text);
    font:16px/1.55 system-ui, Segoe UI, Inter, Arial;
    background:
      radial-gradient(1200px 600px at 10% -10%, #e7f6ee66, transparent 55%),
      radial-gradient(900px 500px at 95% 0%, #e5f4ec55, transparent 60%),
      linear-gradient(180deg,var(--bg),var(--bg-2));
  }

  /* ===== Header (glass) ===== */
  .hdr{
    position:sticky; top:0; z-index:60;
    backdrop-filter:var(--blur);
    background:linear-gradient(180deg, color-mix(in srgb, var(--card) 85%, transparent), transparent);
    border-bottom:1px solid color-mix(in srgb, var(--line) 60%, transparent);
  }
  .row{max-width:1180px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:14px}
  .brand{display:flex;align-items:center;gap:12px;font-weight:900;letter-spacing:.2px;transform-style:preserve-3d}
  .brand img{width:56px;height:56px;border-radius:14px;display:block;box-shadow:0 12px 36px rgba(46,139,87,.28);transform:translateZ(20px)}
  .brand b{color:var(--brand)}
  .grow{flex:1}

  /* ===== Sticky chipbar (invisible horizontal scroll) ===== */
  .chipbar-wrap{
    position:sticky; top:72px; z-index:55;
    background:linear-gradient(180deg, color-mix(in srgb, var(--card) 70%, transparent), transparent);
    border-bottom:1px solid color-mix(in srgb, var(--line) 60%, transparent);
    backdrop-filter:saturate(1.05) blur(6px);
  }
  .chipbar{
    max-width:1180px;margin:0 auto;padding:8px 16px 10px;
    display:flex;gap:10px;overflow-x:auto;overflow-y:hidden;
    -webkit-overflow-scrolling:touch;scroll-behavior:smooth;scroll-snap-type:x proximity;
  }
  .chipbar::-webkit-scrollbar{display:none}
  .chipbar{scrollbar-width:none}
  .chip{
    appearance:none;border:1px solid var(--line);background:var(--card);
    border-radius:999px;padding:10px 14px;cursor:pointer;user-select:none;
    box-shadow:var(--e1);transition:transform var(--speed),box-shadow var(--speed),background var(--speed);
    font-weight:700;scroll-snap-align:center;white-space:nowrap;
  }
  .chip:hover{transform:translateY(-2px);box-shadow:var(--e2)}
  .chip.active{background:var(--gbrand);color:#fff;border-color:transparent;transform:translateY(-2px);box-shadow:0 16px 40px rgba(46,139,87,.4)}

  /* ===== Main / Sections ===== */
  main{max-width:1180px;margin:0 auto;padding:14px 16px 56px}
  .section{
    background:var(--card);border:1px solid var(--line);border-radius:22px;
    box-shadow:var(--e1);overflow:hidden;transition:transform var(--speed),box-shadow var(--speed),border-color var(--speed);
    margin:14px 0;transform-style:preserve-3d;animation:float-in .6s cubic-bezier(.2,.7,.2,1) both;
  }
  .section:hover{transform:translateY(-6px) rotateX(.6deg) rotateY(.4deg);box-shadow:var(--e3);border-color:color-mix(in srgb,var(--brand) 35%, var(--line))}
  .section-hdr{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,color-mix(in srgb,var(--card) 85%,transparent),transparent)}
  .section-hdr h3{margin:0;font-size:18px}
  .iframe-wrap{position:relative}
  iframe.sbx{display:block;width:100%;min-height:640px;border:0;background:transparent;transform:translateZ(1px)}

  /* ====== asBody (full-bleed, no scroll) ====== */
  .section.as-body{
    background:transparent;border:none;box-shadow:none;border-radius:0;margin:0;
  }
  .section.as-body .iframe-wrap{ /* h balandlik JS bilan beriladi */ }
  .section.as-body iframe.sbx{
    min-height:0; /* JS calcHeight beradi */
    display:block;border:0;background:transparent;
  }

  /* ===== Overlay / menu / buttons (ixcham) ===== */
  .userchip{border:1px solid var(--line);background:var(--card);padding:6px 10px;border-radius:999px;box-shadow:var(--e1);display:flex;align-items:center;gap:10px;cursor:pointer;position:relative}
  .avatar{width:32px;height:32px;border-radius:50%;overflow:hidden;background:linear-gradient(135deg,#dcefe5,#f1faf5)}
  .menu{position:absolute;right:0;top:46px;min-width:260px;background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--e2);display:none;overflow:hidden}
  .menu.open{display:block}
  .menu a{display:flex;align-items:center;gap:10px;padding:12px 14px;text-decoration:none;color:inherit;border-bottom:1px solid var(--line)}
  .menu a:last-child{border-bottom:none}
  .ico{width:18px;height:18px;display:inline-block}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.2);display:none;place-items:center;z-index:70}
  .overlay.show{display:grid}
  .profile-card{width:min(820px,96vw);background:var(--card);border:1px solid var(--line);border-radius:22px;box-shadow:var(--e2);padding:22px}

  @keyframes float-in{from{opacity:0;transform:translateY(16px) rotateX(3deg)}to{opacity:1;transform:translateY(0) rotateX(0)}}
  @media (max-width:900px){iframe.sbx{min-height:520px} }
  </style>
</head>
<body>
  <header class="hdr" id="hdr">
    <div class="row">
      <div class="brand">
        <img src="./logo.png" alt="LM"/>
        <div style="display:grid;line-height:1.1">
          <span style="font-size:18px;font-weight:900">LeaderMath.<b style="color:var(--brand)">UZ</b></span>
          <small style="color:var(--muted)">Matematika platformasi</small>
        </div>
      </div>
      <div class="grow"></div>
      <div id="user-slot"></div>
    </div>
    <div class="chipbar-wrap" id="chipsWrap">
      <nav id="chipbar" class="chipbar" aria-label="Bo‘limlar"></nav>
    </div>
  </header>

  <main id="app"><div id="sections"></div></main>
  <div id="overlay" class="overlay"></div>

  <script type="module">
  /* === Firebase (o‘zingizniki, o‘zgarmagan) === */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, setPersistence, browserLocalPersistence, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getStorage, ref as sRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
    authDomain: "xplusy-760fa.firebaseapp.com",
    projectId: "xplusy-760fa",
    storageBucket: "xplusy-760fa.appspot.com",
    messagingSenderId: "992512966017",
    appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
    measurementId: "G-459PLJ7P7L"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const st   = getStorage(app);
  try { await setPersistence(auth, browserLocalPersistence); } catch {}

  const q=(s,r=document)=>r.querySelector(s); const qa=(s,r=document)=>[...r.querySelectorAll(s)];

  /* === Minimal profil / user chip (ixcham) === */
  let CURRENT_USER=null, PROFILE=null, USER_POINTS=0;
  const svgPhone='<svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M6.6 10.2c1.5 2.9 3.9 5.2 6.8 6.8l2.3-2.3c.3-.3.8-.4 1.2-.3 1 .3 2 .4 3 .4.7 0 1.1.5 1.1 1.1V20c0 .7-.5 1.1-1.1 1.1C10.6 21.1 2.9 13.4 2.9 3.1 2.9 2.5 3.4 2 4.1 2h3.1c.7 0 1.1.5 1.1 1.1 0 1 .1 2 .4 3 .1.4 0 .9-.3 1.2L6.6 10.2z"/></svg>';
  const svgMail ='<svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5L4 8V6l8 5 8-5v2z"/></svg>';
  const svgTg   ='<svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M9.4 15.6 9.1 19c.4 0 .6-.2 .9-.4l2-1.8 4.2 3.1c.8.5 1.4.2 1.6-.7l2.9-13.7c.3-1.3-.5-1.8-1.3-1.5L2.6 9.6c-1.3.5-1.3 1.2-.2 1.5l4.8 1.5 11.3-7c.5-.3 1-.1 .6.2"/></svg>';

  async function getProfile(uid){const s=await getDoc(doc(db,'profiles',uid)); return s.exists()? s.data(): null;}
  async function getUserPoints(uid){try{const s=await getDoc(doc(db,'users',uid)); return s.exists()?(s.data().points||0):0;}catch{return 0;}}

  function renderUserChip(u, profile){
    const name = profile?.firstName ? (profile.firstName + (profile.lastName?' '+profile.lastName:'')) : (u.displayName||u.email||'Foydalanuvchi');
    const avatar = profile?.avatarUrl || u.photoURL || '';
    const role = profile?.role || '—';
    q('#user-slot').innerHTML = `
      <div class="userchip" id="userchip">
        <div class="avatar">${avatar?`<img src="${avatar}" alt="">`:''}</div>
        <div style="display:grid;line-height:1"><b style="font-size:14px">${name}</b>
          <small class="mini">${role} • ${USER_POINTS} points</small></div>
        <div class="menu" id="usermenu">
          <a href="#" id="mLogout">Chiqish</a>
          <div class="label" style="padding:8px 14px;color:#6b7f75;border-top:1px solid #e5efe9">Aloqa</div>
          <a href="tel:+998901234567">${svgPhone} +998 90 123 45 67</a>
          <a href="mailto:info@leadermath.uz">${svgMail} info@leadermath.uz</a>
          <a href="https://t.me/LeaderMathUZ" target="_blank" rel="noopener">${svgTg} Telegram</a>
        </div>
      </div>`;
    const chip=q('#userchip'), menu=q('#usermenu');
    chip.onclick=()=>menu.classList.toggle('open');
    q('#mLogout').onclick=(e)=>{e.preventDefault(); signOut(auth);};
  }

  /* ===== Home sections ===== */
  async function fetchHome(){
    try{const s=await getDoc(doc(db,'configs','home')); if(s.exists()){const d=s.data(); if(Array.isArray(d.sections)) return d;}}
    catch(e){}
    const r=await fetch('./home.json',{cache:'no-store'}); if(!r.ok) return {sections:[]}; return await r.json();
  }

  // AsBody iframe’larni viewport’ga moslab balandlik berish
  function sizeAsBodyIframes(){
    const hdr = q('#hdr');
    const chipsWrap = q('#chipsWrap');
    const headerH = hdr ? hdr.getBoundingClientRect().height : 0;
    const chipsH  = chipsWrap ? chipsWrap.getBoundingClientRect().height : 0;

    const avail = Math.max(0, window.innerHeight - headerH - chipsH);

    qa('.section.as-body iframe.sbx').forEach(ifr=>{
      // to‘liq ko‘rsatish (scrollsiz)
      ifr.style.height = avail + 'px';
    });
  }

  // Agar banner.html parent’ga height yuborsa (ixtiyoriy, lekin qo‘llab-quvvatlaymiz)
  // window.parent.postMessage({type:'bannerHeight', height: <px>}, '*')
  window.addEventListener('message', (ev)=>{
    try{
      const data = ev.data || {};
      if(data.type === 'bannerHeight' && Number.isFinite(+data.height)){
        // Agar banner ichidan aniq height kelsa — undan foydalanamiz
        qa('.section.as-body iframe.sbx').forEach(ifr=>{
          ifr.style.height = Math.max(0, +data.height) + 'px';
        });
      }
    }catch{}
  });

  const state={sections:[],activeId:null};
  function renderChips(){
    const bar=q('#chipbar'); bar.innerHTML='';
    state.sections.forEach((s,i)=>{
      const b=document.createElement('button');
      b.className='chip'+(i===0?' active':'');
      b.textContent=s.title||s.id||('Bo‘lim '+(i+1));
      b.dataset.target=s.id||('sec'+i);
      b.onclick=()=>{
        activate(b.dataset.target);
        b.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'});
      };
      bar.appendChild(b);
    });
  }
  function renderSections(){
    const host=q('#sections'); host.innerHTML='';
    state.sections.forEach((s,i)=>{
      const id=s.id||('sec'+i);
      const outer=document.createElement('section');
      outer.className='section'+(s.asBody?' as-body':'');
      outer.dataset.section=id;

      if(s.title && !s.asBody){
        const sh=document.createElement('div'); sh.className='section-hdr';
        sh.innerHTML = '<h3>'+(s.title||'')+'</h3>';
        outer.appendChild(sh);
      }

      const cont=document.createElement('div'); cont.className='iframe-wrap';
      const ifr=document.createElement('iframe');
      ifr.className='sbx';
      ifr.setAttribute('sandbox', s.sandbox || 'allow-scripts allow-same-origin allow-forms');

      if(s.mode==='url' && s.src){ ifr.src=s.src; }
      else {
        const base=s.baseHref?'<base href="'+s.baseHref+'">':''; 
        ifr.srcdoc='<!doctype html><html><head>'+base+'<meta charset="utf-8"></head><body style="margin:0">'+(s.contentHtml||'')+'</body></html>';
      }
      cont.appendChild(ifr); outer.appendChild(cont); host.appendChild(outer);
    });
    // Renderdan keyin banner balandligini hisobla
    requestAnimationFrame(sizeAsBodyIframes);
  }
  function activate(id){
    state.activeId=id;
    qa('.chip').forEach(c=>c.classList.toggle('active',c.dataset.target===id));
    qa('[data-section]').forEach(s=>s.style.display=(s.dataset.section===id)?'block':'none');
    const vis=q('[data-section="'+id+'"]'); if(vis) vis.scrollIntoView({behavior:'smooth',block:'start'});
    sizeAsBodyIframes();
  }

  async function loadHome(){
    const d=await fetchHome();
    state.sections=Array.isArray(d.sections)?d.sections:[];
    renderChips(); renderSections();
    if(state.sections.length) activate(state.sections[0].id||'sec0');
  }

  // Dinamik reflow: resize/orientation/font-load/sticky o‘zgarishlarida qayta hisoblash
  ['resize','orientationchange'].forEach(evt=>window.addEventListener(evt, sizeAsBodyIframes));
  // chipbar balandligi dinamik bo‘lsa:
  const chipsObs = new ResizeObserver(sizeAsBodyIframes);
  chipsObs.observe(q('#chipsWrap'));
  // header ham:
  const hdrObs = new ResizeObserver(sizeAsBodyIframes);
  hdrObs.observe(q('#hdr'));

  // ===== Auth — minimal (faqat logout ko‘rsatamiz) =====
  onAuthStateChanged(auth, async (u)=>{
    CURRENT_USER=u||null;
    if(!u){ q('#user-slot').innerHTML = `<button id="loginBtn" class="chip" style="font-weight:800">Kirish</button>`; q('#loginBtn').onclick=()=>signInWithPopup(auth,new GoogleAuthProvider()); return; }
    [PROFILE, USER_POINTS] = await Promise.all([ getProfile(u.uid), getUserPoints(u.uid) ]);
    renderUserChip(u, PROFILE||{});
  });

  // Chip markazga keltirish “pointerdown”
  document.addEventListener('pointerdown',(e)=>{
    const t=e.target.closest('.chip'); if(!t) return;
    t.scrollIntoView({behavior:'smooth',inline:'center',block:'nearest'});
  });

  await loadHome();
  </script>
</body>
</html>
