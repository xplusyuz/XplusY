<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LeaderMath.UZ — Home + Profil</title>

  <link rel="icon" href="./logo.png" sizes="any">
  <link rel="apple-touch-icon" href="./logo.png">
  <meta name="theme-color" content="#2E8B57"/>
  <style>
/* ============================
   LeaderMath.UZ — Neo UI (3D)
   ============================ */
:root{
  /* Colors */
  --brand:#2E8B57; --brand-600:#1f6a41; --brand-700:#145935;
  --bg:#F6FAF7; --bg-2:#ECF4EF; --card:#ffffff; --text:#0e1813;
  --muted:#5f7469; --line:#E2ECE6;

  /* Elevation */
  --e1:0 6px 18px rgba(18,40,28,.08);
  --e2:0 14px 40px rgba(18,40,28,.12);
  --e3:0 24px 70px rgba(18,40,28,.18);

  /* FX */
  --blur:saturate(1.15) blur(10px);
  --speed:.28s; --speed-fast:.16s; --ring:0 0 0 3px color-mix(in srgb,var(--brand) 50%, transparent);

  /* Gradients */
  --g1:conic-gradient(from 180deg at 50% 50%, #e9f7ef, #fbfffd, #e9f7ef);
  --gbrand:linear-gradient(180deg, color-mix(in srgb, var(--brand) 25%, #fff), var(--brand));
}
html[data-theme="dark"]{
  --bg:#0b1010; --bg-2:#0e1514; --card:#0f1615; --text:#e9f4ef; --muted:#9ab0a6; --line:#19241f;
  --e1:0 8px 24px rgba(0,0,0,.40); --e2:0 18px 60px rgba(0,0,0,.50); --e3:0 30px 90px rgba(0,0,0,.65);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  color:var(--text);
  font:16px/1.55 system-ui, Segoe UI, Inter, Arial;
  background:
    radial-gradient(1200px 600px at 10% -10%, #e7f6ee77, transparent 55%),
    radial-gradient(900px 500px at 95% 0%, #e5f4ec66, transparent 60%),
    linear-gradient(180deg,var(--bg),var(--bg-2));
}

/* ===== Header (glass + parallax) ===== */
.hdr{
  position:sticky; top:0; z-index:50;
  backdrop-filter:var(--blur);
  background:linear-gradient(180deg, color-mix(in srgb, var(--card) 85%, transparent), transparent);
  border-bottom:1px solid color-mix(in srgb, var(--line) 60%, transparent);
}
.row{max-width:1180px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:14px}
.brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.2px;transform-style:preserve-3d}
.brand img{
  border-radius:12px; width:52px; height:52px; display:block;
  box-shadow:0 10px 30px rgba(46,139,87,.25);
  transform:translateZ(20px) rotateZ(0.0001deg);
}
.brand span{transform:translateZ(8px)}
.brand small{opacity:.8}

/* ===== Chips (tabs) + ripple ===== */
.chipbar{max-width:1180px;margin:8px auto 0;padding:0 16px 16px;display:flex;flex-wrap:wrap;gap:10px}
.chip{
  appearance:none; cursor:pointer; user-select:none;
  border:1px solid var(--line); background:var(--card);
  border-radius:999px; padding:10px 14px; font-weight:600;
  box-shadow:var(--e1); transition:transform var(--speed), box-shadow var(--speed), background var(--speed);
  position:relative; overflow:hidden;
}
.chip:hover{transform:translateY(-2px); box-shadow:var(--e2)}
.chip.active{
  background:var(--gbrand); color:#fff; border-color:transparent; transform:translateY(-2px);
  box-shadow:0 12px 40px color-mix(in srgb,var(--brand) 40%, transparent);
}
.chip:active::after{
  content:""; position:absolute; inset:-20px; border-radius:50%;
  background:radial-gradient(120px 120px at var(--x,50%) var(--y,50%), #ffffff66, transparent 60%);
  animation:ripple .5s ease-out;
}
@keyframes ripple{from{opacity:.9; transform:scale(.6)} to{opacity:0; transform:scale(1.1)}}

/* ===== Main / Sections (3D tilt + glow) ===== */
main{max-width:1180px;margin:0 auto;padding:12px 16px 56px; perspective:1200px}
.section{
  background:var(--card); border:1px solid var(--line); border-radius:22px;
  box-shadow:var(--e1); overflow:hidden; transform-style:preserve-3d;
  transition:transform var(--speed), box-shadow var(--speed), border-color var(--speed);
  position:relative; isolation:isolate;
  animation:float-in .6s cubic-bezier(.2,.7,.2,1) both;
}
.section::before{
  /* glossy rim light */
  content:""; position:absolute; inset:-1px; border-radius:inherit; z-index:-1;
  background:conic-gradient(from 220deg at 50% 50%, #ffffff00, #9ee0bd22, #ffffff00 60%);
  filter:blur(8px); opacity:.7; transform:translateZ(-1px);
}
.section:hover{
  transform:translateY(-6px) rotateX(.6deg) rotateY(.6deg);
  box-shadow:var(--e3); border-color:color-mix(in srgb,var(--brand) 35%, var(--line));
}
.section-hdr{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px; border-bottom:1px solid var(--line);
  background:linear-gradient(180deg, color-mix(in srgb,var(--card) 85%, transparent), transparent);
}
.section-hdr h3{margin:0;font-size:18px;letter-spacing:.2px}
.iframe-wrap{position:relative}
iframe.sbx{display:block;width:100%;min-height:640px;border:0;background:#fff;transform:translateZ(1px)}

/* ===== Auth modal ===== */
.lock{position:fixed;inset:0;display:grid;place-items:center;background:color-mix(in srgb,var(--bg) 70%, #0000);backdrop-filter:blur(2px);animation:fade .4s ease}
.card{
  width:min(520px,96vw); background:var(--card);
  border:1px solid var(--line); border-radius:22px; box-shadow:var(--e2); padding:22px;
  transform:translateY(8px) scale(.98); animation:pop .35s ease forwards;
}
.btn{
  appearance:none; border:1px solid var(--line); background:var(--card); color:var(--text);
  padding:12px 16px; border-radius:14px; cursor:pointer; transition:transform var(--speed-fast), box-shadow var(--speed-fast), background var(--speed-fast);
  display:inline-flex; align-items:center; justify-content:center; gap:8px; font-weight:700; box-shadow:var(--e1);
}
.btn:hover{transform:translateY(-1px); box-shadow:var(--e2)}
.btn.primary{background:var(--gbrand); color:#fff; border-color:transparent}
.btn.full{width:100%}
.fld{display:grid;gap:8px;margin:10px 0}
.fld input,.fld select,.fld textarea{
  width:100%; padding:12px 14px; border-radius:14px; border:1px solid var(--line);
  background:linear-gradient(180deg, var(--card), color-mix(in srgb,var(--card) 92%, #000));
  transition:border-color var(--speed-fast), box-shadow var(--speed-fast), background var(--speed-fast);
}
.fld input:focus,.fld select:focus,.fld textarea:focus{border-color:color-mix(in srgb,var(--brand) 50%, var(--line)); box-shadow:var(--ring)}

/* ===== Userchip + menu ===== */
.userchip{
  border:1px solid var(--line); background:var(--card); padding:6px 10px; border-radius:999px;
  box-shadow:var(--e1); display:flex; align-items:center; gap:10px; cursor:pointer; position:relative;
  transition:transform var(--speed-fast), box-shadow var(--speed-fast);
}
.userchip:hover{transform:translateY(-2px); box-shadow:var(--e2)}
.avatar{width:32px;height:32px;border-radius:50%;overflow:hidden;background:var(--g1)}
.avatar img{width:100%;height:100%;object-fit:cover;display:block;transform:scale(1);transition:transform .35s cubic-bezier(.2,.7,.2,1)}
.userchip:hover .avatar img{transform:scale(1.06)}

.menu{
  position:absolute; right:0; top:46px; min-width:260px; background:var(--card);
  border:1px solid var(--line); border-radius:16px; box-shadow:var(--e2); display:none; overflow:hidden;
  transform-origin:100% 0; transform:translateY(6px) scale(.96); opacity:0;
}
.menu.open{display:block; animation:menu-in .18s ease forwards}
.menu a{display:flex;align-items:center;gap:10px;padding:12px 14px;text-decoration:none;color:inherit;border-bottom:1px solid var(--line); transition:background var(--speed-fast)}
.menu a:last-child{border-bottom:none}
.menu a:hover{background:color-mix(in srgb, var(--brand) 10%, transparent)}
.menu .label{padding:8px 14px;color:var(--muted);font-size:12px;border-bottom:1px solid var(--line);background:color-mix(in srgb, var(--card) 60%, transparent)}
.ico{width:18px;height:18px;display:inline-block}

/* ===== Overlay / profile ===== */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.18);display:none;place-items:center;z-index:60}
.overlay.show{display:grid;animation:fade .2s ease}
.profile-card{
  width:min(820px,96vw); background:var(--card); border:1px solid var(--line); border-radius:22px; box-shadow:var(--e2); padding:22px;
  transform:translateY(8px) rotateX(2deg); transform-origin:50% 100%; animation:pop .28s ease forwards;
}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.muted{color:var(--muted)} .divider{height:1px;background:var(--line);margin:12px 0}

/* ===== Animations ===== */
@keyframes pop{from{opacity:0; transform:translateY(14px) scale(.98)} to{opacity:1; transform:translateY(0) scale(1)}}
@keyframes fade{from{opacity:0} to{opacity:1}}
@keyframes float-in{from{opacity:0; transform:translateY(16px) rotateX(3deg)} to{opacity:1; transform:translateY(0) rotateX(0)}}
@keyframes menu-in{from{opacity:0; transform:translateY(8px) scale(.96)} to{opacity:1; transform:translateY(0) scale(1)}}

/* ===== Reduced Motion ===== */
@media (prefers-reduced-motion:reduce){
  *{animation:none!important; transition:none!important}
  .section, .userchip, .btn{transform:none!important}
}

/* ===== Responsive ===== */
@media (max-width:900px){
  .grid2,.grid3{grid-template-columns:1fr}
  iframe.sbx{min-height:520px}
}
</style>
</head>
<body>
  <header class="hdr">
    <div class="row">
      <div class="brand">
        <img src="./logo.png" alt="LM" width="52" height="52" style="border-radius:12px"/>
        <div style="display:grid;line-height:1.1">
          <span style="font-size:18px;font-weight:800">LeaderMath.<b style="color:var(--brand)">UZ</b></span>
          <small style="color:var(--muted)">Matematika platformasi</small>
        </div>
      </div>
      <div class="grow"></div>
      <div id="user-slot"></div>
    </div>
    <nav id="chipbar" class="chipbar"></nav>
  </header>

  <main id="app"><div id="sections"></div></main>
  <div id="overlay" class="overlay"></div>

  <script type="module">
  // Ripple koordinata: chip bosilganda --x/--y
document.addEventListener('pointerdown', (e)=>{
  const t = e.target.closest('.chip');
  if(!t) return;
  const r = t.getBoundingClientRect();
  t.style.setProperty('--x', ((e.clientX - r.left)/r.width*100)+'%');
  t.style.setProperty('--y', ((e.clientY - r.top)/r.height*100)+'%');
});
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, setPersistence, browserLocalPersistence, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
  import { getStorage, ref as sRef, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
    authDomain: "xplusy-760fa.firebaseapp.com",
    projectId: "xplusy-760fa",
    storageBucket: "xplusy-760fa.appspot.com",
    messagingSenderId: "992512966017",
    appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
    measurementId: "G-459PLJ7P7L"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const st   = getStorage(app);
  try { await setPersistence(auth, browserLocalPersistence); } catch {}

  const q=(s,r=document)=>r.querySelector(s); const qa=(s,r=document)=>[...r.querySelectorAll(s)];
  const ALWAYS_REQ=['firstName','lastName','birthDate','region','district','role'];
  let REGIONS=[]; let CURRENT_USER=null; let PROFILE=null; let USER_POINTS=0;

  const calcAge=iso=>{try{const b=new Date(iso),t=new Date();let a=t.getFullYear()-b.getFullYear();const m=t.getMonth()-b.getMonth();if(m<0||(m===0&&t.getDate()<b.getDate()))a--;return a;}catch{return '';}};
  async function getProfile(uid){const s=await getDoc(doc(db,'profiles',uid));return s.exists()?s.data():null;}
  async function saveProfile(uid,data){data.updatedAt=serverTimestamp();if(!PROFILE)data.createdAt=serverTimestamp();await setDoc(doc(db,'profiles',uid),data,{merge:false});PROFILE=data;}
  async function getUserPoints(uid){try{const s=await getDoc(doc(db,'users',uid));return s.exists()?(s.data().points||0):0;}catch{return 0;}}

  async function loadRegions(){
    try{const r=await fetch('./region.json',{cache:'no-store'});if(!r.ok)throw 0;const j=await r.json();return j?.regions||[];}
    catch{return[{name:"Toshkent",districts:[{name:"Chilonzor",schools:["1-maktab","12-maktab"]},{name:"Olmazor",schools:["5-maktab","14-maktab"]}]},{name:"Samarqand",districts:[{name:"Urgut",schools:["3-maktab","28-maktab"]}]}];}
  }

  // SVG ikonalar (alohida stringlar)
  const svgPhone='<svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M6.6 10.2c1.5 2.9 3.9 5.2 6.8 6.8l2.3-2.3c.3-.3.8-.4 1.2-.3 1 .3 2 .4 3 .4.7 0 1.1.5 1.1 1.1V20c0 .7-.5 1.1-1.1 1.1C10.6 21.1 2.9 13.4 2.9 3.1 2.9 2.5 3.4 2 4.1 2h3.1c.7 0 1.1.5 1.1 1.1 0 1 .1 2 .4 3 .1.4 0 .9-.3 1.2L6.6 10.2z"/></svg>';
  const svgMail ='<svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5L4 8V6l8 5 8-5v2z"/></svg>';
  const svgTg   ='<svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M9.4 15.6 9.1 19c.4 0 .6-.2.9-.4l2-1.8 4.2 3.1c.8.5 1.4.2 1.6-.7l2.9-13.7c.3-1.3-.5-1.8-1.3-1.5L2.6 9.6c-1.3.5-1.3 1.2-.2 1.5l4.8 1.5 11.3-7c.5-.3 1-.1 .6.2"/></svg>';
  const svgIg   ='<svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M7 2h10a5 5 0 0 1 5 5v10a5 5 0 0 1-5 5H7a5 5 0 0 1-5-5V7a5 5 0 0 1 5-5zm5 5a5 5 0 1 0 .001 10.001A5 5 0 0 0 12 7zm0 2.5a2.5 2.5 0 1 1-.001 5.001A2.5 2.5 0 0 1 12 9.5zm5.2-3a1 1 0 1 0 0 2 1 1 0 0 0 0-2z"/></svg>';
  const svgYt   ='<svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M23.5 6.2s-.2-1.6-.9-2.3c-.9-.9-1.8-.9-2.2-1C16.9 2.5 12 2.5 12 2.5h-.1s-4.9 0-8.4.4c-.4.1-1.3.1-2.2 1-.7.7-.9 2.3-.9 2.3S0 8.1 0 10v1.9c0 1.9.5 3.8.5 3.8s.2 1.6.9 2.3c.9.9 2.1.9 2.6 1 1.9.2 8 .4 8 .4s4.9 0 8.4-.4c.4-.1 1.3-.1 2.2-1 .7-.7.9-2.3.9-2.3S24 13.8 24 12V10c0-1.9-.5-3.8-.5-3.8zM9.5 14.6V7.9l6.4 3.3-6.4 3.4z"/></svg>';

  function renderUserChip(u, profile){
    const slot=q('#user-slot'); if(!slot) return;
    const age=profile?.birthDate?calcAge(profile.birthDate):''; const name=profile?.firstName?(profile.firstName+(profile.lastName?' '+profile.lastName:'')):(u.displayName||u.email||'Foydalanuvchi');
    const avatar=profile?.avatarUrl||u.photoURL||''; const role=profile?.role||'—';
    slot.innerHTML=`
      <div class="userchip" id="userchip">
        <div class="avatar">${avatar?`<img src="${avatar}" alt="">`:''}</div>
        <div style="display:grid;line-height:1"><b style="font-size:14px">${name}</b><small class="mini">${role} • ${age?age+' yosh • ':''}${USER_POINTS} points</small></div>
        <div class="menu" id="usermenu">
          <a href="#" id="mProfile">Profil</a>
          <a href="#" id="mEdit">Profilni tahrirlash</a>
          <a href="#" id="mLogout">Chiqish</a>
          <div class="label">Aloqa</div>
          <a href="tel:+998901234567">${svgPhone} +998 90 123 45 67</a>
          <a href="mailto:info@leadermath.uz">${svgMail} info@leadermath.uz</a>
          <a href="https://t.me/LeaderMathUZ" target="_blank" rel="noopener">${svgTg} Telegram</a>
          <a href="https://t.me/LeaderMathBot" target="_blank" rel="noopener">${svgTg} Bot</a>
          <a href="https://instagram.com/leadermath.uz" target="_blank" rel="noopener">${svgIg} Instagram</a>
          <a href="https://www.youtube.com/@leadermathuz" target="_blank" rel="noopener">${svgYt} YouTube</a>
        </div>
      </div>`;
    const chip=q('#userchip',slot), menu=q('#usermenu',slot);
    chip.onclick=()=>menu.classList.toggle('open');
    q('#mLogout',slot).onclick=e=>{e.preventDefault();menu.classList.remove('open');signOut(auth);};
    q('#mProfile',slot).onclick=e=>{e.preventDefault();menu.classList.remove('open');openProfileView();};
    q('#mEdit',slot).onclick=e=>{e.preventDefault();menu.classList.remove('open');openProfileEditor();};
  }

  function openProfileView(){
    const d=PROFILE||{}; const name=(d.firstName||'')+(d.lastName?' '+d.lastName:''); const age=d.birthDate?calcAge(d.birthDate):''; const avatar=d.avatarUrl||(CURRENT_USER?.photoURL||'');
    const html=`
      <div class="profile-card">
        <div class="rowx" style="align-items:center">
          <div class="avatar" style="width:56px;height:56px;border-radius:14px;overflow:hidden;background:#f2f6f3">${avatar?`<img src="${avatar}" alt="">`:''}</div>
          <div style="display:grid"><b style="font-size:18px">${name||'—'}</b><span class="muted">${(d.role||'—')} • ${age?age+' yosh • ':''}${USER_POINTS} points</span></div>
          <div class="grow"></div><button class="btn" id="toEdit">Tahrirlash</button><button class="btn" id="closeView">Yopish</button>
        </div><div class="divider"></div>
        <div class="grid3">
          <div><div class="muted">Viloyat</div><b>${d.region||'—'}</b></div>
          <div><div class="muted">Tuman</div><b>${d.district||'—'}</b></div>
          <div><div class="muted">Tug‘ilgan sana</div><b>${d.birthDate||'—'}</b></div>
        </div>
        ${d.role==='O‘quvchi'?`<div style="height:6px"></div><div class="grid3"><div><div class="muted">Sinf</div><b>${d.class||'—'}</b></div><div><div class="muted">Maktab</div><b>${d.school||d.schoolCustom||'—'}</b></div><div></div></div>`:''}
      </div>`;
    showOverlay(html); q('#toEdit').onclick=()=>{closeOverlay();openProfileEditor();}; q('#closeView').onclick=closeOverlay;
  }

  function openProfileEditor(){
    const d=PROFILE||{}; const avatar=d.avatarUrl||(CURRENT_USER?.photoURL||'');
    const html=`
      <div class="profile-card">
        <div class="rowx" style="align-items:center">
          <div class="avatar" style="width:56px;height:56px;border-radius:14px;overflow:hidden;background:#f2f6f3" id="pAvatar">${avatar?`<img src="${avatar}" alt="">`:''}</div>
          <div class="grow"></div>
          <label class="btn"><input type="file" id="avatarFile" accept="image/*" style="display:none"> Fayldan avatar</label>
          <button class="btn" id="avatarUrlBtn">URLdan o‘rnatish</button>
        </div>
        <div class="divider"></div>
        <div class="grid2">
          <div class="fld"><label>Ism</label><input id="firstName" value="${d.firstName||''}" placeholder="Ismingiz"></div>
          <div class="fld"><label>Familiya</label><input id="lastName" value="${d.lastName||''}" placeholder="Familiyangiz"></div>
        </div>
        <div class="grid2">
          <div class="fld"><label>Tug‘ilgan kun</label><input type="date" id="birthDate" value="${d.birthDate||''}"></div>
          <div class="fld"><label>Roli</label>
            <select id="roleSel">
              ${['O‘quvchi','O‘qituvchi','Talaba','Abituriyent'].map(r=>`<option ${(d.role||'O‘quvchi')===r?'selected':''}>${r}</option>`).join('')}
            </select>
          </div>
        </div>
        <div id="stuBlock">
          <div class="grid2">
            <div class="fld"><label>Sinf</label>
              <select id="class">${Array.from({length:11},(_,i)=>i+1).map(n=>`<option value="${n}" ${d.class==n?'selected':''}>${n}-sinf</option>`).join('')}</select>
            </div>
            <div class="fld"><label>Maktab</label><select id="schoolSel"></select><small class="muted">Ro‘yxatdan tanlang yoki “Boshqa…”</small></div>
          </div>
          <div class="fld"><label>Boshqa maktab (ixtiyoriy)</label><input id="schoolCustom" value="${d.schoolCustom||''}" placeholder="Masalan: 12-maktab filiali"></div>
        </div>
        <div class="grid2">
          <div class="fld"><label>Viloyat</label><select id="regionSel"></select></div>
          <div class="fld"><label>Tuman</label><select id="districtSel"></select></div>
        </div>
        <div class="divider"></div>
        <div class="rowx"><button class="btn" id="cancelEdit">Bekor qilish</button><div class="grow"></div><button class="btn primary" id="saveProfile">Saqlash</button></div>
      </div>`;
    showOverlay(html);

    const rSel=q('#regionSel'), dSel=q('#districtSel'), sSel=q('#schoolSel');
    function fillRegions(){rSel.innerHTML=`<option value="">Tanlang...</option>`+REGIONS.map(r=>`<option value="${r.name}">${r.name}</option>`).join(''); if(d.region) rSel.value=d.region; fillDistricts(); fillSchools();}
    function fillDistricts(){const r=REGIONS.find(x=>x.name===rSel.value); const districts=(r?.districts||[]).map(x=>typeof x==='string'?{name:x,schools:[]}:x); dSel.innerHTML=`<option value="">Tanlang...</option>`+districts.map(t=>`<option value="${t.name}">${t.name}</option>`).join(''); if(d.district) dSel.value=d.district;}
    function fillSchools(){const r=REGIONS.find(x=>x.name===rSel.value); const t=(r?.districts||[]).map(x=>typeof x==='string'?{name:x,schools:[]}:x).find(x=>x.name===dSel.value); const schools=t?.schools||[]; sSel.innerHTML=schools.map(s=>`<option value="${s}">${s}</option>`).join('')+`<option value="__other__">Boshqa…</option>`; sSel.value=schools.includes(d.school)?d.school:"__other__";}
    rSel.onchange=()=>{fillDistricts();fillSchools();}; dSel.onchange=fillSchools; fillRegions();

    const roleSel=q('#roleSel'); const stuBlock=q('#stuBlock'); const toggle=()=>stuBlock.classList.toggle('hide',roleSel.value!=='O‘quvchi'); roleSel.onchange=toggle; toggle();

    q('#avatarFile').onchange=async e=>{const f=e.target.files?.[0]; if(!f||!CURRENT_USER) return; const fr=new FileReader(); fr.onload=async()=>{try{const dataUrl=fr.result; const ref=sRef(st,`avatars/${CURRENT_USER.uid}/${Date.now()}.jpg`); await uploadString(ref,dataUrl,'data_url'); const url=await getDownloadURL(ref); const bust=url+(url.includes('?')?'&':'?')+'v='+Date.now(); q('#pAvatar').innerHTML=`<img src="${bust}" alt="">`; PROFILE={...(PROFILE||{}),avatarUrl:bust};}catch(err){alert('Avatar yuklashda xatolik: '+(err?.message||err));}}; fr.readAsDataURL(f);};
    q('#avatarUrlBtn').onclick=()=>{const url=prompt("Avatar rasm URL manzilini kiriting:"); if(!url) return; PROFILE={...(PROFILE||{}),avatarUrl:url}; q('#pAvatar').innerHTML=`<img src="${url}" alt="">`;};

    q('#cancelEdit').onclick=closeOverlay;
    q('#saveProfile').onclick=async()=>{if(!CURRENT_USER) return; const roleVal=q('#roleSel').value; const v={firstName:q('#firstName').value.trim(),lastName:q('#lastName').value.trim(),birthDate:q('#birthDate').value,role:roleVal,region:rSel.value,district:dSel.value,class:roleVal==='O‘quvchi'?q('#class').value:'',school:roleVal==='O‘quvchi'?(sSel.value==="__other__"?'':sSel.value):'',schoolCustom:roleVal==='O‘quvchi'?q('#schoolCustom').value.trim():'',avatarUrl:PROFILE?.avatarUrl||(CURRENT_USER.photoURL||'')}; for(const k of ALWAYS_REQ){if(!v[k]){alert('Majburiy maydonlarni to‘ldiring.');return;}} if(roleVal==='O‘quvchi'&&!v.class){alert('Sinfni tanlang.');return;} await saveProfile(CURRENT_USER.uid,v); closeOverlay(); renderUserChip(CURRENT_USER,PROFILE); setLocked(false);};
  }

  const showOverlay=html=>{const ov=q('#overlay'); ov.innerHTML=html; ov.classList.add('show');};
  const closeOverlay=()=>{const ov=q('#overlay'); ov.classList.remove('show'); ov.innerHTML='';};

  async function fetchHome(){try{const s=await getDoc(doc(db,'configs','home')); if(s.exists()){const d=s.data(); if(Array.isArray(d.sections)) return d;}}catch{} const r=await fetch('./home.json',{cache:'no-store'}); if(!r.ok) return {sections:[]}; return await r.json();}
  const state={sections:[],activeId:null};
  async function loadHome(){const d=await fetchHome(); state.sections=Array.isArray(d.sections)?d.sections:[]; renderChips(); renderSections(); if(state.sections.length) activate(state.sections[0].id||'sec0');}
  function renderChips(){const bar=q('#chipbar'); bar.innerHTML=''; state.sections.forEach((s,i)=>{const b=document.createElement('button'); b.className='chip'+(i===0?' active':''); b.textContent=s.title||s.id||('Bo‘lim '+(i+1)); b.dataset.target=s.id||('sec'+i); b.onclick=()=>activate(b.dataset.target); bar.appendChild(b);});}
  function renderSections(){const host=q('#sections'); host.innerHTML=''; state.sections.forEach((s,i)=>{const id=s.id||('sec'+i); const outer=document.createElement('section'); outer.className='section'+(s.fullBleed?' h-bleed':''); outer.dataset.section=id; const sh=document.createElement('div'); sh.className='section-hdr'; sh.innerHTML='<h3>'+(s.title||'')+'</h3>'; if(!s.title) sh.style.display='none'; const cont=document.createElement('div'); const ifr=document.createElement('iframe'); ifr.className='sbx'; ifr.setAttribute('sandbox',s.sandbox||'allow-scripts allow-forms'); if(s.mode==='url'&&s.src){ifr.src=s.src;} else {const base=s.baseHref?'<base href="'+s.baseHref+'">':''; ifr.srcdoc='<!doctype html><html><head>'+base+'<meta charset="utf-8"></head><body>'+(s.contentHtml||'')+'</body></html>'; } cont.appendChild(ifr); outer.appendChild(sh); outer.appendChild(cont); host.appendChild(outer);});}
  function activate(id){state.activeId=id; qa('.chip').forEach(c=>c.classList.toggle('active',c.dataset.target===id)); qa('[data-section]').forEach(s=>s.style.display=(s.dataset.section===id)?'block':'none'); const vis=q('[data-section="'+id+'"]'); if(vis) vis.scrollIntoView({behavior:'smooth',block:'start'});}

  function setLocked(b){const a=q('#app'); if(a) a.hidden=b;}
  function buildAuthLock(){if(q('#auth-lock'))return q('#auth-lock'); const lock=document.createElement('div'); lock.id='auth-lock'; lock.className='lock'; lock.hidden=true; lock.innerHTML=`<div class="card"><div class="rowx" style="align-items:center"><img src="./logo.png" width="28" height="28" style="border-radius:8px"><b>LeaderMath.UZ</b></div><div class="fld"><label>Email</label><input type="email" id="eml" placeholder="email@example.com"></div><div class="fld"><label>Parol</label><input type="password" id="pwd" placeholder="••••••••"></div><div id="err"></div><div class="rowx"><button id="login" class="btn primary">Kirish</button><button id="signup" class="btn">Ro‘yxatdan o‘tish</button></div><div style="height:10px"></div><button id="google" class="btn full"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> Google bilan kirish</button></div>`; document.body.appendChild(lock); lock.addEventListener('click',async e=>{const id=e.target.id; const errEl=q('#err',lock); const busy=b=>qa('button',lock).forEach(x=>x.disabled=b); try{busy(true); if(id==='google') await signInWithPopup(auth,new GoogleAuthProvider()); if(id==='login'){const eml=q('#eml',lock).value.trim(),pwd=q('#pwd',lock).value; await signInWithEmailAndPassword(auth,eml,pwd);} if(id==='signup'){const eml=q('#eml',lock).value.trim(),pwd=q('#pwd',lock).value; await createUserWithEmailAndPassword(auth,eml,pwd);} }catch(err){if(errEl) errEl.textContent=err?.message||String(err);} finally{busy(false);} }); return lock;}

  onAuthStateChanged(auth, async (u)=>{
    const lock=buildAuthLock(); CURRENT_USER=u||null;
    if(!u){setLocked(true); lock.style.removeProperty('display'); lock.hidden=false; q('#user-slot').innerHTML=''; return;}
    setLocked(false); lock.style.display='none'; setTimeout(()=>{try{lock.remove();}catch{}},0);
    if(!REGIONS.length) REGIONS=await loadRegions();
    [PROFILE,USER_POINTS]=await Promise.all([getProfile(u.uid),getUserPoints(u.uid)]);
    if(PROFILE && !PROFILE.role){PROFILE.role='O‘quvchi'; await saveProfile(u.uid,PROFILE);}
    const baseOk=ALWAYS_REQ.every(k=>PROFILE&&PROFILE[k]); let ok=baseOk; if(PROFILE?.role==='O‘quvchi'){ok=ok&&!!PROFILE.class;}
    if(!ok){setLocked(true); openProfileEditor();} else {renderUserChip(u,PROFILE);}
  });

  await loadHome();
  </script>
</body>
</html>
