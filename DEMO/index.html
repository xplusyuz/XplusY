<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LeaderMath.UZ — Home + Profil</title>
  <meta name="theme-color" content="#2E8B57"/>
  <link rel="icon" href="./logo.png"/>

  <style>
    :root{
      --brand:#2E8B57; --bg:#F6FBF8; --text:#0d1b14; --card:#fff; --frame:#dfe7e2;
      --shadow:0 12px 40px rgba(16,32,23,.08); --muted:#4a6b5a;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.55 system-ui,Segoe UI,Arial}

    /* Header */
    header.hdr{position:sticky;top:0;z-index:20;background:#fffdd0000;
      backdrop-filter:saturate(1.1) blur(6px); border-bottom:1px solid var(--frame)}
    .row{max-width:1180px;margin:0 auto;display:flex;align-items:center;gap:14px;padding:10px 16px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}.brand b{color:var(--brand)}
    .grow{flex:1}
    nav.chipbar{max-width:1180px;margin:12px auto 0;display:flex;gap:8px;flex-wrap:wrap;padding:0 16px 12px}
    .chip{padding:8px 12px;border:1px solid var(--frame);border-radius:999px;cursor:pointer;background:#fff}
    .chip.active{background:var(--brand);color:#fff;border-color:var(--brand)} .chip:disabled{opacity:.6;cursor:not-allowed}

    /* Sections */
    main{max-width:1180px;margin:0 auto;padding:12px 16px 40px}
    section.section{background:var(--card);border:1px solid var(--frame);border-radius:16px;overflow:hidden;box-shadow:var(--shadow)}
    .section.h-bleed{border:none;border-radius:0;box-shadow:none}
    .section-hdr{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--frame)}
    .section-hdr h3{margin:0;font-size:18px}
    .iframe-wrap{position:relative} iframe.sbx{display:block;width:100%;border:0;background:#fff;min-height:600px}
    .bleed{width:100vw;margin-left:50%;transform:translateX(-50%)}

    /* Auth lock (fallback) */
    .lock{position:fixed;inset:0;background:linear-gradient(180deg,#F6FBF8ee,#F6FBF8ff);display:grid;place-items:center;z-index:50}
    .card{width:min(520px,96vw);background:#fff;border:1px solid var(--frame);border-radius:18px;box-shadow:var(--shadow);padding:18px}
    .title{display:flex;align-items:center;gap:10px;font-weight:800;margin-bottom:10px}
    .hint{color:var(--muted);font-size:14px;margin-bottom:12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--frame);background:#fff;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)} .btn.full{width:100%}
    .fld{display:grid;gap:6px;margin:8px 0} .fld input, .fld select, .fld textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--frame);outline:none;background:#fff}
    .rowx{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    #err{color:#b00020;min-height:18px;margin-top:4px;font-size:13px}

    /* User chip in header */
    .userchip{display:flex;gap:10px;align-items:center;border:1px solid var(--frame);padding:6px 10px;border-radius:999px;background:#fff;cursor:pointer;position:relative}
    .avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#cfe7db,#eaf6f0);overflow:hidden}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .menu{position:absolute;right:0;top:42px;background:#fff;border:1px solid var(--frame);border-radius:12px;box-shadow:var(--shadow);min-width:220px;display:none}
    .menu.open{display:block}
    .menu a{display:flex;justify-content:space-between;gap:8px;padding:10px 12px;text-decoration:none;color:inherit;border-bottom:1px solid #f0f3f1}
    .menu a:last-child{border-bottom:none}
    .mini{color:var(--muted);font-size:12px}

    /* Profile modal */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.18);display:none;place-items:center;z-index:60}
    .overlay.show{display:grid}
    .profile-card{width:min(760px,96vw);background:#fff;border:1px solid var(--frame);border-radius:16px;box-shadow:var(--shadow);padding:18px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .muted{color:var(--muted);font-size:13px}
    .divider{height:1px;background:#eef2ee;margin:10px 0}
    .pill{padding:4px 8px;border:1px solid var(--frame);border-radius:999px;background:#fff}
  </style>

  <script type="module">
    /* Firebase */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, setPersistence,
      browserLocalPersistence, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";

    /* ==== CONFIG ==== */
    const firebaseConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.appspot.com",
      messagingSenderId: "992512966017",
      appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId: "G-459PLJ7P7L"
    };

    /* ==== APP ==== */
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const st   = getStorage(app);

    try{ await setPersistence(auth, browserLocalPersistence); }catch(e){ console.warn('setPersistence:', e); }

    /* ======= UI helpers ======= */
    function q(sel,root=document){ return root.querySelector(sel); }
    function qa(sel,root=document){ return [...root.querySelectorAll(sel)]; }
    function setLocked(locked){
      const appEl = q('#app'); if(appEl) appEl.hidden = locked;
    }

    /* ======= Region JSON load ======= */
    async function loadRegions(){
      try{
        const res = await fetch('./region.json', {cache:'no-store'});
        if(!res.ok) throw new Error('region.json topilmadi');
        const json = await res.json();
        return json?.regions || [];
      }catch(e){
        console.warn(e); return [];
      }
    }

    /* ======= Profile state ======= */
    let REGIONS = [];
    let CURRENT_USER = null;
    let PROFILE = null; // {firstName,lastName,birthDate,region,district,school,schoolCustom,class,avatarUrl,points}
    const REQUIRED = ['firstName','lastName','birthDate','region','district','class']; // school may be custom

    function calcAge(iso){ try{ const b=new Date(iso); const t=new Date(); let a=t.getFullYear()-b.getFullYear(); const m=t.getMonth()-b.getMonth(); if(m<0||(m===0&&t.getDate()<b.getDate())) a--; return a; }catch{ return '';} }

    async function getProfile(uid){
      const snap = await getDoc(doc(db,'profiles',uid));
      return snap.exists()? snap.data(): null;
    }
    async function saveProfile(uid, data){
      data.updatedAt = serverTimestamp();
      if(!PROFILE) data.createdAt = serverTimestamp();
      await setDoc(doc(db,'profiles',uid), data, {merge:false});
      PROFILE = data;
    }

    /* ======= Header user chip ======= */
    function renderUserChip(u, profile){
      const slot = q('#user-slot'); if(!slot) return;
      const points = profile?.points ?? 0;
      const age = profile?.birthDate ? calcAge(profile.birthDate) : '';
      const name = profile?.firstName ? (profile.firstName + (profile.lastName? ' ' + profile.lastName : '')) : (u.displayName || u.email || 'Foydalanuvchi');
      const avatar = profile?.avatarUrl || u.photoURL || '';

      slot.innerHTML = `
        <div class="userchip" id="userchip">
          <div class="avatar">${avatar? `<img src="${avatar}" alt="">`:''}</div>
          <div style="display:grid;line-height:1">
            <b style="font-size:14px">${name}</b>
            <small class="mini">${age? age+' yosh • ':''}${points} points</small>
          </div>
          <div class="menu" id="usermenu">
            <a href="#" id="mProfile">Profil</a>
            <a href="#" id="mEdit">Profilni tahrirlash</a>
            <a href="#" id="mLogout">Chiqish</a>
          </div>
        </div>`;
      const chip = q('#userchip',slot), menu=q('#usermenu',slot);
      chip.onclick = ()=> menu.classList.toggle('open');
      q('#mLogout',slot).onclick = (e)=>{ e.preventDefault(); menu.classList.remove('open'); signOut(auth); };
      q('#mProfile',slot).onclick = (e)=>{ e.preventDefault(); menu.classList.remove('open'); openProfileView(); };
      q('#mEdit',slot).onclick    = (e)=>{ e.preventDefault(); menu.classList.remove('open'); openProfileEditor(); };
    }

    /* ======= Profile Modal (view & edit) ======= */
    function openProfileView(){
      const d = PROFILE || {};
      const name = (d.firstName||'') + (d.lastName? ' '+d.lastName:'');
      const age  = d.birthDate? calcAge(d.birthDate): '';
      const avatar = d.avatarUrl || (CURRENT_USER?.photoURL||'');
      const html = `
        <div class="profile-card">
          <div class="rowx" style="align-items:center">
            <div class="avatar" style="width:56px;height:56px;border-radius:14px;overflow:hidden;background:#f2f6f3">${avatar?`<img src="${avatar}" alt="">`:''}</div>
            <div style="display:grid"><b style="font-size:18px">${name||'—'}</b>
              <span class="muted">${age? age+' yosh • ':''}${d.class? d.class+'-sinf • ':''}${d.points??0} points</span>
            </div>
            <div class="grow"></div>
            <button class="btn" id="toEdit">Tahrirlash</button>
            <button class="btn" id="closeView">Yopish</button>
          </div>
          <div class="divider"></div>
          <div class="grid3">
            <div><div class="muted">Viloyat</div><b>${d.region||'—'}</b></div>
            <div><div class="muted">Tuman</div><b>${d.district||'—'}</b></div>
            <div><div class="muted">Maktab</div><b>${d.school || d.schoolCustom || '—'}</b></div>
          </div>
          <div style="height:6px"></div>
          <div class="grid3">
            <div><div class="muted">Tug‘ilgan sana</div><b>${d.birthDate||'—'}</b></div>
            <div><div class="muted">Ism</div><b>${d.firstName||'—'}</b></div>
            <div><div class="muted">Familiya</div><b>${d.lastName||'—'}</b></div>
          </div>
        </div>`;
      showOverlay(html);
      q('#toEdit').onclick=()=>{ closeOverlay(); openProfileEditor(); };
      q('#closeView').onclick=closeOverlay;
    }

    function openProfileEditor(){
      const d = PROFILE || {};
      const avatar = d.avatarUrl || (CURRENT_USER?.photoURL||'');
      const schoolsHelp = `<span class="muted">Maktab: ro‘yxatdan tanlang yoki "Boshqa"ni tanlab ostidagi maydonga yozing.</span>`;
      const html = `
        <div class="profile-card">
          <div class="rowx" style="align-items:center">
            <div class="avatar" style="width:56px;height:56px;border-radius:14px;overflow:hidden;background:#f2f6f3" id="pAvatar">${avatar?`<img src="${avatar}" alt="">`:''}</div>
            <div class="grow"></div>
            <label class="btn"><input type="file" id="avatarFile" accept="image/*" style="display:none"> Avatarni almashtirish</label>
          </div>

          <div class="divider"></div>

          <div class="grid2">
            <div class="fld"><label>Ism</label><input id="firstName" value="${d.firstName||''}" placeholder="Ismingiz"></div>
            <div class="fld"><label>Familiya</label><input id="lastName" value="${d.lastName||''}" placeholder="Familiyangiz"></div>
          </div>

          <div class="grid2">
            <div class="fld"><label>Tug‘ilgan kun</label><input type="date" id="birthDate" value="${d.birthDate||''}"></div>
            <div class="fld"><label>Sinf</label>
              <select id="class">
                ${Array.from({length:11},(_,i)=>i+1).map(n=>`<option value="${n}" ${d.class==n?'selected':''}>${n}-sinf</option>`).join('')}
              </select>
            </div>
          </div>

          <div class="grid2">
            <div class="fld"><label>Viloyat</label><select id="regionSel"></select></div>
            <div class="fld"><label>Tuman</label><select id="districtSel"></select></div>
          </div>

          <div class="grid2">
            <div class="fld"><label>Maktab</label><select id="schoolSel"></select><div>${schoolsHelp}</div></div>
            <div class="fld"><label>Boshqa maktab (ixtiyoriy)</label><input id="schoolCustom" value="${d.schoolCustom||''}" placeholder="Masalan: 12-maktab filiali"></div>
          </div>

          <div class="divider"></div>
          <div class="rowx">
            <button class="btn" id="cancelEdit">Bekor qilish</button>
            <div class="grow"></div>
            <button class="btn primary" id="saveProfile">Saqlash</button>
          </div>
        </div>`;
      showOverlay(html);

      // Region/district/school chaining
      function fillRegions(){
        const rSel = q('#regionSel'), dSel=q('#districtSel'), sSel=q('#schoolSel');
        rSel.innerHTML = `<option value="">Tanlang...</option>` + REGIONS.map(r=>`<option value="${r.name}">${r.name}</option>`).join('');
        if(d.region){ rSel.value = d.region; }
        fillDistricts();
        rSel.onchange = ()=>{ fillDistricts(); fillSchools(); };
        dSel.onchange = ()=>{ fillSchools(); };
        function fillDistricts(){
          const r = REGIONS.find(x=>x.name===rSel.value);
          const districts = (r?.districts||[]).map(x=>typeof x==='string'? {name:x,schools:[]} : x);
          dSel.innerHTML = `<option value="">Tanlang...</option>` + districts.map(t=>`<option value="${t.name}">${t.name}</option>`).join('');
          if(d.district){ dSel.value = d.district; }
        }
        function fillSchools(){
          const r = REGIONS.find(x=>x.name===rSel.value);
          const t = (r?.districts||[]).map(x=>typeof x==='string'? {name:x,schools:[]} : x).find(x=>x.name===dSel.value);
          const schools = t?.schools || [];
          sSel.innerHTML = schools.map(s=>`<option value="${s}">${s}</option>`).join('') + `<option value="__other__">Boshqa…</option>`;
          sSel.value = schools.includes(d.school)? d.school : "__other__";
        }
        fillSchools();
      }
      fillRegions();

      // Avatar upload
      q('#avatarFile').onchange = async (e)=>{
        const f = e.target.files?.[0]; if(!f || !CURRENT_USER) return;
        const r = sRef(st, `avatars/${CURRENT_USER.uid}.jpg`);
        await uploadBytes(r, f);
        const url = await getDownloadURL(r);
        q('#pAvatar').innerHTML = `<img src="${url}" alt="">`;
        PROFILE = {...(PROFILE||{}), avatarUrl:url}; // temp
      };

      q('#cancelEdit').onclick = closeOverlay;
      q('#saveProfile').onclick = async ()=>{
        if(!CURRENT_USER) return;
        const v = {
          firstName: q('#firstName').value.trim(),
          lastName:  q('#lastName').value.trim(),
          birthDate: q('#birthDate').value,
          class:     q('#class').value,
          region:    q('#regionSel').value,
          district:  q('#districtSel').value,
          school:    (q('#schoolSel').value==="__other__"? "" : q('#schoolSel').value),
          schoolCustom: q('#schoolCustom').value.trim(),
          avatarUrl: PROFILE?.avatarUrl || (CURRENT_USER.photoURL || ''),
          points: PROFILE?.points ?? 0
        };
        // required check
        for(const k of REQUIRED){
          if(!v[k]){ alert('Iltimos: majburiy maydonlarni to‘ldiring'); return; }
        }
        await saveProfile(CURRENT_USER.uid, v);
        closeOverlay();
        renderUserChip(CURRENT_USER, PROFILE);
        setLocked(false);
      };
    }

    /* ======= Overlay helpers ======= */
    function showOverlay(innerHtml){
      const ov = q('#overlay');
      ov.innerHTML = innerHtml;
      ov.classList.add('show');
    }
    function closeOverlay(){ q('#overlay').classList.remove('show'); q('#overlay').innerHTML = ''; }

    /* ======= Content rendering (chips + sections) ======= */
    async function fetchHome(){
      try{
        const snap = await getDoc(doc(db,'configs','home'));
        if(snap.exists()){
          const d = snap.data(); if(d && Array.isArray(d.sections)) return d;
        }
      }catch(e){ console.warn('Firestore home load failed', e); }
      const res = await fetch('./home.json', {cache:'no-store'});
      if(!res.ok) throw new Error('home.json topilmadi');
      return await res.json();
    }

    const state = { sections:[], activeId:null };
    async function loadHome(){
      let data = null;
      try{ data = await fetchHome(); }catch(e){ alert('Konfiguratsiya yuklashda xato: '+e.message); data={sections:[]}; }
      state.sections = Array.isArray(data.sections)? data.sections : [];
      renderChips(); renderSections();
      if(state.sections.length>0){ activate(state.sections[0].id || 'sec0'); }
    }
    function renderChips(){
      const bar=q('#chipbar'); bar.innerHTML='';
      state.sections.forEach((s,i)=>{
        const btn=document.createElement('button');
        btn.className='chip'+(i===0?' active':''); btn.textContent=s.title||s.id||('Bo‘lim '+(i+1));
        btn.dataset.target=s.id||('sec'+i); btn.onclick=()=>activate(btn.dataset.target);
        bar.appendChild(btn);
      });
    }
    function renderSections(){
      const host=q('#sections'); host.innerHTML='';
      state.sections.forEach((s,i)=>{
        const secId=s.id||('sec'+i);
        const outer=document.createElement('section'); outer.className='section'+(s.fullBleed?' h-bleed':''); outer.dataset.section=secId;
        const sh=document.createElement('div'); sh.className='section-hdr'+(s.fullBleed?' bleed':''); sh.innerHTML='<h3>'+(s.title||'')+'</h3>'; if(!s.title) sh.style.display='none';
        const cont=document.createElement('div'); cont.className='iframe-wrap'+(s.fullBleed?' bleed':'');
        const ifr=document.createElement('iframe'); ifr.className='sbx'; ifr.setAttribute('sandbox', s.sandbox||'allow-scripts allow-forms');
        if(s.mode==='url' && s.src){ ifr.src=s.src; } else {
          const baseTag=s.baseHref?'<base href="'+s.baseHref+'">':''; ifr.srcdoc='<!doctype html><html><head>'+baseTag+'<meta charset="utf-8"></head><body>'+(s.contentHtml||'')+'</body></html>';
        }
        cont.appendChild(ifr);
        outer.appendChild(sh); outer.appendChild(cont); host.appendChild(outer);
      });
    }
    function activate(id){
      state.activeId=id;
      qa('.chip').forEach(c=>c.classList.toggle('active', c.dataset.target===id));
      qa('[data-section]').forEach(s=>s.style.display=(s.dataset.section===id)?'block':'none');
      const vis=q('[data-section="'+id+'"]'); if(vis){ vis.scrollIntoView({behavior:'smooth',block:'start'}); }
    }
    window.addEventListener('message', (ev)=>{
      const msg=ev.data||{}; if(!msg.__lmResize) return;
      const sec=q('[data-section="'+msg.id+'"]'); if(!sec) return; const ifr=sec.querySelector('iframe'); if(!ifr) return; const h=Math.max(parseInt(msg.height,10)||0,200); ifr.style.height=h+'px';
    });

    /* ======= Auth flow ======= */
    function buildAuthLock(){
      if(q('#auth-lock')) return q('#auth-lock');
      const lock=document.createElement('div'); lock.id='auth-lock'; lock.className='lock'; lock.hidden=true;
      lock.innerHTML = '' +
        '<div class="card">' +
        ' <div class="title"><img src="./logo.png" width="28" height="28" style="border-radius:8px"/><span>LeaderMath.<b>UZ</b></span></div>' +
        ' <div class="hint">Ro‘yxatdan o‘ting yoki kiring — tizimga kirmaguncha kontent ko‘rinmaydi.</div>' +
        ' <div class="fld"><label>Email</label><input type="email" id="eml" placeholder="email@example.com"/></div>' +
        ' <div class="fld"><label>Parol</label><input type="password" id="pwd" placeholder="••••••••"/></div>' +
        ' <div id="err"></div>' +
        ' <div class="rowx"><button id="login" class="btn primary">Kirish</button><button id="signup" class="btn">Ro‘yxatdan o‘tish</button></div>' +
        ' <div style="height:10px"></div>' +
        ' <button id="google" class="btn full"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"/> Google bilan kirish</button>' +
        '</div>';
      document.body.appendChild(lock);
      lock.addEventListener('click', async (e)=>{
        const id=e.target.id;
        const errEl=q('#err',lock);
        function busy(b){ qa('button',lock).forEach(x=>x.disabled=b); }
        try{
          busy(true);
          if(id==='google') await signInWithPopup(auth,new GoogleAuthProvider());
          if(id==='login'){ const eml=q('#eml',lock).value.trim(), pwd=q('#pwd',lock).value; await signInWithEmailAndPassword(auth,eml,pwd); }
          if(id==='signup'){ const eml=q('#eml',lock).value.trim(), pwd=q('#pwd',lock).value; await createUserWithEmailAndPassword(auth,eml,pwd); }
        }catch(err){ if(errEl) errEl.textContent = err?.message || String(err); }
        finally{ busy(false); }
      });
      return lock;
    }

    onAuthStateChanged(auth, async (u)=>{
      CURRENT_USER = u || null;
      const lock=buildAuthLock();

      if(!u){
        // show auth
        if(!document.getElementById('auth-lock')) buildAuthLock();
        setLocked(true);
        lock.style.removeProperty('display'); lock.hidden=false;
        q('#user-slot').innerHTML='';
        return;
      }

      // hide auth
      setLocked(false); lock.style.display='none'; setTimeout(()=>{ try{ lock.remove(); }catch{} }, 0);

      // regions (once)
      if(!REGIONS.length) REGIONS = await loadRegions();

      // profile check
      PROFILE = await getProfile(u.uid);
      const isComplete = REQUIRED.every(k=>(PROFILE && PROFILE[k]));
      if(!isComplete){ setLocked(true); openProfileEditor(); }
      else{ renderUserChip(u, PROFILE); }

    });

    // boot homepage
    await loadHome();
  </script>
</head>
<body>
  <header class="hdr">
    <div class="row">
      <div class="brand"><img src="./logo.png" alt="LM" width="28" height="28" style="border-radius:8px"/><span>LeaderMath.<b>UZ</b></span></div>
      <div class="grow"></div>
      <div id="user-slot"></div>
    </div>
    <nav id="chipbar" class="chipbar"></nav>
  </header>

  <main id="app"><div id="sections"></div></main>

  <!-- profil/view/edit uchun modal -->
  <div id="overlay" class="overlay"></div>
</body>
</html>
