<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>LeaderMath.uz — Bosh sahifa</title>
  <meta name="theme-color" content="#2E8B57" id="meta-theme-color"/>
  <link rel="icon" href="./favicon.png"/><!-- Agar fayl yo'q bo'lsa olib tashlang -->
  <style>
    :root{
      --brand:#2E8B57;--brand2:#1F6B45;
      --bg:#f4f8f6;--text:#0d1b14;--muted:#5b7a6b;
      --card:#ffffff;--frame:#d8e7dd;--ring:#8ad1b1;
      --chip:#eaf6f0;--chip-b:#cfe7db;--radius:16px;
    }
    :root.dark{
      --bg:#0e1512; --text:#EAF7EE; --muted:#A5C7B4; --card:#142018; --frame:#1e4234; --chip:#0f221b; --chip-b:#173428;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    .app{display:flex;flex-direction:column;min-height:100dvh}

    /* Appbar */
    .appbar{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#f7fbf9,rgba(247,251,249,.6));backdrop-filter: blur(8px);border-bottom:1px solid var(--frame)}
    .bar{display:flex;align-items:center;gap:12px;padding:10px 14px;max-width:1120px;margin:0 auto}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#7fd6ad,#2E8B57);display:grid;place-items:center;color:#fff;font-weight:800}
    .title{font-weight:800;letter-spacing:.2px}
    .spacer{flex:1}

    /* User chip */
    .userchip{display:flex;align-items:center;gap:10px;padding:6px 10px;border:1px solid var(--frame);background:var(--card);border-radius:999px;cursor:pointer;box-shadow:0 1px 0 rgba(0,0,0,.04)}
    .ava{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#bfead3,#66c79a);display:grid;place-items:center;color:#0c3a2a;font-weight:800}
    .uname{font-weight:700;max-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .score{padding:2px 8px;border-radius:999px;background:var(--chip);border:1px solid var(--chip-b);font-weight:800}
    .chev{width:16px;height:16px;opacity:.7}

    /* Popover */
    .popover{position:absolute;inset:auto 12px auto auto;top:58px;max-width:360px;border:1px solid var(--frame);background:var(--card);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:14px;display:none}
    .row{display:flex;gap:12px}
    .popava{width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#bfead3,#66c79a);display:grid;place-items:center;color:#0c3a2a;font-weight:800;font-size:20px}
    .popmeta{flex:1}
    .muted{color:var(--muted);font-size:13px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--frame);background:var(--card);cursor:pointer}
    .btn.pri{background:linear-gradient(180deg,#8fe3b0,#2E8B57);border-color:#1F6B45;color:#fff}
    .btn.small{padding:6px 10px;border-radius:10px;font-size:13px}
    .grp{display:flex;flex-wrap:wrap;gap:8px}
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}

    /* Chip tabs */
    .chipbar{position:sticky;top:64px;z-index:40;background:linear-gradient(180deg,#f7fbf9,rgba(247,251,249,.6));backdrop-filter:blur(8px);border-bottom:1px solid var(--frame)}
    .chips{max-width:1120px;margin:0 auto;padding:10px 14px;display:flex;gap:8px;overflow-x:auto;scrollbar-width:thin}
    .chip{white-space:nowrap;padding:8px 12px;border-radius:12px;border:1px solid var(--chip-b);background:var(--chip);cursor:pointer}
    .chip.act{background:#2E8B57;color:#fff;border-color:#1F6B45;font-weight:600}

    /* Main content */
    .main{max-width:1120px;margin:16px auto;padding:0 14px 60px}
    .card{border:1px solid var(--frame);background:var(--card);border-radius:var(--radius);box-shadow:0 8px 30px rgba(0,0,0,.06)}
    .viewer{height:calc(100dvh - 220px);min-height:420px;border:none;width:100%;border-radius:inherit}

    /* Gate (login) */
    .gate{max-width:560px;margin:40px auto;border:1px solid var(--frame);background:var(--card);border-radius:16px;padding:20px;text-align:center}
    .gtitle{font-weight:800;font-size:20px;margin-bottom:8px}

    /* Modal */
    .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;z-index:60}
    .modal{width:min(720px,96vw);max-height:86vh;overflow:auto;border:1px solid var(--frame);background:var(--card);border-radius:16px;padding:16px}
    .fld{display:grid;gap:6px;margin:10px 0}
    .fld>label{font-size:13px;color:var(--muted)}
    .fld>input{border:1px solid var(--frame);border-radius:12px;padding:10px 12px;background:transparent;color:var(--text)}
  </style>
</head>
<body>
<div class="app">
  <!-- APPBAR -->
  <div class="appbar">
    <div class="bar">
      <div class="logo">L</div>
      <div class="title">LeaderMath.uz</div>
      <div class="spacer"></div>

      <!-- USER CHIP (auth bo'lsa) -->
      <div id="userChip" class="userchip" aria-haspopup="dialog" aria-expanded="false" style="display:none">
        <div id="chipAva" class="ava">LM</div>
        <div class="uname" id="chipName">Foydalanuvchi</div>
        <div class="score" id="chipScore">0</div>
        <svg class="chev" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" stroke-width="2"/></svg>
      </div>

      <!-- SIGN IN (auth bo'lmasa) -->
      <button id="signInBtn" class="btn pri">Google bilan kirish</button>
    </div>
  </div>

  <!-- USER POPOVER -->
  <div id="userPop" class="popover">
    <div class="row">
      <div id="popAva" class="popava">LM</div>
      <div class="popmeta">
        <div style="font-weight:800" id="popName">Foydalanuvchi</div>
        <div class="muted" id="popInfo">#000000 • Maktab / Sinf</div>
        <div class="grp mt8">
          <button class="btn small" id="viewProfileBtn">Profil</button>
          <button class="btn small" id="editProfileBtn">Tahrirlash</button>
          <button class="btn small" id="signOutBtn">Chiqish</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CHIP BAR -->
  <div class="chipbar" id="chipBar" style="display:none">
    <div id="chipList" class="chips" role="tablist" aria-label="Bo‘limlar"></div>
  </div>

  <!-- MAIN -->
  <main class="main">
    <div id="gate" class="gate">
      <div class="gtitle">Kirish talab qilinadi</div>
      <p>LeaderMath xizmatlaridan foydalanish uchun Google hisob bilan kiring.</p>
      <button id="gateSignIn" class="btn pri">Google bilan kirish</button>
    </div>

    <div id="contentCard" class="card" style="display:none">
      <iframe id="viewer" class="viewer" sandbox="allow-scripts"></iframe>
    </div>
  </main>
</div>

<!-- MODAL BACKDROP -->
<div id="modalBack" class="modalBack" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" id="modalContent"></div>
</div>

<!-- ================= Firebase & App (type=module) ================= -->
<script type="module">
(async()=>{
  /* ================= Firebase SDK (v10 modular) ================= */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider, setPersistence, browserLocalPersistence,
    onAuthStateChanged, signInWithPopup, signOut, updateProfile
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, runTransaction, serverTimestamp,
    onSnapshot, updateDoc
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  /* ================== CONFIG (o'zingiznikini qo'ying) ================== */
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };

  // Init
  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const provider = new GoogleAuthProvider();
  provider.setCustomParameters({ prompt: "select_account" });
  await setPersistence(auth, browserLocalPersistence);

  /* ================= Shorthand & DOM ================= */
  const qs = (s, r=document)=>r.querySelector(s);
  const qsa= (s, r=document)=>Array.from(r.querySelectorAll(s));
  const escapeHtml=(x='')=>x.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  const initials=(name)=>{ const p=String(name||"").trim().split(/\s+/); return ((p[0]?.[0]||'L')+(p[1]?.[0]||'M')).toUpperCase(); };

  // UI refs
  const signInBtn   = qs("#signInBtn");
  const gateSignIn  = qs("#gateSignIn");
  const userChip    = qs("#userChip");
  const userPop     = qs("#userPop");
  const chipBar     = qs("#chipBar");
  const chipList    = qs("#chipList");
  const gate        = qs("#gate");
  const contentCard = qs("#contentCard");
  const viewer      = qs("#viewer");

  // Click handlers
  const doSignIn = async ()=>{ try{ await signInWithPopup(auth, provider); }catch(e){ alert("Kirishda xatolik: "+e.message); } };
  signInBtn?.addEventListener("click", doSignIn);
  gateSignIn?.addEventListener("click", doSignIn);

  userChip.addEventListener("click", ()=>{
    const open = userPop.style.display === "block";
    userPop.style.display = open ? "none" : "block";
    userChip.setAttribute("aria-expanded", String(!open));
  });
  document.addEventListener("click", (e)=>{
    if(!userPop.contains(e.target) && !userChip.contains(e.target)){
      userPop.style.display = "none"; userChip.setAttribute("aria-expanded","false");
    }
  });
  qs("#signOutBtn").onclick = async()=>{ await signOut(auth); };
  qs("#viewProfileBtn").onclick = ()=> openProfileModal(false);
  qs("#editProfileBtn").onclick = ()=> openProfileModal(true);

  /* =============== Auth gate & userdoc bootstrap =============== */
  let unsubscribeUser = null;

  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      userChip.style.display="none";
      signInBtn.style.display="inline-flex";
      chipBar.style.display="none";
      gate.style.display="block";
      contentCard.style.display="none";
      if(unsubscribeUser) { unsubscribeUser(); unsubscribeUser=null; }
      return;
    }

    signInBtn.style.display="none";
    userChip.style.display="flex";
    chipBar.style.display="block";
    gate.style.display="none";
    contentCard.style.display="block";

    await ensureUserDoc(user);

    const uref = doc(db, "users", user.uid);
    if(unsubscribeUser) unsubscribeUser();
    unsubscribeUser = onSnapshot(uref, (snap)=>{
      const u = snap.data() || {};
      renderUserUI(user, u);
    });

    loadChips();
  });

  async function ensureUserDoc(user){
    const uref = doc(db, "users", user.uid);
    const udoc = await getDoc(uref);
    if(udoc.exists()) return;

    const cref = doc(db, "meta", "counters");
    await runTransaction(db, async (tx)=>{
      const csnap = await tx.get(cref);
      let data = csnap.exists()? csnap.data() : { lastNumericId: 1000, users:0 };
      const nextId = (data.lastNumericId|0) + 1;
      data.lastNumericId = nextId;
      data.users = (data.users|0) + 1;
      tx.set(cref, data, { merge:true });

      tx.set(uref, {
        uid: user.uid,
        email: user.email || "",
        name: user.displayName || "",
        photoURL: user.photoURL || "",
        numericId: nextId,
        role: "student",
        school: "",
        class: "",
        phone: "",
        points: 0,
        balance: 0,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, { merge:true });
    });
  }

  function renderUserUI(authUser, u){
    qs("#chipName").textContent = u.name || authUser.displayName || "Foydalanuvchi";
    qs("#chipScore").textContent = u.points|0;
    qs("#chipAva").textContent  = initials(u.name || authUser.displayName || "");
    qs("#popAva").textContent   = initials(u.name || authUser.displayName || "");
    qs("#popName").textContent  = u.name || authUser.displayName || "Foydalanuvchi";
    qs("#popInfo").textContent  = `#${u.numericId||"----"} • ${(u.school||"Maktab")} ${(u.class||"")}`;
  }

  /* ================= Profile View/Edit ================= */
  const modalBack = qs("#modalBack"), modalContent=qs("#modalContent");
  function openModal(inner){ modalContent.innerHTML = inner; modalBack.style.display="flex"; modalBack.setAttribute("aria-hidden","false"); }
  function closeModal(){ modalBack.style.display="none"; modalBack.setAttribute("aria-hidden","true"); }
  modalBack.addEventListener("click",(e)=>{ if(e.target===modalBack) closeModal(); });

  function openProfileModal(edit=false){
    const user = auth.currentUser; if(!user) return;
    const uref = doc(db,"users",user.uid);
    getDoc(uref).then(s=>{
      const u = s.data()||{};
      if(!edit){
        openModal(`
          <h2 style="margin:4px 0 8px">Profil</h2>
          <div class="fld"><label>Ism Familiya</label><div>${escapeHtml(u.name||user.displayName||"")}</div></div>
          <div class="fld"><label>Raqam (ID)</label><div>#${u.numericId||"----"}</div></div>
          <div class="fld"><label>Maktab / Sinf</label><div>${escapeHtml(u.school||"")} ${escapeHtml(u.class||"")}</div></div>
          <div class="fld"><label>Telefon</label><div>${escapeHtml(u.phone||"")}</div></div>
          <div class="fld"><label>Ball</label><div>${u.points|0}</div></div>
          <div class="fld"><label>Balans</label><div>${u.balance|0}</div></div>
          <div class="grp mt12"><button class="btn" id="pvClose">Yopish</button></div>
        `);
        qs("#pvClose").onclick=closeModal;
      }else{
        openModal(`
          <h2 style="margin:4px 0 8px">Profilni tahrirlash</h2>
          <div class="fld"><label>Ism Familiya</label><input id="pfName" value="${escapeHtml(u.name||user.displayName||"")}"></div>
          <div class="fld"><label>Maktab</label><input id="pfSchool" value="${escapeHtml(u.school||"")}"></div>
          <div class="fld"><label>Sinf</label><input id="pfClass" value="${escapeHtml(u.class||"")}"></div>
          <div class="fld"><label>Telefon</label><input id="pfPhone" value="${escapeHtml(u.phone||"")}"></div>
          <div class="grp mt12">
            <button class="btn pri" id="pfSave">Saqlash</button>
            <button class="btn" id="pfCancel">Bekor qilish</button>
          </div>
        `);
        qs("#pfSave").onclick=async()=>{
          await updateDoc(uref, {
            name: qs("#pfName").value.trim(),
            school: qs("#pfSchool").value.trim(),
            class: qs("#pfClass").value.trim(),
            phone: qs("#pfPhone").value.trim(),
            updatedAt: serverTimestamp()
          });
          try{ await updateProfile(user,{ displayName: qs("#pfName").value.trim() }); }catch{}
          closeModal();
        };
        qs("#pfCancel").onclick=closeModal;
      }
    });
  }

  /* ================= Chips (admin.json) ================= */
  let CHIP_DATA = { chips: [] };
  async function loadChips(){
    try{
      const res = await fetch("./admin.json",{cache:"no-store"});
      if(!res.ok) throw new Error("admin.json not found");
      CHIP_DATA = await res.json();
    }catch(err){
      // Fallback demo chips (escape qilingan </script> bilan!)
      CHIP_DATA = {
        chips:[
          {id:"welcome", label:"Bosh sahifa", order:1, visible:true, html:`<!doctype html>
<html><head><meta charset="utf-8"><title>Welcome</title>
<style>body{font:16px system-ui;margin:0;padding:24px} .h{font-weight:800;font-size:28px}</style></head>
<body>
  <div class="h">LeaderMath.uz — Xush kelibsiz!</div>
  <p>Bu chip <b>admin.json</b> bo‘lmasa ko‘rinadigan namunaviy kontent.</p>
  <button id="b">+1</button> <span id="c">0</span>
  <script>let n=0; b.onclick=()=>{ c.textContent=++n };<\/script>
</body></html>`}
        ]
      };
    }
    CHIP_DATA.chips = (CHIP_DATA.chips||[]).filter(c=>c && (c.visible!==false)).sort((a,b)=>(a.order||999)-(b.order||999));
    renderChipTabs();
  }

  function renderChipTabs(){
    chipList.innerHTML="";
    CHIP_DATA.chips.forEach(ch=>{
      const el = document.createElement("button");
      el.className = "chip"; el.role="tab"; el.dataset.id = ch.id;
      el.textContent = ch.label || ch.id;
      el.onclick = ()=> activateChip(ch.id);
      chipList.appendChild(el);
    });
    if(CHIP_DATA.chips.length) activateChip(CHIP_DATA.chips[0].id);
  }

  function activateChip(id){
    const chip = CHIP_DATA.chips.find(c=>c.id===id); if(!chip) return;
    qsa(".chip").forEach(x=>x.classList.toggle("act", x.dataset.id===id));
    const doc = viewer.contentWindow.document;
    doc.open(); doc.write(chip.html || "<!doctype html><meta charset='utf-8'><body>Bo‘sh chip</body>"); doc.close();
  }
})();
</script>
</body>
</html>
