<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LeaderMath — Chip Pages (JSON → body)</title>
  <style>
    :root{
      --brand:#2E8B57; --brand2:#1F6B45;
      --bg:#f6faf8; --text:#0f172a; --muted:#5b7a6a; --card:#fff; --frame:#d8e7dd;
      --radius:16px; --ring:#8ad1b1;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,Segoe UI,Roboto}

    /* Header */
    header{position:sticky;top:0;z-index:5;background:rgba(255,255,255,.7);
      backdrop-filter:saturate(1.5) blur(10px);border-bottom:1px solid var(--frame)}
    .bar{max-width:1200px;margin:0 auto;padding:10px 14px;display:flex;align-items:center;gap:12px}
    .logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand2));
      color:#fff;display:grid;place-items:center;font-weight:900}

    /* Horizontal chips */
    .chips-wrap{border-top:1px solid var(--frame);border-bottom:1px solid var(--frame);background:#fff}
    .chips-row{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:8px}
    .chips-scroll{overflow-x:auto;white-space:nowrap;scroll-snap-type:x mandatory;padding:8px;display:flex;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--frame);background:#fafdfb;color:var(--text);
      padding:8px 12px;border-radius:999px;cursor:pointer;scroll-snap-align:center;transition:.15s}
    .chip:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(0,0,0,.08)}
    .chip.active{outline:2px solid var(--ring);background:#f2fbf7}
    .navbtn{background:#fff;border:1px solid var(--frame);border-radius:10px;cursor:pointer;padding:8px 10px;margin:0 6px}
    .navbtn:active{transform:scale(.98)}
    .search{width:260px;max-width:42vw;padding:8px 12px;border:1px solid var(--frame);border-radius:12px}

    /* Page content area (chip HTML shu yerga tushadi) */
    main{max-width:1200px;margin:12px auto;padding:12px}
    .content{background:var(--card);border:1px solid var(--frame);border-radius:var(--radius);
      box-shadow:0 8px 24px rgba(0,0,0,.06)}
    .content-head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid var(--frame)}
    .title{font-weight:700}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#eff9f4;border:1px solid var(--frame)}
    .body{padding:16px}
    .muted{color:var(--muted)}
    @media (max-width:900px){
      .search{display:none}
      .chips-row{grid-template-columns: auto 1fr auto}
    }
  </style>
</head>
<body>
  <!-- Top app bar -->
  <header>
    <div class="bar">
      <div class="logo">L</div>
      <div>
        <div style="font-weight:700">LeaderMath — JSON Chip Pages</div>
        <div class="muted" style="font-size:12px">Chip bosilganda HTML sahifaning o‘zida ochiladi</div>
      </div>
      <input id="q" class="search" placeholder="Chip qidirish..." autocomplete="off"/>
    </div>

    <!-- Horizontal chips with scroll -->
    <div class="chips-wrap">
      <div class="chips-row">
        <button class="navbtn" id="prev" title="Oldinga">◀</button>
        <div class="chips-scroll" id="chips"></div>
        <button class="navbtn" id="next" title="Keyinga">▶</button>
      </div>
    </div>
  </header>

  <!-- Content panel -->
  <main>
    <section class="content">
      <div class="content-head">
        <div class="title" id="title">Chip tanlang</div>
        <div class="badge" id="tags" hidden></div>
      </div>
      <div class="body" id="content">
        <div class="muted">Yuqoridagi gorizontal chiplardan birini bosing.</div>
      </div>
    </section>
  </main>

  <script type="module">
    // === Helpers
    const $ = (s, r=document) => r.querySelector(s);
    const esc = (s='') => String(s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
    const chipsEl = $('#chips'), qEl = $('#q'), titleEl = $('#title'), tagsEl = $('#tags'), contentEl = $('#content');
    const setQS = (id) => history.replaceState(null,'',`?id=${encodeURIComponent(id)}`);
    const getQS = () => new URLSearchParams(location.search).get('id');

    // Smooth scroll helpers
    $('#prev').onclick = () => chipsEl.scrollBy({left:-300,behavior:'smooth'});
    $('#next').onclick = () => chipsEl.scrollBy({left: 300,behavior:'smooth'});
    chipsEl.addEventListener('wheel', e => {
      if (Math.abs(e.deltaX) < Math.abs(e.deltaY)) {  // wheel → horizontal
        chipsEl.scrollLeft += e.deltaY;
        e.preventDefault();
      }
    }, {passive:false});

    // Load JSON
    const admin = await fetch('./admin.json',{cache:'no-store'}).then(r=>r.json()).catch(()=>({chips:[]}));
    let all = Array.isArray(admin.chips)? admin.chips : [];

    // Render chips
    function drawChips(filter=''){
      const f = filter.trim().toLowerCase();
      const list = all.filter(c => !f || (c.title||'').toLowerCase().includes(f) || (c.tags||[]).join(' ').toLowerCase().includes(f));
      chipsEl.innerHTML = list.map(c =>
        `<button class="chip" data-id="${esc(c.id)}">${esc(c.title||c.id)}</button>`
      ).join('') || `<div class="muted" style="padding:10px">Topilmadi</div>`;
      chipsEl.querySelectorAll('.chip').forEach(b => b.onclick = () => openChip(b.dataset.id));
      highlightActive();
    }
    qEl?.addEventListener('input', e => drawChips(e.target.value));

    // Inject HTML into body and run scripts
    function injectHTML(el, html){
      // 1) Asosiy HTML
      el.innerHTML = html || '';
      // 2) <script>larni ishga tushirish (innerHTML avtomatik ishga tushirmaydi)
      const scripts = el.querySelectorAll('script');
      scripts.forEach(old => {
        const s = document.createElement('script');
        // type, module, src, nomi — hammasini ko‘chirib chiqamiz
        [...old.attributes].forEach(a => s.setAttribute(a.name, a.value));
        s.textContent = old.textContent;
        old.replaceWith(s);
      });
    }

    function highlightActive(){
      const id = getQS() || localStorage.getItem('lm:lastChip');
      chipsEl.querySelectorAll('.chip').forEach(b => b.classList.toggle('active', b.dataset.id===id));
    }

    // Open chip into page body
    function openChip(id){
      const c = all.find(x => x.id === id); if(!c) return;
      titleEl.textContent = c.title || c.id;
      if (c.tags?.length){ tagsEl.textContent = c.tags.join(' · '); tagsEl.hidden = false; }
      else { tagsEl.hidden = true; }
      injectHTML(contentEl, c.html || '<em class="muted">Kontent yo‘q</em>');
      localStorage.setItem('lm:lastChip', id);
      setQS(id);
      highlightActive();
      // Ixtiyoriy: hodisa (agar keyinroq boshqa modul eshitsa)
      window.Bus?.emit?.('chip:opened', {id});
    }

    // Init
    drawChips();
    const initial = getQS() || localStorage.getItem('lm:lastChip') || all[0]?.id;
    if (initial) { openChip(initial); }
  </script>
</body>
</html>
