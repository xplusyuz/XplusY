<!doctype html>
<html lang="uz"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin (Netlify Function)</title>
<style>body{margin:0;background:#f6fbf4;font:15px system-ui} header{padding:10px 14px;border-bottom:1px solid #e1e8e4;background:#fff;display:flex;gap:10px;align-items:center} .brand{color:#2E8B57;font-weight:800} main{max-width:1100px;margin:0 auto;padding:14px;display:grid;gap:12px} .card{background:#fff;border:1px solid #e1e8e4;border-radius:12px} .card h3{margin:0;padding:10px 12px;border-bottom:1px solid #e1e8e4} .card .body{padding:12px} table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid #eef2ee;text-align:left}</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
const firebaseConfig = {"apiKey": "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM", "authDomain": "xplusy-760fa.firebaseapp.com", "projectId": "xplusy-760fa", "storageBucket": "xplusy-760fa.appspot.com", "messagingSenderId": "992512966017", "appId": "1:992512966017:web:5e919dbc9b8d8abcb43c80", "measurementId": "G-459PLJ7P7L"};
const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);
let state={sections:[]}; const FN_URL='/.netlify/functions/saveConfig';
function renderTable(){ const tb=document.querySelector('#tbl tbody'); tb.innerHTML=''; state.sections.forEach((s,i)=>{ const tr=document.createElement('tr'); tr.innerHTML='<td>'+ (i+1) +'</td><td>'+ (s.id||'') +'</td><td>'+ (s.title||'') +'</td><td>'+ (s.mode||'html') +'</td><td><button data-i="'+i+'" class="edit">Edit</button> <button data-i="'+i+'" class="del">Del</button></td>'; tb.appendChild(tr); }); }
function edit(i){ const s=state.sections[i]||{}; const ed=document.getElementById('ed'); ed.innerHTML='<label>ID</label><input id=eid value="'+(s.id||'')+'"/>'+'<label>Title</label><input id=et value="'+(s.title||'')+'"/>'+'<label>Mode</label><select id=em><option '+(s.mode==='html'?'selected':'')+'>html</option><option '+(s.mode==='url'?'selected':'')+'>url</option></select>'+'<label>Sandbox</label><input id=es value="'+(s.sandbox||'allow-scripts allow-forms')+'"/>'+'<label>fullBleed</label><select id=ef><option value=false '+(!s.fullBleed?'selected':'')+'>false</option><option value=true '+(s.fullBleed?'selected':'')+'>true</option></select>'+'<div id=blkH '+(s.mode==='html'?'':'style=display:none')+'><label>contentHtml</label><textarea id=eh>'+(s.contentHtml?String(s.contentHtml).replace(/</g,'&lt;'):'')+'</textarea></div>'+'<div id=blkU '+(s.mode==='url'?'':'style=display:none')+'><label>src</label><input id=esrc value="'+(s.src||'')+'"/></div>'+'<div style=margin-top:8px><button id=saveOne>Saqlash</button></div>'; ed.querySelector('#em').onchange=function(){ const v=this.value; ed.querySelector('#blkH').style.display=(v==='html')?'block':'none'; ed.querySelector('#blkU').style.display=(v==='url')?'block':'none'; }; ed.querySelector('#saveOne').onclick=function(){ const obj={ id:ed.querySelector('#eid').value.trim(), title:ed.querySelector('#et').value.trim(), mode:ed.querySelector('#em').value, sandbox:ed.querySelector('#es').value.trim(), fullBleed:ed.querySelector('#ef').value==='true' }; const bh=ed.querySelector('#esrc'); if(obj.mode==='html') obj.contentHtml = ed.querySelector('#eh').value; else obj.src = (bh?bh.value.trim():''); state.sections[i]=obj; renderTable(); alert('Saved'); }; }
document.addEventListener('click', (e)=>{ const i=e.target.getAttribute('data-i'); if(i===null) return; const idx=parseInt(i,10); if(e.target.classList.contains('edit')) edit(idx); if(e.target.classList.contains('del')){ state.sections.splice(idx,1); renderTable(); } });
document.getElementById('add').onclick=()=>{ const n=state.sections.length+1; state.sections.push({id:'sec'+n,title:'Yangi '+n,mode:'html',sandbox:'allow-scripts allow-forms',fullBleed:false,contentHtml:'<section style=\'padding:20px\'><h2>Yangi</h2></section>'}); renderTable(); };
document.getElementById('download').onclick=()=>{ const blob=new Blob([JSON.stringify({sections:state.sections},null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='home.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); };
document.getElementById('publish').onclick=async()=>{ const u=auth.currentUser; if(!u) return alert('Avval kiring'); const tok=await u.getIdToken(); const res=await fetch(FN_URL, {method:'POST', headers:{'Authorization':'Bearer '+tok,'Content-Type':'application/json'}, body: JSON.stringify({sections:state.sections})}); if(!res.ok){ alert('Saqlash xatosi: '+await res.text()); } else alert('Saqlandi âœ…'); };
onAuthStateChanged(auth, async (u)=>{ if(!u){ document.getElementById('guard').innerHTML='<button id=g>Google bilan kiring</button>'; document.getElementById('g').onclick=()=>signInWithPopup(auth,new GoogleAuthProvider()); return; } document.getElementById('guard').textContent='ðŸ‘‹ '+(u.email||u.uid); const snap=await getDoc(doc(db,'configs','home')); state = snap.exists()? (snap.data()||{sections:[]}) : {sections:[]}; if(!Array.isArray(state.sections)) state.sections=[]; renderTable(); });
</script></head>
<body>
<header><div class="brand">LeaderMath â€” Admin (Netlify)</div><div style="margin-left:auto" id="guard">...</div></header>
<main>
  <div class="card"><h3>Nazorat</h3><div class="body">
    <button id="add">+ Boâ€˜lim qoâ€˜shish</button>
    <button id="download">home.json yuklab olish</button>
    <button id="publish">Firestoreâ€™ga chiqarish (Netlify)</button>
  </div></div>
  <div class="card"><h3>Boâ€˜limlar</h3><div class="body"><table id="tbl"><thead><tr><th>#</th><th>ID</th><th>Sarlavha</th><th>Mode</th><th>Amal</th></tr></thead><tbody></tbody></table></div></div>
  <div class="card"><h3>Tahrir</h3><div class="body" id="ed"><div class="small">Edit tugmasini bosing.</div></div></div>
</main>
</body></html>
