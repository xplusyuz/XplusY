<!DOCTYPE html>
<img class="w-full h-36 object-cover img hidden"/>
<div class="p-4">
<div class="flex items-center justify-between">
<div class="font-semibold title line-clamp-1">Test</div>
<span class="text-xs px-2 py-0.5 rounded-full bg-emerald-100 text-emerald-700 type">Oddiy</span>
</div>
<p class="text-xs text-gray-500 mt-1 sub">â€”</p>
<div class="mt-2 text-xs text-gray-600 schedule">â€”</div>
<div class="mt-3 grid grid-cols-2 gap-2 text-sm">
<button class="btn btn-secondary openBtn" type="button">Boshlash</button>
<div class="flex gap-2 justify-end">
<button class="btn btn-secondary infoBtn hidden" type="button">â„¹ï¸ Info</button>
<a class="btn btn-secondary link" target="_blank">Havola</a>
</div>
</div>
<div class="mt-3 flex gap-2">
<button class="btn btn-secondary edit" type="button">âœï¸</button>
<button class="btn btn-secondary del" type="button">ğŸ—‘ï¸</button>
</div>
</div>
</div>
</template>


<script>
const LS='adm_tests_v1';
const get=()=>JSON.parse(localStorage.getItem(LS)||'[]');
const set=v=>localStorage.setItem(LS,JSON.stringify(v));
const $=s=>document.querySelector(s);
const esc=s=>String(s||'').replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;","\"":"&quot;","'":"&#39;","\">":"&gt;"}[c]));


const modal=$('#modal'), body=$('#body');
$('#mCancel').onclick=()=>modal.close();
function inputHtml(f){
if(f.type==='select') return `<select name="${f.key}" class="input">${f.options.map(o=>`<option value="${o}">${o}</option>`).join('')}</select>`;
const base=`name="${f.key}" class="input" ${f.required?'required':''}`;
if(f.type==='textarea') return `<textarea ${base} rows="3">${f.value||''}</textarea>`;
return `<input type="${f.type||'text'}" ${base} value="${f.value||''}">`;
}
function openForm(data,onSave){
body.innerHTML='';
const fields=[
{key:'type',label:'Turi',type:'select',options:['Oddiy','Online'],value:data?.type||'Oddiy'},
{key:'title',label:'Sarlavha',type:'text',required:true,value:data?.title||''},
{key:'subtitle',label:'Qisqa info',type:'textarea',value:data?.subtitle||''},
{key:'price',label:'Narx (UZS)',type:'number',value:data?.price??0},
{key:'imageUrl',label:'Rasm (Oddiy)',type:'url',value:data?.imageUrl||''},
{key:'link',label:'Havola',type:'url',value:data?.link||''},
{key:'startAt',label:'Boshlash (Online)',type:'text',value:data?.startAt||''},
{key:'endAt',label:'Tugash (Online)',type:'text',value:data?.endAt||''},
{key:'infoText',label:'Info matni (Online)',type:'textarea',value:data?.infoText||''},
{key:'tags',label:'Teglar (vergul bilan)',type:'text',value:(data?.tags||[]).join(',')}
];
fields.forEach(f=>{const w=document.createElement('div'); w.innerHTML=`<label class='text-sm text-gray-600'>${f.label}</label>${inputHtml(f)}`; const i=w.querySelector('input,textarea,select'); if(i && f.value!=null) i.value=f.value; body.appendChild(w);});
modal.showModal();
$('#mSave').onclick=()=>{const v={}; body.querySelectorAll('input,textarea,select').forEach(el=>v[el.name]=el.type==='number'?Number(el.value):el.value); v.tags=String(v.tags||'').split(',').map(s=>s.trim()).filter(Boolean); onSave(v); modal.close();};
}


const grid=$('#grid'), filters=$('#filters'); let active=new Set();
function render(){
const arr=get();
const all=[...new Set(arr.flatMap(x=>x.tags||[]))].slice(0,12);
filters.innerHTML=all.map(t=>`<button data-t="${esc(t)}" class="px-3 py-1 rounded-full border ${active.has(t)?'bg-emerald-600 text-white border-emerald-600':'bg-white'} text-sm">${esc(t)}</button>`).join('');
filters.querySelectorAll('button').forEach(b=> b.onclick=()=>{ const t=b.dataset.t; if(active.has(t)) active.delete(t); else { if(active.size>=3) return alert('Max 3 tag'); active.add(t);} render(); });
grid.innerHTML='';
const list=arr.filter(x=> active.size? (x.tags||[]).some(t=>active.has(t)) : true);
list.forEach((x,i)=> grid.appendChild(card(x,i)));
}


function card(x,i){
const tpl=document.querySelector('#tpl').content.cloneNode(true);
const free=Number(x.price||0)===0; tpl.querySelector('.badge-free').classList.toggle('hidden',!free); tpl.querySelector('.badge-pro').classList.toggle('hidden',free);
tpl.querySelector('.title').textContent=x.title||'â€”'; tpl.querySelector('.sub').textContent=x.subtitle||'â€”';
tpl.querySelector('.type').textContent=x.type||'Oddiy';
const img=tpl.querySelector('.img'); if((x.type||'Oddiy')==='Oddiy' && x.imageUrl){ img.src=x.imageUrl; img.classList.remove('hidden'); }
const link=tpl.querySelector('.link'); link.href=x.link||'#';
const openBtn=tpl.querySelector('.openBtn'); const schedule=tpl.querySelector('.schedule'); const infoBtn=tpl.querySelector('.infoBtn');
if((x.type||'Oddiy')==='Online'){
infoBtn.classList.remove('hidden'); infoBtn.onclick=()=> alert(x.infoText||'');
const now=new Date(), s=x.startAt?new Date(x.startAt):null, e=x.endAt?new Date(x.endAt):null;
let enabled=false, msg='â€”'; if(s&&e){msg=`${s.toLocaleString()} â€” ${e.toLocaleString()}`; enabled=now>=s && now<=e;} else if(s){msg=`Boshlanish: ${s.toLocaleString()}`; enabled=now>=s;}