<section class="home">
  <style>
    /* ====== Home (inline CSS) ====== */
    :root{
      --bg:#0b1210; --bg-2:#101a17; --bg-3:#0e1714; --card:#12211b;
      --muted:#9ab6a8; --txt:#eaf5ef; --brand:#34d399; --brand-2:#10b981;
    }
    .home { display:grid; gap:22px; }
    .home-head h1, .home-head h2 { margin:.2rem 0; }
    .home-head p { color: var(--muted); margin:.2rem 0; }
    .home-sep { height:1px; border:none; background:linear-gradient(90deg, rgba(255,255,255,.08), transparent); }

    /* Lists */
    .banner-list.hero { display:grid; gap:14px; }
    .banner-list.promos.grid {
      display:grid; gap:14px;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    }
    .banner-list.sponsors.row {
      display:flex; gap:16px; flex-wrap:wrap; align-items:center;
    }

    /* Cards */
    .banner {
      text-decoration:none; color:inherit;
      border:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
      border-radius:16px; overflow:hidden;
      display:grid; gap:0;
      transition: border-color .15s ease;
    }
    .banner:hover { border-color: rgba(52,211,153,.35); }

    .hero-card {
      grid-template-columns: 1.2fr .8fr;
      min-height: 240px;
    }
    .hero-card .b-txt { padding:18px; display:grid; gap:8px; align-content:center; }
    .hero-card .b-title { font-size: 28px; margin:0; }
    .hero-card .b-sub { color: var(--muted); margin:0; }
    .hero-card .b-media { display:grid; place-items:center; background: rgba(0,0,0,.12); }
    .hero-card img { width:100%; height:100%; object-fit:cover; }

    .promo-card { display:grid; grid-template-rows: 180px auto; }
    .promo-card .b-media { background: rgba(0,0,0,.12); }
    .promo-card img { width:100%; height:100%; object-fit:cover; }
    .promo-card .b-txt { padding:12px; }
    .promo-card .b-title { margin:.2rem 0; font-size:20px; }

    .sponsor-card {
      background:#0f1916; border:1px dashed rgba(255,255,255,.08);
      display:grid; place-items:center; padding:10px 14px;
      min-width: 140px; min-height: 64px; border-radius:12px;
    }
    .sponsor-card img { max-height:44px; width:auto; }

    .btn.mini {
      display:inline-block; padding:8px 12px; border-radius:10px;
      background: linear-gradient(180deg, var(--brand), var(--brand-2));
      color:#0b1210; font-weight:700; border: none;
      width:max-content;
    }

    /* Responsive */
    @media (max-width: 780px){
      .hero-card { grid-template-columns: 1fr; grid-template-rows: auto 220px; }
    }

    /* Small utilities */
    .small{font-size:12px} .muted{color:var(--muted)}
    .msg { padding:10px 12px; border-radius:10px; }
    .msg.error{ color:#fecaca; background:rgba(239,68,68,.15); border:1px solid rgba(239,68,68,.35); }
  </style>

  <!-- HERO BANNERS (kattasi) -->
  <section
    id="heroBanners"
    class="home-hero"
    aria-label="Reklama bannerlari"
    data-csv="/data/banners.csv"
    data-placement="hero"
  >
    <header class="home-head">
      <h1>Kundalik yangilik va takliflar</h1>
    </header>

    <div class="banner-list hero" data-target="list"></div>
    <div class="home-note small muted">
      <span>CSV: <code>/data/banners.csv</code></span>
    </div>
  </section>

  <hr class="home-sep" />

  <!-- PROMO GRID -->
  <section
    id="promoGrid"
    class="home-promos"
    aria-label="Maxsus aksiyalar"
    data-csv="/data/banners.csv"
    data-placement="promo"
  >
    <header class="home-head">
      <h2>Maxsus aksiyalar</h2>
    </header>

    <div class="banner-list promos grid" data-target="list"></div>
  </section>

  <hr class="home-sep" />

  <!-- SPONSORLAR -->
  <section
    id="sponsorStrip"
    class="home-sponsors"
    aria-label="Hamkorlar"
    data-csv="/data/banners.csv"
    data-placement="sponsor"
  >
    <header class="home-head">
      <h2>Hamkorlarimiz</h2>
    </header>

    <div class="banner-list sponsors row" data-target="list"></div>
  </section>

  <script>
    // ====== CSV Banner Loader (pure functional JS) ======
    (function(){
      // Oddiy CSV parser: qo'shtirnoqni qo'llab-quvvatlaydi
      function csvParse(text){
        const rows=[]; const lines=text.replace(/\r/g,'').split('\n').filter(x=>x.trim().length);
        const headers = lines.shift().split(',').map(h=>h.trim());
        for(const line of lines){
          let row=[], cur='', inQ=false;
          for(let i=0;i<line.length;i++){
            const ch=line[i], nx=line[i+1];
            if(ch==='\"'){
              if(inQ && nx==='\"'){ cur+='\"'; i++; }
              else{ inQ=!inQ; }
            }else if(ch===',' && !inQ){ row.push(cur); cur=''; }
            else{ cur+=ch; }
          }
          row.push(cur);
          const obj={}; headers.forEach((h,idx)=>obj[h]= (row[idx]??'').trim());
          rows.push(obj);
        }
        return rows;
      }
      const normalizeBool = v => String(v||'').trim()==='1';
      const num = (v, d=0) => { const n=Number(v); return Number.isFinite(n)?n:d; };
      const byDate = it => {
        const now = new Date();
        const sd = it.start_date ? new Date(it.start_date) : null;
        const ed = it.end_date ? new Date(it.end_date) : null;
        if(sd && now < sd) return false;
        if(ed && now > ed) return false;
        return true;
      };

      function card(item, placement){
        const bg = item.background ? `style="background:${item.background}"` : "";
        const img = item.image ? `<img src="${item.image}" alt="${(item.title||'')}" loading="lazy">` : "";
        const sub = item.subtitle ? `<p class="b-sub">${item.subtitle}</p>` : "";
        const cta = item.cta_text ? `<span class="btn mini">${item.cta_text}</span>` : "";
        const href = item.url ? `href="${item.url}"` : "";

        if(placement==='hero'){
          return `<a class="banner hero-card" ${href} ${bg}>
            <div class="b-txt">
              <h3 class="b-title">${item.title||''}</h3>
              ${sub}
              ${cta}
            </div>
            <div class="b-media">${img}</div>
          </a>`;
        }
        if(placement==='promo'){
          return `<a class="banner promo-card" ${href} ${bg}>
            <div class="b-media">${img}</div>
            <div class="b-txt">
              <h4 class="b-title">${item.title||''}</h4>
              ${sub}
            </div>
          </a>`;
        }
        // sponsor
        return `<a class="banner sponsor-card" ${href} title="${item.title||''}">
          ${img || `<span class="sponsor-fallback">${item.title||''}</span>`}
        </a>`;
      }

      async function loadSection(sec){
        const csvUrl = sec.getAttribute('data-csv');
        const placement = (sec.getAttribute('data-placement')||'hero').toLowerCase();
        const list = sec.querySelector('[data-target="list"]');
        if(!csvUrl || !list) return;

        try{
          const res = await fetch(csvUrl, {cache:'no-store'});
          if(!res.ok) throw new Error('CSV topilmadi');
          const text = await res.text();
          const items = csvParse(text)
            .filter(x => normalizeBool(x.active))
            .filter(byDate)
            .filter(x => (x.placement||'').toLowerCase() === placement)
            .sort((a,b)=> num(a.order,9999)-num(b.order,9999));
          list.innerHTML = items.map(x=>card(x, placement)).join('') || `<div class="muted small">Banner yo‘q.</div>`;
        }catch(e){
          console.error('[home banners]', e);
          list.innerHTML = `<div class="msg error">CSV o‘qishda xatolik.</div>`;
        }
      }

      async function hydrate(){
        const sections = document.querySelectorAll('section[data-csv][data-placement]');
        for(const sec of sections) await loadSection(sec);
      }

      // Bir marta ishga tushirish
      hydrate();

      // Agar bu partial SPA ichida bo‘lsa, qayta render qilishga qulaylik:
      window.__xpy_reload_home_banners = hydrate;
    })();
  </script>
</section>
