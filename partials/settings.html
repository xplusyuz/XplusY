<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sozlamalar</title>
  <link rel="stylesheet" href="./base.css"/>
  <style>
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .status-badge { padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border-1); text-transform:capitalize; }
    .status-pending { background:#fff8e1; }
    .status-approved { background:#e8f5e9; }
    .status-rejected { background:#ffebee; }
    .adm-note { width:100%; min-height:64px; border:1px solid var(--border-1); border-radius:8px; padding:8px; }
    .tabs { display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; }
    .tabs .btn.active { outline:2px solid var(--border-2); }
    .hint.ok { color: #0a7b36; }
    .hint.err { color: #b00020; }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .grid { display:grid; gap:10px; }
    .card { border:1px solid var(--border-1,#ddd); border-radius:12px; padding:10px; }
    .modal.hidden{ display:none; }
    .modal .dialog{ background:#fff; border-radius:14px; margin:5svh auto; max-width:960px; padding:10px; border:1px solid #ddd; }
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.32); padding:10px; }
    .btn{ padding:8px 12px; border-radius:10px; border:1px solid #ddd; background:#f7f7f7; cursor:pointer; }
    .btn.primary{ background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
    .btn.ghost{ background:#fff; }
    .btn.danger{ background:#ef4444; color:#fff; border-color:#ef4444; }
    .sub{ color:#555; font-size:.9rem; }
    .pill{ display:inline-block; padding:4px 10px; border:1px solid #ddd; border-radius:999px; margin:2px; }
    .form-grid{ display:grid; gap:8px; grid-template-columns:repeat(2,minmax(0,1fr)); }
    .field{ display:flex; flex-direction:column; gap:4px; }
    .field input, .field select{ padding:8px; border-radius:8px; border:1px solid #ddd; }
    .head{ display:flex; align-items:center; justify-content:space-between; }
    .icon-btn{ border:none; background:transparent; font-size:22px; cursor:pointer; }
  </style>
</head>
<body>
<h1>Sozlamalar</h1>

<section class="grid">
  <article class="card" id="cardProfile">
    <h2>üë§ Profil</h2>
    <p class="sub">Shaxsiy ma‚Äôlumotlar</p>
    <button class="btn ghost" data-open="profileModal">Ko‚Äòrish</button>
  </article>

  <article class="card" id="cardResults">
    <h2>üìä Natijalar</h2>
    <p class="sub">So‚Äònggi 20 natija</p>
    <button class="btn ghost" data-open="resultsModal">Ko‚Äòrish</button>
  </article>

  <article class="card" id="cardBalance">
    <h2>üí≥ Balans to‚Äòldirish</h2>
    <p class="sub">CLICK / Xazna / P2P</p>
    <button class="btn ghost" data-open="topUpModal">Ochish</button>
  </article>

  <article class="card" id="cardBadges">
    <h2>üèÜ Yutuqlar</h2>
    <p class="sub">Badjlar</p>
    <button class="btn ghost" data-open="badgesModal">Ko‚Äòrish</button>
  </article>

  <article class="card" id="cardPromo">
    <h2>üéÅ Promo kod</h2>
    <p class="sub">Bonus olish</p>
    <button class="btn ghost" data-open="promoModal">Kiritish</button>
  </article>

  <article class="card" id="cardAdmin">
    <h2>üõ†Ô∏è Admin sahifa</h2>
    <p class="sub">To‚Äòlovlar / Users / Promo</p>
    <button class="btn danger" id="openAdmin">Kirish</button>
  </article>

  <button class="btn" data-action="signout">Chiqish</button>
</section>

<!-- Profil -->
<div class="modal hidden" id="profileModal">
  <div class="dialog">
    <div class="head">
      <h3>Profil</h3>
      <button class="icon-btn" data-close>&times;</button>
    </div>
    <div class="body">
      <form id="profileForm" class="form-grid">
        <div class="field"><label>Numeric ID</label><input id="pf_numericId" type="text" readonly/></div>
        <div class="field"><label>Ism</label><input id="pf_firstName" type="text"/></div>
        <div class="field"><label>Familiya</label><input id="pf_lastName" type="text"/></div>
        <div class="field"><label>Otasining ismi</label><input id="pf_middleName" type="text"/></div>
        <div class="field"><label>Tug‚Äòilgan sana</label><input id="pf_dob" type="date"/></div>
        <div class="field"><label>Viloyat</label><input id="pf_region" type="text"/></div>
        <div class="field"><label>Tuman/Shahar</label><input id="pf_district" type="text"/></div>
        <div class="field"><label>Telefon</label><input id="pf_phone" type="tel"/></div>
        <div class="field"><label>üíµ Balans</label><input id="pf_balance" type="number" readonly/></div>
        <div class="field"><label>üíé Olmos</label><input id="pf_gems" type="number" readonly/></div>
      </form>
    </div>
    <div class="foot">
      <button id="profileEdit" class="btn">‚úèÔ∏è Tahrirlash</button>
      <button id="profileSave" class="btn primary">Saqlash</button>
    </div>
  </div>
</div>

<!-- Natijalar -->
<div class="modal hidden" id="resultsModal">
  <div class="dialog">
    <div class="head">
      <h3>Natijalar</h3>
      <button class="icon-btn" data-close>&times;</button>
    </div>
    <div class="body">
      <div id="resultsList" class="grid"></div>
    </div>
  </div>
</div>

<!-- Yutuqlar -->
<div class="modal hidden" id="badgesModal">
  <div class="dialog">
    <div class="head">
      <h3>Yutuqlar</h3>
      <button class="icon-btn" data-close>&times;</button>
    </div>
    <div class="body">
      <div id="badgesWrap" class="grid" style="grid-template-columns:repeat(2,1fr)"></div>
    </div>
  </div>
</div>

<!-- Promo -->
<div class="modal hidden" id="promoModal">
  <div class="dialog">
    <div class="head">
      <h3>Promo kod</h3>
      <button class="icon-btn" data-close>&times;</button>
    </div>
    <div class="body">
      <div style="display:flex;gap:8px">
        <input id="promoInput" type="text" placeholder="Kodni kiriting"/>
        <button id="promoApply" class="btn primary">Qo‚Äòllash</button>
      </div>
      <p id="promoMsg" class="hint"></p>
    </div>
  </div>
</div>

<!-- Admin: Tabs -->
<div class="modal hidden" id="adminModal">
  <div class="dialog" style="width:min(1100px,100%)">
    <div class="head">
      <h3>üõ†Ô∏è Admin</h3>
      <button class="icon-btn" data-close>&times;</button>
    </div>
    <div class="body">
      <div class="tabs">
        <button class="btn ghost active" id="tabPayments">üßæ To‚Äòlovlar</button>
        <button class="btn ghost" id="tabUsers">üë• Users</button>
        <button class="btn ghost" id="tabPromo">üéÅ Promo</button>
      </div>

      <!-- PAYMENTS -->
      <section id="panePayments">
        <div class="row" style="margin-bottom:8px">
          <button id="adm_pay_pending" class="btn primary">‚è≥ Yangi</button>
          <button id="adm_pay_approved" class="btn ghost">‚úÖ Qabul qilingan</button>
          <button id="adm_pay_rejected" class="btn ghost">‚ùå Rad etilgan</button>
          <button id="adm_pay_all" class="btn ghost">Hammasi</button>
        </div>
        <div id="adm_pay_table" class="grid"></div>
      </section>

      <!-- USERS -->
      <section id="paneUsers" class="hidden">
        <div style="display:flex;gap:8px;margin-bottom:10px">
          <input id="adm_query" type="text" placeholder="numericId yoki telefon"/>
          <button id="adm_search" class="btn">Qidirish</button>
          <button id="adm_list_all" class="btn ghost">Top 50</button>
        </div>
        <div id="adm_table" class="grid"></div>
      </section>

      <!-- PROMO -->
      <section id="panePromo" class="hidden">
        <h4 style="margin:6px 0 10px">Promo kod yaratish</h4>
        <div class="form-grid">
          <div class="field"><label>Kod</label><input id="pr_code" type="text" placeholder="MASALAX10"/></div>
          <div class="field"><label>Balans + (so‚Äòm)</label><input id="pr_balance" type="number" value="0"/></div>
          <div class="field"><label>Olmos +</label><input id="pr_gems" type="number" value="0"/></div>
          <div class="field"><label>Foizli skidka (%)</label><input id="pr_percent" type="number" value="0"/></div>
          <div class="field"><label>Muddati (yyyy-mm-dd)</label><input id="pr_expires" type="date"/></div>
          <div class="field"><label>Maks. ishlatish soni</label><input id="pr_max" type="number" value="1"/></div>
          <div class="field"><label>Bir foydalanuvchiga limit</label><input id="pr_peruser" type="number" value="1"/></div>
          <div class="field"><label>Faol</label>
            <select id="pr_active">
              <option value="true">Ha</option>
              <option value="false">Yo‚Äòq</option>
            </select>
          </div>
        </div>
        <div class="foot" style="justify-content:flex-start">
          <button id="pr_create" class="btn primary">Yaratish</button>
          <span id="pr_msg" class="sub"></span>
        </div>
      </section>
    </div>
  </div>
</div>

<!-- Top-up Modal -->
<div class="modal hidden" id="topUpModal">
  <div class="dialog" style="width:min(980px,100%)">
    <div class="head">
      <h3>üí≥ Balans to‚Äòldirish</h3>
      <button class="icon-btn" data-close>&times;</button>
    </div>
    <div class="body">
      <div class="grid" style="grid-template-columns:repeat(2,minmax(0,1fr));gap:12px">
        <section class="card">
          <h4 style="margin:0 0 8px">To‚Äòlov usullari</h4>
          <div class="grid" style="grid-template-columns:repeat(2,minmax(0,1fr));gap:10px">
            <a class="btn primary" href="https://indoor.click.uz/pay?id=0081656&t=0" target="_blank" rel="noopener">CLICK ‚Äî to‚Äòlov</a>
            <a class="btn" href="https://pay.xazna.uz/p2p/f5edea87-06a5-4d48-a01d-885cf843eb8f" target="_blank" rel="noopener">Xazna ‚Äî P2P</a>
            <a class="card" href="https://indoor.click.uz/pay?id=0081656&t=0" target="_blank" rel="noopener" style="text-align:center">
              <img src="./assets/Click.jpg" alt="CLICK" style="max-width:100%;border-radius:12px">
              <div class="sub">CLICK orqali onlayn to‚Äòlov</div>
            </a>
            <a class="card" href="https://pay.xazna.uz/p2p/f5edea87-06a5-4d48-a01d-885cf843eb8f" target="_blank" rel="noopener" style="text-align:center">
              <img src="./assets/Xazna.jpg" alt="Xazna" style="max-width:100%;border-radius:12px">
              <div class="sub">Xazna P2P orqali to‚Äòlov</div>
            </a>
            <div class="card" style="text-align:center">
              <img src="./assets/Click QR kode.png" alt="CLICK QR/USSD" style="max-width:100%;border-radius:12px">
              <div class="sub">USSD: <b>*880*081656*summa#</b></div>
            </div>
            <div class="card" style="text-align:center">
              <img src="./assets/Bank karta.png" alt="Karta P2P" style="max-width:100%;border-radius:12px">
              <div class="sub"><b>Sattorov Sohibjon</b><br>4916 9903 0103 2469</div>
            </div>
          </div>
        </section>

        <section class="card">
          <h4 style="margin:0 0 8px">Chekni yuborish</h4>
          <div class="form-grid">
            <div class="field"><label>Summasi (so‚Äòm)</label><input id="pay_amount" type="number" min="1000" step="1000" placeholder="10000"></div>
            <div class="field"><label>Izoh (ixtiyoriy)</label><input id="pay_note" type="text" placeholder="To‚Äòlov maqsadi"></div>
            <div class="field"><label>Chek fayl</label><input id="pay_file" type="file" accept="image/*,application/pdf"></div>
          </div>
          <p class="sub">Chek, summa va profilingiz ma‚Äôlumotlari admin panelga va Telegram botga yuboriladi.</p>
          <div class="foot" style="justify-content:flex-start">
            <button id="pay_submit" class="btn primary">Yuborish</button>
            <span id="pay_msg" class="hint"></span>
          </div>
        </section>
      </div>

      <section class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px">To‚Äòldirishlar tarixi</h4>
        <div id="pay_history" class="grid"></div>
      </section>
    </div>
  </div>
</div>

<!-- Inline JS (module) -->
<script type="module">
import { attachAuthUI, initUX, db, ADMIN_NUMERIC_IDS } from "./common.js";
import { doc, setDoc, updateDoc, collection, query, where, orderBy, limit, getDocs, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

// ==== Telegram =====
const TG_TOKEN = "8021293022:AAGud9dz-Dv_5RjsjF0RFaqgMR2LeKA6G7c";
const TG_CHAT_ID = "2049065724";
const TG_API = \`https://api.telegram.org/bot\${TG_TOKEN}\`;
// ===================

attachAuthUI({ requireSignIn: true });
initUX();

const qs=(s,el=document)=>el.querySelector(s);
const qsa=(s,el=document)=>[...el.querySelectorAll(s)];
const show=el=>el?.classList.remove('hidden');
const hide=el=>el?.classList.add('hidden');

function openModal(id){ hideAll(); show(qs('#'+id)); }
function hideAll(){ qsa('.modal').forEach(m=>m.classList.add('hidden')); }
document.addEventListener('click',(e)=>{
  const openId=e.target.getAttribute('data-open'); if(openId) openModal(openId);
  if(e.target.hasAttribute('data-close')) e.target.closest('.modal')?.classList.add('hidden');
  if(e.target.classList.contains('modal')) e.target.classList.add('hidden');
});

let currentUser=null, currentDoc=null;
document.addEventListener('mc:user-ready', async ()=>{
  const { user, profile } = window.__mcUser; currentUser=user; currentDoc=profile;
  fillProfile(profile);
  renderBadges(profile.badges||[]);
});

function fillProfile(d){
  qs('#pf_numericId').value = d.numericId ?? '‚Äî';
  qs('#pf_firstName').value = d.firstName ?? '';
  qs('#pf_lastName').value = d.lastName ?? '';
  qs('#pf_middleName').value = d.middleName ?? '';
  qs('#pf_dob').value = d.dob ?? '';
  qs('#pf_region').value = d.region ?? '';
  qs('#pf_district').value = d.district ?? '';
  qs('#pf_phone').value = d.phone ?? '';
  qs('#pf_balance').value = d.balance ?? 0;
  qs('#pf_gems').value = d.gems ?? 0;
}
function setEditable(x){
  ['#pf_firstName','#pf_lastName','#pf_middleName','#pf_dob','#pf_region','#pf_district','#pf_phone'].forEach(s=> qs(s).readOnly=!x);
  qs('#profileSave').disabled = !x;
}
qs('#profileEdit').addEventListener('click', ()=> setEditable(true));
qs('#profileSave').addEventListener('click', async ()=>{
  try{
    const ref=doc(db,'users', currentUser.uid);
    const data={
      firstName: qs('#pf_firstName').value.trim(),
      lastName: qs('#pf_lastName').value.trim(),
      middleName: qs('#pf_middleName').value.trim(),
      dob: qs('#pf_dob').value,
      region: qs('#pf_region').value.trim(),
      district: qs('#pf_district').value.trim(),
      phone: qs('#pf_phone').value.trim(),
    };
    await updateDoc(ref, data);
    alert('Profil saqlandi ‚úÖ'); setEditable(false); currentDoc={ ...currentDoc, ...data };
  }catch(e){ alert('Xato: '+e.message); }
});

// Results
async function loadResults(){
  const list=qs('#resultsList'); list.innerHTML='<div class="card">Yuklanmoqda‚Ä¶</div>';
  const col=collection(db,'users', currentUser.uid, 'results');
  const snap=await getDocs(query(col, orderBy('createdAtFS','desc'), limit(20)));
  list.innerHTML=''; if(snap.empty){ list.innerHTML='<div class="hint">Hozircha natija yo‚Äòq.</div>'; return; }
  snap.forEach(d=>{ const r=d.data(); const when=r.createdAt || ''; const el=document.createElement('div'); el.className='card'; el.innerHTML=\`<div><b>\${r.examName||'Sinov'}</b></div><div class="sub">Score: \${r.score?.toFixed?.(2) ?? r.score} ‚Äî \${when}</div>\`; list.appendChild(el); });
}
document.querySelector('#cardResults .btn')?.addEventListener('click', loadResults);

// Badges
function renderBadges(arr){
  const w=qs('#badgesWrap'); w.innerHTML=''; if(!arr||!arr.length){ w.innerHTML='<div class="hint">Hozircha yutuqlar yo‚Äòq.</div>'; return; }
  arr.forEach(b=>{ const s=document.createElement('span'); s.className='pill'; s.textContent=b; w.appendChild(s); });
}

// Promo apply (user)
qs('#promoApply').addEventListener('click', async ()=>{
  const msg=qs('#promoMsg'); msg.textContent='';
  const code=qs('#promoInput').value.trim(); if(!code){ msg.textContent='Kod kiriting'; return; }
  try{
    const promoRef=doc(db,'promoCodes', code);
    const userRef=doc(db,'users', currentUser.uid);
    const redRef=doc(db,'users', currentUser.uid, 'promoRedemptions', code);
    await runTransaction(db, async (tx)=>{
      const p=await tx.get(promoRef); if(!p.exists()) throw new Error('Kod topilmadi');
      const D=p.data();
      if(D.active===false) throw new Error('Kod faol emas');
      if(D.expiresAt && D.expiresAt.toDate && D.expiresAt.toDate() < new Date()) throw new Error('Muddati tugagan');
      const used=await tx.get(redRef); if(used.exists()) throw new Error('Bu kod allaqachon ishlatilgan');
      const u=await tx.get(userRef); if(!u.exists()) throw new Error('Foydalanuvchi topilmadi');
      tx.update(userRef, { balance: Number(u.data().balance||0) + Number(D.balance||0), gems: Number(u.data().gems||0) + Number(D.gems||0) });
      tx.set(redRef, { usedAt: serverTimestamp(), code });
    });
    msg.textContent='‚úÖ Qo‚Äòllandi';
  }catch(e){
    msg.textContent='‚ùå '+(e.message||e);
  }
});

// Admin open (guarded)
document.getElementById('openAdmin')?.addEventListener('click', ()=>{
  if(!ADMIN_NUMERIC_IDS.includes(Number(currentDoc?.numericId))) return alert('Faqat 1000001/1000002');
  openModal('adminModal');
  document.getElementById('adm_pay_pending')?.click();
});

// ---------- Top-up: upload -> Firestore -> Telegram (non-blocking) -> history ----------
function bindTopup(){
  const btn = document.getElementById('pay_submit');
  if(!btn || btn._bound) return;
  btn._bound = true;
  btn.addEventListener('click', async ()=>{
    const msg=qs('#pay_msg'); msg.className='hint'; msg.textContent='Yuborilmoqda‚Ä¶';
    btn.disabled = true;
    try{
      const amount = Number(qs('#pay_amount').value||0);
      if(!amount || amount<1000) throw new Error('Summani kiriting');
      const note = qs('#pay_note').value.trim();
      const file = qs('#pay_file').files?.[0];
      // Storage (optional)
      let fileURL=null, fileName=null, id=Math.random().toString(36).slice(2);
      try{
        if(file){
          const storage = getStorage();
          fileName = file.name;
          const path = \`users/\${currentUser.uid}/topups/\${id}/\${fileName}\`;
          const sref = sRef(storage, path);
          await uploadBytes(sref, file);
          fileURL = await getDownloadURL(sref);
        }
      }catch(err){ console.warn('Storage xato:', err); }
      // Firestore
      const refCol = collection(db,'users', currentUser.uid, 'topups');
      const payload={ 
        amount, note, filename: fileName, fileURL: fileURL || null,
        createdAt: new Date(), createdAtFS: serverTimestamp(), 
        status: 'pending',
        userNumericId: currentDoc?.numericId || null,
        userName: \`\${currentDoc?.firstName||''} \${currentDoc?.lastName||''}\`.trim(),
        userPhone: currentDoc?.phone || null
      };
      await setDoc(doc(refCol, id), payload);

      // UI: do not wait for Telegram
      msg.className='hint ok'; msg.textContent='‚úÖ Yuborildi. Arizangiz ko‚Äòrib chiqiladi.';
      qs('#pay_amount').value=''; qs('#pay_note').value=''; if(qs('#pay_file')) qs('#pay_file').value='';
      await loadPayHistory();

      // Telegram fire-and-forget with 3s timeout
      try{
        const caption = \`üßæ Yangi to‚Äòlov arizasi\n\n\`+
          \`üí∞ Summasi: \${amount.toLocaleString('uz-UZ')} so‚Äòm\n\`+
          \`üë§ ID: \${currentDoc?.numericId} | \${currentDoc?.firstName||''} \${currentDoc?.lastName||''}\n\`+
          \`üìû Tel: \${currentDoc?.phone||'-'}\n\`+
          (note?\`üìù Izoh: \${note}\n\`:'')+
          (fileURL?\`üìé Chek: \${fileURL}\n\`:'');
        const controller = new AbortController();
        setTimeout(()=>controller.abort(), 3000);
        const url = fileURL? \`\${TG_API}/sendDocument\` : \`\${TG_API}/sendMessage\`;
        const body = fileURL? { chat_id: TG_CHAT_ID, caption, document: fileURL, parse_mode:"HTML" } : { chat_id: TG_CHAT_ID, text: caption };
        fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body), signal: controller.signal })
          .catch(err=>console.warn('Telegram yuborilmadi:', err));
      }catch(err){ console.warn('Telegram skip:', err); }

    }catch(e){
      msg.className='hint err'; msg.textContent='‚ùå '+(e.message||e);
    } finally {
      btn.disabled = false;
    }
  });
}
bindTopup();

export async function loadPayHistory(){
  const wrap=qs('#pay_history'); if(!wrap) return;
  wrap.innerHTML='<div class="card">Yuklanmoqda‚Ä¶</div>';
  const col=collection(db,'users', currentUser.uid, 'topups');
  const snap=await getDocs(query(col, orderBy('createdAtFS','desc'), limit(20)));
  wrap.innerHTML='';
  if(snap.empty){ wrap.innerHTML='<div class="hint">Hozircha ma‚Äôlumot yo‚Äòq.</div>'; return; }
  snap.forEach(d=>{
    const r=d.data();
    const st = r.status||'pending';
    const el=document.createElement('div'); el.className='card';
    el.innerHTML = \`<div class="row"><b>\${r.amount?.toLocaleString?.('uz-UZ')} so‚Äòm</b>
        <span class="status-badge status-\${st}">\${st}</span></div>
        \${r.note?\`<div class="sub">Izoh: \${r.note}</div>\`:''}
        \${r.adminNote && st!=='pending' ? \`<div class="sub"><b>Admin izohi:</b> \${r.adminNote}</div>\`:''}\`;
    wrap.appendChild(el);
  });
}
document.querySelector('#cardBalance [data-open="topUpModal"]')?.addEventListener('click', ()=>{
  try{ loadPayHistory(); }catch{}
  bindTopup();
});

// ------------------- ADMIN: Users & Promo -------------------
function ensureAdminSync(){
  if(!ADMIN_NUMERIC_IDS.includes(Number(currentDoc?.numericId))){
    throw new Error('Faqat 1000001/1000002 ruxsat etiladi');
  }
}

// Users list/search
async function adminListTop(){
  ensureAdminSync();
  const table=qs('#adm_table'); table.innerHTML='';
  const snap=await getDocs(query(collection(db,'users'), orderBy('numericId','asc'), limit(50)));
  renderAdminTable(snap);
}
async function adminSearch(){
  ensureAdminSync();
  const term=(qs('#adm_query').value||'').trim(); if(!term) return adminListTop();
  let snap;
  if(/^[0-9]+$/.test(term)){
    snap = await getDocs(query(collection(db,'users'), where('numericId','==', Number(term)), limit(20)));
  }else{
    snap = await getDocs(query(collection(db,'users'), where('phone','==', term), limit(20)));
  }
  renderAdminTable(snap);
}
function renderAdminTable(snap){
  const table=qs('#adm_table'); table.innerHTML='';
  const head=document.createElement('div'); head.className='card';
  head.innerHTML='<b>ID</b> | Ism | Fam | Tel | Viloyat | Balans | Olmos | DOB | Amal';
  table.appendChild(head);
  if(snap.empty){ const d=document.createElement('div'); d.className='hint'; d.textContent='Hech narsa topilmadi'; table.appendChild(d); return; }
  snap.forEach(d=>{
    const u=d.data(); const row=document.createElement('div'); row.className='card adm-row'; row.setAttribute('data-uid', d.id);
    row.innerHTML = \`
      <input class="a_numericId" type="number" value="\${u.numericId ?? ''}" />
      <input class="a_firstName" type="text" value="\${u.firstName ?? ''}" />
      <input class="a_lastName" type="text" value="\${u.lastName ?? ''}" />
      <input class="a_phone" type="text" value="\${u.phone ?? ''}" />
      <input class="a_region" type="text" value="\${u.region ?? ''}" />
      <input class="a_balance" type="number" value="\${u.balance ?? 0}" />
      <input class="a_gems" type="number" value="\${u.gems ?? 0}" />
      <input class="a_dob" type="date" value="\${u.dob ?? ''}" />
      <button class="btn primary a_save">Saqlash</button>\`;
    table.appendChild(row);
  });
}
document.getElementById('adm_list_all')?.addEventListener('click', adminListTop);
document.getElementById('adm_search')?.addEventListener('click', adminSearch);

// Save user row
document.addEventListener('click', async (e)=>{
  if(!e.target.classList.contains('a_save')) return;
  try{
    ensureAdminSync();
    const row=e.target.closest('.adm-row'); const uid=row.getAttribute('data-uid');
    const ref=doc(db,'users', uid);
    await updateDoc(ref, {
      numericId: Number(row.querySelector('.a_numericId').value) || null,
      firstName: row.querySelector('.a_firstName').value.trim(),
      lastName: row.querySelector('.a_lastName').value.trim(),
      phone: row.querySelector('.a_phone').value.trim(),
      region: row.querySelector('.a_region').value.trim(),
      balance: Number(row.querySelector('.a_balance').value),
      gems: Number(row.querySelector('.a_gems').value),
      dob: row.querySelector('.a_dob').value
    });
    alert('Saqlandi ‚úÖ');
  }catch(err){ alert('Xato: '+(err.message||err)); }
});

// Promo create
document.getElementById('pr_create')?.addEventListener('click', async ()=>{
  try{
    ensureAdminSync();
    const code = qs('#pr_code').value.trim();
    if(!code) throw new Error('Kod kiriting');
    const payload = {
      code,
      active: qs('#pr_active').value==='true',
      balance: Number(qs('#pr_balance').value||0),
      gems: Number(qs('#pr_gems').value||0),
      percent: Number(qs('#pr_percent').value||0),
      maxUses: Number(qs('#pr_max').value||0),
      perUserLimit: Number(qs('#pr_peruser').value||1),
      createdAt: serverTimestamp(),
      createdBy: currentUser.uid
    };
    const ex = qs('#pr_expires').value;
    if(ex) payload.expiresAt = new Date(ex+'T23:59:59');
    await setDoc(doc(db,'promoCodes', code), payload);
    qs('#pr_msg').textContent = '‚úÖ Yaratildi';
  }catch(err){
    qs('#pr_msg').textContent = '‚ùå '+(err.message||err);
  }
});

// ------------------- ADMIN: Payments list + approve/reject + filters -------------------
async function listPayments(filter='pending'){
  ensureAdminSync();
  const wrap = qs('#adm_pay_table'); wrap.innerHTML='<div class="card">Yuklanmoqda‚Ä¶</div>';

  try{
    const usersSnap = await getDocs(query(collection(db,'users'), orderBy('numericId','asc'), limit(200)));
    wrap.innerHTML='';
    let cnt=0;
    for (const u of usersSnap.docs){
      const uid=u.id;
      const col=collection(db,'users', uid, 'topups');
      let qy;
      if(filter==='all'){
        qy = query(col, orderBy('createdAtFS','desc'), limit(50));
      }else{
        qy = query(col, where('status','==', filter), limit(50)); // orderBy yo'q ‚Äî indeks talab qilmaydi
      }
      const snap=await getDocs(qy);
      snap.forEach(d=>{
        const r=d.data();
        const nid = r.userNumericId ?? u.data().numericId ?? '‚Äî';
        const card=document.createElement('div'); card.className='card adm-row'; card.dataset.uid=uid; card.dataset.id=d.id;
        card.innerHTML = \`
          <div class="row">
            <b>\${r.amount?.toLocaleString?.('uz-UZ')} so‚Äòm</b>
            <span class="status-badge status-\${r.status||'pending'}">\${r.status||'pending'}</span>
          </div>
          <div class="sub">UserID: \${nid} | Name: \${r.userName||''} | Tel: \${r.userPhone||''}</div>
          <div class="sub">Topup Doc ID: \${d.id}</div>
          \${r.note?\`<div class="sub">Foydalanuvchi izohi: \${r.note}</div>\`:''}
          \${r.adminNote && r.status!=='pending' ? \`<div class="sub"><b>Admin izohi:</b> \${r.adminNote}</div>\`:''}
          <textarea class="adm-note" placeholder="Admin izohi (faqat siz uchun)"></textarea>
          <div class="row">
            \${r.status==='pending' ? \`<button class="btn primary a_approve">Qabul qilish</button>
            <button class="btn danger a_reject">Rad etish</button>\` : ''}
          </div>\`;
        wrap.appendChild(card);
        cnt++;
      });
    }
    if(!cnt){ wrap.innerHTML = '<div class="hint">Hech narsa yo‚Äòq.</div>'; }
  }catch(err){
    wrap.innerHTML = \`<div class="card" style="color:#b00020">‚ùå Xato: \${err?.message||err}</div>\`;
    console.error('[payments]', err);
  }
}
document.getElementById('adm_pay_pending')?.addEventListener('click', ()=>listPayments('pending'));
document.getElementById('adm_pay_approved')?.addEventListener('click', ()=>listPayments('approved'));
document.getElementById('adm_pay_rejected')?.addEventListener('click', ()=>listPayments('rejected'));
document.getElementById('adm_pay_all')?.addEventListener('click', ()=>listPayments('all'));

document.addEventListener('click', async (e)=>{
  if(!(e.target.classList.contains('a_approve')||e.target.classList.contains('a_reject'))) return;
  try{
    ensureAdminSync();
    const row = e.target.closest('.adm-row');
    const uid=row.dataset.uid, id=row.dataset.id;
    const reason = row.querySelector('.adm-note')?.value?.trim()||'';
    const approved = e.target.classList.contains('a_approve');
    const userRef = doc(db,'users', uid);
    const topupRef = doc(db,'users', uid, 'topups', id);
    await runTransaction(db, async (tx)=>{
      const t = await tx.get(topupRef); if(!t.exists()) throw new Error('Top-up topilmadi');
      const R = t.data(); if(R.status!=='pending') throw new Error('Bu ariza allaqachon ko‚Äòrilgan');
      const u = await tx.get(userRef); if(!u.exists()) throw new Error('User topilmadi');
      if(approved){
        const newBal = Number(u.data().balance||0) + Number(R.amount||0);
        tx.update(userRef, { balance: newBal });
        tx.update(topupRef, { status:'approved', adminNote: reason, reviewedAt: serverTimestamp(), reviewedBy: currentUser.uid });
      }else{
        tx.update(topupRef, { status:'rejected', adminNote: reason, reviewedAt: serverTimestamp(), reviewedBy: currentUser.uid });
      }
    });
    const badge = row.querySelector('.status-badge');
    badge.textContent = approved? 'approved':'rejected';
    badge.className = 'status-badge ' + (approved? 'status-approved':'status-rejected');
    row.querySelectorAll('.a_approve,.a_reject').forEach(b=> b.disabled=true);
    alert('Bajarildi ‚úÖ');
  }catch(err){
    alert('Xato: '+(err.message||err));
  }
});

// -------- Tabs switching --------
function setTab(tab){
  const tabs = ['Payments','Users','Promo'];
  tabs.forEach(name=>{
    const btn = document.getElementById('tab'+name);
    const pane = document.getElementById('pane'+name);
    if(!btn || !pane) return;
    if(name===tab){ btn.classList.add('active'); pane.classList.remove('hidden'); }
    else{ btn.classList.remove('active'); pane.classList.add('hidden'); }
  });
}
document.getElementById('tabPayments')?.addEventListener('click', ()=>{ setTab('Payments'); document.getElementById('adm_pay_pending')?.click(); });
document.getElementById('tabUsers')?.addEventListener('click', ()=>{ setTab('Users'); adminListTop(); });
document.getElementById('tabPromo')?.addEventListener('click', ()=>{ setTab('Promo'); });
</script>
</body>
</html>
