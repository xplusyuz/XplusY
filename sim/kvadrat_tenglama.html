<!DOCTYPE html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>MathPro — Professional Kvadrat Tenglamalar Simulyatori</title>
  <meta name="theme-color" content="#4361ee"/>
  <link rel="icon" href="./logo.png" sizes="any">
  <link rel="apple-touch-icon" href="./logo.png">
  <meta name="theme-color" content="#2E8B57"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- MathJax -->
  <script>
    (function(){
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      s.async = true; 
      document.head.appendChild(s);
      window.MathJax = { 
        tex: { 
          inlineMath: [['$','$'],['\\(','\\)']],
          displayMath: [['$$','$$'],['\\[','\\]']]
        },
        chtml: {
          scale: 1.1
        }
      };
    })();
  </script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #7209b7;
      --success: #4cc9f0;
      --danger: #f72585;
      --warning: #f8961e;
      --info: #4895ef;
      --light: #f8f9fa;
      --dark: #212529;
      --bg: #f9fafb;
      --card: #ffffff;
      --text: #333333;
      --muted: #6c757d;
      --border: #dee2e6;
      --radius: 12px;
      --radius-lg: 16px;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.12);
      --transition: all 0.3s ease;
    }

    [data-theme="dark"] {
      --bg: #121212;
      --card: #1e1e1e;
      --text: #f0f0f0;
      --muted: #a0a0a0;
      --border: #333333;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.4);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      font-size: 15px;
      line-height: 1.6;
      color: var(--text);
      background: var(--bg);
      min-height: 100vh;
      transition: var(--transition);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    header {
      position: sticky;
      top: 0;
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.85);
      border-bottom: 1px solid var(--border);
      z-index: 100;
      transition: var(--transition);
    }

    [data-theme="dark"] header {
      background: rgba(30, 30, 30, 0.85);
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px 0;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 18px;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
    }

    .brand-name {
      font-weight: 700;
      font-size: 20px;
      color: var(--primary);
    }

    .brand-tagline {
      font-size: 13px;
      color: var(--muted);
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .theme-toggle {
      background: none;
      border: none;
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: var(--transition);
    }

    .theme-toggle:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    [data-theme="dark"] .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .main-content {
      padding: 30px 0;
      display: grid;
      gap: 25px;
    }

    .panel {
      background: var(--card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      overflow: hidden;
      transition: var(--transition);
    }

    .panel-header {
      padding: 20px 25px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .panel-title {
      font-weight: 600;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-title i {
      color: var(--primary);
    }

    .panel-body {
      padding: 25px;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .control-label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .control-label i {
      color: var(--primary);
      font-size: 14px;
    }

    .control-hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: -5px;
    }

    .form-control, .form-select {
      padding: 12px 15px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      color: var(--text);
      font-size: 14px;
      transition: var(--transition);
    }

    .form-control:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
    }

    .form-select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 40px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 5px;
    }

    .checkbox {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }

    .checkbox-label {
      font-size: 14px;
      color: var(--text);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      border: none;
      border-radius: var(--radius);
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
    }

    .btn-secondary {
      background: var(--light);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--border);
      transform: translateY(-1px);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #e11570;
      transform: translateY(-2px);
    }

    .btn-sm {
      padding: 8px 15px;
      font-size: 13px;
    }

    .actions-row {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 20px;
    }

    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 15px;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 120px;
      flex: 1;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }

    .stat-label {
      font-size: 13px;
      color: var(--muted);
    }

    .progress-container {
      width: 100%;
      height: 8px;
      background: var(--light);
      border-radius: 10px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      border-radius: 10px;
      transition: width 0.5s ease;
    }

    .question-container {
      background: var(--light);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid var(--border);
    }

    .question-text {
      font-size: 18px;
      line-height: 1.5;
      margin-bottom: 15px;
    }

    .graph-container {
      margin: 20px 0;
      display: flex;
      justify-content: center;
      flex-direction: column;
      align-items: center;
    }

    .graph-canvas {
      max-width: 100%;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: white;
    }

    .graph-instructions {
      margin-top: 10px;
      font-size: 14px;
      color: var(--muted);
      text-align: center;
    }

    .answer-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .math-keyboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
      gap: 8px;
      margin-top: 15px;
      padding: 15px;
      background: var(--light);
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    .math-key {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
      user-select: none;
    }

    .math-key:hover {
      background: var(--primary);
      color: white;
    }

    .input-hint {
      font-size: 13px;
      color: var(--muted);
      margin-top: 5px;
    }

    .feedback {
      padding: 15px;
      border-radius: var(--radius);
      margin-top: 15px;
      display: none;
    }

    .feedback-success {
      background: rgba(76, 201, 240, 0.1);
      border: 1px solid var(--success);
      color: var(--success);
    }

    .feedback-error {
      background: rgba(247, 37, 133, 0.1);
      border: 1px solid var(--danger);
      color: var(--danger);
    }

    .results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .result-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      border: 1px solid var(--border);
    }

    .result-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--primary);
    }

    .skill-progress {
      margin-bottom: 15px;
    }

    .skill-name {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 14px;
    }

    .skill-value {
      font-weight: 600;
    }

    .history-table {
      width: 100%;
      border-collapse: collapse;
    }

    .history-table th, .history-table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .history-table th {
      font-weight: 600;
      color: var(--muted);
      font-size: 14px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-primary {
      background: rgba(67, 97, 238, 0.1);
      color: var(--primary);
    }

    .badge-success {
      background: rgba(76, 201, 240, 0.1);
      color: var(--success);
    }

    .badge-warning {
      background: rgba(248, 150, 30, 0.1);
      color: var(--warning);
    }

    .badge-danger {
      background: rgba(247, 37, 133, 0.1);
      color: var(--danger);
    }

    .hidden {
      display: none !important;
    }

    .timer-warning {
      color: var(--warning);
      animation: pulse 1.5s infinite;
    }

    .timer-danger {
      color: var(--danger);
      animation: pulse 1s infinite;
    }

    .question-analysis {
      margin-top: 30px;
    }

    .analysis-item {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 15px;
      overflow: hidden;
    }

    .analysis-header {
      padding: 15px;
      background: var(--light);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .analysis-question {
      font-weight: 500;
    }

    .analysis-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .analysis-body {
      padding: 15px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .analysis-answer {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .analysis-label {
      font-size: 13px;
      color: var(--muted);
    }

    .analysis-value {
      font-weight: 500;
    }

    .analysis-correct {
      color: var(--success);
    }

    .analysis-incorrect {
      color: var(--danger);
    }

    @media (max-width: 768px) {
      .controls-grid {
        grid-template-columns: 1fr;
      }
      
      .header-content {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .stats-row {
        flex-direction: column;
      }
      
      .answer-grid {
        grid-template-columns: 1fr;
      }
      
      .math-keyboard {
        grid-template-columns: repeat(6, 1fr);
      }
      
      .analysis-body {
        grid-template-columns: 1fr;
      }
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
	.logo {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 48px;
  height: 48px;
  border-radius: 14px;
  background: linear-gradient(180deg, #eaf6f0, #ffffff);
  box-shadow:
    0 4px 12px rgba(46,139,87,.15),
    inset 0 1px 0 rgba(255,255,255,.8);
  border: 1px solid #dfe9e3;
  overflow: hidden;
  transition: transform .25s ease, box-shadow .25s ease;
}
.logo img {
  width: 70%;
  height: 70%;
  object-fit: contain;
  filter: drop-shadow(0 2px 3px rgba(46,139,87,.2));
  transition: transform .25s ease;
}
.logo:hover {
  transform: scale(1.05);
  box-shadow:
    0 6px 20px rgba(46,139,87,.25),
    inset 0 1px 0 rgba(255,255,255,.8);
}
.logo:hover img {
  transform: rotate(8deg);
}
@media (max-width:640px){
  .logo{
    width:40px; height:40px; border-radius:12px;
  }
}

  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="header-content">
        <div class="brand">
          <span class="logo"><img src="./logo.png" alt="LM"></span>
          <div class="brand-text">
            <div class="brand-name">MathPro</div>
            <div class="brand-tagline">Professional matematika simulyatori</div>
          </div>
        </div>
        <div class="header-controls">
          <button class="theme-toggle" id="themeToggle">
            <i class="fas fa-moon"></i>
          </button>
          <div class="badge badge-primary" id="modeIndicator">
            <i class="fas fa-user-graduate"></i> Ustoz rejimi: O'chiq
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="main-content">
      <!-- Boshqaruv paneli -->
      <section class="panel" id="configPanel">
        <div class="panel-header">
          <h2 class="panel-title">
            <i class="fas fa-sliders-h"></i>
            Test sozlamalari
          </h2>
        </div>
        <div class="panel-body">
          <div class="controls-grid">
            <div class="control-group">
              <label class="control-label">
                <i class="fas fa-layer-group"></i>
                Test turi
              </label>
              <select class="form-select" id="testType">
                <option value="quick">Tezkor test (10 savol)</option>
                <option value="exam">Imtihon (30 savol)</option>
                <option value="custom">Maxsus test</option>
              </select>
            </div>
            
            <div class="control-group">
              <label class="control-label">
                <i class="fas fa-tachometer-alt"></i>
                Qiyinchilik darajasi
              </label>
              <select class="form-select" id="difficulty">
                <option value="easy">Oson (butun ildizlar)</option>
                <option value="medium" selected>O'rtacha (ratsional/irratsional)</option>
                <option value="hard">Qiyin (irratsional/kompleks)</option>
              </select>
            </div>
            
            <div class="control-group" id="customCountGroup">
              <label class="control-label">
                <i class="fas fa-list-ol"></i>
                Savollar soni
              </label>
              <input type="number" class="form-control" id="questionCount" min="5" max="100" value="15">
            </div>
            
            <div class="control-group">
              <label class="control-label">
                <i class="fas fa-clock"></i>
                Vaqt cheklovi (daqiqa)
              </label>
              <input type="number" class="form-control" id="timeLimit" min="0" max="180" value="25">
              <div class="control-hint">0 - vaqt cheklovsiz</div>
            </div>
            
            <div class="control-group">
              <label class="control-label">
                <i class="fas fa-calculator"></i>
                Kompleks ildizlar
              </label>
              <select class="form-select" id="allowComplex">
                <option value="no" selected>Ruxsat etilmaydi</option>
                <option value="yes">Ruxsat etiladi</option>
              </select>
            </div>
            
            <div class="control-group">
              <label class="control-label">
                <i class="fas fa-random"></i>
                Savol turlari
              </label>
              <select class="form-select" id="questionTypes" multiple size="4">
                <option value="disc" selected>Diskriminant</option>
                <option value="vieta" selected>Vieta formulalari</option>
                <option value="vertex" selected>Parabola uchi</option>
                <option value="roots" selected>Ildizlarni topish</option>
                <option value="count" selected>Ildizlar soni</option>
                <option value="axis">Simmetriya o'qi</option>
                <option value="yint">Y kesishish nuqtasi</option>
                <option value="factor">Ko'paytuvchilarga ajratish</option>
                <option value="ineq" selected>Tengsizliklar</option>
                <option value="g_roots" selected>Grafikdan ildizlar</option>
                <option value="g_vertex" selected>Grafikdan uchi</option>
                <option value="g_axis">Grafikdan o'q</option>
                <option value="g_range">Grafikdan qiymatlar sohasi</option>
                <option value="g_to_eq" selected>Grafikdan tenglama</option>
              </select>
              <div class="control-hint">Ctrl/Cmd tugmasi bilan bir nechtasini tanlang</div>
            </div>
            
            <div class="control-group">
              <label class="control-label">
                <i class="fas fa-balance-scale"></i>
                Savol turlari nisbati (%)
              </label>
              <input type="text" class="form-control" id="typeWeights" value="25,25,25,25">
              <div class="control-hint">Diskriminant, Vieta, Uchi, Ildizlar</div>
            </div>
            
            <div class="control-group">
              <label class="control-label">
                <i class="fas fa-seedling"></i>
                Ildiz tabiati nisbati (%)
              </label>
              <input type="text" class="form-control" id="rootNatureWeights" value="40,25,35,0">
              <div class="control-hint">Butun, Ratsional, Irratsional, Kompleks</div>
            </div>
            
            <div class="control-group hidden" id="seedGroup">
              <label class="control-label">
                <i class="fas fa-key"></i>
                Test identifikatori (seed)
              </label>
              <input type="text" class="form-control" id="seed" placeholder="test-2025-001">
              <div class="control-hint">Bir xil testni takrorlash uchun</div>
            </div>
          </div>
          
          <div class="checkbox-group">
            <input type="checkbox" class="checkbox" id="teacherMode">
            <label class="checkbox-label">Ustoz rejimi (qo'shimcha sozlamalar)</label>
          </div>
          
          <div class="actions-row">
            <button class="btn btn-secondary" id="demoBtn">
              <i class="fas fa-eye"></i> Demo savol
            </button>
            <button class="btn btn-primary" id="startBtn">
              <i class="fas fa-play"></i> Testni boshlash
            </button>
          </div>
        </div>
      </section>

      <!-- Test paneli -->
      <section class="panel hidden" id="testPanel">
        <div class="panel-header">
          <h2 class="panel-title">
            <i class="fas fa-pencil-alt"></i>
            Test davom etmoqda
          </h2>
          <div class="badge badge-warning" id="timer">
            <i class="fas fa-clock"></i> <span id="timeDisplay">25:00</span>
          </div>
        </div>
        <div class="panel-body">
          <div class="stats-row">
            <div class="stat-card">
              <div class="stat-value" id="currentQuestion">1</div>
              <div class="stat-label">Joriy savol</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalQuestions">15</div>
              <div class="stat-label">Jami savollar</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="correctAnswers">0</div>
              <div class="stat-label">To'g'ri javoblar</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="currentScore">0</div>
              <div class="stat-label">Ball</div>
            </div>
          </div>
          
          <div class="progress-container">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
          </div>
          
          <div class="question-container">
            <div class="question-text" id="questionText">
              Savol matni yuklanmoqda...
            </div>
            <div class="graph-container hidden" id="graphContainer">
              <canvas class="graph-canvas" id="graphCanvas" width="600" height="400"></canvas>
              <div class="graph-instructions" id="graphInstructions">
                Grafikdagi nuqtalarni kuzatib, ildizlarni taxmin qiling
              </div>
            </div>
          </div>
          
          <div class="answer-grid" id="answerArea">
            <!-- Javob maydonlari dinamik ravishda yuklanadi -->
          </div>
          
          <div class="math-keyboard hidden" id="mathKeyboard">
            <!-- Matematik klaviatura dinamik ravishda yuklanadi -->
          </div>
          
          <div class="feedback hidden" id="feedback">
            <!-- Feedback dinamik ravishda yuklanadi -->
          </div>
          
          <div class="actions-row">
            <button class="btn btn-danger" id="skipBtn">
              <i class="fas fa-forward"></i> O'tkazib yuborish (-2 ball)
            </button>
            <button class="btn btn-primary" id="checkBtn">
              <i class="fas fa-check"></i> Javobni tekshirish
            </button>
          </div>
        </div>
      </section>

      <!-- Natijalar paneli -->
      <section class="panel hidden" id="resultsPanel">
        <div class="panel-header">
          <h2 class="panel-title">
            <i class="fas fa-chart-line"></i>
            Test natijalari
          </h2>
        </div>
        <div class="panel-body">
          <div class="results-grid">
            <div class="result-card">
              <div class="result-title">Umumiy natija</div>
              <div class="skill-progress">
                <div class="skill-name">
                  <span>Umumiy ball</span>
                  <span class="skill-value" id="finalScore">0/150</span>
                </div>
                <div class="progress-container">
                  <div class="progress-bar" id="finalScoreBar" style="width: 0%"></div>
                </div>
              </div>
              <div class="skill-progress">
                <div class="skill-name">
                  <span>To'g'ri javoblar</span>
                  <span class="skill-value" id="finalCorrect">0/15</span>
                </div>
                <div class="progress-container">
                  <div class="progress-bar" id="correctBar" style="width: 0%"></div>
                </div>
              </div>
              <div class="skill-progress">
                <div class="skill-name">
                  <span>Sarflangan vaqt</span>
                  <span class="skill-value" id="timeSpent">00:00</span>
                </div>
              </div>
              <div class="skill-progress">
                <div class="skill-name">
                  <span>Baholash</span>
                  <span class="skill-value" id="finalGrade">-</span>
                </div>
              </div>
            </div>
            
            <div class="result-card">
              <div class="result-title">Ko'nikmalar tahlili</div>
              <div id="skillsAnalysis">
                <!-- Ko'nikmalar tahlili dinamik ravishda yuklanadi -->
              </div>
            </div>
          </div>
          
          <div class="question-analysis">
            <h3 style="margin-bottom: 15px;">Savollar tahlili</h3>
            <div id="questionsAnalysis">
              <!-- Savollar tahlili dinamik ravishda yuklanadi -->
            </div>
          </div>
          
          <div class="actions-row">
            <button class="btn btn-secondary" id="exportCsv">
              <i class="fas fa-file-csv"></i> CSV eksport
            </button>
            <button class="btn btn-secondary" id="exportJson">
              <i class="fas fa-file-code"></i> JSON eksport
            </button>
            <button class="btn btn-primary" id="restartBtn">
              <i class="fas fa-redo"></i> Yangi test
            </button>
          </div>
          
          <div style="margin-top: 30px;">
            <h3 style="margin-bottom: 15px;">Oxirgi testlar</h3>
            <table class="history-table" id="historyTable">
              <thead>
                <tr>
                  <th>Sana</th>
                  <th>Test turi</th>
                  <th>Savollar</th>
                  <th>Ball</th>
                  <th>Vaqt</th>
                  <th>Baholash</th>
                </tr>
              </thead>
              <tbody>
                <!-- Tarix jadvali dinamik ravishda yuklanadi -->
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    // Asosiy konstantalar va o'zgaruvchilar
    const QUESTION_TYPES = [
      "disc", "vieta", "vertex", "roots", "count", "axis", "yint", 
      "factor", "ineq", "g_roots", "g_vertex", "g_axis", "g_range", "g_to_eq"
    ];
    
    const STATE = {
      config: null,
      questions: [],
      currentQuestionIndex: 0,
      correctAnswers: 0,
      incorrectAnswers: 0,
      score: 0,
      startTime: 0,
      timeLimit: 0,
      timer: null,
      subSkills: {},
      subSkillsCorrect: {},
      isDemo: false,
      activeInput: null,
      userAnswers: [] // Foydalanuvchi javoblarini saqlash uchun
    };

    // DOM elementlari
    const DOM = {
      configPanel: document.getElementById('configPanel'),
      testPanel: document.getElementById('testPanel'),
      resultsPanel: document.getElementById('resultsPanel'),
      themeToggle: document.getElementById('themeToggle'),
      modeIndicator: document.getElementById('modeIndicator'),
      teacherMode: document.getElementById('teacherMode'),
      seedGroup: document.getElementById('seedGroup'),
      testType: document.getElementById('testType'),
      customCountGroup: document.getElementById('customCountGroup'),
      questionCount: document.getElementById('questionCount'),
      timeLimit: document.getElementById('timeLimit'),
      difficulty: document.getElementById('difficulty'),
      allowComplex: document.getElementById('allowComplex'),
      questionTypes: document.getElementById('questionTypes'),
      typeWeights: document.getElementById('typeWeights'),
      rootNatureWeights: document.getElementById('rootNatureWeights'),
      seed: document.getElementById('seed'),
      startBtn: document.getElementById('startBtn'),
      demoBtn: document.getElementById('demoBtn'),
      currentQuestion: document.getElementById('currentQuestion'),
      totalQuestions: document.getElementById('totalQuestions'),
      correctAnswers: document.getElementById('correctAnswers'),
      currentScore: document.getElementById('currentScore'),
      progressBar: document.getElementById('progressBar'),
      questionText: document.getElementById('questionText'),
      graphContainer: document.getElementById('graphContainer'),
      graphCanvas: document.getElementById('graphCanvas'),
      graphInstructions: document.getElementById('graphInstructions'),
      answerArea: document.getElementById('answerArea'),
      mathKeyboard: document.getElementById('mathKeyboard'),
      feedback: document.getElementById('feedback'),
      checkBtn: document.getElementById('checkBtn'),
      skipBtn: document.getElementById('skipBtn'),
      timer: document.getElementById('timer'),
      timeDisplay: document.getElementById('timeDisplay'),
      finalScore: document.getElementById('finalScore'),
      finalCorrect: document.getElementById('finalCorrect'),
      finalScoreBar: document.getElementById('finalScoreBar'),
      correctBar: document.getElementById('correctBar'),
      timeSpent: document.getElementById('timeSpent'),
      finalGrade: document.getElementById('finalGrade'),
      skillsAnalysis: document.getElementById('skillsAnalysis'),
      questionsAnalysis: document.getElementById('questionsAnalysis'),
      historyTable: document.getElementById('historyTable'),
      exportCsv: document.getElementById('exportCsv'),
      exportJson: document.getElementById('exportJson'),
      restartBtn: document.getElementById('restartBtn')
    };

    // Yordamchi funksiyalar
    const UTILS = {
      // DOM qisqartmasi
      $(selector) { return document.querySelector(selector); },
      $$(selector) { return Array.from(document.querySelectorAll(selector)); },
      
      // Raqamni chegaralash
      clamp(value, min, max) { return Math.max(min, Math.min(max, value)); },
      
      // Joriy vaqt
      now() { return Date.now(); },
      
      // Vaqtni formatlash
      formatTime(seconds) {
        seconds = Math.floor(seconds);
        const minutes = Math.floor(seconds / 60).toString().padStart(2, '0');
        const secs = (seconds % 60).toString().padStart(2, '0');
        return `${minutes}:${secs}`;
      },
      
      // Sonni tahlil qilish
      parseNumber(str) {
        if (!str || typeof str !== 'string') return null;
        
        str = str.trim();
        
        // Butun son
        if (/^-?\d+$/.test(str)) return parseInt(str, 10);
        
        // O'nlik son
        if (/^-?\d*\.\d+$/.test(str)) return parseFloat(str);
        
        // Kasr
        const fractionMatch = str.match(/^(-?\d+)\/(-?\d+)$/);
        if (fractionMatch) {
          const numerator = parseInt(fractionMatch[1], 10);
          const denominator = parseInt(fractionMatch[2], 10);
          if (denominator !== 0) return numerator / denominator;
        }
        
        // Ildiz
        const sqrtMatch = str.match(/^([+-]?)\s*sqrt\((\d+)\)$/i);
        if (sqrtMatch) {
          const sign = sqrtMatch[1] === '-' ? -1 : 1;
          const value = parseInt(sqrtMatch[2], 10);
          return sign * Math.sqrt(value);
        }
        
        // Son sifatida
        const num = Number(str);
        return isNaN(num) ? null : num;
      },
      
      // Tasodifiy son generatori
      createRandomGenerator(seed) {
        let h = 0;
        if (seed) {
          for (let i = 0; i < seed.length; i++) {
            h = (h * 131 + seed.charCodeAt(i)) >>> 0;
          }
        }
        
        return () => {
          if (seed) {
            h ^= h << 13;
            h ^= h >>> 17;
            h ^= h << 5;
            return (h >>> 0) / 4294967296;
          }
          return Math.random();
        };
      },
      
      // Sonlarni solishtirish
      nearlyEqual(a, b, tolerance = 1e-4) {
        return Number.isFinite(a) && Number.isFinite(b) && Math.abs(a - b) <= tolerance;
      },
      
      // Massivni tasodifiy aralashtirish
      shuffleArray(array, randomFn = Math.random) {
        const result = [...array];
        for (let i = result.length - 1; i > 0; i--) {
          const j = Math.floor(randomFn() * (i + 1));
          [result[i], result[j]] = [result[j], result[i]];
        }
        return result;
      },
      
      // Butun qismga yaxlitlash
      randInt(randomFn, min, max) {
        return Math.floor(randomFn() * (max - min + 1)) + min;
      },
      
      // Qiymatlar sohasini tekshirish
      parseRange(str) {
        if (!str) return null;
        
        // Barcha bo'sh joylarni olib tashlash
        str = str.replace(/\s+/g, '');
        
        // Standart formatlar
        const patterns = [
          /^\(-∞,([^)]+)\)$/, // (-∞, a)
          /^\(-∞,([^]]+)\]$/, // (-∞, a]
          /^\(([^,]+),∞\)$/,  // (a, ∞)
          /^\[([^,]+),∞\)$/,  // [a, ∞)
          /^\(([^,]+),([^)]+)\)$/, // (a, b)
          /^\[([^,]+),([^]]+)\]$/, // [a, b]
          /^\(([^,]+),([^]]+)\]$/, // (a, b]
          /^\[([^,]+),([^)]+)\)$/, // [a, b)
          /^\{([^}]+)\}$/, // {a} - bitta nuqta
          /^∅$/, // Bo'sh to'plam
          /^R$/, // Barcha haqiqiy sonlar
          /^\(-∞,\+∞\)$/ // (-∞, +∞)
        ];
        
        for (const pattern of patterns) {
          const match = str.match(pattern);
          if (match) {
            return str;
          }
        }
        
        return null;
      },
      
      // Javobni formatlash
      formatAnswer(answer, questionType) {
        if (!answer) return "Javob berilmagan";
        
        if (questionType === 'roots') {
          if (answer.complex) return "Kompleks ildizlar";
          return `x₁ = ${answer.x1?.toFixed(4) || '?'}, x₂ = ${answer.x2?.toFixed(4) || '?'}`;
        }
        
        if (questionType === 'vertex') {
          return `(h, k) = (${answer.h?.toFixed(4) || '?'}, ${answer.k?.toFixed(4) || '?'})`;
        }
        
        if (questionType === 'vieta') {
          return `S = ${answer.S?.toFixed(4) || '?'}, P = ${answer.P?.toFixed(4) || '?'}`;
        }
        
        if (questionType === 'disc') {
          return `D = ${answer.D || '?'}`;
        }
        
        if (questionType === 'count') {
          return `${answer.count || '?'} ta`;
        }
        
        if (questionType === 'axis') {
          return `x = ${answer.axis?.toFixed(4) || '?'}`;
        }
        
        if (questionType === 'yint') {
          return `y(0) = ${answer.y0 || '?'}`;
        }
        
        if (questionType === 'factor') {
          return answer.factorization || "Omillarga ajratib bo'lmaydi";
        }
        
        if (questionType === 'ineq') {
          return answer.range || '?';
        }
        
        if (questionType === 'g_roots') {
          if ('count' in answer) return `${answer.count} ta`;
          return `x₁ ≈ ${answer.x1?.toFixed(2) || '?'}, x₂ ≈ ${answer.x2?.toFixed(2) || '?'}`;
        }
        
        if (questionType === 'g_vertex') {
          return `(h, k) = (${answer.h || '?'}, ${answer.k || '?'})`;
        }
        
        if (questionType === 'g_axis') {
          return `x = ${answer.axis || '?'}`;
        }
        
        if (questionType === 'g_range') {
          return answer.range || '?';
        }
        
        if (questionType === 'g_to_eq') {
          return `a = ${answer.A || '?'}, h = ${answer.h || '?'}, k = ${answer.k || '?'}`;
        }
        
        return JSON.stringify(answer);
      }
    };

    // Algebra funksiyalari
    const ALGEBRA = {
      // Diskriminant
      discriminant(a, b, c) {
        return b * b - 4 * a * c;
      },
      
      // Ildizlar
      findRoots(a, b, c) {
        const D = this.discriminant(a, b, c);
        if (D < 0) return null;
        const sqrtD = Math.sqrt(D);
        const x1 = (-b - sqrtD) / (2 * a);
        const x2 = (-b + sqrtD) / (2 * a);
        return [x1, x2].sort((x, y) => x - y);
      },
      
      // Parabola uchi
      findVertex(a, b, c) {
        const h = -b / (2 * a);
        const k = a * h * h + b * h + c;
        return [h, k];
      },
      
      // Simmetriya o'qi
      findAxis(a, b) {
        return -b / (2 * a);
      },
      
      // Kvadratmi?
      isPerfectSquare(n) {
        if (n < 0) return false;
        const root = Math.round(Math.sqrt(n));
        return root * root === n;
      },
      
      // EKUB
      gcd(a, b) {
        return b ? this.gcd(b, a % b) : Math.abs(a);
      },
      
      // EKUK
      lcm(a, b) {
        return Math.abs(a * b) / this.gcd(a, b);
      }
    };

    // Savol yaratish funksiyalari
    const QUESTION_GENERATOR = {
      // Savol turini tanlash
      chooseQuestionType(selectedTypes, weights) {
        const availableTypes = selectedTypes.filter(t => 
          ['disc', 'vieta', 'vertex', 'roots'].includes(t)
        );
        
        if (availableTypes.length === 0) {
          return selectedTypes[Math.floor(Math.random() * selectedTypes.length)];
        }
        
        const totalWeight = availableTypes.reduce((sum, type) => sum + (weights[type] || 0), 0);
        let randomValue = Math.random() * totalWeight;
        
        for (const type of availableTypes) {
          randomValue -= weights[type] || 0;
          if (randomValue <= 0) return type;
        }
        
        return availableTypes[0];
      },
      
      // Ildiz tabiatini tanlash
      chooseRootNature(weights) {
        const total = weights.reduce((sum, w) => sum + w, 0);
        let randomValue = Math.random() * total;
        
        if (randomValue < weights[0]) return 'integer';
        randomValue -= weights[0];
        if (randomValue < weights[1]) return 'rational';
        randomValue -= weights[1];
        if (randomValue < weights[2]) return 'irrational';
        return 'complex';
      },
      
      // Koeffitsientlarni yaratish
      generateCoefficients(nature, difficulty, allowComplex, randomFn) {
        const randInt = (min, max) => UTILS.randInt(randomFn, min, max);
        
        if (nature === 'integer') {
          const p = randInt(-6, 6);
          const q = randInt(-6, 6);
          const A = randInt(1, 3) * (randomFn() < 0.25 ? -1 : 1);
          return {
            a: A,
            b: -A * (p + q),
            c: A * p * q
          };
        }
        
        if (nature === 'rational') {
          const n = [2, 3, 4, 5][randInt(0, 3)];
          const v = [2, 3, 4, 5][randInt(0, 3)];
          const m = randInt(-8, 8);
          const u = randInt(-8, 8);
          const p = m / n;
          const q = u / v;
          
          // Agar butun bo'lib qolsa, qayta urinib ko'ramiz
          if (Number.isInteger(p) || Number.isInteger(q)) {
            return this.generateCoefficients(nature, difficulty, allowComplex, randomFn);
          }
          
          const L = ALGEBRA.lcm(n, v);
          const A = randInt(1, 3) * (randomFn() < 0.25 ? -1 : 1) * L;
          return {
            a: Math.round(A),
            b: Math.round(-A * (p + q)),
            c: Math.round(A * p * q)
          };
        }
        
        if (nature === 'irrational') {
          let a, b, c, D, attempts = 0;
          do {
            a = randInt(1, 5) * (randomFn() < 0.3 ? -1 : 1);
            b = randInt(-12, 12);
            c = randInt(-12, 12);
            D = ALGEBRA.discriminant(a, b, c);
            attempts++;
          } while ((D <= 0 || ALGEBRA.isPerfectSquare(D)) && attempts < 200);
          return { a, b, c };
        }
        
        if (nature === 'complex') {
          let a, b, c, D, attempts = 0;
          do {
            a = randInt(1, 4);
            b = randInt(-8, 8);
            c = randInt(-8, 8);
            D = ALGEBRA.discriminant(a, b, c);
            attempts++;
          } while (D >= 0 && attempts < 200);
          
          if (D >= 0) {
            c = Math.abs(c) + randInt(1, 4);
          }
          return { a, b, c };
        }
        
        // Umumiy holat
        return this.generateGenericCoefficients(difficulty, allowComplex, randomFn);
      },
      
      // Umumiy koeffitsientlar
      generateGenericCoefficients(difficulty, allowComplex, randomFn) {
        const randInt = (min, max) => UTILS.randInt(randomFn, min, max);
        let a, b, c;
        
        do {
          a = randInt(1, 5) * (randomFn() < 0.2 ? -1 : 1);
        } while (a === 0);
        
        b = randInt(-10, 10);
        c = randInt(-12, 12);
        
        if (difficulty === 'easy') {
          const p = randInt(-6, 6);
          const q = randInt(-6, 6);
          a = randInt(1, 3);
          b = -a * (p + q);
          c = a * p * q;
        }
        
        if (difficulty === 'hard' && allowComplex === 'yes') {
          const s = randInt(1, 5);
          a = randInt(1, 4);
          b = randInt(-6, 6);
          c = Math.round((b * b) / (4 * a) + s);
          if (ALGEBRA.discriminant(a, b, c) >= 0) {
            c += randInt(1, 3);
          }
        }
        
        return { a, b, c };
      },
      
      // Grafik parametrlarini yaratish
      generateGraphParams(randomFn) {
        const randInt = (min, max) => UTILS.randInt(randomFn, min, max);
        const A = [-2, -1, -0.5, 0.5, 1, 2][randInt(0, 5)];
        const h = randInt(-4, 4);
        const k = randInt(-4, 4);
        return { A, h, k };
      },
      
      // Savol yaratish
      generateQuestion(config, randomFn) {
        const selectedTypes = Array.from(config.questionTypes.selectedOptions).map(opt => opt.value);
        if (selectedTypes.length === 0) {
          selectedTypes.push('roots'); // Standart savol turi
        }
        
        const type = this.chooseQuestionType(selectedTypes, config.weights);
        
        // Ildiz tabiati vaznlarini olish
        const natureWeights = config.rootNatureWeights.split(',').map(w => parseInt(w) || 0);
        const nature = this.chooseRootNature(natureWeights);
        
        // Koeffitsientlarni yaratish
        let a, b, c;
        ({ a, b, c } = this.generateCoefficients(
          nature, 
          config.difficulty, 
          config.allowComplex, 
          randomFn
        ));
        
        // Tenglama matni
        const aText = a === 1 ? '' : a === -1 ? '-' : `${a}`;
        const bSign = b < 0 ? '−' : '+';
        const bText = Math.abs(b) === 1 ? '' : Math.abs(b);
        const bPart = b === 0 ? '' : ` ${bSign} ${bText}x`;
        const cSign = c < 0 ? '−' : '+';
        const cPart = c === 0 ? '' : ` ${cSign} ${Math.abs(c)}`;
        
        const equationText = `$${aText}x^2${bPart}${cPart} = 0$`;
        const baseQuestion = { type, a, b, c, text: equationText };
        
        // Savol turiga qarab javob yaratish
        return this.createQuestionByType(baseQuestion, config, randomFn);
      },
      
      // Savol turi bo'yicha yaratish
      createQuestionByType(base, config, randomFn) {
        const { type, a, b, c } = base;
        const randInt = (min, max) => UTILS.randInt(randomFn, min, max);
        
        if (type === 'disc') {
          return {
            ...base,
            answer: { D: ALGEBRA.discriminant(a, b, c) }
          };
        }
        
        if (type === 'count') {
          const D = ALGEBRA.discriminant(a, b, c);
          const count = D > 0 ? 2 : D === 0 ? 1 : 0;
          return {
            ...base,
            answer: { count }
          };
        }
        
        if (type === 'roots') {
          const roots = ALGEBRA.findRoots(a, b, c);
          if (roots) {
            return {
              ...base,
              answer: { x1: roots[0], x2: roots[1] }
            };
          } else {
            return {
              ...base,
              answer: { complex: true }
            };
          }
        }
        
        if (type === 'vertex') {
          const [h, k] = ALGEBRA.findVertex(a, b, c);
          return {
            ...base,
            answer: { h, k }
          };
        }
        
        if (type === 'axis') {
          return {
            ...base,
            answer: { axis: ALGEBRA.findAxis(a, b) }
          };
        }
        
        if (type === 'yint') {
          return {
            ...base,
            answer: { y0: c }
          };
        }
        
        if (type === 'vieta') {
          return {
            ...base,
            answer: { S: -b / a, P: c / a }
          };
        }
        
        if (type === 'factor') {
          const roots = ALGEBRA.findRoots(a, b, c);
          let factorization = null;
          
          if (roots && 
              UTILS.nearlyEqual(roots[0], Math.round(roots[0])) && 
              UTILS.nearlyEqual(roots[1], Math.round(roots[1]))) {
            const p = -roots[0];
            const q = -roots[1];
            const A = a === 1 ? '' : `${a}·`;
            factorization = `${A}(x ${p < 0 ? '+' : '-'} ${Math.abs(p)})(x ${q < 0 ? '+' : '-'} ${Math.abs(q)})`;
          }
          
          return {
            ...base,
            answer: { factorization }
          };
        }
        
        if (type === 'ineq') {
          const signs = ['≥', '≤', '>', '<'];
          const sign = signs[randInt(0, 3)];
          const D = ALGEBRA.discriminant(a, b, c);
          
          const formatValue = (x) => {
            if (!Number.isFinite(x)) return x;
            if (Math.abs(x) > 1e6) return x.toExponential(2);
            return Number.isInteger(x) ? x : Number(x.toFixed(4));
          };
          
          let solution = '';
          
          if (sign === '>' || sign === '≥') {
            if (a > 0) {
              if (D < 0) {
                solution = '(-∞, +∞)';
              } else if (D === 0) {
                solution = sign === '>' ? '(-∞, +∞) \\ {h}' : '(-∞, +∞)';
              } else {
                const [x1, x2] = ALGEBRA.findRoots(a, b, c);
                solution = sign === '>' 
                  ? `(-∞, ${formatValue(x1)}) ∪ (${formatValue(x2)}, +∞)`
                  : `(-∞, ${formatValue(x1)}] ∪ [${formatValue(x2)}, +∞)`;
              }
            } else {
              if (D < 0) {
                solution = '∅';
              } else if (D === 0) {
                solution = sign === '>' ? '∅' : '{h}';
              } else {
                const [x1, x2] = ALGEBRA.findRoots(a, b, c);
                solution = sign === '>' 
                  ? `(${formatValue(x1)}, ${formatValue(x2)})`
                  : `[${formatValue(x1)}, ${formatValue(x2)}]`;
              }
            }
          } else { // < yoki ≤
            if (a < 0) {
              if (D < 0) {
                solution = '(-∞, +∞)';
              } else if (D === 0) {
                solution = sign === '<' ? '(-∞, +∞) \\ {h}' : '(-∞, +∞)';
              } else {
                const [x1, x2] = ALGEBRA.findRoots(a, b, c);
                solution = sign === '<' 
                  ? `(-∞, ${formatValue(x1)}) ∪ (${formatValue(x2)}, +∞)`
                  : `(-∞, ${formatValue(x1)}] ∪ [${formatValue(x2)}, +∞)`;
              }
            } else {
              if (D < 0) {
                solution = '∅';
              } else if (D === 0) {
                solution = sign === '<' ? '∅' : '{h}';
              } else {
                const [x1, x2] = ALGEBRA.findRoots(a, b, c);
                solution = sign === '<' 
                  ? `(${formatValue(x1)}, ${formatValue(x2)})`
                  : `[${formatValue(x1)}, ${formatValue(x2)}]`;
              }
            }
          }
          
          const inequalityText = `$${a === 1 ? '' : a === -1 ? '-' : a}x^2${b < 0 ? '−' : '+'} ${Math.abs(b)}x${c < 0 ? '−' : '+'} ${Math.abs(c)} ${sign} 0$`;
          
          return {
            type: 'ineq',
            a, b, c,
            sign,
            text: `Tengsizlikni yeching: ${inequalityText}`,
            answer: { range: solution, sign }
          };
        }
        
        // Grafik bilan bog'liq savollar
        if (type.startsWith('g_')) {
          const graphParams = this.generateGraphParams(randomFn);
          
          if (type === 'g_roots') {
            const hasRealRoots = (graphParams.A * graphParams.k) <= 0;
            let answer;
            
            if (hasRealRoots) {
              const s = Math.sqrt(Math.max(0, -graphParams.k / graphParams.A));
              answer = { x1: graphParams.h - s, x2: graphParams.h + s };
            } else {
              answer = { count: 0 };
            }
            
            return {
              type: 'g_roots',
              graph: graphParams,
              text: `Parabola grafigiga asosan tenglamaning ildiz(lar)ini toping`,
              answer
            };
          }
          
          if (type === 'g_vertex') {
            return {
              type: 'g_vertex',
              graph: graphParams,
              text: `Parabola grafigiga asosan uning uchi koordinatalarini toping`,
              answer: { h: graphParams.h, k: graphParams.k }
            };
          }
          
          if (type === 'g_axis') {
            return {
              type: 'g_axis',
              graph: graphParams,
              text: `Parabola grafigiga asosan uning simmetriya o'qining tenglamasini toping`,
              answer: { axis: graphParams.h }
            };
          }
          
          if (type === 'g_range') {
            const range = graphParams.A > 0 
              ? `[${graphParams.k}, +∞)` 
              : `(-∞, ${graphParams.k}]`;
            return {
              type: 'g_range',
              graph: graphParams,
              text: `Parabola grafigiga asosan funksiya qiymatlari sohasini (range) toping`,
              answer: { range }
            };
          }
          
          if (type === 'g_to_eq') {
            return {
              type: 'g_to_eq',
              graph: graphParams,
              text: `Parabola grafigiga asosan $y = a(x-h)^2 + k$ ko'rinishidagi tenglamaning parametrlarini toping`,
              answer: { A: graphParams.A, h: graphParams.h, k: graphParams.k }
            };
          }
        }
        
        // Standart holat
        return {
          ...base,
          answer: { x1: 0, x2: 0 } // Standart javob
        };
      }
    };

    // Interfeys funksiyalari
    const UI = {
      // Sozlamalarni o'qish
      readConfig() {
        const testType = DOM.testType.value;
        let questionCount = 10;
        
        if (testType === 'exam') {
          questionCount = 30;
        } else if (testType === 'custom') {
          questionCount = UTILS.clamp(parseInt(DOM.questionCount.value) || 15, 5, 100);
        }
        
        const timeLimitMinutes = parseInt(DOM.timeLimit.value) || 0;
        const timeLimitSeconds = timeLimitMinutes * 60;
        
        const weights = DOM.typeWeights.value.split(',').map(w => parseInt(w) || 0);
        const weightsObj = {
          disc: weights[0] / 100 || 0.25,
          vieta: weights[1] / 100 || 0.25,
          vertex: weights[2] / 100 || 0.25,
          roots: weights[3] / 100 || 0.25
        };
        
        return {
          testType,
          difficulty: DOM.difficulty.value,
          allowComplex: DOM.allowComplex.value,
          questionTypes: DOM.questionTypes,
          questionCount,
          timeLimit: timeLimitSeconds,
          weights: weightsObj,
          rootNatureWeights: DOM.rootNatureWeights.value,
          seed: DOM.teacherMode.checked ? (DOM.seed.value || '') : ''
        };
      },
      
      // Matematik klaviaturani yaratish
      createMathKeyboard() {
        const mathKeys = [
          '0', '1', '2', '3', '4', '5', '6', '7', '8', '9',
          '.', '-', '+', '(', ')', '[', ']', '{', '}',
          'sqrt(', '∞', '∪', ',', '/', 'π', 'i'
        ];
        
        let html = '';
        for (const key of mathKeys) {
          html += `<div class="math-key" data-value="${key}">${key}</div>`;
        }
        
        DOM.mathKeyboard.innerHTML = html;
        
        // Klaviatura tugmalariga hodisa qo'shish
        const keys = DOM.mathKeyboard.querySelectorAll('.math-key');
        keys.forEach(key => {
          key.addEventListener('click', (e) => {
            e.preventDefault();
            
            // Agar avvalgi active input mavjud bo'lsa, unga fokus qilish
            if (STATE.activeInput) {
              STATE.activeInput.focus();
            } else {
              // Aks holda birinchi inputni topib, unga fokus qilish
              const firstInput = DOM.answerArea.querySelector('input');
              if (firstInput) {
                STATE.activeInput = firstInput;
                firstInput.focus();
              }
            }
            
            // Agar hali ham active input bo'lmasa, chiqib ketish
            if (!STATE.activeInput) return;
            
            const value = key.getAttribute('data-value');
            const start = STATE.activeInput.selectionStart;
            const end = STATE.activeInput.selectionEnd;
            const text = STATE.activeInput.value;
            
            STATE.activeInput.value = text.substring(0, start) + value + text.substring(end);
            STATE.activeInput.selectionStart = STATE.activeInput.selectionEnd = start + value.length;
            STATE.activeInput.focus();
            
            // Input hodisasini ishga tushirish
            const event = new Event('input', { bubbles: true });
            STATE.activeInput.dispatchEvent(event);
          });
        });
        
        // Input elementlariga fokus bo'lganda, ularni active input sifatida saqlash
        const inputs = DOM.answerArea.querySelectorAll('input');
        inputs.forEach(input => {
          input.addEventListener('focus', () => {
            STATE.activeInput = input;
          });
        });
      },
      
      // Savol interfeysini yaratish
      buildQuestionInterface(question) {
        DOM.answerArea.innerHTML = '';
        
        const createField = (label, id, type = 'text', placeholder = '', hint = '') => {
          if (type === 'select') {
            return `
              <div class="control-group">
                <label class="control-label">${label}</label>
                <select class="form-select" id="answer_${id}">
                  ${placeholder.split(',').map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                </select>
                ${hint ? `<div class="input-hint">${hint}</div>` : ''}
              </div>
            `;
          }
          
          return `
            <div class="control-group">
              <label class="control-label">${label}</label>
              <input type="text" class="form-control" id="answer_${id}" placeholder="${placeholder}">
              ${hint ? `<div class="input-hint">${hint}</div>` : ''}
            </div>
          `;
        };
        
        let html = '';
        let showKeyboard = false;
        
        switch (question.type) {
          case 'roots':
            html = createField('x₁', 'x1', 'text', 'Masalan: 2, -1.5, sqrt(2)', 'Kasrlar uchun 3/2, ildizlar uchun sqrt(5)') + 
                   createField('x₂', 'x2', 'text', 'Masalan: 2, -1.5, sqrt(2)', 'Agar ildizlar kompleks bo\'lsa "kompleks" yozing');
            showKeyboard = true;
            break;
            
          case 'disc':
            html = createField('Diskriminant D', 'D', 'text', 'Masalan: 25, -4, 0');
            showKeyboard = true;
            break;
            
          case 'count':
            html = createField('Ildizlar soni', 'count', 'select', '2,1,0');
            break;
            
          case 'vertex':
            html = createField('h (x-koordinata)', 'h', 'text', 'Masalan: 2, -1.5') + 
                   createField('k (y-koordinata)', 'k', 'text', 'Masalan: 4, -3.2');
            showKeyboard = true;
            break;
            
          case 'axis':
            html = createField('Simmetriya o\'qi', 'axis', 'text', 'Masalan: x=2', 'x = [qiymat] ko\'rinishida yozing');
            showKeyboard = true;
            break;
            
          case 'yint':
            html = createField('y-kesishish nuqtasi', 'y0', 'text', 'Masalan: 3, -2');
            showKeyboard = true;
            break;
            
          case 'vieta':
            html = createField('S = x₁ + x₂', 'S', 'text', 'Masalan: 5, -3.2') + 
                   createField('P = x₁ · x₂', 'P', 'text', 'Masalan: 6, 2.5');
            showKeyboard = true;
            break;
            
          case 'factor':
            const hint = question.answer.factorization 
              ? 'Masalan: (x - 2)(x + 3)' 
              : 'Bu tenglamani omillarga ajratib bo\'lmaydi';
            html = createField('Omillarga ajratish', 'factorization', 'text', hint);
            showKeyboard = true;
            break;
            
          case 'ineq':
            html = createField('Yechimlar sohasi', 'range', 'text', 'Masalan: (-∞, 2] ∪ [5, ∞)', 
              'Formatlar: (-∞, a), [b, ∞), (a, b), [a, b], ∅ (bo\'sh to\'plam)');
            showKeyboard = true;
            break;
            
          case 'g_roots':
            if ('count' in question.answer) {
              html = createField('Ildizlar soni', 'count', 'select', '0,1,2');
            } else {
              html = createField('x₁', 'x1', 'text', 'Grafikdan taxmin qiling', 'Taxminiy qiymat kiriting') + 
                     createField('x₂', 'x2', 'text', 'Grafikdan taxmin qiling', 'Taxminiy qiymat kiriting');
              showKeyboard = true;
            }
            break;
            
          case 'g_vertex':
            html = createField('h', 'h', 'text', 'Grafikdan o\'qing') + 
                   createField('k', 'k', 'text', 'Grafikdan o\'qing');
            showKeyboard = true;
            break;
            
          case 'g_axis':
            html = createField('Simmetriya o\'qi', 'axis', 'text', 'Masalan: x=2', 'x = [qiymat] ko\'rinishida yozing');
            showKeyboard = true;
            break;
            
          case 'g_range':
            html = createField('Qiymatlar sohasi', 'range', 'text', 'Masalan: [2, ∞), (-∞, 5]', 
              'Formatlar: [a, ∞), (-∞, b], [a, b]');
            showKeyboard = true;
            break;
            
          case 'g_to_eq':
            html = createField('a', 'A', 'text', 'Masalan: 1, -2, 0.5') + 
                   createField('h', 'h', 'text', 'Masalan: 2, -1') + 
                   createField('k', 'k', 'text', 'Masalan: 3, -4');
            showKeyboard = true;
            break;
        }
        
        DOM.answerArea.innerHTML = html;
        DOM.mathKeyboard.classList.toggle('hidden', !showKeyboard);
        
        // Yangi input elementlarini active input sifatida sozlash
        const inputs = DOM.answerArea.querySelectorAll('input');
        if (inputs.length > 0) {
          STATE.activeInput = inputs[0];
          inputs.forEach(input => {
            input.addEventListener('focus', () => {
              STATE.activeInput = input;
            });
          });
        }
      },
      
      // Savolni ko'rsatish
      renderQuestion() {
        const question = STATE.questions[STATE.currentQuestionIndex];
        
        // Savol raqami va statistikani yangilash
        DOM.currentQuestion.textContent = STATE.currentQuestionIndex + 1;
        DOM.totalQuestions.textContent = STATE.questions.length;
        DOM.correctAnswers.textContent = STATE.correctAnswers;
        DOM.currentScore.textContent = STATE.score;
        
        // Progress barni yangilash
        const progress = ((STATE.currentQuestionIndex) / STATE.questions.length) * 100;
        DOM.progressBar.style.width = `${progress}%`;
        
        // Savol matnini ko'rsatish
        DOM.questionText.innerHTML = question.text;
        
        // Grafikni ko'rsatish kerakmi?
        const showGraph = question.type.startsWith('g_');
        DOM.graphContainer.classList.toggle('hidden', !showGraph);
        
        if (showGraph) {
          this.drawGraph(question);
          this.updateGraphInstructions(question);
        }
        
        // Javob maydonini yaratish
        this.buildQuestionInterface(question);
        
        // Matematik klaviaturani yaratish
        this.createMathKeyboard();
        
        // Feedbackni yashirish
        DOM.feedback.classList.add('hidden');
        
        // MathJax ni yangilash
        if (window.MathJax && MathJax.typeset) {
          MathJax.typeset();
        }
      },
      
      // Grafik chizish
      drawGraph(question) {
        const canvas = DOM.graphCanvas;
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        
        // Canvasni tozalash
        ctx.clearRect(0, 0, width, height);
        
        // Fon va ko'rinish sozlamalari
        const scale = 40;
        const originX = width / 2;
        const originY = height / 2;
        
        // Ko'rinish chiziqlari
        ctx.strokeStyle = '#e0e0e0';
        ctx.lineWidth = 1;
        
        // Vertikal chiziqlar
        for (let x = originX % scale; x < width; x += scale) {
          ctx.beginPath();
          ctx.moveTo(x, 0);
          ctx.lineTo(x, height);
          ctx.stroke();
        }
        
        // Gorizontal chiziqlar
        for (let y = originY % scale; y < height; y += scale) {
          ctx.beginPath();
          ctx.moveTo(0, y);
          ctx.lineTo(width, y);
          ctx.stroke();
        }
        
        // Koordinata o'qlari
        ctx.strokeStyle = '#888';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0, originY);
        ctx.lineTo(width, originY);
        ctx.moveTo(originX, 0);
        ctx.lineTo(originX, height);
        ctx.stroke();
        
        // O'q belgilari
        ctx.fillStyle = '#888';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'top';
        
        // X o'qi belgilari
        for (let x = originX + scale; x < width; x += scale) {
          const value = (x - originX) / scale;
          if (value !== 0) {
            ctx.fillText(value, x, originY + 5);
          }
        }
        
        for (let x = originX - scale; x > 0; x -= scale) {
          const value = (x - originX) / scale;
          if (value !== 0) {
            ctx.fillText(value, x, originY + 5);
          }
        }
        
        // Y o'qi belgilari
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';
        
        for (let y = originY + scale; y < height; y += scale) {
          const value = (originY - y) / scale;
          if (value !== 0) {
            ctx.fillText(value, originX - 5, y);
          }
        }
        
        for (let y = originY - scale; y > 0; y -= scale) {
          const value = (originY - y) / scale;
          if (value !== 0) {
            ctx.fillText(value, originX - 5, y);
          }
        }
        
        // Parabolani chizish
        const graph = question.graph || question;
        ctx.strokeStyle = '#4361ee';
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        let firstPoint = true;
        for (let px = 0; px < width; px++) {
          const x = (px - originX) / scale;
          const y = graph.A * Math.pow(x - graph.h, 2) + graph.k;
          const py = originY - y * scale;
          
          if (firstPoint) {
            ctx.moveTo(px, py);
            firstPoint = false;
          } else {
            ctx.lineTo(px, py);
          }
        }
        
        ctx.stroke();
        
        // Uch nuqtasini belgilash
        const vertexX = originX + graph.h * scale;
        const vertexY = originY - graph.k * scale;
        
        ctx.fillStyle = '#f72585';
        ctx.beginPath();
        ctx.arc(vertexX, vertexY, 5, 0, Math.PI * 2);
        ctx.fill();
        
        // Agar ildizlar mavjud bo'lsa, ularni belgilash
        if (question.type === 'g_roots' && question.answer.x1 !== undefined) {
          const root1X = originX + question.answer.x1 * scale;
          const root2X = originX + question.answer.x2 * scale;
          const rootY = originY;
          
          ctx.fillStyle = '#4cc9f0';
          ctx.beginPath();
          ctx.arc(root1X, rootY, 5, 0, Math.PI * 2);
          ctx.fill();
          
          ctx.beginPath();
          ctx.arc(root2X, rootY, 5, 0, Math.PI * 2);
          ctx.fill();
          
          // Ildizlarni raqamlari
          ctx.fillStyle = '#4cc9f0';
          ctx.font = 'bold 14px Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'bottom';
          ctx.fillText('x₁', root1X, rootY - 8);
          ctx.fillText('x₂', root2X, rootY - 8);
        }
      },
      
      // Grafik ko'rsatmalarini yangilash
      updateGraphInstructions(question) {
        let instructions = '';
        
        switch (question.type) {
          case 'g_roots':
            instructions = 'Grafikdagi koʻk nuqtalar ildizlarni koʻrsatadi. ʻx₁ʼ va ʻx₂ʼ belgilariga qarang.';
            break;
          case 'g_vertex':
            instructions = 'Grafikdagi qizil nuqta parabolaning uchini koʻrsatadi.';
            break;
          case 'g_axis':
            instructions = 'Parabolaning simmetriya oʻqi uning uchidan oʻtadi.';
            break;
          case 'g_range':
            instructions = 'Parabolaning qiymatlar sohasi uning eng past yoki eng baland nuqtasiga bogʻliq.';
            break;
          case 'g_to_eq':
            instructions = 'Parabolaning shakli va joylashishiga qarab a, h, k parametrlarini aniqlang.';
            break;
          default:
            instructions = 'Grafikdagi nuqtalarni kuzatib, ildizlarni taxmin qiling.';
        }
        
        DOM.graphInstructions.textContent = instructions;
      },
      
      // Foydalanuvchi javobini olish
      getUserAnswer(question) {
        const getAnswerValue = (id) => {
          const element = document.getElementById(`answer_${id}`);
          return element ? element.value : null;
        };
        
        const parseAnswer = (value) => UTILS.parseNumber(value);
        
        let userAnswer = {};
        
        switch (question.type) {
          case 'disc':
            userAnswer.D = parseAnswer(getAnswerValue('D'));
            break;
            
          case 'count':
            userAnswer.count = parseInt(getAnswerValue('count'));
            break;
            
          case 'roots':
            if (question.answer.complex) {
              const answer1 = (getAnswerValue('x1') || '').toLowerCase();
              const answer2 = (getAnswerValue('x2') || '').toLowerCase();
              userAnswer.complex = answer1.includes('i') || answer2.includes('i') || 
                                 answer1.includes('kompleks') || answer2.includes('kompleks');
            } else {
              userAnswer.x1 = parseAnswer(getAnswerValue('x1'));
              userAnswer.x2 = parseAnswer(getAnswerValue('x2'));
            }
            break;
            
          case 'vertex':
            userAnswer.h = parseAnswer(getAnswerValue('h'));
            userAnswer.k = parseAnswer(getAnswerValue('k'));
            break;
            
          case 'axis':
            userAnswer.axis = parseAnswer(getAnswerValue('axis'));
            break;
            
          case 'yint':
            userAnswer.y0 = parseAnswer(getAnswerValue('y0'));
            break;
            
          case 'vieta':
            userAnswer.S = parseAnswer(getAnswerValue('S'));
            userAnswer.P = parseAnswer(getAnswerValue('P'));
            break;
            
          case 'factor':
            userAnswer.factorization = getAnswerValue('factorization');
            break;
            
          case 'ineq':
            userAnswer.range = getAnswerValue('range');
            break;
            
          case 'g_roots':
            if ('count' in question.answer) {
              userAnswer.count = parseInt(getAnswerValue('count'));
            } else {
              userAnswer.x1 = parseAnswer(getAnswerValue('x1'));
              userAnswer.x2 = parseAnswer(getAnswerValue('x2'));
            }
            break;
            
          case 'g_vertex':
            userAnswer.h = parseAnswer(getAnswerValue('h'));
            userAnswer.k = parseAnswer(getAnswerValue('k'));
            break;
            
          case 'g_axis':
            userAnswer.axis = parseAnswer(getAnswerValue('axis'));
            break;
            
          case 'g_range':
            userAnswer.range = getAnswerValue('range');
            break;
            
          case 'g_to_eq':
            userAnswer.A = parseAnswer(getAnswerValue('A'));
            userAnswer.h = parseAnswer(getAnswerValue('h'));
            userAnswer.k = parseAnswer(getAnswerValue('k'));
            break;
        }
        
        return userAnswer;
      },
      
      // Javobni tekshirish
      checkAnswer() {
        const question = STATE.questions[STATE.currentQuestionIndex];
        let isCorrect = false;
        let partialScore = 0;
        let message = '';
        
        // Foydalanuvchi javobini olish va saqlash
        const userAnswer = this.getUserAnswer(question);
        STATE.userAnswers[STATE.currentQuestionIndex] = userAnswer;
        
        const parseAnswer = (value) => UTILS.parseNumber(value);
        
        // Turli savol turlari uchun tekshirish
        switch (question.type) {
          case 'disc':
            const userD = userAnswer.D;
            isCorrect = UTILS.nearlyEqual(userD, question.answer.D);
            message = `To'g'ri javob: D = ${question.answer.D}`;
            break;
            
          case 'count':
            const userCount = userAnswer.count;
            isCorrect = userCount === question.answer.count;
            message = `Diskriminant: ${ALGEBRA.discriminant(question.a, question.b, question.c)} → ${question.answer.count} ta haqiqiy ildiz`;
            break;
            
          case 'roots':
            if (question.answer.complex) {
              isCorrect = userAnswer.complex === true;
              message = 'Diskriminant manfiy - haqiqiy ildizlar mavjud emas';
            } else {
              const x1 = userAnswer.x1;
              const x2 = userAnswer.x2;
              
              if (x1 === null || x2 === null) {
                isCorrect = false;
              } else {
                const userRoots = [x1, x2].sort((a, b) => a - b);
                const correctRoots = [question.answer.x1, question.answer.x2];
                
                isCorrect = UTILS.nearlyEqual(userRoots[0], correctRoots[0]) && 
                           UTILS.nearlyEqual(userRoots[1], correctRoots[1]);
                
                // Qisman ball
                partialScore = (
                  UTILS.nearlyEqual(userRoots[0], correctRoots[0]) ||
                  UTILS.nearlyEqual(userRoots[0], correctRoots[1]) ||
                  UTILS.nearlyEqual(userRoots[1], correctRoots[0]) ||
                  UTILS.nearlyEqual(userRoots[1], correctRoots[1])
                ) ? 1 : 0;
              }
              
              message = `To'g'ri javob: x₁ = ${question.answer.x1.toFixed(4)}, x₂ = ${question.answer.x2.toFixed(4)}`;
            }
            break;
            
          case 'vertex':
            const h = userAnswer.h;
            const k = userAnswer.k;
            isCorrect = h !== null && k !== null && 
                       UTILS.nearlyEqual(h, question.answer.h) && 
                       UTILS.nearlyEqual(k, question.answer.k);
            partialScore = (UTILS.nearlyEqual(h, question.answer.h) || UTILS.nearlyEqual(k, question.answer.k)) ? 1 : 0;
            message = `To'g'ri javob: (h, k) = (${question.answer.h.toFixed(4)}, ${question.answer.k.toFixed(4)})`;
            break;
            
          case 'axis':
            const axis = userAnswer.axis;
            isCorrect = UTILS.nearlyEqual(axis, question.answer.axis);
            message = `To'g'ri javob: x = ${question.answer.axis.toFixed(4)}`;
            break;
            
          case 'yint':
            const y0 = userAnswer.y0;
            isCorrect = UTILS.nearlyEqual(y0, question.answer.y0);
            message = `To'g'ri javob: y(0) = ${question.answer.y0}`;
            break;
            
          case 'vieta':
            const S = userAnswer.S;
            const P = userAnswer.P;
            isCorrect = S !== null && P !== null && 
                       UTILS.nearlyEqual(S, question.answer.S) && 
                       UTILS.nearlyEqual(P, question.answer.P);
            partialScore = (UTILS.nearlyEqual(S, question.answer.S) || UTILS.nearlyEqual(P, question.answer.P)) ? 1 : 0;
            message = `To'g'ri javob: S = ${question.answer.S.toFixed(4)}, P = ${question.answer.P.toFixed(4)}`;
            break;
            
          case 'factor':
            if (!question.answer.factorization) {
              isCorrect = false;
              message = 'Bu tenglamani chiroyli omillarga ajratib bo\'lmaydi';
            } else {
              const userAnswerText = (userAnswer.factorization || '').toLowerCase().replace(/\s+/g, '');
              const correctAnswer = question.answer.factorization.toLowerCase().replace(/\s+/g, '');
              isCorrect = userAnswerText.includes(correctAnswer) || correctAnswer.includes(userAnswerText);
              message = `To'g'ri javob: ${question.answer.factorization}`;
            }
            break;
            
          case 'ineq':
            const userRange = (userAnswer.range || '').replace(/\s+/g, '');
            const correctRange = question.answer.range.replace(/\s+/g, '');
            isCorrect = userRange === correctRange;
            message = `To'g'ri javob: ${question.answer.range}`;
            break;
            
          case 'g_roots':
            if ('count' in question.answer) {
              const userCount = userAnswer.count;
              isCorrect = userCount === question.answer.count;
              message = 'Grafik O\'x o\'qini kesmaydi - ildizlar yo\'q';
            } else {
              const x1 = userAnswer.x1;
              const x2 = userAnswer.x2;
              
              if (x1 === null || x2 === null) {
                isCorrect = false;
              } else {
                const userRoots = [x1, x2].sort((a, b) => a - b);
                const correctRoots = [question.answer.x1, question.answer.x2].sort((a, b) => a - b);
                
                // Grafik ildizlar uchun kengroq xatolik chegarasi
                isCorrect = UTILS.nearlyEqual(userRoots[0], correctRoots[0], 0.5) && 
                           UTILS.nearlyEqual(userRoots[1], correctRoots[1], 0.5);
                
                partialScore = (
                  UTILS.nearlyEqual(userRoots[0], correctRoots[0], 0.5) ||
                  UTILS.nearlyEqual(userRoots[1], correctRoots[1], 0.5)
                ) ? 1 : 0;
              }
              
              message = `To'g'ri javob: x₁ ≈ ${question.answer.x1.toFixed(2)}, x₂ ≈ ${question.answer.x2.toFixed(2)}`;
            }
            break;
            
          case 'g_vertex':
            const gh = userAnswer.h;
            const gk = userAnswer.k;
            // Grafik uchi uchun kengroq xatolik chegarasi
            isCorrect = UTILS.nearlyEqual(gh, question.answer.h, 0.3) && 
                       UTILS.nearlyEqual(gk, question.answer.k, 0.3);
            partialScore = (UTILS.nearlyEqual(gh, question.answer.h, 0.3) || UTILS.nearlyEqual(gk, question.answer.k, 0.3)) ? 1 : 0;
            message = `To'g'ri javob: (h, k) = (${question.answer.h}, ${question.answer.k})`;
            break;
            
          case 'g_axis':
            const gAxis = userAnswer.axis;
            isCorrect = UTILS.nearlyEqual(gAxis, question.answer.axis, 0.3);
            message = `To'g'ri javob: x = ${question.answer.axis}`;
            break;
            
          case 'g_range':
            const userGRange = (userAnswer.range || '').replace(/\s+/g, '');
            const correctGRange = question.answer.range.replace(/\s+/g, '');
            isCorrect = userGRange === correctGRange;
            message = `To'g'ri javob: ${question.answer.range}`;
            break;
            
          case 'g_to_eq':
            const gA = userAnswer.A;
            const gH = userAnswer.h;
            const gK = userAnswer.k;
            // Grafik tenglama uchun kengroq xatolik chegarasi
            isCorrect = UTILS.nearlyEqual(gA, question.answer.A, 0.3) && 
                       UTILS.nearlyEqual(gH, question.answer.h, 0.3) && 
                       UTILS.nearlyEqual(gK, question.answer.k, 0.3);
            partialScore = (
              UTILS.nearlyEqual(gA, question.answer.A, 0.3) ||
              UTILS.nearlyEqual(gH, question.answer.h, 0.3) ||
              UTILS.nearlyEqual(gK, question.answer.k, 0.3)
            ) ? 1 : 0;
            message = `To'g'ri javob: a = ${question.answer.A}, h = ${question.answer.h}, k = ${question.answer.k}`;
            break;
        }
        
        // Ballarni hisoblash
        const points = isCorrect ? 10 : (partialScore > 0 ? 5 : -2);
        STATE.score = Math.max(0, STATE.score + points);
        
        if (isCorrect) {
          STATE.correctAnswers++;
          STATE.subSkillsCorrect[question.type] = (STATE.subSkillsCorrect[question.type] || 0) + 1;
        } else {
          STATE.incorrectAnswers++;
        }
        
        // Feedback ko'rsatish
        DOM.feedback.classList.remove('hidden');
        DOM.feedback.className = `feedback ${isCorrect ? 'feedback-success' : 'feedback-error'}`;
        
        DOM.feedback.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas ${isCorrect ? 'fa-check-circle' : 'fa-times-circle'}" style="font-size: 20px;"></i>
            <div>
              <strong>${isCorrect ? 'To\'g\'ri!' : 'Xato.'}</strong> ${message}
            </div>
            <div class="badge ${isCorrect ? 'badge-success' : 'badge-warning'}" style="margin-left: auto;">
              ${points > 0 ? '+' : ''}${points} ball
            </div>
          </div>
        `;
        
        // Statistikani yangilash
        this.updateStats();
        
        // MathJax ni yangilash
        if (window.MathJax && MathJax.typeset) {
          MathJax.typeset();
        }
        
        return isCorrect;
      },
      
      // Statistikani yangilash
      updateStats() {
        DOM.correctAnswers.textContent = STATE.correctAnswers;
        DOM.currentScore.textContent = STATE.score;
      },
      
      // Keyingi savolga o'tish
      nextQuestion() {
        if (STATE.currentQuestionIndex < STATE.questions.length - 1) {
          STATE.currentQuestionIndex++;
          this.renderQuestion();
        } else {
          this.finishTest();
        }
      },
      
      // Testni yakunlash
      finishTest() {
        // Taymerni to'xtatish
        if (STATE.timer) {
          clearInterval(STATE.timer);
        }
        
        // Test panelini yashirish
        DOM.testPanel.classList.add('hidden');
        
        // Natijalarni hisoblash
        const timeSpent = Math.floor((UTILS.now() - STATE.startTime) / 1000);
        const totalQuestions = STATE.questions.length;
        const maxScore = totalQuestions * 10;
        const percentage = maxScore > 0 ? (STATE.score / maxScore) * 100 : 0;
        
        // Baholash
        let grade;
        if (percentage >= 90) grade = 'A (A\'lo)';
        else if (percentage >= 80) grade = 'B (Yaxshi)';
        else if (percentage >= 70) grade = 'C (Qoniqarli)';
        else if (percentage >= 60) grade = 'D (Qoniqarsiz)';
        else grade = 'F (Yiqildi)';
        
        // Natijalarni ko'rsatish
        DOM.finalScore.textContent = `${STATE.score} / ${maxScore}`;
        DOM.finalCorrect.textContent = `${STATE.correctAnswers} / ${totalQuestions}`;
        DOM.finalScoreBar.style.width = `${percentage}%`;
        DOM.correctBar.style.width = `${(STATE.correctAnswers / totalQuestions) * 100}%`;
        DOM.timeSpent.textContent = UTILS.formatTime(timeSpent);
        DOM.finalGrade.textContent = grade;
        
        // Ko'nikmalar tahlili
        this.renderSkillsAnalysis();
        
        // Savollar tahlili
        this.renderQuestionsAnalysis();
        
        // Tarixni yangilash
        this.saveToHistory(timeSpent, totalQuestions, maxScore, grade);
        this.renderHistory();
        
        // Natija panelini ko'rsatish
        DOM.resultsPanel.classList.remove('hidden');
      },
      
      // Ko'nikmalar tahlili
      renderSkillsAnalysis() {
        let html = '';
        
        for (const type of QUESTION_TYPES) {
          const total = STATE.subSkills[type] || 0;
          if (total === 0) continue;
          
          const correct = STATE.subSkillsCorrect[type] || 0;
          const percentage = Math.round((correct / total) * 100);
          
          const typeLabels = {
            disc: 'Diskriminant',
            vieta: 'Vieta formulalari',
            vertex: 'Parabola uchi',
            roots: 'Ildizlarni topish',
            count: 'Ildizlar soni',
            axis: 'Simmetriya o\'qi',
            yint: 'Y-kesishish nuqtasi',
            factor: 'Omillarga ajratish',
            ineq: 'Tengsizliklar',
            g_roots: 'Grafik: ildizlar',
            g_vertex: 'Grafik: uchi',
            g_axis: 'Grafik: o\'q',
            g_range: 'Grafik: qiymatlar sohasi',
            g_to_eq: 'Grafik: tenglama'
          };
          
          html += `
            <div class="skill-progress">
              <div class="skill-name">
                <span>${typeLabels[type] || type}</span>
                <span class="skill-value">${correct}/${total}</span>
              </div>
              <div class="progress-container">
                <div class="progress-bar" style="width: ${percentage}%"></div>
              </div>
            </div>
          `;
        }
        
        DOM.skillsAnalysis.innerHTML = html || '<p>Hech qanday ma\'lumot mavjud emas</p>';
      },
      
      // Savollar tahlili
      renderQuestionsAnalysis() {
        let html = '';
        
        for (let i = 0; i < STATE.questions.length; i++) {
          const question = STATE.questions[i];
          const userAnswer = STATE.userAnswers[i] || {};
          const isCorrect = this.isAnswerCorrect(question, userAnswer);
          
          const userAnswerText = UTILS.formatAnswer(userAnswer, question.type);
          const correctAnswerText = UTILS.formatAnswer(question.answer, question.type);
          
          html += `
            <div class="analysis-item">
              <div class="analysis-header">
                <div class="analysis-question">
                  <strong>${i + 1}.</strong> ${question.text}
                </div>
                <div class="analysis-status">
                  ${isCorrect ? 
                    '<span class="badge badge-success"><i class="fas fa-check"></i> To\'g\'ri</span>' : 
                    '<span class="badge badge-danger"><i class="fas fa-times"></i> Noto\'g\'ri</span>'
                  }
                </div>
              </div>
              <div class="analysis-body">
                <div class="analysis-answer">
                  <div class="analysis-label">Sizning javobingiz:</div>
                  <div class="analysis-value ${isCorrect ? 'analysis-correct' : 'analysis-incorrect'}">${userAnswerText}</div>
                </div>
                <div class="analysis-answer">
                  <div class="analysis-label">To'g'ri javob:</div>
                  <div class="analysis-value analysis-correct">${correctAnswerText}</div>
                </div>
              </div>
            </div>
          `;
        }
        
        DOM.questionsAnalysis.innerHTML = html;
        
        // MathJax ni yangilash
        if (window.MathJax && MathJax.typeset) {
          MathJax.typeset();
        }
      },
      
      // Javob to'g'ri yoki yo'qligini tekshirish
      isAnswerCorrect(question, userAnswer) {
        // Bu yerda checkAnswer funksiyasidagi tekshirish mantiqini qayta ishlatamiz
        // Ammo soddalik uchun, biz oddiygina tekshiramiz
        // Haqiqiy loyihada bu mantiqni alohida funksiyaga ajratish maqsadga muvofiq
        
        const parseAnswer = (value) => UTILS.parseNumber(value);
        
        switch (question.type) {
          case 'disc':
            return UTILS.nearlyEqual(userAnswer.D, question.answer.D);
            
          case 'count':
            return userAnswer.count === question.answer.count;
            
          case 'roots':
            if (question.answer.complex) {
              return userAnswer.complex === true;
            } else {
              const x1 = userAnswer.x1;
              const x2 = userAnswer.x2;
              
              if (x1 === null || x2 === null) return false;
              
              const userRoots = [x1, x2].sort((a, b) => a - b);
              const correctRoots = [question.answer.x1, question.answer.x2];
              
              return UTILS.nearlyEqual(userRoots[0], correctRoots[0]) && 
                     UTILS.nearlyEqual(userRoots[1], correctRoots[1]);
            }
            
          case 'vertex':
            const h = userAnswer.h;
            const k = userAnswer.k;
            return h !== null && k !== null && 
                   UTILS.nearlyEqual(h, question.answer.h) && 
                   UTILS.nearlyEqual(k, question.answer.k);
            
          case 'axis':
            return UTILS.nearlyEqual(userAnswer.axis, question.answer.axis);
            
          case 'yint':
            return UTILS.nearlyEqual(userAnswer.y0, question.answer.y0);
            
          case 'vieta':
            const S = userAnswer.S;
            const P = userAnswer.P;
            return S !== null && P !== null && 
                   UTILS.nearlyEqual(S, question.answer.S) && 
                   UTILS.nearlyEqual(P, question.answer.P);
            
          case 'factor':
            if (!question.answer.factorization) return false;
            const userAnswerText = (userAnswer.factorization || '').toLowerCase().replace(/\s+/g, '');
            const correctAnswer = question.answer.factorization.toLowerCase().replace(/\s+/g, '');
            return userAnswerText.includes(correctAnswer) || correctAnswer.includes(userAnswerText);
            
          case 'ineq':
            const userRange = (userAnswer.range || '').replace(/\s+/g, '');
            const correctRange = question.answer.range.replace(/\s+/g, '');
            return userRange === correctRange;
            
          case 'g_roots':
            if ('count' in question.answer) {
              return userAnswer.count === question.answer.count;
            } else {
              const x1 = userAnswer.x1;
              const x2 = userAnswer.x2;
              
              if (x1 === null || x2 === null) return false;
              
              const userRoots = [x1, x2].sort((a, b) => a - b);
              const correctRoots = [question.answer.x1, question.answer.x2];
              
              return UTILS.nearlyEqual(userRoots[0], correctRoots[0], 0.5) && 
                     UTILS.nearlyEqual(userRoots[1], correctRoots[1], 0.5);
            }
            
          case 'g_vertex':
            const gh = userAnswer.h;
            const gk = userAnswer.k;
            return UTILS.nearlyEqual(gh, question.answer.h, 0.3) && 
                   UTILS.nearlyEqual(gk, question.answer.k, 0.3);
            
          case 'g_axis':
            return UTILS.nearlyEqual(userAnswer.axis, question.answer.axis, 0.3);
            
          case 'g_range':
            const userGRange = (userAnswer.range || '').replace(/\s+/g, '');
            const correctGRange = question.answer.range.replace(/\s+/g, '');
            return userGRange === correctGRange;
            
          case 'g_to_eq':
            const gA = userAnswer.A;
            const gH = userAnswer.h;
            const gK = userAnswer.k;
            return UTILS.nearlyEqual(gA, question.answer.A, 0.3) && 
                   UTILS.nearlyEqual(gH, question.answer.h, 0.3) && 
                   UTILS.nearlyEqual(gK, question.answer.k, 0.3);
        }
        
        return false;
      },
      
      // Tarixga saqlash
      saveToHistory(timeSpent, totalQuestions, maxScore, grade) {
        const history = this.getHistory();
        const record = {
          date: new Date().toISOString(),
          config: STATE.config,
          score: STATE.score,
          maxScore,
          timeSpent,
          correct: STATE.correctAnswers,
          total: totalQuestions,
          grade,
          subSkills: STATE.subSkills,
          subSkillsCorrect: STATE.subSkillsCorrect
        };
        
        history.unshift(record);
        localStorage.setItem('mathpro-quadratic-history', JSON.stringify(history.slice(0, 50)));
      },
      
      // Tarixni o'qish
      getHistory() {
        try {
          return JSON.parse(localStorage.getItem('mathpro-quadratic-history') || '[]');
        } catch (e) {
          return [];
        }
      },
      
      // Tarixni ko'rsatish
      renderHistory() {
        const history = this.getHistory();
        let html = '';
        
        for (const record of history.slice(0, 10)) {
          const date = new Date(record.date).toLocaleDateString('uz-UZ');
          const time = UTILS.formatTime(record.timeSpent);
          const percentage = Math.round((record.score / record.maxScore) * 100);
          
          html += `
            <tr>
              <td>${date}</td>
              <td>${record.config.testType === 'exam' ? 'Imtihon' : record.config.testType === 'quick' ? 'Tezkor' : 'Maxsus'}</td>
              <td>${record.total}</td>
              <td>${record.score}/${record.maxScore} (${percentage}%)</td>
              <td>${time}</td>
              <td>${record.grade}</td>
            </tr>
          `;
        }
        
        DOM.historyTable.querySelector('tbody').innerHTML = html || '<tr><td colspan="6">Hech qanday ma\'lumot mavjud emas</td></tr>';
      }
    };

    // Test boshqaruvi
    const TEST_MANAGER = {
      // Testni boshlash
      startTest(isDemo = false) {
        STATE.config = UI.readConfig();
        STATE.isDemo = isDemo;
        
        // Tasodifiy son generatori
        const randomFn = UTILS.createRandomGenerator(STATE.config.seed);
        
        // Savollarni yaratish
        const questionCount = isDemo ? 1 : STATE.config.questionCount;
        STATE.questions = [];
        STATE.userAnswers = []; // Foydalanuvchi javoblarini tozalash
        
        for (let i = 0; i < questionCount; i++) {
          const question = QUESTION_GENERATOR.generateQuestion(STATE.config, randomFn);
          STATE.questions.push(question);
          
          // Ko'nikmalar statistikasini yaratish
          STATE.subSkills[question.type] = (STATE.subSkills[question.type] || 0) + 1;
          STATE.subSkillsCorrect[question.type] = STATE.subSkillsCorrect[question.type] || 0;
        }
        
        // Holatni qayta o'rnatish
        STATE.currentQuestionIndex = 0;
        STATE.correctAnswers = 0;
        STATE.incorrectAnswers = 0;
        STATE.score = 0;
        STATE.startTime = UTILS.now();
        STATE.timeLimit = STATE.config.timeLimit;
        STATE.activeInput = null;
        
        // Interfeysni sozlash
        DOM.configPanel.classList.add('hidden');
        DOM.resultsPanel.classList.add('hidden');
        DOM.testPanel.classList.remove('hidden');
        
        // Birinchi savolni ko'rsatish
        UI.renderQuestion();
        
        // Taymerni boshlash
        if (STATE.timeLimit > 0) {
          this.startTimer();
        } else {
          DOM.timeDisplay.textContent = '--:--';
        }
      },
      
      // Taymerni boshlash
      startTimer() {
        if (STATE.timer) {
          clearInterval(STATE.timer);
        }
        
        STATE.timer = setInterval(() => {
          const elapsed = Math.floor((UTILS.now() - STATE.startTime) / 1000);
          const remaining = Math.max(0, STATE.timeLimit - elapsed);
          
          DOM.timeDisplay.textContent = UTILS.formatTime(remaining);
          
          // Vaqt qolganligiga qarab rang o'zgartirish
          if (remaining <= 300) { // 5 daqiqa
            DOM.timer.classList.add('timer-warning');
            DOM.timer.classList.remove('timer-danger');
          }
          
          if (remaining <= 60) { // 1 daqiqa
            DOM.timer.classList.remove('timer-warning');
            DOM.timer.classList.add('timer-danger');
          }
          
          // Vaqt tugashi
          if (remaining <= 0) {
            clearInterval(STATE.timer);
            UI.finishTest();
          }
        }, 1000);
      },
      
      // Demo test
      startDemo() {
        this.startTest(true);
      }
    };

    // Dasturni ishga tushirish
    function init() {
      // Tema sozlamalari
      const savedTheme = localStorage.getItem('mathpro-theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      DOM.themeToggle.innerHTML = savedTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
      
      // Test turi o'zgarishi
      DOM.testType.addEventListener('change', function() {
        DOM.customCountGroup.classList.toggle('hidden', this.value !== 'custom');
      });
      
      // Ustoz rejimi
      DOM.teacherMode.addEventListener('change', function() {
        DOM.seedGroup.classList.toggle('hidden', !this.checked);
        DOM.modeIndicator.innerHTML = `
          <i class="fas fa-user-graduate"></i> Ustoz rejimi: ${this.checked ? 'Yoqilgan' : 'O\'chiq'}
        `;
      });
      
      // Tugmalar
      DOM.startBtn.addEventListener('click', () => TEST_MANAGER.startTest(false));
      DOM.demoBtn.addEventListener('click', () => TEST_MANAGER.startDemo());
      DOM.checkBtn.addEventListener('click', () => {
        UI.checkAnswer();
        setTimeout(() => UI.nextQuestion(), 2000);
      });
      DOM.skipBtn.addEventListener('click', () => {
        STATE.score = Math.max(0, STATE.score - 2);
        STATE.incorrectAnswers++;
        UI.updateStats();
        UI.nextQuestion();
      });
      DOM.restartBtn.addEventListener('click', () => {
        DOM.resultsPanel.classList.add('hidden');
        DOM.configPanel.classList.remove('hidden');
      });
      
      // Tema almashinuvi
      DOM.themeToggle.addEventListener('click', function() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        
        document.documentElement.setAttribute('data-theme', newTheme);
        this.innerHTML = newTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        localStorage.setItem('mathpro-theme', newTheme);
      });
      
      // Klaviatura tugmalari
      document.addEventListener('keydown', function(e) {
        if (!DOM.testPanel.classList.contains('hidden')) {
          if (e.key === 'Enter') {
            DOM.checkBtn.click();
          } else if (e.key === 'ArrowRight') {
            UI.nextQuestion();
          }
        }
      });
      
      // Eksport tugmalari
      DOM.exportJson.addEventListener('click', function() {
        const history = UI.getHistory();
        const dataStr = JSON.stringify(history, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const exportFileDefaultName = 'mathpro-history.json';
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
      });
      
      DOM.exportCsv.addEventListener('click', function() {
        const history = UI.getHistory();
        const headers = ['Sana', 'Test turi', 'Savollar', 'Ball', 'Vaqt', 'Baholash'];
        const rows = history.map(record => [
          new Date(record.date).toLocaleDateString('uz-UZ'),
          record.config.testType === 'exam' ? 'Imtihon' : record.config.testType === 'quick' ? 'Tezkor' : 'Maxsus',
          record.total,
          `${record.score}/${record.maxScore}`,
          UTILS.formatTime(record.timeSpent),
          record.grade
        ]);
        
        let csvContent = headers.join(',') + '\n';
        csvContent += rows.map(row => row.join(',')).join('\n');
        
        const encodedUri = encodeURI('data:text/csv;charset=utf-8,' + csvContent);
        const link = document.createElement('a');
        link.setAttribute('href', encodedUri);
        link.setAttribute('download', 'mathpro-history.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
      
      // Dastur yuklanganida tarixni ko'rsatish
      UI.renderHistory();
    }

    // Dasturni ishga tushirish
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>