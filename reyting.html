<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1,viewport-fit=cover"/>
  <title>LeaderMath ‚Äî Global Reyting (TOP-100 + Rank)</title>
  <meta name="theme-color" content="#2E8B57"/>

  <style>
    :root{
      --brand:#2E8B57; --brand2:#1F6B45;
      --bg:#F6FAF7; --card:#FFFFFF; --card2:#F9FCFA;
      --text:#0f1b15; --muted:#5f7469; --line:#E3EBE6;
      --ring:#9dd8ba; --shadow:0 26px 70px rgba(18,40,28,.12), 0 6px 18px rgba(18,40,28,.06);
      --wrap: clamp(1100px, 96vw, 1400px);
      --radius:18px; --radius-lg:22px;
    }
    body{margin:0;background:linear-gradient(180deg,var(--bg),#ECF4EF);color:var(--text);
      font:16px/1.55 system-ui,Segoe UI,Inter,Arial}
    header{position:sticky;top:0;background:linear-gradient(180deg, color-mix(in srgb, var(--card) 86%, transparent), transparent);
      border-bottom:1px solid color-mix(in srgb,var(--line) 70%, transparent); backdrop-filter:saturate(1.06) blur(10px); z-index:10}
    .row{max-width:var(--wrap);margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:12px;font-weight:900}
    .brand .logo{width:46px;height:46px;border-radius:14px;overflow:hidden;display:grid;place-items:center;background:#fff;box-shadow:0 10px 30px rgba(46,139,87,.22)}
    .brand img{width:38px;height:38px}
    .grow{flex:1}

    main{max-width:var(--wrap);margin:18px auto;padding:0 16px 64px;display:grid;gap:16px}

    /* Top cards */
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--line);
      border-radius:var(--radius-lg);box-shadow:var(--shadow);overflow:hidden}
    .card-h{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
    .card-h h2{margin:0;font-size:18px}
    .card-b{padding:14px 16px}

    /* Controls */
    .ctrls{display:flex;gap:10px;flex-wrap:wrap}
    .fld{display:flex;align-items:center;gap:8px;border:1px solid var(--line);border-radius:12px;background:#fff;padding:8px 10px}
    .fld input{border:0;outline:0}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 14px;font-weight:900;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#7fd1a5,var(--brand));color:#fff;border-color:transparent}

    /* Table */
    .tbl{width:100%;border-collapse:separate;border-spacing:0 10px}
    .tbl thead th{font-size:12px;color:var(--muted);text-align:left;padding:0 10px}
    .rowx{display:grid;grid-template-columns: 80px 1fr 160px; align-items:center; gap:10px;
      background:linear-gradient(180deg,#fff,#FAFDFC); border:1px solid var(--line); border-radius:14px; padding:10px}
    .rankpill{min-width:54px;justify-self:center;text-align:center;font-weight:900;border:1px solid var(--line);
      border-radius:999px;padding:6px 10px;background:#fff}
    .me{outline:2px solid var(--ring);box-shadow:0 0 0 6px color-mix(in srgb,var(--ring) 30%, transparent) inset}
    .name{display:flex;align-items:center;gap:10px}
    .av{width:36px;height:36px;border-radius:50%;overflow:hidden;border:1px solid var(--line);background:#fff}
    .pts{font-weight:900;justify-self:end}

    /* My rank card */
    .myrank{display:grid;gap:10px}
    .stat{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);
      background:linear-gradient(180deg,#fff,#F9FCFA);padding:12px;border-radius:14px}
    .big{font-size:26px;font-weight:900;color:var(--brand)}
    .muted{color:var(--muted)}
    .mini{font-size:12px;color:var(--muted)}

    /* Footer info */
    .foot{display:flex;align-items:center;gap:10px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <div class="brand">
        <div class="logo"><img src="/logo.png" alt="LM"></div>
        <div><div>LeaderMath.<span style="color:var(--brand)">UZ</span></div><small class="mini">Global Reyting</small></div>
      </div>
      <div class="grow"></div>
      <a class="btn" href="/index.html">‚Üê Bosh sahifa</a>
    </div>
  </header>

  <main>
    <div class="grid">
      <!-- LEFT: Leaderboard -->
      <div class="card" id="lbCard">
        <div class="card-h">
          <h2>TOP-100 Reyting (ball bo‚Äòyicha)</h2>
          <div class="ctrls">
            <label class="fld"><span>üîé</span><input id="q" placeholder="Ism / email bo‚Äòyicha filter"/></label>
            <button id="refresh" class="btn">Yangilash</button>
          </div>
        </div>
        <div class="card-b">
          <div id="list" role="list" aria-live="polite" aria-busy="true"></div>
          <div class="foot" id="lbFoot" style="margin-top:10px;display:none">‚è±Ô∏è Live: Firestore‚Äôdan real-vaqt yangilanadi.</div>
        </div>
      </div>

      <!-- RIGHT: My rank -->
      <div class="card">
        <div class="card-h"><h2>Mening o‚Äòrnim</h2></div>
        <div class="card-b myrank" id="myRankBox">
          <div class="stat">
            <div>
              <div class="mini">Umumiy joylashuv</div>
              <div class="big" id="myRank">‚Äî</div>
            </div>
            <div>
              <div class="mini">Mening ballim</div>
              <div class="big" id="myPts">‚Äî</div>
            </div>
          </div>

          <div class="stat">
            <div>
              <div class="mini">Mendan balandroq</div>
              <div class="big" id="aboveCnt">‚Äî</div>
            </div>
            <div>
              <div class="mini">Taxminiy umumiy foydalanuvchilar</div>
              <div class="big" id="totalApprox">‚Äî</div>
            </div>
          </div>

          <div>
            <div class="mini" style="margin-bottom:6px">Atrofimdagi foydalanuvchilar</div>
            <div id="neighbors" class="myneighbors" style="display:grid;gap:8px"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Firebase (v10) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import {
      getFirestore, collection, query, orderBy, limit, onSnapshot, getDoc, doc,
      where, getCountFromServer, startAfter, endBefore, limitToLast
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Helpers
    const $ = (s,r=document)=>r.querySelector(s);
    const listHost = $('#list');
    const footInfo = $('#lbFoot');
    const qInput = $('#q');

    let CURRENT_UID = null;
    let MY_POINTS = 0;
    let MY_PROFILE = null; // optional: agar kerak bo‚Äòlsa profiles dan o‚Äòqib kengaytirish mumkin

    // Render ONE row
    function rowEl({rank, uid, name, email, avatar, points, isMe=false}){
      const el = document.createElement('div');
      el.className = 'rowx' + (isMe?' me':'');
      el.setAttribute('role','listitem');
      el.innerHTML = `
        <div class="rankpill">#${rank}</div>
        <div class="name">
          <div class="av">${avatar?`<img src="${avatar}" style="width:100%;height:100%;object-fit:cover">`:''}</div>
          <div style="line-height:1.1">
            <b>${name||'Foydalanuvchi'}</b>
            <div class="mini">${email||''}</div>
          </div>
        </div>
        <div class="pts">${points ?? 0} pts</div>
      `;
      return el;
    }

    // Compute competition rank numbers inside an ordered array
    function applyRanks(rows){
      let prevPts = null, prevRank = 0;
      rows.forEach((r,i)=>{
        if(prevPts===null){ r.rank = 1; prevPts = r.points; prevRank = 1; }
        else if(r.points === prevPts){ r.rank = prevRank; }
        else { r.rank = i+1; prevRank = r.rank; prevPts = r.points; }
      });
      return rows;
    }

    // Load TOP-100 live and render (with text filter)
    let unsubscribeTop = null;
    function watchTop(){
      unsubscribeTop?.();
      const qTop = query(collection(db,'users'), orderBy('points','desc'), limit(100));
      unsubscribeTop = onSnapshot(qTop, async (snap)=>{
        const rows = [];
        snap.forEach(d=>{
          const u = d.data()||{};
          rows.push({
            uid: d.id,
            name: u.name || u.displayName || u.email || 'Foydalanuvchi',
            email: u.email || '',
            avatar: u.avatarUrl || '',
            points: Number(u.points)||0
          });
        });
        // sort fallback (safety)
        rows.sort((a,b)=> (b.points||0)-(a.points||0));
        applyRanks(rows);
        renderList(rows);
        footInfo.style.display='flex';
      }, (err)=>{ console.warn('onSnapshot error', err); });
    }

    function renderList(rows){
      const term = (qInput.value||'').trim().toLowerCase();
      listHost.innerHTML = '';
      (term ? rows.filter(r=>{
        return (r.name||'').toLowerCase().includes(term) || (r.email||'').toLowerCase().includes(term);
      }) : rows).forEach(r=>{
        const isMe = (r.uid===CURRENT_UID);
        listHost.appendChild(rowEl({...r, isMe}));
      });
      listHost.setAttribute('aria-busy','false');
    }

    // Compute my absolute rank using count(points > MY_POINTS) + 1
    async function computeMyRank(uid){
      if(!uid) return;
      // get my points
      const meDoc = await getDoc(doc(db,'users', uid));
      const me = meDoc.exists()? meDoc.data(): {};
      MY_POINTS = Number(me.points)||0;

      // rank = 1 + count(points > myPoints)
      const cntSnap = await getCountFromServer(query(collection(db,'users'), where('points','>', MY_POINTS)));
      const above = cntSnap.data().count || 0;
      const myRank = above + 1;

      $('#myPts').textContent = MY_POINTS.toString();
      $('#myRank').textContent = '#'+ myRank;
      $('#aboveCnt').textContent = above.toString();

      // Approx total
      const totalSnap = await getCountFromServer(collection(db,'users'));
      const total = totalSnap.data().count || myRank; // safety
      $('#totalApprox').textContent = total.toString();

      // Neighbors (around me): top-side and bottom-side small windows, then merge & sort
      try{
        const neighBox = $('#neighbors');
        neighBox.innerHTML = '';
        // Upper 3 (<= my points, desc)
        // NOTE: Firestore requires composite order. This is a simple single-field orderBy.
        const upperQ = query(collection(db,'users'), where('points','>=', MY_POINTS), orderBy('points','desc'), limit(3));
        const lowerQ = query(collection(db,'users'), where('points','<=', MY_POINTS), orderBy('points','asc'), limit(3));
        const [upSnap, loSnap] = await Promise.all([ (await import("https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js")).getDocs?.(upperQ) ?? null,
                                                     (await import("https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js")).getDocs?.(lowerQ) ?? null ]);
        const items = [];
        if(upSnap) upSnap.forEach(d=> items.push({uid:d.id, ...(d.data()||{})}));
        if(loSnap) loSnap.forEach(d=> items.push({uid:d.id, ...(d.data()||{})}));
        // unique + sort by points desc
        const map = new Map();
        items.forEach(u=> map.set(u.uid, u));
        const merged = [...map.values()].map(u=>({
          uid:u.uid,
          name:u.name||u.displayName||u.email||'Foydalanuvchi',
          email:u.email||'',
          avatar:u.avatarUrl||'',
          points:Number(u.points)||0
        })).sort((a,b)=>b.points-a.points);
        // Draw (max 5)
        merged.slice(0,5).forEach(u=>{
          const isMe = (u.uid===uid);
          neighBox.appendChild(rowEl({rank:'', uid:u.uid, name:u.name, email:u.email, avatar:u.avatar, points:u.points, isMe}));
        });
      }catch(e){ /* neighbors optional */ }
    }

    // Events
    $('#refresh').onclick = ()=>watchTop();
    qInput.addEventListener('input', ()=> {
      // Re-render with current cached DOM list (we keep last snapshot in memory if needed).
      // For simplicity, trigger watchTop() once and filter client-side:
      // Here we simply refire render from last rendered nodes.
      const rows = [...listHost.children].map(el=>{
        return {
          rank: Number(el.querySelector('.rankpill')?.textContent?.replace('#','')||0),
          name: el.querySelector('.name b')?.textContent || '',
          email: el.querySelector('.name .mini')?.textContent || '',
          points: Number((el.querySelector('.pts')?.textContent || '0').replace(/[^\d]/g,'')),
          uid: el._uid
        };
      }); // this fallback won‚Äôt have uid; better to re-pull. Simpler: just re-run watchTop.
      watchTop(); // cheap and safe for live filtering
    });

    onAuthStateChanged(auth, async (u)=>{
      if(!u){
        // oddiy Google login prompt
        const ok = confirm("Reytingni ko‚Äòrish uchun kirish kerak. Google bilan kirasizmi?");
        if(ok){
          try{ await signInWithPopup(auth, new GoogleAuthProvider()); }
          catch(e){ alert(e?.message||e); }
        }
        return;
      }
      CURRENT_UID = u.uid;
      watchTop();
      computeMyRank(u.uid);
    });
  </script>
</body>
</html>
