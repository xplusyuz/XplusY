<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <title>Namangan shahar 1-IMI — Portal</title>

  <!-- LOGO / FAVICON -->
  <link rel="icon" href="logo.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="logo.png" />
  <meta name="theme-color" content="#e0f2fe">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    :root{
      --brand:#0ea5e9;
      --bg:#f1f5f9;
      --text:#0f172a;
      --muted:#6b7280;
      --shell-radius:22px;
      --card-radius:20px;
      --shadow:0 10px 24px rgba(15,23,42,.12);
      --border:#e5e7eb;
    }

    *{margin:0;padding:0;box-sizing:border-box;}
    html,body{min-height:100%;}
    body{
      font-family:system-ui,-apple-system,'Segoe UI',Roboto,Arial;
      background:linear-gradient(180deg,#e0f2fe,#f9fafb);
      color:var(--text);
      -webkit-tap-highlight-color:transparent;
      display:flex; justify-content:center;
    }
    body.no-scroll{overflow:hidden;}

    .app{
      width:100%;
      max-width:960px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:100vh;
    }

    /* HEADER */
    header{
      top:8px; z-index:10;
    }
    .header-card{
      display:flex; align-items:center;
      gap:12px;
      padding:10px 14px;
      background:white;
      border-radius:var(--shell-radius);
      border:1px solid #dbeafe;
      box-shadow:var(--shadow);
    }
    .logo-img{
      width:52px; height:52px;
      border-radius:50%;
      object-fit:cover;
      box-shadow:0 4px 12px rgba(15,23,42,.22);
      flex-shrink:0;
    }
    .header-text{display:flex;flex-direction:column;gap:2px;}
    .header-title{font-size:14px;font-weight:700;}
    .header-sub{font-size:12px;color:var(--muted);}
    .header-tag{
      margin-left:auto;
      padding:4px 8px;
      font-size:11px;
      border-radius:999px;
      background:#eff6ff;
      border:1px solid #bfdbfe;
      display:flex; align-items:center; gap:6px;
      color:#2563eb;
      white-space:nowrap;
      cursor:pointer;
    }
    .header-tag i{font-size:11px;}

    main{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .section-shell{
      background:white;
      border-radius:var(--shell-radius);
      border:1px solid #e2e8f0;
      box-shadow:var(--shadow);
      padding:14px 12px 16px;
    }
    .section-header{
      margin-bottom:8px;
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .section-title-wrap{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .section-title{
      font-size:16px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .section-title i{color:var(--brand);}
    .section-sub{
      font-size:12px;
      color:var(--muted);
    }
    .section-chip{
      font-size:10px;
      padding:4px 8px;
      border-radius:999px;
      background:#eff6ff;
      border:1px dashed #bfdbfe;
      color:#1d4ed8;
      white-space:nowrap;
    }

    .card-list{
      display:grid;
      gap:14px;
    }
    @media(min-width:680px){
      .card-list{grid-template-columns:1fr 1fr;}
    }
    @media(min-width:900px){
      .card-list{grid-template-columns:1fr 1fr 1fr;}
    }

    .card{
      background:white;
      border-radius:var(--card-radius);
      border:1px solid var(--border);
      box-shadow:0 6px 14px rgba(15,23,42,.06);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      transition:.2s;
    }
    .card:hover{
      transform:translateY(-2px);
      box-shadow:0 10px 22px rgba(15,23,42,.16);
      border-color:#bfdbfe;
    }

    .card-img-wrap{
      position:relative;
      padding-top:58%;
      background:#e5e7eb;
    }
    .card-img-wrap img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .card-label{
      position:absolute;
      left:10px;
      top:10px;
      padding:4px 8px;
      border-radius:999px;
      font-size:10px;
      background:rgba(15,23,42,.7);
      color:#e5e7eb;
      display:flex;
      align-items:center;
      gap:5px;
    }
    .card-label i{font-size:10px;color:#38bdf8;}

    .card-body{
      padding:10px 11px 11px;
      display:flex;
      flex-direction:column;
      gap:6px;
      flex:1;
    }
    .card-title{font-size:13px;font-weight:600;}
    .card-desc{font-size:11px;color:var(--muted);}

    .card-meta-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-top:2px;
    }
    .card-meta-left{
      font-size:10px;
      color:#9ca3af;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .dot{
      width:4px;height:4px;border-radius:50%;background:#0ea5e9;
    }
    .card-tag-mini{
      font-size:10px;
      padding:4px 8px;
      border-radius:999px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      color:#6b7280;
      white-space:nowrap;
    }

    .card-footer{
      margin-top:6px;
      display:flex;
      gap:8px;
    }
    .btn{
      border:none;
      outline:none;
      border-radius:999px;
      padding:9px 10px;
      font-size:11px;
      font-weight:600;
      cursor:pointer;
      flex:1;
      background:linear-gradient(135deg,#0ea5e9,#38bdf8);
      color:white;
      box-shadow:0 8px 20px rgba(56,189,248,.45);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      transition:.18s;
    }
    .btn i{font-size:11px;}
    .btn:active{
      transform:scale(.97);
      box-shadow:0 4px 12px rgba(56,189,248,.65);
    }

    /* FOOTER */
    footer{margin-top:4px;}
    .footer-card{
      background:white;
      border-radius:var(--shell-radius);
      border:1px solid #e2e8f0;
      box-shadow:var(--shadow);
      padding:8px 10px 10px;
      font-size:10px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .footer-left{display:flex;flex-direction:column;gap:2px;}
    .footer-name{
      font-size:10px;
      font-weight:600;
      color:#0ea5e9;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .footer-right{
      display:flex;
      flex-wrap:wrap;
      gap:5px;
      justify-content:flex-end;
    }
    .footer-link{
      font-size:10px;
      padding:4px 8px;
      border-radius:999px;
      border:1px dashed #bfdbfe;
      background:#eff6ff;
      color:#1d4ed8;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:5px;
    }
    .footer-link i{font-size:10px;}

    /* FULLSCREEN MODAL (sahifalar uchun) */
    #page-modal{
      position:fixed;
      inset:0;
      z-index:999;
      display:none;
      justify-content:center;
      align-items:stretch;
      background:rgba(15,23,42,.18);
      backdrop-filter:blur(10px);
    }
    #page-modal.open{display:flex;}
    .modal-inner{
      flex:1;
      max-width:960px;
      padding:8px;
      position:relative;
      display:flex;
      flex-direction:column;
    }
    .modal-frame{
      width:100%;
      height:100%;
      border-radius:20px;
      border:1px solid #bfdbfe;
      background:white;
      box-shadow:0 18px 40px rgba(15,23,42,.35);
    }
    .close-btn{
      position:absolute;
      top:14px;
      right:14px;
      width:32px;
      height:32px;
      border-radius:50%;
      border:1px solid #e5e7eb;
      background:white;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow:0 4px 10px rgba(15,23,42,.25);
    }

    /* PROFILE OVERLAY */
    .profile-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.6);
      backdrop-filter:blur(12px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1900;
    }
    .profile-overlay.open{
      display:flex;
    }
    .profile-dialog{
      width:100%;
      max-width:720px;
      max-height:90vh;
      background:#f9fafb;
      border-radius:20px;
      padding:14px 14px 12px;
      box-shadow:0 18px 40px rgba(15,23,42,.4);
      border:1px solid #e5e7eb;
      display:flex;
      flex-direction:column;
    }
    .profile-header{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
      margin-bottom:8px;
    }
    .profile-title{
      font-size:16px;
      font-weight:700;
      color:#0f172a;
    }
    .profile-sub{
      font-size:12px;
      color:#6b7280;
      margin-top:2px;
    }
    .profile-close{
      border:none;
      background:white;
      width:30px;
      height:30px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      box-shadow:0 4px 10px rgba(15,23,42,.25);
      border:1px solid #e5e7eb;
    }
    .profile-body{
      flex:1;
      overflow:auto;
      padding:4px 0 0;
    }

    .profile-view{
      margin-bottom:10px;
      padding:8px 9px;
      border-radius:14px;
      background:#eff6ff;
      border:1px solid #bfdbfe;
    }
    .profile-summary-main{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-bottom:6px;
    }
    .profile-name{
      font-size:15px;
      font-weight:700;
      color:#0f172a;
    }
    .profile-summary-meta{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .chip{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      background:white;
      border:1px solid #bfdbfe;
      color:#1d4ed8;
    }
    .profile-summary-grid{
      display:flex;
      flex-direction:column;
      gap:3px;
      font-size:12px;
    }
    .summary-row{
      display:flex;
      justify-content:space-between;
      gap:8px;
    }
    .summary-row span{
      color:#6b7280;
    }

    .profile-form{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .profile-grid{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    @media(min-width:640px){
      .profile-grid{
        flex-direction:row;
      }
    }
    .profile-field{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:3px;
      font-size:11px;
      color:#4b5563;
    }
    .profile-field label{
      font-weight:600;
    }
    .profile-field input,
    .profile-field select{
      padding:7px 8px;
      border-radius:10px;
      border:1px solid #d4d4d8;
      font-size:12px;
      outline:none;
      background:white;
    }
    .profile-field input:focus,
    .profile-field select:focus{
      border-color:#0ea5e9;
      box-shadow:0 0 0 1px #0ea5e9;
    }
    .profile-points-row{
      margin-top:4px;
      padding:8px 9px;
      border-radius:14px;
      background:#eff6ff;
      border:1px solid #bfdbfe;
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
      font-size:12px;
    }
    .profile-points-label{
      font-weight:600;
      color:#1f2937;
    }
    .profile-points-value span{
      font-weight:700;
      color:#1d4ed8;
      font-size:14px;
      margin-right:3px;
    }
    .profile-rank-badge{
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background:white;
      border:1px solid #bfdbfe;
      color:#1d4ed8;
      white-space:nowrap;
    }
    .profile-actions{
      margin-top:8px;
      display:flex;
      justify-content:flex-end;
      flex-wrap:wrap;
      gap:8px;
    }
    .profile-btn-primary,
    .profile-btn-secondary{
      border:none;
      border-radius:999px;
      padding:8px 14px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .profile-btn-primary{
      background:linear-gradient(135deg,#0ea5e9,#38bdf8);
      color:white;
      box-shadow:0 8px 18px rgba(56,189,248,.55);
    }
    .profile-btn-secondary{
      background:white;
      border:1px solid #d4d4d8;
      color:#4b5563;
    }

    #btn-install-pwa{
      display:none; /* beforeinstallprompt bo'lganda ko'rinadi */
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>

  <!-- Config + Auth-lite -->
  <script src="./firebase-config.js"></script>
  <script src="./auth-lite.js"></script>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <header>
    <div class="header-card">
      <img src="logo.png" alt="Namangan shahar 1-IMI" class="logo-img">
      <div class="header-text">
        <div class="header-title">Namangan shahar 1-IMI</div>
        <div class="header-sub">Ta'lim Sari Birinchi Qadam</div>
      </div>
      <!-- PROFIL TUGMASI -->
      <div class="header-tag" id="btn-profile">
        <i class="fa-solid fa-user-circle"></i>
        Profil
      </div>
    </div>
  </header>

  <main>
    <!-- ASOSIY BO'LIMLAR -->
    <!-- (shu yerda siz bergan barcha cardlar o'zgarmagan holda turadi) -->
    <!-- Talabalar, jadval, imtihonlar, ... kodini o'zgartirmadim, faqat qisqartirish uchun
         bu javobda takror yozmayapman. O'zingiz oldingi indexdan copy qilib qo'yasiz. -->
    <!-- !!! Agar xohlasangiz, xuddi boshidagi katta index'ni shu yerga qo'yib qo'ying. -->
    <!-- ... bu yerga card'lar ... -->
  </main>

  <!-- FOOTER (siz bergan footer kodingizni ham shu yerga qo'ying) -->

</div>

<!-- FULLSCREEN MODAL (iframe) -->
<div id="page-modal">
  <div class="modal-inner">
    <button class="close-btn" id="modal-close">
      <i class="fa-solid fa-xmark"></i>
    </button>
    <iframe class="modal-frame" id="modal-frame" src=""></iframe>
  </div>
</div>

<!-- PROFILE MODAL -->
<div id="profile-overlay" class="profile-overlay">
  <div class="profile-dialog">
    <div class="profile-header">
      <div>
        <div class="profile-title">Profil ma’lumotlari</div>
        <div class="profile-sub">
          Ism familiya, tug‘ilgan sana va yashash joyingizni bir marta kiriting. Keyin profil oynasidan ko‘rib va tahrirlab borishingiz mumkin.
        </div>
      </div>
      <button type="button" class="profile-close" id="profile-close-btn">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <div class="profile-body">
      <!-- VIEW -->
      <div id="profile-view" class="profile-view">
        <div class="profile-summary-main">
          <div class="profile-name" id="pv-fullname">Foydalanuvchi</div>
          <div class="profile-summary-meta">
            <span class="chip" id="pv-id">ID: —</span>
            <span class="chip" id="pv-age">Yoshi: —</span>
            <span class="chip" id="pv-points">0 ball</span>
          </div>
        </div>
        <div class="profile-summary-grid">
          <div class="summary-row">
            <span>Viloyat:</span>
            <strong id="pv-region">—</strong>
          </div>
          <div class="summary-row">
            <span>Tuman / shahar:</span>
            <strong id="pv-district">—</strong>
          </div>
          <div class="summary-row">
            <span>Tug‘ilgan sana:</span>
            <strong id="pv-birthdate">—</strong>
          </div>
          <div class="summary-row">
            <span>Daraja:</span>
            <strong id="pv-rank">Yangi foydalanuvchi</strong>
          </div>
        </div>
      </div>

      <!-- EDIT FORM -->
      <form id="profile-form" class="profile-form">
        <div class="profile-grid">
          <div class="profile-field">
            <label>Ism familiya</label>
            <input type="text" id="pf-fullname" placeholder="Familiya Ism Sharif" autocomplete="name" required>
          </div>
        </div>

        <div class="profile-grid">
          <div class="profile-field">
            <label>Tug‘ilgan sana</label>
            <input type="date" id="pf-birthdate" required>
          </div>
        </div>

        <div class="profile-grid">
          <div class="profile-field">
            <label>Viloyat</label>
            <select id="pf-region" required>
              <option value="">Tanlang</option>
            </select>
          </div>
          <div class="profile-field">
            <label>Tuman / shahar</label>
            <select id="pf-district" disabled required>
              <option value="">Avval viloyatni tanlang</option>
            </select>
          </div>
        </div>

        <!-- Parol o'zgartirish -->
        <div class="profile-grid">
          <div class="profile-field">
            <label>Yangi parol (ixtiyoriy)</label>
            <input type="password" id="pf-new-password" minlength="6" placeholder="Kamida 6 ta belgi">
          </div>
          <div class="profile-field">
            <label>Yangi parol takrori</label>
            <input type="password" id="pf-new-password2" minlength="6" placeholder="Yangi parolni takrorlang">
          </div>
        </div>

        <div class="profile-points-row">
          <div class="profile-points-main">
            <div class="profile-points-label">Ball (points) tizimi</div>
            <div class="profile-points-value">
              <span id="pf-points">0</span> ball
            </div>
          </div>
          <div class="profile-points-extra">
            <span id="pf-rank-badge" class="profile-rank-badge">Yangi foydalanuvchi</span>
          </div>
        </div>

        <div class="profile-actions">
          <button type="button" class="profile-btn-secondary" id="btn-install-pwa">
            <i class="fa-solid fa-download"></i> Ilovani o‘rnatish (PWA)
          </button>

          <button type="button" class="profile-btn-secondary" id="profile-logout-btn">
            <i class="fa-solid fa-arrow-right-from-bracket"></i> Chiqish
          </button>

          <button type="button" class="profile-btn-secondary" id="profile-close-view-btn">
            Yopish
          </button>
          <button type="button" class="profile-btn-primary" id="profile-edit-btn">
            <i class="fa-solid fa-pen-to-square"></i>
            Tahrirlash
          </button>

          <button type="button" class="profile-btn-secondary" id="profile-cancel-btn">
            Bekor qilish
          </button>
          <button type="submit" class="profile-btn-primary" id="profile-save-btn">
            <i class="fa-solid fa-floppy-disk"></i>
            Saqlash
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // iframe modal
  (function(){
    const modal = document.getElementById('page-modal');
    const frame = document.getElementById('modal-frame');
    const closeBtn = document.getElementById('modal-close');

    document.querySelectorAll('[data-link]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const url = btn.dataset.link;
        if(!url) return;
        frame.src = url;
        modal.classList.add('open');
        document.body.classList.add('no-scroll');
      });
    });

    function closeModal(){
      modal.classList.remove('open');
      frame.src = '';
      document.body.classList.remove('no-scroll');
    }

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', e=>{ if(e.target===modal) closeModal(); });
  })();

  // PROFILE + PWA + REGIONS
  (function(){
    const db = window.authLite?.db;
    let currentSession = null;
    let regionsData = null;
    let isEditing = false;
    let isMandatory = false;

    function calcAge(birthDateStr){
      if (!birthDateStr) return null;
      const d = new Date(birthDateStr);
      if (isNaN(d.getTime())) return null;
      const now = new Date();
      let age = now.getFullYear() - d.getFullYear();
      const m = now.getMonth() - d.getMonth();
      if (m < 0 || (m === 0 && now.getDate() < d.getDate())) age--;
      return age >= 0 ? age : null;
    }

    function calcRank(points){
      const p = Number(points) || 0;
      if (p >= 1000) return "Legend";
      if (p >= 500)  return "Ustoz";
      if (p >= 200)  return "Faol talaba";
      if (p >= 50)   return "Faol foydalanuvchi";
      if (p > 0)     return "Yangi ishtirokchi";
      return "Yangi foydalanuvchi";
    }

    async function loadRegions(){
      if (regionsData) return regionsData;
      try{
        const res = await fetch('./region.json');
        regionsData = await res.json();
      }catch(err){
        console.error('region.json yuklashda xatolik:', err);
        regionsData = { regions: [] };
      }
      return regionsData;
    }

    function fillRegionSelect(){
      const selRegion = document.getElementById("pf-region");
      if (!selRegion || !regionsData || !regionsData.regions) return;
      selRegion.innerHTML = '<option value="">Tanlang</option>';
      regionsData.regions.forEach(r=>{
        const opt = document.createElement("option");
        opt.value = r.name;
        opt.textContent = r.name;
        selRegion.appendChild(opt);
      });
    }

    function fillDistrictSelect(regionName, selectedDistrict){
      const selDistrict = document.getElementById("pf-district");
      if (!selDistrict) return;
      selDistrict.disabled = true;
      selDistrict.innerHTML = '<option value="">Avval viloyatni tanlang</option>';
      if (!regionName || !regionsData) return;

      const region = regionsData.regions.find(r => r.name === regionName);
      if (!region) return;

      selDistrict.disabled = false;
      selDistrict.innerHTML = '<option value="">Tuman/shaharni tanlang</option>';

      (region.districts || []).forEach(d=>{
        const opt = document.createElement("option");
        opt.value = d.name;
        opt.textContent = d.name;
        selDistrict.appendChild(opt);
      });

      if (selectedDistrict){
        selDistrict.value = selectedDistrict;
      }
    }

    function renderProfileView(){
      if (!currentSession) return;
      const data = currentSession.data || {};
      const id = currentSession.id;

      const fullName = data.fullName || 'Foydalanuvchi';
      const points = Number(data.points || 0);
      const rank = calcRank(points);
      const age = calcAge(data.birthDate);

      document.getElementById('pv-fullname').textContent = fullName;
      document.getElementById('pv-id').textContent = 'ID: ' + (id || '—');
      document.getElementById('pv-points').textContent = points + ' ball';
      document.getElementById('pv-age').textContent = age != null ? ('Yoshi: ' + age) : 'Yoshi: —';
      document.getElementById('pv-region').textContent = data.region   || '—';
      document.getElementById('pv-district').textContent = data.district || '—';
      document.getElementById('pv-birthdate').textContent = data.birthDate || '—';
      document.getElementById('pv-rank').textContent = rank;

      document.getElementById('pf-points').textContent = points;
      document.getElementById('pf-rank-badge').textContent = rank;
    }

    function fillFormFromData(){
      const data = currentSession?.data || {};
      document.getElementById("pf-fullname").value  = data.fullName  || '';
      document.getElementById("pf-birthdate").value = data.birthDate || '';
      document.getElementById("pf-region").value    = data.region    || '';
      if (data.region){
        fillDistrictSelect(data.region, data.district || '');
      }else{
        const selDistrict = document.getElementById("pf-district");
        selDistrict.disabled = true;
        selDistrict.innerHTML = '<option value="">Avval viloyatni tanlang</option>';
      }
      document.getElementById("pf-new-password").value  = '';
      document.getElementById("pf-new-password2").value = '';
    }

    function isProfileComplete(data){
      return !!(data.fullName && data.birthDate && data.region && data.district);
    }

    function setEditingMode(edit){
      isEditing = !!edit;
      const viewBlock   = document.getElementById("profile-view");
      const btnCloseX   = document.getElementById("profile-close-btn");
      const btnCloseV   = document.getElementById("profile-close-view-btn");
      const btnEdit     = document.getElementById("profile-edit-btn");
      const btnCancel   = document.getElementById("profile-cancel-btn");
      const btnSave     = document.getElementById("profile-save-btn");

      if (viewBlock) viewBlock.style.display = edit ? "none" : "block";
      if (btnCloseV) btnCloseV.style.display = edit ? "none" : "inline-flex";
      if (btnEdit)   btnEdit.style.display   = edit ? "none" : "inline-flex";
      if (btnCancel) btnCancel.style.display = edit ? "inline-flex" : "none";
      if (btnSave)   btnSave.style.display   = edit ? "inline-flex" : "none";

      if (btnCloseX) btnCloseX.style.display = isMandatory ? "none" : "inline-flex";
      if (btnCancel && isMandatory) btnCancel.style.display = "none";
      if (btnCloseV && isMandatory) btnCloseV.style.display = "none";
    }

    function openProfileModal(mandatory){
      const overlay = document.getElementById("profile-overlay");
      if (!overlay) return;
      isMandatory = !!mandatory;
      renderProfileView();
      fillFormFromData();
      setEditingMode(isMandatory ? true : false);
      overlay.classList.add('open');
      document.body.classList.add('no-scroll');
    }

    function closeProfileModal(){
      if (isMandatory) return;
      const overlay = document.getElementById("profile-overlay");
      if (!overlay) return;
      overlay.classList.remove('open');
      document.body.classList.remove('no-scroll');
    }

    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e)=>{
      e.preventDefault();
      deferredPrompt = e;
      const btn = document.getElementById('btn-install-pwa');
      if (btn) btn.style.display = 'inline-flex';
    });

    document.getElementById('btn-install-pwa').addEventListener('click', async ()=>{
      if (!deferredPrompt){
        alert('Hozircha o‘rnatish imkoni yo‘q. Keyinroq urinib ko‘ring.');
        return;
      }
      deferredPrompt.prompt();
      const res = await deferredPrompt.userChoice;
      deferredPrompt = null;
      console.log('PWA install outcome:', res.outcome);
    });

    function setupEvents(){
      const btnProfile = document.getElementById("btn-profile");
      const btnCloseX  = document.getElementById("profile-close-btn");
      const btnCloseV  = document.getElementById("profile-close-view-btn");
      const btnEdit    = document.getElementById("profile-edit-btn");
      const btnCancel  = document.getElementById("profile-cancel-btn");
      const overlay    = document.getElementById("profile-overlay");
      const form       = document.getElementById("profile-form");
      const selRegion  = document.getElementById("pf-region");
      const selDistrict= document.getElementById("pf-district");
      const btnLogout  = document.getElementById("profile-logout-btn");

      if (btnProfile){
        btnProfile.addEventListener('click', ()=> openProfileModal(false));
      }
      if (btnCloseX) btnCloseX.addEventListener('click', closeProfileModal);
      if (btnCloseV) btnCloseV.addEventListener('click', closeProfileModal);

      if (btnEdit){
        btnEdit.addEventListener('click', ()=>{
          isMandatory = false;
          setEditingMode(true);
        });
      }
      if (btnCancel){
        btnCancel.addEventListener('click', ()=>{
          if (isMandatory) return;
          fillFormFromData();
          setEditingMode(false);
        });
      }
      if (overlay){
        overlay.addEventListener('click', (e)=>{
          if (e.target === overlay) closeProfileModal();
        });
      }
      if (selRegion){
        selRegion.addEventListener('change', ()=>{
          const regionName = selRegion.value;
          fillDistrictSelect(regionName, "");
        });
      }
      if (btnLogout){
        btnLogout.addEventListener('click', async ()=>{
          if (window.authLite){
            await authLite.logout();
          }
        });
      }

      if (form){
        form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          if (!currentSession || !db){
            alert("Auth tizimi topilmadi.");
            return;
          }
          const fullName  = document.getElementById("pf-fullname").value.trim();
          const birthDate = document.getElementById("pf-birthdate").value;
          const region    = document.getElementById("pf-region").value;
          const district  = document.getElementById("pf-district").value;

          if (!fullName || !birthDate || !region || !district){
            alert("Ism familiya, tug‘ilgan sana, viloyat va tuman/shahar majburiy.");
            return;
          }

          const newPass  = document.getElementById("pf-new-password").value;
          const newPass2 = document.getElementById("pf-new-password2").value;

          if (newPass || newPass2){
            if (newPass.length < 6){
              alert("Yangi parol kamida 6 ta belgidan iborat bo‘lsin.");
              return;
            }
            if (newPass !== newPass2){
              alert("Yangi parol va takrori mos emas.");
              return;
            }
          }

          const payload = {
            fullName,
            birthDate,
            region,
            district,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          if (newPass){
            payload.password = newPass;
          }

          try{
            const docRef = db.collection('foydalanuvchilar').doc(currentSession.id);
            await docRef.set(payload, { merge:true });
            currentSession.data = Object.assign({}, currentSession.data, payload);
            renderProfileView();
            if (isMandatory){
              isMandatory = false;
              closeProfileModal();
            }else{
              setEditingMode(false);
              alert("Profil saqlandi.");
            }
          }catch(err){
            console.error(err);
            alert("Profilni saqlashda xatolik: " + err.message);
          }
        });
      }
    }

    async function init(){
      if (!window.authLite || !db){
        alert("Auth tizimi yoki Firestore yuklanmagan.");
        return;
      }

      if ('serviceWorker' in navigator){
        navigator.serviceWorker.register('./service-worker.js').catch(console.error);
      }

      currentSession = await authLite.requireSession(true);
      if (!currentSession) return;

      await loadRegions();
      fillRegionSelect();

      if (!isProfileComplete(currentSession.data || {})){
        openProfileModal(true);
      }else{
        renderProfileView();
      }

      setupEvents();
    }

    document.addEventListener('DOMContentLoaded', init);
  })();
</script>
</body>
</html>
