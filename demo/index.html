<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>LeaderMath — Card + Ads</title>
  <meta name="theme-color" content="#2E8B57"/>

  <style>
    :root{
      --brand:#2E8B57; --brand-dark:#1F6B45; --accent:#6B8E23;
      --bg:#F6FBF8; --bg-2:#ECF5EF;
      --card:#FFFFFF; --card-soft:#F8FCF9;
      --text:#0F1B15; --muted:#5E7867;
      --line:#DFEAE3;
      --shadow:0 20px 60px rgba(16,40,26,.16);
      --shadow-soft:0 12px 36px rgba(16,40,26,.12);
      --radius:18px; --pill:999px;
      --speed:.22s;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#E4F1EA 0,#F6FBF8 40%,#FFFFFF 100%);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter:blur(16px);
      background:linear-gradient(120deg,rgba(246,251,248,.96),rgba(232,244,237,.9));
      border-bottom:1px solid rgba(223,234,227,.9);
    }
    .row{
      max-width:1180px; margin:0 auto;
      padding:10px 16px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .logo-wrap{
      display:flex; align-items:center; gap:10px;
    }
    .logo-circle{
      width:32px; height:32px;border-radius:50%;
      background:radial-gradient(circle at 20% 0,#7EE0AB 0,#2E8B57 40%,#1F6B45 100%);
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-weight:800; font-size:18px;
      box-shadow:0 10px 28px rgba(46,139,87,.55);
    }
    .brand-title{
      display:flex; flex-direction:column; line-height:1.1;
    }
    .brand-title span:first-child{
      font-weight:800; letter-spacing:.06em; text-transform:uppercase;
      font-size:12px; color:#1F3A2B;
    }
    .brand-title span:last-child{
      font-size:11px; color:var(--muted);
    }
    .user-chip{
      display:flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.9);
      border:1px solid rgba(223,231,226,.9);
      box-shadow:0 10px 26px rgba(16,40,26,.12);
      cursor:pointer;
      font-size:13px;
      transition:transform var(--speed),box-shadow var(--speed),background var(--speed);
    }
    .user-chip:hover{
      transform:translateY(-1px);
      box-shadow:0 16px 40px rgba(16,40,26,.22);
      background:#FFFFFF;
    }
    .avatar{
      width:26px; height:26px;
      border-radius:50%;
      background:linear-gradient(135deg,#2E8B57,#6B8E23);
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-size:14px; font-weight:700;
    }
    .user-meta{
      display:flex; flex-direction:column; line-height:1.1;
    }
    .user-meta span:first-child{
      font-weight:600; font-size:13px;
    }
    .user-meta span:last-child{
      font-size:11px; color:var(--muted);
    }
    .btn{
      border:0; outline:0; cursor:pointer;
      border-radius:999px;
      padding:6px 14px;
      font-size:13px; font-weight:600;
      display:inline-flex; align-items:center; gap:6px;
      transition:background var(--speed),transform var(--speed),box-shadow var(--speed);
      background:var(--brand); color:#fff;
      box-shadow:0 10px 30px rgba(46,139,87,.35);
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 16px 40px rgba(46,139,87,.45);
    }

    .chip-bar{
      position:sticky; top:56px; z-index:15;
      padding:6px 0 2px;
      background:linear-gradient(180deg,rgba(246,251,248,.98),rgba(246,251,248,.92),transparent);
      backdrop-filter:blur(8px);
    }
    .chip-scroll{
      max-width:1180px; margin:0 auto;
      padding:0 16px;
      overflow-x:auto;
      scrollbar-width:none;
    }
    .chip-scroll::-webkit-scrollbar{display:none;}
    .chip-row{
      display:flex; gap:8px; padding:4px 0 8px;
    }
    .chip{
      flex:0 0 auto;
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 11px;
      border-radius:999px;
      background:rgba(255,255,255,.94);
      border:1px solid rgba(223,234,227,.9);
      box-shadow:0 10px 32px rgba(16,40,26,.12);
      font-size:13px;
      cursor:pointer;
      transition:transform var(--speed),box-shadow var(--speed),background var(--speed),border-color var(--speed),color var(--speed);
    }
    .chip span.icon{font-size:15px;}
    .chip small{
      font-size:11px; color:var(--muted);
    }
    .chip.active{
      background:linear-gradient(120deg,#2E8B57,#6B8E23);
      color:#fff;
      border-color:transparent;
      box-shadow:0 16px 48px rgba(46,139,87,.6);
    }
    .chip.active small{color:rgba(255,255,255,.85);}

    main{
      max-width:1180px; margin:12px auto 24px;
      padding:0 16px 24px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    .cards-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:10px;
    }
    .card{
      border-radius:var(--radius);
      background:radial-gradient(circle at top left,#FFFFFF,#F9FCFA);
      padding:10px 10px 9px;
      border:1px solid rgba(223,234,227,.9);
      box-shadow:var(--shadow-soft);
      display:flex; flex-direction:column; gap:6px;
      position:relative;
      overflow:hidden;
    }
    .badge{
      position:absolute; top:8px; right:8px;
      border-radius:999px;
      font-size:10px;
      padding:3px 9px;
      background:rgba(46,139,87,.08);
      color:#1F6B45;
      border:1px solid rgba(46,139,87,.25);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .badge.pro{
      background:rgba(57,73,171,.1);
      color:#1A237E;
      border-color:rgba(57,73,171,.35);
    }
    .badge.hot{
      background:rgba(229,57,53,.12);
      color:#B71C1C;
      border-color:rgba(229,57,53,.4);
    }
    .card-title{
      font-weight:700; font-size:14px;
    }
    .card-text{
      font-size:12px; color:var(--muted);
    }
    .card-cta{
      margin-top:4px;
      font-size:12px; font-weight:600;
      text-decoration:none;
      color:#fff;
      background:var(--brand);
      padding:6px 10px;
      border-radius:999px;
      display:inline-flex; align-items:center; gap:6px;
      box-shadow:0 10px 26px rgba(46,139,87,.4);
      cursor:pointer;
    }
    .card-cta::after{
      content:"›"; font-size:13px;
    }
    .card-cta:hover{
      box-shadow:0 16px 40px rgba(46,139,87,.55);
      transform:translateY(-1px);
    }
    .empty{
      font-size:12px; color:var(--muted);
      text-align:center; padding:12px 8px;
    }
    footer{
      padding:10px 16px 18px;
      font-size:11px; color:var(--muted);
      text-align:center;
    }

    /* ====== ADS MODAL ====== */
    .ad-modal{
      position:fixed; inset:0; z-index:50;
      display:none;
      align-items:center; justify-content:center;
    }
    .ad-modal.active{display:flex;}
    .ad-backdrop{
      position:absolute; inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter:blur(10px);
    }
    .ad-dialog{
      position:relative;
      max-width:640px;
      width:calc(100% - 32px);
      max-height:80vh;
      background:#0D1712;
      color:#f5fff9;
      border-radius:18px;
      box-shadow:0 26px 70px rgba(0,0,0,.7);
      overflow:hidden;
      display:flex; flex-direction:column;
      z-index:51;
    }
    .ad-header{
      padding:10px 14px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:linear-gradient(135deg,rgba(14,53,34,.98),rgba(16,73,42,.98));
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:.14em;
    }
    .ad-header button{
      border:0; background:transparent; color:#fff;
      font-size:16px; cursor:pointer;
    }
    .ad-content{
      padding:12px 14px;
      overflow:auto;
      background:radial-gradient(circle at top,#163d27,#041209);
      font-size:13px;
    }
    .ad-footer{
      padding:10px 14px;
      display:flex; justify-content:space-between; gap:8px;
      border-top:1px solid rgba(255,255,255,.08);
      background:linear-gradient(180deg,rgba(4,12,7,.96),rgba(8,20,12,.98));
    }
    .ad-btn{
      flex:1;
      border-radius:999px;
      padding:7px 10px;
      font-size:13px; font-weight:600;
      border:0; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      gap:6px;
      transition:background var(--speed),transform var(--speed),box-shadow var(--speed);
    }
    .ad-btn-next{
      background:rgba(255,255,255,.08);
      color:#E3F5EB;
    }
    .ad-btn-next:hover{
      background:rgba(255,255,255,.14);
      transform:translateY(-1px);
    }
    .ad-btn-continue{
      background:#FFCF33;
      color:#271E05;
      box-shadow:0 12px 36px rgba(0,0,0,.7);
    }
    .ad-btn-continue:hover{
      background:#FFE066;
      transform:translateY(-1px);
    }
  </style>
</head>
<body>
<header>
  <div class="row">
    <div class="logo-wrap">
      <div class="logo-circle">π</div>
      <div class="brand-title">
        <span>LeaderMath Card</span>
        <span>Card bosilganda reklama orqali o‘tish</span>
      </div>
    </div>
    <div id="authArea"></div>
  </div>
</header>

<div class="chip-bar">
  <div class="chip-scroll">
    <div class="chip-row" id="chipsRow"></div>
  </div>
</div>

<main>
  <section>
    <div class="cards-grid" id="cardsGrid"></div>
  </section>
</main>

<footer>
  Card konfiguratsiyasi va ads HTML Firestore orqali boshqariladi. Admin panel: <code>/admin.html</code>
</footer>

<!-- ADS MODAL -->
<div id="adModal" class="ad-modal">
  <div class="ad-backdrop" id="adBackdrop"></div>
  <div class="ad-dialog">
    <div class="ad-header">
      <span>Reklama</span>
      <button id="adCloseX">✕</button>
    </div>
    <div id="adContent" class="ad-content">
      <!-- HTML ad shu yerga tushadi -->
    </div>
    <div class="ad-footer">
      <button class="ad-btn ad-btn-next" id="adNextBtn">Keyingisi</button>
      <button class="ad-btn ad-btn-continue" id="adContinueBtn">Boshlashga o‘tish</button>
    </div>
  </div>
</div>

<script type="module">
  import {
    auth,
    provider,
    signInWithPopup,
    onAuthStateChanged,
    signOut,
    subscribeHomeConfig,
    ensureUserDoc,
    subscribeUserProfile
  } from './firebase.js';

  const chipsRow = document.getElementById('chipsRow');
  const cardsGrid = document.getElementById('cardsGrid');
  const authArea = document.getElementById('authArea');

  const adModal = document.getElementById('adModal');
  const adBackdrop = document.getElementById('adBackdrop');
  const adCloseX = document.getElementById('adCloseX');
  const adContent = document.getElementById('adContent');
  const adNextBtn = document.getElementById('adNextBtn');
  const adContinueBtn = document.getElementById('adContinueBtn');

  let homeConfig = { chips: [], ads: [] };
  let currentChipIndex = 0;
  let currentRole = 'guest';
  let currentUser = null;
  let unsubscribeProfile = null;

  let activeAds = []; // faqat enabled ads
  let adQueue = [];
  let adIndex = 0;
  let pendingHref = null;

  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  function filterByRole(items) {
    return (items || []).filter(it => {
      if (!it.visibleRoles || !it.visibleRoles.length) return true;
      return it.visibleRoles.includes(currentRole);
    });
  }

  // ---- AUTH ----
  function renderAuth(user, role) {
    authArea.innerHTML = '';
    if (!user) {
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = 'Kirish (Google)';
      btn.onclick = async () => {
        try {
          await signInWithPopup(auth, provider);
        } catch (e) {
          alert('Kirishda xatolik: ' + e.message);
          console.error(e);
        }
      };
      authArea.appendChild(btn);
      return;
    }
    const chip = document.createElement('div');
    chip.className = 'user-chip';
    chip.innerHTML = `
      <div class="avatar">${(user.displayName || user.email || '?')[0]?.toUpperCase()}</div>
      <div class="user-meta">
        <span>${user.displayName || 'Foydalanuvchi'}</span>
        <span>${role || 'user'} • ${user.email || ''}</span>
      </div>
    `;
    chip.onclick = async () => {
      await signOut(auth);
    };
    authArea.appendChild(chip);
  }

  onAuthStateChanged(auth, async (user) => {
    currentUser = user || null;
    if (unsubscribeProfile) {
      unsubscribeProfile();
      unsubscribeProfile = null;
    }

    if (!user) {
      currentRole = 'guest';
      renderAuth(null, currentRole);
      renderChips();
      renderCardsForCurrentChip();
      return;
    }

    try {
      await ensureUserDoc(user);
    } catch (e) {
      console.error('ensureUserDoc xato:', e);
    }

    unsubscribeProfile = subscribeUserProfile(user.uid, (profile) => {
      currentRole = profile.role || 'user';
      renderAuth(user, currentRole);
      renderChips();
      renderCardsForCurrentChip();
    });
  });

  // ---- CHIPLAR + CARDLAR ----
  function renderChips() {
    chipsRow.innerHTML = '';
    if (!homeConfig.chips || !homeConfig.chips.length) {
      chipsRow.innerHTML = '<span class="empty">Hali chiplar yo‘q.</span>';
      return;
    }
    homeConfig.chips.forEach((chip, idx) => {
      const visible = !chip.visibleRoles || !chip.visibleRoles.length || chip.visibleRoles.includes(currentRole);
      if (!visible) return;
      const div = document.createElement('button');
      div.type = 'button';
      div.className = 'chip' + (idx === currentChipIndex ? ' active' : '');
      div.innerHTML = `
        <span class="icon">${chip.icon || '⬡'}</span>
        <span>${chip.label || chip.id || 'Chip'}</span>
        <small>${(chip.cards?.length || 0)} ta card</small>
      `;
      div.onclick = () => {
        currentChipIndex = idx;
        renderChips();
        renderCardsForCurrentChip();
      };
      chipsRow.appendChild(div);
    });
  }

  function renderCardsForCurrentChip() {
    cardsGrid.innerHTML = '';
    if (!homeConfig.chips || !homeConfig.chips.length) {
      cardsGrid.innerHTML = '<div class="empty">Hali cardlar yo‘q.</div>';
      return;
    }
    const chip = homeConfig.chips[currentChipIndex] || homeConfig.chips[0];
    const cards = filterByRole(chip.cards || []);
    if (!cards.length) {
      cardsGrid.innerHTML = '<div class="empty">Bu chip uchun cardlar yo‘q.</div>';
      return;
    }

    cards.forEach((c, idx) => {
      const div = document.createElement('article');
      div.className = 'card';
      const badgeClass = !c.badge ? '' :
        (c.badge.toLowerCase().includes('pro') ? ' pro' :
         c.badge.toLowerCase().includes('cheg') || c.badge.toLowerCase().includes('aksiya') ? ' hot' : '');
      const href = c.ctaHref || '#';
      div.innerHTML = `
        ${c.badge ? `<div class="badge${badgeClass}">${c.badge}</div>` : ''}
        <div class="card-title">${c.title || 'Card sarlavhasi'}</div>
        <div class="card-text">${c.description || ''}</div>
        ${href && href !== '#' ? `<a href="${href}" class="card-cta" data-href="${href}">${c.ctaLabel || 'Boshlash'}</a>` : ''}
      `;
      cardsGrid.appendChild(div);
    });

    // CTA tugmalariga reklama modalini ulaymiz
    cardsGrid.querySelectorAll('.card-cta').forEach(a=>{
      a.addEventListener('click',(e)=>{
        e.preventDefault();
        const href = e.currentTarget.dataset.href;
        if (!href || href === '#') return;
        handleCardClickWithAds(href);
      });
    });
  }

  // ---- ADS LOGIKA ----
  function handleCardClickWithAds(href) {
    // agar ads yo'q yoki faol emas bo'lsa — to'g'ridan-to'g'ri linkka o'tamiz
    if (!activeAds.length) {
      window.location.href = href;
      return;
    }
    pendingHref = href;
    adQueue = shuffle(activeAds);
    adIndex = 0;
    showAdAt(adIndex);
    openAdModal();
  }

  function showAdAt(idx) {
    if (!adQueue.length) return;
    const ad = adQueue[idx % adQueue.length];
    adContent.innerHTML = ad.html || '<div style="padding:16px;">Reklama HTML mavjud emas.</div>';
  }

  function openAdModal() {
    adModal.classList.add('active');
  }

  function closeAdModalAndGo() {
    adModal.classList.remove('active');
    const href = pendingHref;
    pendingHref = null;
    if (href) {
      window.location.href = href;
    }
  }

  adNextBtn.onclick = () => {
    if (!adQueue.length) return;
    adIndex = (adIndex + 1) % adQueue.length;
    showAdAt(adIndex);
  };
  adContinueBtn.onclick = () => {
    closeAdModalAndGo();
  };
  adBackdrop.onclick = () => {
    closeAdModalAndGo();
  };
  adCloseX.onclick = () => {
    closeAdModalAndGo();
  };

  // ---- FIRESTORE LISTENER ----
  subscribeHomeConfig((cfg) => {
    homeConfig = cfg || { chips: [], ads: [] };
    if (!homeConfig.chips) homeConfig.chips = [];
    if (!homeConfig.ads) homeConfig.ads = [];
    activeAds = (homeConfig.ads || []).filter(a => a && a.html && a.enabled !== false);
    if (currentChipIndex >= homeConfig.chips.length) {
      currentChipIndex = 0;
    }
    renderChips();
    renderCardsForCurrentChip();
  });
</script>
</body>
</html>
