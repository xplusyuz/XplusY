<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"/>
  <title>LeaderMath.UZ ‚Äî Gigant Platforma</title>

  <meta name="theme-color" content="#2E8B57" id="meta-theme-color"/>
  <link rel="icon" href="./logo.png" sizes="192x192">
  <link rel="apple-touch-icon" href="./logo.png">

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <style>
  :root[data-theme="light"]{
    --brand:#2E8B57;
    --brand-2:#1F6B45;
    --accent:#FFD166;
    --bg:#F4FBF6;
    --bg-alt:#E5F3EB;
    --card:#FFFFFF;
    --card-soft:#F9FCFA;
    --text:#0F1B15;
    --muted:#5E7567;
    --line:#DFEAE3;
    --radius:18px;
    --radius-lg:26px;
    --pill:999px;
    --shadow-sm:0 10px 30px rgba(16,37,24,.14);
    --shadow-lg:0 26px 80px rgba(8,24,16,.26);
    --tran-fast:.18s ease-out;
    --tran-med:.26s cubic-bezier(.22,.8,.24,1);
  }
  :root[data-theme="dark"]{
    --brand:#4ADE80;
    --brand-2:#16A34A;
    --accent:#FACC15;
    --bg:#020817;
    --bg-alt:#020617;
    --card:#020617;
    --card-soft:#020817;
    --text:#E5F3EB;
    --muted:#7A8C84;
    --line:#1F2937;
    --radius:18px;
    --radius-lg:26px;
    --pill:999px;
    --shadow-sm:0 16px 40px rgba(0,0,0,.75);
    --shadow-lg:0 40px 120px rgba(0,0,0,.85);
  }

  *{box-sizing:border-box;margin:0;padding:0;}
  html,body{height:100%;width:100%;scroll-behavior:smooth;}
  body{
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
    background:radial-gradient(ellipse at top,#ffffff 0,var(--bg) 42%,var(--bg-alt) 100%);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    display:flex;
    flex-direction:column;
  }
  .page{flex:1;display:flex;flex-direction:column;min-height:100vh;}
  header{
    position:sticky;top:0;z-index:40;
    backdrop-filter:blur(24px);
    background:linear-gradient(90deg,rgba(244,251,246,.94),rgba(244,251,246,.85),rgba(244,251,246,.94));
    border-bottom:1px solid rgba(223,234,227,.8);
  }
  [data-theme="dark"] header{
    background:linear-gradient(90deg,rgba(2,8,23,.9),rgba(2,6,23,.96));
    border-bottom-color:#111827;
  }
  .header-inner{
    max-width:1320px;margin:0 auto;padding:10px 18px;
    display:flex;align-items:center;gap:16px;
  }
  .logo-wrap{display:flex;align-items:center;gap:10px;}
  .logo{
    width:40px;height:40px;border-radius:18px;
    background:radial-gradient(circle at 30% 20%,#ffffff 0,#b7f0c9 32%,#2E8B57 100%);
    display:flex;align-items:center;justify-content:center;
    box-shadow:0 12px 30px rgba(46,139,87,.4);overflow:hidden;
  }
  .logo img{width:28px;height:28px;object-fit:contain;}
  .brand-text{display:flex;flex-direction:column;line-height:1.1;}
  .brand-title{font-weight:800;font-size:19px;letter-spacing:.04em;text-transform:uppercase;}
  .brand-sub{font-size:11px;color:var(--muted);}
  .header-main{flex:1;display:flex;align-items:center;justify-content:space-between;gap:16px;}
  .top-menu{display:flex;gap:10px;align-items:center;font-size:13px;}
  .top-menu a{
    padding:6px 12px;border-radius:999px;text-decoration:none;
    color:var(--muted);border:1px solid transparent;transition:all var(--tran-fast);
  }
  .top-menu a.is-active,.top-menu a:hover{
    color:var(--brand-2);
    border-color:rgba(46,139,87,.24);
    background:linear-gradient(120deg,rgba(167,243,208,.4),rgba(190,242,220,.15));
  }
  .user-area{display:flex;align-items:center;gap:10px;justify-content:flex-end;}
  .points-pill{
    display:flex;align-items:center;gap:6px;
    padding:4px 10px;border-radius:999px;
    background:rgba(46,139,87,.06);border:1px solid rgba(46,139,87,.16);
    font-size:11px;
  }
  .points-pill span.value{font-weight:700;}
  [data-theme="dark"] .points-pill{
    background:rgba(22,163,74,.1);border-color:rgba(34,197,94,.5);
  }
  .user-chip{
    position:relative;display:flex;align-items:center;gap:10px;
    padding:6px 10px 6px 6px;border-radius:999px;
    background:radial-gradient(circle at 0 0,rgba(255,255,255,.5),rgba(255,255,255,0)) border-box,
               linear-gradient(120deg,rgba(148,245,196,.8),rgba(76,182,130,.9)) padding-box;
    box-shadow:0 10px 30px rgba(16,37,24,.18);
    color:#052012;cursor:pointer;
  }
  [data-theme="dark"] .user-chip{
    background:radial-gradient(circle at 0 0,rgba(15,23,42,1),rgba(15,23,42,.7)) border-box,
               linear-gradient(120deg,rgba(74,222,128,1),rgba(45,212,191,1)) padding-box;
    color:#ECFDF5;
  }
  .avatar{
    width:32px;height:32px;border-radius:999px;
    background:radial-gradient(circle at 30% 10%,#ffffff,rgba(148,245,196,1));
    display:flex;align-items:center;justify-content:center;
    font-weight:700;font-size:15px;
  }
  .avatar img{width:100%;height:100%;object-fit:cover;border-radius:inherit;}
  .user-chip-main{display:flex;flex-direction:column;gap:2px;}
  .user-name{font-size:13px;font-weight:600;max-width:140px;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;}
  .user-meta{display:flex;gap:6px;align-items:center;font-size:11px;opacity:.9;}
  .user-meta .badge{padding:2px 6px;border-radius:999px;background:rgba(15,118,110,.12);}
  .user-meta .class-label{opacity:.8;}
  .user-chevron{font-size:14px;opacity:.8;}
  .sign-btn{
    padding:8px 14px;border-radius:999px;border:none;
    background:linear-gradient(120deg,#2E8B57,#1F6B45);
    color:#fff;font-size:13px;font-weight:600;cursor:pointer;
    box-shadow:0 16px 40px rgba(34,197,94,.5);
    display:flex;align-items:center;gap:6px;
  }
  .sign-btn span.icon{font-size:16px;}
  .theme-toggle{
    width:32px;height:32px;border-radius:999px;
    border:1px solid rgba(148,163,184,.5);
    display:flex;align-items:center;justify-content:center;
    cursor:pointer;font-size:15px;background:rgba(255,255,255,.7);
  }
  [data-theme="dark"] .theme-toggle{background:rgba(15,23,42,.9);}
  .user-menu{
    position:absolute;top:120%;right:0;min-width:220px;
    background:var(--card);border-radius:18px;border:1px solid var(--line);
    box-shadow:var(--shadow-lg);padding:8px;display:none;
  }
  .user-menu.open{display:block;}
  .user-menu-section-title{
    font-size:11px;text-transform:uppercase;letter-spacing:.12em;
    color:var(--muted);padding:4px 8px;
  }
  .user-menu-item{
    display:flex;justify-content:space-between;align-items:center;
    padding:8px 10px;border-radius:12px;font-size:13px;
    cursor:pointer;transition:background var(--tran-fast),transform var(--tran-fast);
  }
  .user-menu-item:hover{background:rgba(46,139,87,.08);transform:translateY(-1px);}
  .user-menu-kpi{font-size:11px;opacity:.8;}
  .logout{color:#B91C1C;}

  .hero-shell{max-width:1320px;margin:18px auto 0;padding:0 18px 22px;}
  .hero{display:grid;grid-template-columns:minmax(0,2.1fr) minmax(0,1.4fr);gap:18px;}
  .hero-main{
    border-radius:var(--radius-lg);padding:20px 20px 18px;
    background:
      radial-gradient(circle at 0 0,rgba(255,255,255,1),rgba(209,250,229,.6)),
      radial-gradient(circle at 100% 0,rgba(254,249,195,.6),rgba(251,251,251,0)),
      linear-gradient(135deg,rgba(209,250,229,.9),rgba(187,247,208,.55));
    box-shadow:var(--shadow-lg);position:relative;overflow:hidden;
  }
  [data-theme="dark"] .hero-main{
    background:
      radial-gradient(circle at 0 0,rgba(15,23,42,1),rgba(15,23,42,1)),
      radial-gradient(circle at 100% 0,rgba(30,64,175,.4),rgba(17,24,39,.9));
  }
  .hero-kicker{
    display:inline-flex;gap:6px;align-items:center;
    padding:4px 10px 4px 4px;border-radius:999px;
    background:rgba(255,255,255,.8);font-size:11px;margin-bottom:8px;
  }
  [data-theme="dark"] .hero-kicker{background:rgba(15,23,42,.9);}
  .hero-kicker-pill{
    padding:3px 8px;border-radius:999px;
    background:rgba(34,197,94,.12);font-weight:600;font-size:11px;
  }
  .hero-title{font-size:30px;letter-spacing:.02em;margin-bottom:6px;}
  .hero-title span.accent{
    background:linear-gradient(120deg,#166534,#22c55e);
    -webkit-background-clip:text;color:transparent;
  }
  .hero-sub{font-size:13px;color:var(--muted);max-width:460px;}
  .hero-metrics{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;}
  .metric-pill{
    padding:6px 10px;border-radius:999px;
    background:rgba(255,255,255,.8);font-size:11px;
    display:flex;gap:6px;align-items:center;
  }
  [data-theme="dark"] .metric-pill{background:rgba(15,23,42,.9);}
  .hero-actions{margin-top:14px;display:flex;flex-wrap:wrap;gap:10px;}
  .hero-btn{
    border-radius:999px;border:none;padding:9px 18px;
    font-size:13px;font-weight:600;cursor:pointer;
    display:inline-flex;align-items:center;gap:8px;
    box-shadow:0 16px 50px rgba(34,197,94,.6);
    background:linear-gradient(120deg,#166534,#22c55e);
    color:white;
  }
  .hero-btn.secondary{
    box-shadow:none;background:rgba(255,255,255,.9);
    color:var(--text);border:1px solid rgba(148,163,184,.4);
  }
  .hero-grid{display:flex;flex-direction:column;gap:12px;}
  .hero-card{
    border-radius:var(--radius-lg);background:var(--card);
    border:1px solid rgba(148,163,184,.25);box-shadow:var(--shadow-sm);
    padding:12px 12px 12px;
  }
  .hero-card h3{font-size:13px;margin-bottom:4px;}
  .hero-card p{font-size:12px;color:var(--muted);}
  .hero-kpi-row{display:flex;gap:10px;margin-top:8px;}
  .hero-kpi{
    flex:1;padding:8px;border-radius:14px;
    background:var(--card-soft);font-size:11px;
  }
  .hero-kpi strong{display:block;font-size:14px;}
  .xp-bar{
    height:8px;border-radius:999px;
    background:rgba(148,163,184,.25);
    overflow:hidden;margin-top:8px;
  }
  .xp-bar-inner{
    height:100%;width:40%;
    background:linear-gradient(90deg,#22c55e,#38bdf8);
  }

  .shell{
    max-width:1320px;margin:0 auto;padding:0 18px 32px;
    display:grid;grid-template-columns:260px minmax(0,1fr);gap:20px;
  }
  @media (max-width:960px){
    .hero{grid-template-columns:1fr;}
    .shell{grid-template-columns:1fr;}
  }
  .side-menu{
    position:sticky;top:80px;align-self:flex-start;
    border-radius:24px;background:var(--card);
    border:1px solid var(--line);box-shadow:var(--shadow-sm);
    padding:12px;display:flex;flex-direction:column;gap:10px;
    max-height:calc(100vh - 100px);
  }
  .side-title{
    font-size:12px;text-transform:uppercase;letter-spacing:.16em;
    color:var(--muted);padding:0 6px;
  }
  .menu-list{
    overflow:auto;padding-right:4px;
    display:flex;flex-direction:column;gap:6px;
  }
  .menu-item{
    padding:7px 10px;border-radius:16px;
    font-size:13px;display:flex;justify-content:space-between;align-items:center;
    cursor:pointer;transition:background var(--tran-fast),transform var(--tran-fast),box-shadow var(--tran-fast);
  }
  .menu-item span.count{font-size:11px;opacity:.7;}
  .menu-item.active{
    background:linear-gradient(120deg,rgba(16,185,129,.15),rgba(34,197,94,.08));
    box-shadow:0 14px 30px rgba(16,185,129,.35);
    transform:translateY(-1px);
  }
  .content-area{display:flex;flex-direction:column;gap:12px;min-width:0;}
  .chip-row-shell{
    position:sticky;top:80px;z-index:20;
    padding:6px 10px;margin:0 -10px;
    backdrop-filter:blur(18px);
    background:linear-gradient(to bottom,rgba(244,251,246,.95),rgba(244,251,246,.85),transparent);
  }
  [data-theme="dark"] .chip-row-shell{
    background:linear-gradient(to bottom,rgba(2,8,23,.96),rgba(2,6,23,.94),transparent);
  }
  .chip-row{
    display:flex;gap:8px;overflow-x:auto;
    padding:4px 4px 2px;scrollbar-width:none;
  }
  .chip-row::-webkit-scrollbar{display:none;}
  .chip{
    flex:0 0 auto;padding:6px 12px;border-radius:999px;
    border:1px solid rgba(148,163,184,.35);
    background:rgba(255,255,255,.9);font-size:12px;
    cursor:pointer;white-space:nowrap;
    display:flex;gap:6px;align-items:center;
    transition:all var(--tran-fast);
  }
  [data-theme="dark"] .chip{background:rgba(15,23,42,.95);}
  .chip span.dot{width:6px;height:6px;border-radius:999px;background:#22c55e;}
  .chip.active{
    border-color:rgba(16,185,129,.9);
    background:linear-gradient(120deg,#bbf7d0,#a5f3fc);
    box-shadow:0 10px 30px rgba(56,189,248,.35);
  }
  .card-grid{
    margin-top:4px;display:grid;
    grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
    gap:16px;align-items:stretch;
  }
  .card{
    border-radius:24px;background:var(--card);
    border:1px solid var(--line);box-shadow:var(--shadow-sm);
    display:flex;flex-direction:column;overflow:hidden;position:relative;
  }
  .card-img-wrap{
    position:relative;padding-top:56%;
    overflow:hidden;background:radial-gradient(circle at 20% 0,#bbf7d0,#22c55e);
  }
  .card-img-wrap img{
    position:absolute;inset:0;width:100%;height:100%;
    object-fit:cover;transition:transform .5s ease-out;
  }
  .card:hover .card-img-wrap img{transform:scale(1.04);}
  .card-tag{
    position:absolute;left:10px;top:10px;
    padding:3px 8px;border-radius:999px;
    font-size:10px;background:rgba(15,23,42,.75);color:#e5e7eb;
  }
  .card-body{padding:10px 12px 12px;display:flex;flex-direction:column;gap:6px;}
  .card-title{font-size:15px;font-weight:650;}
  .card-sub{font-size:12px;color:var(--muted);}
  .card-meta-row{display:flex;justify-content:space-between;align-items:center;margin-top:4px;}
  .class-pill{
    padding:3px 8px;border-radius:999px;
    background:rgba(37,99,235,.08);font-size:11px;
  }
  .role-pill{
    padding:3px 8px;border-radius:999px;
    background:rgba(16,185,129,.1);font-size:11px;
  }
  .chips-inline{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;}
  .chips-inline span{
    border-radius:999px;background:rgba(148,163,184,.16);
    padding:2px 7px;font-size:10px;
  }
  .card-footer{margin-top:8px;display:flex;justify-content:space-between;align-items:center;gap:10px;}
  .card-cta{
    flex:1;border-radius:999px;border:none;padding:8px 12px;
    font-size:13px;font-weight:600;cursor:pointer;
    background:linear-gradient(120deg,#16a34a,#22c55e);
    color:#f9fafb;display:flex;align-items:center;gap:6px;
  }
  .card-cta span.icon{font-size:15px;}
  .card-xp{font-size:11px;color:var(--muted);}
  .card.recommended{
    outline:2px solid rgba(52,211,153,.9);
    box-shadow:0 26px 60px rgba(16,185,129,.5);
  }
  .empty{
    padding:18px;border-radius:18px;border:1px dashed var(--line);
    font-size:13px;color:var(--muted);text-align:center;margin-top:12px;
  }
  .modal-backdrop{
    position:fixed;inset:0;background:rgba(15,23,42,.55);
    backdrop-filter:blur(18px);display:none;
    align-items:center;justify-content:center;z-index:60;
  }
  .modal-backdrop.open{display:flex;}
  .modal{
    width:100%;max-width:480px;max-height:86vh;
    border-radius:24px;background:var(--card);
    border:1px solid var(--line);box-shadow:var(--shadow-lg);
    padding:18px 18px 16px;overflow:auto;
  }
  .modal h2{font-size:18px;margin-bottom:4px;}
  .modal p{font-size:13px;color:var(--muted);margin-bottom:10px;}
  .modal-close{border:none;background:transparent;font-size:18px;cursor:pointer;}
  .modal-header{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;margin-bottom:8px;}
  .form-grid{display:grid;gap:10px;margin-top:8px;}
  .field{display:flex;flex-direction:column;gap:4px;font-size:12px;}
  .field label{font-size:12px;font-weight:600;}
  .field input,.field select{
    border-radius:12px;border:1px solid var(--line);
    padding:7px 9px;font-size:13px;background:var(--card-soft);outline:none;
  }
  .field input:focus,.field select:focus{
    border-color:#22c55e;box-shadow:0 0 0 1px rgba(34,197,94,.6);
  }
  .helper{font-size:11px;color:var(--muted);}
  .primary-btn{
    border-radius:999px;border:none;padding:9px 16px;
    font-size:13px;font-weight:600;cursor:pointer;
    background:linear-gradient(120deg,#16a34a,#22c55e);
    color:white;display:inline-flex;align-items:center;gap:6px;margin-top:10px;
  }
  .ad-backdrop{
    position:fixed;inset:0;background:rgba(15,23,42,.9);
    display:none;align-items:center;justify-content:center;z-index:70;
  }
  .ad-backdrop.open{display:flex;}
  .ad-frame{
    width:min(720px,96vw);height:min(420px,70vh);
    border-radius:24px;overflow:hidden;background:#000;
    position:relative;box-shadow:0 40px 120px rgba(0,0,0,.9);
  }
  .ad-inner{position:absolute;inset:0;background:#000;color:#fff;}
  .ad-countdown{
    position:absolute;left:16px;bottom:16px;
    padding:7px 12px;border-radius:999px;
    background:rgba(0,0,0,.7);border:1px solid rgba(148,163,184,.6);
    font-size:12px;
  }
  .ad-label{
    position:absolute;right:16px;top:16px;
    padding:4px 9px;border-radius:999px;
    background:rgba(15,23,42,.8);font-size:11px;
    text-transform:uppercase;letter-spacing:.1em;
  }
  @media (max-width:720px){
    .header-inner{padding-inline:12px;}
    .brand-sub{display:none;}
    .hero-shell{padding-inline:12px;}
    .shell{padding-inline:12px;}
    .side-menu{position:static;max-height:none;}
    .chip-row-shell{top:70px;margin-inline:-12px;}
  }
  </style>
</head>
<body>
<div class="page">
  <header>
    <div class="header-inner">
      <div class="logo-wrap">
        <div class="logo">
          <img src="./logo.png" alt="LM" onerror="this.style.display='none'">
        </div>
        <div class="brand-text">
          <div class="brand-title">LeaderMath.UZ</div>
          <div class="brand-sub">Yagona gigant matematika ekotizimi</div>
        </div>
      </div>
      <div class="header-main">
        <nav class="top-menu">
          <a href="#top" class="is-active">Asosiy</a>
          <a href="#content">Kurslar &amp; testlar</a>
        </nav>
        <div class="user-area">
          <div class="points-pill" id="pointsPill" style="display:none;">
            <span>Ball:</span><span class="value" id="pointsValue">0</span>
          </div>
          <button class="theme-toggle" id="themeToggle" title="Kun / Tun">‚òÄÔ∏è</button>
          <button class="sign-btn" id="signInBtn">
            <span class="icon">‚ö°Ô∏è</span><span>Kirish / Ro‚Äòyxatdan o‚Äòtish</span>
          </button>
          <div class="user-chip" id="userChip" style="display:none;">
            <div class="avatar" id="avatar">
              <span id="avatarInitials">LM</span>
              <img id="avatarImg" src="" alt="" style="display:none;">
            </div>
            <div class="user-chip-main">
              <div class="user-name" id="userName">Foydalanuvchi</div>
              <div class="user-meta">
                <span class="badge" id="userRoleBadge">Guest</span>
                <span class="class-label" id="userClassLabel"></span>
              </div>
            </div>
            <div class="user-chevron">‚ñæ</div>
            <div class="user-menu" id="userMenu">
              <div class="user-menu-section-title">Profil</div>
              <div class="user-menu-item" id="viewProfileItem">
                <span>Profil</span><span class="user-menu-kpi" id="profileIdLabel">ID ‚Äî</span>
              </div>
              <div class="user-menu-item" id="editProfileItem">
                <span>Profilni to‚Äòldirish / tahrirlash</span>
              </div>
              <div class="user-menu-item">
                <span>Ball</span><span class="user-menu-kpi"><span id="userMenuPoints">0</span> XP</span>
              </div>
              <div class="user-menu-item logout" id="logoutItem">
                <span>Chiqish</span><span>‚á¶</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main id="top">
    <section class="hero-shell">
      <div class="hero">
        <div class="hero-main">
          <div class="hero-kicker">
            <div class="hero-kicker-pill">Gigant index</div>
            <span>Menu ‚Üí Chip ‚Üí Card filtrlash + XP tizimi</span>
          </div>
          <h1 class="hero-title">
            Bir sahifada <span class="accent">barcha matematika hayotingiz</span>.
          </h1>
          <p class="hero-sub">
            Menyudan yo‚Äònalishni tanlang, chiplar orqali maydonga torting, mos cardlar esa
            sizning sinfingiz va rol profilingizga qarab ‚ÄúSiz uchun‚Äù tavsiya qilinadi.
          </p>
          <div class="hero-metrics">
            <div class="metric-pill">üéØ Adaptiv filtrlash: menu + chip + sinf</div>
            <div class="metric-pill">üíé Ball tizimi, yosh va sinf bo‚Äòyicha darajalar</div>
            <div class="metric-pill">üõ°Ô∏è Reklamalar ‚Äî ads1.html, ads2.html... 5 soniya</div>
          </div>
          <div class="hero-actions">
            <button class="hero-btn" id="heroStartBtn">üöÄ Darhol boshlash</button>
            <button class="hero-btn secondary" id="heroProfileBtn">üë§ Profilni to‚Äòldirish</button>
          </div>
          <div class="xp-bar">
            <div class="xp-bar-inner" id="heroXpBar"></div>
          </div>
        </div>
        <div class="hero-grid">
          <div class="hero-card">
            <h3>Darajangiz</h3>
            <p id="heroLevelText">Kirishdan keyin sizga mos sinf va topshiriqlar tavsiya qilinadi.</p>
            <div class="hero-kpi-row">
              <div class="hero-kpi">
                <span>Ball</span><strong id="heroPoints">0 XP</strong>
                <small>Kengaygan testlar, simulatsiyalar, turnirlar uchun foyd.</small>
              </div>
              <div class="hero-kpi">
                <span>Sinf / Rol</span><strong id="heroClassRole">‚Äî</strong>
                <small>O‚Äòquvchi, abituriyent, talaba yoki o‚Äòqituvchi sifatida.</small>
              </div>
            </div>
          </div>
          <div class="hero-card">
            <h3>Gigant karta panjarasi</h3>
            <p>
              Cardlar <code>cards.json</code> dan yuklanadi:
              <span class="helper">imageUrl, buttonLabel, buttonUrl, menu, chips[]</span>.
            </p>
            <div class="hero-kpi-row">
              <div class="hero-kpi">
                <span>JSON</span><strong>cards.json</strong>
                <small>Har bir card uchun rasm, chiplar, menu, havola.</small>
              </div>
              <div class="hero-kpi">
                <span>ADS</span><strong>ads/*.html</strong>
                <small>Kartadagi tugmani bosganda 5 soniya full-screen reklama.</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="shell" id="content">
      <aside class="side-menu">
        <div class="side-title">Menyu</div>
        <div class="menu-list" id="menuList"></div>
      </aside>
      <section class="content-area">
        <div class="chip-row-shell">
          <div class="chip-row" id="chipRow"></div>
        </div>
        <div class="card-grid" id="cardGrid"></div>
        <div class="empty" id="emptyState" style="display:none;">
          Ushbu menu + chip bo‚Äòyicha card topilmadi. Boshqa chipni tanlab ko‚Äòring.
        </div>
      </section>
    </section>
  </main>
</div>

<div class="modal-backdrop" id="authModal">
  <div class="modal">
    <div class="modal-header">
      <div>
        <h2>LeaderMath.UZ akkaunt</h2>
        <p>Ball yig‚Äòish, sinflar bo‚Äòyicha tavsiyalar va profilingizni saqlash uchun kiring.</p>
      </div>
      <button class="modal-close" data-close-auth>‚úï</button>
    </div>
    <button class="primary-btn" id="googleSignInBtn">üîë Google orqali kirish</button>
    <p class="helper">
      Kirgandan keyin ‚ÄúProfilni to‚Äòldirish‚Äù orqali <b>ism-familiya, rol, sinf, tug‚Äòilgan yil</b> ni kiritasiz.
    </p>
  </div>
</div>

<div class="modal-backdrop" id="profileModal">
  <div class="modal">
    <div class="modal-header">
      <div>
        <h2>Profilni to‚Äòldirish</h2>
        <p>Yosh va sinf tizimi bo‚Äòyicha sizga mos cardlar ko‚Äòrsatiladi.</p>
      </div>
      <button class="modal-close" data-close-profile>‚úï</button>
    </div>
    <div class="form-grid">
      <div class="field">
        <label for="fullNameInput">To‚Äòliq ism-familiya</label>
        <input id="fullNameInput" type="text" placeholder="Masalan: Sattorov Sohibjon">
      </div>
      <div class="field">
        <label for="roleSelect">Rol</label>
        <select id="roleSelect">
          <option value="">Tanlang...</option>
          <option value="oquvchi">O‚Äòquv—á–∏</option>
          <option value="abiturient">Abituriyent</option>
          <option value="talaba">Talaba</option>
          <option value="oqituvchi">O‚Äòqituvchi</option>
        </select>
      </div>
      <div class="field" id="classField" style="display:none;">
        <label for="classSelect">Sinf</label>
        <select id="classSelect">
          <option value="">1‚Äì11 sinf</option>
          <option value="1">1-sinf</option>
          <option value="2">2-sinf</option>
          <option value="3">3-sinf</option>
          <option value="4">4-sinf</option>
          <option value="5">5-sinf</option>
          <option value="6">6-sinf</option>
          <option value="7">7-sinf</option>
          <option value="8">8-sinf</option>
          <option value="9">9-sinf</option>
          <option value="10">10-sinf</option>
          <option value="11">11-sinf</option>
        </select>
      </div>
      <div class="field">
        <label for="birthYearInput">Tug‚Äòilgan yil</label>
        <input id="birthYearInput" type="number" min="1980" max="2030" placeholder="Masalan: 2008">
        <span class="helper">Yosh tizimi va tavsiyalar uchun (taxminiy ham bo‚Äòlishi mumkin).</span>
      </div>
    </div>
    <button class="primary-btn" id="saveProfileBtn">üíæ Saqlash</button>
    <p class="helper">Profilda zarur maydonlar bo‚Äòsh qolsa, sayt asosiy funksiyalari cheklanishi mumkin.</p>
  </div>
</div>

<div class="ad-backdrop" id="adModal">
  <div class="ad-frame">
    <div class="ad-inner" id="adInner"></div>
    <div class="ad-label">Reklama</div>
    <div class="ad-countdown">5 soniya qoldi...</div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  authDomain: "xplusy-760fa.firebaseapp.com",
  projectId: "xplusy-760fa",
  storageBucket: "xplusy-760fa.firebasestorage.app",
  messagingSenderId: "992512966017",
  appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
  measurementId: "G-459PLJ7P7L"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

let currentUser = null;
let currentUserDoc = null;
let userUnsub = null;

const cardsUrl = "./cards.json";
const ADS_MAX = 3;

const state = {cards:[],menus:[],currentMenu:null,chipsByMenu:{},currentChip:"Hammasi"};

const signInBtn        = document.getElementById("signInBtn");
const userChip         = document.getElementById("userChip");
const userMenu         = document.getElementById("userMenu");
const avatarInitials   = document.getElementById("avatarInitials");
const avatarImg        = document.getElementById("avatarImg");
const userNameEl       = document.getElementById("userName");
const userRoleBadge    = document.getElementById("userRoleBadge");
const userClassLabel   = document.getElementById("userClassLabel");
const pointsPill       = document.getElementById("pointsPill");
const pointsValue      = document.getElementById("pointsValue");
const userMenuPoints   = document.getElementById("userMenuPoints");
const profileIdLabel   = document.getElementById("profileIdLabel");
const themeToggle      = document.getElementById("themeToggle");

const heroLevelText    = document.getElementById("heroLevelText");
const heroPoints       = document.getElementById("heroPoints");
const heroClassRole    = document.getElementById("heroClassRole");
const heroXpBar        = document.getElementById("heroXpBar");
const heroStartBtn     = document.getElementById("heroStartBtn");
const heroProfileBtn   = document.getElementById("heroProfileBtn");

const menuList         = document.getElementById("menuList");
const chipRow          = document.getElementById("chipRow");
const cardGrid         = document.getElementById("cardGrid");
const emptyState       = document.getElementById("emptyState");

const authModal        = document.getElementById("authModal");
const profileModal     = document.getElementById("profileModal");

const fullNameInput    = document.getElementById("fullNameInput");
const roleSelect       = document.getElementById("roleSelect");
const classField       = document.getElementById("classField");
const classSelect      = document.getElementById("classSelect");
const birthYearInput   = document.getElementById("birthYearInput");
const saveProfileBtn   = document.getElementById("saveProfileBtn");

const adModal          = document.getElementById("adModal");
const adInner          = document.getElementById("adInner");
const adCountdown      = adModal.querySelector(".ad-countdown");

(function initTheme(){
  const saved = localStorage.getItem("lm_theme");
  if(saved === "dark"){
    document.documentElement.setAttribute("data-theme","dark");
    themeToggle.textContent = "üåô";
  }
})();
themeToggle.addEventListener("click", ()=>{
  const current = document.documentElement.getAttribute("data-theme") || "light";
  const next = current === "light" ? "dark" : "light";
  document.documentElement.setAttribute("data-theme", next);
  localStorage.setItem("lm_theme", next);
  themeToggle.textContent = next === "light" ? "‚òÄÔ∏è" : "üåô";
});

function openAuthModal(){authModal.classList.add("open");}
function closeAuthModal(){authModal.classList.remove("open");}
document.querySelectorAll("[data-close-auth]").forEach(btn=>btn.addEventListener("click", closeAuthModal));
signInBtn.addEventListener("click", openAuthModal);
heroStartBtn.addEventListener("click", ()=>{
  if(currentUser){document.getElementById("content").scrollIntoView({behavior:"smooth"});}
  else openAuthModal();
});
heroProfileBtn.addEventListener("click", ()=>{
  if(currentUser) openProfileModal(); else openAuthModal();
});

document.getElementById("googleSignInBtn").addEventListener("click", async ()=>{
  try{
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
    closeAuthModal();
  }catch(err){alert("Kirishda xatolik: "+err.message);}
});

auth.onAuthStateChanged(async user=>{
  currentUser = user || null;
  if(user){
    signInBtn.style.display = "none";
    userChip.style.display = "flex";
    subscribeUserDoc(user.uid);
  }else{
    signInBtn.style.display = "inline-flex";
    userChip.style.display = "none";
    pointsPill.style.display = "none";
    heroPoints.textContent = "0 XP";
    heroClassRole.textContent = "‚Äî";
    heroXpBar.style.width = "0%";
    if(userUnsub){userUnsub();userUnsub=null;}
  }
});

function subscribeUserDoc(uid){
  if(userUnsub){userUnsub();userUnsub=null;}
  const ref = db.collection("users").doc(uid);
  userUnsub = ref.onSnapshot(async snap=>{
    if(!snap.exists){await createUserDocFromAuth();return;}
    currentUserDoc = snap.data();
    updateUserUI();
    if(profileIncomplete(currentUserDoc)) openProfileModal();
  });
}

async function createUserDocFromAuth(){
  if(!currentUser) return;
  const usersRef = db.collection("users").doc(currentUser.uid);
  const countersRef = db.collection("meta").doc("counters");
  await db.runTransaction(async tx=>{
    const countersSnap = await tx.get(countersRef);
    let nextNumeric = 1;
    if(!countersSnap.exists){
      tx.set(countersRef,{userNumericId:1});
    }else{
      const data = countersSnap.data() || {};
      nextNumeric = (data.userNumericId || 0) + 1;
      tx.update(countersRef,{userNumericId:nextNumeric});
    }
    const userSnap = await tx.get(usersRef);
    if(!userSnap.exists){
      tx.set(usersRef,{
        uid: currentUser.uid,
        email: currentUser.email || null,
        fullName: currentUser.displayName || "",
        photoURL: currentUser.photoURL || null,
        role: "",
        class: null,
        birthYear: null,
        points: 0,
        numericId: nextNumeric,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
  });
}

function profileIncomplete(doc){
  if(!doc) return true;
  if(!doc.fullName) return true;
  if(!doc.role) return true;
  if(doc.role === "oquvchi" && !doc.class) return true;
  if(!doc.birthYear) return true;
  return false;
}

function updateUserUI(){
  if(!currentUser || !currentUserDoc) return;
  const d = currentUserDoc;
  const name = d.fullName || currentUser.displayName || "Foydalanuvchi";
  userNameEl.textContent = name;
  const initials = name.split(" ").filter(Boolean).map(s=>s[0]).join("").slice(0,2).toUpperCase();
  avatarInitials.textContent = initials || "LM";
  if(d.photoURL){avatarImg.src=d.photoURL;avatarImg.style.display="block";}
  else avatarImg.style.display="none";

  const roleMap = {"oquvchi":"O‚Äòquvchi","abiturient":"Abituriyent","talaba":"Talaba","oqituvchi":"O‚Äòqituvchi"};
  userRoleBadge.textContent = roleMap[d.role] || "Guest";

  let classText = "";
  if(d.role === "oquvchi" && d.class) classText = d.class+"-sinf";
  else if(d.role==="abiturient") classText = "Abituriyent";
  else if(d.role==="talaba") classText = "Talaba";
  else if(d.role==="oqituvchi") classText = "O‚Äòqituvchi";
  userClassLabel.textContent = classText;

  const points = d.points || 0;
  pointsPill.style.display = "flex";
  pointsValue.textContent = points;
  userMenuPoints.textContent = points;
  profileIdLabel.textContent = "ID: "+(d.numericId || "‚Äî");

  heroPoints.textContent = points+" XP";
  heroClassRole.textContent = classText || "Rol belgilanmagan";
  const pct = Math.max(5, Math.min(100, points/10));
  heroXpBar.style.width = pct+"%";
  heroLevelText.textContent = classText
    ? classText+" uchun mos cardlar avtomatik filtrlanadi."
    : "Profilni to‚Äòldirsangiz, sinf va rolingiz bo‚Äòyicha tavsiyalar ishlaydi.";
  renderCards();
}

userChip.addEventListener("click",e=>{
  e.stopPropagation();
  userMenu.classList.toggle("open");
});
document.addEventListener("click",()=>userMenu.classList.remove("open"));
document.getElementById("viewProfileItem").addEventListener("click",e=>{
  e.stopPropagation();
  alert(JSON.stringify(currentUserDoc || {},null,2));
});
document.getElementById("editProfileItem").addEventListener("click",e=>{
  e.stopPropagation();openProfileModal();
});
document.getElementById("logoutItem").addEventListener("click",async e=>{
  e.stopPropagation();
  try{await auth.signOut();}catch(err){alert("Chiqishda xatolik: "+err.message);}
});

function openProfileModal(){
  if(!currentUserDoc) return;
  fullNameInput.value = currentUserDoc.fullName || "";
  roleSelect.value    = currentUserDoc.role || "";
  birthYearInput.value= currentUserDoc.birthYear || "";
  if(currentUserDoc.role==="oquvchi"){
    classField.style.display="block";
    classSelect.value=currentUserDoc.class || "";
  }else{
    classField.style.display="none";
    classSelect.value="";
  }
  profileModal.classList.add("open");
}
function closeProfileModal(){profileModal.classList.remove("open");}
document.querySelectorAll("[data-close-profile]").forEach(btn=>btn.addEventListener("click", closeProfileModal));
roleSelect.addEventListener("change",()=>{
  if(roleSelect.value==="oquvchi") classField.style.display="block";
  else{classField.style.display="none";classSelect.value="";}
});
saveProfileBtn.addEventListener("click",async ()=>{
  if(!currentUser) return;
  const fullName = fullNameInput.value.trim();
  const role     = roleSelect.value;
  const birthYear= birthYearInput.value ? parseInt(birthYearInput.value,10):null;
  const classVal = role==="oquvchi" && classSelect.value ? parseInt(classSelect.value,10):null;
  if(!fullName || !role || !birthYear || (role==="oquvchi" && !classVal)){
    alert("Barcha zarur maydonlarni to‚Äòldiring.");return;
  }
  try{
    await db.collection("users").doc(currentUser.uid).update({fullName,role,birthYear,class:classVal});
    closeProfileModal();
  }catch(err){alert("Profilni saqlashda xatolik: "+err.message);}
});

async function loadCards(){
  try{
    const res = await fetch(cardsUrl);
    if(!res.ok) throw new Error("cards.json topilmadi");
    const data = await res.json();
    if(!Array.isArray(data)) throw new Error("cards.json massiv bo‚Äòlishi kerak");
    state.cards = data;
    buildMenusAndChips();
    renderMenu();renderChips();renderCards();
  }catch(err){
    console.error(err);
    cardGrid.innerHTML = "<div class='empty'>cards.json yuklashda muammo: "+err.message+"</div>";
  }
}
function buildMenusAndChips(){
  const menus = new Map();
  const chipsByMenu = {};
  for(const card of state.cards){
    const menu = card.menu || "Boshqa";
    menus.set(menu,(menus.get(menu)||0)+1);
    if(!chipsByMenu[menu]) chipsByMenu[menu] = new Set();
    const chips = Array.isArray(card.chips)?card.chips:[];
    for(const ch of chips) chipsByMenu[menu].add(ch);
  }
  state.menus = Array.from(menus.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
  state.chipsByMenu = {};
  for(const [menu] of state.menus) state.chipsByMenu[menu] = Array.from(chipsByMenu[menu] || []);
  if(!state.currentMenu && state.menus.length) state.currentMenu = state.menus[0][0];
  if(!state.currentChip) state.currentChip = "Hammasi";
}
function renderMenu(){
  menuList.innerHTML="";
  if(!state.menus.length){
    menuList.innerHTML="<div class='helper'>cards.json ichida hech qanday menu yo‚Äòq.</div>";
    return;
  }
  for(const [menuName,count] of state.menus){
    const item = document.createElement("div");
    item.className="menu-item"+(menuName===state.currentMenu?" active":"");
    item.innerHTML=`<span>${menuName}</span><span class="count">${count}</span>`;
    item.addEventListener("click",()=>{
      state.currentMenu=menuName;state.currentChip="Hammasi";
      renderMenu();renderChips();renderCards();
    });
    menuList.appendChild(item);
  }
}
function renderChips(){
  chipRow.innerHTML="";
  if(!state.currentMenu){
    chipRow.innerHTML="<div class='helper'>Menyu tanlang.</div>";return;
  }
  const chips = state.chipsByMenu[state.currentMenu] || [];
  const allChip = document.createElement("button");
  allChip.className="chip"+(state.currentChip==="Hammasi"?" active":"");
  allChip.innerHTML=`<span class="dot"></span><span>Hammasi</span>`;
  allChip.addEventListener("click",()=>{
    state.currentChip="Hammasi";renderChips();renderCards();
  });
  chipRow.appendChild(allChip);
  chips.forEach(ch=>{
    const btn=document.createElement("button");
    btn.className="chip"+(state.currentChip===ch?" active":"");
    btn.innerHTML=`<span class="dot"></span><span>${ch}</span>`;
    btn.addEventListener("click",()=>{
      state.currentChip=ch;renderChips();renderCards();
    });
    chipRow.appendChild(btn);
  });
}
function cardMatchesFilters(card){
  if(card.menu!==state.currentMenu) return false;
  if(state.currentChip && state.currentChip!=="Hammasi"){
    const list = Array.isArray(card.chips)?card.chips:[];
    if(!list.includes(state.currentChip)) return false;
  }
  return true;
}
function isRecommendedForUser(card){
  if(!currentUserDoc) return false;
  const u = currentUserDoc;
  const minClass = card.minClass || null;
  const maxClass = card.maxClass || null;
  const classVal = u.class || null;
  if(minClass && classVal && classVal<minClass) return false;
  if(maxClass && classVal && classVal>maxClass) return false;
  if(card.visibleRoles && Array.isArray(card.visibleRoles) && u.role){
    if(!card.visibleRoles.includes(u.role) && !card.visibleRoles.includes("guest")) return false;
  }
  return true;
}
function renderCards(){
  cardGrid.innerHTML="";
  if(!state.currentMenu){
    emptyState.style.display="block";
    emptyState.textContent="Menyu tanlang.";return;
  }
  const filtered = state.cards.filter(cardMatchesFilters);
  if(!filtered.length){
    emptyState.style.display="block";
    emptyState.textContent="Ushbu menu + chip bo‚Äòyicha card topilmadi.";return;
  }
  emptyState.style.display="none";
  for(const card of filtered){
    const div=document.createElement("article");
    const rec=isRecommendedForUser(card);
    div.className="card"+(rec?" recommended":"");
    const imageUrl = card.imageUrl || "./img/placeholder-16x9.png";
    const title = card.title || "Nomlanmagan card";
    const subtitle = card.subtitle || "";
    const chips = Array.isArray(card.chips)?card.chips:[];
    const buttonLabel = card.buttonLabel || "Boshlash";
    const buttonUrl = card.buttonUrl || "#";
    const classLabel = card.classLabel || (card.minClass || card.maxClass ? `${card.minClass || ""}-${card.maxClass || ""} sinf` : "");
    const roleLabel = card.roleLabel || "";
    div.innerHTML = `
      <div class="card-img-wrap">
        <img src="${imageUrl}" alt="">
        ${card.badge ? `<div class="card-tag">${card.badge}</div>` : ""}
      </div>
      <div class="card-body">
        <div class="card-title">${title}</div>
        ${subtitle ? `<div class="card-sub">${subtitle}</div>` : ""}
        <div class="card-meta-row">
          <div class="class-pill">${classLabel || "Sinf: aralash"}</div>
          <div class="role-pill">${roleLabel || "Rol: hamma"}</div>
        </div>
        <div class="chips-inline">
          ${chips.map(ch=>`<span>${ch}</span>`).join("")}
        </div>
        <div class="card-footer">
          <button class="card-cta" data-url="${buttonUrl}">
            <span>${buttonLabel}</span><span class="icon">‚ûú</span>
          </button>
          <div class="card-xp">
            +${card.xp || 5} XP
          </div>
        </div>
      </div>
    `;
    const btn=div.querySelector(".card-cta");
    btn.addEventListener("click",e=>{
      e.preventDefault();
      const url=btn.getAttribute("data-url");
      if(!url || url==="#") return;
      showAdThenGo(url);
    });
    cardGrid.appendChild(div);
  }
}
let adTimer=null;
async function showAdThenGo(targetUrl){
  let html="";
  let attempts=0;
  while(attempts<ADS_MAX && !html){
    const idx=1+Math.floor(Math.random()*ADS_MAX);
    const path=`./ads/ads${idx}.html`;
    try{
      const res=await fetch(path);
      if(res.ok){html=await res.text();break;}
    }catch(e){}
    attempts++;
  }
  if(!html){window.location.href=targetUrl;return;}
  adInner.innerHTML=html;
  adModal.classList.add("open");
  let remaining=5;
  adCountdown.textContent=remaining+" soniya qoldi...";
  if(adTimer) clearInterval(adTimer);
  adTimer=setInterval(()=>{
    remaining--;
    if(remaining<=0){
      clearInterval(adTimer);adTimer=null;
      adModal.classList.remove("open");adInner.innerHTML="";
      window.location.href=targetUrl;
    }else adCountdown.textContent=remaining+" soniya qoldi...";
  },1000);
}
window.addEventListener("DOMContentLoaded", ()=>{loadCards();});
</script>
</body>
</html>
