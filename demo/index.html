<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <title>LeaderMath.uz — O'quvchilar Uchun Intellekt Maydoni</title>

  <!-- Favicon -->
  <link rel="icon" href="logo.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="logo.png" />
  <meta name="theme-color" content="#007AFF">

  <!-- PWA meta tags -->
  <meta name="application-name" content="LeaderMath.uz">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="LeaderMath">
  <meta name="format-detection" content="telephone=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="msapplication-TileColor" content="#007AFF">
  <meta name="msapplication-tap-highlight" content="no">
  <meta name="theme-color" content="#007AFF">
  <meta name="description" content="Matematika o'qitishning yangi avlod platformasi">

  <!-- iOS icons -->
  <link rel="apple-touch-icon" href="logo.png">
  <link rel="apple-touch-icon" sizes="152x152" href="logo.png">
  <link rel="apple-touch-icon" sizes="180x180" href="logo.png">
  <link rel="apple-touch-icon" sizes="167x167" href="logo.png">

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.webmanifest">

  <!-- Font Awesome -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* =============== MAIN STYLES (OLD DESIGN WITH IMPROVEMENTS) =============== */
    :root {
      --brand: #007AFF;
      --bg: #F2F2F7;
      --text: #1C1C1E;
      --muted: #8E8E93;
      --shell-radius: 16px;
      --card-radius: 12px;
      --shadow: 0 4px 16px rgba(0,0,0,0.08);
      --border: #C6C6C8;
      --surface: #FFFFFF;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #000000;
        --text: #FFFFFF;
        --muted: #8E8E93;
        --border: #38383A;
        --surface: #1C1C1E;
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      min-height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      line-height: 1.4;
    }

    body {
      display: flex;
      justify-content: center;
    }

    /* =============== APP CONTAINER =============== */
    .app {
      width: 100%;
      max-width: 768px;
      min-height: 100vh;
      background: var(--surface);
    }

    /* =============== HEADER - OLD DESIGN =============== */
    header {
      position: sticky;
      top: 0;
      z-index: 100;
      padding: 12px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(20px);
      background: rgba(var(--surface-rgb), 0.95);
    }

    .header-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0;
      background: transparent;
      border: none;
      box-shadow: none;
    }

    .logo-img {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      object-fit: cover;
      box-shadow: 0 4px 12px rgba(0,122,255,0.3);
    }

    .header-text {
      flex: 1;
    }

    .brand-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }

    .header-sub {
      font-size: 13px;
      color: var(--muted);
      margin-top: 2px;
    }

    .header-id-chip {
      font-size: 12px;
      padding: 6px 12px;
      background: var(--bg);
      border-radius: 20px;
      border: 1px solid var(--border);
      color: var(--muted);
      white-space: nowrap;
    }

    .header-tag {
      padding: 8px 16px;
      background: var(--bg);
      border-radius: 20px;
      border: 1px solid var(--border);
      color: var(--brand);
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .header-tag:hover {
      background: rgba(0,122,255,0.1);
    }

    /* =============== MAIN CONTENT =============== */
    main {
      padding: 16px;
      padding-bottom: 80px; /* Space for bottom nav */
    }

    .section-shell {
      background: var(--surface);
      border-radius: var(--shell-radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 20px 16px;
      margin-bottom: 16px;
    }

    .section-header {
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text);
    }

    .section-title i {
      color: var(--brand);
    }

    .section-sub {
      font-size: 14px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* =============== CARD GRID - OLD DESIGN =============== */
    .card-list {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    }

    .card {
      background: var(--surface);
      border-radius: var(--card-radius);
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      overflow: hidden;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      border-color: var(--brand);
    }

    .card-img-wrap {
      background: linear-gradient(135deg, #F0F5FF, #E6F0FF);
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      aspect-ratio: 16/9;
      padding: 20px;
    }

    .card-img-wrap img {
      max-width: 80%;
      max-height: 80%;
      object-fit: contain;
      transition: transform 0.3s ease;
    }

    .card:hover .card-img-wrap img {
      transform: scale(1.05);
    }

    .card-label {
      position: absolute;
      left: 12px;
      top: 12px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      background: rgba(0,0,0,0.8);
      color: white;
      display: flex;
      align-items: center;
      gap: 6px;
      backdrop-filter: blur(10px);
    }

    .card-body {
      padding: 16px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .card-desc {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .card-meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .card-meta-left {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dot {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: var(--brand);
    }

    .card-tag-mini {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 20px;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--muted);
    }

    /* =============== BUTTONS =============== */
    .btn {
      border: none;
      outline: none;
      border-radius: 10px;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(135deg, var(--brand), #5856D6);
      color: white;
      box-shadow: 0 4px 16px rgba(0,122,255,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s ease;
      width: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,122,255,0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    /* =============== MATHLEAGUE SECTION - OLD TIMER STYLE =============== */
    .mathleague-section {
      background: var(--surface);
      border-radius: var(--shell-radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 20px 16px;
      margin-top: 16px;
      margin-bottom: 16px;
    }

    .mathleague-section .section-header {
      text-align: center;
      margin-bottom: 24px;
    }

    .mathleague-section .section-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .mathleague-section .section-title:before {
      content: "★";
      color: #FF9500;
      font-size: 18px;
    }

    .mathleague-section .section-subtitle {
      font-size: 14px;
      color: var(--muted);
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.5;
    }

    /* MathLeague cards */
    .mathleague-section .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .mathleague-section .card {
      background: linear-gradient(145deg, var(--surface), var(--bg));
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,122,255,0.08);
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .mathleague-section .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 24px rgba(0,122,255,0.15);
      border-color: var(--brand);
    }

    .mathleague-section .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--brand), #5856D6);
      border-radius: 12px 12px 0 0;
    }

    .mathleague-section .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .mathleague-section .card-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: rgba(0,122,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--brand);
      font-size: 18px;
    }

    .mathleague-section .card h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin: 0;
    }

    .mathleague-section .card-desc {
      font-size: 14px;
      color: var(--muted);
      line-height: 1.5;
      margin-bottom: 16px;
      flex-grow: 0;
    }

    /* Timer container - OLD STYLE */
    .mathleague-section .timer-container {
      background: linear-gradient(135deg, #F0F9FF, #E0F2FE);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      margin-bottom: 16px;
      border: 1px solid rgba(0,122,255,0.2);
    }

    .mathleague-section .timer {
      font-size: 36px;
      font-weight: 800;
      font-family: 'Inter', monospace;
      background: linear-gradient(135deg, var(--brand), #5856D6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: 1px;
      margin-bottom: 4px;
      line-height: 1.2;
    }

    .mathleague-section .timer-label {
      font-size: 12px;
      color: var(--muted);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Stats preview */
    .mathleague-section .stats-preview {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }

    .mathleague-section .stat {
      background: rgba(255,255,255,0.8);
      border-radius: 10px;
      padding: 12px 8px;
      text-align: center;
      border: 1px solid var(--border);
    }

    .mathleague-section .stat-value {
      display: block;
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 2px;
      line-height: 1;
    }

    .mathleague-section .stat-label {
      display: block;
      font-size: 11px;
      color: var(--muted);
      font-weight: 500;
    }

    /* Info list */
    .mathleague-section .info-list {
      margin: 0 0 16px 0;
      padding-left: 0;
      list-style: none;
    }

    .mathleague-section .info-list li {
      position: relative;
      padding-left: 20px;
      margin-bottom: 8px;
      font-size: 14px;
      color: var(--muted);
      line-height: 1.4;
    }

    .mathleague-section .info-list li::before {
      content: "✓";
      position: absolute;
      left: 0;
      color: #34C759;
      font-weight: bold;
      font-size: 16px;
    }

    /* Card actions */
    .mathleague-section .card-actions {
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .mathleague-section .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 10px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s ease;
      width: 100%;
    }

    .mathleague-section .btn-primary {
      background: linear-gradient(135deg, var(--brand), #5856D6);
      color: white;
      box-shadow: 0 4px 12px rgba(0,122,255,0.3);
    }

    .mathleague-section .btn-primary:hover:not(.disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,122,255,0.4);
    }

    .mathleague-section .status {
      font-size: 12px;
      text-align: center;
      padding: 8px;
      background: var(--bg);
      border-radius: 8px;
      color: var(--muted);
      font-weight: 500;
    }

    /* =============== BOTTOM NAVIGATION =============== */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      padding: 12px 0;
      z-index: 90;
      max-width: 768px;
      margin: 0 auto;
      backdrop-filter: blur(20px);
      background: rgba(var(--surface-rgb), 0.95);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 4px 12px;
      background: none;
      border: none;
      color: var(--muted);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
    }

    .nav-item.active {
      color: var(--brand);
    }

    .nav-item:hover {
      color: var(--brand);
    }

    .nav-icon {
      font-size: 20px;
    }

    /* =============== MODAL STYLES =============== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: var(--surface);
      border-radius: 16px;
      padding: 0;
      max-width: 800px;
      width: 100%;
      box-shadow: 0 25px 50px rgba(0,0,0,0.5);
      animation: slideUp 0.4s ease;
      max-height: 90vh;
      overflow: hidden;
    }

    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: linear-gradient(90deg, var(--brand), #5856D6);
      color: white;
    }

    .modal-header h4 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .modal-close {
      background: rgba(255,255,255,0.2);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: white;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: rgba(255,255,255,0.3);
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 0;
      height: calc(90vh - 64px);
    }

    #rating-iframe {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }

    /* =============== PROFILE MODAL =============== */
    .profile-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(20px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .profile-overlay.open {
      display: flex;
    }

    .profile-dialog {
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      background: var(--surface);
      border-radius: 16px;
      padding: 0;
      box-shadow: 0 25px 50px rgba(0,0,0,0.5);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .profile-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: linear-gradient(90deg, var(--brand), #5856D6);
      color: white;
    }

    .profile-title {
      font-size: 20px;
      font-weight: 700;
    }

    .profile-sub {
      font-size: 14px;
      opacity: 0.9;
      margin-top: 4px;
    }

    .profile-close {
      background: rgba(255,255,255,0.2);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: white;
      transition: all 0.2s ease;
    }

    .profile-close:hover {
      background: rgba(255,255,255,0.3);
    }

    .profile-body {
      flex: 1;
      overflow: auto;
      padding: 20px;
    }

    /* Profile View */
    .profile-view {
      margin-bottom: 20px;
      padding: 20px;
      border-radius: 12px;
      background: var(--bg);
      border: 1px solid var(--border);
    }

    .profile-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      overflow: hidden;
      border: 3px solid var(--brand);
      margin-bottom: 16px;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .profile-name {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
    }

    .profile-summary-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }

    .chip {
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--brand);
    }

    .profile-summary-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }

    .summary-row:last-child {
      border-bottom: none;
    }

    .summary-row span {
      color: var(--muted);
    }

    /* Profile Form */
    .profile-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .profile-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 14px;
      color: var(--text);
    }

    .profile-field label {
      font-weight: 600;
      font-size: 14px;
    }

    .profile-field input,
    .profile-field select {
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 14px;
      outline: none;
      background: var(--surface);
      color: var(--text);
    }

    .profile-field input:focus,
    .profile-field select:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(0,122,255,0.1);
    }

    .profile-actions {
      margin-top: 20px;
      display: flex;
      justify-content: flex-end;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .profile-actions-left {
      margin-right: auto;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .profile-btn-primary,
    .profile-btn-secondary {
      border: none;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }

    .profile-btn-primary {
      background: linear-gradient(135deg, var(--brand), #5856D6);
      color: white;
      box-shadow: 0 4px 12px rgba(0,122,255,0.3);
    }

    .profile-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,122,255,0.4);
    }

    .profile-btn-secondary {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
    }

    .profile-btn-secondary:hover {
      background: var(--bg);
      border-color: var(--border);
      transform: translateY(-1px);
    }

    /* =============== RESPONSIVE DESIGN =============== */
    @media (max-width: 768px) {
      .card-list {
        grid-template-columns: 1fr;
      }
      
      .mathleague-section .cards {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .mathleague-section .timer {
        font-size: 28px;
      }
      
      main {
        padding-bottom: 70px;
      }
      
      .header-id-chip {
        display: none;
      }
    }

    @media (min-width: 768px) and (max-width: 1024px) {
      .card-list {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* =============== FOOTER =============== */
    footer {
      padding: 20px 16px;
      background: var(--bg);
      border-top: 1px solid var(--border);
      margin-top: 32px;
    }

    .footer-card {
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0;
      font-size: 12px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .footer-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .footer-name {
      font-size: 12px;
      font-weight: 600;
      color: var(--brand);
      letter-spacing: .08em;
      text-transform: uppercase;
    }

    .footer-right {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      justify-content: flex-end;
    }

    .footer-link {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px dashed var(--border);
      background: var(--surface);
      color: var(--brand);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <header>
    <div class="header-card">
      <div class="header-text">
        <div class="brand-row">
          <img src="logo.png" alt="LeaderMath" class="logo-img">
          <div class="header-title">LeaderMath.uz</div>
        </div>
        <div class="header-sub">Matematika o'qitishning yangi avlod platformasi</div>
      </div>
      <div class="header-id-chip" id="header-id">ID: —</div>
      <div class="header-tag" id="btn-profile">
        <i class="fa-solid fa-user-circle"></i>
        Profil
      </div>
    </div>
  </header>

  <main>
    <section class="section-shell">
      <div class="section-header">
        <div class="section-title-wrap">
          <div class="section-title">
            <i class="fa-solid fa-layer-group"></i>
            Asosiy bo'limlar
          </div>
          <div class="section-sub">Platformaning eng ko'p ishlatiladigan bo'limlari.</div>
        </div>
      </div>

      <div class="card-list">
        <!-- Onlayn musobaqalar -->
        <div class="card" data-link="comingsoon.html">
          <div class="card-img-wrap">
            <img src="img/musobaqa.png" alt="Onlayn musobaqalar" loading="lazy">
            <div class="card-label">
              <i class="fa-solid fa-trophy"></i> Onlayn musobaqalar
            </div>
          </div>
          <div class="card-body">
            <div class="card-title">Onlayn musobaqalar</div>
            <div class="card-desc">
              Maktablar va guruhlar uchun reyting bilan musobaqalar, turnir jadvali va ballar.
            </div>
            <div class="card-meta-row">
              <div class="card-meta-left">
                <span class="dot"></span>
                <span>Real vaqtda natijalar</span>
              </div>
              <span class="card-tag-mini">Turnirlar</span>
            </div>
          </div>
        </div>

        <!-- Testlar -->
        <div class="card" data-link="comingsoon.html">
          <div class="card-img-wrap">
            <img src="img/testlar.png" alt="Testlar" loading="lazy">
            <div class="card-label">
              <i class="fa-solid fa-file-pen"></i> Testlar
            </div>
          </div>
          <div class="card-body">
            <div class="card-title">Testlar</div>
            <div class="card-desc">
              Onlayn testlar, vaqt va savol turlari — tayyorgarlik uchun qulay vosita.
            </div>
            <div class="card-meta-row">
              <div class="card-meta-left">
                <span class="dot"></span>
                <span>Vaqt va avtomatik baholash</span>
              </div>
              <span class="card-tag-mini">Amaliy mashqlar</span>
            </div>
          </div>
        </div>

        <!-- Darslar -->
        <div class="card" data-link="comingsoon.html">
          <div class="card-img-wrap">
            <img src="img/darslar.png" alt="Darslar" loading="lazy">
            <div class="card-label">
              <i class="fa-solid fa-chalkboard-teacher"></i> Darslar
            </div>
          </div>
          <div class="card-body">
            <div class="card-title">Darslar</div>
            <div class="card-desc">
              Video darslar, prezentatsiyalar va darslik materiallari — mavzuga oid to'plam.
            </div>
            <div class="card-meta-row">
              <div class="card-meta-left">
                <span class="dot"></span>
                <span>Bo'lim va mavzu bo'yicha tartiblangan</span>
              </div>
              <span class="card-tag-mini">Ta'lim resurslari</span>
            </div>
          </div>
        </div>

        <!-- Simulyatorlar -->
        <div class="card" data-link="sim.html">
          <div class="card-img-wrap">
            <img src="img/simulation.png" alt="Simulyatorlar" loading="lazy">
            <div class="card-label">
              <i class="fa-solid fa-robot"></i>Ta'lim Simulyatorlar
            </div>
          </div>
          <div class="card-body">
            <div class="card-title">Ta'lim Simulyatorlar</div>
            <div class="card-desc">
              Interaktiv mashqlar va o'yinlar — nazariyani amaliyotga aylantirish uchun.
            </div>
            <div class="card-meta-row">
              <div class="card-meta-left">
                <span class="dot"></span>
                <span>Interaktiv va vizual</span>
              </div>
              <span class="card-tag-mini">Amaliy simulyatsiyalar</span>
            </div>
          </div>
        </div>

        <!-- ITMA -->
        <div class="card" data-link="itma.html">
          <div class="card-img-wrap">
            <img src="img/itma.webp" alt="ITMA" loading="lazy">
            <div class="card-label">
              <i class="fa-solid fa-school"></i>ITMA
            </div>
          </div>
          <div class="card-body">
            <div class="card-title">Ixtisoslashtirilgan ta'lim muassasalari agentligi</div>
            <div class="card-desc">
              CHSB va BSB larga tayyorgarlik.
            </div>
            <div class="card-meta-row">
              <div class="card-meta-left">
                <span class="dot"></span>
                <span>DEMO variantlar</span>
              </div>
              <span class="card-tag-mini">CHSB va BSB</span>
            </div>
          </div>
        </div>

        <!-- Reyting -->
        <div class="card" data-link="comingsoon.html">
          <div class="card-img-wrap">
            <img src="img/star.png" alt="Reyting" loading="lazy">
            <div class="card-label">
              <i class="fa-solid fa-star"></i> Reyting
            </div>
          </div>
          <div class="card-body">
            <div class="card-title">Reyting</div>
            <div class="card-desc">
              Foydalanuvchi va maktab reytingi, ballar tarixi va yillik ko'rsatkichlar.
            </div>
            <div class="card-meta-row">
              <div class="card-meta-left">
                <span class="dot"></span>
                <span>Guruh va individual ko'rsatkich</span>
              </div>
              <span class="card-tag-mini">Liderlar jadvali</span>
            </div>
          </div>
        </div>
      </div>
    </section>
    
    <section id="mathleague" class="mathleague-section" aria-labelledby="mathleague-title">
      <div class="section-header">
        <h2 id="mathleague-title" class="section-title">MathLeague</h2>
        <p class="section-subtitle">Haftalik matematika musobaqalari va reyting tizimi</p>
      </div>

      <div class="cards">
        <!-- Card 1: Timer + Start -->
        <article class="card" id="card-timer" aria-labelledby="card-timer-title">
          <div class="card-header">
            <div class="card-icon">
              <i class="fas fa-clock"></i>
            </div>
            <h3 id="card-timer-title">Haftalik MathCup</h3>
          </div>
          
          <p class="card-desc">Har shanba 20:00 da boshlanadi. Boshlash tugmasi 20:00–20:05 oralig'ida ochiladi — kirish 21:00 da yopiladi.</p>

          <div class="timer-container">
            <div class="timer" id="timer-display" aria-live="polite">Yuklanmoqda...</div>
            <div class="timer-label">Keyingi boshlanishgacha</div>
          </div>

          <div class="card-actions">
            <a id="start-button" class="btn btn-primary disabled" href="mathcup.html" role="button" aria-disabled="true">
              <i class="fas fa-play"></i>
              <span>Boshlash</span>
            </a>
            <div id="status-text" class="status">—</div>
          </div>
        </article>

        <!-- Card 2: Rating with modal -->
        <article class="card" id="card-rating" aria-labelledby="card-rating-title">
          <div class="card-header">
            <div class="card-icon">
              <i class="fas fa-trophy"></i>
            </div>
            <h3 id="card-rating-title">Reyting</h3>
          </div>
          
          <p class="card-desc">Oxirgi MathCup reytinglarini ko'rish va o'z o'rningizni taqqoslash.</p>
          
          <div class="stats-preview">
            <div class="stat">
              <span class="stat-value">50+</span>
              <span class="stat-label">Ishtirokchi</span>
            </div>
            <div class="stat">
              <span class="stat-value">10</span>
              <span class="stat-label">Savol</span>
            </div>
            <div class="stat">
              <span class="stat-value">60 daqiqa</span>
              <span class="stat-label">Vaqt</span>
            </div>
          </div>
          
          <div class="card-actions">
            <button id="open-rating" class="btn btn-primary">
              <i class="fas fa-chart-bar"></i>
              <span>Reytingni ko'rish</span>
            </button>
          </div>
        </article>

        <!-- Card 3: Info -->
        <article class="card" id="card-info" aria-labelledby="card-info-title">
          <div class="card-header">
            <div class="card-icon">
              <i class="fas fa-info-circle"></i>
            </div>
            <h3 id="card-info-title">Qoida va Ma'lumot</h3>
          </div>
          
          <p class="card-desc">Musobaqa qoidalari, ballash tizimi va batafsil ma'lumotlar bilan tanishish.</p>
          
          <ul class="info-list">
            <li>Har bir savol - alohida ball</li>
            <li>Tez javob - qo'shimcha ball</li>
            <li>Har bir ishtirokchi uchun sertifikat</li>
            <li>Yil yakuni - g'oliblar sovrini</li>
          </ul>
          
          <div class="card-actions">
            <a class="btn btn-primary" href="mathleagueinfo.html">
              <i class="fas fa-external-link-alt"></i>
              <span>Batafsil ma'lumot</span>
            </a>
          </div>
        </article>
      </div>

      <!-- Rating modal -->
      <div id="rating-modal" class="modal-overlay">
        <div class="modal-content">
          <div class="modal-header">
            <h4>MathCup Reytingi</h4>
            <button id="close-modal" class="modal-close" aria-label="Yopish">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <iframe id="rating-iframe" src="mathcupreting.html" title="MathCup Reytingi" frameborder="0"></iframe>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer>
    <div class="footer-card">
      <div class="footer-left">
        <div class="footer-name">LeaderMath.uz</div>
        <div>LeaderMath.uz — Raqamli Matematika Platformasi</div>
      </div>
      <div class="footer-right">
        <a href="#" class="footer-link">
          <i class="fa-brands fa-telegram"></i>
          Telegram bot
        </a>
        <a href="#" class="footer-link">
          <i class="fa-solid fa-link"></i>
          App ulanish
        </a>
      </div>
    </div>
  </footer>
</div>

<!-- BOTTOM NAVIGATION -->
<nav class="bottom-nav">
  <a href="index.html" class="nav-item active">
    <i class="fas fa-home nav-icon"></i>
    Bosh sahifa
  </a>
  <a href="comingsoon.html" class="nav-item">
    <i class="fas fa-trophy nav-icon"></i>
    Musobaqalar
  </a>
  <a href="comingsoon.html" class="nav-item">
    <i class="fas fa-book nav-icon"></i>
    Darslar
  </a>
  <a href="game.html" class="nav-item">
    <i class="fas fa-gamepad nav-icon"></i>
    Game
  </a>
</nav>

<!-- PROFILE MODAL -->
<div id="profile-overlay" class="profile-overlay">
  <div class="profile-dialog">
    <div class="profile-header">
      <div>
        <div class="profile-title">Profil ma'lumotlari</div>
        <div class="profile-sub">
          Ism familiya, tug'ilgan sana, viloyat va tuman/shaharni kiriting
        </div>
      </div>
      <button type="button" class="profile-close" id="profile-close-btn">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <div class="profile-body">
      <!-- VIEW REJIM -->
      <div id="profile-view" class="profile-view">
        <div class="profile-avatar">
          <img src="logo.png" alt="Profil" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 100 100\"><circle cx=\"50\" cy=\"50\" r=\"45\" fill=\"%23007AFF\"/><text x=\"50\" y=\"60\" font-family=\"Arial\" font-size=\"40\" fill=\"white\" text-anchor=\"middle\">LM</text></svg>';">
        </div>
        
        <div class="profile-summary-main">
          <div class="profile-name" id="pv-fullname">Foydalanuvchi</div>
          <div class="profile-summary-meta">
            <span class="chip" id="pv-id">ID: —</span>
            <span class="chip" id="pv-age">Yoshi: —</span>
            <span class="chip" id="pv-points">0 ball</span>
            <span class="chip" id="pv-rank">Yangi</span>
          </div>
        </div>
        
        <div class="profile-summary-grid">
          <div class="summary-row">
            <span>Viloyat:</span>
            <strong id="pv-region">—</strong>
          </div>
          <div class="summary-row">
            <span>Tuman / shahar:</span>
            <strong id="pv-district">—</strong>
          </div>
          <div class="summary-row">
            <span>Tug'ilgan sana:</span>
            <strong id="pv-birthdate">—</strong>
          </div>
          <div class="summary-row">
            <span>Qo'shilgan sana:</span>
            <strong id="pv-joindate">—</strong>
          </div>
        </div>
      </div>

      <!-- EDIT REJIM -->
      <form id="profile-form" class="profile-form" style="display: none;">
        <div class="profile-field">
          <label>Ism familiya</label>
          <input type="text" id="pf-fullname" placeholder="Familiya Ism Sharif" required>
        </div>
        
        <div class="profile-field">
          <label>Tug'ilgan sana</label>
          <input type="date" id="pf-birthdate" required>
        </div>
        
        <div class="profile-field">
          <label>Viloyat</label>
          <select id="pf-region" required>
            <option value="">Tanlang</option>
          </select>
        </div>
        
        <div class="profile-field">
          <label>Tuman / shahar</label>
          <select id="pf-district" required disabled>
            <option value="">Avval viloyatni tanlang</option>
          </select>
        </div>
        
        <div class="profile-field">
          <label>Yangi parol (ixtiyoriy)</label>
          <input type="password" id="pf-new-password" minlength="6"
                 placeholder="Kamida 6 ta belgi">
        </div>
        
        <div class="profile-field">
          <label>Yangi parol takrori</label>
          <input type="password" id="pf-new-password2" minlength="6"
                 placeholder="Yangi parolni takrorlang">
        </div>
      </form>
    </div>

    <div class="profile-actions">
      <div class="profile-actions-left">
        <button type="button" class="profile-btn-secondary" id="btn-install-pwa">
          <i class="fa-solid fa-download"></i>
          Ilovani o'rnatish
        </button>

        <button type="button" class="profile-btn-secondary" id="profile-logout-btn">
          <i class="fa-solid fa-arrow-right-from-bracket"></i>
          Chiqish
        </button>
      </div>

      <!-- VIEW rejim tugmalari -->
      <button type="button" class="profile-btn-secondary" id="profile-close-view-btn">
        Yopish
      </button>
      <button type="button" class="profile-btn-primary" id="profile-edit-btn">
        <i class="fa-solid fa-pen-to-square"></i>
        Tahrirlash
      </button>

      <!-- EDIT rejim tugmalari -->
      <button type="button" class="profile-btn-secondary" id="profile-cancel-btn" style="display: none;">
        Bekor qilish
      </button>
      <button type="submit" form="profile-form" class="profile-btn-primary" id="profile-save-btn" style="display: none;">
        <i class="fa-solid fa-floppy-disk"></i>
        Saqlash
      </button>
    </div>
  </div>
</div>

<script src="auth-utils.js"></script>
<script>
  /* =============== FIREBASE INIT =============== */
  const db = firebase.firestore();
  const USER_COLL = 'foydalanuvchilar';

  /* =============== CARD CLICK HANDLERS =============== */
  document.querySelectorAll('.card[data-link]').forEach(card => {
    card.addEventListener('click', (e) => {
      const link = card.getAttribute('data-link');
      if (link && link !== '#') {
        window.location.href = link;
      }
    });
  });

  /* =============== PROFILE MANAGEMENT =============== */
  const profOverlay = document.getElementById('profile-overlay');
  const profBtn = document.getElementById('btn-profile');
  const profCloseX = document.getElementById('profile-close-btn');
  const profCloseV = document.getElementById('profile-close-view-btn');
  const profEditBtn = document.getElementById('profile-edit-btn');
  const profCancel = document.getElementById('profile-cancel-btn');
  const profLogout = document.getElementById('profile-logout-btn');
  const profForm = document.getElementById('profile-form');
  const viewBlock = document.getElementById('profile-view');

  // Form elements
  const pfFullname = document.getElementById('pf-fullname');
  const pfBirth = document.getElementById('pf-birthdate');
  const pfRegion = document.getElementById('pf-region');
  const pfDistrict = document.getElementById('pf-district');
  const pfNewPass = document.getElementById('pf-new-password');
  const pfNewPass2 = document.getElementById('pf-new-password2');

  // View elements
  const pvFullname = document.getElementById('pv-fullname');
  const pvId = document.getElementById('pv-id');
  const pvAge = document.getElementById('pv-age');
  const pvPoints = document.getElementById('pv-points');
  const pvRegion = document.getElementById('pv-region');
  const pvDistrict = document.getElementById('pv-district');
  const pvBirth = document.getElementById('pv-birthdate');
  const pvRank = document.getElementById('pv-rank');
  const pvJoinDate = document.getElementById('pv-joindate');
  const headerIdEl = document.getElementById('header-id');

  let regionsData = null;
  let isEditing = false;
  let isMandatory = false;

  /* =============== LOAD REGIONS =============== */
  async function loadRegions() {
    if (regionsData) return regionsData;
    try {
      const res = await fetch('region.json');
      if (!res.ok) throw new Error('HTTP ' + res.status);
      regionsData = (await res.json()).regions;
      return regionsData;
    } catch (err) {
      console.error('region.json yuklashda xatolik:', err);
      regionsData = [];
      return regionsData;
    }
  }

  function fillRegionSelect() {
    if (!pfRegion || !regionsData) return;
    pfRegion.innerHTML = '<option value="">Tanlang</option>';
    regionsData.forEach(r => {
      const opt = document.createElement('option');
      opt.value = r.name;
      opt.textContent = r.name;
      pfRegion.appendChild(opt);
    });
  }

  function fillDistrictSelect(regionName, selected) {
    if (!pfDistrict) return;
    pfDistrict.disabled = true;
    pfDistrict.innerHTML = '<option value="">Avval viloyatni tanlang</option>';

    if (!regionName || !regionsData) return;
    const reg = regionsData.find(r => r.name === regionName);
    if (!reg) return;

    pfDistrict.disabled = false;
    pfDistrict.innerHTML = '<option value="">Tuman/shaharni tanlang</option>';
    (reg.districts || []).forEach(d => {
      const opt = document.createElement('option');
      opt.value = d.name;
      opt.textContent = d.name;
      pfDistrict.appendChild(opt);
    });

    if (selected) {
      pfDistrict.value = selected;
    }
  }

  /* =============== CALCULATIONS =============== */
  function calcAge(birthDateStr) {
    if (!birthDateStr) return null;
    const d = new Date(birthDateStr);
    if (isNaN(d.getTime())) return null;
    const now = new Date();
    let age = now.getFullYear() - d.getFullYear();
    const m = now.getMonth() - d.getMonth();
    if (m < 0 || (m === 0 && now.getDate() < d.getDate())) age--;
    return age >= 0 ? age : null;
  }

  function calcRank(points) {
    const p = Number(points || 0);
    if (p >= 1000) return "Legend";
    if (p >= 500) return "Ustoz";
    if (p >= 200) return "Faol talaba";
    if (p >= 50) return "Faol foydalanuvchi";
    if (p > 0) return "Yangi ishtirokchi";
    return "Yangi foydalanuvchi";
  }

  function formatDate(dateStr) {
    if (!dateStr) return "—";
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return "—";
    return date.toLocaleDateString('uz-UZ', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  }

  function isProfileComplete(profile) {
    return !!(profile && profile.fullName && profile.birthDate && profile.region && profile.district);
  }

  /* =============== RENDER VIEW =============== */
  function renderView() {
    const currentUser = authUtils.getUser();
    if (!currentUser) return;

    const userData = currentUser.data || {};
    const loginId = userData.loginId || userData.login || authUtils.getConsistentUserId(currentUser) || "—";
    const birth = userData.birthDate || "";
    const region = userData.region || "";
    const district = userData.district || "";
    const points = Number(userData.points || 0);
    const age = calcAge(birth);
    const joinDate = userData.createdAt || userData.joinedAt || "";

    if (pvFullname) pvFullname.textContent = userData.fullName || "Foydalanuvchi";
    if (pvId) pvId.textContent = "ID: " + loginId;
    if (pvAge) pvAge.textContent = age != null ? ("Yoshi: " + age) : "Yoshi: —";
    if (pvPoints) pvPoints.textContent = points + " ball";
    if (pvRegion) pvRegion.textContent = region || "—";
    if (pvDistrict) pvDistrict.textContent = district || "—";
    if (pvBirth) pvBirth.textContent = formatDate(birth);
    if (pvRank) pvRank.textContent = calcRank(points);
    if (pvJoinDate) pvJoinDate.textContent = formatDate(joinDate);

    if (headerIdEl) headerIdEl.textContent = "ID: " + loginId;
  }

  /* =============== EDIT MODE MANAGEMENT =============== */
  function setEditingMode(edit) {
    isEditing = !!edit;

    if (viewBlock) viewBlock.style.display = edit ? 'none' : 'block';
    if (profForm) profForm.style.display = edit ? 'flex' : 'none';

    if (profCloseV) profCloseV.style.display = edit ? 'none' : 'inline-flex';
    if (profEditBtn) profEditBtn.style.display = edit ? 'none' : 'inline-flex';
    if (profCancel) profCancel.style.display = edit ? 'inline-flex' : 'none';
    const saveBtn = document.getElementById('profile-save-btn');
    if (saveBtn) saveBtn.style.display = edit ? 'inline-flex' : 'none';

    if (isMandatory) {
      if (profCloseX) profCloseX.style.display = 'none';
      if (profCloseV) profCloseV.style.display = 'none';
      if (profCancel) profCancel.style.display = 'none';
    } else {
      if (profCloseX) profCloseX.style.display = 'inline-flex';
      if (!edit && profCloseV) profCloseV.style.display = 'inline-flex';
    }
  }

  async function openProfile(mandatory) {
    const currentUser = authUtils.getUser();
    if (!currentUser) {
      alert("Avval tizimga kiring.");
      return;
    }
    
    isMandatory = !!mandatory;

    await loadRegions();
    fillRegionSelect();

    const userData = currentUser.data || {};

    if (pfFullname) pfFullname.value = userData.fullName || '';
    if (pfBirth) pfBirth.value = userData.birthDate || '';
    if (pfRegion) pfRegion.value = userData.region || '';

    if (userData.region) {
      fillDistrictSelect(userData.region, userData.district || '');
    } else if (pfDistrict) {
      pfDistrict.disabled = true;
      pfDistrict.innerHTML = '<option value="">Avval viloyatni tanlang</option>';
    }
    
    if (pfNewPass) pfNewPass.value = '';
    if (pfNewPass2) pfNewPass2.value = '';

    renderView();
    setEditingMode(!!mandatory);

    if (profOverlay) {
      profOverlay.classList.add('open');
      document.body.classList.add('no-scroll');
    }
  }

  function closeProfile() {
    if (isMandatory) return;
    if (profOverlay) profOverlay.classList.remove('open');
    document.body.classList.remove('no-scroll');
  }

  /* =============== EVENT LISTENERS =============== */
  if (profBtn) {
    profBtn.addEventListener('click', () => openProfile(false));
  }
  
  if (profCloseX) {
    profCloseX.addEventListener('click', closeProfile);
  }
  
  if (profCloseV) {
    profCloseV.addEventListener('click', closeProfile);
  }
  
  if (profCancel) {
    profCancel.addEventListener('click', () => {
      if (isMandatory) return;
      const currentUser = authUtils.getUser();
      const userData = currentUser?.data || {};
      
      if (pfFullname) pfFullname.value = userData.fullName || '';
      if (pfBirth) pfBirth.value = userData.birthDate || '';
      if (pfRegion) pfRegion.value = userData.region || '';
      if (userData.region) fillDistrictSelect(userData.region, userData.district || '');
      if (pfNewPass) pfNewPass.value = '';
      if (pfNewPass2) pfNewPass2.value = '';
      setEditingMode(false);
    });
  }
  
  if (profOverlay) {
    profOverlay.addEventListener('click', e => {
      if (e.target === profOverlay) closeProfile();
    });
  }
  
  if (pfRegion) {
    pfRegion.addEventListener('change', () => {
      fillDistrictSelect(pfRegion.value, '');
    });
  }
  
  if (profEditBtn) {
    profEditBtn.addEventListener('click', () => {
      isMandatory = false;
      setEditingMode(true);
    });
  }
  
  if (profLogout) {
    profLogout.addEventListener('click', () => {
      authUtils.logout();
      if (profOverlay) profOverlay.classList.remove('open');
      document.body.classList.remove('no-scroll');
      window.location.href = 'login.html';
    });
  }

  // PROFILNI SAQLASH
  if (profForm) {
    profForm.addEventListener('submit', async e => {
      e.preventDefault();
      
      const currentUser = authUtils.getUser();
      if (!currentUser) {
        alert("Avval tizimga kiring.");
        return;
      }

      const userId = authUtils.getConsistentUserId(currentUser);
      if (!userId) {
        alert("Foydalanuvchi ID si aniqlanmadi.");
        return;
      }

      const fullName = pfFullname.value.trim();
      const birthDate = pfBirth.value;
      const region = pfRegion.value;
      const district = pfDistrict.value;
      const newPass = pfNewPass.value;
      const newPass2 = pfNewPass2.value;

      if (!fullName || !birthDate || !region || !district) {
        alert("Ism, tug'ilgan sana, viloyat va tuman/shahar majburiy.");
        return;
      }

      if (newPass || newPass2) {
        if (newPass.length < 6) {
          alert("Yangi parol kamida 6 ta belgidan iborat bo'lishi kerak.");
          return;
        }
        if (newPass !== newPass2) {
          alert("Yangi parol va uning takrori mos emas.");
          return;
        }
      }

      const payload = {
        fullName,
        birthDate,
        region,
        district,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      if (newPass) {
        payload.password = newPass;
      }

      try {
        await authUtils.updateUserData(payload);
        
        renderView();
        alert("Profil saqlandi" + (newPass ? " va parol yangilandi." : "."));

        if (isMandatory) {
          isMandatory = false;
          closeProfile();
        } else {
          setEditingMode(false);
        }
      } catch (err) {
        console.error('Profil saqlash xatosi:', err);
        alert("Profilni saqlashda xatolik: " + (err.message || err));
      }
    });
  }

  /* =============== PAGE LOAD =============== */
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      // Sessionni tekshirish
      const user = await authUtils.requireSession();
      console.log('Foydalanuvchi:', user);
      
      if (user) {
        renderView();

        // Profil to'liq emasligini tekshirish
        if (!isProfileComplete(user.data)) {
          setTimeout(() => openProfile(true), 1000);
        }
      }
    } catch (e) {
      console.warn('Session yo`q yoki xatolik:', e);
      window.location.href = 'login.html';
    }

    // Foydalanuvchi o'zgarishlarini kuzatish
    authUtils.onUserChange((user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      renderView();
    });
  });

  /* =============== MATHLEAGUE TIMER =============== */
  (function() {
    // Helper: find next Saturday at specified hour/minute
    function nextSaturdayAt(hour, minute) {
      const now = new Date();
      const target = new Date(now);
      const day = now.getDay(); // 0 = Sun, 6 = Sat
      const daysUntilSat = ((6 - day) + 7) % 7; // 0 if today is Saturday
      target.setDate(now.getDate() + daysUntilSat);
      target.setHours(hour, minute, 0, 0);
      // if today is Saturday but time already passed, move 7 days
      if (target <= now) {
        target.setDate(target.getDate() + 7);
      }
      return target;
    }

    // Compute the next relevant times
    function computeWindows(now) {
      const sat = new Date(now);
      const day = now.getDay();
      const daysUntilSat = ((6 - day) + 7) % 7;
      sat.setDate(now.getDate() + daysUntilSat);
      sat.setHours(20, 0, 0, 0); // 20:00

      const start = new Date(sat);
      const startEnd = new Date(sat); 
      startEnd.setMinutes(5); // 20:05
      const entryClose = new Date(sat); 
      entryClose.setHours(21, 0, 0, 0);

      // If we've already passed entryClose (21:00) for this satellite, shift everything by +7 days
      if (now >= entryClose) {
        start.setDate(start.getDate() + 7);
        startEnd.setDate(startEnd.getDate() + 7);
        entryClose.setDate(entryClose.getDate() + 7);
      }

      return { start, startEnd, entryClose };
    }

    // Format remaining time
    function formatRemaining(ms) {
      if (ms <= 0) return "00:00:00";
      const s = Math.floor(ms / 1000);
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
    }

    const timerEl = document.getElementById('timer-display');
    const startBtn = document.getElementById('start-button');
    const statusText = document.getElementById('status-text');

    function refreshUi() {
      const now = new Date();
      const { start, startEnd, entryClose } = computeWindows(now);

      if (now >= start && now < startEnd) {
        // Start window (20:00 - 20:05)
        timerEl.textContent = "00:00:00";
        timerEl.style.background = "linear-gradient(135deg, #34C759, #30B451)";
        timerEl.style.webkitBackgroundClip = "text";
        timerEl.style.webkitTextFillColor = "transparent";
        timerEl.style.backgroundClip = "text";
        startBtn.classList.remove('disabled');
        startBtn.removeAttribute('aria-disabled');
        startBtn.href = 'mathcup.html';
        statusText.textContent = "Boshlash tugmasi ochiq — 20:05 gacha.";
        statusText.style.color = "#34C759";
      } else if (now >= startEnd && now < entryClose) {
        // After start window but before entry close (20:05 - 21:00)
        const rem = entryClose - now;
        timerEl.textContent = formatRemaining(rem);
        timerEl.style.background = "linear-gradient(135deg, #FF9500, #E68500)";
        timerEl.style.webkitBackgroundClip = "text";
        timerEl.style.webkitTextFillColor = "transparent";
        timerEl.style.backgroundClip = "text";
        startBtn.classList.add('disabled');
        startBtn.setAttribute('aria-disabled', 'true');
        startBtn.href = '#';
        statusText.textContent = "Musobaqa davom etmoqda — faqat kuzatish mumkin.";
        statusText.style.color = "#FF9500";
      } else {
        // Before start window OR after entryClose
        let target;
        if (now < start) target = start;
        else target = nextSaturdayAt(20, 0);
        const rem = target - now;
        timerEl.textContent = formatRemaining(rem);
        timerEl.style.background = "linear-gradient(135deg, #007AFF, #5856D6)";
        timerEl.style.webkitBackgroundClip = "text";
        timerEl.style.webkitTextFillColor = "transparent";
        timerEl.style.backgroundClip = "text";
        startBtn.classList.add('disabled');
        startBtn.setAttribute('aria-disabled', 'true');
        startBtn.href = '#';
        statusText.textContent = "Boshlash tugmasi keyingi shanbaga qadar yopiq.";
        statusText.style.color = "#8E8E93";
      }
    }

    // initial refresh and interval
    refreshUi();
    setInterval(refreshUi, 1000);

    // Modal logic for rating
    const openRatingBtn = document.getElementById('open-rating');
    const modal = document.getElementById('rating-modal');
    const closeModalBtn = document.getElementById('close-modal');

    if (openRatingBtn && modal && closeModalBtn) {
      openRatingBtn.addEventListener('click', () => {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      });

      closeModalBtn.addEventListener('click', () => {
        modal.classList.remove('active');
        document.body.style.overflow = '';
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
          document.body.style.overflow = '';
        }
      });

      // keyboard escape close
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
          modal.classList.remove('active');
          document.body.style.overflow = '';
        }
      });
    }

    // Add loading animation to timer
    setTimeout(() => {
      if (timerEl) {
        timerEl.style.transition = 'all 0.3s ease';
      }
    }, 100);
  })();

  /* =============== PWA INSTALLATION =============== */
  let deferredPrompt;
  const installBtn = document.getElementById('btn-install-pwa');

  if (installBtn) {
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-flex';
    });

    installBtn.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          installBtn.style.display = 'none';
          alert('LeaderMath ilovasi muvaffaqiyatli o\'rnatildi!');
        }
        deferredPrompt = null;
      }
    });
  }

  /* =============== SERVICE WORKER =============== */
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js').then(registration => {
        console.log('Service Worker registered:', registration);
      }).catch(err => {
        console.warn('SW register xatolik:', err);
      });
    });
  }
</script>
</body>
</html>