<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Reklama & Card Platforma</title>
  <meta name="theme-color" content="#2E8B57"/>

  <style>
    :root{
      --brand:#2E8B57; --brand-dark:#1F6B45; --accent:#6B8E23;
      --bg:#F6FBF8; --bg-2:#ECF5EF;
      --card:#FFFFFF; --card-soft:#F8FCF9;
      --text:#0F1B15; --muted:#5E7867;
      --line:#DFEAE3;
      --shadow:0 20px 60px rgba(16,40,26,.16);
      --shadow-soft:0 12px 36px rgba(16,40,26,.12);
      --radius:18px; --pill:999px;
      --speed:.22s;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#E4F1EA 0,#F6FBF8 40%,#FFFFFF 100%);
      color:var(--text);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter:blur(16px);
      background:linear-gradient(120deg,rgba(246,251,248,.96),rgba(232,244,237,.9));
      border-bottom:1px solid rgba(223,234,227,.9);
    }
    .row{
      max-width:1180px; margin:0 auto;
      padding:10px 16px;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
    }
    .logo-wrap{
      display:flex; align-items:center; gap:10px;
    }
    .logo-circle{
      width:32px; height:32px;border-radius:50%;
      background:radial-gradient(circle at 20% 0,#7EE0AB 0,#2E8B57 40%,#1F6B45 100%);
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-weight:800; font-size:18px;
      box-shadow:0 10px 28px rgba(46,139,87,.55);
    }
    .brand-title{
      display:flex; flex-direction:column; line-height:1.1;
    }
    .brand-title span:first-child{
      font-weight:800; letter-spacing:.06em; text-transform:uppercase;
      font-size:12px; color:#1F3A2B;
    }
    .brand-title span:last-child{
      font-size:11px; color:var(--muted);
    }
    .chip-bar{
      position:sticky; top:56px; z-index:15;
      padding:6px 0 2px;
      background:linear-gradient(180deg,rgba(246,251,248,.98),rgba(246,251,248,.92),transparent);
      backdrop-filter:blur(8px);
    }
    .chip-scroll{
      max-width:1180px; margin:0 auto;
      padding:0 16px;
      overflow-x:auto;
      scrollbar-width:none;
    }
    .chip-scroll::-webkit-scrollbar{display:none;}
    .chip-row{
      display:flex; gap:8px; padding:4px 0 8px;
    }
    .chip{
      flex:0 0 auto;
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 11px;
      border-radius:999px;
      background:rgba(255,255,255,.94);
      border:1px solid rgba(223,234,227,.9);
      box-shadow:0 10px 32px rgba(16,40,26,.12);
      font-size:13px;
      cursor:pointer;
      transition:transform var(--speed),box-shadow var(--speed),background var(--speed),border-color var(--speed),color var(--speed);
    }
    .chip span.icon{font-size:15px;}
    .chip small{
      font-size:11px; color:var(--muted);
    }
    .chip.active{
      background:linear-gradient(120deg,#2E8B57,#6B8E23);
      color:#fff;
      border-color:transparent;
      box-shadow:0 16px 48px rgba(46,139,87,.6);
    }
    .chip.active small{color:rgba(255,255,255,.85);}
    main{
      max-width:1180px; margin:12px auto 24px;
      padding:0 16px 24px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .banner-shell{
      position:relative;
      width:100%;
      border-radius:var(--radius);
      overflow:hidden;
      background:#000;
      box-shadow:var(--shadow);
      aspect-ratio:16/9;
    }
    @media(max-width:740px){
      .banner-shell{aspect-ratio:9/16;max-height:70vh;}
    }
    .banner-slide{
      position:absolute; inset:0;
      display:flex; align-items:stretch; justify-content:stretch;
      opacity:0; pointer-events:none;
      transition:opacity .5s ease;
    }
    .banner-slide.active{
      opacity:1; pointer-events:auto;
    }
    .banner-media{
      flex:1 1 55%;
      background:#000 center/cover no-repeat;
    }
    .banner-overlay{
      flex:1 1 45%;
      background:linear-gradient(135deg,rgba(12,35,23,.9),rgba(24,70,41,.96));
      color:#fff;
      padding:16px 16px 14px;
      display:flex; flex-direction:column; justify-content:space-between;
    }
    .banner-tag{
      font-size:11px; text-transform:uppercase; letter-spacing:.16em;
      opacity:.8;
    }
    .banner-title{
      font-size:18px; font-weight:750; margin-top:6px;
    }
    .banner-text{
      font-size:13px; opacity:.92; margin-top:4px;
    }
    .banner-cta-row{
      display:flex; flex-wrap:wrap; gap:8px;
      margin-top:10px;
      align-items:center;
    }
    .banner-cta{
      border-radius:999px;
      padding:7px 14px;
      font-size:13px; font-weight:600;
      text-decoration:none;
      background:#FFCF33;
      color:#2E2A10;
      box-shadow:0 14px 40px rgba(0,0,0,.45);
      transition:transform var(--speed),box-shadow var(--speed),background var(--speed);
    }
    .banner-cta:hover{
      transform:translateY(-1px);
      box-shadow:0 18px 54px rgba(0,0,0,.7);
      background:#FFE066;
    }
    .banner-meta{
      font-size:11px; opacity:.8;
    }
    .banner-dots{
      position:absolute; inset:auto 12px 10px auto;
      display:flex; gap:4px;
    }
    .banner-dot{
      width:9px; height:9px; border-radius:50%;
      background:rgba(255,255,255,.3);
      border:1px solid rgba(0,0,0,.25);
      cursor:pointer;
      transition:transform var(--speed),background var(--speed),box-shadow var(--speed);
    }
    .banner-dot.active{
      transform:scale(1.2);
      background:#FFCF33;
      box-shadow:0 0 12px rgba(255,207,51,.9);
    }
    .cards-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:10px;
    }
    .card{
      border-radius:var(--radius);
      background:radial-gradient(circle at top left,#FFFFFF,#F9FCFA);
      padding:10px 10px 9px;
      border:1px solid rgba(223,234,227,.9);
      box-shadow:var(--shadow-soft);
      display:flex; flex-direction:column; gap:6px;
      position:relative;
      overflow:hidden;
    }
    .badge{
      position:absolute; top:8px; right:8px;
      border-radius:999px;
      font-size:10px;
      padding:3px 9px;
      background:rgba(46,139,87,.08);
      color:#1F6B45;
      border:1px solid rgba(46,139,87,.25);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .badge.pro{
      background:rgba(57,73,171,.1);
      color:#1A237E;
      border-color:rgba(57,73,171,.35);
    }
    .badge.hot{
      background:rgba(229,57,53,.12);
      color:#B71C1C;
      border-color:rgba(229,57,53,.4);
    }
    .card-title{
      font-weight:700; font-size:14px;
    }
    .card-text{
      font-size:12px; color:var(--muted);
    }
    .card-cta{
      margin-top:4px;
      font-size:12px; font-weight:600;
      text-decoration:none;
      color:var(--brand-dark);
      display:inline-flex; align-items:center; gap:6px;
    }
    .card-cta::after{
      content:"›"; font-size:13px;
    }
    .empty{
      font-size:12px; color:var(--muted);
      text-align:center; padding:12px 8px;
    }
    footer{
      padding:10px 16px 18px;
      font-size:11px; color:var(--muted);
      text-align:center;
    }
  </style>
</head>
<body>
<header>
  <div class="row">
    <div class="logo-wrap">
      <div class="logo-circle">π</div>
      <div class="brand-title">
        <span>LeaderMath Reklama</span>
        <span>Chiplar, bannerlar va cardlar bitta tizimda</span>
      </div>
    </div>
  </div>
</header>

<div class="chip-bar">
  <div class="chip-scroll">
    <div class="chip-row" id="chipsRow">
      <!-- JS bilan to‘ldiriladi -->
    </div>
  </div>
</div>

<main>
  <section id="bannerSection">
    <div class="banner-shell" id="bannerShell">
      <!-- JS bilan bannerlar -->
    </div>
  </section>

  <section>
    <div class="cards-grid" id="cardsGrid">
      <!-- JS bilan cardlar -->
    </div>
  </section>
</main>

<footer>
  Reklama konfiguratsiyasi Firebase Firestore orqali boshqariladi. Admin panel: <code>/admin.html</code>
</footer>

<script type="module">
  import { subscribeHomeConfig } from './firebase.js';

  const chipsRow = document.getElementById('chipsRow');
  const bannerShell = document.getElementById('bannerShell');
  const cardsGrid = document.getElementById('cardsGrid');

  let homeConfig = { chips: [] };
  let currentChipIndex = 0;
  let bannerTimer = null;
  const AUTO_SLIDE_MS = 6000;
  const CURRENT_ROLE = 'guest'; // kerak bo‘lsa auth bilan bog‘lab almashtirasan

  function filterByRole(items) {
    return (items || []).filter(it => {
      if (!it.visibleRoles || !it.visibleRoles.length) return true;
      return it.visibleRoles.includes(CURRENT_ROLE);
    });
  }

  // ---- CHIPLARNI CHIZISH ----
  function renderChips() {
    chipsRow.innerHTML = '';
    if (!homeConfig.chips || !homeConfig.chips.length) {
      chipsRow.innerHTML = '<span class="empty">Hali chiplar konfiguratsiya qilinmagan.</span>';
      return;
    }
    homeConfig.chips.forEach((chip, idx) => {
      const visible = !chip.visibleRoles || !chip.visibleRoles.length || chip.visibleRoles.includes(CURRENT_ROLE);
      if (!visible) return;
      const div = document.createElement('button');
      div.type = 'button';
      div.className = 'chip' + (idx === currentChipIndex ? ' active' : '');
      div.innerHTML = `
        <span class="icon">${chip.icon || '⬡'}</span>
        <span>${chip.label || chip.id || 'Chip'}</span>
        <small>${(chip.banners?.length || 0) + (chip.cards?.length || 0)} ta element</small>
      `;
      div.onclick = () => {
        currentChipIndex = idx;
        renderChips();
        renderActiveChipContent();
      };
      chipsRow.appendChild(div);
    });
  }

  function renderActiveChipContent() {
    if (!homeConfig.chips || !homeConfig.chips.length) {
      bannerShell.innerHTML = '';
      cardsGrid.innerHTML = '';
      return;
    }
    const chip = homeConfig.chips[currentChipIndex] || homeConfig.chips[0];
    const banners = filterByRole(chip.banners || []);
    const cards = filterByRole(chip.cards || []);

    renderBanners(banners);
    renderCards(cards);
  }

  // ---- BANNERLAR ----
  function renderBanners(banners) {
    bannerShell.innerHTML = '';
    clearInterval(bannerTimer);
    if (!banners.length) {
      bannerShell.innerHTML = '<div class="empty" style="background:#111;color:#ddd;">Bu chip uchun bannerlar yo‘q.</div>';
      return;
    }

    banners.forEach((b, idx) => {
      const slide = document.createElement('article');
      slide.className = 'banner-slide' + (idx === 0 ? ' active' : '');
      slide.dataset.index = idx;
      slide.innerHTML = `
        <div class="banner-media" style="background-image:url('${b.imageUrl || 'https://images.pexels.com/photos/4145354/pexels-photo-4145354.jpeg?auto=compress&cs=tinysrgb&w=1200'}');"></div>
        <div class="banner-overlay">
          <div>
            <div class="banner-tag">LeaderMath • Banner</div>
            <div class="banner-title">${b.title || 'Sarlavha'} </div>
            <div class="banner-text">${b.tagline || b.description || ''}</div>
            <div class="banner-cta-row">
              ${b.ctaHref ? `<a href="${b.ctaHref}" class="banner-cta" target="_blank" rel="noopener">${b.ctaLabel || 'Ko‘rish'}</a>` : ''}
            </div>
          </div>
          <div class="banner-meta">
            ${(b.visibleRoles || []).length ? 'Rollar: ' + (b.visibleRoles || []).join(', ') : 'Barcha foydalanuvchilar uchun'}
          </div>
        </div>
      `;
      bannerShell.appendChild(slide);
    });

    const dotsWrap = document.createElement('div');
    dotsWrap.className = 'banner-dots';
    banners.forEach((_, idx) => {
      const dot = document.createElement('button');
      dot.type = 'button';
      dot.className = 'banner-dot' + (idx === 0 ? ' active' : '');
      dot.dataset.index = idx;
      dot.onclick = () => switchBanner(idx);
      dotsWrap.appendChild(dot);
    });
    bannerShell.appendChild(dotsWrap);

    let current = 0;
    bannerTimer = setInterval(() => {
      current = (current + 1) % banners.length;
      switchBanner(current);
    }, AUTO_SLIDE_MS);
  }

  function switchBanner(index) {
    const slides = Array.from(bannerShell.querySelectorAll('.banner-slide'));
    const dots = Array.from(bannerShell.querySelectorAll('.banner-dot'));
    slides.forEach(s => s.classList.remove('active'));
    dots.forEach(d => d.classList.remove('active'));
    if (slides[index]) slides[index].classList.add('active');
    if (dots[index]) dots[index].classList.add('active');
  }

  // ---- CARDSLAR ----
  function renderCards(cards) {
    cardsGrid.innerHTML = '';
    if (!cards.length) {
      cardsGrid.innerHTML = '<div class="empty">Bu chip uchun cardlar yo‘q.</div>';
      return;
    }
    cards.forEach(c => {
      const div = document.createElement('article');
      div.className = 'card';
      const badgeClass = !c.badge ? '' :
        (c.badge.toLowerCase().includes('pro') ? ' pro' :
         c.badge.toLowerCase().includes('cheg') || c.badge.toLowerCase().includes('aksiya') ? ' hot' : '');
      div.innerHTML = `
        ${c.badge ? `<div class="badge${badgeClass}">${c.badge}</div>` : ''}
        <div class="card-title">${c.title || 'Card sarlavhasi'}</div>
        <div class="card-text">${c.description || ''}</div>
        ${c.ctaHref ? `<a href="${c.ctaHref}" class="card-cta" target="_blank" rel="noopener">${c.ctaLabel || 'Ko‘rish'}</a>` : ''}
      `;
      cardsGrid.appendChild(div);
    });
  }

  // ---- FIRESTORE LISTENER ----
  subscribeHomeConfig((cfg) => {
    homeConfig = cfg || { chips: [] };
    if (!homeConfig.chips) homeConfig.chips = [];
    if (currentChipIndex >= homeConfig.chips.length) {
      currentChipIndex = 0;
    }
    renderChips();
    renderActiveChipContent();
  });
</script>
</body>
</html>
