<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <title>Namangan shahar 1-IMI — Kirish</title>

  <link rel="icon" href="logo.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="logo.png" />
  <meta name="theme-color" content="#e0f2fe">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    :root{
      --brand:#0ea5e9;
      --bg:#e0f2fe;
      --text:#0f172a;
      --muted:#6b7280;
      --card-radius:22px;
      --shadow:0 18px 40px rgba(15,23,42,.35);
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    html,body{height:100%;}
    body{
      font-family:system-ui,-apple-system,'Segoe UI',Roboto,Arial;
      background:linear-gradient(180deg,#e0f2fe,#f9fafb);
      display:flex;
      align-items:center;
      justify-content:center;
      -webkit-tap-highlight-color:transparent;
    }
    .shell{
      width:100%;
      max-width:480px;
      padding:12px;
    }
    .card{
      background:#f9fafb;
      border-radius:var(--card-radius);
      box-shadow:var(--shadow);
      border:1px solid #e5e7eb;
      padding:16px 14px 14px;
    }
    .header{
      display:flex;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    .avatar{
      width:48px;height:48px;
      border-radius:50%;
      background:#dbeafe;
      display:flex;align-items:center;justify-content:center;
      color:#1d4ed8;
      box-shadow:0 4px 10px rgba(15,23,42,.25);
    }
    .title{
      font-size:15px;font-weight:700;color:var(--text);
    }
    .subtitle{
      font-size:11px;color:var(--muted);
    }
    .badge-protect{
      margin-left:auto;
      font-size:10px;
      padding:4px 7px;
      border-radius:999px;
      background:#ecfeff;
      border:1px solid #bae6fd;
      color:#0369a1;
      display:inline-flex;
      align-items:center;
      gap:5px;
    }
    .badge-protect i{font-size:10px;}

    .section-title{
      font-size:12px;
      font-weight:600;
      margin:8px 0 4px;
      color:#111827;
    }
    .form{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:6px;
    }
    label{
      font-size:11px;
      color:#374151;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    input{
      padding:7px 9px;
      border-radius:10px;
      border:1px solid #d4d4d8;
      font-size:12px;
      outline:none;
    }
    input:focus{
      border-color:#0ea5e9;
      box-shadow:0 0 0 1px #0ea5e9;
    }
    .btn-primary,
    .btn-secondary{
      width:100%;
      border:none;
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      margin-top:6px;
    }
    .btn-primary{
      background:linear-gradient(135deg,#0ea5e9,#38bdf8);
      color:white;
      box-shadow:0 8px 18px rgba(56,189,248,.55);
    }
    .btn-primary:active{
      transform:scale(.97);
      box-shadow:0 4px 12px rgba(56,189,248,.7);
    }
    .btn-secondary{
      background:white;
      border:1px solid #d1d5db;
      color:#111827;
    }
    .hint{
      font-size:10px;
      color:#6b7280;
      margin-top:4px;
    }
    .error{
      margin-top:4px;
      font-size:10px;
      color:#b91c1c;
    }

    /* Credentials modal */
    .overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.65);
      backdrop-filter:blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
    }
    .overlay.open{display:flex;}
    .cred-dialog{
      width:100%;
      max-width:420px;
      background:#f9fafb;
      border-radius:18px;
      padding:14px 14px 12px;
      box-shadow:0 18px 40px rgba(15,23,42,.4);
      border:1px solid #e5e7eb;
    }
    .cred-title{
      font-size:14px;
      font-weight:700;
      margin-bottom:4px;
      color:#111827;
    }
    .cred-sub{
      font-size:11px;
      color:#4b5563;
      margin-bottom:8px;
    }
    .cred-box{
      font-size:11px;
      background:#eff6ff;
      border-radius:12px;
      border:1px solid #bfdbfe;
      padding:8px;
      margin-bottom:8px;
    }
    .cred-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:4px;
    }
    .cred-row code{
      background:white;
      padding:2px 9px;
      border-radius:999px;
      border:1px solid #dbeafe;
      font-family:monospace;
      font-size:11px;
    }
    .cred-note{
      font-size:10px;
      color:#1f2937;
    }
    .btn-copy{
      border:none;
      background:white;
      border-radius:999px;
      padding:6px 9px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:5px;
      cursor:pointer;
      border:1px solid #d1d5db;
    }
    .btn-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:6px;
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>

  <script src="./firebase-config.js"></script>
  <script src="./auth-lite.js"></script>
</head>
<body>
<div class="shell">
  <div class="card">
    <div class="header">
      <div class="avatar">
        <i class="fa-solid fa-school"></i>
      </div>
      <div>
        <div class="title">Namangan shahar 1-IMI</div>
        <div class="subtitle">ID + Parol tizimi orqali kirish</div>
      </div>
      <div class="badge-protect">
        <i class="fa-solid fa-shield-halved"></i>
        Himoyalangan kirish
      </div>
    </div>

    <div class="section-title">ID + Parol orqali kirish</div>
    <form id="login-form" class="form">
      <label>
        <span>ID (6 xonali)</span>
        <input id="login-id" type="text" inputmode="numeric" maxlength="6" autocomplete="off" required>
      </label>
      <label>
        <span>Parol</span>
        <input id="login-password" type="password" minlength="6" autocomplete="current-password" required>
      </label>
      <button type="submit" class="btn-primary">
        <i class="fa-solid fa-right-to-bracket"></i>
        Kirish
      </button>
    </form>
    <div id="login-error" class="error" style="display:none;"></div>

    <div class="section-title" style="margin-top:10px;">Yangi foydalanuvchi (bir bosishda)</div>
    <p class="hint">
      Tizim sizga avtomatik 6 xonali ID va 8 belgili parol beradi. Ularni albatta yozib oling.
    </p>
    <button type="button" id="btn-auto" class="btn-secondary">
      <i class="fa-solid fa-user-plus"></i>
      Yangi ID + Parol berish
    </button>
  </div>
</div>

<!-- Avto yaratilgan ID + Parol modal -->
<div class="overlay" id="cred-overlay">
  <div class="cred-dialog">
    <div class="cred-title">Siz uchun yangi hisob yaratilidi ✅</div>
    <div class="cred-sub">
      ID va Parolni yozib oling yoki nusxa ko‘chirib oling. Bu oynani yopmaguncha ular ko‘rinib turadi.
    </div>
    <div class="cred-box">
      <div class="cred-row">
        <span>ID:</span>
        <code id="cred-id">------</code>
      </div>
      <div class="cred-row">
        <span>Parol:</span>
        <code id="cred-pass">--------</code>
      </div>
      <div class="cred-note">
        ID va Parol bilan keyinchalik qayta kirishingiz mumkin.
      </div>
    </div>
    <div class="btn-row">
      <button type="button" id="btn-copy" class="btn-copy">
        <i class="fa-solid fa-copy"></i> Nusxa olish
      </button>
      <button type="button" id="btn-go-portal" class="btn-primary" style="flex:1;">
        <i class="fa-solid fa-arrow-right"></i>
        Portalga o‘tish
      </button>
      <button type="button" id="btn-close-modal" class="btn-secondary">
        Yopish (ID yodda)
      </button>
    </div>
  </div>
</div>

<script>
  function showError(msg){
    const el = document.getElementById('login-error');
    el.textContent = msg;
    el.style.display = 'block';
  }
  function clearError(){
    const el = document.getElementById('login-error');
    el.textContent = '';
    el.style.display = 'none';
  }
  function goRedirect(){
    const redirect = window.authLite?.getRedirectParam() || '/demo/index.html';
    window.location.href = redirect;
  }

  document.getElementById('login-form').addEventListener('submit', async (e)=>{
    e.preventDefault();
    clearError();
    const id = document.getElementById('login-id').value;
    const pass = document.getElementById('login-password').value;
    try{
      if (!window.authLite) throw new Error('Auth tizimi topilmadi');
      await authLite.loginWithIdPassword(id, pass);
      goRedirect();
    }catch(err){
      console.error(err);
      showError(err.message || 'Kirishda xatolik yuz berdi.');
    }
  });

  document.getElementById('btn-auto').addEventListener('click', async ()=>{
    clearError();
    try{
      if (!window.authLite) throw new Error('Auth tizimi topilmadi');
      const res = await authLite.autoRegister();
      document.getElementById('cred-id').textContent   = res.id;
      document.getElementById('cred-pass').textContent = res.password;
      document.getElementById('cred-overlay').classList.add('open');
    }catch(err){
      console.error(err);
      showError(err.message || 'Ro‘yxatdan o‘tishda xatolik.');
    }
  });

  document.getElementById('btn-copy').addEventListener('click', async ()=>{
    const id   = document.getElementById('cred-id').textContent;
    const pass = document.getElementById('cred-pass').textContent;
    const txt  = `ID: ${id}\nParol: ${pass}`;
    try{
      await navigator.clipboard.writeText(txt);
      alert('ID va Parol clipboard-ga nusxa qilindi.');
    }catch{
      alert('Nusxa olishda xatolik. Qo‘lda yozib oling.');
    }
  });

  document.getElementById('btn-go-portal').addEventListener('click', ()=>{
    goRedirect();
  });
  document.getElementById('btn-close-modal').addEventListener('click', ()=>{
    document.getElementById('cred-overlay').classList.remove('open');
  });

  // Agar session allaqachon bo'lsa → bevosita redirect
  (async ()=>{
    if (!window.authLite) return;
    const ses = await authLite.getSession();
    if (ses){
      goRedirect();
    }
  })();
</script>
</body>
</html>
