<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <title>1-IMI Portal — Kirish</title>

  <link rel="icon" href="logo.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="logo.png" />
  <meta name="theme-color" content="#0ea5e9">

  <link rel="manifest" href="manifest.webmanifest">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    :root{
      --brand:#0ea5e9;
      --bg:#e0f2fe;
      --text:#0f172a;
      --muted:#6b7280;
      --card:#f9fafb;
      --shadow:0 18px 40px rgba(15,23,42,.35);
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    html,body{min-height:100%;}
    body{
      font-family:system-ui,-apple-system,'Segoe UI',Roboto,Arial;
      background:radial-gradient(circle at top,#bae6fd,#eff6ff 50%,#ffffff);
      color:var(--text);
      display:flex;
      justify-content:center;
      align-items:center;
      padding:12px;
    }

    .shell{
      width:100%;
      max-width:800px;
      background:rgba(249,250,251,.95);
      border-radius:22px;
      padding:14px 14px 16px;
      box-shadow:var(--shadow);
      border:1px solid #e5e7eb;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .header{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .logo{
      width:52px;height:52px;
      border-radius:16px;
      background:#0ea5e9;
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-weight:800;
      font-size:22px;
      box-shadow:0 12px 30px rgba(14,165,233,.6);
    }
    .htxt-title{
      font-size:18px;
      font-weight:700;
    }
    .htxt-sub{
      font-size:12px;
      color:var(--muted);
    }

    .cols{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    @media(min-width:720px){
      .cols{
        flex-direction:row;
      }
    }
    .col{
      flex:1;
      background:white;
      border-radius:18px;
      padding:10px;
      border:1px solid #e5e7eb;
    }
    .col-title{
      font-size:14px;
      font-weight:600;
      margin-bottom:6px;
    }
    .form{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:4px;
    }
    label{
      display:flex;
      flex-direction:column;
      gap:2px;
      font-size:11px;
      color:#4b5563;
    }
    input{
      padding:7px 8px;
      border-radius:10px;
      border:1px solid #d4d4d8;
      font-size:12px;
      outline:none;
    }
    input:focus{
      border-color:#0ea5e9;
      box-shadow:0 0 0 1px #0ea5e9;
    }
    .btn-primary,
    .btn-secondary{
      width:100%;
      border:none;
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      margin-top:6px;
    }
    .btn-primary{
      background:linear-gradient(135deg,#0ea5e9,#38bdf8);
      color:white;
      box-shadow:0 8px 18px rgba(56,189,248,.55);
    }
    .btn-secondary{
      background:#f9fafb;
      color:#374151;
      border:1px solid #d1d5db;
    }
    .text{
      font-size:11px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .footer{
      font-size:10px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Auto credentials modal */
    .cred-overlay{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.65);
      backdrop-filter:blur(10px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
    }
    .cred-overlay.open{
      display:flex;
    }
    .cred-dialog{
      width:100%;
      max-width:420px;
      background:#f9fafb;
      border-radius:18px;
      padding:12px 12px 10px;
      border:1px solid #e5e7eb;
      box-shadow:0 18px 40px rgba(15,23,42,.4);
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .cred-title{
      font-size:15px;
      font-weight:700;
    }
    .cred-sub{
      font-size:11px;
      color:#4b5563;
    }
    .cred-box{
      margin-top:4px;
      padding:8px;
      border-radius:12px;
      background:#eff6ff;
      border:1px solid #bfdbfe;
      font-size:11px;
      color:#111827;
    }
    .cred-row{
      display:flex;
      justify-content:space-between;
      gap:6px;
      align-items:center;
      margin-bottom:3px;
    }
    .cred-row code{
      background:white;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid #dbeafe;
      font-family:monospace;
    }
    .cred-note{
      margin-top:4px;
      font-size:10px;
      color:#4b5563;
    }
    .cred-actions{
      margin-top:8px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
    }
    .btn-ghost{
      border:none;
      background:transparent;
      font-size:11px;
      color:#4b5563;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="auth-lite.js"></script>
</head>
<body>
<div class="shell">
  <div class="header">
    <div class="logo">1</div>
    <div>
      <div class="htxt-title">Namangan shahar 1-IMI portali</div>
      <div class="htxt-sub">ID + Parol bilan kirish yoki bir bosishda ro'yxatdan o'tish</div>
    </div>
  </div>

  <div class="cols">
    <div class="col">
      <div class="col-title">ID + Parol bilan kirish</div>
      <form id="login-form" class="form">
        <label>
          <span>ID (6 xonali)</span>
          <input type="text" id="login-id" maxlength="6" inputmode="numeric" required>
        </label>
        <label>
          <span>Parol</span>
          <input type="password" id="login-password" minlength="6" required>
        </label>
        <button type="submit" class="btn-primary">
          <i class="fa-solid fa-right-to-bracket"></i>
          Kirish
        </button>
      </form>
      <button type="button" id="btn-to-index" class="btn-secondary">
        <i class="fa-solid fa-house"></i>
        Portal bosh sahifasiga qaytish
      </button>
    </div>

    <div class="col">
      <div class="col-title">Yangi foydalanuvchi</div>
      <p class="text">
        Bir bosishda ro'yxatdan o'tish: tizim sizga 6 xonali ID va 8 belgili parol beradi.
        Ushbu ma'lumotlarni saqlab qo'ying, keyin istalgan vaqtda portalga kira olasiz.
      </p>
      <button type="button" id="btn-auto-register" class="btn-primary">
        <i class="fa-solid fa-user-plus"></i>
        ID + Parolni avtomatik berish
      </button>
    </div>
  </div>

  <div class="footer">
    <span>Namangan shahar 1-IMI — mobil qurilmalarga mos portal</span>
    <span>Texnik qo'llab-quvvatlash: IT bo'limi</span>
  </div>
</div>

<!-- Auto credentials modal -->
<div id="cred-overlay" class="cred-overlay">
  <div class="cred-dialog">
    <div>
      <div class="cred-title">Siz uchun ID va Parol yaratildi</div>
      <div class="cred-sub">
        Iltimos, ushbu ma'lumotlarni yozib oling yoki skrinshot qiling. Oyna o'zingiz yopmaguningizcha qoladi.
      </div>
    </div>

    <div class="cred-box">
      <div class="cred-row">
        <span>ID:</span>
        <code id="cred-id">------</code>
      </div>
      <div class="cred-row">
        <span>Parol:</span>
        <code id="cred-pass">--------</code>
      </div>
      <div class="cred-note">
        Ushbu ID va Parol orqali keyingi safar portalga kira olasiz.
      </div>
    </div>

    <div class="cred-actions">
      <button type="button" id="btn-copy" class="btn-ghost">
        <i class="fa-solid fa-copy"></i>
        Nusxa olish
      </button>
      <button type="button" id="btn-cred-ok" class="btn-primary">
        <i class="fa-solid fa-check"></i>
        Tushunarli, portalga o'tish
      </button>
    </div>
  </div>
</div>

<script>
  // Service worker PWA
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js')
        .catch(err => console.log('SW xatolik:', err));
    });
  }

  const loginForm   = document.getElementById('login-form');
  const inputId     = document.getElementById('login-id');
  const inputPass   = document.getElementById('login-password');
  const btnAutoReg  = document.getElementById('btn-auto-register');
  const btnToIndex  = document.getElementById('btn-to-index');

  const credOverlay = document.getElementById('cred-overlay');
  const credIdEl    = document.getElementById('cred-id');
  const credPassEl  = document.getElementById('cred-pass');
  const btnCopy     = document.getElementById('btn-copy');
  const btnCredOk   = document.getElementById('btn-cred-ok');

  loginForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const id  = inputId.value.trim();
    const pwd = inputPass.value.trim();
    if (!id || !pwd){
      alert("ID va parolni kiriting.");
      return;
    }
    try{
      await authLite.login(id, pwd);
      window.location.href = 'index.html';
    }catch(err){
      alert(err.message || err);
    }
  });

  btnAutoReg.addEventListener('click', async ()=>{
    try{
      const res = await authLite.autoRegister();
      credIdEl.textContent   = res.loginId;
      credPassEl.textContent = res.password;
      credOverlay.classList.add('open');
    }catch(err){
      console.error(err);
      alert(err.message || err);
    }
  });

  btnCopy.addEventListener('click', async ()=>{
    const text = "ID: " + credIdEl.textContent + "\nParol: " + credPassEl.textContent;
    try{
      await navigator.clipboard.writeText(text);
      alert("ID va parol nusxa olindi.");
    }catch(e){
      alert("Clipboard ishlamadi, qo'lda nusxa oling.");
    }
  });

  btnCredOk.addEventListener('click', ()=>{
    credOverlay.classList.remove('open');
    window.location.href = 'index.html';
  });

  btnToIndex.addEventListener('click', ()=>{
    window.location.href = 'index.html';
  });

  // Agar session bo'lsa, avtomatik indexga uzatish
  document.addEventListener('DOMContentLoaded', ()=>{
    authLite.onUserChange(u=>{
      if (u){
        // Oldin ro'yxatdan o'tgan bo'lsa, to'g'ridan-to'g'ri indexga
        // (foydalanuvchi xohlasa logout qiladi)
        // window.location.href = 'index.html';
      }
    });
  });
</script>
</body>
</html>
