<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LeaderMath — User Admin</title>
  <style>
    :root{--brand:#2E8B57;--muted:#666}
    body{font-family:Inter, system-ui, Arial; margin:0; background:#f6f7f9; color:#111}
    header{background:linear-gradient(90deg,var(--brand),#1f6b44); color:white; padding:14px 20px; display:flex;align-items:center;justify-content:space-between}
    header h1{font-size:18px;margin:0}
    .container{padding:18px; max-width:1200px;margin:18px auto}
    .card{background:white;border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(20,20,20,0.06)}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:14px}
    #usersList{height:640px; overflow:auto;padding:8px;border-radius:8px;border:1px solid #eee}
    .userRow{padding:8px;border-radius:8px;border:1px solid transparent;margin-bottom:8px;cursor:pointer}
    .userRow:hover{background:#f2f6f2;border-color:#e6efe6}
    .userRow.active{background:#eaf7ea;border-color:#cfe6cf}
    .toolbar{display:flex;gap:8px;align-items:center}
    button{background:var(--brand);color:white;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
    button.secondary{background:#eee;color:#222}
    label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
    input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-top:6px}
    .row{display:flex;gap:8px}
    .small{width:120px}
    .muted{color:var(--muted);font-size:13px}
    .danger{background:#ff4d4f}
    pre{white-space:pre-wrap;word-break:break-word;background:#fafafa;padding:8px;border-radius:6px;border:1px solid #eee}
    footer{margin-top:12px;font-size:13px;color:var(--muted)}
    @media(max-width:900px){.grid{grid-template-columns:1fr;}.card{padding:10px}}
  </style>
</head>
<body>
  <header>
    <h1>LeaderMath — User Admin</h1>
    <div class="toolbar">
      <div id="currentUser" class="muted">Not signed in</div>
      <button id="btnSignIn">Sign in (Google)</button>
      <button id="btnSignOut" class="secondary" style="display:none">Sign out</button>
    </div>
  </header>

  <div class="container">
    <div class="card grid">
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>Foydalanuvchilar</strong>
          <div>
            <button id="btnRefresh" class="secondary">Refresh</button>
            <button id="btnAddNew">+ Add</button>
          </div>
        </div>

        <div id="usersList"></div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnExport">Export JSON</button>
          <label class="secondary" style="padding:8px;border-radius:8px;display:inline-block;background:#fff;border:1px dashed #ddd;color:#444;cursor:pointer">Import
            <input id="fileImport" type="file" accept="application/json" style="display:none" />
          </label>
        </div>
      </div>

      <div>
        <strong>Selected user</strong>
        <div id="detailsCard" style="margin-top:8px">
          <div class="muted">Select a user from the left to view and edit details.</div>
        </div>
        <footer>
          <div class="muted">Only <strong>sohibjonmath@gmail.com</strong> can sign in and use this page. Replace Firebase config below with your project settings.</div>
        </footer>
      </div>
    </div>
  </div>

  <script type="module">
    // IMPORTANT: Replace the firebaseConfig below with your project's config from Firebase Console.
    // How to use: open this file, paste your firebase config, then host (or open locally with Live Server).

    // ----------------- Firebase setup (modular v9+) -----------------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js'
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, setPersistence, browserLocalPersistence, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js'
    import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, addDoc, getDocs, setDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js'

    const firebaseConfig = {
  apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  authDomain: "xplusy-760fa.firebaseapp.com",
  projectId: "xplusy-760fa",
  storageBucket: "xplusy-760fa.firebasestorage.app",
  messagingSenderId: "992512966017",
  appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
  measurementId: "G-459PLJ7P7L"
};

    const app = initializeApp(firebaseConfig)
    const auth = getAuth(app)
    const db = getFirestore(app)

    // admin email allowed to use this page
    const ADMIN_EMAIL = 'sohibjonmath@gmail.com'

    // UI refs
    const btnSignIn = document.getElementById('btnSignIn')
    const btnSignOut = document.getElementById('btnSignOut')
    const currentUserEl = document.getElementById('currentUser')
    const usersListEl = document.getElementById('usersList')
    const detailsCard = document.getElementById('detailsCard')
    const btnRefresh = document.getElementById('btnRefresh')
    const btnAddNew = document.getElementById('btnAddNew')
    const btnExport = document.getElementById('btnExport')
    const fileImport = document.getElementById('fileImport')

    let unsubscribeUsers = null
    let users = []
    let selUserId = null

    // sign in
    btnSignIn.addEventListener('click', async ()=>{
      try{
        await setPersistence(auth, browserLocalPersistence)
        const provider = new GoogleAuthProvider()
        await signInWithPopup(auth, provider)
      }catch(e){ alert('Sign-in failed: '+e.message) }
    })

    btnSignOut.addEventListener('click', async ()=>{
      await signOut(auth)
    })

    onAuthStateChanged(auth, async user =>{
      if(user){
        currentUserEl.textContent = user.email
        btnSignIn.style.display = 'none'
        btnSignOut.style.display = 'inline-block'

        if(user.email !== ADMIN_EMAIL){
          alert('Siz admin emassiz — sahifadan chiqamiz.')
          await signOut(auth)
          return
        }

        // start listening for users
        startUsersListener()
      }else{
        currentUserEl.textContent = 'Not signed in'
        btnSignIn.style.display = 'inline-block'
        btnSignOut.style.display = 'none'
        stopUsersListener()
        usersListEl.innerHTML = ''
        detailsCard.innerHTML = '<div class="muted">Select a user from the left to view and edit details.</div>'
      }
    })

    // Real-time listener on collection 'foydalanuvchilar'
    function startUsersListener(){
      const col = collection(db, 'foydalanuvchilar')
      const q = query(col, orderBy('fullName'))
      unsubscribeUsers = onSnapshot(q, snap=>{
        users = []
        snap.forEach(d=> users.push({ id: d.id, ...d.data() }))
        renderUsersList()
      }, err=>{
        console.error('Users listener error', err)
        alert('Firestore error: '+err.message)
      })
    }

    function stopUsersListener(){ if(unsubscribeUsers) { unsubscribeUsers(); unsubscribeUsers=null } }

    function renderUsersList(){
      usersListEl.innerHTML = ''
      if(users.length===0){ usersListEl.innerHTML = '<div class="muted">No users found.</div>' ; return }
      users.forEach(u=>{
        const el = document.createElement('div')
        el.className = 'userRow'
        if(u.id===selUserId) el.classList.add('active')
        el.innerHTML = `<strong>${escapeHtml(u.fullName||'(No name)')}</strong><div class='muted'>${escapeHtml(u.region||'')} • ${escapeHtml(u.district||'')} • points: ${u.points||0}</div>`
        el.addEventListener('click', ()=>{ selUserId=u.id; renderUsersList(); renderDetails(u) })
        usersListEl.appendChild(el)
      })
    }

    function renderDetails(u){
      const html = `
      <div class="card" style="padding:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Edit: ${escapeHtml(u.fullName||u.id)}</strong>
          <div style="color:var(--muted);font-size:13px">id: ${u.id}</div>
        </div>

        <label>Full name</label>
        <input id="f_fullName" value="${escapeHtml(u.fullName||'')}" />

        <label>Email</label>
        <input id="f_email" value="${escapeHtml(u.email||'')}" />

        <div class="row">
          <div style="flex:1">
            <label>Region</label>
            <input id="f_region" value="${escapeHtml(u.region||'')}" />
          </div>
          <div style="flex:1">
            <label>District</label>
            <input id="f_district" value="${escapeHtml(u.district||'')}" />
          </div>
        </div>

        <div class="row">
          <div style="flex:1">
            <label>Login ID</label>
            <input id="f_loginId" value="${escapeHtml(u.loginId||'')}" />
          </div>
          <div style="width:120px">
            <label>Points</label>
            <input id="f_points" type="number" value="${Number(u.points||0)}" />
          </div>
        </div>

        <label>Rank</label>
        <input id="f_rank" value="${escapeHtml(u.rank||'')}" />

        <label>Birth date</label>
        <input id="f_birthDate" value="${escapeHtml(u.birthDate||'')}" placeholder="YYYY-MM-DD" />

        <label>Extra (JSON)</label>
        <textarea id="f_extra" rows="4">${escapeHtml(JSON.stringify(pickExtra(u), null, 2))}</textarea>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="btnSave">Save</button>
          <button id="btnClone" class="secondary">Clone</button>
          <button id="btnDelete" class="danger">Delete</button>
        </div>

        <div style="margin-top:10px">
          <strong>Raw document preview</strong>
          <pre>${escapeHtml(JSON.stringify(u, null, 2))}</pre>
        </div>
      </div>
      `
      detailsCard.innerHTML = html

      document.getElementById('btnSave').addEventListener('click', async ()=>{
        const payload = {
          fullName: document.getElementById('f_fullName').value.trim(),
          email: document.getElementById('f_email').value.trim(),
          region: document.getElementById('f_region').value.trim(),
          district: document.getElementById('f_district').value.trim(),
          loginId: document.getElementById('f_loginId').value.trim(),
          points: Number(document.getElementById('f_points').value)||0,
          rank: document.getElementById('f_rank').value.trim(),
          birthDate: document.getElementById('f_birthDate').value.trim(),
        }
        // merge extra JSON
        try{
          const extra = JSON.parse(document.getElementById('f_extra').value || '{}')
          Object.assign(payload, extra)
        }catch(e){ alert('Extra JSON is invalid: '+e.message); return }

        try{
          await updateDoc(doc(db, 'foydalanuvchilar', u.id), payload)
          alert('Saved')
        }catch(e){ alert('Save failed: '+e.message) }
      })

      document.getElementById('btnDelete').addEventListener('click', async ()=>{
        if(!confirm('O`chirishni tasdiqlaysizmi? dokument ID: '+u.id)) return
        try{ await deleteDoc(doc(db, 'foydalanuvchilar', u.id)); selUserId=null; detailsCard.innerHTML='<div class="muted">Select a user from the left to view and edit details.</div>'; renderUsersList(); alert('Deleted') }catch(e){ alert('Delete failed: '+e.message) }
      })

      document.getElementById('btnClone').addEventListener('click', async ()=>{
        const newDoc = { ...u }
        delete newDoc.id
        newDoc.fullName = newDoc.fullName + ' (copy)'
        try{ await addDoc(collection(db, 'foydalanuvchilar'), newDoc); alert('Cloned') }catch(e){ alert('Clone failed: '+e.message) }
      })
    }

    btnRefresh.addEventListener('click', ()=>{ if(unsubscribeUsers){ stopUsersListener(); startUsersListener(); } })

    btnAddNew.addEventListener('click', ()=>{
      const temp = { fullName:'New user', email:'', region:'', district:'', loginId:'', points:0, rank:'', createdAt: new Date().toISOString() }
      addDoc(collection(db,'foydalanuvchilar'), temp).then(()=>alert('New user added')).catch(e=>alert('Add failed: '+e.message))
    })

    btnExport.addEventListener('click', async ()=>{
      const snap = await getDocs(collection(db,'foydalanuvchilar'))
      const arr = []
      snap.forEach(d=> arr.push({ id:d.id, ...d.data() }))
      const blob = new Blob([JSON.stringify(arr,null,2)], {type:'application/json'})
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a'); a.href=url; a.download='foydalanuvchilar.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url)
    })

    fileImport.addEventListener('change', async (ev)=>{
      const f = ev.target.files[0]
      if(!f) return
      try{
        const txt = await f.text()
        const arr = JSON.parse(txt)
        if(!Array.isArray(arr)) throw new Error('JSON must be an array of documents')
        if(!confirm('Import '+arr.length+' documents? This will add them as new documents.')) return
        for(const docObj of arr){
          const copy = {...docObj}; delete copy.id
          await addDoc(collection(db,'foydalanuvchilar'), copy)
        }
        alert('Import finished')
      }catch(e){ alert('Import failed: '+e.message) }
      ev.target.value = ''
    })

    // helpers
    function escapeHtml(s){ if(s==null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }
    function pickExtra(u){ const k=['fullName','email','region','district','loginId','points','rank','birthDate','createdAt','updatedAt']; const out={}; for(const kk in u) if(!k.includes(kk)) out[kk]=u[kk]; return out }

    // quick guard: if firebase config not replaced, warn
    if(firebaseConfig.apiKey==="YOUR_API_KEY"){
      console.warn('Please replace firebaseConfig with your project values (apiKey etc).')
    }

  </script>
</body>
</html>
