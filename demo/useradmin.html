<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LeaderMath — User Admin (Enhanced)</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <style>
    :root{--brand:#2E8B57;--accent:#1f6b44;--muted:#6b7280;--bg:#f6f7f9}
    *{box-sizing:border-box}
    body{font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:var(--bg); color:#0f172a}
    header{background:linear-gradient(90deg,var(--brand),var(--accent)); color:white; padding:14px 22px; display:flex;align-items:center;justify-content:space-between;gap:12px}
    header h1{font-size:18px;margin:0}
    .toolbar{display:flex;gap:8px;align-items:center}
    .container{padding:18px;max-width:1200px;margin:18px auto}
    .card{background:white;border-radius:12px;padding:14px;box-shadow:0 10px 30px rgba(2,6,23,0.06)}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:16px}

    /* left panel */
    #usersListWrap{display:flex;flex-direction:column;gap:8px}
    .searchBox{display:flex;gap:8px}
    .searchBox input{flex:1;padding:8px;border-radius:10px;border:1px solid #e6edf0}
    .filters{display:flex;gap:8px;flex-wrap:wrap}
    select, input[type=number]{padding:8px;border-radius:8px;border:1px solid #e6edf0}

    #usersList{height:640px; overflow:auto;padding:8px;border-radius:12px;border:1px solid #f0f4f6}
    .userRow{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;border:1px solid transparent;margin-bottom:8px;background:linear-gradient(180deg,#fff,#fcfffb)}
    .userRow:hover{box-shadow:0 6px 18px rgba(30,80,40,0.06)}
    .userRow.active{outline:2px solid rgba(46,139,87,0.12)}
    .avatar{width:44px;height:44px;border-radius:10px;flex-shrink:0;background:#eef6ed;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--brand)}
    .meta{flex:1}
    .meta strong{display:block}
    .meta .muted{font-size:13px;color:var(--muted)}

    /* right panel */
    #detailsCard{min-height:200px}
    label{display:block;font-size:13px;color:var(--muted);margin-top:10px}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6edf0;margin-top:6px}
    .row{display:flex;gap:8px}
    .small{width:130px}
    .btn{background:var(--brand);color:white;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--brand);border:1px solid #e6edf0}
    .btn.danger{background:#ef4444}

    .controls{display:flex;gap:8px;align-items:center}
    .bulkBar{display:flex;gap:8px;align-items:center;padding:8px;border-radius:8px;background:#fbfdfb;border:1px solid #eef7ee;margin-bottom:8px}

    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;text-align:left;border-bottom:1px solid #f3f4f6}
    th{font-size:13px;color:var(--muted)}

    .pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:12px}
    .muted{color:var(--muted)}

    /* modal */
    .modal{position:fixed;inset:0;background:rgba(2,6,23,0.4);display:flex;align-items:center;justify-content:center}
    .modal .box{background:white;padding:16px;border-radius:12px;max-width:720px;width:100%}

    @media(max-width:920px){.grid{grid-template-columns:1fr}.card{padding:10px}.container{padding:12px}} 
  </style>
</head>
<body>
  <header>
    <h1>LeaderMath — User Admin (Enhanced)</h1>
    <div class="toolbar">
      <div id="currentUser" class="muted">Not signed in</div>
      <button id="btnSignIn" class="btn">Sign in</button>
      <button id="btnSignOut" class="btn ghost" style="display:none">Sign out</button>
    </div>
  </header>

  <div class="container">
    <div class="card grid">
      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <strong>Foydalanuvchilar</strong>
          <div style="display:flex;gap:8px;align-items:center">
            <div class="controls">
              <input id="search" placeholder="Ism, email, region, loginId..." />
              <select id="filterRegion"><option value="">All regions</option></select>
              <select id="sortBy"><option value="points_desc">Points ↓</option><option value="points_asc">Points ↑</option><option value="name_asc">Name A→Z</option><option value="name_desc">Name Z→A</option></select>
            </div>
          </div>
        </div>

        <div class="bulkBar" style="display:none" id="bulkBar">
          <div id="bulkCount">0 selected</div>
          <div style="margin-left:auto;display:flex;gap:8px"><button id="btnBulkDelete" class="btn danger">Delete</button><button id="btnBulkExport" class="btn ghost">Export</button><button id="btnClearSelection" class="btn ghost">Clear</button></div>
        </div>

        <div id="usersListWrap">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <div class="muted">Showing <span id="visibleCount">0</span> of <span id="totalCount">0</span></div>
            <div style="display:flex;gap:6px">
              <button id="btnRefresh" class="btn ghost">Refresh</button>
              <button id="btnAddNew" class="btn">+ Add</button>
            </div>
          </div>

          <div id="usersList"></div>

          <div class="pager">
            <div class="muted">Page</div>
            <button id="prevPage" class="btn ghost">◀</button>
            <div id="pageInfo" class="muted">1 / 1</div>
            <button id="nextPage" class="btn ghost">▶</button>
          </div>
        </div>

      </div>

      <div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Selected user</strong>
          <div class="muted">Only <strong>sohibjonmath@gmail.com</strong> can sign in</div>
        </div>

        <div id="detailsCard" class="card" style="margin-top:10px;min-height:320px">
          <div class="muted">Select a user from the left to view and edit details.</div>
        </div>

      </div>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button id="btnExportAll" class="btn ghost">Export all</button>
      <button id="btnImport" class="btn ghost">Import</button>
      <input id="fileImport" type="file" accept="application/json" style="display:none" />
    </div>
  </div>

  <!-- edit modal -->
  <div id="modal" style="display:none" class="modal"><div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center"><strong>Edit user</strong><button id="modalClose" class="btn ghost">Close</button></div>
    <div id="modalBody" style="margin-top:10px"></div>
  </div></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js'
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, setPersistence, browserLocalPersistence, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js'
    import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, addDoc, getDocs, setDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js'

    // --- REPLACE WITH YOUR FIREBASE CONFIG ---
    const firebaseConfig = {
  apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  authDomain: "xplusy-760fa.firebaseapp.com",
  projectId: "xplusy-760fa",
  storageBucket: "xplusy-760fa.firebasestorage.app",
  messagingSenderId: "992512966017",
  appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
  measurementId: "G-459PLJ7P7L"
};

    const app = initializeApp(firebaseConfig)
    const auth = getAuth(app)
    const db = getFirestore(app)
    const ADMIN_EMAIL = 'sohibjonmath@gmail.com'

    // UI refs
    const btnSignIn = document.getElementById('btnSignIn')
    const btnSignOut = document.getElementById('btnSignOut')
    const currentUserEl = document.getElementById('currentUser')
    const usersListEl = document.getElementById('usersList')
    const detailsCard = document.getElementById('detailsCard')
    const searchEl = document.getElementById('search')
    const filterRegion = document.getElementById('filterRegion')
    const sortBy = document.getElementById('sortBy')
    const visibleCount = document.getElementById('visibleCount')
    const totalCount = document.getElementById('totalCount')
    const pageInfo = document.getElementById('pageInfo')
    const prevPage = document.getElementById('prevPage')
    const nextPage = document.getElementById('nextPage')
    const bulkBar = document.getElementById('bulkBar')
    const bulkCount = document.getElementById('bulkCount')
    const btnBulkDelete = document.getElementById('btnBulkDelete')
    const btnBulkExport = document.getElementById('btnBulkExport')
    const btnClearSelection = document.getElementById('btnClearSelection')
    const btnRefresh = document.getElementById('btnRefresh')
    const btnAddNew = document.getElementById('btnAddNew')
    const btnExportAll = document.getElementById('btnExportAll')
    const btnImport = document.getElementById('btnImport')
    const fileImport = document.getElementById('fileImport')
    const modal = document.getElementById('modal')
    const modalBody = document.getElementById('modalBody')
    const modalClose = document.getElementById('modalClose')

    let unsubscribeUsers = null
    let allUsers = []
    let selectedIds = new Set()
    let selUser = null

    // pagination
    let page = 1
    const PAGE_SIZE = 20

    btnSignIn.addEventListener('click', async ()=>{
      try{
        await setPersistence(auth, browserLocalPersistence)
        const provider = new GoogleAuthProvider()
        await signInWithPopup(auth, provider)
      }catch(e){ alert('Sign-in failed: '+e.message) }
    })
    btnSignOut.addEventListener('click', async ()=>{ await signOut(auth) })

    onAuthStateChanged(auth, async user =>{
      if(user){
        currentUserEl.textContent = user.email
        btnSignIn.style.display = 'none'
        btnSignOut.style.display = 'inline-block'
        if(user.email !== ADMIN_EMAIL){ alert('Siz admin emassiz — chiqamiz'); await signOut(auth); return }
        startUsersListener()
      }else{
        currentUserEl.textContent = 'Not signed in'
        btnSignIn.style.display = 'inline-block'
        btnSignOut.style.display = 'none'
        stopUsersListener(); renderEmpty()
      }
    })

    function startUsersListener(){
      const col = collection(db, 'foydalanuvchilar')
      const q = query(col, orderBy('fullName'))
      unsubscribeUsers = onSnapshot(q, snap=>{
        allUsers = []
        snap.forEach(d=> allUsers.push({ id:d.id, ...d.data() }))
        totalCount.textContent = allUsers.length
        page = 1
        renderList()
        populateRegions()
      }, err=>{ console.error(err); alert('Firestore error:'+err.message) })
    }
    function stopUsersListener(){ if(unsubscribeUsers){ unsubscribeUsers(); unsubscribeUsers=null } }

    function renderEmpty(){ usersListEl.innerHTML=''; detailsCard.innerHTML='<div class="muted">Select a user from the left to view and edit details.</div>'; totalCount.textContent='0'; visibleCount.textContent='0'; pageInfo.textContent='0 / 0' }

    function filterAndSort(arr){
      const q = searchEl.value.trim().toLowerCase()
      let out = arr.filter(u=>{
        if(q){
          return (String(u.fullName||'').toLowerCase().includes(q) || String(u.email||'').toLowerCase().includes(q) || String(u.region||'').toLowerCase().includes(q) || String(u.loginId||'').toLowerCase().includes(q))
        }
        return true
      })
      const region = filterRegion.value
      if(region) out = out.filter(u=>u.region===region)

      const s = sortBy.value
      if(s==='points_desc') out.sort((a,b)=>Number(b.points||0)-Number(a.points||0))
      if(s==='points_asc') out.sort((a,b)=>Number(a.points||0)-Number(b.points||0))
      if(s==='name_asc') out.sort((a,b)=>String(a.fullName||'').localeCompare(String(b.fullName||'')))
      if(s==='name_desc') out.sort((a,b)=>String(b.fullName||'').localeCompare(String(a.fullName||'')))
      return out
    }

    function renderList(){
      const filtered = filterAndSort(allUsers)
      visibleCount.textContent = filtered.length
      const totalPages = Math.max(1, Math.ceil(filtered.length / PAGE_SIZE))
      if(page>totalPages) page = totalPages
      const start = (page-1)*PAGE_SIZE
      const pageItems = filtered.slice(start, start+PAGE_SIZE)

      usersListEl.innerHTML = ''
      pageItems.forEach(u=>{
        const el = document.createElement('div')
        el.className = 'userRow'
        if(selectedIds.has(u.id)) el.style.outline = '2px solid rgba(46,139,87,0.12)'
        const avatar = u.avatarUrl ? `<img src="${u.avatarUrl}" style="width:44px;height:44px;border-radius:10px;object-fit:cover" />` : `<div class="avatar">${String((u.fullName||u.id).slice(0,2)).toUpperCase()}</div>`
        el.innerHTML = `<div style="display:flex;gap:10px;align-items:center;width:100%"><input type=checkbox data-id="${u.id}" ${selectedIds.has(u.id)?'checked':''} /><div>${avatar}</div><div class="meta"><strong>${escapeHtml(u.fullName||'(No name)')}</strong><div class='muted'>${escapeHtml(u.email||'—')} • ${escapeHtml(u.region||'')} ${escapeHtml(u.district||'')} • points: ${Number(u.points||0)}</div></div><div style="margin-left:auto;text-align:right"><div class='muted'>${u.rank||''}</div><div class='muted' style='font-size:12px'>id: ${u.id}</div><div style='margin-top:6px'><button class='btn ghost btnOpen' data-id='${u.id}'>Open</button></div></div></div>`
        // checkbox
        el.querySelector('input[type=checkbox]').addEventListener('click', (ev)=>{
          const id = ev.target.dataset.id
          if(ev.target.checked) selectedIds.add(id); else selectedIds.delete(id)
          updateBulkBar(); renderList()
          ev.stopPropagation()
        })
        // open
        el.querySelector('.btnOpen').addEventListener('click', ()=> openUserModal(u))
        // row click selects
        el.addEventListener('click', (ev)=>{ if(ev.target.tagName.toLowerCase()==='input') return; selUser = u; renderDetails(u); document.querySelectorAll('.userRow').forEach(r=>r.classList.remove('active')); el.classList.add('active') })

        usersListEl.appendChild(el)
      })

      pageInfo.textContent = page + ' / ' + totalPages
    }

    function renderDetails(u){
      selUser = u
      detailsCard.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong>${escapeHtml(u.fullName||'')}</strong>
          <div class="muted">${escapeHtml(u.email||'')}</div>
        </div>
        <div style="text-align:right">
          <div class="muted">Points: ${Number(u.points||0)}</div>
          <div class="muted">Rank: ${escapeHtml(u.rank||'')}</div>
        </div>
      </div>

      <label>Full name</label>
      <input id="d_fullName" value="${escapeHtml(u.fullName||'')}" />
      <label>Email</label>
      <input id="d_email" value="${escapeHtml(u.email||'')}" />
      <div class="row">
        <div style="flex:1"><label>Region</label><input id="d_region" value="${escapeHtml(u.region||'')}" /></div>
        <div style="flex:1"><label>District</label><input id="d_district" value="${escapeHtml(u.district||'')}" /></div>
      </div>
      <div class="row">
        <div style="flex:1"><label>Login ID</label><input id="d_loginId" value="${escapeHtml(u.loginId||'')}" /></div>
        <div class="small"><label>Points</label><input id="d_points" type=number value="${Number(u.points||0)}" /></div>
      </div>
      <label>Rank</label><input id="d_rank" value="${escapeHtml(u.rank||'')}" />
      <label>Birth date</label><input id="d_birthDate" value="${escapeHtml(u.birthDate||'')}" placeholder='YYYY-MM-DD' />
      <label>Extra (JSON)</label><textarea id="d_extra" rows=4>${escapeHtml(JSON.stringify(pickExtra(u),null,2))}</textarea>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="d_save" class="btn">Save</button>
        <button id="d_clone" class="btn ghost">Clone</button>
        <button id="d_delete" class="btn danger">Delete</button>
      </div>
      <div style="margin-top:12px"><strong>Raw</strong><pre>${escapeHtml(JSON.stringify(u,null,2))}</pre></div>
      `

      document.getElementById('d_save').addEventListener('click', async ()=>{
        const payload = {
          fullName: document.getElementById('d_fullName').value.trim(),
          email: document.getElementById('d_email').value.trim(),
          region: document.getElementById('d_region').value.trim(),
          district: document.getElementById('d_district').value.trim(),
          loginId: document.getElementById('d_loginId').value.trim(),
          points: Number(document.getElementById('d_points').value)||0,
          rank: document.getElementById('d_rank').value.trim(),
          birthDate: document.getElementById('d_birthDate').value.trim()
        }
        try{
          const extra = JSON.parse(document.getElementById('d_extra').value||'{}')
          Object.assign(payload, extra)
        }catch(e){ alert('JSON invalid: '+e.message); return }
        try{ await updateDoc(doc(db,'foydalanuvchilar',selUser.id), payload); alert('Saved'); }catch(e){ alert('Save failed:'+e.message) }
      })

      document.getElementById('d_delete').addEventListener('click', async ()=>{
        if(!confirm('O\'chirishni tasdiqlaysizmi?')) return
        try{ await deleteDoc(doc(db,'foydalanuvchilar',selUser.id)); alert('Deleted'); selUser=null; detailsCard.innerHTML='<div class="muted">Select a user from the left to view and edit details.</div>'; }catch(e){ alert('Delete failed:'+e.message) }
      })

      document.getElementById('d_clone').addEventListener('click', async ()=>{
        const copy = {...selUser}; delete copy.id; copy.fullName = (copy.fullName||'') + ' (copy)'
        try{ await addDoc(collection(db,'foydalanuvchilar'), copy); alert('Cloned') }catch(e){ alert('Clone failed:'+e.message) }
      })
    }

    // modal for quick edit
    function openUserModal(u){ modal.style.display='flex'; modalBody.innerHTML = `<label>Full name</label><input id='m_fullName' value='${escapeHtml(u.fullName||'')}' /><label>Points</label><input id='m_points' type=number value='${Number(u.points||0)}' /><div style='display:flex;gap:8px;margin-top:10px'><button id='m_save' class='btn'>Save</button><button id='m_cancel' class='btn ghost'>Cancel</button></div>`
      document.getElementById('m_save').addEventListener('click', async ()=>{ try{ await updateDoc(doc(db,'foydalanuvchilar',u.id), { fullName: document.getElementById('m_fullName').value.trim(), points: Number(document.getElementById('m_points').value)||0 }); modal.style.display='none'; alert('Saved') }catch(e){ alert('Save failed:'+e.message) } })
      document.getElementById('m_cancel').addEventListener('click', ()=> modal.style.display='none')
    }
    modalClose.addEventListener('click', ()=> modal.style.display='none')

    // bulk actions
    function updateBulkBar(){ const n = selectedIds.size; if(n>0){ bulkBar.style.display='flex'; bulkCount.textContent = n + ' selected' } else { bulkBar.style.display='none' } }

    btnBulkDelete.addEventListener('click', async ()=>{
      if(!confirm('Delete '+selectedIds.size+' documents?')) return
      for(const id of Array.from(selectedIds)){ try{ await deleteDoc(doc(db,'foydalanuvchilar', id)); selectedIds.delete(id) }catch(e){ console.error('delete',id,e) } }
      updateBulkBar(); renderList(); alert('Bulk delete finished')
    })
    btnBulkExport.addEventListener('click', async ()=>{
      const arr = allUsers.filter(u=> selectedIds.has(u.id)).map(u=> ({ id:u.id, ...u }))
      const blob = new Blob([JSON.stringify(arr,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='selected_users.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url)
    })
    btnClearSelection.addEventListener('click', ()=>{ selectedIds.clear(); updateBulkBar(); renderList() })

    // pagination
    prevPage.addEventListener('click', ()=>{ if(page>1){ page--; renderList() } })
    nextPage.addEventListener('click', ()=>{ page++; renderList() })

    // refresh / add
    btnRefresh.addEventListener('click', ()=>{ if(unsubscribeUsers){ stopUsersListener(); startUsersListener(); } })
    btnAddNew.addEventListener('click', async ()=>{ const tmp={ fullName:'New user', email:'', region:'', district:'', loginId:'', points:0, rank:'', createdAt:new Date().toISOString() }; try{ await addDoc(collection(db,'foydalanuvchilar'), tmp); alert('New user added') }catch(e){ alert('Add failed:'+e.message) } })

    // export/import
    btnExportAll.addEventListener('click', async ()=>{
      const snap = await getDocs(collection(db,'foydalanuvchilar'))
      const arr = []
      snap.forEach(d=> arr.push({ id:d.id, ...d.data() }))
      const blob = new Blob([JSON.stringify(arr,null,2)], {type:'application/json'})
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a'); a.href=url; a.download='foydalanuvchilar.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url)
    })
    btnImport.addEventListener('click', ()=> fileImport.click())
    fileImport.addEventListener('change', async (ev)=>{
      const f = ev.target.files[0]; if(!f) return
      try{ const txt = await f.text(); const arr = JSON.parse(txt); if(!Array.isArray(arr)) throw new Error('JSON must be array'); if(!confirm('Import '+arr.length+' docs?')) return; for(const docObj of arr){ const copy = {...docObj}; delete copy.id; await addDoc(collection(db,'foydalanuvchilar'), copy) } alert('Import finished') }catch(e){ alert('Import failed:'+e.message) } ev.target.value=''
    })

    // search / filters
    searchEl.addEventListener('input', ()=>{ page=1; renderList() })
    filterRegion.addEventListener('change', ()=>{ page=1; renderList() })
    sortBy.addEventListener('change', ()=>{ renderList() })

    // helpers
    function escapeHtml(s){ if(s==null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }
    function pickExtra(u){ const k=['fullName','email','region','district','loginId','points','rank','birthDate','createdAt','updatedAt','avatarUrl']; const out={}; for(const kk in u) if(!k.includes(kk)) out[kk]=u[kk]; return out }

    function populateRegions(){ const regions = Array.from(new Set(allUsers.map(u=>u.region).filter(Boolean))).sort(); filterRegion.innerHTML = '<option value="">All regions</option>' + regions.map(r=>`<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`).join('') }

    // initial guard
    if(firebaseConfig.apiKey==="YOUR_API_KEY") console.warn('Replace firebaseConfig with your project values')

  </script>
</body>
</html>
