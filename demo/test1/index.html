<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1-IMI & LeaderMath - Test Tizimi</title>
    
    <!-- MathJax - Soddalashtirilgan versiya -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
                ignoreHtmlClass: 'tex2jax_ignore',
                enableMenu: false,
                enableAssistiveMml: false  // Storage xatolarini oldini olish
            }
        };
    </script>
    <!-- Alternative MathJax CDN -->
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" id="MathJax-script" async></script>
    
    <!-- Favicon (404 xatosini oldini olish) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“š</text></svg>">
    
    <style>
        /* ASOSIY STILLAR */
        :root {
            --brand: #2E8B57;
            --brand2: #1F6B45;
            --bg: #f8f9fa;
            --text: #333;
            --frame: #ddd;
            --danger: #e74c3c;
            --success: #27ae60;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
        }
        
        /* BANNERLAR */
        .top-banner {
            background: linear-gradient(90deg, #1e3c72, #2a5298);
            color: white;
            height: 40px;
            overflow: hidden;
        }
        
        .banner-content {
            display: flex;
            animation: scrollBanner 120s linear infinite;
            padding: 10px 0;
            white-space: nowrap;
        }
        
        .banner-item {
            display: inline-flex;
            align-items: center;
            margin-right: 40px;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .bottom-banner {
            background: linear-gradient(90deg, #2E8B57, #1F6B45);
            color: white;
            height: 35px;
            overflow: hidden;
        }
        
        .bottom-banner-content {
            display: flex;
            animation: scrollBottomBanner 100s linear infinite;
            padding: 8px 0;
            white-space: nowrap;
        }
        
        @keyframes scrollBanner {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        
        @keyframes scrollBottomBanner {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        
        /* ASOSIY KONTENT */
        .wrap {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            min-height: calc(100vh - 75px);
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid var(--frame);
        }
        
        .hidden {
            display: none !important;
        }
        
        /* SAVOL STILLARI */
        .question-image-container {
            margin: 15px 0;
            text-align: center;
        }
        
        .question-image {
            max-width: 100%;
            max-height: 350px;
            object-fit: contain;
        }
        
        /* TUGMALAR VA INPUT */
        .btn {
            background: var(--brand);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn:hover {
            background: var(--brand2);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--frame);
            border-radius: 6px;
            font-size: 16px;
        }
        
        /* NAV DOTS */
        .nav-dots {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .dot {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: 1px solid var(--frame);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: white;
            position: relative;
        }
        
        .dot.active {
            background: var(--brand);
            color: white;
        }
        
        .dot.answered {
            background: var(--success);
            color: white;
        }
        
        .dot.locked {
            background: var(--danger);
            color: white;
            cursor: not-allowed;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .wrap {
                padding: 10px;
            }
            
            .card {
                padding: 15px;
            }
            
            .banner-item {
                font-size: 12px;
                margin-right: 30px;
            }
            
            .question-image {
                max-height: 250px;
            }
        }
    </style>
</head>
<body>
    <!-- YUQORI BANNER -->
    <div class="top-banner">
        <div class="banner-content" id="topBannerContent"></div>
    </div>
    
    <!-- ASOSIY KONTENT -->
    <div class="wrap">
        <!-- Yuklanish ekrani -->
        <div id="loadingScreen" class="card">
            <div style="text-align: center;">
                <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--brand); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
                <h2>Yuklanmoqda...</h2>
            </div>
        </div>
        
        <!-- Test kodi kiritish -->
        <div id="codeInputCard" class="card hidden">
            <h1 style="text-align: center; color: var(--brand); margin-bottom: 20px;">Test Tizimi</h1>
            <p style="text-align: center; margin-bottom: 20px;">Test kodini kiriting:</p>
            
            <div class="input-group">
                <input type="text" id="testCodeInput" placeholder="Masalan: 8001" maxlength="10">
            </div>
            
            <button id="loadTestBtn" class="btn">Testni Yuklash</button>
        </div>
        
        <!-- Sinf tanlash -->
        <div id="classSelectionCard" class="card hidden">
            <h2>Sinfni Tanlang</h2>
            
            <div class="input-group">
                <select id="classSelect">
                    <option value="">Sinfni tanlang</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button id="backToCodeBtn" class="btn btn-secondary">Orqaga</button>
                <button id="nextToStudentBtn" class="btn">Keyingi</button>
            </div>
        </div>
        
        <!-- O'quvchi tanlash -->
        <div id="studentSelectionCard" class="card hidden">
            <h2>O'quvchini Tanlang</h2>
            
            <div class="input-group">
                <select id="studentSelect">
                    <option value="">O'quvchini tanlang</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button id="backToClassBtn" class="btn btn-secondary">Orqaga</button>
                <button id="nextToIntroBtn" class="btn">Keyingi</button>
            </div>
        </div>
        
        <!-- Test kirish -->
        <div id="introCard" class="card hidden">
            <h1 id="testTitle">Test</h1>
            <p id="testDescription" style="text-align: center; margin-bottom: 20px;"></p>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 20px 0;">
                <div style="background: #f5f5f5; padding: 10px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 12px; color: #666;">Savollar</div>
                    <div style="font-size: 20px; font-weight: bold; color: var(--brand);" id="totalQuestions">0</div>
                </div>
                <div style="background: #f5f5f5; padding: 10px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 12px; color: #666;">Vaqt</div>
                    <div style="font-size: 20px; font-weight: bold; color: var(--brand);" id="testDuration">0 daq</div>
                </div>
            </div>
            
            <div style="background: #f0f9f0; padding: 10px; border-radius: 6px; margin: 15px 0; text-align: center;">
                <strong>O'quvchi:</strong> <span id="studentName">-</span>
            </div>
            
            <button id="startTestBtn" class="btn">Testni Boshlash</button>
        </div>
        
        <!-- Savol kartasi -->
        <div id="questionCard" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div style="font-size: 24px; font-weight: bold; color: var(--brand);" id="currentQ">1</div>
                <div style="background: #fee; color: var(--danger); padding: 8px 15px; border-radius: 4px; font-weight: bold;" id="timer">00:00</div>
            </div>
            
            <!-- Rasm -->
            <div id="questionImageContainer" class="question-image-container hidden">
                <img id="questionImage" class="question-image hidden" alt="Savol rasmi">
                <div id="imageNotFound" class="hidden" style="padding: 20px; color: #666; background: #f5f5f5; border-radius: 4px;">Rasm yuklanmadi</div>
            </div>
            
            <!-- Savol matni -->
            <div id="questionText" style="font-size: 18px; margin: 15px 0; padding: 15px; background: #f9f9f9; border-radius: 6px;"></div>
            
            <!-- Variantlar -->
            <div id="optionsContainer" class="hidden"></div>
            
            <!-- 3 marta ko'rish ogohlantirishi -->
            <div id="viewWarning" class="hidden" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px 0; border-radius: 4px; text-align: center;">
                <strong>Diqqat!</strong> Bu savolni <span id="viewCount">1</span> marta ko'rdiz. 3 martadan keyin qulfdanadi.
            </div>
            
            <!-- Navigatsiya nuqtalari -->
            <div class="nav-dots" id="navDots"></div>
            
            <!-- Tugmalar -->
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="prevBtn" class="btn btn-secondary">Oldingi</button>
                <button id="nextBtn" class="btn">Keyingi</button>
                <button id="finishBtn" class="btn" style="background: var(--danger);">Yakunlash</button>
            </div>
        </div>
        
        <!-- Natijalar -->
        <div id="resultsCard" class="card hidden">
            <div style="text-align: center;">
                <div style="width: 150px; height: 150px; border-radius: 50%; background: var(--brand); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 20px;">
                    <span style="font-size: 40px; font-weight: bold;" id="finalScore">0</span>
                    <small>ball</small>
                </div>
                
                <h2>Test Yakunlandi!</h2>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0;">
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 12px; color: #666;">To'g'ri javoblar</div>
                        <div style="font-size: 24px; font-weight: bold; color: var(--brand);" id="correctCount">0</div>
                    </div>
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 12px; color: #666;">Noto'g'ri javoblar</div>
                        <div style="font-size: 24px; font-weight: bold; color: #e74c3c;" id="wrongCount">0</div>
                    </div>
                </div>
                
                <button id="restartBtn" class="btn">Yana Test Yechish</button>
            </div>
        </div>
    </div>
    
    <!-- PASTKI BANNER -->
    <div class="bottom-banner">
        <div class="bottom-banner-content" id="bottomBannerContent"></div>
    </div>
    
    <script>
        // ==================== ASOSIY KONFIGURATSIYA ====================
        const TELEGRAM_BOT_TOKEN = "8036217508:AAHtKM7BhVc-KxR-C_19wWH4TrLSfLaQucI";
        const TELEGRAM_CHAT_ID = "2049065724";
        
        // ==================== GLOBAL O'ZGARUVCHILAR ====================
        let currentTestCode = '';
        let testData = null;
        let randomizedTest = null;
        let classes = [];
        let students = [];
        let currentClass = '';
        let currentStudent = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let timerInterval = null;
        let timeRemaining = 0;
        let testStarted = false;
        let questionViews = {};
        
        // ==================== BANNERLARNI YARATISH ====================
        function createBanners() {
            // Yuqori banner
            const topContent = document.getElementById('topBannerContent');
            for (let i = 0; i < 15; i++) {
                const item = document.createElement('div');
                item.className = 'banner-item';
                item.innerHTML = '1-IMI.UZ | LeaderMath.uz | Test Tizimi';
                topContent.appendChild(item);
            }
            
            // Pastki banner
            const bottomContent = document.getElementById('bottomBannerContent');
            for (let i = 0; i < 15; i++) {
                const item = document.createElement('div');
                item.className = 'banner-item';
                item.innerHTML = 'Telegram: @Help_LeaderMath_bot | Tel: +998 XX XXX XX XX';
                bottomContent.appendChild(item);
            }
        }
        
        // ==================== TEST FUNKSIYALARI ====================
        async function loadJSON(file) {
            try {
                const response = await fetch(file);
                if (!response.ok) throw new Error(`${file} yuklanmadi`);
                return await response.json();
            } catch (error) {
                console.error('Xato:', error);
                return null;
            }
        }
        
        async function loadTestData(code) {
            showScreen('loading');
            
            testData = await loadJSON(`${code}.json`);
            if (!testData) {
                alert(`"${code}" testi topilmadi`);
                showScreen('codeInput');
                return false;
            }
            
            // Javoblarni yuklash
            const answersData = await loadJSON(`${code}_javoblar.json`);
            if (answersData) {
                testData.questions.forEach((q, i) => {
                    if (answersData[i]) {
                        if (q.type === 'variant') q.correctIndex = answersData[i].correctIndex;
                        else if (q.type === 'open') q.correctAnswer = answersData[i].correctAnswer;
                    }
                });
            }
            
            // Testni random qilish
            randomizedTest = randomizeTest();
            return true;
        }
        
        function randomizeTest() {
            if (!testData) return null;
            
            const randomized = JSON.parse(JSON.stringify(testData));
            randomized.questions = shuffleArray(testData.questions.map((q, idx) => ({
                ...q,
                originalIndex: idx
            })));
            
            // Variantlarni random qilish
            randomized.questions.forEach(question => {
                if (question.type === 'variant' && question.options) {
                    const originalOptions = [...question.options];
                    const shuffledOptions = shuffleArray(originalOptions);
                    
                    if (question.correctIndex !== undefined) {
                        const correctAnswer = originalOptions[question.correctIndex];
                        question.correctIndex = shuffledOptions.indexOf(correctAnswer);
                    }
                    
                    question.options = shuffledOptions;
                }
            });
            
            return randomized;
        }
        
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        // ==================== NAV DOTS FUNKSIYALARI ====================
        function buildNavDots() {
            const dotsContainer = document.getElementById('navDots');
            if (!dotsContainer || !randomizedTest) return;
            
            dotsContainer.innerHTML = '';
            
            randomizedTest.questions.forEach((_, index) => {
                const dot = document.createElement('div');
                dot.className = 'dot';
                dot.textContent = index + 1;
                
                if (index === currentQuestionIndex) {
                    dot.classList.add('active');
                }
                
                if (userAnswers[index] !== undefined) {
                    dot.classList.add('answered');
                }
                
                if (questionViews[index] >= 3) {
                    dot.classList.add('locked');
                    dot.title = 'Bu savol qulfdanadi';
                    dot.onclick = null;
                } else {
                    dot.onclick = () => {
                        if (testStarted && questionViews[currentQuestionIndex] < 3) {
                            currentQuestionIndex = index;
                            renderQuestion();
                        }
                    };
                }
                
                dotsContainer.appendChild(dot);
            });
        }
        
        function updateNavDots() {
            const dots = document.querySelectorAll('.dot');
            dots.forEach((dot, index) => {
                dot.classList.remove('active', 'answered', 'locked');
                
                if (index === currentQuestionIndex) {
                    dot.classList.add('active');
                }
                
                if (userAnswers[index] !== undefined) {
                    dot.classList.add('answered');
                }
                
                if (questionViews[index] >= 3) {
                    dot.classList.add('locked');
                    dot.onclick = null;
                }
            });
        }
        
        // ==================== 3 MARTALIK KO'RISH TIZIMI ====================
        function checkQuestionView(questionIndex) {
            if (!questionViews[questionIndex]) {
                questionViews[questionIndex] = 1;
            } else {
                questionViews[questionIndex]++;
            }
            
            if (questionViews[questionIndex] >= 3) {
                updateNavDots();
                
                if (currentQuestionIndex === questionIndex) {
                    setTimeout(() => {
                        alert("Bu savolni 3 marta ko'rdingiz. Keyingi savolga o'ting.");
                        nextQuestion();
                    }, 500);
                }
            }
            
            return questionViews[questionIndex];
        }
        
        // ==================== SAVOLNI KO'RSATISH ====================
        function renderQuestion() {
            if (!randomizedTest || !randomizedTest.questions[currentQuestionIndex]) return;
            
            const question = randomizedTest.questions[currentQuestionIndex];
            const views = checkQuestionView(currentQuestionIndex);
            
            // Savol raqami
            document.getElementById('currentQ').textContent = currentQuestionIndex + 1;
            
            // Rasm
            const imgContainer = document.getElementById('questionImageContainer');
            const imgElement = document.getElementById('questionImage');
            const imgNotFound = document.getElementById('imageNotFound');
            
            imgContainer.classList.add('hidden');
            imgElement.classList.add('hidden');
            imgNotFound.classList.add('hidden');
            
            if (question.hasImage) {
                imgContainer.classList.remove('hidden');
                const imgNum = question.originalIndex + 1;
                imgElement.src = `${currentTestCode}/${imgNum}.png`;
                
                imgElement.onload = function() {
                    imgElement.classList.remove('hidden');
                };
                
                imgElement.onerror = function() {
                    imgNotFound.classList.remove('hidden');
                };
            }
            
            // Savol matni
            document.getElementById('questionText').innerHTML = question.text || '';
            
            // Variantlar
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.classList.add('hidden');
            optionsContainer.innerHTML = '';
            
            if (question.type === 'variant') {
                optionsContainer.classList.remove('hidden');
                
                question.options.forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.style.cssText = 'display: flex; align-items: center; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;';
                    
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = 'questionOption';
                    input.value = index;
                    input.id = `option_${index}`;
                    
                    if (userAnswers[currentQuestionIndex] === index) {
                        input.checked = true;
                        optionDiv.style.background = '#e8f5ef';
                        optionDiv.style.borderColor = '#2E8B57';
                    }
                    
                    input.onchange = () => {
                        document.querySelectorAll('#optionsContainer > div').forEach(div => {
                            div.style.background = 'white';
                            div.style.borderColor = '#ddd';
                        });
                        
                        optionDiv.style.background = '#e8f5ef';
                        optionDiv.style.borderColor = '#2E8B57';
                        userAnswers[currentQuestionIndex] = index;
                        updateNavDots();
                    };
                    
                    const label = document.createElement('label');
                    label.htmlFor = `option_${index}`;
                    label.innerHTML = option;
                    label.style.cssText = 'margin-left: 10px; cursor: pointer; flex: 1;';
                    
                    optionDiv.appendChild(input);
                    optionDiv.appendChild(label);
                    optionsContainer.appendChild(optionDiv);
                });
            }
            
            // 3 marta ko'rish ogohlantirishi
            const viewWarning = document.getElementById('viewWarning');
            viewWarning.classList.add('hidden');
            
            if (views >= 2) {
                viewWarning.classList.remove('hidden');
                document.getElementById('viewCount').textContent = views;
            }
            
            updateNavDots();
            updateNavigationButtons();
            
            // MathJax ni yangilash
            if (window.MathJax && MathJax.typesetPromise) {
                MathJax.typesetPromise();
            }
        }
        
        function updateNavigationButtons() {
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').disabled = currentQuestionIndex === randomizedTest.questions.length - 1;
        }
        
        // ==================== TEST BOSHLASH VA YAKUNLASH ====================
        function startTest() {
            testStarted = true;
            userAnswers = new Array(randomizedTest.questions.length);
            timeRemaining = (randomizedTest.durationMinutes || 30) * 60;
            questionViews = {};
            
            // Timer boshlash
            startTimer();
            buildNavDots();  // buildNavDots endi mavjud
            currentQuestionIndex = 0;
            renderQuestion();
            showScreen('question');
        }
        
        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeRemaining--;
                
                if (timeRemaining <= 0) {
                    finishTest();
                    return;
                }
                
                updateTimerDisplay();
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function nextQuestion() {
            if (currentQuestionIndex < randomizedTest.questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            }
        }
        
        function finishTest() {
            clearInterval(timerInterval);
            testStarted = false;
            
            // Natijalarni hisoblash
            let correctCount = 0;
            let totalScore = 0;
            
            randomizedTest.questions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                
                if (question.type === 'variant' && userAnswer === question.correctIndex) {
                    correctCount++;
                    totalScore += (question.points || 1);
                }
            });
            
            // Natijalarni ko'rsatish
            document.getElementById('finalScore').textContent = totalScore.toFixed(1);
            document.getElementById('correctCount').textContent = correctCount;
            document.getElementById('wrongCount').textContent = randomizedTest.questions.length - correctCount;
            
            showScreen('results');
            
            // Telegramga yuborish
            sendToTelegram(correctCount, totalScore);
        }
        
        async function sendToTelegram(correctCount, totalScore) {
            try {
                const message = `
ðŸ“Š TEST NATIJALARI
========================
ðŸ‘¤ O'quvchi: ${currentStudent?.fullName || '-'}
ðŸ« Sinf: ${currentClass}
ðŸ“ Test: ${testData?.title || '-'}
ðŸ”¢ Test kodi: ${currentTestCode}
========================
âœ… To'g'ri javoblar: ${correctCount}
âŒ Noto'g'ri javoblar: ${randomizedTest.questions.length - correctCount}
ðŸ“ˆ Umumiy ball: ${totalScore.toFixed(1)}
â±ï¸ Test yakunlandi
                `.trim();
                
                const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
                await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: TELEGRAM_CHAT_ID,
                        text: message
                    })
                });
            } catch (error) {
                console.error('Telegram xatosi:', error);
            }
        }
        
        // ==================== EKRANLARNI KO'RSATISH ====================
        function showScreen(screenName) {
            const screens = [
                'loadingScreen',
                'codeInputCard',
                'classSelectionCard',
                'studentSelectionCard',
                'introCard',
                'questionCard',
                'resultsCard'
            ];
            
            screens.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            
            document.getElementById(screenName + (screenName === 'loading' ? 'Screen' : 'Card')).classList.remove('hidden');
        }
        
        // ==================== DASTURNI ISHGA TUSHIRISH ====================
        async function initializeApp() {
            // Bannerlarni yaratish
            createBanners();
            
            // URL dan test kodini olish
            const urlParams = new URLSearchParams(window.location.search);
            const urlCode = urlParams.get('code');
            
            if (urlCode) {
                document.getElementById('testCodeInput').value = urlCode;
                await handleTestCodeLoad();
            } else {
                showScreen('codeInput');
            }
            
            setupEventListeners();
        }
        
        function setupEventListeners() {
            // Test kodini yuklash
            document.getElementById('loadTestBtn').onclick = handleTestCodeLoad;
            document.getElementById('testCodeInput').onkeypress = (e) => {
                if (e.key === 'Enter') handleTestCodeLoad();
            };
            
            // Navigatsiya
            document.getElementById('nextToStudentBtn').onclick = () => {
                currentClass = document.getElementById('classSelect').value;
                if (!currentClass) {
                    alert('Iltimos, sinfni tanlang');
                    return;
                }
                loadStudents(currentClass);
                showScreen('studentSelection');
            };
            
            document.getElementById('backToCodeBtn').onclick = () => showScreen('codeInput');
            document.getElementById('nextToIntroBtn').onclick = handleStudentSelection;
            document.getElementById('backToClassBtn').onclick = () => showScreen('classSelection');
            document.getElementById('startTestBtn').onclick = startTest;
            
            // Savol navigatsiyasi
            document.getElementById('prevBtn').onclick = () => {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    renderQuestion();
                }
            };
            
            document.getElementById('nextBtn').onclick = () => {
                if (currentQuestionIndex < randomizedTest.questions.length - 1) {
                    currentQuestionIndex++;
                    renderQuestion();
                }
            };
            
            document.getElementById('finishBtn').onclick = () => {
                if (confirm('Testni yakunlashni xohlaysizmi?')) {
                    finishTest();
                }
            };
            
            document.getElementById('restartBtn').onclick = () => {
                window.location.reload();
            };
        }
        
        async function handleTestCodeLoad() {
            const code = document.getElementById('testCodeInput').value.trim();
            if (!code) {
                alert('Iltimos, test kodini kiriting');
                return;
            }
            
            currentTestCode = code;
            const loaded = await loadTestData(code);
            
            if (loaded) {
                // Sinflarni yuklash
                classes = await loadJSON('sinflar.json');
                if (classes && classes.length > 0) {
                    const classSelect = document.getElementById('classSelect');
                    classSelect.innerHTML = '<option value="">Sinfni tanlang</option>';
                    classes.forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls;
                        option.textContent = cls;
                        classSelect.appendChild(option);
                    });
                }
                showScreen('classSelection');
            }
        }
        
        async function loadStudents(className) {
            students = await loadJSON(`${className}.json`);
            if (students && students.length > 0) {
                const studentSelect = document.getElementById('studentSelect');
                studentSelect.innerHTML = '<option value="">O\'quvchini tanlang</option>';
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.fullName;
                    studentSelect.appendChild(option);
                });
            }
        }
        
        function handleStudentSelection() {
            const studentId = document.getElementById('studentSelect').value;
            if (!studentId) {
                alert('Iltimos, o\'quvchini tanlang');
                return;
            }
            
            currentStudent = students.find(s => s.id == studentId);
            if (!currentStudent) {
                alert('O\'quvchi topilmadi');
                return;
            }
            
            // Test ma'lumotlarini ko'rsatish
            document.getElementById('testTitle').textContent = testData.title;
            document.getElementById('testDescription').textContent = testData.description;
            document.getElementById('totalQuestions').textContent = testData.questions.length;
            document.getElementById('testDuration').textContent = (testData.durationMinutes || 30) + ' daqiqa';
            document.getElementById('studentName').textContent = currentStudent.fullName;
            
            showScreen('intro');
        }
        
        // Dasturni ishga tushirish
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Loading spinner uchun CSS
        const style = document.createElement('style');
        style.textContent = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`;
        document.head.appendChild(style);
    </script>
</body>
</html>