<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1-IMI & LeaderMath - Test Tizimi</title>
    
    <!-- MathJax - Yaxshilangan konfiguratsiya -->
    <script>
        window.MathJax = {
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    console.log('MathJax yuklandi');
                }
            },
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
                ignoreHtmlClass: 'tex2jax_ignore',
                enableMenu: false  // Oddiy rejim
            }
        };
    </script>
    <!-- MathJax manbasini o'zgartirish -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js" id="MathJax-script" async></script>
    
    <!-- Favicon (404 xatosini oldini olish) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìö</text></svg>">
    
    <style>
        /* 1. ASOSIY STILLAR - SODDA */
        :root {
            --brand: #2E8B57;
            --brand2: #1F6B45;
            --bg: #f8f9fa;
            --text: #333;
            --frame: #ddd;
            --danger: #e74c3c;
            --success: #27ae60;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
        }
        
        /* 2. BANNERLAR - SEKIN VA SODDA */
        .top-banner {
            background: linear-gradient(90deg, #1e3c72, #2a5298);
            color: white;
            height: 40px;
            overflow: hidden;
            position: relative;
        }
        
        .banner-content {
            display: flex;
            animation: scrollBanner 150s linear infinite;
            padding: 10px 0;
            white-space: nowrap;
        }
        
        .banner-item {
            display: inline-flex;
            align-items: center;
            margin-right: 50px;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .bottom-banner {
            background: linear-gradient(90deg, #2E8B57, #1F6B45);
            color: white;
            height: 35px;
            overflow: hidden;
            position: relative;
        }
        
        .bottom-banner-content {
            display: flex;
            animation: scrollBottomBanner 120s linear infinite;
            padding: 8px 0;
            white-space: nowrap;
        }
        
        @keyframes scrollBanner {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        
        @keyframes scrollBottomBanner {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        
        /* 3. ASOSIY KONTENT */
        .wrap {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            min-height: calc(100vh - 75px);
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid var(--frame);
        }
        
        .hidden {
            display: none !important;
        }
        
        /* 4. SAVOL STILLARI - RAMKASIZ RASM */
        .question-image-container {
            margin: 15px 0;
            text-align: center;
        }
        
        .question-image {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 4px;
        }
        
        .image-not-found {
            padding: 20px;
            color: #666;
            background: #f5f5f5;
            border-radius: 4px;
        }
        
        /* 5. TUGMALAR VA INPUT */
        .btn {
            background: var(--brand);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 10px;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: var(--brand2);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--frame);
            border-radius: 6px;
            font-size: 16px;
        }
        
        /* 6. NAV DOTS - QULF TIZIMI */
        .nav-dots {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .dot {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            border: 1px solid var(--frame);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: white;
            position: relative;
        }
        
        .dot.active {
            background: var(--brand);
            color: white;
            border-color: var(--brand);
        }
        
        .dot.answered {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        
        .dot.locked {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
            cursor: not-allowed;
        }
        
        .dot.locked::after {
            content: "üîí";
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 10px;
        }
        
        /* 7. MATEMATIK EDITOR - SODDA */
        .math-editor-container {
            margin: 15px 0;
            border: 1px solid var(--frame);
            border-radius: 6px;
            padding: 15px;
        }
        
        #mathEditor {
            min-height: 80px;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 18px;
            width: 100%;
            font-family: 'Times New Roman', serif;
        }
        
        .math-keypad {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        
        .math-keypad-btn {
            padding: 8px;
            border: none;
            border-radius: 4px;
            background: #4f46e5;
            color: white;
            cursor: pointer;
        }
        
        /* 8. RESPONSIVE */
        @media (max-width: 768px) {
            .wrap {
                padding: 10px;
            }
            
            .card {
                padding: 15px;
            }
            
            .banner-item {
                font-size: 12px;
                margin-right: 30px;
            }
            
            .banner-content {
                animation-duration: 180s;
            }
            
            .bottom-banner-content {
                animation-duration: 150s;
            }
            
            .math-keypad {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .question-image {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- 1. YUQORI BANNER (SEKIN) -->
    <div class="top-banner" id="topBanner">
        <div class="banner-content">
            <!-- Kontent JavaScript orqali qo'shiladi -->
        </div>
    </div>
    
    <!-- 2. ASOSIY KONTENT -->
    <div class="wrap">
        <!-- Yuklanish ekrani -->
        <div id="loadingScreen" class="card">
            <div style="text-align: center;">
                <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--brand); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
                <h2>Yuklanmoqda...</h2>
            </div>
        </div>
        
        <!-- Test kodi kiritish -->
        <div id="codeInputCard" class="card hidden">
            <h1 style="text-align: center; color: var(--brand); margin-bottom: 20px;">Test Tizimi</h1>
            <p style="text-align: center; margin-bottom: 20px;">Test kodini kiriting:</p>
            
            <div class="input-group">
                <input type="text" id="testCodeInput" placeholder="Masalan: 8001" maxlength="10">
            </div>
            
            <button id="loadTestBtn" class="btn">Testni Yuklash</button>
        </div>
        
        <!-- Sinf tanlash -->
        <div id="classSelectionCard" class="card hidden">
            <h2>Sinfni Tanlang</h2>
            
            <div class="input-group">
                <select id="classSelect">
                    <option value="">Sinfni tanlang</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button id="backToCodeBtn" class="btn btn-secondary">Orqaga</button>
                <button id="nextToStudentBtn" class="btn">Keyingi</button>
            </div>
        </div>
        
        <!-- O'quvchi tanlash -->
        <div id="studentSelectionCard" class="card hidden">
            <h2>O'quvchini Tanlang</h2>
            
            <div class="input-group">
                <select id="studentSelect">
                    <option value="">O'quvchini tanlang</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button id="backToClassBtn" class="btn btn-secondary">Orqaga</button>
                <button id="nextToIntroBtn" class="btn">Keyingi</button>
            </div>
        </div>
        
        <!-- Test kirish -->
        <div id="introCard" class="card hidden">
            <h1 id="testTitle">Test</h1>
            <p id="testDescription" style="text-align: center; margin-bottom: 20px;"></p>
            
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 20px 0;">
                <div style="background: #f5f5f5; padding: 10px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 12px; color: #666;">Savollar</div>
                    <div style="font-size: 20px; font-weight: bold; color: var(--brand);" id="totalQuestions">0</div>
                </div>
                <div style="background: #f5f5f5; padding: 10px; border-radius: 6px; text-align: center;">
                    <div style="font-size: 12px; color: #666;">Vaqt</div>
                    <div style="font-size: 20px; font-weight: bold; color: var(--brand);" id="testDuration">0 daq</div>
                </div>
            </div>
            
            <div id="selectedStudentInfo" style="background: #f0f9f0; padding: 10px; border-radius: 6px; margin: 15px 0; text-align: center;">
                <strong>O'quvchi:</strong> <span id="studentName">-</span>
            </div>
            
            <button id="startTestBtn" class="btn">Testni Boshlash</button>
        </div>
        
        <!-- Savol kartasi -->
        <div id="questionCard" class="card hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div style="font-size: 24px; font-weight: bold; color: var(--brand);" id="currentQ">1</div>
                <div style="background: #fee; color: var(--danger); padding: 8px 15px; border-radius: 4px; font-weight: bold;" id="timer">00:00</div>
            </div>
            
            <div style="color: var(--brand2); font-weight: bold; margin-bottom: 10px; padding-left: 5px; border-left: 3px solid var(--brand);" id="sectionName">Umumiy</div>
            
            <!-- Rasm -->
            <div id="questionImageContainer" class="question-image-container hidden">
                <img id="questionImage" class="question-image hidden" alt="Savol rasmi">
                <div id="imageNotFound" class="image-not-found hidden">Rasm yuklanmadi</div>
            </div>
            
            <!-- Savol matni -->
            <div id="questionText" style="font-size: 18px; margin: 15px 0; padding: 15px; background: #f9f9f9; border-radius: 6px;"></div>
            
            <!-- Variantlar -->
            <div id="optionsContainer" class="hidden">
                <!-- Variantlar bu yerga yuklanadi -->
            </div>
            
            <!-- Ochiq javob -->
            <div id="openAnswerContainer" class="hidden">
                <div class="math-editor-container">
                    <div id="mathEditor" contenteditable="true" placeholder="Javobingizni kiriting..."></div>
                    
                    <div class="math-keypad">
                        <button onclick="insertMath('7')" class="math-keypad-btn">7</button>
                        <button onclick="insertMath('8')" class="math-keypad-btn">8</button>
                        <button onclick="insertMath('9')" class="math-keypad-btn">9</button>
                        <button onclick="insertMath('+')" class="math-keypad-btn">+</button>
                        <button onclick="insertMath('(')" class="math-keypad-btn">(</button>
                        <button onclick="insertMath(')')" class="math-keypad-btn">)</button>
                        
                        <button onclick="insertMath('4')" class="math-keypad-btn">4</button>
                        <button onclick="insertMath('5')" class="math-keypad-btn">5</button>
                        <button onclick="insertMath('6')" class="math-keypad-btn">6</button>
                        <button onclick="insertMath('-')" class="math-keypad-btn">-</button>
                        <button onclick="insertMath('x')" class="math-keypad-btn">x</button>
                        <button onclick="insertMath('y')" class="math-keypad-btn">y</button>
                        
                        <button onclick="insertMath('1')" class="math-keypad-btn">1</button>
                        <button onclick="insertMath('2')" class="math-keypad-btn">2</button>
                        <button onclick="insertMath('3')" class="math-keypad-btn">3</button>
                        <button onclick="insertMath('*')" class="math-keypad-btn">√ó</button>
                        <button onclick="insertMath('a')" class="math-keypad-btn">a</button>
                        <button onclick="insertMath('b')" class="math-keypad-btn">b</button>
                        
                        <button onclick="insertMath('0')" class="math-keypad-btn">0</button>
                        <button onclick="insertMath('.')" class="math-keypad-btn">.</button>
                        <button onclick="insertMath('=')" class="math-keypad-btn">=</button>
                        <button onclick="insertMath('/')" class="math-keypad-btn">√∑</button>
                        <button onclick="insertMath('^')" class="math-keypad-btn">^</button>
                        <button onclick="clearMathEditor()" class="math-keypad-btn">C</button>
                    </div>
                </div>
            </div>
            
            <!-- 3 marta ko'rish ogohlantirishi -->
            <div id="viewWarning" class="hidden" style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; margin: 10px 0; border-radius: 4px; text-align: center;">
                <strong>Diqqat!</strong> Bu savolni <span id="viewCount">1</span> marta ko'rdiz. 3 martadan keyin qulfdanadi.
            </div>
            
            <!-- Navigatsiya nuqtalari -->
            <div class="nav-dots" id="navDots"></div>
            
            <!-- Tugmalar -->
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="prevBtn" class="btn btn-secondary">Oldingi</button>
                <button id="nextBtn" class="btn">Keyingi</button>
                <button id="finishBtn" class="btn" style="background: var(--danger);">Yakunlash</button>
            </div>
        </div>
        
        <!-- Natijalar -->
        <div id="resultsCard" class="card hidden">
            <div style="text-align: center;">
                <div style="width: 150px; height: 150px; border-radius: 50%; background: var(--brand); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 20px;">
                    <span style="font-size: 40px; font-weight: bold;" id="finalScore">0</span>
                    <small>ball</small>
                </div>
                
                <h2>Test Yakunlandi!</h2>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0;">
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 12px; color: #666;">To'g'ri javoblar</div>
                        <div style="font-size: 24px; font-weight: bold; color: var(--brand);" id="correctCount">0</div>
                    </div>
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 6px; text-align: center;">
                        <div style="font-size: 12px; color: #666;">Noto'g'ri javoblar</div>
                        <div style="font-size: 24px; font-weight: bold; color: #e74c3c;" id="wrongCount">0</div>
                    </div>
                </div>
                
                <div id="telegramStatus" style="background: #d1ecf1; padding: 10px; border-radius: 6px; margin: 15px 0; text-align: center;">
                    Natijalar yuborilmoqda...
                </div>
                
                <button id="restartBtn" class="btn">Yana Test Yechish</button>
            </div>
        </div>
    </div>
    
    <!-- 3. PASTKI BANNER (SEKIN) -->
    <div class="bottom-banner" id="bottomBanner">
        <div class="bottom-banner-content">
            <!-- Kontent JavaScript orqali qo'shiladi -->
        </div>
    </div>
    
    <script>
        // ==================== ASOSIY KONFIGURATSIYA ====================
        const TELEGRAM_BOT_TOKEN = "8036217508:AAHtKM7BhVc-KxR-C_19wWH4TrLSfLaQucI";
        const TELEGRAM_CHAT_ID = "2049065724";
        
        // ==================== GLOBAL O'ZGARUVCHILAR ====================
        let currentTestCode = '';
        let testData = null;
        let randomizedTest = null;
        let classes = [];
        let students = [];
        let currentClass = '';
        let currentStudent = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let timerInterval = null;
        let timeRemaining = 0;
        let timeSpent = 0;
        let testStarted = false;
        let violations = 0;
        let questionViews = {};
        let testStartTime = null;
        
        // ==================== BANNERLARNI YARATISH ====================
        function createBanners() {
            // Yuqori banner
            const topContent = document.querySelector('.top-banner .banner-content');
            for (let i = 0; i < 10; i++) {
                const item = document.createElement('div');
                item.className = 'banner-item';
                item.innerHTML = '1-IMI.UZ | LeaderMath.uz | Test Tizimi';
                topContent.appendChild(item);
            }
            
            // Pastki banner
            const bottomContent = document.querySelector('.bottom-banner .bottom-banner-content');
            for (let i = 0; i < 10; i++) {
                const item = document.createElement('div');
                item.className = 'banner-item';
                item.innerHTML = 'Telegram: @Help_LeaderMath_bot | Tel: +998 XX XXX XX XX';
                bottomContent.appendChild(item);
            }
        }
        
        // ==================== TEST FUNKSIYALARI ====================
        async function loadJSON(file) {
            try {
                const response = await fetch(file);
                if (!response.ok) throw new Error(`${file} yuklanmadi`);
                return await response.json();
            } catch (error) {
                console.error('Xato:', error);
                return null;
            }
        }
        
        async function loadTestData(code) {
            showScreen('loading');
            
            testData = await loadJSON(`${code}.json`);
            if (!testData) {
                alert(`"${code}" testi topilmadi`);
                showScreen('codeInput');
                return false;
            }
            
            // Javoblarni yuklash
            const answersData = await loadJSON(`${code}_javoblar.json`);
            if (answersData) {
                testData.questions.forEach((q, i) => {
                    if (answersData[i]) {
                        if (q.type === 'variant') q.correctIndex = answersData[i].correctIndex;
                        else if (q.type === 'open') q.correctAnswer = answersData[i].correctAnswer;
                    }
                });
            }
            
            // Testni random qilish
            randomizedTest = randomizeTest();
            return true;
        }
        
        function randomizeTest() {
            if (!testData) return null;
            
            const randomized = JSON.parse(JSON.stringify(testData));
            randomized.questions = shuffleArray(testData.questions.map((q, idx) => ({
                ...q,
                originalIndex: idx
            })));
            
            // Variantlarni random qilish
            randomized.questions.forEach(question => {
                if (question.type === 'variant' && question.options) {
                    const originalOptions = [...question.options];
                    const shuffledOptions = shuffleArray(originalOptions);
                    
                    if (question.correctIndex !== undefined) {
                        const correctAnswer = originalOptions[question.correctIndex];
                        question.correctIndex = shuffledOptions.indexOf(correctAnswer);
                    }
                    
                    question.options = shuffledOptions;
                    question.originalOptions = originalOptions;
                }
            });
            
            return randomized;
        }
        
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        // ==================== 3 MARTALIK KO'RISH TIZIMI ====================
        function checkQuestionView(questionIndex) {
            if (!questionViews[questionIndex]) questionViews[questionIndex] = 1;
            else questionViews[questionIndex]++;
            
            if (questionViews[questionIndex] >= 3) {
                updateNavDots();
                // Agar joriy savol qulflangan bo'lsa
                if (currentQuestionIndex === questionIndex && !document.querySelector('.lock-overlay')) {
                    showLockedQuestion();
                }
            }
            
            return questionViews[questionIndex];
        }
        
        function isQuestionLocked(questionIndex) {
            return questionViews[questionIndex] >= 3;
        }
        
        function showLockedQuestion() {
            const lockDiv = document.createElement('div');
            lockDiv.className = 'lock-overlay';
            lockDiv.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); z-index: 1000; display: flex; justify-content: center; align-items: center;">
                    <div style="background: white; padding: 30px; border-radius: 10px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.2); max-width: 400px;">
                        <h2 style="color: #e74c3c; margin-bottom: 15px;">üîí Savol Qulfdanadi</h2>
                        <p>Bu savolni 3 marta ko'rdingiz. Keyingi savolga o'ting.</p>
                        <button onclick="nextUnlockedQuestion()" style="margin-top: 20px; padding: 10px 20px; background: #2E8B57; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Keyingi savol
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(lockDiv);
        }
        
        function nextUnlockedQuestion() {
            // Lock overlayni olib tashlash
            const lock = document.querySelector('.lock-overlay');
            if (lock) lock.remove();
            
            // Keyingi qulflanmagan savolni topish
            let nextIndex = currentQuestionIndex;
            for (let i = currentQuestionIndex + 1; i < randomizedTest.questions.length; i++) {
                if (!isQuestionLocked(i)) {
                    nextIndex = i;
                    break;
                }
            }
            
            if (nextIndex !== currentQuestionIndex) {
                currentQuestionIndex = nextIndex;
                renderQuestion();
            }
        }
        
        // ==================== SAVOLNI KO'RSATISH ====================
        function renderQuestion() {
            if (!randomizedTest) return;
            
            const question = randomizedTest.questions[currentQuestionIndex];
            const views = checkQuestionView(currentQuestionIndex);
            
            // Savol raqami
            document.getElementById('currentQ').textContent = currentQuestionIndex + 1;
            
            // Rasm
            const imgContainer = document.getElementById('questionImageContainer');
            const imgElement = document.getElementById('questionImage');
            const imgNotFound = document.getElementById('imageNotFound');
            
            imgContainer.classList.add('hidden');
            imgElement.classList.add('hidden');
            imgNotFound.classList.add('hidden');
            
            if (question.hasImage) {
                const imgNum = question.originalIndex + 1;
                const imgPath = `${currentTestCode}/${imgNum}.png`;
                
                imgContainer.classList.remove('hidden');
                
                const img = new Image();
                img.onload = function() {
                    imgElement.src = imgPath;
                    imgElement.classList.remove('hidden');
                };
                img.onerror = function() {
                    imgNotFound.classList.remove('hidden');
                };
                img.src = imgPath;
            }
            
            // Savol matni
            document.getElementById('questionText').innerHTML = question.text || '';
            
            // Variantlar yoki ochiq javob
            document.getElementById('optionsContainer').classList.add('hidden');
            document.getElementById('openAnswerContainer').classList.add('hidden');
            document.getElementById('viewWarning').classList.add('hidden');
            
            if (views >= 2) {
                document.getElementById('viewWarning').classList.remove('hidden');
                document.getElementById('viewCount').textContent = views;
            }
            
            if (question.type === 'variant') {
                document.getElementById('optionsContainer').classList.remove('hidden');
                const optionsContainer = document.getElementById('optionsContainer');
                optionsContainer.innerHTML = '';
                
                question.options.forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.style.cssText = 'display: flex; align-items: center; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; cursor: pointer;';
                    
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = 'questionOption';
                    input.value = index;
                    input.id = `option_${index}`;
                    
                    if (userAnswers[currentQuestionIndex] === index) {
                        input.checked = true;
                        optionDiv.style.background = '#e8f5ef';
                        optionDiv.style.borderColor = '#2E8B57';
                    }
                    
                    input.addEventListener('change', () => {
                        // Barcha variantlardan tanlangan stilni olib tashlash
                        document.querySelectorAll('#optionsContainer > div').forEach(div => {
                            div.style.background = 'white';
                            div.style.borderColor = '#ddd';
                        });
                        
                        // Tanlangan variantga stil berish
                        optionDiv.style.background = '#e8f5ef';
                        optionDiv.style.borderColor = '#2E8B57';
                        
                        // Javobni saqlash
                        userAnswers[currentQuestionIndex] = index;
                        updateNavDots();
                    });
                    
                    const label = document.createElement('label');
                    label.htmlFor = `option_${index}`;
                    label.innerHTML = option;
                    label.style.marginLeft = '10px';
                    label.style.cursor = 'pointer';
                    label.style.flex = '1';
                    
                    optionDiv.appendChild(input);
                    optionDiv.appendChild(label);
                    optionsContainer.appendChild(optionDiv);
                });
            } else if (question.type === 'open') {
                document.getElementById('openAnswerContainer').classList.remove('hidden');
                const editor = document.getElementById('mathEditor');
                editor.innerHTML = userAnswers[currentQuestionIndex] || '';
            }
            
            updateNavDots();
            updateNavigationButtons();
            
            // MathJax ni yangilash
            if (window.MathJax && MathJax.typesetPromise) {
                MathJax.typesetPromise();
            }
        }
        
        function updateNavDots() {
            const dotsContainer = document.getElementById('navDots');
            if (!dotsContainer || !randomizedTest) return;
            
            dotsContainer.innerHTML = '';
            
            randomizedTest.questions.forEach((_, index) => {
                const dot = document.createElement('div');
                dot.className = 'dot';
                dot.textContent = index + 1;
                
                if (index === currentQuestionIndex) {
                    dot.classList.add('active');
                }
                
                if (userAnswers[index] !== undefined) {
                    dot.classList.add('answered');
                }
                
                if (isQuestionLocked(index)) {
                    dot.classList.add('locked');
                    dot.title = 'Bu savol qulfdanadi';
                    dot.onclick = null;
                } else {
                    dot.onclick = () => {
                        checkQuestionView(currentQuestionIndex);
                        currentQuestionIndex = index;
                        renderQuestion();
                    };
                }
                
                dotsContainer.appendChild(dot);
            });
        }
        
        function updateNavigationButtons() {
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').disabled = currentQuestionIndex === randomizedTest.questions.length - 1;
        }
        
        // ==================== MATEMATIK EDITOR ====================
        function insertMath(text) {
            const editor = document.getElementById('mathEditor');
            editor.focus();
            document.execCommand('insertText', false, text);
            saveMathAnswer();
        }
        
        function clearMathEditor() {
            const editor = document.getElementById('mathEditor');
            editor.innerHTML = '';
            saveMathAnswer();
        }
        
        function saveMathAnswer() {
            const editor = document.getElementById('mathEditor');
            if (editor) {
                userAnswers[currentQuestionIndex] = editor.innerHTML;
                updateNavDots();
            }
        }
        
        // ==================== TEST BOSHLASH VA YAKUNLASH ====================
        function startTest() {
            testStarted = true;
            testStartTime = new Date();
            userAnswers = new Array(randomizedTest.questions.length);
            timeRemaining = (randomizedTest.durationMinutes || 30) * 60;
            timeSpent = 0;
            violations = 0;
            questionViews = {};
            
            // Timer boshlash
            startTimer();
            buildNavDots();
            currentQuestionIndex = 0;
            renderQuestion();
            showScreen('question');
        }
        
        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeRemaining--;
                timeSpent++;
                
                if (timeRemaining <= 0) {
                    finishTest();
                    return;
                }
                
                updateTimerDisplay();
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        async function finishTest() {
            clearInterval(timerInterval);
            testStarted = false;
            
            const results = calculateResults();
            
            // Natijalarni ko'rsatish
            document.getElementById('finalScore').textContent = results.finalScore.toFixed(1);
            document.getElementById('correctCount').textContent = results.correctCount;
            document.getElementById('wrongCount').textContent = results.wrongCount;
            
            const minutes = Math.floor(timeSpent / 60);
            const seconds = timeSpent % 60;
            document.getElementById('timeUsed').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            showScreen('results');
            
            // Telegramga yuborish
            const message = formatResultsForTelegram(results);
            await sendToTelegram(message);
        }
        
        function calculateResults() {
            let correctCount = 0;
            let totalScore = 0;
            
            randomizedTest.questions.forEach((question, index) => {
                const userAnswer = userAnswers[index];
                
                if (question.type === 'variant') {
                    if (userAnswer === question.correctIndex) {
                        correctCount++;
                        totalScore += (question.points || 1);
                    }
                } else if (question.type === 'open') {
                    if (userAnswer && userAnswer.trim() !== '') {
                        correctCount++;
                        totalScore += (question.points || 1);
                    }
                }
            });
            
            return {
                correctCount,
                wrongCount: randomizedTest.questions.length - correctCount,
                totalScore,
                finalScore: totalScore
            };
        }
        
        // ==================== TELEGRAM FUNKSIYALARI ====================
        async function sendToTelegram(message) {
            try {
                const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: TELEGRAM_CHAT_ID,
                        text: message,
                        parse_mode: 'HTML'
                    })
                });
                
                const data = await response.json();
                const statusElement = document.getElementById('telegramStatus');
                
                if (data.ok) {
                    statusElement.innerHTML = '<div style="color: #155724;">‚úÖ Natijalar yuborildi!</div>';
                } else {
                    statusElement.innerHTML = '<div style="color: #721c24;">‚ùå Xatolik yuz berdi</div>';
                }
            } catch (error) {
                console.error('Telegram xatosi:', error);
                document.getElementById('telegramStatus').innerHTML = '<div style="color: #721c24;">‚ùå Internet aloqasi yo\'q</div>';
            }
        }
        
        function formatResultsForTelegram(results) {
            const testEndTime = new Date();
            const testDuration = Math.floor((testEndTime - testStartTime) / 1000);
            const minutes = Math.floor(testDuration / 60);
            const seconds = testDuration % 60;
            
            let message = `<b>üìä TEST NATIJALARI</b>\n`;
            message += `<b>========================</b>\n`;
            message += `<b>üë§ O'quvchi:</b> ${currentStudent.fullName}\n`;
            message += `<b>üè´ Sinf:</b> ${currentClass}\n`;
            message += `<b>üìù Test:</b> ${testData.title}\n`;
            message += `<b>üî¢ Test kodi:</b> ${currentTestCode}\n`;
            message += `<b>========================</b>\n`;
            message += `<b>‚úÖ To'g'ri javoblar:</b> ${results.correctCount}\n`;
            message += `<b>‚ùå Noto'g'ri javoblar:</b> ${results.wrongCount}\n`;
            message += `<b>üìà Umumiy ball:</b> ${results.totalScore.toFixed(1)}\n`;
            message += `<b>‚è±Ô∏è Sarflangan vaqt:</b> ${minutes} daqiqa ${seconds} soniya\n`;
            
            return message;
        }
        
        // ==================== EKRANLARNI KO'RSATISH ====================
        function showScreen(screenName) {
            ['loadingScreen', 'codeInputCard', 'classSelectionCard', 'studentSelectionCard', 'introCard', 'questionCard', 'resultsCard']
                .forEach(id => document.getElementById(id).classList.add('hidden'));
            
            document.getElementById(screenName + (screenName === 'loading' ? 'Screen' : 'Card')).classList.remove('hidden');
        }
        
        // ==================== DASTURNI ISHGA TUSHIRISH ====================
        async function initializeApp() {
            // Bannerlarni yaratish
            createBanners();
            
            // URL dan test kodini olish
            const urlParams = new URLSearchParams(window.location.search);
            const urlCode = urlParams.get('code');
            
            if (urlCode) {
                document.getElementById('testCodeInput').value = urlCode;
                await handleTestCodeLoad();
            } else {
                showScreen('codeInput');
            }
            
            setupEventListeners();
        }
        
        function setupEventListeners() {
            // Test kodini yuklash
            document.getElementById('loadTestBtn').addEventListener('click', handleTestCodeLoad);
            document.getElementById('testCodeInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleTestCodeLoad();
            });
            
            // Navigatsiya
            document.getElementById('nextToStudentBtn').addEventListener('click', () => {
                currentClass = document.getElementById('classSelect').value;
                if (!currentClass) {
                    alert('Iltimos, sinfni tanlang');
                    return;
                }
                loadStudents(currentClass);
                showScreen('studentSelection');
            });
            
            document.getElementById('backToCodeBtn').addEventListener('click', () => showScreen('codeInput'));
            document.getElementById('nextToIntroBtn').addEventListener('click', handleStudentSelection);
            document.getElementById('backToClassBtn').addEventListener('click', () => showScreen('classSelection'));
            document.getElementById('startTestBtn').addEventListener('click', startTest);
            
            // Savol navigatsiyasi
            document.getElementById('prevBtn').addEventListener('click', () => {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    renderQuestion();
                }
            });
            
            document.getElementById('nextBtn').addEventListener('click', () => {
                if (currentQuestionIndex < randomizedTest.questions.length - 1) {
                    currentQuestionIndex++;
                    renderQuestion();
                }
            });
            
            document.getElementById('finishBtn').addEventListener('click', () => {
                if (confirm('Testni yakunlashni xohlaysizmi?')) {
                    finishTest();
                }
            });
            
            document.getElementById('restartBtn').addEventListener('click', () => {
                window.location.reload();
            });
            
            // Matematik editor
            document.getElementById('mathEditor')?.addEventListener('input', saveMathAnswer);
        }
        
        async function handleTestCodeLoad() {
            const code = document.getElementById('testCodeInput').value.trim();
            if (!code) {
                alert('Iltimos, test kodini kiriting');
                return;
            }
            
            currentTestCode = code;
            const loaded = await loadTestData(code);
            
            if (loaded) {
                // Sinflarni yuklash
                classes = await loadJSON('sinflar.json');
                if (classes && classes.length > 0) {
                    const classSelect = document.getElementById('classSelect');
                    classSelect.innerHTML = '<option value="">Sinfni tanlang</option>';
                    classes.forEach(cls => {
                        const option = document.createElement('option');
                        option.value = cls;
                        option.textContent = cls;
                        classSelect.appendChild(option);
                    });
                }
                showScreen('classSelection');
            }
        }
        
        async function loadStudents(className) {
            students = await loadJSON(`${className}.json`);
            if (students && students.length > 0) {
                const studentSelect = document.getElementById('studentSelect');
                studentSelect.innerHTML = '<option value="">O\'quvchini tanlang</option>';
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.fullName;
                    studentSelect.appendChild(option);
                });
            }
        }
        
        function handleStudentSelection() {
            const studentId = document.getElementById('studentSelect').value;
            if (!studentId) {
                alert('Iltimos, o\'quvchini tanlang');
                return;
            }
            
            currentStudent = students.find(s => s.id == studentId);
            if (!currentStudent) {
                alert('O\'quvchi topilmadi');
                return;
            }
            
            // Test ma'lumotlarini ko'rsatish
            document.getElementById('testTitle').textContent = testData.title;
            document.getElementById('testDescription').textContent = testData.description;
            document.getElementById('totalQuestions').textContent = testData.questions.length;
            document.getElementById('testDuration').textContent = (testData.durationMinutes || 30) + ' daqiqa';
            document.getElementById('studentName').textContent = currentStudent.fullName;
            
            showScreen('intro');
        }
        
        // Dasturni ishga tushirish
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Kontekst menyusini bloklash (test davomida)
        document.addEventListener('contextmenu', (e) => {
            if (testStarted) e.preventDefault();
        });
        
        // Loading spinner uchun CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>