<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Kvadrat Funksiya Grafigi</title>
    <style>
        /* Oldingi CSS kodlar o'zgarishsiz qoldi, faqat kerakli qismlar qo'shildi */
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #f8f9fa;
            --dark: #2c3e50;
            --gray: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            min-height: 100vh;
            padding: 10px;
            line-height: 1.5;
        }
        
        .container {
            max-width: 90%; 
            margin: 0 auto; 
            background-color: #fff; 
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow); 
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, var(--primary), var(--secondary)); 
            color: #fff; 
            padding: 15px 12px; 
            text-align: center; 
            position: relative;
        }
        
        .user-info { 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.15);
            padding: 6px 12px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            font-size: 0.9rem;
            margin-top: 8px;
        }
        
        .user-name { 
            font-weight: bold; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70%;
        }
      
        h1 { 
            font-size: 1.4rem; 
            margin-bottom: 5px; 
            font-weight: 700;
        }
        
        .subtitle { 
            font-size: 0.8rem; 
            opacity: .9; 
        }
        
        .content { 
            padding: 15px; 
            display: flex; 
            flex-direction: column;
            gap: 15px; 
        }
        
        .stats-container { 
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            background: var(--light); 
            padding: 12px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow); 
        }
        
        .stat { 
            text-align: center; 
            padding: 6px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .stat-value { 
            font-size: 1.2rem; 
            font-weight: 700; 
            color: var(--primary); 
            margin-bottom: 2px;
        }
        
        .stat-label { 
            font-size: 0.7rem; 
            color: var(--gray); 
            font-weight: 500;
        }
        
        .progress-container {
            margin: 10px 10px;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.75rem;
            color: var(--gray);
        }
        
        .progress-bar { 
            height: 6px; 
            background: #e9ecef; 
            border-radius: 10px; 
            overflow: hidden; 
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .progress { 
            height: 100%; 
            background: linear-gradient(to right, var(--success), var(--primary)); 
            width: 0%; 
            transition: width .5s; 
            border-radius: 10px;
        }
        
        .lives { 
            display: flex; 
            justify-content: center; 
            gap: 8px; 
            margin-bottom: 12px; 
        }
        
        .life { 
            width: 24px; 
            height: 24px; 
            background: var(--danger); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: #fff; 
            font-weight: 700;
            font-size: 0.8rem;
            box-shadow: 0 2px 4px rgba(231, 76, 60, 0.3);
            transition: var(--transition);
        }
        
        .life.lost { 
            background: #bdc3c7; 
            transform: scale(0.9);
            box-shadow: none;
        }
        
        .graph-container { 
            background: linear-gradient(135deg, #f1f9ff, #e3f2fd); 
            border-radius: var(--border-radius); 
            padding: 15px; 
            text-align: center; 
            margin-bottom: 12px; 
            border: 2px dashed var(--primary);
            box-shadow: var(--box-shadow);
            margin: 10px 10px;
            position: relative;
        }
        
        .question { 
            font-size: 1.1rem; 
            font-weight: 700; 
            color: var(--dark); 
            margin: 8px 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .difficulty-indicator { 
            text-align: center; 
            margin-top: 6px; 
            font-weight: 700; 
            color: var(--primary-dark);
            font-size: 0.8rem;
        }
        
        .input-container { 
            display: flex; 
            justify-content: space-between; 
            gap: 10px; 
            margin-bottom: 12px; 
            margin: 10px 10px;
        }
        
        .input-group { 
            text-align: center; 
            flex: 1;
            position: relative;
        }
        
        label { 
            display: block; 
            margin-bottom: 6px; 
            font-weight: 600; 
            color: var(--dark); 
            font-size: 0.8rem;
        }
        
        /* changed to text inputs to allow fractions; special handling in JS */
        input[type="text"] { 
            width: 100%; 
            padding: 8px 10px; 
            font-size: 1rem; 
            text-align: center; 
            border: 2px solid #e0e0e0; 
            border-radius: var(--border-radius); 
            transition: var(--transition);
            font-weight: 600;
        }
        
        input:focus { 
            border-color: var(--primary); 
            outline: none; 
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2); 
        }
        
        .keyboard-toggle {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            width: 36px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
        }
        
        .keyboard-toggle:hover {
            background: var(--primary-dark);
        }
        
        .math-keyboard {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #ddd;
            padding: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .keyboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 0 5px;
        }
        
        .keyboard-title {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }
        
        .keyboard-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
        }
        
        .keyboard-btn {
            background: #f1f3f4;
            border: 1px solid #dadce0;
            border-radius: 4px;
            padding: 10px 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .keyboard-btn:hover {
            background: #e8eaed;
        }
        
        .keyboard-btn:active {
            background: #dadce0;
        }
        
        .keyboard-btn.primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .keyboard-btn.primary:hover {
            background: var(--primary-dark);
        }
        
        .keyboard-btn.danger {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        
        .timer-container { 
            background: #fff3cd; 
            border-radius: var(--border-radius); 
            padding: 10px; 
            text-align: center; 
            margin-bottom: 12px; 
            border: 1px solid #ffeaa7; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-size: 0.85rem;
            margin: 10px 10px;
        }
        
        .timer { 
            font-weight: 700; 
            color: var(--warning); 
        }
        
        .buttons { 
            display: flex; 
            justify-content: center; 
            gap: 10px; 
            margin-bottom: 12px; 
            margin: 10px 10px;
        }
        
        button { 
            padding: 10px 16px; 
            font-size: 0.85rem; 
            font-weight: 600; 
            border: none; 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
            flex: 1;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
        }
        
        button:active {
            transform: translateY(-1px);
        }
        
        #check-btn { 
            background: var(--success); 
            color: #fff; 
        }
        
        #check-btn:hover { 
            background: #27ae60; 
        }
        
        #check-btn:disabled { 
            background: #bdc3c7; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }
        
        .result { 
            padding: 12px; 
            border-radius: var(--border-radius); 
            margin-bottom: 12px; 
            text-align: center; 
            display: none; 
            animation: fadeIn .4s; 
            box-shadow: var(--box-shadow);
            font-size: 0.85rem;
        }
        
        .correct { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        
        .incorrect { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        
        .game-over { 
            text-align: center; 
            padding: 20px; 
            background: #f8d7da; 
            border-radius: var(--border-radius); 
            margin-bottom: 12px; 
            display: none; 
            box-shadow: var(--box-shadow);
        }
        
        .game-over h2 { 
            color: #721c24; 
            margin-bottom: 10px; 
            font-size: 1.3rem;
        }
        
        .game-over p {
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        .restart-btn { 
            background: var(--primary); 
            color: #fff; 
            margin-top: 10px;
        }       
      
        .explanation {
            background: var(--light);
            border-radius: var(--border-radius);
            padding: 12px;
            box-shadow: var(--box-shadow);
            margin-top: 12px;
        }
        
        .explanation h3 {
            color: var(--dark);
            margin-bottom: 8px;
            text-align: center;
            font-size: 1rem;
        }
        
        .explanation p {
            margin-bottom: 6px;
            color: var(--gray);
            font-size: 0.8rem;
        }
        
        .explanation ul {
            padding-left: 16px;
            margin-bottom: 8px;
        }
        
        .explanation li {
            margin-bottom: 4px;
            color: var(--gray);
            font-size: 0.8rem;
        }
        
        @keyframes fadeIn { 
            from { opacity: 0 } 
            to { opacity: 1 } 
        }
        
        /* Reyting jadvali - faqat kerak bo'lganda ko'rsatiladi */
        .leaderboard-toggle {
            text-align: center;
            margin: 8px 0;
        }
        
        .leaderboard-toggle-btn {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 6px 12px;
            font-size: 0.8rem;
            box-shadow: none;
        }
        
        .leaderboard {
            display: none;
            background: var(--light); 
            border-radius: var(--border-radius); 
            padding: 12px;
            box-shadow: var(--box-shadow);
            margin-top: 10px;
        }
        
        .leaderboard h3 { 
            color: var(--dark); 
            margin-bottom: 10px; 
            text-align: center; 
            font-size: 1rem;
        }
        
        .leaderboard-list { 
            max-height: 150px; 
            overflow-y: auto; 
            border-radius: 8px;
            background: white;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .leaderboard-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 6px 8px; 
            border-bottom: 1px solid #e9ecef; 
            transition: var(--transition);
            font-size: 0.75rem;
        }
        
        .leaderboard-item:hover {
            background: #f8f9fa;
        }
        
        .leaderboard-rank { 
            font-weight: 700; 
            color: var(--primary); 
            min-width: 20px;
        }
        
        .leaderboard-name { 
            flex: 1; 
            margin: 0 6px; 
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .leaderboard-score { 
            font-weight: 700; 
            color: var(--warning); 
        }
        
        .current-user { 
            background: #e3f2fd; 
            border-radius: 4px; 
            font-weight: 600;
        }
        
        /* Canvas uchun */
        .graph-canvas {
            width: 100%;
            height: 200px;
            background-color: white;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        /* PC da klaviatura ko'rinmasin */
        @media (min-width: 769px) {
            .keyboard-toggle {
                display: none;
            }
            
            .math-keyboard {
                display: none !important;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 8px;
            }
            
            .content {
                padding: 12px;
            }
            
            header {
                padding: 12px 8px;
            }
            
            h1 {
                font-size: 1.2rem;
            }
            
            .question {
                font-size: 1rem;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
                padding: 10px;
            }
            
            .stat-value {
                font-size: 1.1rem;
            }
            
            .input-container {
                flex-direction: column;
                gap: 8px;
            }
            
            .buttons {
                flex-direction: column;
            }
            .keyboard-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container" role="main">
        <header>
            <h1>Kvadrat Funksiya Grafigi</h1>
            <div class="subtitle">Parabola Xususiyatlari Simulyatori</div>

            <div class="user-info" id="user-info" style="display:none;">
                <span class="user-name" id="user-name" aria-live="polite"></span>                
            </div>
        </header>      

            <div class="progress-container">
                <div class="progress-info">
                    <span>Darajalanish</span>
                    <span id="progress-percent">0%</span>
                </div>
                <div class="progress-bar" aria-hidden="true">
                    <div class="progress" id="progress-bar"></div>
                </div>
            </div>

            <div class="lives" id="lives-container" aria-label="Hayotlar">
                <div class="life" id="life-1">❤</div>
                <div class="life" id="life-2">❤</div>
                <div class="life" id="life-3">❤</div>
            </div>

            <div class="graph-container" aria-live="polite">
                <div class="question" id="question">Parabolaning vertex nuqtasi koordinatalarini toping</div>
                <div class="difficulty-indicator" id="difficulty-indicator">Boshlang'ich daraja</div>
                <canvas class="graph-canvas" id="graph-canvas" width="300" height="200"></canvas>
            </div>

            <div class="input-container">
                <div class="input-group">
                    <label for="answer1">Javob 1</label>
                    <input type="text" id="answer1" />
                    <button class="keyboard-toggle" data-target="answer1">⌨</button>
                </div>
                <div class="input-group">
                    <label for="answer2">Javob 2</label>
                    <input type="text" id="answer2" />
                    <button class="keyboard-toggle" data-target="answer2">⌨</button>
                </div>
            </div>

            <!-- Matematik Klaviatura (faqat mobil uchun) -->
            <div class="math-keyboard" id="math-keyboard" aria-hidden="true">
                <div class="keyboard-header">
                    <div class="keyboard-title">Matematik Klaviatura</div>
                </div>
                <div class="keyboard-grid">
                    <button class="keyboard-btn" data-value="7">7</button>
                    <button class="keyboard-btn" data-value="8">8</button>
                    <button class="keyboard-btn" data-value="9">9</button>
                    <button class="keyboard-btn" data-value="backspace">⌫</button>
                    
                    <button class="keyboard-btn" data-value="4">4</button>
                    <button class="keyboard-btn" data-value="5">5</button>
                    <button class="keyboard-btn" data-value="6">6</button>
                    <button class="keyboard-btn" data-value="-">-</button>
                    
                    <button class="keyboard-btn" data-value="1">1</button>
                    <button class="keyboard-btn" data-value="2">2</button>
                    <button class="keyboard-btn" data-value="3">3</button>
                    <button class="keyboard-btn" data-value="/">/</button>
                    
                    <button class="keyboard-btn" data-value="0">0</button>
                    <button class="keyboard-btn" data-value=".">.</button>
                    <button class="keyboard-btn primary" data-value="switch">↔</button>
                    <button class="keyboard-btn primary" data-value="clear">C</button>
                </div>
            </div>

            <div class="timer-container">
                <div>Vaqt: <span class="timer" id="timer">0.0</span> soniya</div>
            </div>

            <div class="buttons">
                <button id="check-btn" aria-label="Javobni tekshirish">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                    </svg>
                    Tekshirish
                </button>
            </div>
<div class="content">
            <div class="stats-container" aria-hidden="false">
                <div class="stat">
                    <div class="stat-value" id="question-count">0</div>
                    <div class="stat-label">Savol</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="correct-count">0</div>
                    <div class="stat-label">To'g'ri</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="xp-count">0</div>
                    <div class="stat-label">XP</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="difficulty-level">1</div>
                    <div class="stat-label">Daraja</div>
                </div>
            </div>
            <div class="result" id="result" role="status" aria-live="polite"></div>

            <div class="game-over" id="game-over" role="dialog" aria-modal="true">
                <h2>O'yin Tugadi!</h2>
                <p>Yakuniy natijangiz:</p>
                <p><strong>Savollar:</strong> <span id="final-questions">0</span></p>
                <p><strong>To'g'ri javoblar:</strong> <span id="final-correct">0</span></p>
                <p><strong>XP:</strong> <span id="final-xp">0</span></p>
                <button class="restart-btn" id="restart-btn">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                    </svg>
                    Qayta boshlash
                </button>
            </div>
            <div class="leaderboard-toggle">
                <button class="leaderboard-toggle-btn" id="leaderboard-toggle">
                    Reyting jadvalini ko'rsatish
                </button>
            </div>

            <div class="leaderboard" id="leaderboard">
                <h3>Reyting Jadvali</h3>
                <div class="leaderboard-list" id="leaderboard-list">
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank">1</div>
                        <div class="leaderboard-name">Namuna Foydalanuvchi</div>
                        <div class="leaderboard-score">100</div>
                    </div>
                </div>
            </div>

            <div class="explanation">
                <h3>Kvadrat Funksiya Grafigi</h3>
                <p>y = ax² + bx + c ko'rinishidagi funksiya grafigi parabola deb ataladi.</p>
                <ul>
                    <li>Vertex (uch nuqta): (h, k) = (-b/(2a), f(h))</li>
                    <li>Simmetriya o'qi: x = h</li>
                    <li>Parabola a>0 bo'lsa yuqoriga, a<0 bo'lsa pastga ochiladi</li>
                    <li>Y o'qi bilan kesishish nuqtasi: (0, c)</li>
                    <li>X o'qi bilan kesishish nuqtalari: ax² + bx + c = 0 tenglamaning ildizlari</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>

    <!-- Config va AuthUtils skriptlari -->
    <script src="/demo/firebase-config.js"></script>
    <script src="/demo/auth-utils.js"></script>

    <script>
      // --- O'yin holati o'zgaruvchilari ---
      let questionCount = 0;
      let correctCount = 0;
      let xpCount = 0;
      let difficultyLevel = 1;
      let startTime = null;
      let timerInterval = null;
      let currentQuestion = {};
      let autoNextTimeout = null;
      let incorrectCount = 0;
      const maxIncorrect = 3;
      let gameActive = true;
      let currentUser = null;
      let userData = null;
      let activeInput = null;
      let timeUpTimeout = null;
      let questionTypes = [
        "vertex",
        "axis",
        "yIntercept",
        "xIntercepts",
        "direction",
        "minMax"
      ];

      // --- Yordamchi funksiyalar ---
      function isMobileDevice() {
          return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
      }

      function parseFractionalNumber(str) {
          if (typeof str !== 'string') return NaN;
          const s = str.trim();
          if (s === '') return NaN;

          if (s.includes('/')) {
              const parts = s.split('/');
              if (parts.length !== 2) return NaN;
              const a = parseFloat(parts[0]);
              const b = parseFloat(parts[1]);
              if (!isFinite(a) || !isFinite(b) || b === 0) return NaN;
              return a / b;
          } else {
              const v = parseFloat(s);
              if (!isFinite(v)) return NaN;
              return v;
          }
      }

      function nearlyEqual(a, b, eps = 1e-9) {
          return Math.abs(a - b) <= eps;
      }

      // Parabola chizish funksiyasi
      function drawParabola(a, b, c) {
          const canvas = document.getElementById('graph-canvas');
          const ctx = canvas.getContext('2d');
          const width = canvas.width;
          const height = canvas.height;
          
          // Tozalash
          ctx.clearRect(0, 0, width, height);
          
          // Koordinata o'qlarini chizish
          ctx.beginPath();
          ctx.strokeStyle = '#ccc';
          ctx.lineWidth = 1;
          
          // Y o'qi
          ctx.moveTo(width/2, 0);
          ctx.lineTo(width/2, height);
          
          // X o'qi
          ctx.moveTo(0, height/2);
          ctx.lineTo(width, height/2);
          
          ctx.stroke();
          
          // Koordinata tizimi belgilari
          ctx.fillStyle = '#666';
          ctx.font = '10px Arial';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          
          // O'q belgilari
          ctx.fillText('y', width/2 - 10, 10);
          ctx.fillText('x', width - 10, height/2 + 10);
          ctx.fillText('O', width/2 + 5, height/2 + 10);
          
          // Parabolani chizish
          ctx.beginPath();
          ctx.strokeStyle = '#4361ee';
          ctx.lineWidth = 2;
          
          const scale = 20; // Masshtab
          const h = -b/(2*a); // Vertex x koordinatasi
          const k = a*h*h + b*h + c; // Vertex y koordinatasi
          
          // Parabola chizish
          for (let x = -width/(2*scale); x <= width/(2*scale); x += 0.1) {
              const y = a*x*x + b*x + c;
              const canvasX = width/2 + x * scale;
              const canvasY = height/2 - y * scale;
              
              if (x === -width/(2*scale)) {
                  ctx.moveTo(canvasX, canvasY);
              } else {
                  ctx.lineTo(canvasX, canvasY);
              }
          }
          
          ctx.stroke();
          
          // Vertex nuqtasini chizish
          ctx.beginPath();
          ctx.fillStyle = '#e74c3c';
          ctx.arc(width/2 + h * scale, height/2 - k * scale, 4, 0, Math.PI * 2);
          ctx.fill();
      }

      // Yangi savol yaratish
      function generateQuestion() {
          // a, b, c koeffitsiyentlarini generatsiya qilish
          let a, b, c;
          
          switch (difficultyLevel) {
              case 1:
                  a = Math.random() > 0.5 ? 1 : -1;
                  b = Math.floor(Math.random() * 11) - 5;
                  c = Math.floor(Math.random() * 11) - 5;
                  break;
              case 2:
                  a = Math.random() > 0.5 ? 1 : -1;
                  b = Math.floor(Math.random() * 21) - 10;
                  c = Math.floor(Math.random() * 21) - 10;
                  break;
              case 3:
                  a = Math.floor(Math.random() * 5) + 1;
                  if (Math.random() > 0.5) a *= -1;
                  b = Math.floor(Math.random() * 21) - 10;
                  c = Math.floor(Math.random() * 21) - 10;
                  break;
              case 4:
                  a = Math.floor(Math.random() * 8) + 1;
                  if (Math.random() > 0.5) a *= -1;
                  b = Math.floor(Math.random() * 31) - 15;
                  c = Math.floor(Math.random() * 31) - 15;
                  break;
              case 5:
                  a = Math.floor(Math.random() * 10) + 1;
                  if (Math.random() > 0.5) a *= -1;
                  b = Math.floor(Math.random() * 41) - 20;
                  c = Math.floor(Math.random() * 41) - 20;
                  break;
              default:
                  a = 1;
                  b = 0;
                  c = 0;
          }
          
          // Savol turini tanlash
          const questionType = questionTypes[Math.floor(Math.random() * questionTypes.length)];
          
          // Vertex hisoblash
          const h = -b/(2*a);
          const k = a*h*h + b*h + c;
          
          // Diskriminant
          const discriminant = b*b - 4*a*c;
          
          // X kesishish nuqtalari
          let x1, x2;
          if (discriminant >= 0) {
              x1 = (-b - Math.sqrt(discriminant))/(2*a);
              x2 = (-b + Math.sqrt(discriminant))/(2*a);
          }
          
          // Savol va javobni tayyorlash
          let questionText, correctAnswer1, correctAnswer2, answerLabel1, answerLabel2;
          
          switch (questionType) {
              case "vertex":
                  questionText = "Parabolaning vertex nuqtasi koordinatalarini toping";
                  correctAnswer1 = h;
                  correctAnswer2 = k;
                  answerLabel1 = "x";
                  answerLabel2 = "y";
                  break;
              case "axis":
                  questionText = "Parabolaning simmetriya o'qi tenglamasini toping";
                  correctAnswer1 = h;
                  correctAnswer2 = null;
                  answerLabel1 = "x =";
                  answerLabel2 = "";
                  break;
              case "yIntercept":
                  questionText = "Parabolaning Y o'qi bilan kesishish nuqtasini toping";
                  correctAnswer1 = c;
                  correctAnswer2 = null;
                  answerLabel1 = "y =";
                  answerLabel2 = "";
                  break;
              case "xIntercepts":
                  if (discriminant >= 0) {
                      questionText = "Parabolaning X o'qi bilan kesishish nuqtalarini toping";
                      correctAnswer1 = x1;
                      correctAnswer2 = x2;
                      answerLabel1 = "x₁";
                      answerLabel2 = "x₂";
                  } else {
                      // Agar ildizlar mavjud bo'lmasa, boshqa savol beramiz
                      return generateQuestion();
                  }
                  break;
              case "direction":
                  questionText = "Parabola qaysi tomonga ochiladi? (yuqori/pastga)";
                  correctAnswer1 = a > 0 ? "yuqori" : "pastga";
                  correctAnswer2 = null;
                  answerLabel1 = "Yo'nalish";
                  answerLabel2 = "";
                  break;
              case "minMax":
                  questionText = "Parabolaning eng katta/eng kichik qiymatini toping";
                  correctAnswer1 = k;
                  correctAnswer2 = null;
                  answerLabel1 = a > 0 ? "Minimum" : "Maksimum";
                  answerLabel2 = "";
                  break;
          }
          
          currentQuestion = {
              type: questionType,
              a, b, c,
              correctAnswer1, correctAnswer2,
              answerLabel1, answerLabel2
          };
          
          // Savolni ko'rsatish
          document.getElementById("question").textContent = questionText;
          
          // Input label'larini yangilash
          document.querySelector('label[for="answer1"]').textContent = answerLabel1;
          document.querySelector('label[for="answer2"]').textContent = answerLabel2;
          
          // Agar ikkinchi javob kerak bo'lmasa, ikkinchi inputni yashirish
          const answer2Group = document.querySelector('.input-group:nth-child(2)');
          if (correctAnswer2 === null) {
              answer2Group.style.display = 'none';
          } else {
              answer2Group.style.display = 'block';
          }
          
          // Grafikni chizish
          drawParabola(a, b, c);
      }

      // DOMContentLoaded — sahifa DOM to'liq yuklangandan keyin ishlaydi
      document.addEventListener('DOMContentLoaded', () => {
          // Elementlarni olinishi
          const logoutBtn = document.getElementById('logout-btn');
          const checkBtn = document.getElementById('check-btn');
          const answer1Input = document.getElementById('answer1');
          const answer2Input = document.getElementById('answer2');
          const restartBtn = document.getElementById('restart-btn');
          const leaderboardToggle = document.getElementById('leaderboard-toggle');
          const leaderboard = document.getElementById('leaderboard');
          const keyboardToggleBtns = document.querySelectorAll('.keyboard-toggle');
          const keyboardBtns = document.querySelectorAll('.keyboard-btn');
          const mathKeyboard = document.getElementById('math-keyboard');

          const mobile = isMobileDevice();

          // Agar mobil bo'lsa — device klaviaturasini ko'rsatmaslik uchun inputlarni readonly qilamiz
          if (mobile) {
              [answer1Input, answer2Input].forEach(inp => {
                  if (inp) {
                      inp.setAttribute('readonly', 'true');
                      inp.setAttribute('inputmode', 'none');
                      inp.addEventListener('touchstart', (e) => {
                          activeInput = inp;
                          mathKeyboard.style.display = 'block';
                          inp.focus();
                          e.preventDefault();
                      }, {passive:false});
                  }
              });
          } else {
              // Desktop uchun inputlar tahrirlanishi mumkin bo'lsin
              [answer1Input, answer2Input].forEach(inp => {
                  if (inp) {
                      inp.removeAttribute('readonly');
                  }
              });
          }

          // Matematik klaviatura funksiyalari
          keyboardToggleBtns.forEach(btn => {
              btn.addEventListener('click', () => {
                  const targetId = btn.getAttribute('data-target');
                  activeInput = document.getElementById(targetId);
                  mathKeyboard.style.display = 'block';
                  mathKeyboard.setAttribute('aria-hidden', 'false');
                  if (activeInput) activeInput.focus();
              });
          });

          // Klaviatura tugmalari
          keyboardBtns.forEach(btn => {
              btn.addEventListener('click', () => {
                  if (!activeInput) return;
                  
                  const value = btn.getAttribute('data-value');
                  const cur = activeInput.value || '';

                  switch(value) {
                      case 'backspace':
                          activeInput.value = cur.slice(0, -1);
                          break;
                      case 'clear':
                          activeInput.value = '';
                          break;
                      case 'switch':
                          if (activeInput.id === 'answer1') {
                              activeInput = document.getElementById('answer2');
                          } else {
                              activeInput = document.getElementById('answer1');
                          }
                          activeInput.focus();
                          break;
                      case '/':
                          if (!cur.includes('/')) {
                              if (cur === '' || cur === '-') {
                              } else {
                                  activeInput.value = cur + '/';
                              }
                          }
                          break;
                      case '.':
                          const segDot = cur.includes('/') ? cur.split('/').pop() : cur;
                          if (!segDot.includes('.')) activeInput.value = cur + '.';
                          break;
                      case '-':
                          if (cur === '') activeInput.value = '-';
                          else if (cur.endsWith('/')) activeInput.value = cur + '-';
                          break;
                      default:
                          activeInput.value = cur + value;
                  }
                  
                  activeInput.dispatchEvent(new Event('input', { bubbles: true }));
                  activeInput.focus();
              });
          });

          // Inputlarni bosganda (desktop)
          if (!mobile) {
              [answer1Input, answer2Input].forEach(input => {
                  input.addEventListener('focus', () => {
                      activeInput = input;
                  });
              });
          }

          // Ekranning boshqa joyiga bosganda klaviatura yopiladi
          document.addEventListener('click', (e) => {
              if (!mathKeyboard.contains(e.target) && 
                  !answer1Input.contains(e.target) && 
                  !answer2Input.contains(e.target) &&
                  !e.target.classList.contains('keyboard-toggle')) {
                  mathKeyboard.style.display = 'none';
                  mathKeyboard.setAttribute('aria-hidden', 'true');
                  if (activeInput) {
                      try { activeInput.blur(); } catch(e){/*ignore*/ }
                      activeInput = null;
                  }
              }
          });

          // Reyting jadvalini ko'rsatish/yashirish
          if (leaderboardToggle && leaderboard) {
              leaderboardToggle.addEventListener('click', () => {
                  if (leaderboard.style.display === 'block') {
                      leaderboard.style.display = 'none';
                      leaderboardToggle.textContent = 'Reyting jadvalini ko\'rsatish';
                  } else {
                      leaderboard.style.display = 'block';
                      leaderboardToggle.textContent = 'Reyting jadvalini yashirish';
                  }
              });
          }

          // Tugmalarga event listenerlar qo'shish
          if (logoutBtn) {
              logoutBtn.addEventListener('click', async () => {
                  if (typeof authUtils !== 'undefined' && authUtils.logout) {
                      try {
                          await authUtils.logout();
                      } catch (err) {
                          console.warn('Logout error:', err);
                      }
                  }
                  window.location.href = '/demo/login.html';
              });
          }

          if (checkBtn) {
              checkBtn.addEventListener('click', checkAnswer);
          }

          if (answer2Input) {
              answer2Input.addEventListener('keypress', (e) => {
                  if (e.key === 'Enter') checkAnswer();
              });
          }

          if (restartBtn) {
              restartBtn.addEventListener('click', restartGame);
          }

          // Avval hayot holatini yangilash
          updateLives();

          // Foydalanuvchi holatini kuzatish
          if (typeof authUtils !== 'undefined' && authUtils.onUserChange) {
              authUtils.onUserChange(async (user) => {
                  if (user) {
                      currentUser = user;
                      try {
                          userData = user.data;
                          const userNameEl = document.getElementById('user-name');
                          const userInfoEl = document.getElementById('user-info');
                          if (userNameEl) userNameEl.textContent = `${userData.fullName || 'Foydalanuvchi'}`;
                          if (userInfoEl) userInfoEl.style.display = 'flex';
                          
                          // Reyting jadvalini yuklash
                          loadLeaderboard();
                          
                          // O'yinni boshlash
                          startGameInitial();
                      } catch (err) {
                          console.error("Foydalanuvchi yuklash xatosi:", err);
                      }
                  } else {
                      // Foydalanuvchi mavjud emas, login sahifasiga yo'naltirish
                      window.location.href = '/demo/login.html';
                  }
              });
          } else {
              console.warn('AuthUtils mavjud emas — lokal testing rejimida ishlayapsiz.');
              // Agar AuthUtils bo'lmasa, shunchaki boshlang'ich savol bilan boshlaymiz (local testing)
              startGameInitial();
          }
      });

      // O'yinni boshlash
      function startGameInitial() {
          updateUIStats();
          updateLives();
          newQuestion();
      }

      // --- Yangi savol yaratish ---
      function newQuestion() {
          if (!gameActive) return;
          clearTimeout(autoNextTimeout);
          clearTimeout(timeUpTimeout);
          updateDifficulty();

          generateQuestion();

          // Inputlarni tozalash
          const answer1El = document.getElementById("answer1");
          const answer2El = document.getElementById("answer2");
          if (answer1El) answer1El.value = "";
          if (answer2El) answer2El.value = "";

          const resultDiv = document.getElementById("result");
          if (resultDiv) {
              resultDiv.style.display = "none";
              resultDiv.className = "result";
              resultDiv.innerHTML = "";
          }

          const checkBtn = document.getElementById("check-btn");
          if (checkBtn) checkBtn.disabled = false;

          resetTimer();
          startTimer();
          updateProgressBar();
          
          // 60 soniya chegarasi
          timeUpTimeout = setTimeout(() => {
              if (gameActive) {
                  timeUpAutoCheck();
              }
          }, 60000);
          
          // Birinchi inputga fokus qo'yish
          const answer1El = document.getElementById("answer1");
          if (answer1El) answer1El.focus();
      }

      // Vaqt tugaganda avtomatik tekshirish
      function timeUpAutoCheck() {
          if (!gameActive) return;
          
          stopTimer();
          const resultDiv = document.getElementById("result");
          if (resultDiv) {
              resultDiv.style.display = "block";
              resultDiv.className = "result incorrect";
              
              let correctAnswerText = "";
              switch (currentQuestion.type) {
                  case "vertex":
                      correctAnswerText = `To'g'ri javob: (${currentQuestion.correctAnswer1}, ${currentQuestion.correctAnswer2})`;
                      break;
                  case "axis":
                      correctAnswerText = `To'g'ri javob: x = ${currentQuestion.correctAnswer1}`;
                      break;
                  case "yIntercept":
                      correctAnswerText = `To'g'ri javob: y = ${currentQuestion.correctAnswer1}`;
                      break;
                  case "xIntercepts":
                      correctAnswerText = `To'g'ri javob: x₁ = ${currentQuestion.correctAnswer1}, x₂ = ${currentQuestion.correctAnswer2}`;
                      break;
                  case "direction":
                      correctAnswerText = `To'g'ri javob: ${currentQuestion.correctAnswer1}`;
                      break;
                  case "minMax":
                      correctAnswerText = `To'g'ri javob: ${currentQuestion.correctAnswer1}`;
                      break;
              }
              
              resultDiv.innerHTML = `<h3>⏰ Vaqt tugadi!</h3>
                  <p>60 soniya ichida javob berolmadingiz.</p>
                  <p>${correctAnswerText}</p>`;
          }

          incorrectCount++;
          updateLives();

          questionCount++;
          updateUIStats();

          if (incorrectCount >= maxIncorrect) {
              endGame();
              return;
          }

          // Keyingi savolga o'tish
          autoNextTimeout = setTimeout(newQuestion, 2000);
      }

      // --- Qiyinlik darajasini yangilash ---
      function updateDifficulty() {
          if (questionCount >= 20) difficultyLevel = 5;
          else if (questionCount >= 15) difficultyLevel = 4;
          else if (questionCount >= 10) difficultyLevel = 3;
          else if (questionCount >= 5) difficultyLevel = 2;
          else difficultyLevel = 1;

          const dlEl = document.getElementById("difficulty-level");
          if (dlEl) dlEl.textContent = difficultyLevel;

          const difficultyText = [
              "Boshlang'ich daraja",
              "O'rta daraja",
              "Qiyin daraja",
              "Juda qiyin daraja",
              "Murakkab daraja"
          ];
          const diEl = document.getElementById("difficulty-indicator");
          if (diEl) diEl.textContent = difficultyText[difficultyLevel - 1];
      }

      // --- Progress bar ---
      function updateProgressBar() {
          const progress = (questionCount % 5) * 20;
          const pb = document.getElementById("progress-bar");
          if (pb) pb.style.width = `${progress}%`;
      }

      // --- Timer funksiyalari ---
      function startTimer() {
          startTime = new Date();
          clearInterval(timerInterval);
          timerInterval = setInterval(updateTimer, 100);
      }
      function updateTimer() {
          if (!startTime) return;
          const currentTime = new Date();
          const timeDiff = (currentTime - startTime) / 1000;
          const timerEl = document.getElementById("timer");
          if (timerEl) timerEl.textContent = timeDiff.toFixed(1);
      }
      function stopTimer() { clearInterval(timerInterval); }
      function resetTimer() {
          stopTimer();
          startTime = null;
          const timerEl = document.getElementById("timer");
          if (timerEl) timerEl.textContent = "0.0";
      }

      // --- Hayotlarni yangilash ---
      function updateLives() {
          for (let i = 1; i <= maxIncorrect; i++) {
              const lifeElement = document.getElementById(`life-${i}`);
              if (!lifeElement) continue;
              if (i <= (maxIncorrect - incorrectCount)) lifeElement.classList.remove('lost');
              else lifeElement.classList.add('lost');
          }
      }

      // --- Reyting jadvalini yuklash ---
      async function loadLeaderboard() {
          if (typeof authUtils === 'undefined' || !authUtils.getLeaderboard) return;
          try {
              const result = await authUtils.getLeaderboard();
              if (result && result.success) {
                  const leaderboardList = document.getElementById('leaderboard-list');
                  if (!leaderboardList) return;
                  leaderboardList.innerHTML = '';
                  (result.leaderboard || []).forEach((item, index) => {
                      const leaderboardItem = document.createElement('div');
                      leaderboardItem.className = 'leaderboard-item';
                      if (currentUser && item.id === currentUser.docId) leaderboardItem.classList.add('current-user');
                      leaderboardItem.innerHTML = `
                          <div class="leaderboard-rank">${index + 1}</div>
                          <div class="leaderboard-name">${item.fullName || 'Foydalanuvchi'}</div>
                          <div class="leaderboard-score">${item.bestScore || 0}</div>
                      `;
                      leaderboardList.appendChild(leaderboardItem);
                  });
              }
          } catch (err) {
              console.error('Reyting jadvalini yuklashda xatolik:', err);
          }
      }

      // --- O'yinni tugatish ---
      async function endGame() {
          gameActive = false;
          stopTimer();
          clearTimeout(timeUpTimeout);
          const checkBtn = document.getElementById("check-btn");
          if (checkBtn) checkBtn.disabled = true;

          // Natijalarni hisoblash
          const endTime = new Date();
          const totalTime = startTime ? (endTime - startTime) / 1000 : 0;
          
          const finalStats = {
              score: xpCount,
              correctAnswers: correctCount,
              totalQuestions: questionCount,
              difficulty: difficultyLevel,
              xpEarned: xpCount,
              timeSpent: totalTime
          };

          // Firebasega natijalarni saqlash
          if (currentUser && typeof authUtils !== 'undefined') {
              try {
                  // O'yin natijasini saqlash
                  await authUtils.saveGameResult(finalStats);
                  
                  // Eng yaxshi natijani yangilash
                  const bestScoreResult = await authUtils.updateBestScore(xpCount);
                  
                  // Yangi rekord bo'lsa bildirish
                  if (bestScoreResult && bestScoreResult.isNewRecord) {
                      const gameOverEl = document.getElementById("game-over");
                      if (gameOverEl) {
                          const recordNote = document.createElement('div');
                          recordNote.className = 'result correct';
                          recordNote.style.marginTop = '10px';
                          recordNote.innerHTML = `<h3>🎉 Yangi rekord!</h3><p>Siz o'z rekordingizni yangiladingiz: ${xpCount} XP</p>`;
                          gameOverEl.appendChild(recordNote);
                      }
                  }
                  
                  // Reyting jadvalini yangilash
                  loadLeaderboard();
              } catch (error) {
                  console.error('Natijalarni saqlashda xatolik:', error);
              }
          }

          // UI ni yangilash
          document.getElementById("final-questions").textContent = questionCount;
          document.getElementById("final-correct").textContent = correctCount;
          document.getElementById("final-xp").textContent = xpCount;

          const gameOverEl = document.getElementById("game-over");
          if (gameOverEl) gameOverEl.style.display = 'block';
      }

      // --- Qayta boshlash ---
      function restartGame() {
          questionCount = 0;
          correctCount = 0;
          xpCount = 0;
          incorrectCount = 0;
          gameActive = true;

          document.getElementById("question-count").textContent = questionCount;
          document.getElementById("correct-count").textContent = correctCount;
          document.getElementById("xp-count").textContent = xpCount;
          const gameOverEl = document.getElementById("game-over");
          if (gameOverEl) gameOverEl.style.display = 'none';

          updateLives();
          updateUIStats();
          newQuestion();
      }

      // --- Javobni tekshirish ---
      async function checkAnswer() {
          if (!gameActive) return;

          // Yangi: vaqt chegarasini tozalash
          clearTimeout(timeUpTimeout);

          // Kiritilgan qiymatlarni olish
          const userAnswer1Raw = document.getElementById("answer1")?.value;
          let userAnswer1, userAnswer2;

          // Savol turiga qarab javoblarni tekshirish
          switch (currentQuestion.type) {
              case "vertex":
              case "xIntercepts":
                  userAnswer1 = parseFractionalNumber(userAnswer1Raw);
                  const userAnswer2Raw = document.getElementById("answer2")?.value;
                  userAnswer2 = parseFractionalNumber(userAnswer2Raw);
                  
                  if (!isFinite(userAnswer1) || !isFinite(userAnswer2)) {
                      alert("Iltimos, ikkala koordinatani ham to'g'ri kiriting (butun son, onlik yoki kasr).");
                      timeUpTimeout = setTimeout(() => {
                          if (gameActive) {
                              timeUpAutoCheck();
                          }
                      }, 60000);
                      return;
                  }
                  break;
                  
              case "axis":
              case "yIntercept":
              case "minMax":
                  userAnswer1 = parseFractionalNumber(userAnswer1Raw);
                  
                  if (!isFinite(userAnswer1)) {
                      alert("Iltimos, javobni to'g'ri kiriting (butun son, onlik yoki kasr).");
                      timeUpTimeout = setTimeout(() => {
                          if (gameActive) {
                              timeUpAutoCheck();
                          }
                      }, 60000);
                      return;
                  }
                  break;
                  
              case "direction":
                  userAnswer1 = userAnswer1Raw.toLowerCase();
                  if (userAnswer1 !== "yuqori" && userAnswer1 !== "pastga") {
                      alert("Iltimos, 'yuqori' yoki 'pastga' kiriting.");
                      timeUpTimeout = setTimeout(() => {
                          if (gameActive) {
                              timeUpAutoCheck();
                          }
                      }, 60000);
                      return;
                  }
                  break;
          }

          stopTimer();
          const endTime = new Date();
          const timeDiff = startTime ? (endTime - startTime) / 1000 : 9999;

          // XP hisoblash
          let xpEarned = 0;
          if (timeDiff <= 60) {
              xpEarned = Math.max(1, 61 - Math.ceil(timeDiff));
          } else {
              xpEarned = 1;
          }

          // Javobni tekshirish
          let correct = false;
          
          switch (currentQuestion.type) {
              case "vertex":
              case "xIntercepts":
                  const matchA = nearlyEqual(userAnswer1, currentQuestion.correctAnswer1) && 
                               nearlyEqual(userAnswer2, currentQuestion.correctAnswer2);
                  const matchB = nearlyEqual(userAnswer1, currentQuestion.correctAnswer2) && 
                               nearlyEqual(userAnswer2, currentQuestion.correctAnswer1);
                  correct = matchA || matchB;
                  break;
                  
              case "axis":
              case "yIntercept":
              case "minMax":
                  correct = nearlyEqual(userAnswer1, currentQuestion.correctAnswer1);
                  break;
                  
              case "direction":
                  correct = userAnswer1 === currentQuestion.correctAnswer1;
                  break;
          }

          const resultDiv = document.getElementById("result");
          if (resultDiv) {
              resultDiv.style.display = "block";
          }

          if (correct) {
              if (resultDiv) {
                  resultDiv.className = "result correct";
                  resultDiv.innerHTML = `<h3>✅ To'g'ri javob!</h3>
                      <p>Siz ${timeDiff.toFixed(1)} soniyada javob berdingiz va ${xpEarned} XP qo'lga kiritdingiz!</p>`;
              }

              correctCount++;
              xpCount += xpEarned;

              const checkBtn = document.getElementById("check-btn");
              if (checkBtn) checkBtn.disabled = true;

              // Keyingi savolga avtomatik o'tish
              autoNextTimeout = setTimeout(newQuestion, 2000);
          } else {
              if (resultDiv) {
                  resultDiv.className = "result incorrect";
                  
                  let correctAnswerText = "";
                  switch (currentQuestion.type) {
                      case "vertex":
                          correctAnswerText = `To'g'ri javob: (${currentQuestion.correctAnswer1}, ${currentQuestion.correctAnswer2})`;
                          break;
                      case "axis":
                          correctAnswerText = `To'g'ri javob: x = ${currentQuestion.correctAnswer1}`;
                          break;
                      case "yIntercept":
                          correctAnswerText = `To'g'ri javob: y = ${currentQuestion.correctAnswer1}`;
                          break;
                      case "xIntercepts":
                          correctAnswerText = `To'g'ri javob: x₁ = ${currentQuestion.correctAnswer1}, x₂ = ${currentQuestion.correctAnswer2}`;
                          break;
                      case "direction":
                          correctAnswerText = `To'g'ri javob: ${currentQuestion.correctAnswer1}`;
                          break;
                      case "minMax":
                          correctAnswerText = `To'g'ri javob: ${currentQuestion.correctAnswer1}`;
                          break;
                  }
                  
                  resultDiv.innerHTML = `<h3>❌ Noto'g'ri javob</h3>
                      <p>${correctAnswerText}</p>`;
              }

              incorrectCount++;
              updateLives();

              if (incorrectCount >= maxIncorrect) {
                  await endGame();
                  return;
              }

              autoNextTimeout = setTimeout(newQuestion, 2000);
          }

          questionCount++;
          updateUIStats();
      }

      // --- UI statistika yangilash ---
      function updateUIStats() {
          const qc = document.getElementById("question-count");
          const cc = document.getElementById("correct-count");
          const xp = document.getElementById("xp-count");
          if (qc) qc.textContent = questionCount;
          if (cc) cc.textContent = correctCount;
          if (xp) xp.textContent = xpCount;
      }

      // --- yordamchi: sahifa tozalanayotganda interval va timeoutlarni tozalash ---
      window.addEventListener('beforeunload', () => {
          clearInterval(timerInterval);
          clearTimeout(autoNextTimeout);
          clearTimeout(timeUpTimeout);
      });
    </script>
</body>
</html>