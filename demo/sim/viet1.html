<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Kvadrat Tenglamalar — Viet Usuli</title>
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #f8f9fa;
            --dark: #2c3e50;
            --gray: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            min-height: 100vh;
            padding: 10px;
            line-height: 1.5;
        }
        
        .container {
            max-width: 500px; 
            margin: 0 auto; 
            background-color: #fff; 
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow); 
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, var(--primary), var(--secondary)); 
            color: #fff; 
            padding: 15px 12px; 
            text-align: center; 
            position: relative;
        }
        
        .user-info { 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.15);
            padding: 6px 12px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            font-size: 0.9rem;
            margin-top: 8px;
        }
        
        .user-name { 
            font-weight: bold; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }        
             
        h1 { 
            font-size: 1.4rem; 
            margin-bottom: 5px; 
            font-weight: 700;
        }
        
        .subtitle { 
            font-size: 0.8rem; 
            opacity: .9; 
        }
        
        .content { 
            padding: 15px; 
            display: flex; 
            flex-direction: column;
            gap: 15px; 
        }
        
        .stats-container { 
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            background: var(--light); 
            padding: 12px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow); 
        }
        
        .stat { 
            text-align: center; 
            padding: 6px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .stat-value { 
            font-size: 1.2rem; 
            font-weight: 700; 
            color: var(--primary); 
            margin-bottom: 2px;
        }
        
        .stat-label { 
            font-size: 0.7rem; 
            color: var(--gray); 
            font-weight: 500;
        }
        
        .progress-container {
            margin: 10px 0;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.75rem;
            color: var(--gray);
        }
        
        .progress-bar { 
            height: 6px; 
            background: #e9ecef; 
            border-radius: 10px; 
            overflow: hidden; 
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .progress { 
            height: 100%; 
            background: linear-gradient(to right, var(--success), var(--primary)); 
            width: 0%; 
            transition: width .5s; 
            border-radius: 10px;
        }
        
        .lives { 
            display: flex; 
            justify-content: center; 
            gap: 8px; 
            margin-bottom: 12px; 
        }
        
        .life { 
            width: 24px; 
            height: 24px; 
            background: var(--danger); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: #fff; 
            font-weight: 700;
            font-size: 0.8rem;
            box-shadow: 0 2px 4px rgba(231, 76, 60, 0.3);
            transition: var(--transition);
        }
        
        .life.lost { 
            background: #bdc3c7; 
            transform: scale(0.9);
            box-shadow: none;
        }
        
        .equation-container { 
            background: linear-gradient(135deg, #f1f9ff, #e3f2fd); 
            border-radius: var(--border-radius); 
            padding: 15px; 
            text-align: center; 
            margin-bottom: 12px; 
            border: 2px dashed var(--primary);
            box-shadow: var(--box-shadow);
        }
        
        .equation { 
            font-size: 1.4rem; 
            font-weight: 700; 
            color: var(--dark); 
            margin: 8px 0; 
            font-family: 'Courier New', monospace;
        }
        
        .difficulty-indicator { 
            text-align: center; 
            margin-top: 6px; 
            font-weight: 700; 
            color: var(--primary-dark);
            font-size: 0.8rem;
        }
        
        .input-container { 
            display: flex; 
            justify-content: space-between; 
            gap: 10px; 
            margin-bottom: 12px; 
        }
        
        .input-group { 
            text-align: center; 
            flex: 1;
            position: relative;
        }
        
        label { 
            display: block; 
            margin-bottom: 6px; 
            font-weight: 600; 
            color: var(--dark); 
            font-size: 0.8rem;
        }
        
        input[type="text"] { 
            width: 100%; 
            padding: 8px 10px; 
            font-size: 1rem; 
            text-align: center; 
            border: 2px solid #e0e0e0; 
            border-radius: var(--border-radius); 
            transition: var(--transition);
            font-weight: 600;
        }
        
        input:focus { 
            border-color: var(--primary); 
            outline: none; 
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2); 
        }
        
        .keyboard-toggle {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            width: 36px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
        }
        
        .keyboard-toggle:hover {
            background: var(--primary-dark);
        }
        
        .math-keyboard {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #ddd;
            padding: 10px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .keyboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 0 5px;
        }
        
        .keyboard-title {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }
        
        .keyboard-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
        }
        
        .keyboard-btn {
            background: #f1f3f4;
            border: 1px solid #dadce0;
            border-radius: 4px;
            padding: 10px 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .keyboard-btn:hover {
            background: #e8eaed;
        }
        
        .keyboard-btn:active {
            background: #dadce0;
        }
        
        .keyboard-btn.primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .keyboard-btn.primary:hover {
            background: var(--primary-dark);
        }
        
        .keyboard-btn.danger {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }
        
        .timer-container { 
            background: #fff3cd; 
            border-radius: var(--border-radius); 
            padding: 10px; 
            text-align: center; 
            margin-bottom: 12px; 
            border: 1px solid #ffeaa7; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-size: 0.85rem;
        }
        
        .timer { 
            font-weight: 700; 
            color: var(--warning); 
        }
        
        .buttons { 
            display: flex; 
            justify-content: center; 
            gap: 10px; 
            margin-bottom: 12px; 
        }
        
        button { 
            padding: 10px 16px; 
            font-size: 0.85rem; 
            font-weight: 600; 
            border: none; 
            border-radius: var(--border-radius); 
            cursor: pointer; 
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.1);
            flex: 1;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
        }
        
        button:active {
            transform: translateY(-1px);
        }
        
        #check-btn { 
            background: var(--success); 
            color: #fff; 
        }
        
        #check-btn:hover { 
            background: #27ae60; 
        }
        
        #check-btn:disabled { 
            background: #bdc3c7; 
            cursor: not-allowed; 
            transform: none;
            box-shadow: none;
        }
        
        .result { 
            padding: 12px; 
            border-radius: var(--border-radius); 
            margin-bottom: 12px; 
            text-align: center; 
            display: none; 
            animation: fadeIn .4s; 
            box-shadow: var(--box-shadow);
            font-size: 0.85rem;
        }
        
        .correct { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        
        .incorrect { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        
        .game-over { 
            text-align: center; 
            padding: 20px; 
            background: #f8d7da; 
            border-radius: var(--border-radius); 
            margin-bottom: 12px; 
            display: none; 
            box-shadow: var(--box-shadow);
        }
        
        .game-over h2 { 
            color: #721c24; 
            margin-bottom: 10px; 
            font-size: 1.3rem;
        }
        
        .game-over p {
            margin-bottom: 6px;
            font-size: 0.9rem;
        }
        
        .restart-btn { 
            background: var(--primary); 
            color: #fff; 
            margin-top: 10px;
        }
        
        .xp-system { 
            background: #e8f4fc; 
            border-radius: var(--border-radius); 
            padding: 12px;
            box-shadow: var(--box-shadow);
        }
        
        .xp-system h3 { 
            color: var(--dark); 
            margin-bottom: 10px; 
            text-align: center; 
            font-size: 1rem;
        }
        
        .xp-rules { 
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }
        
        .xp-rule { 
            text-align: center; 
            padding: 6px; 
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .xp-time { 
            font-weight: 600; 
            color: var(--dark);
            margin-bottom: 2px;
            font-size: 0.75rem;
        }
        
        .xp-points { 
            font-weight: 700; 
            color: var(--success); 
            font-size: 0.85rem;
        }
        
        .explanation {
            background: var(--light);
            border-radius: var(--border-radius);
            padding: 12px;
            box-shadow: var(--box-shadow);
            margin-top: 12px;
        }
        
        .explanation h3 {
            color: var(--dark);
            margin-bottom: 8px;
            text-align: center;
            font-size: 1rem;
        }
        
        .explanation p {
            margin-bottom: 6px;
            color: var(--gray);
            font-size: 0.8rem;
        }
        
        .explanation ul {
            padding-left: 16px;
            margin-bottom: 8px;
        }
        
        .explanation li {
            margin-bottom: 4px;
            color: var(--gray);
            font-size: 0.8rem;
        }
        
        @keyframes fadeIn { 
            from { opacity: 0 } 
            to { opacity: 1 } 
        }
        
        /* Reyting jadvali - faqat kerak bo'lganda ko'rsatiladi */
        .leaderboard-toggle {
            text-align: center;
            margin: 8px 0;
        }
        
        .leaderboard-toggle-btn {
            background: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
            padding: 6px 12px;
            font-size: 0.8rem;
            box-shadow: none;
        }
        
        .leaderboard {
            display: none;
            background: var(--light); 
            border-radius: var(--border-radius); 
            padding: 12px;
            box-shadow: var(--box-shadow);
            margin-top: 10px;
        }
        
        .leaderboard h3 { 
            color: var(--dark); 
            margin-bottom: 10px; 
            text-align: center; 
            font-size: 1rem;
        }
        
        .leaderboard-list { 
            max-height: 150px; 
            overflow-y: auto; 
            border-radius: 8px;
            background: white;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .leaderboard-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 6px 8px; 
            border-bottom: 1px solid #e9ecef; 
            transition: var(--transition);
            font-size: 0.75rem;
        }
        
        .leaderboard-item:hover {
            background: #f8f9fa;
        }
        
        .leaderboard-rank { 
            font-weight: 700; 
            color: var(--primary); 
            min-width: 20px;
        }
        
        .leaderboard-name { 
            flex: 1; 
            margin: 0 6px; 
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .leaderboard-score { 
            font-weight: 700; 
            color: var(--warning); 
        }
        
        .current-user { 
            background: #e3f2fd; 
            border-radius: 4px; 
            font-weight: 600;
        }
        
        /* PC da klaviatura ko'rinmasin */
        @media (min-width: 769px) {
            .keyboard-toggle {
                display: none;
            }
            
            .math-keyboard {
                display: none !important;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 8px;
            }
            
            .content {
                padding: 12px;
            }
            
            header {
                padding: 12px 8px;
            }
            
            h1 {
                font-size: 1.2rem;
            }
            
            .equation {
                font-size: 1.2rem;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
                padding: 10px;
            }
            
            .stat-value {
                font-size: 1.1rem;
            }
            
            .input-container {
                flex-direction: column;
                gap: 8px;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .xp-rules {
                grid-template-columns: 1fr;
            }
            
            .keyboard-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container" role="main">
        <header>
            <h1>Kvadrat Tenglamalar</h1>
            <div class="subtitle">Viet Usuli Simulyatori</div>

            <div class="user-info" id="user-info" style="display:none;">
                <span class="user-name" id="user-name" aria-live="polite"></span>
            </div>
        </header>
        
        <div class="content">
            <div class="progress-container">
                <div class="progress-info">
                    <span>Darajalanish</span>
                    <span id="progress-percent">0%</span>
                </div>
                <div class="progress-bar" aria-hidden="true">
                    <div class="progress" id="progress-bar"></div>
                </div>
            </div>

            <div class="lives" id="lives-container" aria-label="Hayotlar">
                <div class="life" id="life-1">❤</div>
                <div class="life" id="life-2">❤</div>
                <div class="life" id="life-3">❤</div>
            </div>

            <div class="equation-container" aria-live="polite">
                <div class="equation" id="equation">x² + 5x + 6 = 0</div>
                <div class="difficulty-indicator" id="difficulty-indicator">Boshlang'ich daraja</div>
            </div>

            <div class="input-container">
                <div class="input-group">
                    <label for="x1">x₁ (1-ildiz)</label>
                    <input type="text" id="x1" />
                    <button class="keyboard-toggle" data-target="x1">⌨</button>
                </div>
                <div class="input-group">
                    <label for="x2">x₂ (2-ildiz)</label>
                    <input type="text" id="x2" />
                    <button class="keyboard-toggle" data-target="x2">⌨</button>
                </div>
            </div>

            <!-- Matematik Klaviatura (faqat mobil uchun) -->
            <div class="math-keyboard" id="math-keyboard" aria-hidden="true">
                <div class="keyboard-header">
                    <div class="keyboard-title">Matematik Klaviatura</div>
                </div>
                <div class="keyboard-grid">
                    <button class="keyboard-btn" data-value="7">7</button>
                    <button class="keyboard-btn" data-value="8">8</button>
                    <button class="keyboard-btn" data-value="9">9</button>
                    <button class="keyboard-btn" data-value="backspace">⌫</button>
                    
                    <button class="keyboard-btn" data-value="4">4</button>
                    <button class="keyboard-btn" data-value="5">5</button>
                    <button class="keyboard-btn" data-value="6">6</button>
                    <button class="keyboard-btn" data-value="-">-</button>
                    
                    <button class="keyboard-btn" data-value="1">1</button>
                    <button class="keyboard-btn" data-value="2">2</button>
                    <button class="keyboard-btn" data-value="3">3</button>
                    <button class="keyboard-btn" data-value="/">/</button>
                    
                    <button class="keyboard-btn" data-value="0">0</button>
                    <button class="keyboard-btn" data-value=".">.</button>
                    <button class="keyboard-btn primary" data-value="switch">↔</button>
                    <button class="keyboard-btn primary" data-value="clear">C</button>
                </div>
            </div>

            <div class="timer-container">
                <div>Vaqt: <span class="timer" id="timer">0.0</span> soniya</div>
            </div>

            <div class="buttons">
                <button id="check-btn" aria-label="Javobni tekshirish">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                    </svg>
                    Tekshirish
                </button>
            </div>

            <div class="stats-container" aria-hidden="false">
                <div class="stat">
                    <div class="stat-value" id="question-count">0</div>
                    <div class="stat-label">Savol</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="correct-count">0</div>
                    <div class="stat-label">To'g'ri</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="xp-count">0</div>
                    <div class="stat-label">XP</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="difficulty-level">1</div>
                    <div class="stat-label">Daraja</div>
                </div>
            </div>
            <div class="result" id="result" role="status" aria-live="polite"></div>

            <div class="game-over" id="game-over" role="dialog" aria-modal="true">
                <h2>O'yin Tugadi!</h2>
                <p>Yakuniy natijangiz:</p>
                <p><strong>Savollar:</strong> <span id="final-questions">0</span></p>
                <p><strong>To'g'ri javoblar:</strong> <span id="final-correct">0</span></p>
                <p><strong>XP:</strong> <span id="final-xp">0</span></p>
                <button class="restart-btn" id="restart-btn">
                    <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
                        <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
                    </svg>
                    Qayta boshlash
                </button>
            </div>

            <div class="xp-system" aria-hidden="false">
                <h3>XP Tizimi</h3>
                <div class="xp-rules">
                    <div class="xp-rule">
                        <div class="xp-time">1 soniya ichida</div>
                        <div class="xp-points">60 XP</div>
                    </div>
                    <div class="xp-rule">
                        <div class="xp-time">10 soniya ichida</div>
                        <div class="xp-points">51 XP</div>
                    </div>
                    <div class="xp-rule">
                        <div class="xp-time">30 soniya ichida</div>
                        <div class="xp-points">31 XP</div>
                    </div>
                    <div class="xp-rule">
                        <div class="xp-time">60 soniya ichida</div>
                        <div class="xp-points">1 XP</div>
                    </div>
                </div>
            </div>

            <div class="leaderboard-toggle">
                <button class="leaderboard-toggle-btn" id="leaderboard-toggle">
                    Reyting jadvalini ko'rsatish
                </button>
            </div>

            <div class="leaderboard" id="leaderboard">
                <h3>Reyting Jadvali</h3>
                <div class="leaderboard-list" id="leaderboard-list">
                    <div class="leaderboard-item">
                        <div class="leaderboard-rank">1</div>
                        <div class="leaderboard-name">Namuna Foydalanuvchi</div>
                        <div class="leaderboard-score">100</div>
                    </div>
                </div>
            </div>

            <div class="explanation">
                <h3>Viet Usuli</h3>
                <p>x² + bx + c = 0 ko'rinishidagi tenglama uchun:</p>
                <ul>
                    <li>x₁ + x₂ = -b</li>
                    <li>x₁ · x₂ = c</li>
                </ul>
                <p>Bu formulalardan foydalanib, ildizlarni toping.</p>
            </div>
        </div>
    </div>
<!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>

    <!-- Config va AuthUtils skriptlari -->
    <script src="/demo/firebase-config.js"></script>
    <script src="/demo/auth-utils.js"></script>

    <script>
      // --- O'yin holati o'zgaruvchilari ---
      let questionCount = 0;
      let correctCount = 0;
      let xpCount = 0;
      let difficultyLevel = 1;
      let startTime = null;
      let timerInterval = null;
      let currentEquation = {};
      let autoNextTimeout = null;
      let incorrectCount = 0;
      const maxIncorrect = 3;
      let gameActive = true;
      let askedEquations = new Set();
      let currentUser = null;
      let userData = null;
      let activeInput = null;
      let timeUpTimeout = null; // Yangi: 60 soniya chegarasi uchun

      // --- Yordamchi funksiyalar ---
      function isMobileDevice() {
          return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
      }

      function parseFractionalNumber(str) {
          if (typeof str !== 'string') return NaN;
          const s = str.trim();
          if (s === '') return NaN;

          if (s.includes('/')) {
              const parts = s.split('/');
              if (parts.length !== 2) return NaN;
              const a = parseFloat(parts[0]);
              const b = parseFloat(parts[1]);
              if (!isFinite(a) || !isFinite(b) || b === 0) return NaN;
              return a / b;
          } else {
              const v = parseFloat(s);
              if (!isFinite(v)) return NaN;
              return v;
          }
      }

      function nearlyEqual(a, b, eps = 1e-9) {
          return Math.abs(a - b) <= eps;
      }

      // DOMContentLoaded
      document.addEventListener('DOMContentLoaded', () => {
          // Elementlarni olinishi
          const checkBtn = document.getElementById('check-btn');
          const x1Input = document.getElementById('x1');
          const x2Input = document.getElementById('x2');
          const restartBtn = document.getElementById('restart-btn');
          const leaderboardToggle = document.getElementById('leaderboard-toggle');
          const leaderboard = document.getElementById('leaderboard');
          const keyboardToggleBtns = document.querySelectorAll('.keyboard-toggle');
          const keyboardBtns = document.querySelectorAll('.keyboard-btn');
          const mathKeyboard = document.getElementById('math-keyboard');

          const mobile = isMobileDevice();

          // Mobil qurilma sozlamalari
          if (mobile) {
              [x1Input, x2Input].forEach(inp => {
                  if (inp) {
                      inp.setAttribute('readonly', 'true');
                      inp.setAttribute('inputmode', 'none');
                      inp.addEventListener('touchstart', (e) => {
                          activeInput = inp;
                          mathKeyboard.style.display = 'block';
                          inp.focus();
                          e.preventDefault();
                      }, {passive:false});
                  }
              });
          } else {
              [x1Input, x2Input].forEach(inp => {
                  if (inp) {
                      inp.removeAttribute('readonly');
                  }
              });
          }

          // Matematik klaviatura funksiyalari
          keyboardToggleBtns.forEach(btn => {
              btn.addEventListener('click', () => {
                  const targetId = btn.getAttribute('data-target');
                  activeInput = document.getElementById(targetId);
                  mathKeyboard.style.display = 'block';
                  mathKeyboard.setAttribute('aria-hidden', 'false');
                  if (activeInput) activeInput.focus();
              });
          });

          // Klaviatura tugmalari
          keyboardBtns.forEach(btn => {
              btn.addEventListener('click', () => {
                  if (!activeInput) return;
                  
                  const value = btn.getAttribute('data-value');
                  const cur = activeInput.value || '';

                  switch(value) {
                      case 'backspace':
                          activeInput.value = cur.slice(0, -1);
                          break;
                      case 'clear':
                          activeInput.value = '';
                          break;
                      case 'switch':
                          if (activeInput.id === 'x1') {
                              activeInput = document.getElementById('x2');
                          } else {
                              activeInput = document.getElementById('x1');
                          }
                          activeInput.focus();
                          break;
                      case '/':
                          if (!cur.includes('/')) {
                              if (cur === '' || cur === '-') {
                              } else {
                                  activeInput.value = cur + '/';
                              }
                          }
                          break;
                      case '.':
                          const segDot = cur.includes('/') ? cur.split('/').pop() : cur;
                          if (!segDot.includes('.')) activeInput.value = cur + '.';
                          break;
                      case '-':
                          if (cur === '') activeInput.value = '-';
                          else if (cur.endsWith('/')) activeInput.value = cur + '-';
                          break;
                      default:
                          activeInput.value = cur + value;
                  }
                  
                  activeInput.dispatchEvent(new Event('input', { bubbles: true }));
                  activeInput.focus();
              });
          });

          // Desktop fokus
          if (!mobile) {
              [x1Input, x2Input].forEach(input => {
                  input.addEventListener('focus', () => {
                      activeInput = input;
                  });
              });
          }

          // Ekranning boshqa joyiga bosganda klaviatura yopiladi
          document.addEventListener('click', (e) => {
              if (!mathKeyboard.contains(e.target) && 
                  !x1Input.contains(e.target) && 
                  !x2Input.contains(e.target) &&
                  !e.target.classList.contains('keyboard-toggle')) {
                  mathKeyboard.style.display = 'none';
                  mathKeyboard.setAttribute('aria-hidden', 'true');
                  if (activeInput) {
                      try { activeInput.blur(); } catch(e){}
                      activeInput = null;
                  }
              }
          });

          // Reyting jadvalini ko'rsatish/yashirish
          if (leaderboardToggle && leaderboard) {
              leaderboardToggle.addEventListener('click', () => {
                  if (leaderboard.style.display === 'block') {
                      leaderboard.style.display = 'none';
                      leaderboardToggle.textContent = 'Reyting jadvalini ko\'rsatish';
                  } else {
                      leaderboard.style.display = 'block';
                      leaderboardToggle.textContent = 'Reyting jadvalini yashirish';
                  }
              });
          }

          // Tugmalarga event listenerlar qo'shish
          if (checkBtn) {
              checkBtn.addEventListener('click', checkAnswer);
          }

          if (x2Input) {
              x2Input.addEventListener('keypress', (e) => {
                  if (e.key === 'Enter') checkAnswer();
              });
          }

          if (restartBtn) {
              restartBtn.addEventListener('click', restartGame);
          }

          // Avval hayot holatini yangilash
          updateLives();

          // Boshlang'ich o'yin holati
          startGameInitial();
      });

      // O'yinni boshlash
      function startGameInitial() {
          updateUIStats();
          updateLives();
          newQuestion();
      }

      // --- Yangi savol yaratish ---
      function newQuestion() {
          if (!gameActive) return;
          clearTimeout(autoNextTimeout);
          clearTimeout(timeUpTimeout); // Yangi: oldingi vaqt chegarasini tozalash
          updateDifficulty();

          let equationKey;
          let x1, x2, b, c;
          let attempts = 0;
          const maxAttempts = 200;

          do {
              let maxRoot, minRoot;
              switch (difficultyLevel) {
                  case 1: minRoot = -5; maxRoot = 5; break;
                  case 2: minRoot = -8; maxRoot = 8; break;
                  case 3: minRoot = -12; maxRoot = 12; break;
                  case 4: minRoot = -15; maxRoot = 15; break;
                  case 5: minRoot = -20; maxRoot = 20; break;
                  default: minRoot = -5; maxRoot = 5;
              }

              if (difficultyLevel >= 4) {
                  do {
                      x1 = Math.floor(Math.random() * (maxRoot - minRoot + 1)) + minRoot;
                      x2 = Math.floor(Math.random() * (maxRoot - minRoot + 1)) + minRoot;
                  } while (Math.abs(x1 - x2) < (difficultyLevel === 4 ? 3 : 5));
              } else {
                  x1 = Math.floor(Math.random() * (maxRoot - minRoot + 1)) + minRoot;
                  if (Math.random() > 0.7 && difficultyLevel > 1) {
                      x2 = x1;
                  } else {
                      x2 = Math.floor(Math.random() * (maxRoot - minRoot + 1)) + minRoot;
                  }
              }

              b = -(x1 + x2);
              c = x1 * x2;

              equationKey = `${b},${c}`;
              attempts++;
              if (attempts >= maxAttempts) { askedEquations.clear(); break; }
          } while (askedEquations.has(equationKey));

          askedEquations.add(equationKey);
          currentEquation = { x1, x2, b, c };

          // Tuzilgan tenglamani matnga aylantirish
          let equationText = "x²";
          if (b !== 0) equationText += (b > 0 ? ` + ${b}x` : ` - ${Math.abs(b)}x`);
          if (c !== 0) equationText += (c > 0 ? ` + ${c}` : ` - ${Math.abs(c)}`);
          equationText += " = 0";

          const eqEl = document.getElementById("equation");
          if (eqEl) eqEl.textContent = equationText;

          // Inputlarni tozalash
          const x1El = document.getElementById("x1");
          const x2El = document.getElementById("x2");
          if (x1El) x1El.value = "";
          if (x2El) x2El.value = "";

          const resultDiv = document.getElementById("result");
          if (resultDiv) {
              resultDiv.style.display = "none";
              resultDiv.className = "result";
              resultDiv.innerHTML = "";
          }

          const checkBtn = document.getElementById("check-btn");
          if (checkBtn) checkBtn.disabled = false;

          resetTimer();
          startTimer();
          updateProgressBar();
          
          // Yangi: 60 soniya chegarasi
          timeUpTimeout = setTimeout(() => {
              if (gameActive) {
                  timeUpAutoCheck();
              }
          }, 60000); // 60 soniya = 60000 millisekund
          
          if (x1El) x1El.focus();
      }

      // Yangi: Vaqt tugaganda avtomatik tekshirish
      function timeUpAutoCheck() {
          if (!gameActive) return;
          
          stopTimer();
          const resultDiv = document.getElementById("result");
          if (resultDiv) {
              resultDiv.style.display = "block";
              resultDiv.className = "result incorrect";
              resultDiv.innerHTML = `<h3>⏰ Vaqt tugadi!</h3>
                  <p>60 soniya ichida javob berolmadingiz.</p>
                  <p>To'g'ri ildizlar: x₁ = ${currentEquation.x1}, x₂ = ${currentEquation.x2}</p>
                  <p>Viet formulalari: x₁ + x₂ = ${-currentEquation.b}, x₁ · x₂ = ${currentEquation.c}</p>`;
          }

          incorrectCount++;
          updateLives();

          questionCount++;
          updateUIStats();

          if (incorrectCount >= maxIncorrect) {
              endGame();
              return;
          }

          // Keyingi savolga o'tish
          autoNextTimeout = setTimeout(newQuestion, 2000);
      }

      // --- Qiyinlik darajasini yangilash ---
      function updateDifficulty() {
          if (questionCount >= 20) difficultyLevel = 5;
          else if (questionCount >= 15) difficultyLevel = 4;
          else if (questionCount >= 10) difficultyLevel = 3;
          else if (questionCount >= 5) difficultyLevel = 2;
          else difficultyLevel = 1;

          const dlEl = document.getElementById("difficulty-level");
          if (dlEl) dlEl.textContent = difficultyLevel;

          const difficultyText = [
              "Boshlang'ich daraja",
              "O'rta daraja",
              "Qiyin daraja",
              "Juda qiyin daraja",
              "Murakkab daraja"
          ];
          const diEl = document.getElementById("difficulty-indicator");
          if (diEl) diEl.textContent = difficultyText[difficultyLevel - 1];
      }

      // --- Progress bar ---
      function updateProgressBar() {
          const progress = (questionCount % 5) * 20;
          const pb = document.getElementById("progress-bar");
          if (pb) pb.style.width = `${progress}%`;
      }

      // --- Timer funksiyalari ---
      function startTimer() {
          startTime = new Date();
          clearInterval(timerInterval);
          timerInterval = setInterval(updateTimer, 100);
      }
      function updateTimer() {
          if (!startTime) return;
          const currentTime = new Date();
          const timeDiff = (currentTime - startTime) / 1000;
          const timerEl = document.getElementById("timer");
          if (timerEl) timerEl.textContent = timeDiff.toFixed(1);
      }
      function stopTimer() { 
          clearInterval(timerInterval); 
      }
      function resetTimer() {
          stopTimer();
          startTime = null;
          const timerEl = document.getElementById("timer");
          if (timerEl) timerEl.textContent = "0.0";
      }

      // --- Hayotlarni yangilash ---
      function updateLives() {
          for (let i = 1; i <= maxIncorrect; i++) {
              const lifeElement = document.getElementById(`life-${i}`);
              if (!lifeElement) continue;
              if (i <= (maxIncorrect - incorrectCount)) lifeElement.classList.remove('lost');
              else lifeElement.classList.add('lost');
          }
      }

      // --- Reyting jadvalini yuklash ---
      async function loadLeaderboard() {
          // Bu yerda Firebase yoki boshqa tizim bilan ishlash kodlari bo'ladi
          // Hozircha faqat namuna ko'rsatamiz
          const leaderboardList = document.getElementById('leaderboard-list');
          if (!leaderboardList) return;
          
          // Namuna ma'lumotlar
          const sampleData = [
              { name: "Ali Valiyev", score: 150 },
              { name: "Malika Qodirova", score: 120 },
              { name: "Sardor Xolmatov", score: 95 },
              { name: "Dilnoza Abdullayeva", score: 80 },
              { name: "Javohir Tursunov", score: 65 }
          ];
          
          leaderboardList.innerHTML = '';
          sampleData.forEach((item, index) => {
              const leaderboardItem = document.createElement('div');
              leaderboardItem.className = 'leaderboard-item';
              leaderboardItem.innerHTML = `
                  <div class="leaderboard-rank">${index + 1}</div>
                  <div class="leaderboard-name">${item.name}</div>
                  <div class="leaderboard-score">${item.score}</div>
              `;
              leaderboardList.appendChild(leaderboardItem);
          });
      }

      // --- O'yinni tugatish ---
      async function endGame() {
          gameActive = false;
          stopTimer();
          clearTimeout(timeUpTimeout); // Yangi: vaqt chegarasini tozalash
          const checkBtn = document.getElementById("check-btn");
          if (checkBtn) checkBtn.disabled = true;

          // UI ni yangilash
          document.getElementById("final-questions").textContent = questionCount;
          document.getElementById("final-correct").textContent = correctCount;
          document.getElementById("final-xp").textContent = xpCount;

          const gameOverEl = document.getElementById("game-over");
          if (gameOverEl) gameOverEl.style.display = 'block';
          
          // Reyting jadvalini yangilash
          loadLeaderboard();
      }

      // --- Qayta boshlash ---
      function restartGame() {
          questionCount = 0;
          correctCount = 0;
          xpCount = 0;
          incorrectCount = 0;
          gameActive = true;
          askedEquations.clear();

          document.getElementById("question-count").textContent = questionCount;
          document.getElementById("correct-count").textContent = correctCount;
          document.getElementById("xp-count").textContent = xpCount;
          const gameOverEl = document.getElementById("game-over");
          if (gameOverEl) gameOverEl.style.display = 'none';

          updateLives();
          updateUIStats();
          newQuestion();
      }

      // --- Javobni tekshirish ---
      async function checkAnswer() {
          if (!gameActive) return;

          // Yangi: vaqt chegarasini tozalash
          clearTimeout(timeUpTimeout);

          const userX1Raw = document.getElementById("x1")?.value;
          const userX2Raw = document.getElementById("x2")?.value;

          const userX1 = parseFractionalNumber(userX1Raw);
          const userX2 = parseFractionalNumber(userX2Raw);

          if (!isFinite(userX1) || !isFinite(userX2)) {
              alert("Iltimos, ikkala ildizni ham to'g'ri kiriting (butun son, onlik yoki kasr, masalan 3/2).");
              // Yangi: vaqt chegarasini qayta o'rnatish
              timeUpTimeout = setTimeout(() => {
                  if (gameActive) {
                      timeUpAutoCheck();
                  }
              }, 60000);
              return;
          }

          stopTimer();
          const endTime = new Date();
          const timeDiff = startTime ? (endTime - startTime) / 1000 : 9999;

          // YANGI XP HISOBLASH TIZIMI
          // 1 soniya = 60 XP, 2 soniya = 59 XP, ... 60 soniya = 1 XP
          let xpEarned = 0;
          if (timeDiff <= 60) {
              xpEarned = Math.max(1, 61 - Math.ceil(timeDiff)); // Minimal 1 XP
          } else {
              xpEarned = 1; // 60 soniyadan keyin ham minimal 1 XP
          }

          const correct1 = currentEquation.x1;
          const correct2 = currentEquation.x2;

          const matchA = nearlyEqual(userX1, correct1) && nearlyEqual(userX2, correct2);
          const matchB = nearlyEqual(userX1, correct2) && nearlyEqual(userX2, correct1);

          const correct = matchA || matchB;

          const resultDiv = document.getElementById("result");
          if (resultDiv) {
              resultDiv.style.display = "block";
          }

          if (correct) {
              if (resultDiv) {
                  resultDiv.className = "result correct";
                  resultDiv.innerHTML = `<h3>✅ To'g'ri javob!</h3>
                      <p>Siz ${timeDiff.toFixed(1)} soniyada javob berdingiz va ${xpEarned} XP qo'lga kiritdingiz!</p>
                      <p>To'g'ri ildizlar: x₁ = ${currentEquation.x1}, x₂ = ${currentEquation.x2}</p>`;
              }

              correctCount++;
              xpCount += xpEarned;

              const checkBtn = document.getElementById("check-btn");
              if (checkBtn) checkBtn.disabled = true;

              autoNextTimeout = setTimeout(newQuestion, 2000);
          } else {
              if (resultDiv) {
                  resultDiv.className = "result incorrect";
                  resultDiv.innerHTML = `<h3>❌ Noto'g'ri javob</h3>
                      <p>To'g'ri ildizlar: x₁ = ${currentEquation.x1}, x₂ = ${currentEquation.x2}</p>
                      <p>Viet formulalari: x₁ + x₂ = ${-currentEquation.b}, x₁ · x₂ = ${currentEquation.c}</p>`;
              }

              incorrectCount++;
              updateLives();

              if (incorrectCount >= maxIncorrect) {
                  await endGame();
                  return;
              }

              autoNextTimeout = setTimeout(newQuestion, 2000);
          }

          questionCount++;
          updateUIStats();
      }

      // --- UI statistika yangilash ---
      function updateUIStats() {
          const qc = document.getElementById("question-count");
          const cc = document.getElementById("correct-count");
          const xp = document.getElementById("xp-count");
          if (qc) qc.textContent = questionCount;
          if (cc) cc.textContent = correctCount;
          if (xp) xp.textContent = xpCount;
      }

      // Sahifa tozalanayotganda interval va timeoutlarni tozalash
      window.addEventListener('beforeunload', () => {
          clearInterval(timerInterval);
          clearTimeout(autoNextTimeout);
          clearTimeout(timeUpTimeout);
      });
    </script>
</body>
</html>