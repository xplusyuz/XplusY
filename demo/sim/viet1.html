<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Kvadrat Tenglamalar ‚Äî Viet Usuli Simulyatori</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px; margin: 0 auto; background-color: #fff; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,.2); overflow: hidden;
        }
        header {
            background: linear-gradient(to right, #2c3e50, #4a6491); color: #fff; padding: 20px; text-align: center; position: relative;
        }
        .user-info { position: absolute; top: 20px; right: 20px; display: flex; align-items: center; gap: 10px; }
        .user-name { font-weight: bold; }
        #logout-btn { background-color: #e74c3c; color: #fff; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
        #logout-btn:hover { background-color: #c0392b; }
        h1 { font-size: 28px; margin-bottom: 6px; }
        .subtitle { font-size: 14px; opacity: .95; }
        .content { padding: 25px; display:flex; flex-wrap:wrap; gap:20px; }
        .main-content { flex:2; min-width:300px; }
        .sidebar { flex:1; min-width:250px; }
        .stats-container { display:flex; justify-content:space-between; background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:25px; box-shadow:0 3px 10px rgba(0,0,0,.08); }
        .stat { text-align:center; flex:1; }
        .stat-value { font-size:22px; font-weight:700; color:#2c3e50; }
        .stat-label { font-size:13px; color:#7f8c8d; }
        .progress-bar { height:8px; background:#ecf0f1; border-radius:4px; margin:15px 0; overflow:hidden; }
        .progress { height:100%; background:linear-gradient(to right,#2ecc71,#3498db); width:0%; transition:width .5s; }
        .lives { display:flex; justify-content:center; gap:10px; margin-bottom:15px; }
        .life { width:30px; height:30px; background:#e74c3c; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; }
        .life.lost { background:#bdc3c7; }
        .equation-container { background:#f1f9ff; border-radius:10px; padding:20px; text-align:center; margin-bottom:20px; border:2px dashed #3498db; }
        .equation { font-size:28px; font-weight:700; color:#2c3e50; margin:10px 0; }
        .difficulty-indicator { text-align:center; margin-top:8px; font-weight:700; color:#e74c3c; }
        .input-container { display:flex; justify-content:center; gap:20px; margin-bottom:20px; flex-wrap:wrap; }
        .input-group { text-align:center; }
        label { display:block; margin-bottom:8px; font-weight:700; color:#2c3e50; }
        input[type="number"] { width:120px; padding:10px; font-size:18px; text-align:center; border:2px solid #bdc3c7; border-radius:8px; transition:border-color .25s; }
        input:focus { border-color:#3498db; outline:none; box-shadow:0 0 5px rgba(52,152,219,.4); }
        .timer-container { background:#fff3cd; border-radius:8px; padding:12px; text-align:center; margin-bottom:14px; border:1px solid #ffeaa7; }
        .timer { font-size:18px; font-weight:700; color:#e67e22; }
        .buttons { display:flex; justify-content:center; gap:15px; margin-bottom:15px; }
        button { padding:12px 20px; font-size:15px; font-weight:700; border:none; border-radius:8px; cursor:pointer; transition:all .2s; }
        #check-btn { background:#2ecc71; color:#fff; }
        #check-btn:hover { transform:translateY(-2px); background:#27ae60; }
        #check-btn:disabled { background:#95a5a6; cursor:not-allowed; transform:none; }
        .result { padding:18px; border-radius:10px; margin-bottom:12px; text-align:center; display:none; animation:fadeIn .4s; }
        .correct { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
        .incorrect { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
        .xp-system { background:#e8f4fc; border-radius:10px; padding:16px; margin-bottom:20px; }
        .xp-system h3 { color:#2c3e50; margin-bottom:10px; text-align:center; }
        .xp-rules { display:flex; justify-content:space-between; flex-wrap:wrap; gap:8px; }
        .xp-rule { text-align:center; flex:1; min-width:100px; padding:8px; }
        .xp-time { font-weight:700; color:#e67e22; }
        .xp-points { font-weight:700; color:#2ecc71; }
        .leaderboard { background:#f8f9fa; border-radius:8px; padding:12px; margin-bottom:16px; }
        .leaderboard h3 { color:#2c3e50; margin-bottom:10px; text-align:center; }
        .leaderboard-list { max-height:300px; overflow-y:auto; }
        .leaderboard-item { display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #e9ecef; }
        .leaderboard-rank { font-weight:700; color:#2c3e50; }
        .leaderboard-name { flex:1; margin:0 10px; }
        .leaderboard-score { font-weight:700; color:#e67e22; }
        .current-user { background:#e3f2fd; border-radius:6px; }
        .game-over { text-align:center; padding:20px; background:#f8d7da; border-radius:10px; margin-bottom:20px; display:none; }
        .game-over h2 { color:#721c24; margin-bottom:10px; }
        .restart-btn { background:#3498db; color:#fff; }
        .restart-btn:hover { transform:translateY(-2px); background:#2980b9; }
        @keyframes fadeIn { from { opacity:0 } to { opacity:1 } }
        @media(max-width:768px) {
            .content { flex-direction:column; }
            .input-container { flex-direction:column; align-items:center; }
            .buttons { flex-direction:column; }
            .xp-rules { flex-direction:column; }
            .user-info { position:static; justify-content:center; margin-top:10px; }
        }
    </style>
</head>
<body>
    <div class="container" role="main">
        <header>
            <h1>Kvadrat Tenglamalar ‚Äî Viet Usuli Simulyatori</h1>
            <div class="subtitle">Javoblaringizni tekshiring va XP to'plang</div>

            <div class="user-info" id="user-info" style="display:none;">
                <span class="user-name" id="user-name" aria-live="polite"></span>
                <button id="logout-btn" aria-label="Chiqish">Chiqish</button>
            </div>
        </header>

        <div class="content">
            <div class="main-content">
                <div class="stats-container" aria-hidden="false">
                    <div class="stat">
                        <div class="stat-value" id="question-count">0</div>
                        <div class="stat-label">Savol</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="correct-count">0</div>
                        <div class="stat-label">To'g'ri javob</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="xp-count">0</div>
                        <div class="stat-label">XP</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="difficulty-level">1</div>
                        <div class="stat-label">Qiyinlik</div>
                    </div>
                </div>

                <div class="progress-bar" aria-hidden="true">
                    <div class="progress" id="progress-bar"></div>
                </div>

                <div class="lives" id="lives-container" aria-label="Hayotlar">
                    <div class="life" id="life-1">‚ù§</div>
                    <div class="life" id="life-2">‚ù§</div>
                    <div class="life" id="life-3">‚ù§</div>
                </div>

                <div class="equation-container" aria-live="polite">
                    <div class="equation" id="equation">x¬≤ + 5x + 6 = 0</div>
                    <div class="difficulty-indicator" id="difficulty-indicator">Boshlang'ich daraja</div>
                </div>

                <div class="input-container">
                    <div class="input-group">
                        <label for="x1">Birinchi ildiz (x‚ÇÅ)</label>
                        <input type="number" id="x1" inputmode="numeric" />
                    </div>
                    <div class="input-group">
                        <label for="x2">Ikkinchi ildiz (x‚ÇÇ)</label>
                        <input type="number" id="x2" inputmode="numeric" />
                    </div>
                </div>

                <div class="timer-container">
                    <div>Javob berish vaqti: <span class="timer" id="timer">0.0</span> soniya</div>
                </div>

                <div class="buttons">
                    <button id="check-btn" aria-label="Javobni tekshirish">Javobni tekshirish</button>
                </div>

                <div class="result" id="result" role="status" aria-live="polite"></div>

                <div class="game-over" id="game-over" role="dialog" aria-modal="true">
                    <h2>O'yin Tugadi!</h2>
                    <p>Siz 3 ta noto'g'ri javob berdingiz.</p>
                    <p>Yakuniy natijangiz:</p>
                    <p><strong>Savollar:</strong> <span id="final-questions">0</span></p>
                    <p><strong>To'g'ri javoblar:</strong> <span id="final-correct">0</span></p>
                    <p><strong>XP:</strong> <span id="final-xp">0</span></p>
                    <button class="restart-btn" id="restart-btn">Qayta boshlash</button>
                </div>

                <div class="xp-system" aria-hidden="false">
                    <h3>XP Tizimi</h3>
                    <div class="xp-rules">
                        <div class="xp-rule">
                            <div class="xp-time">10 soniya ichida</div>
                            <div class="xp-points">15 XP</div>
                        </div>
                        <div class="xp-rule">
                            <div class="xp-time">20 soniya ichida</div>
                            <div class="xp-points">10 XP</div>
                        </div>
                        <div class="xp-rule">
                            <div class="xp-time">30 soniya ichida</div>
                            <div class="xp-points">5 XP</div>
                        </div>
                        <div class="xp-rule">
                            <div class="xp-time">30 soniyadan ko'p</div>
                            <div class="xp-points">2 XP</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="leaderboard">
                    <h3>Reyting Jadvali</h3>
                    <div class="leaderboard-list" id="leaderboard-list">
                        <div class="leaderboard-item">
                            <div class="leaderboard-rank">1</div>
                            <div class="leaderboard-name">Namuna Foydalanuvchi</div>
                            <div class="leaderboard-score">100</div>
                        </div>
                    </div>
                </div>

                <div class="explanation">
                    <h3>Viet Usuli</h3>
                    <p>x¬≤ + bx + c = 0 ko'rinishidagi tenglama uchun:</p>
                    <ul>
                        <li>x‚ÇÅ + x‚ÇÇ = -b</li>
                        <li>x‚ÇÅ ¬∑ x‚ÇÇ = c</li>
                    </ul>
                    <p>Bu formulalardan foydalanib, ildizlarni toping.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>

    <!-- Config va AuthUtils skriptlari -->
    <script src="firebase-config.js"></script>
    <script src="auth-utils.js"></script>

    <script>
    // --- O'yin holati o'zgaruvchilari ---
    let questionCount = 0;
    let correctCount = 0;
    let xpCount = 0;
    let difficultyLevel = 1;
    let startTime = null;
    let timerInterval = null;
    let currentEquation = {};
    let autoNextTimeout = null;
    let incorrectCount = 0;
    const maxIncorrect = 3;
    let gameActive = true;
    let askedEquations = new Set();
    let currentUser = null;
    let userData = null;

    // DOMContentLoaded ‚Äî sahifa DOM to'liq yuklangandan keyin ishlaydi
    document.addEventListener('DOMContentLoaded', () => {
        // Elementlarni olinishi
        const logoutBtn = document.getElementById('logout-btn');
        const checkBtn = document.getElementById('check-btn');
        const x1Input = document.getElementById('x1');
        const x2Input = document.getElementById('x2');
        const restartBtn = document.getElementById('restart-btn');

        // Tugmalarga event listenerlar qo'shish
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                if (typeof authUtils !== 'undefined' && authUtils.logout) {
                    try {
                        await authUtils.logout();
                    } catch (err) {
                        console.warn('Logout error:', err);
                    }
                }
                window.location.href = 'login.html';
            });
        }

        if (checkBtn) {
            checkBtn.addEventListener('click', checkAnswer);
        }

        if (x2Input) {
            x2Input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkAnswer();
            });
        }

        if (restartBtn) {
            restartBtn.addEventListener('click', restartGame);
        }

        // Avval hayot holatini yangilash
        updateLives();

        // Foydalanuvchi holatini kuzatish
        if (typeof authUtils !== 'undefined' && authUtils.onUserChange) {
            authUtils.onUserChange(async (user) => {
                if (user) {
                    currentUser = user;
                    try {
                        userData = user.data;
                        const userNameEl = document.getElementById('user-name');
                        const userInfoEl = document.getElementById('user-info');
                        if (userNameEl) userNameEl.textContent = `${userData.fullName || 'Foydalanuvchi'}`;
                        if (userInfoEl) userInfoEl.style.display = 'flex';
                        
                        // Reyting jadvalini yuklash
                        loadLeaderboard();
                        
                        // O'yinni boshlash
                        startGameInitial();
                    } catch (err) {
                        console.error("Foydalanuvchi yuklash xatosi:", err);
                    }
                } else {
                    // Foydalanuvchi mavjud emas, login sahifasiga yo'naltirish
                    window.location.href = 'login.html';
                }
            });
        } else {
            console.warn('AuthUtils mavjud emas ‚Äî lokal testing rejimida ishlayapsiz.');
            // Agar AuthUtils bo'lmasa, shunchaki boshlang'ich savol bilan boshlaymiz (local testing)
            startGameInitial();
        }
    });

    // O'yinni boshlash
    function startGameInitial() {
        updateUIStats();
        updateLives();
        newQuestion();
    }

    // --- Yangi savol yaratish ---
    function newQuestion() {
        if (!gameActive) return;
        clearTimeout(autoNextTimeout);
        updateDifficulty();

        let equationKey;
        let x1, x2, b, c;
        let attempts = 0;
        const maxAttempts = 200;

        do {
            let maxRoot, minRoot;
            switch (difficultyLevel) {
                case 1: minRoot = -5; maxRoot = 5; break;
                case 2: minRoot = -8; maxRoot = 8; break;
                case 3: minRoot = -12; maxRoot = 12; break;
                case 4: minRoot = -15; maxRoot = 15; break;
                case 5: minRoot = -20; maxRoot = 20; break;
                default: minRoot = -5; maxRoot = 5;
            }

            // Daraja 4 va 5 uchun ildizlar orasida masofa qo'yish
            if (difficultyLevel >= 4) {
                do {
                    x1 = Math.floor(Math.random() * (maxRoot - minRoot + 1)) + minRoot;
                    x2 = Math.floor(Math.random() * (maxRoot - minRoot + 1)) + minRoot;
                } while (Math.abs(x1 - x2) < (difficultyLevel === 4 ? 3 : 5));
            } else {
                x1 = Math.floor(Math.random() * (maxRoot - minRoot + 1)) + minRoot;
                if (Math.random() > 0.7 && difficultyLevel > 1) {
                    x2 = x1;
                } else {
                    x2 = Math.floor(Math.random() * (maxRoot - minRoot + 1)) + minRoot;
                }
            }

            b = -(x1 + x2);
            c = x1 * x2;

            equationKey = `${b},${c}`;
            attempts++;
            if (attempts >= maxAttempts) { askedEquations.clear(); break; }
        } while (askedEquations.has(equationKey));

        askedEquations.add(equationKey);
        currentEquation = { x1, x2, b, c };

        // Tuzilgan tenglamani matnga aylantirish
        let equationText = "x¬≤";
        if (b !== 0) equationText += (b > 0 ? ` + ${b}x` : ` - ${Math.abs(b)}x`);
        if (c !== 0) equationText += (c > 0 ? ` + ${c}` : ` - ${Math.abs(c)}`);
        equationText += " = 0";

        const eqEl = document.getElementById("equation");
        if (eqEl) eqEl.textContent = equationText;

        // Inputlarni tozalash
        const x1El = document.getElementById("x1");
        const x2El = document.getElementById("x2");
        if (x1El) x1El.value = "";
        if (x2El) x2El.value = "";

        const resultDiv = document.getElementById("result");
        if (resultDiv) {
            resultDiv.style.display = "none";
            resultDiv.className = "result";
            resultDiv.innerHTML = "";
        }

        const checkBtn = document.getElementById("check-btn");
        if (checkBtn) checkBtn.disabled = false;

        resetTimer();
        startTimer();
        updateProgressBar();
        
        // Birinchi inputga fokus qo'yish
        if (x1El) x1El.focus();
    }

    // --- Qiyinlik darajasini yangilash ---
    function updateDifficulty() {
        if (questionCount >= 20) difficultyLevel = 5;
        else if (questionCount >= 15) difficultyLevel = 4;
        else if (questionCount >= 10) difficultyLevel = 3;
        else if (questionCount >= 5) difficultyLevel = 2;
        else difficultyLevel = 1;

        const dlEl = document.getElementById("difficulty-level");
        if (dlEl) dlEl.textContent = difficultyLevel;

        const difficultyText = [
            "Boshlang'ich daraja",
            "O'rta daraja",
            "Qiyin daraja",
            "Juda qiyin daraja",
            "Murakkab daraja"
        ];
        const diEl = document.getElementById("difficulty-indicator");
        if (diEl) diEl.textContent = difficultyText[difficultyLevel - 1];
    }

    // --- Progress bar ---
    function updateProgressBar() {
        const progress = (questionCount % 5) * 20;
        const pb = document.getElementById("progress-bar");
        if (pb) pb.style.width = `${progress}%`;
    }

    // --- Timer funksiyalari ---
    function startTimer() {
        startTime = new Date();
        clearInterval(timerInterval);
        timerInterval = setInterval(updateTimer, 100);
    }
    function updateTimer() {
        if (!startTime) return;
        const currentTime = new Date();
        const timeDiff = (currentTime - startTime) / 1000;
        const timerEl = document.getElementById("timer");
        if (timerEl) timerEl.textContent = timeDiff.toFixed(1);
    }
    function stopTimer() { clearInterval(timerInterval); }
    function resetTimer() {
        stopTimer();
        startTime = null;
        const timerEl = document.getElementById("timer");
        if (timerEl) timerEl.textContent = "0.0";
    }

    // --- Hayotlarni yangilash ---
    function updateLives() {
        for (let i = 1; i <= maxIncorrect; i++) {
            const lifeElement = document.getElementById(`life-${i}`);
            if (!lifeElement) continue;
            if (i <= (maxIncorrect - incorrectCount)) lifeElement.classList.remove('lost');
            else lifeElement.classList.add('lost');
        }
    }

    // --- Reyting jadvalini yuklash ---
    async function loadLeaderboard() {
        if (typeof authUtils === 'undefined' || !authUtils.getLeaderboard) return;
        try {
            const result = await authUtils.getLeaderboard();
            if (result && result.success) {
                const leaderboardList = document.getElementById('leaderboard-list');
                if (!leaderboardList) return;
                leaderboardList.innerHTML = '';
                (result.leaderboard || []).forEach((item, index) => {
                    const leaderboardItem = document.createElement('div');
                    leaderboardItem.className = 'leaderboard-item';
                    if (currentUser && item.id === currentUser.docId) leaderboardItem.classList.add('current-user');
                    leaderboardItem.innerHTML = `
                        <div class="leaderboard-rank">${index + 1}</div>
                        <div class="leaderboard-name">${item.fullName || 'Foydalanuvchi'}</div>
                        <div class="leaderboard-score">${item.bestScore || 0}</div>
                    `;
                    leaderboardList.appendChild(leaderboardItem);
                });
            }
        } catch (err) {
            console.error('Reyting jadvalini yuklashda xatolik:', err);
        }
    }

    // --- O'yinni tugatish ---
    async function endGame() {
        gameActive = false;
        stopTimer();
        const checkBtn = document.getElementById("check-btn");
        if (checkBtn) checkBtn.disabled = true;

        // Natijalarni hisoblash
        const endTime = new Date();
        const totalTime = startTime ? (endTime - startTime) / 1000 : 0;
        
        const finalStats = {
            score: xpCount,
            correctAnswers: correctCount,
            totalQuestions: questionCount,
            difficulty: difficultyLevel,
            xpEarned: xpCount,
            timeSpent: totalTime
        };

        // Firebasega natijalarni saqlash
        if (currentUser && typeof authUtils !== 'undefined') {
            try {
                // O'yin natijasini saqlash
                await authUtils.saveGameResult(finalStats);
                
                // Eng yaxshi natijani yangilash
                const bestScoreResult = await authUtils.updateBestScore(xpCount);
                
                // Yangi rekord bo'lsa bildirish
                if (bestScoreResult && bestScoreResult.isNewRecord) {
                    const gameOverEl = document.getElementById("game-over");
                    if (gameOverEl) {
                        const recordNote = document.createElement('div');
                        recordNote.className = 'result correct';
                        recordNote.style.marginTop = '10px';
                        recordNote.innerHTML = `<h3>üéâ Yangi rekord!</h3><p>Siz o'z rekordingizni yangiladingiz: ${xpCount} XP</p>`;
                        gameOverEl.appendChild(recordNote);
                    }
                }
                
                // Reyting jadvalini yangilash
                loadLeaderboard();
            } catch (error) {
                console.error('Natijalarni saqlashda xatolik:', error);
            }
        }

        // UI ni yangilash
        document.getElementById("final-questions").textContent = questionCount;
        document.getElementById("final-correct").textContent = correctCount;
        document.getElementById("final-xp").textContent = xpCount;

        const gameOverEl = document.getElementById("game-over");
        if (gameOverEl) gameOverEl.style.display = 'block';
    }

    // --- Qayta boshlash ---
    function restartGame() {
        questionCount = 0;
        correctCount = 0;
        xpCount = 0;
        incorrectCount = 0;
        gameActive = true;
        askedEquations.clear();

        document.getElementById("question-count").textContent = questionCount;
        document.getElementById("correct-count").textContent = correctCount;
        document.getElementById("xp-count").textContent = xpCount;
        const gameOverEl = document.getElementById("game-over");
        if (gameOverEl) gameOverEl.style.display = 'none';

        updateLives();
        updateUIStats();
        newQuestion();
    }

    // --- Javobni tekshirish ---
    async function checkAnswer() {
        if (!gameActive) return;

        // Kiritilgan qiymatlarni Number() bilan olish
        const userX1Raw = document.getElementById("x1")?.value;
        const userX2Raw = document.getElementById("x2")?.value;
        const userX1 = (userX1Raw === '' || userX1Raw == null) ? NaN : Number(userX1Raw);
        const userX2 = (userX2Raw === '' || userX2Raw == null) ? NaN : Number(userX2Raw);

        if (isNaN(userX1) || isNaN(userX2)) {
            alert("Iltimos, ikkala ildizni ham kiriting!");
            return;
        }

        stopTimer();
        const endTime = new Date();
        const timeDiff = startTime ? (endTime - startTime) / 1000 : 9999;

        let xpEarned = 2;
        if (timeDiff <= 10) xpEarned = 15;
        else if (timeDiff <= 20) xpEarned = 10;
        else if (timeDiff <= 30) xpEarned = 5;

        const correct = (userX1 === currentEquation.x1 && userX2 === currentEquation.x2)
                     || (userX1 === currentEquation.x2 && userX2 === currentEquation.x1);

        const resultDiv = document.getElementById("result");
        if (resultDiv) {
            resultDiv.style.display = "block";
        }

        if (correct) {
            if (resultDiv) {
                resultDiv.className = "result correct";
                resultDiv.innerHTML = `<h3>‚úÖ To'g'ri javob!</h3>
                    <p>Siz ${timeDiff.toFixed(1)} soniyada javob berdingiz va ${xpEarned} XP qo'lga kiritdingiz!</p>
                    <p>To'g'ri ildizlar: x‚ÇÅ = ${currentEquation.x1}, x‚ÇÇ = ${currentEquation.x2}</p>`;
            }

            correctCount++;
            xpCount += xpEarned;

            const checkBtn = document.getElementById("check-btn");
            if (checkBtn) checkBtn.disabled = true;

            // Keyingi savolga avtomatik o'tish
            autoNextTimeout = setTimeout(newQuestion, 2000);
        } else {
            if (resultDiv) {
                resultDiv.className = "result incorrect";
                resultDiv.innerHTML = `<h3>‚ùå Noto'g'ri javob</h3>
                    <p>To'g'ri ildizlar: x‚ÇÅ = ${currentEquation.x1}, x‚ÇÇ = ${currentEquation.x2}</p>
                    <p>Viet formulalari: x‚ÇÅ + x‚ÇÇ = ${-currentEquation.b}, x‚ÇÅ ¬∑ x‚ÇÇ = ${currentEquation.c}</p>`;
            }

            incorrectCount++;
            updateLives();

            if (incorrectCount >= maxIncorrect) {
                await endGame();
                return;
            }

            autoNextTimeout = setTimeout(newQuestion, 2000);
        }

        questionCount++;
        updateUIStats();
    }

    // --- UI statistika yangilash ---
    function updateUIStats() {
        const qc = document.getElementById("question-count");
        const cc = document.getElementById("correct-count");
        const xp = document.getElementById("xp-count");
        if (qc) qc.textContent = questionCount;
        if (cc) cc.textContent = correctCount;
        if (xp) xp.textContent = xpCount;
    }

    // --- yordamchi: sahifa tozalanayotganda interval va timeoutlarni tozalash ---
    window.addEventListener('beforeunload', () => {
        clearInterval(timerInterval);
        clearTimeout(autoNextTimeout);
    });

    </script>
</body>
</html>