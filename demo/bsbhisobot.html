<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSB Hisobot Tizimi</title>
    <!-- Firebase va UI kutubxonalari -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <!-- XLSX for Excel import -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(90deg, #1a237e, #283593);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .role-selection {
            padding: 40px;
            text-align: center;
        }
        
        .role-buttons {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 30px;
        }
        
        .role-btn {
            padding: 25px 40px;
            font-size: 1.3rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            min-width: 200px;
        }
        
        .teacher-btn {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
        }
        
        .student-btn {
            background: linear-gradient(135deg, #2196F3, #0D47A1);
            color: white;
        }
        
        .role-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .login-form, .dashboard {
            padding: 30px;
            display: none;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        button {
            padding: 12px 25px;
            background: #1a237e;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #283593;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .tab-navigation {
            display: flex;
            border-bottom: 1px solid #ddd;
            background: #f8f9fa;
        }
        
        .tab-btn {
            padding: 15px 30px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            border-bottom: 3px solid #1a237e;
            color: #1a237e;
            background: white;
        }
        
        .tab-content {
            padding: 30px;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }
        
        .card h3 {
            margin-bottom: 20px;
            color: #1a237e;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }
        
        .question-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            background: #f9f9f9;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border-left: 5px solid #1a237e;
        }
        
        .stat-card h4 {
            color: #555;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1a237e;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 30px;
        }
        
        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #dc3545;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .role-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .tab-navigation {
                flex-wrap: wrap;
            }
            
            .tab-btn {
                flex: 1;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>BSB Hisobot Tizimi</h1>
            <p>Ballarni Saqlash va Baholash - O'qituvchi va O'quvchi interfeysi</p>
        </header>
        
        <!-- Role selection screen -->
        <div id="roleSelection" class="role-selection">
            <h2>Kim sifatida kirish?</h2>
            <div class="role-buttons">
                <button class="role-btn teacher-btn" onclick="showTeacherLogin()">O'qituvchi</button>
                <button class="role-btn student-btn" onclick="showStudentLogin()">O'quvchi</button>
            </div>
        </div>
        
        <!-- Teacher Login -->
        <div id="teacherLogin" class="login-form">
            <h2>O'qituvchi Kirish</h2>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="teacherEmail" placeholder="email@example.com">
            </div>
            <div class="form-group">
                <label>Parol</label>
                <input type="password" id="teacherPassword" placeholder="Parolingiz">
            </div>
            <button onclick="teacherLogin()">Kirish</button>
            <button class="btn-secondary" onclick="showRoleSelection()">Orqaga</button>
            <p style="margin-top: 20px;">Akkountingiz yo'qmi? <a href="#" onclick="showTeacherRegister()">Ro'yxatdan o'tish</a></p>
        </div>
        
        <!-- Teacher Register -->
        <div id="teacherRegister" class="login-form">
            <h2>O'qituvchi Ro'yxatdan O'tish</h2>
            <div class="form-group">
                <label>Ism</label>
                <input type="text" id="teacherName" placeholder="Ismingiz">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="teacherRegEmail" placeholder="email@example.com">
            </div>
            <div class="form-group">
                <label>Parol</label>
                <input type="password" id="teacherRegPassword" placeholder="Kamida 6 ta belgi">
            </div>
            <button onclick="teacherRegister()">Ro'yxatdan o'tish</button>
            <button class="btn-secondary" onclick="showTeacherLogin()">Kirish sahifasiga</button>
        </div>
        
        <!-- Student Login -->
        <div id="studentLogin" class="login-form">
            <h2>O'quvchi Kirish</h2>
            <div class="form-group">
                <label>BSB Login (O'qituvchi bergan)</label>
                <input type="text" id="studentBSBLogin" placeholder="BSB logini">
            </div>
            <div class="form-group">
                <label>Parol</label>
                <input type="password" id="studentPassword" placeholder="Parol">
            </div>
            <button onclick="studentLogin()">Kirish</button>
            <button class="btn-secondary" onclick="showRoleSelection()">Orqaga</button>
        </div>
        
        <!-- Teacher Dashboard -->
        <div id="teacherDashboard" class="dashboard">
            <button class="logout-btn" onclick="logout()">Chiqish</button>
            <h2>O'qituvchi Paneli</h2>
            <p id="teacherWelcome"></p>
            
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="switchTab('teacher', 'createBSB')">Yangi BSB Yaratish</button>
                <button class="tab-btn" onclick="switchTab('teacher', 'manageBSB')">BSB larni Boshqarish</button>
                <button class="tab-btn" onclick="switchTab('teacher', 'addStudents')">O'quvchilarni Qo'shish</button>
                <button class="tab-btn" onclick="switchTab('teacher', 'viewResults')">Natijalarni Ko'rish</button>
                <button class="tab-btn" onclick="switchTab('teacher', 'analysis')">Tahlil</button>
            </div>
            
            <div class="tab-content">
                <!-- Create BSB Tab -->
                <div id="createBSB" class="tab-pane active">
                    <div class="card">
                        <h3>Yangi BSB Yaratish</h3>
                        <div class="form-group">
                            <label>BSB Nomi</label>
                            <input type="text" id="bsbName" placeholder="Masalan: 1-chorak matematika testi">
                        </div>
                        <div class="form-group">
                            <label>Savollar Soni</label>
                            <input type="number" id="questionCount" min="1" max="100" value="10">
                        </div>
                        
                        <div id="questionsContainer"></div>
                        
                        <button onclick="generateQuestionInputs()">Savollarni Yaratish</button>
                        <button class="btn-success" onclick="saveBSB()" id="saveBSBBtn" style="display:none;">BSB ni Saqlash</button>
                    </div>
                    
                    <div class="card" id="generatedLogins" style="display:none;">
                        <h3>Yaratilgan BSB Loginlari</h3>
                        <p>Quyidagi login va parollarni o'quvchilarga taqsimlang:</p>
                        <div id="loginDetails"></div>
                        <button onclick="printLogins()">Loginlarni Chop etish</button>
                    </div>
                </div>
                
                <!-- Manage BSB Tab -->
                <div id="manageBSB" class="tab-pane">
                    <div class="card">
                        <h3>Mening BSB larim</h3>
                        <div id="teacherBSBList"></div>
                    </div>
                </div>
                
                <!-- Add Students Tab -->
                <div id="addStudents" class="tab-pane">
                    <div class="card">
                        <h3>O'quvchilarni Excel orqali Yuklash</h3>
                        <div class="form-group">
                            <label>BSB ni tanlang</label>
                            <select id="bsbForStudents">
                                <option value="">Tanlang...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Excel faylni yuklang (.xls, .xlsx)</label>
                            <input type="file" id="studentExcelFile" accept=".xls,.xlsx">
                            <p style="font-size: 0.9rem; color: #666; margin-top: 5px;">Fayl format: Ism, Familiya, Guruh</p>
                        </div>
                        <button onclick="uploadStudentExcel()">O'quvchilarni Yuklash</button>
                        
                        <div id="studentUploadResult" style="margin-top: 20px;"></div>
                    </div>
                    
                    <div class="card">
                        <h3>Qo'shilgan O'quvchilar</h3>
                        <select id="bsbStudentList" onchange="loadStudentsForBSB()">
                            <option value="">BSB ni tanlang...</option>
                        </select>
                        <div id="studentsListContainer"></div>
                    </div>
                </div>
                
                <!-- View Results Tab -->
                <div id="viewResults" class="tab-pane">
                    <div class="card">
                        <h3>BSB Natijalari</h3>
                        <select id="bsbResultsSelect" onchange="loadBSBResults()">
                            <option value="">BSB ni tanlang...</option>
                        </select>
                        <div id="bsbResultsContainer"></div>
                    </div>
                </div>
                
                <!-- Analysis Tab -->
                <div id="analysis" class="tab-pane">
                    <div class="card">
                        <h3>BSB Tahlili</h3>
                        <select id="bsbAnalysisSelect" onchange="generateBSBAnalysis()">
                            <option value="">BSB ni tanlang...</option>
                        </select>
                        <div id="analysisContainer"></div>
                        <button onclick="exportAnalysisToPDF()" id="exportPDFBtn" style="display:none;">PDF ga Eksport qilish</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Student Dashboard -->
        <div id="studentDashboard" class="dashboard">
            <button class="logout-btn" onclick="logout()">Chiqish</button>
            <h2>O'quvchi Paneli</h2>
            <p id="studentWelcome"></p>
            
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="switchTab('student', 'selectBSB')">BSB tanlash</button>
                <button class="tab-btn" onclick="switchTab('student', 'enterScores')">Ballarni kiritish</button>
                <button class="tab-btn" onclick="switchTab('student', 'myResults')">Mening natijalarim</button>
            </div>
            
            <div class="tab-content">
                <!-- Select BSB Tab -->
                <div id="selectBSB" class="tab-pane active">
                    <div class="card">
                        <h3>Mening BSB larim</h3>
                        <div id="studentBSBList"></div>
                    </div>
                </div>
                
                <!-- Enter Scores Tab -->
                <div id="enterScores" class="tab-pane">
                    <div class="card">
                        <h3>Ballarni Kiritish</h3>
                        <select id="studentActiveBSB" onchange="loadBSBQuestions()">
                            <option value="">BSB ni tanlang...</option>
                        </select>
                        <div id="scoreEntryContainer"></div>
                        <button onclick="saveStudentScores()" id="saveScoresBtn" style="display:none;">Ballarni Saqlash</button>
                    </div>
                </div>
                
                <!-- My Results Tab -->
                <div id="myResults" class="tab-pane">
                    <div class="card">
                        <h3>Mening Natijalarim</h3>
                        <select id="studentResultBSB" onchange="showStudentResults()">
                            <option value="">BSB ni tanlang...</option>
                        </select>
                        <div id="studentResultsContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase config faylini ulash -->
    <script src="firebase-config.js"></script>
    
    <script>
        // Global o'zgaruvchilar
        let currentUser = null;
        let currentUserRole = null;
        let currentBSB = null;
        
        // Role selection functions
        function showRoleSelection() {
            hideAllSections();
            document.getElementById('roleSelection').style.display = 'block';
        }
        
        function showTeacherLogin() {
            hideAllSections();
            document.getElementById('teacherLogin').style.display = 'block';
        }
        
        function showTeacherRegister() {
            hideAllSections();
            document.getElementById('teacherRegister').style.display = 'block';
        }
        
        function showStudentLogin() {
            hideAllSections();
            document.getElementById('studentLogin').style.display = 'block';
        }
        
        function hideAllSections() {
            const sections = [
                'roleSelection', 'teacherLogin', 'teacherRegister', 
                'studentLogin', 'teacherDashboard', 'studentDashboard'
            ];
            
            sections.forEach(section => {
                document.getElementById(section).style.display = 'none';
            });
        }
        
        // Firebase authentication functions
        async function teacherLogin() {
            const email = document.getElementById('teacherEmail').value;
            const password = document.getElementById('teacherPassword').value;
            
            if (!email || !password) {
                showAlert('Iltimos, email va parolni kiriting', 'error');
                return;
            }
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                currentUserRole = 'teacher';
                
                // Firestore'dan foydalanuvchi ma'lumotlarini olish
                const userDoc = await db.collection('teachers').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    showTeacherDashboard(userDoc.data().name);
                } else {
                    showTeacherDashboard(email);
                }
                
                // O'qituvchi BSB larini yuklash
                loadTeacherBSBs();
                loadBSBsForSelects();
                
            } catch (error) {
                showAlert('Kirishda xatolik: ' + error.message, 'error');
            }
        }
        
        async function teacherRegister() {
            const name = document.getElementById('teacherName').value;
            const email = document.getElementById('teacherRegEmail').value;
            const password = document.getElementById('teacherRegPassword').value;
            
            if (!name || !email || !password) {
                showAlert('Iltimos, barcha maydonlarni to\'ldiring', 'error');
                return;
            }
            
            if (password.length < 6) {
                showAlert('Parol kamida 6 ta belgidan iborat bo\'lishi kerak', 'error');
                return;
            }
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Firestore'ga o'qituvchi ma'lumotlarini saqlash
                await db.collection('teachers').doc(currentUser.uid).set({
                    name: name,
                    email: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                currentUserRole = 'teacher';
                showTeacherDashboard(name);
                showAlert('Muvaffaqiyatli ro\'yxatdan o\'tdingiz!', 'success');
                
            } catch (error) {
                showAlert('Ro\'yxatdan o\'tishda xatolik: ' + error.message, 'error');
            }
        }
        
        async function studentLogin() {
            const bsbLogin = document.getElementById('studentBSBLogin').value;
            const password = document.getElementById('studentPassword').value;
            
            if (!bsbLogin || !password) {
                showAlert('Iltimos, BSB login va parolni kiriting', 'error');
                return;
            }
            
            try {
                // Firestore'dan BSB loginini tekshirish
                const bsbQuery = await db.collection('bsbs')
                    .where('loginCode', '==', bsbLogin)
                    .where('loginPassword', '==', password)
                    .get();
                
                if (bsbQuery.empty) {
                    showAlert('Noto\'g\'ri login yoki parol', 'error');
                    return;
                }
                
                const bsbDoc = bsbQuery.docs[0];
                currentBSB = bsbDoc.id;
                
                // O'quvchi ma'lumotlarini olish (login orqali)
                const studentQuery = await db.collection('students')
                    .where('bsbId', '==', currentBSB)
                    .where('bsbLogin', '==', bsbLogin)
                    .get();
                
                if (studentQuery.empty) {
                    showAlert('O\'quvchi topilmadi', 'error');
                    return;
                }
                
                const studentDoc = studentQuery.docs[0];
                currentUser = {
                    uid: studentDoc.id,
                    name: studentDoc.data().name,
                    bsbLogin: bsbLogin
                };
                
                currentUserRole = 'student';
                
                showStudentDashboard(studentDoc.data().name);
                loadStudentBSBs();
                
            } catch (error) {
                showAlert('Kirishda xatolik: ' + error.message, 'error');
            }
        }
        
        function showTeacherDashboard(teacherName) {
            hideAllSections();
            document.getElementById('teacherDashboard').style.display = 'block';
            document.getElementById('teacherWelcome').textContent = `Xush kelibsiz, ${teacherName}!`;
        }
        
        function showStudentDashboard(studentName) {
            hideAllSections();
            document.getElementById('studentDashboard').style.display = 'block';
            document.getElementById('studentWelcome').textContent = `Xush kelibsiz, ${studentName}!`;
        }
        
        // Tab navigation
        function switchTab(role, tabId) {
            // Tab tugmalarini yangilash
            const tabButtons = document.querySelectorAll(`#${role}Dashboard .tab-btn`);
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
            
            // Tab kontentlarini yangilash
            const tabPanes = document.querySelectorAll(`#${role}Dashboard .tab-pane`);
            tabPanes.forEach(pane => {
                pane.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
        }
        
        // BSB creation functions
        function generateQuestionInputs() {
            const questionCount = parseInt(document.getElementById('questionCount').value);
            const container = document.getElementById('questionsContainer');
            
            if (!questionCount || questionCount < 1) {
                showAlert('Iltimos, savollar sonini kiriting', 'error');
                return;
            }
            
            container.innerHTML = '<h4>Savollarni sozlang:</h4>';
            
            for (let i = 1; i <= questionCount; i++) {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-item';
                questionDiv.innerHTML = `
                    <h5>Savol ${i}</h5>
                    <div class="form-group">
                        <label>Savol matni (ixtiyoriy)</label>
                        <input type="text" id="questionText${i}" placeholder="Savol matni...">
                    </div>
                    <div class="form-group">
                        <label>Maksimal ball</label>
                        <input type="number" id="maxScore${i}" min="1" max="100" value="10">
                    </div>
                `;
                container.appendChild(questionDiv);
            }
            
            document.getElementById('saveBSBBtn').style.display = 'inline-block';
        }
        
        async function saveBSB() {
            const bsbName = document.getElementById('bsbName').value;
            const questionCount = parseInt(document.getElementById('questionCount').value);
            
            if (!bsbName) {
                showAlert('Iltimos, BSB nomini kiriting', 'error');
                return;
            }
            
            if (!questionCount || questionCount < 1) {
                showAlert('Iltimos, savollar sonini kiriting', 'error');
                return;
            }
            
            // Savollarni yig'ish
            const questions = [];
            let totalMaxScore = 0;
            
            for (let i = 1; i <= questionCount; i++) {
                const questionText = document.getElementById(`questionText${i}`).value || `Savol ${i}`;
                const maxScore = parseInt(document.getElementById(`maxScore${i}`).value) || 10;
                
                questions.push({
                    number: i,
                    text: questionText,
                    maxScore: maxScore
                });
                
                totalMaxScore += maxScore;
            }
            
            // BSB login va parol yaratish
            const loginCode = generateLoginCode();
            const loginPassword = generatePassword();
            
            try {
                // Firestore'ga BSB ni saqlash
                const bsbRef = await db.collection('bsbs').add({
                    name: bsbName,
                    teacherId: currentUser.uid,
                    teacherName: (await db.collection('teachers').doc(currentUser.uid).get()).data().name,
                    questions: questions,
                    totalMaxScore: totalMaxScore,
                    loginCode: loginCode,
                    loginPassword: loginPassword,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    studentCount: 0
                });
                
                showAlert('BSB muvaffaqiyatli yaratildi!', 'success');
                
                // Yaratilgan loginlarni ko'rsatish
                document.getElementById('generatedLogins').style.display = 'block';
                document.getElementById('loginDetails').innerHTML = `
                    <div class="stat-card">
                        <h4>BSB Logini</h4>
                        <div class="value">${loginCode}</div>
                    </div>
                    <div class="stat-card">
                        <h4>BSB Paroli</h4>
                        <div class="value">${loginPassword}</div>
                    </div>
                    <p style="margin-top: 20px;">Ushbu login va parolni o'quvchilarga taqsimlang. Har bir o'quvchi shu orqali tizimga kira oladi.</p>
                `;
                
                // BSB ro'yxatini yangilash
                loadTeacherBSBs();
                loadBSBsForSelects();
                
            } catch (error) {
                showAlert('BSB ni saqlashda xatolik: ' + error.message, 'error');
            }
        }
        
        function generateLoginCode() {
            // 6 ta belgidan iborat login kodi yaratish
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        function generatePassword() {
            // 8 ta belgidan iborat parol yaratish
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        function printLogins() {
            const printContent = document.getElementById('loginDetails').innerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = `
                <h2>BSB Login Ma'lumotlari</h2>
                ${printContent}
                <p style="margin-top: 30px; font-size: 0.9rem; color: #666;">Sana: ${new Date().toLocaleDateString()}</p>
            `;
            
            window.print();
            document.body.innerHTML = originalContent;
            location.reload();
        }
        
        // Load teacher's BSBs
        async function loadTeacherBSBs() {
            try {
                const bsbList = document.getElementById('teacherBSBList');
                bsbList.innerHTML = '<div class="loading">Yuklanmoqda...</div>';
                
                const querySnapshot = await db.collection('bsbs')
                    .where('teacherId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                if (querySnapshot.empty) {
                    bsbList.innerHTML = '<p>Hozircha BSB lar mavjud emas. Yangi BSB yarating.</p>';
                    return;
                }
                
                let html = '<div class="stats-grid">';
                
                querySnapshot.forEach(doc => {
                    const bsb = doc.data();
                    html += `
                        <div class="card">
                            <h4>${bsb.name}</h4>
                            <p><strong>Savollar:</strong> ${bsb.questions.length} ta</p>
                            <p><strong>Jami ball:</strong> ${bsb.totalMaxScore}</p>
                            <p><strong>O'quvchilar:</strong> ${bsb.studentCount || 0} ta</p>
                            <p><strong>Yaratilgan:</strong> ${bsb.createdAt?.toDate().toLocaleDateString() || 'Noma\'lum'}</p>
                            <p><strong>Login kodi:</strong> ${bsb.loginCode}</p>
                            <button onclick="viewBSBDetails('${doc.id}')" class="btn-secondary" style="margin-top: 10px;">Batafsil</button>
                        </div>
                    `;
                });
                
                html += '</div>';
                bsbList.innerHTML = html;
                
            } catch (error) {
                document.getElementById('teacherBSBList').innerHTML = `<p class="alert-error">Xatolik: ${error.message}</p>`;
            }
        }
        
        // Load BSBs for dropdown selects
        async function loadBSBsForSelects() {
            try {
                const querySnapshot = await db.collection('bsbs')
                    .where('teacherId', '==', currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                const selects = [
                    'bsbForStudents', 'bsbStudentList', 'bsbResultsSelect', 
                    'bsbAnalysisSelect', 'studentActiveBSB', 'studentResultBSB'
                ];
                
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        // Hozirgi tanlangan qiymatni saqlab qolish
                        const currentValue = select.value;
                        select.innerHTML = '<option value="">Tanlang...</option>';
                        
                        querySnapshot.forEach(doc => {
                            const bsb = doc.data();
                            const option = document.createElement('option');
                            option.value = doc.id;
                            option.textContent = bsb.name;
                            select.appendChild(option);
                        });
                        
                        // Oldingi tanlovni tiklash
                        if (currentValue) {
                            select.value = currentValue;
                        }
                    }
                });
                
            } catch (error) {
                console.error('BSB larni yuklashda xatolik:', error);
            }
        }
        
        // Upload students from Excel
        async function uploadStudentExcel() {
            const bsbId = document.getElementById('bsbForStudents').value;
            const fileInput = document.getElementById('studentExcelFile');
            
            if (!bsbId) {
                showAlert('Iltimos, BSB ni tanlang', 'error');
                return;
            }
            
            if (!fileInput.files.length) {
                showAlert('Iltimos, Excel faylni tanlang', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length === 0) {
                        showAlert('Excel faylda ma\'lumot topilmadi', 'error');
                        return;
                    }
                    
                    // BSB ma'lumotlarini olish
                    const bsbDoc = await db.collection('bsbs').doc(bsbId).get();
                    const bsbData = bsbDoc.data();
                    
                    let successCount = 0;
                    let errorCount = 0;
                    
                    // Har bir o'quvchini saqlash
                    for (const student of jsonData) {
                        try {
                            const name = student.Ism || student.ism || student.Name || student.name || '';
                            const surname = student.Familiya || student.familiya || student.Surname || student.surname || '';
                            const group = student.Guruh || student.guruh || student.Group || student.group || '';
                            
                            if (!name || !surname) {
                                errorCount++;
                                continue;
                            }
                            
                            const fullName = `${name} ${surname}`.trim();
                            
                            // Har bir o'quvchi uchun login yaratish
                            const studentLogin = `${bsbData.loginCode}_${generateStudentCode()}`;
                            
                            await db.collection('students').add({
                                bsbId: bsbId,
                                bsbName: bsbData.name,
                                name: fullName,
                                group: group,
                                bsbLogin: studentLogin,
                                scores: [],
                                totalScore: 0,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            successCount++;
                            
                        } catch (error) {
                            errorCount++;
                            console.error('O\'quvchini saqlashda xatolik:', error);
                        }
                    }
                    
                    // BSB dagi o'quvchilar sonini yangilash
                    await db.collection('bsbs').doc(bsbId).update({
                        studentCount: (bsbData.studentCount || 0) + successCount
                    });
                    
                    // Natijani ko'rsatish
                    const resultDiv = document.getElementById('studentUploadResult');
                    resultDiv.innerHTML = `
                        <div class="alert-success">
                            <p><strong>Muvaffaqiyatli!</strong></p>
                            <p>${successCount} ta o'quvchi qo'shildi.</p>
                            ${errorCount > 0 ? `<p>${errorCount} ta o'quvchi qo'shilmadi (ma'lumotlar noto'g'ri).</p>` : ''}
                        </div>
                    `;
                    
                    // O'quvchilar ro'yxatini yangilash
                    loadStudentsForBSB();
                    
                } catch (error) {
                    showAlert('Excel faylni o\'qishda xatolik: ' + error.message, 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function generateStudentCode() {
            // 4 ta raqamdan iborat kod
            return Math.floor(1000 + Math.random() * 9000).toString();
        }
        
        // Load students for selected BSB
        async function loadStudentsForBSB() {
            const bsbId = document.getElementById('bsbStudentList').value;
            
            if (!bsbId) {
                document.getElementById('studentsListContainer').innerHTML = '';
                return;
            }
            
            try {
                const container = document.getElementById('studentsListContainer');
                container.innerHTML = '<div class="loading">Yuklanmoqda...</div>';
                
                const querySnapshot = await db.collection('students')
                    .where('bsbId', '==', bsbId)
                    .orderBy('name')
                    .get();
                
                if (querySnapshot.empty) {
                    container.innerHTML = '<p>Bu BSB da hozircha o\'quvchilar yo\'q.</p>';
                    return;
                }
                
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>№</th>
                                <th>Ism Familiya</th>
                                <th>Guruh</th>
                                <th>BSB Logini</th>
                                <th>Umumiy ball</th>
                                <th>Holati</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                let index = 1;
                querySnapshot.forEach(doc => {
                    const student = doc.data();
                    html += `
                        <tr>
                            <td>${index++}</td>
                            <td>${student.name}</td>
                            <td>${student.group || '-'}</td>
                            <td><code>${student.bsbLogin}</code></td>
                            <td>${student.totalScore || 0}</td>
                            <td>${student.scores && student.scores.length > 0 ? 'Ballari kiritilgan' : 'Kutilmoqda'}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (error) {
                document.getElementById('studentsListContainer').innerHTML = `<p class="alert-error">Xatolik: ${error.message}</p>`;
            }
        }
        
        // Load BSB results
        async function loadBSBResults() {
            const bsbId = document.getElementById('bsbResultsSelect').value;
            
            if (!bsbId) {
                document.getElementById('bsbResultsContainer').innerHTML = '';
                return;
            }
            
            try {
                const container = document.getElementById('bsbResultsContainer');
                container.innerHTML = '<div class="loading">Yuklanmoqda...</div>';
                
                // BSB ma'lumotlarini olish
                const bsbDoc = await db.collection('bsbs').doc(bsbId).get();
                const bsbData = bsbDoc.data();
                
                // O'quvchilarni olish
                const studentsSnapshot = await db.collection('students')
                    .where('bsbId', '==', bsbId)
                    .orderBy('totalScore', 'desc')
                    .get();
                
                if (studentsSnapshot.empty) {
                    container.innerHTML = '<p>Bu BSB da hozircha natijalar yo\'q.</p>';
                    return;
                }
                
                let html = `
                    <h4>${bsbData.name} - Natijalar</h4>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>O'quvchilar soni</h4>
                            <div class="value">${studentsSnapshot.size}</div>
                        </div>
                        <div class="stat-card">
                            <h4>Jami ball</h4>
                            <div class="value">${bsbData.totalMaxScore}</div>
                        </div>
                        <div class="stat-card">
                            <h4>O'rtacha ball</h4>
                            <div class="value">${calculateAverageScore(studentsSnapshot)}</div>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 30px;">O'quvchilar reytingi</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Oʻrin</th>
                                <th>Ism Familiya</th>
                                <th>Guruh</th>
                                ${bsbData.questions.map((q, i) => `<th>S${i+1}</th>`).join('')}
                                <th>Jami</th>
                                <th>Foiz</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                let rank = 1;
                studentsSnapshot.forEach(doc => {
                    const student = doc.data();
                    const percentage = bsbData.totalMaxScore > 0 
                        ? Math.round((student.totalScore / bsbData.totalMaxScore) * 100) 
                        : 0;
                    
                    html += `
                        <tr>
                            <td>${rank++}</td>
                            <td>${student.name}</td>
                            <td>${student.group || '-'}</td>
                            ${renderStudentScores(student.scores || [], bsbData.questions.length)}
                            <td><strong>${student.totalScore || 0}</strong></td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
            } catch (error) {
                container.innerHTML = `<p class="alert-error">Xatolik: ${error.message}</p>`;
            }
        }
        
        function calculateAverageScore(studentsSnapshot) {
            let total = 0;
            let count = 0;
            
            studentsSnapshot.forEach(doc => {
                const student = doc.data();
                if (student.totalScore !== undefined) {
                    total += student.totalScore;
                    count++;
                }
            });
            
            return count > 0 ? Math.round(total / count * 10) / 10 : 0;
        }
        
        function renderStudentScores(scores, questionCount) {
            let html = '';
            for (let i = 1; i <= questionCount; i++) {
                const score = scores.find(s => s.questionNumber === i);
                html += `<td>${score ? score.score : 0}</td>`;
            }
            return html;
        }
        
        // Generate BSB analysis
        async function generateBSBAnalysis() {
            const bsbId = document.getElementById('bsbAnalysisSelect').value;
            
            if (!bsbId) {
                document.getElementById('analysisContainer').innerHTML = '';
                document.getElementById('exportPDFBtn').style.display = 'none';
                return;
            }
            
            try {
                const container = document.getElementById('analysisContainer');
                container.innerHTML = '<div class="loading">Tahlil yuklanmoqda...</div>';
                
                // BSB ma'lumotlarini olish
                const bsbDoc = await db.collection('bsbs').doc(bsbId).get();
                const bsbData = bsbDoc.data();
                
                // O'quvchilarni olish
                const studentsSnapshot = await db.collection('students')
                    .where('bsbId', '==', bsbId)
                    .get();
                
                if (studentsSnapshot.empty) {
                    container.innerHTML = '<p>Bu BSB da tahlil qilish uchun ma\'lumot yo\'q.</p>';
                    return;
                }
                
                // Tahlil ma'lumotlarini hisoblash
                const analysis = calculateBSBAnalysis(bsbData, studentsSnapshot);
                
                // Tahlilni ko'rsatish
                let html = `
                    <h4>${bsbData.name} - Batafsil Tahlil</h4>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>O'quvchilar soni</h4>
                            <div class="value">${analysis.studentCount}</div>
                        </div>
                        <div class="stat-card">
                            <h4>O'rtacha ball</h4>
                            <div class="value">${analysis.averageScore}</div>
                        </div>
                        <div class="stat-card">
                            <h4>Eng yuqori ball</h4>
                            <div class="value">${analysis.maxScore}</div>
                        </div>
                        <div class="stat-card">
                            <h4>Eng past ball</h4>
                            <div class="value">${analysis.minScore}</div>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 30px;">Savollar bo'yicha tahlil</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Savol №</th>
                                <th>Maksimal ball</th>
                                <th>O'rtacha ball</th>
                                <th>O'rtacha foiz</th>
                                <th>Eng ko'p ball olganlar</th>
                                <th>Eng kam ball olganlar</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                analysis.questions.forEach((q, index) => {
                    html += `
                        <tr>
                            <td><strong>${index + 1}</strong></td>
                            <td>${q.maxScore}</td>
                            <td>${q.averageScore}</td>
                            <td>${q.averagePercentage}%</td>
                            <td>${q.topStudents.join(', ')}</td>
                            <td>${q.bottomStudents.join(', ')}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                    
                    <h4 style="margin-top: 30px;">Ballar taqsimoti</h4>
                    <div class="chart-container">
                        <canvas id="scoreDistributionChart"></canvas>
                    </div>
                    
                    <h4 style="margin-top: 30px;">Foizlar bo'yicha taqsimot</h4>
                    <div class="chart-container">
                        <canvas id="percentageChart"></canvas>
                    </div>
                `;
                
                container.innerHTML = html;
                document.getElementById('exportPDFBtn').style.display = 'inline-block';
                
                // Chart larni chizish
                renderCharts(analysis);
                
            } catch (error) {
                container.innerHTML = `<p class="alert-error">Tahlil yaratishda xatolik: ${error.message}</p>`;
            }
        }
        
        function calculateBSBAnalysis(bsbData, studentsSnapshot) {
            const analysis = {
                studentCount: studentsSnapshot.size,
                averageScore: 0,
                maxScore: 0,
                minScore: bsbData.totalMaxScore,
                questions: [],
                scoreDistribution: {},
                percentageDistribution: {}
            };
            
            let totalScoreSum = 0;
            const studentScores = [];
            
            // Har bir savol uchun ma'lumotlarni yig'ish
            bsbData.questions.forEach((question, qIndex) => {
                const questionAnalysis = {
                    questionNumber: qIndex + 1,
                    maxScore: question.maxScore,
                    totalScore: 0,
                    averageScore: 0,
                    averagePercentage: 0,
                    topStudents: [],
                    bottomStudents: [],
                    scores: []
                };
                
                analysis.questions.push(questionAnalysis);
            });
            
            // Har bir o'quvchi uchun ma'lumotlarni yig'ish
            studentsSnapshot.forEach(doc => {
                const student = doc.data();
                const studentScore = student.totalScore || 0;
                
                totalScoreSum += studentScore;
                studentScores.push(studentScore);
                
                // Eng yuqori va eng past ballarni aniqlash
                if (studentScore > analysis.maxScore) analysis.maxScore = studentScore;
                if (studentScore < analysis.minScore) analysis.minScore = studentScore;
                
                // Har bir savol uchun ma'lumotlarni yig'ish
                (student.scores || []).forEach(score => {
                    const qIndex = score.questionNumber - 1;
                    if (analysis.questions[qIndex]) {
                        analysis.questions[qIndex].totalScore += score.score;
                        analysis.questions[qIndex].scores.push({
                            student: student.name,
                            score: score.score
                        });
                    }
                });
            });
            
            // O'rtacha ballni hisoblash
            analysis.averageScore = studentsSnapshot.size > 0 
                ? Math.round(totalScoreSum / studentsSnapshot.size * 10) / 10 
                : 0;
            
            // Har bir savol uchun o'rtacha ball va foiz
            analysis.questions.forEach(q => {
                q.averageScore = studentsSnapshot.size > 0 
                    ? Math.round(q.totalScore / studentsSnapshot.size * 10) / 10 
                    : 0;
                q.averagePercentage = q.maxScore > 0 
                    ? Math.round((q.averageScore / q.maxScore) * 100) 
                    : 0;
                
                // Eng yuqori va eng past ball olgan o'quvchilarni aniqlash
                if (q.scores.length > 0) {
                    const sortedScores = [...q.scores].sort((a, b) => b.score - a.score);
                    const maxScore = sortedScores[0].score;
                    const minScore = sortedScores[sortedScores.length - 1].score;
                    
                    q.topStudents = sortedScores
                        .filter(s => s.score === maxScore)
                        .map(s => s.student)
                        .slice(0, 3);
                    
                    q.bottomStudents = sortedScores
                        .filter(s => s.score === minScore)
                        .map(s => s.student)
                        .slice(0, 3);
                }
            });
            
            // Ballar taqsimoti
            const scoreRanges = [
                { min: 0, max: bsbData.totalMaxScore * 0.2, label: '0-20%' },
                { min: bsbData.totalMaxScore * 0.2, max: bsbData.totalMaxScore * 0.4, label: '21-40%' },
                { min: bsbData.totalMaxScore * 0.4, max: bsbData.totalMaxScore * 0.6, label: '41-60%' },
                { min: bsbData.totalMaxScore * 0.6, max: bsbData.totalMaxScore * 0.8, label: '61-80%' },
                { min: bsbData.totalMaxScore * 0.8, max: bsbData.totalMaxScore, label: '81-100%' }
            ];
            
            scoreRanges.forEach(range => {
                const count = studentScores.filter(score => 
                    score >= range.min && score <= range.max
                ).length;
                analysis.scoreDistribution[range.label] = count;
            });
            
            // Foizlar bo'yicha taqsimot
            const percentageRanges = [
                { min: 0, max: 20, label: '0-20%' },
                { min: 21, max: 40, label: '21-40%' },
                { min: 41, max: 60, label: '41-60%' },
                { min: 61, max: 80, label: '61-80%' },
                { min: 81, max: 100, label: '81-100%' }
            ];
            
            percentageRanges.forEach(range => {
                const count = studentScores.filter(score => {
                    const percentage = (score / bsbData.totalMaxScore) * 100;
                    return percentage >= range.min && percentage <= range.max;
                }).length;
                analysis.percentageDistribution[range.label] = count;
            });
            
            return analysis;
        }
        
        function renderCharts(analysis) {
            // Ballar taqsimoti uchun diagramma
            const scoreCtx = document.getElementById('scoreDistributionChart').getContext('2d');
            new Chart(scoreCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(analysis.scoreDistribution),
                    datasets: [{
                        label: 'O\'quvchilar soni',
                        data: Object.values(analysis.scoreDistribution),
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'O\'quvchilar soni'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Ball oralig\'i'
                            }
                        }
                    }
                }
            });
            
            // Foizlar bo'yicha taqsimot uchun diagramma
            const percentageCtx = document.getElementById('percentageChart').getContext('2d');
            new Chart(percentageCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(analysis.percentageDistribution),
                    datasets: [{
                        data: Object.values(analysis.percentageDistribution),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                            'rgba(255, 205, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(54, 162, 235, 0.7)'
                        ],
                        borderColor: [
                            'rgb(255, 99, 132)',
                            'rgb(255, 159, 64)',
                            'rgb(255, 205, 86)',
                            'rgb(75, 192, 192)',
                            'rgb(54, 162, 235)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} ta (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Export analysis to PDF
        function exportAnalysisToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Sarlavha
            doc.setFontSize(20);
            doc.text("BSB Tahlil Hisoboti", 105, 20, { align: 'center' });
            
            // BSB ma'lumotlari
            doc.setFontSize(12);
            const bsbName = document.getElementById('bsbAnalysisSelect').selectedOptions[0].text;
            doc.text(`BSB nomi: ${bsbName}`, 20, 40);
            doc.text(`Sana: ${new Date().toLocaleDateString()}`, 20, 50);
            
            // Asosiy statistikalar
            const stats = document.querySelectorAll('.stat-card .value');
            doc.text(`O'quvchilar soni: ${stats[0].textContent}`, 20, 65);
            doc.text(`O'rtacha ball: ${stats[1].textContent}`, 20, 72);
            doc.text(`Eng yuqori ball: ${stats[2].textContent}`, 20, 79);
            doc.text(`Eng past ball: ${stats[3].textContent}`, 20, 86);
            
            // Savollar tahlili jadvali
            doc.autoTable({
                startY: 100,
                head: [['Savol №', 'Max ball', 'Oʻrtacha ball', 'Oʻrtacha foiz']],
                body: Array.from(document.querySelectorAll('#analysisContainer table tbody tr')).map(row => {
                    const cells = row.querySelectorAll('td');
                    return [
                        cells[0].textContent,
                        cells[1].textContent,
                        cells[2].textContent,
                        cells[3].textContent
                    ];
                }),
                theme: 'striped',
                headStyles: { fillColor: [26, 35, 126] }
            });
            
            // PDF ni yuklab olish
            doc.save(`BSB_Tahlil_${bsbName}_${new Date().toISOString().slice(0,10)}.pdf`);
        }
        
        // Student functions
        async function loadStudentBSBs() {
            try {
                const container = document.getElementById('studentBSBList');
                container.innerHTML = '<div class="loading">Yuklanmoqda...</div>';
                
                // O'quvchining BSB larini olish
                const studentQuery = await db.collection('students')
                    .where('bsbLogin', '==', currentUser.bsbLogin)
                    .get();
                
                if (studentQuery.empty) {
                    container.innerHTML = '<p>Sizga tegishli BSB lar topilmadi.</p>';
                    return;
                }
                
                const studentData = studentQuery.docs[0].data();
                const bsbId = studentData.bsbId;
                
                // BSB ma'lumotlarini olish
                const bsbDoc = await db.collection('bsbs').doc(bsbId).get();
                const bsbData = bsbDoc.data();
                
                let html = `
                    <div class="card">
                        <h4>${bsbData.name}</h4>
                        <p><strong>O'qituvchi:</strong> ${bsbData.teacherName}</p>
                        <p><strong>Savollar soni:</strong> ${bsbData.questions.length} ta</p>
                        <p><strong>Jami ball:</strong> ${bsbData.totalMaxScore}</p>
                        <p><strong>Sizning umumiy ballingiz:</strong> ${studentData.totalScore || 0}</p>
                        <p><strong>Holati:</strong> ${studentData.scores && studentData.scores.length > 0 ? 'Ballari kiritilgan' : 'Ballari kiritilmagan'}</p>
                    </div>
                `;
                
                container.innerHTML = html;
                
                // BSB tanlash ro'yxatini yangilash
                const select = document.getElementById('studentActiveBSB');
                select.innerHTML = '<option value="">Tanlang...</option>';
                const option = document.createElement('option');
                option.value = bsbId;
                option.textContent = bsbData.name;
                select.appendChild(option);
                
                // Natijalar uchun ham
                const resultSelect = document.getElementById('studentResultBSB');
                resultSelect.innerHTML = '<option value="">Tanlang...</option>';
                const option2 = document.createElement('option');
                option2.value = bsbId;
                option2.textContent = bsbData.name;
                resultSelect.appendChild(option2);
                
            } catch (error) {
                container.innerHTML = `<p class="alert-error">Xatolik: ${error.message}</p>`;
            }
        }
        
        async function loadBSBQuestions() {
            const bsbId = document.getElementById('studentActiveBSB').value;
            
            if (!bsbId) {
                document.getElementById('scoreEntryContainer').innerHTML = '';
                document.getElementById('saveScoresBtn').style.display = 'none';
                return;
            }
            
            try {
                const container = document.getElementById('scoreEntryContainer');
                container.innerHTML = '<div class="loading">Yuklanmoqda...</div>';
                
                // BSB ma'lumotlarini olish
                const bsbDoc = await db.collection('bsbs').doc(bsbId).get();
                const bsbData = bsbDoc.data();
                
                // O'quvchining oldin kiritgan ballarini olish
                const studentQuery = await db.collection('students')
                    .where('bsbLogin', '==', currentUser.bsbLogin)
                    .get();
                
                let existingScores = [];
                if (!studentQuery.empty) {
                    const studentData = studentQuery.docs[0].data();
                    existingScores = studentData.scores || [];
                }
                
                let html = `<h4>${bsbData.name} - Ballarni kiritish</h4>`;
                html += `<p>Har bir savol uchun olgan ballaringizni kiriting (0 dan ${bsbData.totalMaxScore} gacha)</p>`;
                
                bsbData.questions.forEach((question, index) => {
                    const existingScore = existingScores.find(s => s.questionNumber === question.number);
                    
                    html += `
                        <div class="question-item">
                            <h5>Savol ${question.number}: ${question.text}</h5>
                            <p><strong>Maksimal ball:</strong> ${question.maxScore}</p>
                            <div class="form-group">
                                <label>Sizning ballingiz</label>
                                <input type="number" id="scoreQ${question.number}" 
                                       min="0" max="${question.maxScore}" 
                                       value="${existingScore ? existingScore.score : 0}"
                                       placeholder="0 dan ${question.maxScore} gacha">
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                document.getElementById('saveScoresBtn').style.display = 'inline-block';
                
            } catch (error) {
                container.innerHTML = `<p class="alert-error">Xatolik: ${error.message}</p>`;
            }
        }
        
        async function saveStudentScores() {
            const bsbId = document.getElementById('studentActiveBSB').value;
            
            if (!bsbId) {
                showAlert('Iltimos, BSB ni tanlang', 'error');
                return;
            }
            
            try {
                // BSB ma'lumotlarini olish
                const bsbDoc = await db.collection('bsbs').doc(bsbId).get();
                const bsbData = bsbDoc.data();
                
                // Ballarni yig'ish
                const scores = [];
                let totalScore = 0;
                
                bsbData.questions.forEach(question => {
                    const scoreInput = document.getElementById(`scoreQ${question.number}`);
                    const scoreValue = parseInt(scoreInput.value) || 0;
                    
                    // Ballarni maksimal balldan oshmasligini tekshirish
                    const validScore = Math.min(Math.max(scoreValue, 0), question.maxScore);
                    
                    scores.push({
                        questionNumber: question.number,
                        score: validScore,
                        maxScore: question.maxScore
                    });
                    
                    totalScore += validScore;
                });
                
                // O'quvchini yangilash
                const studentQuery = await db.collection('students')
                    .where('bsbLogin', '==', currentUser.bsbLogin)
                    .get();
                
                if (!studentQuery.empty) {
                    const studentDoc = studentQuery.docs[0];
                    await db.collection('students').doc(studentDoc.id).update({
                        scores: scores,
                        totalScore: totalScore,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                showAlert('Ballaringiz muvaffaqiyatli saqlandi!', 'success');
                
                // O'quvchi BSB larini yangilash
                loadStudentBSBs();
                
            } catch (error) {
                showAlert('Ballarni saqlashda xatolik: ' + error.message, 'error');
            }
        }
        
        async function showStudentResults() {
            const bsbId = document.getElementById('studentResultBSB').value;
            
            if (!bsbId) {
                document.getElementById('studentResultsContainer').innerHTML = '';
                return;
            }
            
            try {
                const container = document.getElementById('studentResultsContainer');
                container.innerHTML = '<div class="loading">Yuklanmoqda...</div>';
                
                // BSB ma'lumotlarini olish
                const bsbDoc = await db.collection('bsbs').doc(bsbId).get();
                const bsbData = bsbDoc.data();
                
                // O'quvchi ma'lumotlarini olish
                const studentQuery = await db.collection('students')
                    .where('bsbLogin', '==', currentUser.bsbLogin)
                    .get();
                
                if (studentQuery.empty) {
                    container.innerHTML = '<p>Ma\'lumot topilmadi.</p>';
                    return;
                }
                
                const studentData = studentQuery.docs[0].data();
                const percentage = bsbData.totalMaxScore > 0 
                    ? Math.round((studentData.totalScore / bsbData.totalMaxScore) * 100) 
                    : 0;
                
                let html = `
                    <h4>${bsbData.name} - Sizning natijalaringiz</h4>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>Jami ball</h4>
                            <div class="value">${studentData.totalScore || 0}</div>
                        </div>
                        <div class="stat-card">
                            <h4>Maksimal ball</h4>
                            <div class="value">${bsbData.totalMaxScore}</div>
                        </div>
                        <div class="stat-card">
                            <h4>Foiz</h4>
                            <div class="value">${percentage}%</div>
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 30px;">Savollar bo'yicha natijalaringiz</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Savol №</th>
                                <th>Savol matni</th>
                                <th>Maksimal ball</th>
                                <th>Sizning ballingiz</th>
                                <th>Foiz</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                bsbData.questions.forEach(question => {
                    const studentScore = studentData.scores?.find(s => s.questionNumber === question.number);
                    const score = studentScore ? studentScore.score : 0;
                    const questionPercentage = question.maxScore > 0 
                        ? Math.round((score / question.maxScore) * 100) 
                        : 0;
                    
                    html += `
                        <tr>
                            <td>${question.number}</td>
                            <td>${question.text}</td>
                            <td>${question.maxScore}</td>
                            <td>${score}</td>
                            <td>${questionPercentage}%</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 30px;">
                        <h4>Baholash:</h4>
                        <p>
                            ${percentage >= 90 ? 'A\'lo' : 
                              percentage >= 80 ? 'Yaxshi' : 
                              percentage >= 70 ? 'Qoniqarli' : 
                              percentage >= 60 ? 'Qoniqarsiz' : 'Yomon'} 
                            (${percentage}%)
                        </p>
                    </div>
                `;
                
                container.innerHTML = html;
                
            } catch (error) {
                container.innerHTML = `<p class="alert-error">Xatolik: ${error.message}</p>`;
            }
        }
        
        // Utility functions
        function showAlert(message, type) {
            // Alert yaratish
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            // Hozirgi tabga qo'shish
            const activeTab = document.querySelector('.tab-pane.active');
            if (activeTab) {
                activeTab.insertBefore(alertDiv, activeTab.firstChild);
                
                // 5 soniyadan keyin alertni olib tashlash
                setTimeout(() => {
                    alertDiv.remove();
                }, 5000);
            }
        }
        
        async function logout() {
            try {
                if (currentUserRole === 'teacher') {
                    await auth.signOut();
                }
                currentUser = null;
                currentUserRole = null;
                currentBSB = null;
                showRoleSelection();
            } catch (error) {
                console.error('Chiqishda xatolik:', error);
            }
        }
        
        // Firestore'dan ma'lumotlarni real vaqtda yangilash
        function setupRealtimeListeners() {
            if (currentUserRole === 'teacher') {
                // O'qituvchi uchun real vaqtda yangilanishlar
                db.collection('bsbs')
                    .where('teacherId', '==', currentUser.uid)
                    .onSnapshot(() => {
                        loadTeacherBSBs();
                        loadBSBsForSelects();
                    });
            }
        }
        
        // Sayt yuklanganda
        document.addEventListener('DOMContentLoaded', function() {
            showRoleSelection();
            
            // Firebase auth holatini kuzatish
           auth.onAuthStateChanged(user => {
  if (!user) {
    // Hech kim kirmagan
    console.log('Foydalanuvchi tizimda emas');
    return;
  }

  // Agar siz hali ham tashqi currentUserRole ga ishonayotgan bo'lsangiz,
  // uni aniqligini tekshiring. Aks holda rolni Firestore'dan oling:
  // Misol: db.collection('teachers').doc(user.uid).get() -> agar mavjud bo'lsa teacher.
  db.collection('teachers').doc(user.uid).get()
    .then(doc => {
      if (doc.exists) {
        // Bu foydalanuvchi o'qituvchi ekanligi aniqlandi
        const name = doc.data().name || 'O\'qituvchi';
        showTeacherDashboard(name);
        loadTeacherBSBs();
        loadBSBsForSelects();
        setupRealtimeListeners();
      } else {
        // teacher hujjati topilmadi — ehtimol o'quvchi yoki rol boshqacha
        console.log('Bu foydalanuvchi teachers to‘plamida yo‘q. currentUserRole:', currentUserRole);
        // agar siz currentUserRole orqali tekshirmoqchi bo'lsangiz:
        if (currentUserRole === 'teacher') {
          console.warn('currentUserRole=teacher, ammo teachers doc topilmadi.');
        } else {
          // boshqa rol uchun ish tarmoqlari
          showStudentView?.();
        }    
                        });
                }
            });
        });
    </script>
</body>
</html>