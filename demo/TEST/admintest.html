<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Rasm-Only Test — Admin (Auto Firebase + Google Sign-in)</title>

  <!-- MathJax -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$','$'],['\\(','\\)']], displayMath: [['$$','$$'],['\\[','\\]']], processEscapes: true, packages:{'[+]':['noerrors']} },
      options: { renderActions: { addMenu: [] } }, loader: { load: ['[tex]/noerrors'] }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <style>
    :root{--g:#2E8B57;--gd:#1F6B45;--bd:#e9f2ec;--muted:#64748b;--ring:rgba(46,139,87,.18)}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#f6faf8;color:#0f172a}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    h1{display:flex;align-items:center;gap:10px;margin:0 0 16px}
    .pi{width:34px;height:34px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,var(--g),var(--gd));color:#fff;font-weight:800}
    .grid{display:grid;gap:12px}
    .card{background:#fff;border:1px solid var(--bd);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(31,107,69,.06)}
    .row{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr))}
    label{font-size:12px;color:#475569}
    input[type="text"],input[type="number"],textarea,select{width:100%;padding:10px 12px;border:1px solid #dfeae3;border-radius:10px;background:#fbfdfc}
    textarea{min-height:92px;resize:vertical}
    .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:700;color:#fff;background:linear-gradient(135deg,var(--g),var(--gd));cursor:pointer}
    .btn.ghost{background:#fff;color:#1F6B45;border:1px solid #cfe4d7}
    .btn.danger{background:linear-gradient(135deg,#d32f2f,#b71c1c)}
    .btn.flat{background:#f8fbf9;color:#1F6B45;border:1px solid #cfe4d7}
    .muted{color:#64748b;font-size:13px}
    .flex{display:flex;gap:10px;flex-wrap:wrap}
    .badge{display:inline-flex;align-items:center;gap:6px;background:#f1f8f4;border:1px solid #dfeae3;border-radius:999px;padding:6px 10px;font-size:12px}
    .mini{font-size:12px;color:#64748b}
    .preview{border:1px dashed #dfeae3;border-radius:12px;padding:12px;background:#fbfdfc}
    .warn{color:#b45309}
    .success{color:#2E8B57}
    .drawer{position:fixed;left:0;right:0;bottom:0;transform:translateY(100%);transition:transform .25s ease;background:#fffffff2;backdrop-filter:saturate(1.2) blur(6px);border-top:1px solid #dfeae3;box-shadow:0 -10px 24px rgba(31,107,69,.12);padding:12px 14px;z-index:9999}
    .drawer.open{transform:translateY(0%)}
    .kgrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(72px,1fr));gap:8px}
    .kbtn{appearance:none;cursor:pointer;padding:8px 10px;border:1px solid #dfeae3;background:#fff;border-radius:10px;display:flex;align-items:center;justify-content:center;min-height:44px;transition:box-shadow .15s,border-color .15s,background .15s}
    .kbtn:hover{border-color:#b9dfc8;box-shadow:0 0 0 4px var(--ring);background:#fff}
    .hidden{display:none}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
    .userchip{display:flex;gap:10px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1><span class="pi">π</span> Test Admin — Auto Firebase & Google Sign-in</h1>
      <div class="userchip">
        <div id="firebaseStatus" class="muted">Ulanish: kutilyapti...</div>
        <div id="userInfo" class="muted" style="min-width:160px;text-align:right"></div>
      </div>
    </div>

    <!-- Main admin controls (no firebase settings) -->
    <div id="adminArea" class="hidden">
      <div class="card grid">
        <div class="row">
          <div><label>Sarlavha</label><input id="title" type="text" placeholder="Algebra — Test"></div>
          <div><label>Ta'rif</label><input id="desc" type="text" placeholder="Test haqida qisqacha"></div>
          <div><label>Test ID (slug)</label><input id="tid" type="text" placeholder="bsb-alg-geo-20"></div>
          <div><label>Test kodi (Firestore uchun)</label><input id="tcode" type="text" placeholder="bsb-a1-2025-10"></div>
          <div><label>Vaqt (daqiqada)</label><input id="dur" type="number" min="0" value="30"></div>
          <div><label>Nechta savol</label><input id="qcount" type="number" min="1" value="20"></div>
        </div>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Global default</label>
            <div style="display:flex;gap:8px;margin-top:6px">
              <button class="mode-tab btn flat active" data-mode="variant">Variantli (global)</button>
              <button class="mode-tab btn flat" data-mode="yopiq">Yopiq (global)</button>
            </div>
          </div>
          <div>
            <label>Test holati</label>
            <select id="testStatus"><option value="draft">Qoralama</option><option value="active">Faol</option><option value="archived">Arxiv</option></select>
          </div>
          <div></div>
          <div></div>
        </div>

        <div style="margin-top:12px" class="flex">
          <button id="buildBtn" class="btn">Savol shakllarini yarat</button>
          <button id="exportBtn" class="btn ghost">Export JSON</button>
          <button id="previewBtn" class="btn ghost">Preview (test.html)</button>
          <button id="saveToFirebaseBtn" class="btn">Firebase'ga saqlash</button>
        </div>
      </div>

      <div id="questionsArea" class="grid" style="margin-top:12px"></div>

      <div class="card" style="margin-top:12px">
        <div class="muted">Eslatma: admin sifatida saqlash <code>test</code> kolleksiyasiga doc id = Test kodi bilan yozadi.</div>
        <div id="saveStatus" style="margin-top:8px"></div>
      </div>
    </div>

    <div id="notAdmin" class="card hidden">
      <div class="warn">Siz admin emassiz yoki ruxsat mavjud emas. Agar siz admin bo‘lishingiz kerak bo‘lsa, <code>sohibjonmath@gmail.com</code> emailiga ega ekanligingizni tekshiring.</div>
    </div>
  </div>

  <!-- Drawer keypad -->
  <div id="keypadDrawer" class="drawer" aria-hidden="true">
    <div class="rowbar">
      <div class="title">Math klaviatura</div>
    </div>
    <div id="keypadGrid" class="kgrid"></div>
  </div>

<script>
/* ---------- Config: automatic, no settings ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  authDomain: "xplusy-760fa.firebaseapp.com",
  projectId: "xplusy-760fa",
  storageBucket: "xplusy-760fa.firebasestorage.app",
  messagingSenderId: "992512966017",
  appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
  measurementId: "G-459PLJ7P7L"
};
const ADMIN_EMAIL = "sohibjonmath@gmail.com";

/* ---------- Utilities ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const typeset = async (el)=>{ if(window.MathJax?.typesetPromise){ try{ await MathJax.typesetPromise([el]); }catch(_){} } };
function escapeHtml(t){ return t.split('&').join('&amp;').split('<').join('&lt;').split('>').join('&gt;'); }
function looksLikeTeX(s){ if (!s) return false; const needles = ['\\frac','\\sqrt','\\sum','\\int','\\log','\\ln','\\sin','\\cos','\\tan','\\vec','\\pi','\\le','\\ge','\\ne','\\pm','\\cdot','\\times','\\left','\\right']; for(const k of needles){ if(s.indexOf(k) !== -1) return true; } for(const ch of ['^','_','{','}','\\']){ if(s.indexOf(ch) !== -1) return true; } return false; }
function hasDollarPair(s){ const i = s.indexOf('$'); if(i === -1) return false; return s.indexOf('$', i+1) !== -1; }
function renderLineForMath(s){ const safe = escapeHtml(s); if (hasDollarPair(s)) return safe; if (looksLikeTeX(s)) return '\\(' + safe + '\\)'; return safe; }
function insertAtCursor(textarea, template){ textarea.focus(); const start = textarea.selectionStart ?? textarea.value.length; const end = textarea.selectionEnd ?? textarea.value.length; const before = textarea.value.slice(0,start); const after = textarea.value.slice(end); let out = before + template + after; const markerPos = (before + template).indexOf('▮'); if(markerPos >= 0){ out = out.replace('▮',''); } textarea.value = out; const pos = markerPos >= 0 ? markerPos : (start + template.length); textarea.setSelectionRange(pos, pos); textarea.dispatchEvent(new Event('input', { bubbles:true })); }
function setDrawer(open){ const d = $('#keypadDrawer'); d.classList.toggle('open', open); d.setAttribute('aria-hidden', open ? 'false' : 'true'); }

/* ---------- Firebase init & auth ---------- */
let firebaseApp = null;
let db = null;
let IS_ADMIN = false;

function initializeFirebase(){
  if(firebaseApp) return;
  firebaseApp = firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();
  console.log("Firebase initialized (auto)");
  $('#firebaseStatus').textContent = "Firebase ulandi (auth kutilyapti...)";
}

/* Auto Google sign-in (popup -> redirect) */
async function tryAutoSignIn(){
  const auth = firebase.auth();
  if(auth.currentUser){
    return handleSignedInUser(auth.currentUser);
  }
  const provider = new firebase.auth.GoogleAuthProvider();
  try{
    const res = await auth.signInWithPopup(provider);
    return handleSignedInUser(res.user);
  }catch(err){
    console.warn("Popup failed, redirecting...", err);
    try{
      await auth.signInWithRedirect(provider);
    }catch(err2){
      console.error("Redirect failed:", err2);
      $('#firebaseStatus').textContent = "Auth xatolik: " + (err2?.message || err.message);
      alert("Google sign-in muvaffaqiyatsiz: " + (err2?.message || err.message));
    }
  }
}

async function handleSignedInUser(user){
  if(!user) return false;
  initializeFirebase();
  $('#userInfo').textContent = user.email || user.uid;
  // get claims (optional)
  const token = await user.getIdTokenResult(true).catch(()=>null);
  const claims = token?.claims || {};
  IS_ADMIN = (claims.admin === true) || (String(user.email || '').toLowerCase() === ADMIN_EMAIL.toLowerCase());
  if(IS_ADMIN){
    $('#firebaseStatus').textContent = `Admin: ${user.email}`;
    $('#adminArea').classList.remove('hidden');
    $('#notAdmin').classList?.add('hidden');
    console.log("Admin access granted:", user.email);
    return true;
  } else {
    // auto sign out and show message
    try{ await firebase.auth().signOut(); }catch(_){}
    $('#firebaseStatus').textContent = "Ruxsat yo'q";
    $('#userInfo').textContent = '';
    $('#adminArea').classList.add('hidden');
    $('#notAdmin').classList?.remove('hidden');
    alert("Siz admin emassiz. Admin email: " + ADMIN_EMAIL);
    return false;
  }
}

firebase.auth().onAuthStateChanged(async (user)=>{
  if(user){
    await handleSignedInUser(user);
  }else{
    initializeFirebase();
    await tryAutoSignIn().catch(e=>console.warn(e));
  }
});

/* ---------- Keypad ---------- */
const KEYS = [
  { show:'x^n', insert:'^{▮}' },
  { show:'x_n', insert:'_{▮}' },
  { show:'\\sqrt{}', insert:'\\sqrt{▮}' },
  { show:'\\frac{a}{b}', insert:'\\frac{▮}{ }' },
  { show:'\\pi', insert:'\\pi' },
  { show:'\\cdot', insert:'\\cdot' },
  { show:'\\times', insert:'\\times' },
  { show:'\\le', insert:'\\le' },
  { show:'\\ge', insert:'\\ge' },
  { show:'\\sum_{i=1}^{n}', insert:'\\sum_{i=1}^{▮}' },
  { show:'\\int', insert:'\\int_{▮}^{ }' },
  { show:'\\left(\\right)', insert:'\\left(▮\\right)' },
];
function buildKeypad(){ const grid = document.getElementById('keypadGrid'); grid.innerHTML=''; KEYS.forEach(k=>{ const btn=document.createElement('button'); btn.type='button'; btn.className='kbtn'; btn.innerHTML=`$${k.show}$`; btn.addEventListener('mousedown', e=>e.preventDefault()); btn.addEventListener('click', ()=>{ const target = ACTIVE_TEXTAREA || LAST_ACTIVE_TEXTAREA; if(target){ insertAtCursor(target, k.insert); target.focus(); } }); grid.appendChild(btn); }); typeset(grid); }
buildKeypad();

/* ---------- Question UI ---------- */
function qTemplate(i, defaultType){
  const t = defaultType || 'variant';
  return `
  <div class="card qbox" data-index="${i}">
    <div class="flex" style="justify-content:space-between;align-items:center">
      <div class="badge">#${i} — rasm: <code>${i}.jpg</code></div>
      <div class="flex">
        <select class="qtype"><option value="variant"${t==='variant'?' selected':''}>Variantli</option><option value="open"${t!=='variant'?' selected':''}>Yopiq</option></select>
        <button class="btn flat" data-minitoggle type="button">Yig'ish</button>
        <button class="btn danger" data-remove type="button">O'chirish</button>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <div><label>Ball</label><input type="number" class="points" min="1" value="1"></div>
      <div><label>Variantlar</label><textarea class="options" placeholder="A varianti\nB varianti\nC varianti"></textarea></div>
      <div><label>To'g'ri javob</label><input class="correct-answer" type="text" placeholder="variant index (0) yoki $x=5$"></div>
    </div>
  </div>`; 
}

function getQuestionTypeFromQbox(qbox){ const sel=qbox.querySelector('.qtype'); return sel?sel.value:'variant'; }
function rebuildAnswerPickers(qbox){
  const type = getQuestionTypeFromQbox(qbox);
  // not showing answer radio here, preview handles it
}
function attachQEvents(qbox){
  qbox.querySelector('[data-remove]').addEventListener('click', ()=>qbox.remove());
  qbox.querySelector('[data-minitoggle]').addEventListener('click',(e)=>{ const c=qbox.classList.toggle('collapsed'); e.target.textContent = c? 'Yoyish':'Yig\'ish'; });
  const ta=qbox.querySelector('.options'); ta.addEventListener('focus', ()=>{ ACTIVE_TEXTAREA = ta; LAST_ACTIVE_TEXTAREA = ta; setDrawer(true); });
  ta.addEventListener('blur', ()=>{ setTimeout(()=>{ const ae=document.activeElement; if(!document.getElementById('keypadDrawer').contains(ae)) setDrawer(false); },0); });
  ta.addEventListener('input', ()=>rebuildAnswerPickers(qbox));
}

function buildForms(defaultType){
  const n = Math.max(1, Number(document.getElementById('qcount').value || 1));
  const area = document.getElementById('questionsArea'); area.innerHTML = '';
  for(let i=1;i<=n;i++){
    const div = document.createElement('div');
    div.innerHTML = qTemplate(i, defaultType);
    const el = div.firstElementChild;
    area.appendChild(el);
    attachQEvents(el);
  }
}

/* ---------- Collect & Save ---------- */
function collectJson(){
  const title = document.getElementById('title').value || 'Test';
  const description = document.getElementById('desc').value || '';
  const code = (document.getElementById('tcode').value || '').trim();
  const durationMinutes = Number(document.getElementById('dur').value || 0);
  const status = document.getElementById('testStatus').value || 'draft';
  const questions = [];
  document.querySelectorAll('#questionsArea .qbox').forEach(qbox=>{
    const points = Number(qbox.querySelector('.points').value || 1);
    const type = getQuestionTypeFromQbox(qbox);
    const opts = (qbox.querySelector('.options').value || '').split('\n').map(s=>s.trim()).filter(Boolean);
    const correctRaw = (qbox.querySelector('.correct-answer').value || '').trim();
    if(type === 'variant'){
      const correctIndex = correctRaw === '' ? 0 : Number(correctRaw);
      questions.push({ points, type:'variant', options: opts, correctIndex });
    } else {
      questions.push({ points, type:'open', correctAnswer: correctRaw });
    }
  });
  return { title, description, durationMinutes, questions, code, status, version:'2.2' };
}

async function saveTestToFirebase(){
  if(!db) { alert("Firebase ulanmagan yoki auth yetarli emas."); return; }
  if(!IS_ADMIN){ alert("Siz admin emassiz."); return; }
  const data = collectJson();
  const code = data.code || document.getElementById('tcode').value;
  if(!code){ alert("Iltimos, test kodi kiriting."); return; }
  try{
    const ref = db.collection('test').doc(code);
    await ref.set({
      ...data,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    $('#saveStatus').textContent = "✅ Saqlandi: " + code;
    $('#saveStatus').className = "success";
    setTimeout(()=>{ $('#saveStatus').textContent = ''; }, 4000);
  }catch(e){
    console.error(e);
    alert("Saqlash xatosi: " + (e?.message || e));
  }
}

/* ---------- Events & Init ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  // wire UI buttons
  $$('#adminArea .mode-tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('#adminArea .mode-tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
    });
  });
  $('#buildBtn').addEventListener('click', ()=>{ const def = $('#adminArea .mode-tab.active')?.dataset.mode || 'variant'; buildForms(def); });
  $('#exportBtn').addEventListener('click', ()=>{ const data=collectJson(); const b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='test.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1000); });
  $('#previewBtn').addEventListener('click', ()=>{ const data=collectJson(); localStorage.setItem('testData', JSON.stringify(data)); window.open('test.html','_blank'); });
  $('#saveToFirebaseBtn').addEventListener('click', saveTestToFirebase);

  // initial form
  buildForms($('.mode-tab.active')?.dataset.mode || 'variant');
});

/* ---------- Small helpers for keyboard focus ---------- */
let ACTIVE_TEXTAREA = null, LAST_ACTIVE_TEXTAREA = null;
document.addEventListener('focusin', e=>{ if(e.target && (e.target.tagName==='TEXTAREA' || e.target.tagName==='INPUT')){ ACTIVE_TEXTAREA = e.target; LAST_ACTIVE_TEXTAREA = e.target; } });

</script>
</body>
</html>
