<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Test Admin — Auto Firebase + Google Sign-in</title>

  <!-- MathJax -->
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$','$'],['\\(','\\)']] },
      options: { renderActions: { addMenu: [] } }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <style>
    body { font-family: Inter, sans-serif; margin:0; background:#f6faf8; }
    .wrap { max-width:1100px; margin:20px auto; padding:16px; }
    h1 { display:flex; gap:10px; align-items:center; }
    input, textarea, select { width:100%; padding:10px; border:1px solid #ddeee3; border-radius:10px; margin-top:4px; }
    textarea { min-height:90px; }
    .btn { padding:10px 16px; border-radius:10px; border:none; cursor:pointer; font-weight:bold; }
    .green { background:#2E8B57; color:white; }
    .gray  { background:white; border:1px solid #ccd; }
    .card { background:white; padding:16px; border-radius:12px; margin-top:16px; box-shadow:0 4px 20px rgba(0,0,0,.05); }
    .row { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; }
    .qbox { border:1px dashed #cde; padding:12px; margin-top:14px; border-radius:10px; }
    .badge { padding:4px 10px; background:#eef8f2; border-radius:6px; display:inline-block; margin-bottom:8px; }
    #notAdmin { color:#b91c1c; font-weight:bold; }
  </style>
</head>
<body>
<div class="wrap">

  <h1>Test Admin — Auto Firebase + Google Sign-in</h1>
  <div id="status" style="margin-bottom:12px;color:#666">Ulanish: kutilyapti…</div>

  <!-- ADMIN UI -->
  <div id="adminUI" style="display:none">

    <!-- Test meta -->
    <div class="card">
      <div class="row">
        <div><label>Sarlavha</label><input id="title" type="text"></div>
        <div><label>Ta'rif</label><input id="desc" type="text"></div>
        <div><label>Test kodi</label><input id="tcode" type="text" placeholder="bsb-a1-2025-10"></div>
        <div><label>Daqiqalar</label><input id="dur" type="number" value="30"></div>
        <div><label>Savollar soni</label><input id="qcount" type="number" value="10"></div>
        <div>
          <label>Holat</label>
          <select id="testStatus">
            <option value="draft">Qoralama</option>
            <option value="active">Faol</option>
          </select>
        </div>
      </div>

      <button class="btn green" id="buildBtn" style="margin-top:12px">Savollarni yaratish</button>
    </div>

    <!-- Questions -->
    <div id="questionsArea"></div>

    <!-- Save -->
    <div class="card">
      <button id="saveBtn" class="btn green">Firebase’ga saqlash</button>
      <span id="saveStatus" style="margin-left:10px;color:#2E8B57"></span>
    </div>

  </div>

  <!-- Not admin UI -->
  <div id="notAdmin" style="display:none" class="card">
    Siz admin emassiz. Ruxsat faqat: <b>sohibjonmath@gmail.com</b>
  </div>

</div>

<script>
/* ---------------------------------------------
   1) Firebase Config — Automatically Connected
----------------------------------------------*/
const firebaseConfig = {
  apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  authDomain: "xplusy-760fa.firebaseapp.com",
  projectId: "xplusy-760fa",
  storageBucket: "xplusy-760fa.firebasestorage.app",
  messagingSenderId: "992512966017",
  appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
  measurementId: "G-459PLJ7P7L"
};

// IMPORTANT: initialize IMMEDIATELY (this fixes your error)
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
document.getElementById("status").textContent = "Firebase ulandi. Auth kutilyapti…";


/* ---------------------------------------------
   2) Google Auto-Sign-In (Popup → Redirect Fallback)
----------------------------------------------*/
const ADMIN_EMAIL = "sohibjonmath@gmail.com";

async function autoSignIn() {
  const auth = firebase.auth();

  // If already logged in
  if (auth.currentUser) {
    return handleUser(auth.currentUser);
  }

  const provider = new firebase.auth.GoogleAuthProvider();

  try {
    const res = await auth.signInWithPopup(provider);
    return handleUser(res.user);
  } catch (e) {
    console.warn("Popup ishlamadi, redirect sinab ko‘riladi...");
    await auth.signInWithRedirect(provider);
  }
}

function handleUser(user) {
  if (!user) return;

  document.getElementById("status").textContent = "Kirdi: " + user.email;

  if (user.email.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
    document.getElementById("adminUI").style.display = "";
    document.getElementById("notAdmin").style.display = "none";
  } else {
    document.getElementById("adminUI").style.display = "none";
    document.getElementById("notAdmin").style.display = "";
  }
}

firebase.auth().onAuthStateChanged(user => {
  if (user) handleUser(user);
  else autoSignIn();
});


/* ---------------------------------------------
   3) Question Builder
----------------------------------------------*/
function questionHTML(i) {
  return `
    <div class="card qbox">
      <div class="badge">#${i} — rasm: <code>${i}.jpg</code></div>

      <label>Ball</label>
      <input class="points" type="number" value="1">

      <label>Variantlar (har satr — bitta)</label>
      <textarea class="options" placeholder="A\nB\nC"></textarea>

      <label>To‘g‘ri javob (variant index yoki matn)</label>
      <input class="correct" type="text" placeholder="0 yoki $x=5$">
    </div>
  `;
}

document.getElementById("buildBtn").onclick = () => {
  const n = Number(document.getElementById("qcount").value);
  const area = document.getElementById("questionsArea");
  area.innerHTML = "";
  for (let i = 1; i <= n; i++) {
    area.insertAdjacentHTML("beforeend", questionHTML(i));
  }
};


/* ---------------------------------------------
   4) Save to Firestore
----------------------------------------------*/
document.getElementById("saveBtn").onclick = async () => {
  const tcode = document.getElementById("tcode").value.trim();
  if (!tcode) return alert("Test kodi kiritilmagan!");

  const data = {
    title: document.getElementById("title").value,
    description: document.getElementById("desc").value,
    durationMinutes: Number(document.getElementById("dur").value),
    status: document.getElementById("testStatus").value,
    questions: [],
    version: "2.2",
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  document.querySelectorAll(".qbox").forEach((q, i) => {
    const points = Number(q.querySelector(".points").value);
    const opts = q.querySelector(".options").value.split("\n").map(s => s.trim()).filter(Boolean);
    const correct = q.querySelector(".correct").value;

    data.questions.push({
      points,
      options: opts,
      correct
    });
  });

  try {
    await db.collection("test").doc(tcode).set(data);
    document.getElementById("saveStatus").textContent = "✔ Saqlandi!";
  } catch (e) {
    alert("Xatolik: " + e.message);
  }
};
</script>

</body>
</html>
