<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>LeaderMath ‚Äî Home Admin (Forms + Drag & Drop + Roles)</title>
  <style>
    :root{
      --brand:#2E8B57;--line:#dfe7e2;--muted:#4a6b5a;
      --bg:#f4f8f6;--card:#ffffff;--radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font:14px/1.5 system-ui,Segoe UI,Arial;
      background:var(--bg);color:#102317;
    }
    header{
      position:sticky;top:0;z-index:5;
      background:var(--bg);
      border-bottom:1px solid var(--line);
    }
    .row{
      max-width:1180px;margin:0 auto;
      padding:10px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .brand{font-weight:800;color:var(--brand);font-size:16px;}
    .muted{color:var(--muted);font-size:12px;}
    main{
      max-width:1180px;margin:0 auto;
      padding:14px 16px 24px;
      display:grid;gap:12px;
    }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid var(--line);
      box-shadow:0 10px 28px rgba(12,41,23,.08);
      padding:12px;
    }
    h2{margin:0 0 8px;font-size:15px;}
    h3{margin:0 0 6px;font-size:14px;}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:3px 9px;border-radius:999px;
      background:#edf5f0;border:1px solid var(--line);
      font-size:11px;color:var(--muted);
    }
    .status{
      margin-top:6px;font-size:12px;color:var(--muted);
    }
    .form-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px;
    }
    label{
      display:flex;flex-direction:column;
      font-size:11px;color:var(--muted);
      gap:3px;
    }
    input[type="text"],
    input[type="url"],
    select,
    textarea{
      border-radius:9px;
      border:1px solid var(--line);
      padding:6px 8px;
      font-size:12px;
      font-family:inherit;
      background:#f7fbf8;
    }
    textarea{min-height:70px;resize:vertical;}
    input:focus,select:focus,textarea:focus{
      outline:2px solid rgba(46,139,87,.4);
      background:#ffffff;
    }
    .toolbar{
      display:flex;flex-wrap:wrap;gap:8px;margin:6px 0;
    }
    button{
      border:none;cursor:pointer;
      border-radius:999px;
      padding:7px 14px;
      font-size:12px;font-weight:600;
      display:inline-flex;align-items:center;gap:6px;
      background:#2e8b57;color:#fff;
      box-shadow:0 10px 20px rgba(10,56,30,.28);
      transition:transform .18s,box-shadow .18s,background .18s;
    }
    button.secondary{
      background:#edf5f0;color:var(--brand);
      box-shadow:none;border:1px solid var(--line);
    }
    button.danger{
      background:#e53e3e;
      box-shadow:0 10px 20px rgba(143,21,21,.4);
    }
    button:hover{
      transform:translateY(-1px);
      box-shadow:0 14px 28px rgba(12,60,32,.38);
    }
    button.secondary:hover{
      box-shadow:0 8px 18px rgba(12,40,25,.18);
      background:#ffffff;
    }
    .two-cols{
      display:grid;
      grid-template-columns:minmax(0,230px) minmax(0,1fr);
      gap:12px;
    }
    @media(max-width:800px){
      .two-cols{grid-template-columns:1fr}
    }
    ul.list{
      list-style:none;margin:0;padding:0;
      border-radius:10px;
      border:1px solid var(--line);
      background:#f7fbf8;
      max-height:320px;overflow:auto;
      font-size:12px;
    }
    .list li{
      padding:6px 10px;
      display:flex;align-items:center;justify-content:space-between;
      gap:8px;
      border-bottom:1px solid #e3ece6;
      cursor:grab;
      background:#f7fbf8;
    }
    .list li:last-child{border-bottom:none;}
    .list li.active{
      background:#e6f4ec;
    }
    .list-main{
      display:flex;flex-direction:column;gap:2px;flex:1;
    }
    .list-line-top{display:flex;align-items:center;gap:6px;}
    .list-name{font-weight:600;}
    .list-email{font-size:11px;color:var(--muted);}
    .drag-handle{
      font-size:13px;cursor:grab;color:#9aa9a1;
    }
    .role-chips{
      display:flex;flex-wrap:wrap;gap:6px;font-size:11px;margin-top:4px;
    }
    .role-chips label{
      flex-direction:row;align-items:center;gap:4px;
      background:#f4f8f6;border-radius:999px;padding:3px 7px;
    }
    .role-chips input{width:auto;}
    .login{
      max-width:480px;margin:40px auto;padding:18px;
      text-align:center;
    }
    pre.note{
      margin:8px 0 0;
      font-size:11px;background:#f4f7f5;border-radius:10px;padding:8px;
      overflow:auto;max-height:200px;
    }
    .user-role-select{
      font-size:11px;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#ffffff;
    }
  </style>
</head>
<body>
  <header>
    <div class="row">
      <div>
        <div class="brand">LeaderMath ‚Äî Home Admin</div>
        <div class="muted">configs/home + foydalanuvchi rollari (Pro, user, guest)</div>
      </div>
      <div>
        <span class="badge" id="userBadge">Kirmagansiz</span>
      </div>
    </div>
  </header>

  <main id="app"></main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup,
      onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc,
      collection, getDocs, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain: "xplusy-760fa.firebaseapp.com",
      projectId: "xplusy-760fa",
      storageBucket: "xplusy-760fa.appspot.com",
      messagingSenderId: "457882083595",
      appId: "1:457882083595:web:4b76c5f5a6bcd1d987b9c8"
    };

    const ADMIN_EMAILS = [
      "sohibjonmath@gmail.com"
    ];

    const appFirebase = initializeApp(firebaseConfig);
    const auth = getAuth(appFirebase);
    const db = getFirestore(appFirebase);
    const provider = new GoogleAuthProvider();

    const appRoot = document.getElementById('app');
    const userBadge = document.getElementById('userBadge');

    let state = {
      hero:{
        title:"",
        subtitle:"",
        ctaLabel:"Batafsil",
        ctaHref:"#",
        ctaType:"primary",
        proCtaLabel:"",
        badgeText:"üîÑ Kontent Firebase configs/home dan yuklanmoqda",
        badgeType:"info"
      },
      carousels:[],
      grids:[]
    };

    const sel = {
      carIdx:0,
      slideIdx:0,
      gridIdx:0,
      cardIdx:0
    };

    let usersCache = [];

    function isAdmin(user){
      return !!(user && user.email && ADMIN_EMAILS.includes(user.email));
    }

    function renderLogin(){
      appRoot.innerHTML = `
        <div class="card login">
          <h2>Admin panelga kirish</h2>
          <p>Google akkaunt orqali kiring. Faqat ADMIN_EMAILS ro‚Äòyxatidagi email-lar kirishi mumkin.</p>
          <button id="loginBtn">Google bilan kirish</button>
        </div>
      `;
      document.getElementById('loginBtn').onclick = async ()=>{
        try{
          await signInWithPopup(auth, provider);
        }catch(e){
          alert("Kirishda xatolik: " + e.message);
        }
      };
      userBadge.textContent = "Kirmagansiz";
    }

    function renderForbidden(){
      appRoot.innerHTML = `
        <div class="card login">
          <h2>Kirish taqiqlangan</h2>
          <p>Bu sahifa faqat maxsus admin akkauntlar uchun. Joriy email ruxsat etilmagan.</p>
          <button id="logoutBtn">Akkauntni almashtirish</button>
        </div>
      `;
      document.getElementById('logoutBtn').onclick = ()=>signOut(auth);
      userBadge.textContent = "Ruxsat yo‚Äòq";
    }

    function ensureDefaults(){
      state = state || {};
      state.hero = state.hero || {
        title:"",
        subtitle:"",
        ctaLabel:"Batafsil",
        ctaHref:"#",
        ctaType:"primary",
        proCtaLabel:"",
        badgeText:"üîÑ Kontent Firebase configs/home dan yuklanmoqda",
        badgeType:"info"
      };
      if(typeof state.hero.proCtaLabel !== 'string') state.hero.proCtaLabel = "";
      state.carousels = Array.isArray(state.carousels) ? state.carousels : [];
      state.grids = Array.isArray(state.grids) ? state.grids : [];
    }

    function renderAdmin(){
      ensureDefaults();
      appRoot.innerHTML = `
        <div class="card" id="heroCard">
          <h2>Hero blok</h2>
          <p class="muted">Sarlavha, CTA tugma va badge (rang turlari bilan). Pro foydalanuvchilar uchun alohida CTA ham qo‚Äòyish mumkin.</p>
          <div class="form-grid">
            <label>Title
              <input type="text" id="hero_title">
            </label>
            <label>Subtitle
              <input type="text" id="hero_subtitle">
            </label>
            <label>CTA label (oddiy foydalanuvchilar)
              <input type="text" id="hero_ctaLabel">
            </label>
            <label>CTA havola (URL)
              <input type="url" id="hero_ctaHref">
            </label>
            <label>CTA turi
              <select id="hero_ctaType">
                <option value="primary">Primary (yashil)</option>
                <option value="success">Success (yashil)</option>
                <option value="warning">Warning (to‚Äòq sariq)</option>
                <option value="info">Info (ko‚Äòk)</option>
              </select>
            </label>
            <label>Pro CTA label (ixtiyoriy)
              <input type="text" id="hero_proCtaLabel" placeholder="Pro foydalanuvchilar uchun alohida matn">
            </label>
            <label>Badge matni
              <input type="text" id="hero_badgeText">
            </label>
            <label>Badge turi
              <select id="hero_badgeType">
                <option value="info">Info (ko‚Äòk)</option>
                <option value="success">Success (yashil)</option>
                <option value="warning">Warning (sariq)</option>
              </select>
            </label>
          </div>
        </div>

        <div class="card" id="carCard">
          <h2>Carousellar</h2>
          <div class="two-cols">
            <div>
              <div class="toolbar">
                <button id="addCarouselBtn" class="secondary">+ Carusel qo‚Äòshish</button>
              </div>
              <ul class="list" id="carList"></ul>
            </div>
            <div id="carEditor"></div>
          </div>
        </div>

        <div class="card" id="gridCard">
          <h2>Grid cardlar</h2>
          <div class="two-cols">
            <div>
              <div class="toolbar">
                <button id="addGridBtn" class="secondary">+ Grid bo‚Äòlim qo‚Äòshish</button>
              </div>
              <ul class="list" id="gridList"></ul>
            </div>
            <div id="gridEditor"></div>
          </div>
        </div>

        <div class="card" id="usersCard">
          <h2>Foydalanuvchilar va rollar</h2>
          <p class="muted">Bu yerda users kolleksiyasidagi foydalanuvchilarga <strong>guest/user/pro</strong> rollarini berasiz. ADMIN_EMAILS bo‚Äòyicha admin aniqlanadi.</p>
          <div class="toolbar">
            <button id="reloadUsersBtn" class="secondary">Foydalanuvchilarni yuklash</button>
          </div>
          <div id="usersBody" class="status">Hali yuklanmadi.</div>
        </div>

        <div class="card" id="saveCard">
          <h2>Saqlash</h2>
          <div class="toolbar">
            <button id="reloadBtn" class="secondary">configs/home ni qayta yuklash</button>
            <button id="saveBtn">Firestore configs/home ga saqlash</button>
            <button id="signOutBtn" class="secondary">Chiqish</button>
          </div>
          <div class="status" id="statusText">Holat: tayyor.</div>
          <pre class="note">
Eslatma:
- Har bir slide/card uchun visibleRoles ni belgilang:
  guest (kirilmagan), user, pro.
- Index.html da elementlar foydalanuvchi roliga qarab filtrlanadi.
- Foydalanuvchi roli users/{uid}.role maydonidan olinadi.
          </pre>
        </div>
      `;

      bindHeroForm();
      renderCarouselsPanel();
      renderGridsPanel();
      setupUserPanel();
      bindSavePanel();
    }

    function bindHeroForm(){
      const h = state.hero;
      const t = (id)=>document.getElementById(id);
      t('hero_title').value = h.title || "";
      t('hero_subtitle').value = h.subtitle || "";
      t('hero_ctaLabel').value = h.ctaLabel || "Batafsil";
      t('hero_ctaHref').value = h.ctaHref || "#";
      t('hero_ctaType').value = h.ctaType || "primary";
      t('hero_proCtaLabel').value = h.proCtaLabel || "";
      t('hero_badgeText').value = h.badgeText || "üîÑ Kontent Firebase configs/home dan yuklanmoqda";
      t('hero_badgeType').value = h.badgeType || "info";

      const update = ()=>{
        state.hero = {
          title: t('hero_title').value.trim(),
          subtitle: t('hero_subtitle').value.trim(),
          ctaLabel: t('hero_ctaLabel').value.trim() || "Batafsil",
          ctaHref: t('hero_ctaHref').value.trim() || "#",
          ctaType: t('hero_ctaType').value,
          proCtaLabel: t('hero_proCtaLabel').value.trim(),
          badgeText: t('hero_badgeText').value.trim() || "üîÑ Kontent Firebase configs/home dan yuklanmoqda",
          badgeType: t('hero_badgeType').value
        };
      };
      ['hero_title','hero_subtitle','hero_ctaLabel','hero_ctaHref','hero_ctaType','hero_proCtaLabel','hero_badgeText','hero_badgeType']
        .forEach(id=>t(id).addEventListener('input',update));
    }

    // ===== CAROUSEL PANEL =====
    function renderCarouselsPanel(){
      ensureDefaults();
      const carList = document.getElementById('carList');
      const carEditor = document.getElementById('carEditor');
      carList.innerHTML = '';

      state.carousels.forEach((c,idx)=>{
        const li = document.createElement('li');
        li.dataset.index = idx;
        li.draggable = true;
        if(idx === sel.carIdx) li.classList.add('active');
        li.innerHTML = `
          <div class="list-main">
            <div class="list-line-top">
              <span class="drag-handle">‚ò∞</span>
              <span class="list-name">${c.title || ('Carusel '+(idx+1))}</span>
            </div>
          </div>
          <button class="secondary" data-action="remove">‚úï</button>
        `;
        carList.appendChild(li);
      });

      carList.querySelectorAll('li').forEach(li=>{
        li.addEventListener('click',e=>{
          if(e.target.dataset.action === 'remove') return;
          sel.carIdx = Number(li.dataset.index);
          sel.slideIdx = 0;
          renderCarouselsPanel();
        });
        li.addEventListener('dragstart',e=>{
          e.dataTransfer.setData('text/plain', li.dataset.index);
        });
        li.addEventListener('dragover',e=>e.preventDefault());
        li.addEventListener('drop',e=>{
          e.preventDefault();
          const from = Number(e.dataTransfer.getData('text/plain'));
          const to = Number(li.dataset.index);
          if(from===to) return;
          const arr = state.carousels;
          arr.splice(to,0, arr.splice(from,1)[0]);
          sel.carIdx = to;
          renderCarouselsPanel();
        });
        const removeBtn = li.querySelector('button[data-action="remove"]');
        removeBtn.onclick = (ev)=>{
          ev.stopPropagation();
          if(!confirm("Ushbu caruselni o‚Äòchirishni xohlaysizmi?")) return;
          state.carousels.splice(Number(li.dataset.index),1);
          if(sel.carIdx >= state.carousels.length) sel.carIdx = state.carousels.length-1;
          if(sel.carIdx < 0) sel.carIdx = 0;
          renderCarouselsPanel();
        };
      });

      document.getElementById('addCarouselBtn').onclick = ()=>{
        state.carousels.push({
          id: 'car_'+Date.now(),
          title:'Yangi carusel',
          items:[]
        });
        sel.carIdx = state.carousels.length-1;
        sel.slideIdx = 0;
        renderCarouselsPanel();
      };

      if(!state.carousels.length){
        carEditor.innerHTML = `<p class="muted">Hozircha carusel yo‚Äòq. ‚Äú+ Carusel qo‚Äòshish‚Äù tugmasini bosing.</p>`;
        return;
      }

      const car = state.carousels[sel.carIdx] || state.carousels[0];
      sel.carIdx = state.carousels.indexOf(car);

      carEditor.innerHTML = `
        <h3>Carusel tahriri</h3>
        <div class="form-grid">
          <label>Carusel ID (o‚Äòzgartirmaslik tavsiya etiladi)
            <input type="text" id="car_id" disabled>
          </label>
          <label>Carusel title
            <input type="text" id="car_title">
          </label>
        </div>
        <div class="toolbar">
          <button id="addSlideBtn" class="secondary">+ Slide qo‚Äòshish</button>
        </div>
        <div class="two-cols">
          <div>
            <ul class="list" id="slideList"></ul>
          </div>
          <div id="slideEditor"></div>
        </div>
      `;

      const carIdInput = document.getElementById('car_id');
      const carTitleInput = document.getElementById('car_title');
      carIdInput.value = car.id || '';
      carTitleInput.value = car.title || '';
      carTitleInput.addEventListener('input',()=>{
        car.title = carTitleInput.value.trim();
      });

      const slideList = document.getElementById('slideList');
      slideList.innerHTML = '';
      car.items = Array.isArray(car.items)?car.items:[];
      car.items.forEach((s,idx)=>{
        const li = document.createElement('li');
        li.dataset.index = idx;
        li.draggable = true;
        if(idx === sel.slideIdx) li.classList.add('active');
        li.innerHTML = `
          <div class="list-main">
            <div class="list-line-top">
              <span class="drag-handle">‚ò∞</span>
              <span class="list-name">${s.title || ('Slide '+(idx+1))}</span>
            </div>
          </div>
          <button class="secondary" data-action="remove">‚úï</button>
        `;
        slideList.appendChild(li);
      });

      slideList.querySelectorAll('li').forEach(li=>{
        li.addEventListener('click',e=>{
          if(e.target.dataset.action === 'remove') return;
          sel.slideIdx = Number(li.dataset.index);
          renderCarouselsPanel();
        });
        li.addEventListener('dragstart',e=>{
          e.dataTransfer.setData('text/plain', li.dataset.index);
        });
        li.addEventListener('dragover',e=>e.preventDefault());
        li.addEventListener('drop',e=>{
          e.preventDefault();
          const from = Number(e.dataTransfer.getData('text/plain'));
          const to = Number(li.dataset.index);
          if(from===to) return;
          car.items.splice(to,0, car.items.splice(from,1)[0]);
          sel.slideIdx = to;
          renderCarouselsPanel();
        });
        const rm = li.querySelector('button[data-action="remove"]');
        rm.onclick = (ev)=>{
          ev.stopPropagation();
          if(!confirm("Ushbu slaydni o‚Äòchirishni xohlaysizmi?")) return;
          car.items.splice(Number(li.dataset.index),1);
          if(sel.slideIdx >= car.items.length) sel.slideIdx = car.items.length-1;
          if(sel.slideIdx < 0) sel.slideIdx = 0;
          renderCarouselsPanel();
        };
      });

      document.getElementById('addSlideBtn').onclick = ()=>{
        car.items.push({
          id:'slide_'+Date.now(),
          title:'Yangi slide',
          text:'',
          imageUrl:'',
          href:'',
          badge:'',
          badgeType:'info',
          visibleRoles:['guest','user','pro']
        });
        sel.slideIdx = car.items.length-1;
        renderCarouselsPanel();
      };

      const slideEditor = document.getElementById('slideEditor');
      if(!car.items.length){
        slideEditor.innerHTML = `<p class="muted">Bu caruselda hali slayd yo‚Äòq. ‚Äú+ Slide qo‚Äòshish‚Äù tugmasini bosing.</p>`;
        return;
      }
      const slide = car.items[sel.slideIdx] || car.items[0];
      sel.slideIdx = car.items.indexOf(slide);

      slideEditor.innerHTML = `
        <h3>Slide tahriri</h3>
        <div class="form-grid">
          <label>Title
            <input type="text" id="slide_title">
          </label>
          <label>Matn
            <textarea id="slide_text"></textarea>
          </label>
          <label>Rasm URL (16:9)
            <input type="url" id="slide_imageUrl">
          </label>
          <label>Havola (URL)
            <input type="url" id="slide_href">
          </label>
          <label>Badge matni
            <input type="text" id="slide_badge">
          </label>
          <label>Badge turi
            <select id="slide_badgeType">
              <option value="info">Info (ko‚Äòk)</option>
              <option value="success">Success (yashil)</option>
              <option value="warning">Warning (sariq)</option>
            </select>
          </label>
        </div>
        <div style="margin-top:6px;">
          <div class="muted">Ko‚Äòrinadigan rollar:</div>
          <div class="role-chips">
            <label><input type="checkbox" id="sr_guest"> guest</label>
            <label><input type="checkbox" id="sr_user"> user</label>
            <label><input type="checkbox" id="sr_pro"> pro</label>
          </div>
        </div>
      `;

      const st = (id)=>document.getElementById(id);
      st('slide_title').value = slide.title || "";
      st('slide_text').value = slide.text || "";
      st('slide_imageUrl').value = slide.imageUrl || "";
      st('slide_href').value = slide.href || "";
      st('slide_badge').value = slide.badge || "";
      st('slide_badgeType').value = slide.badgeType || "info";

      const vis = Array.isArray(slide.visibleRoles)?slide.visibleRoles:[];
      st('sr_guest').checked = vis.includes('guest');
      st('sr_user').checked = vis.includes('user');
      st('sr_pro').checked = vis.includes('pro');

      const updateSlide = ()=>{
        slide.title = st('slide_title').value.trim();
        slide.text = st('slide_text').value.trim();
        slide.imageUrl = st('slide_imageUrl').value.trim();
        slide.href = st('slide_href').value.trim();
        slide.badge = st('slide_badge').value.trim();
        slide.badgeType = st('slide_badgeType').value;
        const roles = [];
        if(st('sr_guest').checked) roles.push('guest');
        if(st('sr_user').checked) roles.push('user');
        if(st('sr_pro').checked) roles.push('pro');
        slide.visibleRoles = roles;
      };
      ['slide_title','slide_text','slide_imageUrl','slide_href','slide_badge','slide_badgeType']
        .forEach(id=>st(id).addEventListener('input',updateSlide));
      ['sr_guest','sr_user','sr_pro'].forEach(id=>st(id).addEventListener('change',updateSlide));
    }

    // ===== GRID PANEL =====
    function renderGridsPanel(){
      ensureDefaults();
      const gridList = document.getElementById('gridList');
      const gridEditor = document.getElementById('gridEditor');
      gridList.innerHTML = '';

      state.grids.forEach((g,idx)=>{
        const li = document.createElement('li');
        li.dataset.index = idx;
        li.draggable = true;
        if(idx === sel.gridIdx) li.classList.add('active');
        li.innerHTML = `
          <div class="list-main">
            <div class="list-line-top">
              <span class="drag-handle">‚ò∞</span>
              <span class="list-name">${g.title || ('Bo‚Äòlim '+(idx+1))}</span>
            </div>
          </div>
          <button class="secondary" data-action="remove">‚úï</button>
        `;
        gridList.appendChild(li);
      });

      gridList.querySelectorAll('li').forEach(li=>{
        li.addEventListener('click',e=>{
          if(e.target.dataset.action === 'remove') return;
          sel.gridIdx = Number(li.dataset.index);
          sel.cardIdx = 0;
          renderGridsPanel();
        });
        li.addEventListener('dragstart',e=>{
          e.dataTransfer.setData('text/plain', li.dataset.index);
        });
        li.addEventListener('dragover',e=>e.preventDefault());
        li.addEventListener('drop',e=>{
          e.preventDefault();
          const from = Number(e.dataTransfer.getData('text/plain'));
          const to = Number(li.dataset.index);
          if(from===to) return;
          state.grids.splice(to,0, state.grids.splice(from,1)[0]);
          sel.gridIdx = to;
          renderGridsPanel();
        });
        const rm = li.querySelector('button[data-action="remove"]');
        rm.onclick = (ev)=>{
          ev.stopPropagation();
          if(!confirm("Ushbu bo‚Äòlimni o‚Äòchirishni xohlaysizmi?")) return;
          state.grids.splice(Number(li.dataset.index),1);
          if(sel.gridIdx >= state.grids.length) sel.gridIdx = state.grids.length-1;
          if(sel.gridIdx < 0) sel.gridIdx = 0;
          renderGridsPanel();
        };
      });

      document.getElementById('addGridBtn').onclick = ()=>{
        state.grids.push({
          id:'grid_'+Date.now(),
          title:'Yangi bo‚Äòlim',
          items:[]
        });
        sel.gridIdx = state.grids.length-1;
        sel.cardIdx = 0;
        renderGridsPanel();
      };

      if(!state.grids.length){
        gridEditor.innerHTML = `<p class="muted">Hozircha grid bo‚Äòlimlar yo‚Äòq. ‚Äú+ Grid bo‚Äòlim qo‚Äòshish‚Äù tugmasini bosing.</p>`;
        return;
      }

      const grid = state.grids[sel.gridIdx] || state.grids[0];
      sel.gridIdx = state.grids.indexOf(grid);

      gridEditor.innerHTML = `
        <h3>Grid bo‚Äòlim tahriri</h3>
        <div class="form-grid">
          <label>Grid ID (o‚Äòzgartirmaslik tavsiya etiladi)
            <input type="text" id="grid_id" disabled>
          </label>
          <label>Bo‚Äòlim title
            <input type="text" id="grid_title">
          </label>
        </div>
        <div class="toolbar">
          <button id="addCardBtn" class="secondary">+ Card qo‚Äòshish</button>
        </div>
        <div class="two-cols">
          <div>
            <ul class="list" id="cardList"></ul>
          </div>
          <div id="cardEditor"></div>
        </div>
      `;

      const gi = (id)=>document.getElementById(id);
      gi('grid_id').value = grid.id || "";
      gi('grid_title').value = grid.title || "";
      gi('grid_title').addEventListener('input',()=>{
        grid.title = gi('grid_title').value.trim();
      });

      const cardList = document.getElementById('cardList');
      cardList.innerHTML = '';
      grid.items = Array.isArray(grid.items)?grid.items:[];
      grid.items.forEach((c,idx)=>{
        const li = document.createElement('li');
        li.dataset.index = idx;
        li.draggable = true;
        if(idx === sel.cardIdx) li.classList.add('active');
        li.innerHTML = `
          <div class="list-main">
            <div class="list-line-top">
              <span class="drag-handle">‚ò∞</span>
              <span class="list-name">${c.title || ('Card '+(idx+1))}</span>
            </div>
          </div>
          <button class="secondary" data-action="remove">‚úï</button>
        `;
        cardList.appendChild(li);
      });

      cardList.querySelectorAll('li').forEach(li=>{
        li.addEventListener('click',e=>{
          if(e.target.dataset.action === 'remove') return;
          sel.cardIdx = Number(li.dataset.index);
          renderGridsPanel();
        });
        li.addEventListener('dragstart',e=>{
          e.dataTransfer.setData('text/plain', li.dataset.index);
        });
        li.addEventListener('dragover',e=>e.preventDefault());
        li.addEventListener('drop',e=>{
          e.preventDefault();
          const from = Number(e.dataTransfer.getData('text/plain'));
          const to = Number(li.dataset.index);
          if(from===to) return;
          grid.items.splice(to,0, grid.items.splice(from,1)[0]);
          sel.cardIdx = to;
          renderGridsPanel();
        });
        const rm = li.querySelector('button[data-action="remove"]');
        rm.onclick = (ev)=>{
          ev.stopPropagation();
          if(!confirm("Ushbu cardni o‚Äòchirishni xohlaysizmi?")) return;
          grid.items.splice(Number(li.dataset.index),1);
          if(sel.cardIdx >= grid.items.length) sel.cardIdx = grid.items.length-1;
          if(sel.cardIdx < 0) sel.cardIdx = 0;
          renderGridsPanel();
        };
      });

      document.getElementById('addCardBtn').onclick = ()=>{
        grid.items.push({
          id:'card_'+Date.now(),
          title:'Yangi card',
          text:'',
          icon:'üì¶',
          href:'',
          status:'active',
          visibleRoles:['guest','user','pro']
        });
        sel.cardIdx = grid.items.length-1;
        renderGridsPanel();
      };

      const cardEditor = document.getElementById('cardEditor');
      if(!grid.items.length){
        cardEditor.innerHTML = `<p class="muted">Bu bo‚Äòlimda card yo‚Äòq. ‚Äú+ Card qo‚Äòshish‚Äù tugmasini bosing.</p>`;
        return;
      }

      const card = grid.items[sel.cardIdx] || grid.items[0];
      sel.cardIdx = grid.items.indexOf(card);

      cardEditor.innerHTML = `
        <h3>Card tahriri</h3>
        <div class="form-grid">
          <label>Title
            <input type="text" id="card_title">
          </label>
          <label>Matn
            <textarea id="card_text"></textarea>
          </label>
          <label>Icon (emoji yoki matn)
            <input type="text" id="card_icon">
          </label>
          <label>Havola (URL)
            <input type="url" id="card_href">
          </label>
          <label>Status
            <select id="card_status">
              <option value="active">active</option>
              <option value="soon">soon</option>
            </select>
          </label>
        </div>
        <div style="margin-top:6px;">
          <div class="muted">Ko‚Äòrinadigan rollar:</div>
          <div class="role-chips">
            <label><input type="checkbox" id="cr_guest"> guest</label>
            <label><input type="checkbox" id="cr_user"> user</label>
            <label><input type="checkbox" id="cr_pro"> pro</label>
          </div>
        </div>
      `;

      const c = (id)=>document.getElementById(id);
      c('card_title').value = card.title || "";
      c('card_text').value = card.text || "";
      c('card_icon').value = card.icon || "üì¶";
      c('card_href').value = card.href || "";
      c('card_status').value = card.status || "active";

      const vis = Array.isArray(card.visibleRoles)?card.visibleRoles:[];
      c('cr_guest').checked = vis.includes('guest');
      c('cr_user').checked = vis.includes('user');
      c('cr_pro').checked = vis.includes('pro');

      const updateCard = ()=>{
        card.title = c('card_title').value.trim();
        card.text = c('card_text').value.trim();
        card.icon = c('card_icon').value || "üì¶";
        card.href = c('card_href').value.trim();
        card.status = c('card_status').value;
        const roles = [];
        if(c('cr_guest').checked) roles.push('guest');
        if(c('cr_user').checked) roles.push('user');
        if(c('cr_pro').checked) roles.push('pro');
        card.visibleRoles = roles;
      };
      ['card_title','card_text','card_icon','card_href','card_status']
        .forEach(id=>c(id).addEventListener('input',updateCard));
      ['cr_guest','cr_user','cr_pro'].forEach(id=>c(id).addEventListener('change',updateCard));
    }

    // ===== FOYDALANUVCHI PANELI =====
    function setupUserPanel(){
      const btn = document.getElementById('reloadUsersBtn');
      const container = document.getElementById('usersBody');
      btn.onclick = ()=>loadUsers(container);
    }

    async function loadUsers(container){
      container.textContent = "Foydalanuvchilar yuklanmoqda...";
      try{
        const snap = await getDocs(collection(db,'users'));
        usersCache = [];
        snap.forEach(d=>{
          const data = d.data();
          usersCache.push({
            uid:d.id,
            displayName:data.displayName || data.first || "",
            email:data.email || "",
            role:data.role || "user"
          });
        });
        usersCache.sort((a,b)=>{
          const an = a.displayName || a.email || "";
          const bn = b.displayName || b.email || "";
          return an.localeCompare(bn);
        });
        renderUsersList(container);
      }catch(e){
        console.error(e);
        container.textContent = "Yuklashda xatolik: " + e.message;
      }
    }

    function renderUsersList(container){
      if(!usersCache.length){
        container.textContent = "Foydalanuvchi topilmadi (users kolleksiyasi bo‚Äòsh).";
        return;
      }
      let html = '<ul class="list">';
      usersCache.forEach((u,idx)=>{
        const name = u.displayName || u.email || ('user-'+(idx+1));
        const email = u.email || '';
        const role = u.role || 'user';
        html += `
          <li data-uid="${u.uid}">
            <div class="list-main">
              <div class="list-line-top">
                <span class="list-name">${name}</span>
                <span class="list-email">${email}</span>
              </div>
            </div>
            <select class="user-role-select">
              <option value="guest"${role==='guest'?' selected':''}>guest</option>
              <option value="user"${role==='user'?' selected':''}>user</option>
              <option value="pro"${role==='pro'?' selected':''}>pro</option>
            </select>
            <button class="secondary saveUserBtn" type="button">Saqlash</button>
          </li>
        `;
      });
      html += '</ul>';
      container.innerHTML = html;

      container.querySelectorAll('li').forEach(li=>{
        const uid = li.dataset.uid;
        const sel = li.querySelector('.user-role-select');
        const btn = li.querySelector('.saveUserBtn');
        btn.onclick = async ()=>{
          const newRole = sel.value;
          try{
            const ref = doc(db,'users',uid);
            try{
              await updateDoc(ref,{role:newRole});
            }catch(err){
              // agar doc yoq bo'lsa, setDoc bilan yaratamiz
              await setDoc(ref,{role:newRole},{merge:true});
            }
            alert("Rol saqlandi: " + newRole);
          }catch(e){
            console.error(e);
            alert("Saqlashda xatolik: " + e.message);
          }
        };
      });
    }

    // ===== SAQLASH PANELI =====
    function bindSavePanel(){
      const statusText = document.getElementById('statusText');
      document.getElementById('reloadBtn').onclick = async ()=>{
        statusText.textContent = "Holat: configs/home qayta yuklanmoqda...";
        try{
          const snap = await getDoc(doc(db,'configs','home'));
          if(snap.exists()){
            state = snap.data();
            ensureDefaults();
            renderAdmin();
            statusText.textContent = "Holat: configs/home qayta yuklandi.";
          }else{
            alert("configs/home mavjud emas. Hozirgi forma orqali yangisini saqlashingiz mumkin.");
            statusText.textContent = "Holat: configs/home topilmadi.";
          }
        }catch(e){
          console.error(e);
          alert("Yuklashda xatolik: " + e.message);
          statusText.textContent = "Holat: xatolik.";
        }
      };

      document.getElementById('saveBtn').onclick = async ()=>{
        statusText.textContent = "Holat: saqlanmoqda...";
        try{
          await setDoc(doc(db,'configs','home'), state, { merge:false });
          statusText.textContent = "Holat: muvaffaqiyatli saqlandi ‚úÖ";
          alert("Saqlandi. Endi index.html sahifasini yangilab ko‚Äòring.");
        }catch(e){
          console.error(e);
          alert("Saqlashda xatolik: " + e.message);
          statusText.textContent = "Holat: xatolik.";
        }
      };

      document.getElementById('signOutBtn').onclick = ()=>signOut(auth);
    }

    async function initForUser(user){
      if(!user){
        renderLogin();
        return;
      }
      userBadge.textContent = user.email || "Admin";
      if(!isAdmin(user)){
        renderForbidden();
        return;
      }
      try{
        const snap = await getDoc(doc(db,'configs','home'));
        if(snap.exists()){
          state = snap.data();
        }
        ensureDefaults();
        renderAdmin();
      }catch(e){
        console.error(e);
        alert("configs/home ni o‚Äòqishda xatolik: " + e.message);
        renderAdmin(); // default bilan
      }
    }

    onAuthStateChanged(auth,(user)=>{
      if(!user){
        renderLogin();
        return;
      }
      initForUser(user).catch(e=>{
        console.error(e);
        alert("Xatolik: " + e.message);
      });
    });
  </script>
</body>
</html>
