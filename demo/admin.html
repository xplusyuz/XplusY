<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Admin â€” Card + Ads</title>
  <meta name="theme-color" content="#2E8B57"/>

  <style>
    :root{
      --brand:#2E8B57; --brand-dark:#1F6B45;
      --bg:#F4F8F6; --card:#FFFFFF;
      --line:#DFE7E2; --muted:#5A7464;
      --radius:14px; --radius-lg:18px; --pill:999px;
      --shadow:0 18px 50px rgba(16,40,26,.16);
      --shadow-sm:0 10px 28px rgba(16,40,26,.10);
      --speed:.2s;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#E8F3EB 0,#F4F8F6 40%,#F8FBF9 100%);
      color:#0F1B15;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter:blur(16px);
      background:linear-gradient(120deg,rgba(244,248,246,.96),rgba(233,244,238,.9));
      border-bottom:1px solid rgba(223,231,226,.9);
    }
    .row{
      max-width:1180px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 16px;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:8px;
      font-weight:800; letter-spacing:.03em;
      text-transform:uppercase; font-size:14px;
      color:var(--brand);
    }
    .brand-pill{
      padding:4px 10px;
      border-radius:999px;
      background:rgba(46,139,87,.08);
      border:1px solid rgba(46,139,87,.18);
      font-size:11px; font-weight:600;
      color:var(--muted);
    }
    .user-chip{
      display:flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.9);
      border:1px solid rgba(223,231,226,.9);
      box-shadow:var(--shadow-sm);
      cursor:pointer;
      font-size:13px;
      transition:transform var(--speed),box-shadow var(--speed),background var(--speed);
    }
    .user-chip:hover{
      transform:translateY(-1px);
      box-shadow:0 14px 40px rgba(16,40,26,.2);
      background:#FFFFFF;
    }
    .avatar{
      width:28px; height:28px;
      border-radius:50%; background:linear-gradient(135deg,#2E8B57,#6B8E23);
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-size:15px; font-weight:700;
    }
    .user-meta{
      display:flex; flex-direction:column; line-height:1.1;
    }
    .user-meta span:first-child{
      font-weight:600; font-size:13px;
    }
    .user-meta span:last-child{
      font-size:11px; color:var(--muted);
    }
    .btn{
      border:0; outline:0; cursor:pointer;
      border-radius:999px;
      padding:6px 14px;
      font-size:13px; font-weight:600;
      display:inline-flex; align-items:center; gap:6px;
      transition:background var(--speed),transform var(--speed),box-shadow var(--speed);
      background:var(--brand); color:#fff;
      box-shadow:0 10px 30px rgba(46,139,87,.35);
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 16px 40px rgba(46,139,87,.45);
    }
    .btn-outline{
      background:transparent;
      color:var(--brand);
      border:1px solid rgba(46,139,87,.5);
      box-shadow:none;
    }
    main{
      max-width:1180px; margin:12px auto 24px;
      padding:0 16px 24px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .grid{
      display:grid; grid-template-columns:280px minmax(0,1fr);
      gap:14px;
    }
    .card{
      background:radial-gradient(circle at top left,rgba(255,255,255,.95),rgba(249,253,250,.98));
      border-radius:var(--radius-lg);
      border:1px solid rgba(223,231,226,.9);
      box-shadow:var(--shadow);
      padding:14px 14px 10px;
    }
    .card-title{
      font-size:13px; font-weight:700;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      margin-bottom:8px;
      display:flex; align-items:center; justify-content:space-between;
      gap:8px;
    }
    .chips-list{
      display:flex; flex-direction:column; gap:6px;
      max-height:360px; overflow:auto;
      padding-right:2px;
    }
    .chip-row{
      border-radius:var(--radius);
      padding:7px 9px;
      display:flex; align-items:center; justify-content:space-between;
      gap:8px;
      cursor:pointer;
      background:rgba(255,255,255,.9);
      border:1px solid rgba(223,231,226,.9);
      transition:background var(--speed),transform var(--speed),box-shadow var(--speed),border-color var(--speed);
      font-size:13px;
    }
    .chip-row:hover{
      transform:translateY(-1px);
      box-shadow:var(--shadow-sm);
    }
    .chip-row.active{
      background:linear-gradient(120deg,#2E8B57,#6B8E23);
      color:#fff;
      border-color:transparent;
      box-shadow:0 12px 32px rgba(46,139,87,.55);
    }
    .chip-row span.icon{
      font-size:16px;
    }
    .chip-row small{
      font-size:11px; opacity:.75;
    }
    .chip-actions{
      display:flex; flex-wrap:wrap; gap:6px;
      margin-top:6px;
    }
    .pill-badge{
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;
      background:rgba(46,139,87,.08);
      color:var(--muted);
      border:1px solid rgba(46,139,87,.12);
    }
    .form-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:8px;
      margin-bottom:8px;
    }
    label{
      display:flex; flex-direction:column; gap:3px;
      font-size:11px; text-transform:uppercase;
      letter-spacing:.06em; color:var(--muted);
    }
    input, textarea{
      border-radius:10px;
      border:1px solid rgba(212,222,217,.9);
      padding:7px 9px;
      font:inherit;
      font-size:13px;
      background:rgba(255,255,255,.96);
      outline:none;
      transition:border-color var(--speed),box-shadow var(--speed),background var(--speed);
    }
    input:focus, textarea:focus{
      border-color:rgba(46,139,87,.7);
      box-shadow:0 0 0 1px rgba(46,139,87,.18);
      background:#fff;
    }
    textarea{min-height:60px;resize:vertical;}
    .section-row{
      display:grid;
      grid-template-columns:minmax(0,1fr);
      gap:10px;
      margin-top:6px;
    }
    .items-list{
      max-height:230px; overflow:auto;
      border-radius:var(--radius);
      border:1px solid rgba(223,231,226,.9);
      background:rgba(255,255,255,.96);
      padding:4px;
      display:flex; flex-direction:column; gap:4px;
    }
    .item-row{
      border-radius:10px;
      padding:6px 8px;
      display:flex; justify-content:space-between; align-items:center;
      font-size:12px;
      cursor:pointer;
      transition:background var(--speed),transform var(--speed),box-shadow var(--speed);
    }
    .item-row:hover{
      background:rgba(239,246,242,1);
      transform:translateY(-1px);
      box-shadow:var(--shadow-sm);
    }
    .item-row.active{
      background:linear-gradient(120deg,#2E8B57,#6B8E23);
      color:#fff;
      box-shadow:0 12px 32px rgba(46,139,87,.55);
    }
    .item-actions{
      display:flex; gap:4px;
    }
    .danger{
      color:#b32630;
    }
    .muted{
      color:var(--muted);
    }
    @media(max-width:820px){
      .grid{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
<header>
  <div class="row">
    <div class="brand">
      <span>LeaderMath Admin</span>
      <span class="brand-pill">Card â€¢ Ads â€¢ Rollar</span>
    </div>
    <div id="authArea"></div>
  </div>
</header>

<main>
  <!-- CHIPLAR + CARDLAR -->
  <div class="card">
    <div class="card-title">
      <span>Chiplar roâ€˜yxati (faqat cardlar)</span>
      <button class="btn btn-outline" id="addChipBtn">+ Chip qoâ€˜shish</button>
    </div>
    <div class="chips-list" id="chipsList"></div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="card-title">
        <span>Tanlangan chip â€” asosiy maâ€™lumotlar</span>
      </div>
      <div id="chipForm" class="form-grid">
        <label>
          Chip ID (unikal)
          <input id="chipId" placeholder="masalan: math-basic">
        </label>
        <label>
          Chip nomi (label)
          <input id="chipLabel" placeholder="masalan: Matematika">
        </label>
        <label>
          Icon (emoji)
          <input id="chipIcon" placeholder="ðŸ“">
        </label>
        <label>
          Koâ€˜rinadigan rollar (vergul bilan)
          <input id="chipRoles" placeholder="guest,user,pro">
        </label>
      </div>
      <div class="chip-actions">
        <span class="pill-badge" id="chipStatus">Chip tanlanmagan</span>
        <button class="btn btn-outline" id="deleteChipBtn">Chipni oâ€˜chirish</button>
        <button class="btn" id="saveAllBtn">BARCHA Oâ€˜ZGARISHLARNI SAQLASH</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">
        <span>Cardlar</span>
        <button class="btn btn-outline" id="addCardBtn" style="padding:4px 10px;font-size:11px;">+ Card</button>
      </div>

      <div class="section-row">
        <div>
          <div id="cardsList" class="items-list"></div>
        </div>
      </div>

      <div style="margin-top:10px;">
        <div class="form-grid">
          <label>
            Sarlavha (title)
            <input id="itemTitle">
          </label>
          <label>
            Badge
            <input id="itemBadge" placeholder="Yangi, Pro, Chegirma...">
          </label>
          <label>
            CTAlabel
            <input id="itemCtaLabel" placeholder="Boshlash, Koâ€˜rish...">
          </label>
          <label>
            CTA havola (url)
            <input id="itemCtaHref" placeholder="https://...">
          </label>
          <label>
            Koâ€˜rinadigan rollar (vergul bilan)
            <input id="itemRoles" placeholder="guest,user,pro">
          </label>
        </div>
        <label>
          Tavsif (description)
          <textarea id="itemDescription"></textarea>
        </label>
        <div class="chip-actions" style="margin-top:6px;">
          <span class="pill-badge" id="itemStatus">Card tanlanmagan</span>
          <button class="btn btn-outline danger" id="deleteItemBtn">Cardni oâ€˜chirish</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ADS BOâ€˜LIMI (HTML reklamalar) -->
  <div class="card">
    <div class="card-title">
      <span>Ads (HTML reklamalar)</span>
      <button class="btn btn-outline" id="addAdBtn">+ Ad qoâ€˜shish</button>
    </div>
    <div id="adsList" class="items-list" style="max-height:260px;"></div>

    <div class="form-grid" style="margin-top:8px;">
      <label>
        Ad ID
        <input id="adId">
      </label>
      <label>
        Ad nomi (title)
        <input id="adTitle">
      </label>
      <label>
        Faol (enabled: true/false)
        <input id="adEnabled" placeholder="true yoki false">
      </label>
    </div>
    <label>
      HTML kontent
      <textarea id="adHtml" placeholder="<div>Reklama HTML...</div>"></textarea>
    </label>
    <div class="chip-actions" style="margin-top:6px;">
      <span class="pill-badge" id="adStatus">Ad tanlanmagan</span>
      <button class="btn btn-outline danger" id="deleteAdBtn">Adni oâ€˜chirish</button>
    </div>
  </div>

  <!-- FOYDALANUVCHILAR VA ROLLAR (oâ€˜zgarmagan) -->
  <div class="card">
    <div class="card-title">
      <span>Foydalanuvchilar va rollar</span>
      <button class="btn btn-outline" id="refreshUsersBtn">Roâ€˜yxatni yangilash</button>
    </div>
    <div id="usersList" class="items-list" style="max-height:260px;"></div>

    <div class="form-grid" style="margin-top:8px;">
      <label>
        User ID
        <input id="userId" readonly>
      </label>
      <label>
        Ism-familya
        <input id="userName" readonly>
      </label>
      <label>
        Email
        <input id="userEmail" readonly>
      </label>
      <label>
        Rol (guest/user/pro/admin)
        <input id="userRole" placeholder="masalan: user">
      </label>
    </div>
    <div class="chip-actions" style="margin-top:6px;">
      <span class="pill-badge" id="userStatus">Foydalanuvchi tanlanmagan</span>
      <button class="btn" id="saveUserRoleBtn">Rolni saqlash</button>
    </div>
  </div>
</main>

<script type="module">
  import {
    auth,
    provider,
    ADMIN_EMAILS,
    signInWithPopup,
    onAuthStateChanged,
    signOut,
    loadHomeConfigOnce,
    saveHomeConfig,
    listUsers,
    setUserRole
  } from './firebase.js';

  const authArea = document.getElementById('authArea');

  // chip + cards
  const chipsList = document.getElementById('chipsList');
  const chipId = document.getElementById('chipId');
  const chipLabel = document.getElementById('chipLabel');
  const chipIcon = document.getElementById('chipIcon');
  const chipRoles = document.getElementById('chipRoles');
  const chipStatus = document.getElementById('chipStatus');
  const addChipBtn = document.getElementById('addChipBtn');
  const deleteChipBtn = document.getElementById('deleteChipBtn');
  const saveAllBtn = document.getElementById('saveAllBtn');

  const cardsList = document.getElementById('cardsList');
  const addCardBtn = document.getElementById('addCardBtn');
  const itemTitle = document.getElementById('itemTitle');
  const itemBadge = document.getElementById('itemBadge');
  const itemCtaLabel = document.getElementById('itemCtaLabel');
  const itemCtaHref = document.getElementById('itemCtaHref');
  const itemRoles = document.getElementById('itemRoles');
  const itemDescription = document.getElementById('itemDescription');
  const itemStatus = document.getElementById('itemStatus');
  const deleteItemBtn = document.getElementById('deleteItemBtn');

  // ads
  const adsList = document.getElementById('adsList');
  const addAdBtn = document.getElementById('addAdBtn');
  const adIdInput = document.getElementById('adId');
  const adTitleInput = document.getElementById('adTitle');
  const adEnabledInput = document.getElementById('adEnabled');
  const adHtmlInput = document.getElementById('adHtml');
  const adStatus = document.getElementById('adStatus');
  const deleteAdBtn = document.getElementById('deleteAdBtn');

  // users
  const usersList = document.getElementById('usersList');
  const refreshUsersBtn = document.getElementById('refreshUsersBtn');
  const userIdInput = document.getElementById('userId');
  const userNameInput = document.getElementById('userName');
  const userEmailInput = document.getElementById('userEmail');
  const userRoleInput = document.getElementById('userRole');
  const userStatus = document.getElementById('userStatus');
  const saveUserRoleBtn = document.getElementById('saveUserRoleBtn');

  let state = { chips: [], ads: [] };
  let selectedChipIndex = -1;
  let selectedCardIndex = -1;

  let usersState = [];
  let selectedUserIndex = -1;

  let selectedAdIndex = -1;

  // ---------- AUTH ----------
  function renderAuth(user) {
    authArea.innerHTML = '';
    if (!user) {
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = 'Google bilan kirish';
      btn.onclick = async () => {
        try {
          await signInWithPopup(auth, provider);
        } catch (e) {
          alert('Kirishda xatolik: ' + e.message);
          console.error(e);
        }
      };
      authArea.appendChild(btn);
      return;
    }
    const isAdmin = ADMIN_EMAILS.includes(user.email);
    if (!isAdmin) {
      authArea.innerHTML = '<span class="muted" style="font-size:12px;">Admin ruxsati yoâ€˜q</span>';
      alert('Bu sahifa faqat adminlar uchun.');
      return;
    }

    const chip = document.createElement('div');
    chip.className = 'user-chip';
    chip.innerHTML = `
      <div class="avatar">${(user.displayName || user.email || '?')[0]?.toUpperCase()}</div>
      <div class="user-meta">
        <span>${user.displayName || 'Admin'}</span>
        <span>${user.email}</span>
      </div>
    `;
    chip.onclick = async () => {
      await signOut(auth);
    };
    authArea.appendChild(chip);
  }

  onAuthStateChanged(auth, async (user) => {
    renderAuth(user);
    if (user && ADMIN_EMAILS.includes(user.email)) {
      await loadConfig();
      await loadUsers();
    } else {
      state = { chips: [], ads: [] };
      renderChips();
      renderCards();
      renderAds();
      usersState = [];
      renderUsers();
    }
  });

  // ---------- CONFIG STATE ----------
  async function loadConfig() {
    try {
      const cfg = await loadHomeConfigOnce();
      state.chips = cfg.chips || [];
      state.ads = cfg.ads || [];
      selectedChipIndex = state.chips.length ? 0 : -1;
      selectedCardIndex = -1;
      selectedAdIndex = -1;
      renderChips();
      renderSelectedChip();
      renderAds();
    } catch (e) {
      console.error(e);
      alert('Configni oâ€˜qishda xatolik.');
    }
  }

  function renderChips() {
    chipsList.innerHTML = '';
    if (!state.chips.length) {
      chipsList.innerHTML = '<div class="muted" style="font-size:12px;padding:6px 4px;">Hali birorta chip qoâ€˜shilmagan.</div>';
      return;
    }
    state.chips.forEach((chip, idx) => {
      const div = document.createElement('div');
      div.className = 'chip-row' + (idx === selectedChipIndex ? ' active' : '');
      div.onclick = () => {
        selectedChipIndex = idx;
        selectedCardIndex = -1;
        renderChips();
        renderSelectedChip();
      };
      div.innerHTML = `
        <div style="display:flex;align-items:center;gap:6px;">
          <span class="icon">${chip.icon || 'â¬¡'}</span>
          <div style="display:flex;flex-direction:column;">
            <span>${chip.label || chip.id || 'No-name chip'}</span>
            <small>${chip.id || ''}</small>
          </div>
        </div>
        <div class="pill-badge" style="font-size:10px;">${(chip.visibleRoles || []).join(', ') || 'barcha'}</div>
      `;
      chipsList.appendChild(div);
    });
  }

  function renderSelectedChip() {
    if (selectedChipIndex < 0 || !state.chips[selectedChipIndex]) {
      chipId.value = '';
      chipLabel.value = '';
      chipIcon.value = '';
      chipRoles.value = '';
      chipStatus.textContent = 'Chip tanlanmagan';
      cardsList.innerHTML = '';
      return;
    }
    const c = state.chips[selectedChipIndex];
    chipId.value = c.id || '';
    chipLabel.value = c.label || '';
    chipIcon.value = c.icon || '';
    chipRoles.value = (c.visibleRoles || []).join(',');
    chipStatus.textContent = `Chip: ${c.id || 'â€”'} â€” ${c.label || ''}`;
    renderCards();
  }

  function renderCards() {
    cardsList.innerHTML = '';
    if (selectedChipIndex < 0 || !state.chips[selectedChipIndex]) {
      cardsList.innerHTML = '<div class="muted" style="font-size:11px;padding:4px;">Chip tanlanmagan.</div>';
      return;
    }
    const chip = state.chips[selectedChipIndex];
    chip.cards = chip.cards || [];
    if (!chip.cards.length) {
      cardsList.innerHTML = '<div class="muted" style="font-size:11px;padding:4px;">Hali cardlar yoâ€˜q.</div>';
      return;
    }
    chip.cards.forEach((card, idx) => {
      const div = document.createElement('div');
      const active = idx === selectedCardIndex;
      div.className = 'item-row' + (active ? ' active' : '');
      div.onclick = () => {
        selectedCardIndex = idx;
        fillCardForm();
        renderCards();
      };
      div.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:2px;">
          <span style="font-weight:600;">${card.title || '(sarlavha yoâ€˜q)'}</span>
          <span class="muted" style="font-size:11px;">${(card.visibleRoles || []).join(', ') || 'barcha'} â€¢ ${card.ctaLabel || ''}</span>
        </div>
      `;
      cardsList.appendChild(div);
    });
  }

  function fillCardForm() {
    if (selectedChipIndex < 0 || selectedCardIndex < 0) {
      itemTitle.value = '';
      itemBadge.value = '';
      itemCtaLabel.value = '';
      itemCtaHref.value = '';
      itemRoles.value = '';
      itemDescription.value = '';
      itemStatus.textContent = 'Card tanlanmagan';
      return;
    }
    const card = state.chips[selectedChipIndex].cards[selectedCardIndex];
    itemTitle.value = card.title || '';
    itemBadge.value = card.badge || '';
    itemCtaLabel.value = card.ctaLabel || '';
    itemCtaHref.value = card.ctaHref || '';
    itemRoles.value = (card.visibleRoles || []).join(',');
    itemDescription.value = card.description || '';
    itemStatus.textContent = `Card #${selectedCardIndex + 1}`;
  }

  function applyCardForm() {
    if (selectedChipIndex < 0 || selectedCardIndex < 0) return;
    const card = state.chips[selectedChipIndex].cards[selectedCardIndex];
    card.title = itemTitle.value.trim();
    card.badge = itemBadge.value.trim();
    card.ctaLabel = itemCtaLabel.value.trim();
    card.ctaHref = itemCtaHref.value.trim();
    card.visibleRoles = itemRoles.value.split(',').map(x => x.trim()).filter(Boolean);
    card.description = itemDescription.value.trim();
    renderCards();
  }

  // input listenerlar
  [itemTitle, itemBadge, itemCtaLabel, itemCtaHref, itemRoles, itemDescription].forEach(el=>{
    el.addEventListener('input', applyCardForm);
  });

  // chip inputs
  chipId.oninput = () => {
    if (selectedChipIndex < 0) return;
    state.chips[selectedChipIndex].id = chipId.value.trim();
    chipStatus.textContent = `Chip: ${chipId.value.trim() || 'â€”'}`;
    renderChips();
  };
  chipLabel.oninput = () => {
    if (selectedChipIndex < 0) return;
    state.chips[selectedChipIndex].label = chipLabel.value;
    renderChips();
  };
  chipIcon.oninput = () => {
    if (selectedChipIndex < 0) return;
    state.chips[selectedChipIndex].icon = chipIcon.value;
    renderChips();
  };
  chipRoles.oninput = () => {
    if (selectedChipIndex < 0) return;
    state.chips[selectedChipIndex].visibleRoles =
      chipRoles.value.split(',').map(x => x.trim()).filter(Boolean);
    renderChips();
  };

  // chip tugmalari
  addChipBtn.onclick = () => {
    const newChip = {
      id: 'chip-' + Date.now(),
      label: 'Yangi chip',
      icon: 'â¬¡',
      visibleRoles: ['guest','user','pro'],
      cards: []
    };
    state.chips.push(newChip);
    selectedChipIndex = state.chips.length - 1;
    selectedCardIndex = -1;
    renderChips();
    renderSelectedChip();
  };

  deleteChipBtn.onclick = () => {
    if (selectedChipIndex < 0) return alert('Chip tanlanmagan.');
    const chip = state.chips[selectedChipIndex];
    if (!confirm(`Chip "${chip.label || chip.id}" oâ€˜chirilsinmi?`)) return;
    state.chips.splice(selectedChipIndex, 1);
    selectedChipIndex = state.chips.length ? 0 : -1;
    selectedCardIndex = -1;
    renderChips();
    renderSelectedChip();
  };

  // card tugmalari
  addCardBtn.onclick = () => {
    if (selectedChipIndex < 0) return alert('Avval chip tanlang.');
    const chip = state.chips[selectedChipIndex];
    chip.cards = chip.cards || [];
    chip.cards.push({
      id: 'c-' + Date.now(),
      title: 'Yangi card',
      badge: '',
      description: '',
      ctaLabel: 'Boshlash',
      ctaHref: '#',
      visibleRoles: ['guest','user','pro']
    });
    selectedCardIndex = chip.cards.length - 1;
    renderCards();
    fillCardForm();
  };

  deleteItemBtn.onclick = () => {
    if (selectedChipIndex < 0 || selectedCardIndex < 0) {
      return alert('Card tanlanmagan.');
    }
    const chip = state.chips[selectedChipIndex];
    if (!confirm('Cardni oâ€˜chirishni tasdiqlaysizmi?')) return;
    chip.cards.splice(selectedCardIndex, 1);
    selectedCardIndex = chip.cards.length ? 0 : -1;
    renderCards();
    fillCardForm();
  };

  // BARCHA configni saqlash
  saveAllBtn.onclick = async () => {
    try {
      await saveHomeConfig(state);
      alert('Saqlash muvaffaqiyatli!');
    } catch (e) {
      console.error(e);
      alert('Saqlashda xatolik.');
    }
  };

  // ---------- ADS (HTML reklamalar) ----------
  function renderAds() {
    adsList.innerHTML = '';
    if (!state.ads || !state.ads.length) {
      adsList.innerHTML = '<div class="muted" style="font-size:11px;padding:4px;">Hali ads yoâ€˜q.</div>';
      return;
    }
    state.ads.forEach((ad, idx) => {
      const div = document.createElement('div');
      const active = idx === selectedAdIndex;
      div.className = 'item-row' + (active ? ' active' : '');
      div.onclick = () => {
        selectedAdIndex = idx;
        fillAdForm();
        renderAds();
      };
      const enabled = (ad.enabled !== false);
      div.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:2px;">
          <span style="font-weight:600;">${ad.title || ad.id || 'No-name ad'}</span>
          <span class="muted" style="font-size:11px;">ID: ${ad.id || '(yoâ€˜q)'} â€¢ ${enabled ? 'faol' : 'oâ€˜chirilgan'}</span>
        </div>
      `;
      adsList.appendChild(div);
    });
  }

  function fillAdForm() {
    if (selectedAdIndex < 0 || !state.ads[selectedAdIndex]) {
      adIdInput.value = '';
      adTitleInput.value = '';
      adEnabledInput.value = '';
      adHtmlInput.value = '';
      adStatus.textContent = 'Ad tanlanmagan';
      return;
    }
    const ad = state.ads[selectedAdIndex];
    adIdInput.value = ad.id || '';
    adTitleInput.value = ad.title || '';
    adEnabledInput.value = (ad.enabled !== false) ? 'true' : 'false';
    adHtmlInput.value = ad.html || '';
    adStatus.textContent = `Ad: ${ad.id || 'â€”'}`;
  }

  function applyAdForm() {
    if (selectedAdIndex < 0 || !state.ads[selectedAdIndex]) return;
    const ad = state.ads[selectedAdIndex];
    ad.id = adIdInput.value.trim() || ('ad-' + Date.now());
    ad.title = adTitleInput.value.trim();
    const enabledStr = (adEnabledInput.value || '').trim().toLowerCase();
    ad.enabled = enabledStr === '' ? true : (enabledStr === 'true');
    ad.html = adHtmlInput.value;
    renderAds();
  }

  [adIdInput, adTitleInput, adEnabledInput, adHtmlInput].forEach(el=>{
    el.addEventListener('input', applyAdForm);
  });

  addAdBtn.onclick = () => {
    state.ads = state.ads || [];
    state.ads.push({
      id: 'ad-' + Date.now(),
      title: 'Yangi ad',
      html: '<div style="padding:16px;text-align:center;">Yangi reklama HTML</div>',
      enabled: true
    });
    selectedAdIndex = state.ads.length - 1;
    renderAds();
    fillAdForm();
  };

  deleteAdBtn.onclick = () => {
    if (selectedAdIndex < 0 || !state.ads[selectedAdIndex]) {
      return alert('Ad tanlanmagan.');
    }
    if (!confirm('Adni oâ€˜chirishni tasdiqlaysizmi?')) return;
    state.ads.splice(selectedAdIndex, 1);
    selectedAdIndex = state.ads.length ? 0 : -1;
    renderAds();
    fillAdForm();
  };

  // ---------- USERS + ROLLAR ----------
  async function loadUsers() {
    try {
      usersState = await listUsers(200);
      renderUsers();
    } catch (e) {
      console.error(e);
      alert('Foydalanuvchilarni oâ€˜qishda xatolik.');
    }
  }

  function renderUsers() {
    usersList.innerHTML = '';
    if (!usersState.length) {
      usersList.innerHTML = '<div class="muted" style="font-size:11px;padding:4px;">Hali users kolleksiyasida foydalanuvchi yoâ€˜q.</div>';
      return;
    }
    usersState.forEach((u, idx) => {
      const div = document.createElement('div');
      const active = idx === selectedUserIndex;
      div.className = 'item-row' + (active ? ' active' : '');
      div.onclick = () => {
        selectedUserIndex = idx;
        fillUserForm();
        renderUsers();
      };
      const role = (u.role || 'user');
      div.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:2px;">
          <span style="font-weight:600;">${u.displayName || u.email || '(No name)'}</span>
          <span class="muted" style="font-size:11px;">${u.email || ''}</span>
        </div>
        <div class="item-actions">
          <span class="pill-badge" style="font-size:10px;">${role}</span>
        </div>
      `;
      usersList.appendChild(div);
    });
  }

  function fillUserForm() {
    if (selectedUserIndex < 0 || !usersState[selectedUserIndex]) {
      userIdInput.value = '';
      userNameInput.value = '';
      userEmailInput.value = '';
      userRoleInput.value = '';
      userStatus.textContent = 'Foydalanuvchi tanlanmagan';
      return;
    }
    const u = usersState[selectedUserIndex];
    userIdInput.value = u.id;
    userNameInput.value = u.displayName || '';
    userEmailInput.value = u.email || '';
    userRoleInput.value = u.role || 'user';
    userStatus.textContent = `Tanlangan: ${u.email || u.id}`;
  }

  refreshUsersBtn.onclick = () => {
    loadUsers();
  };

  saveUserRoleBtn.onclick = async () => {
    if (selectedUserIndex < 0 || !usersState[selectedUserIndex]) {
      return alert('Foydalanuvchini tanlang.');
    }
    const newRole = (userRoleInput.value || '').trim().toLowerCase();
    if (!newRole) return alert('Rolni kiriting (guest/user/pro/admin).');
    if (!['guest','user','pro','admin'].includes(newRole)) {
      return alert('Rol faqat: guest, user, pro, admin boâ€˜lishi mumkin.');
    }
    const u = usersState[selectedUserIndex];
    try {
      await setUserRole(u.id, newRole);
      usersState[selectedUserIndex].role = newRole;
      renderUsers();
      fillUserForm();
      userStatus.textContent = `Rol saqlandi: ${newRole}`;
    } catch (e) {
      console.error(e);
      alert('Rolni saqlashda xatolik.');
    }
  };
</script>
</body>
</html>
