<!doctype html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Admin â€” Chip, Banner, Card Boshqaruvi</title>
  <meta name="theme-color" content="#2E8B57"/>

  <style>
    :root{
      --brand:#2E8B57; --brand-dark:#1F6B45;
      --bg:#F4F8F6; --card:#FFFFFF;
      --line:#DFE7E2; --muted:#5A7464;
      --radius:14px; --radius-lg:18px; --pill:999px;
      --shadow:0 18px 50px rgba(16,40,26,.16);
      --shadow-sm:0 10px 28px rgba(16,40,26,.10);
      --speed:.2s;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#E8F3EB 0,#F4F8F6 40%,#F8FBF9 100%);
      color:#0F1B15;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter:blur(16px);
      background:linear-gradient(120deg,rgba(244,248,246,.96),rgba(233,244,238,.9));
      border-bottom:1px solid rgba(223,231,226,.9);
    }
    .row{
      max-width:1180px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 16px;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:8px;
      font-weight:800; letter-spacing:.03em;
      text-transform:uppercase; font-size:14px;
      color:var(--brand);
    }
    .brand-pill{
      padding:4px 10px;
      border-radius:999px;
      background:rgba(46,139,87,.08);
      border:1px solid rgba(46,139,87,.18);
      font-size:11px; font-weight:600;
      color:var(--muted);
    }
    .user-chip{
      display:flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.9);
      border:1px solid rgba(223,231,226,.9);
      box-shadow:var(--shadow-sm);
      cursor:pointer;
      font-size:13px;
      transition:transform var(--speed),box-shadow var(--speed),background var(--speed);
    }
    .user-chip:hover{
      transform:translateY(-1px);
      box-shadow:0 14px 40px rgba(16,40,26,.2);
      background:#FFFFFF;
    }
    .avatar{
      width:28px; height:28px;
      border-radius:50%; background:linear-gradient(135deg,#2E8B57,#6B8E23);
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-size:15px; font-weight:700;
    }
    .user-meta{
      display:flex; flex-direction:column; line-height:1.1;
    }
    .user-meta span:first-child{
      font-weight:600; font-size:13px;
    }
    .user-meta span:last-child{
      font-size:11px; color:var(--muted);
    }
    .btn{
      border:0; outline:0; cursor:pointer;
      border-radius:999px;
      padding:6px 14px;
      font-size:13px; font-weight:600;
      display:inline-flex; align-items:center; gap:6px;
      transition:background var(--speed),transform var(--speed),box-shadow var(--speed);
      background:var(--brand); color:#fff;
      box-shadow:0 10px 30px rgba(46,139,87,.35);
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 16px 40px rgba(46,139,87,.45);
    }
    .btn-outline{
      background:transparent;
      color:var(--brand);
      border:1px solid rgba(46,139,87,.5);
      box-shadow:none;
    }
    main{
      max-width:1180px; margin:12px auto 24px;
      padding:0 16px 24px;
      display:grid; gap:16px;
    }
    .grid{
      display:grid; grid-template-columns:280px minmax(0,1fr);
      gap:14px;
    }
    .card{
      background:radial-gradient(circle at top left,rgba(255,255,255,.95),rgba(249,253,250,.98));
      border-radius:var(--radius-lg);
      border:1px solid rgba(223,231,226,.9);
      box-shadow:var(--shadow);
      padding:14px 14px 10px;
    }
    .card-title{
      font-size:13px; font-weight:700;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      margin-bottom:8px;
      display:flex; align-items:center; justify-content:space-between;
      gap:8px;
    }
    .chips-list{
      display:flex; flex-direction:column; gap:6px;
      max-height:360px; overflow:auto;
      padding-right:2px;
    }
    .chip-row{
      border-radius:var(--radius);
      padding:7px 9px;
      display:flex; align-items:center; justify-content:space-between;
      gap:8px;
      cursor:pointer;
      background:rgba(255,255,255,.9);
      border:1px solid rgba(223,231,226,.9);
      transition:background var(--speed),transform var(--speed),box-shadow var(--speed),border-color var(--speed);
      font-size:13px;
    }
    .chip-row:hover{
      transform:translateY(-1px);
      box-shadow:var(--shadow-sm);
    }
    .chip-row.active{
      background:linear-gradient(120deg,#2E8B57,#6B8E23);
      color:#fff;
      border-color:transparent;
      box-shadow:0 12px 32px rgba(46,139,87,.55);
    }
    .chip-row span.icon{
      font-size:16px;
    }
    .chip-row small{
      font-size:11px; opacity:.75;
    }
    .chip-actions{
      display:flex; flex-wrap:wrap; gap:6px;
      margin-top:6px;
    }
    .pill-badge{
      border-radius:999px;
      padding:2px 8px;
      font-size:11px;
      background:rgba(46,139,87,.08);
      color:var(--muted);
      border:1px solid rgba(46,139,87,.12);
    }
    .form-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
      gap:8px;
      margin-bottom:8px;
    }
    label{
      display:flex; flex-direction:column; gap:3px;
      font-size:11px; text-transform:uppercase;
      letter-spacing:.06em; color:var(--muted);
    }
    input, textarea{
      border-radius:10px;
      border:1px solid rgba(212,222,217,.9);
      padding:7px 9px;
      font:inherit;
      font-size:13px;
      background:rgba(255,255,255,.96);
      outline:none;
      transition:border-color var(--speed),box-shadow var(--speed),background var(--speed);
    }
    input:focus, textarea:focus{
      border-color:rgba(46,139,87,.7);
      box-shadow:0 0 0 1px rgba(46,139,87,.18);
      background:#fff;
    }
    textarea{min-height:60px;resize:vertical;}
    .section-row{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1.3fr);
      gap:10px;
      margin-top:6px;
    }
    .items-list{
      max-height:230px; overflow:auto;
      border-radius:var(--radius);
      border:1px solid rgba(223,231,226,.9);
      background:rgba(255,255,255,.96);
      padding:4px;
      display:flex; flex-direction:column; gap:4px;
    }
    .item-row{
      border-radius:10px;
      padding:6px 8px;
      display:flex; justify-content:space-between; align-items:center;
      font-size:12px;
      cursor:pointer;
      transition:background var(--speed),transform var(--speed),box-shadow var(--speed);
    }
    .item-row:hover{
      background:rgba(239,246,242,1);
      transform:translateY(-1px);
      box-shadow:var(--shadow-sm);
    }
    .item-row.active{
      background:linear-gradient(120deg,#2E8B57,#6B8E23);
      color:#fff;
      box-shadow:0 12px 32px rgba(46,139,87,.55);
    }
    .item-actions{
      display:flex; gap:4px;
    }
    .ghost{
      opacity:.35; pointer-events:none;
    }
    .danger{
      color:#b32630;
    }
    .muted{
      color:var(--muted);
    }
    @media(max-width:820px){
      .grid{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
<header>
  <div class="row">
    <div class="brand">
      <span>LeaderMath Admin</span>
      <span class="brand-pill">Chip â€¢ Banner â€¢ Card</span>
    </div>
    <div id="authArea">
      <!-- JS bilan toâ€˜ldiriladi -->
    </div>
  </div>
</header>

<main>
  <div class="card">
    <div class="card-title">
      <span>Chiplar roâ€˜yxati</span>
      <button class="btn btn-outline" id="addChipBtn">+ Chip qoâ€˜shish</button>
    </div>
    <div class="chips-list" id="chipsList"></div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="card-title">
        <span>Tanlangan chip â€” asosiy maâ€™lumotlar</span>
      </div>
      <div id="chipForm" class="form-grid">
        <label>
          Chip ID (unikal)
          <input id="chipId" placeholder="masalan: math-basic">
        </label>
        <label>
          Chip nomi (label)
          <input id="chipLabel" placeholder="masalan: Matematika">
        </label>
        <label>
          Icon (emoji)
          <input id="chipIcon" placeholder="ðŸ“">
        </label>
        <label>
          Koâ€˜rinadigan rollar (vergul bilan)
          <input id="chipRoles" placeholder="guest,user,pro">
        </label>
      </div>
      <div class="chip-actions">
        <span class="pill-badge" id="chipStatus">Chip tanlanmagan</span>
        <button class="btn btn-outline" id="deleteChipBtn">Chipni oâ€˜chirish</button>
        <button class="btn" id="saveAllBtn">BARCHA Oâ€˜ZGARISHLARNI SAQLASH</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">
        <span>Bannerlar va cardlar</span>
      </div>

      <div class="section-row">
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
            <span class="muted" style="font-size:11px;text-transform:uppercase;letter-spacing:.06em;">Bannerlar</span>
            <button class="btn btn-outline" id="addBannerBtn" style="padding:4px 10px;font-size:11px;">+ Banner</button>
          </div>
          <div id="bannersList" class="items-list"></div>
        </div>
        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
            <span class="muted" style="font-size:11px;text-transform:uppercase;letter-spacing:.06em;">Cardlar</span>
            <button class="btn btn-outline" id="addCardBtn" style="padding:4px 10px;font-size:11px;">+ Card</button>
          </div>
          <div id="cardsList" class="items-list"></div>
        </div>
      </div>

      <div style="margin-top:10px;">
        <div class="form-grid">
          <label>
            Element turi
            <input id="itemType" readonly placeholder="banner / card">
          </label>
          <label>
            Sarlavha (title)
            <input id="itemTitle">
          </label>
          <label>
            Tagline (banner uchun)
            <input id="itemTagline" placeholder="ixtiyoriy">
          </label>
          <label>
            Badge (card uchun)
            <input id="itemBadge" placeholder="Yangi, Pro, Chegirma...">
          </label>
          <label>
            CTAlabel
            <input id="itemCtaLabel" placeholder="Boshlash, Koâ€˜rish...">
          </label>
          <label>
            CTA havola (url)
            <input id="itemCtaHref" placeholder="https://...">
          </label>
          <label>
            Rasm manzili (banner)
            <input id="itemImageUrl" placeholder="https://...">
          </label>
          <label>
            Koâ€˜rinadigan rollar (vergul bilan)
            <input id="itemRoles" placeholder="guest,user,pro">
          </label>
        </div>
        <label>
          Tavsif (description â€“ card / qoâ€˜shimcha matn)
          <textarea id="itemDescription"></textarea>
        </label>
        <div class="chip-actions" style="margin-top:6px;">
          <span class="pill-badge" id="itemStatus">Element tanlanmagan</span>
          <button class="btn btn-outline danger" id="deleteItemBtn">Elementni oâ€˜chirish</button>
        </div>
      </div>
    </div>
  </div>
</main>

<script type="module">
  import {
    auth,
    provider,
    ADMIN_EMAILS,
    signInWithPopup,
    onAuthStateChanged,
    signOut,
    loadHomeConfigOnce,
    saveHomeConfig
  } from './firebase.js';

  const authArea = document.getElementById('authArea');
  const chipsList = document.getElementById('chipsList');
  const chipId = document.getElementById('chipId');
  const chipLabel = document.getElementById('chipLabel');
  const chipIcon = document.getElementById('chipIcon');
  const chipRoles = document.getElementById('chipRoles');
  const chipStatus = document.getElementById('chipStatus');
  const addChipBtn = document.getElementById('addChipBtn');
  const deleteChipBtn = document.getElementById('deleteChipBtn');
  const saveAllBtn = document.getElementById('saveAllBtn');

  const bannersList = document.getElementById('bannersList');
  const cardsList = document.getElementById('cardsList');
  const addBannerBtn = document.getElementById('addBannerBtn');
  const addCardBtn = document.getElementById('addCardBtn');

  const itemType = document.getElementById('itemType');
  const itemTitle = document.getElementById('itemTitle');
  const itemTagline = document.getElementById('itemTagline');
  const itemBadge = document.getElementById('itemBadge');
  const itemCtaLabel = document.getElementById('itemCtaLabel');
  const itemCtaHref = document.getElementById('itemCtaHref');
  const itemImageUrl = document.getElementById('itemImageUrl');
  const itemRoles = document.getElementById('itemRoles');
  const itemDescription = document.getElementById('itemDescription');
  const itemStatus = document.getElementById('itemStatus');
  const deleteItemBtn = document.getElementById('deleteItemBtn');

  let state = { chips: [] };
  let selectedChipIndex = -1;
  let selectedItem = { type: null, index: -1 };

  // ---------- AUTH ----------
  function renderAuth(user) {
    authArea.innerHTML = '';
    if (!user) {
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = 'Google bilan kirish';
      btn.onclick = async () => {
        try {
          await signInWithPopup(auth, provider);
        } catch (e) {
          alert('Kirishda xatolik: ' + e.message);
          console.error(e);
        }
      };
      authArea.appendChild(btn);
      return;
    }
    const isAdmin = ADMIN_EMAILS.includes(user.email);
    if (!isAdmin) {
      authArea.innerHTML = '<span class="muted" style="font-size:12px;">Ruxsat yoâ€˜q</span>';
      alert('Bu sahifa faqat adminlar uchun.');
      return;
    }

    const chip = document.createElement('div');
    chip.className = 'user-chip';
    chip.innerHTML = `
      <div class="avatar">${(user.displayName || user.email || '?')[0]?.toUpperCase()}</div>
      <div class="user-meta">
        <span>${user.displayName || 'Admin'}</span>
        <span>${user.email}</span>
      </div>
    `;
    chip.onclick = async () => {
      await signOut(auth);
    };
    authArea.appendChild(chip);
  }

  onAuthStateChanged(auth, async (user) => {
    renderAuth(user);
    if (user && ADMIN_EMAILS.includes(user.email)) {
      await loadConfig();
    } else {
      state = { chips: [] };
      renderChips();
      clearChipForm();
      clearItemForm();
    }
  });

  // ---------- STATE HELPERS ----------
  async function loadConfig() {
    try {
      state = await loadHomeConfigOnce();
      if (!state.chips) state.chips = [];
      selectedChipIndex = state.chips.length ? 0 : -1;
      selectedItem = { type: null, index: -1 };
      renderChips();
      renderSelectedChip();
    } catch (e) {
      console.error(e);
      alert('Configni oâ€˜qishda xatolik.');
    }
  }

  function renderChips() {
    chipsList.innerHTML = '';
    if (!state.chips.length) {
      chipsList.innerHTML = '<div class="muted" style="font-size:12px;padding:6px 4px;">Hali birorta chip qoâ€˜shilmagan.</div>';
      return;
    }
    state.chips.forEach((chip, idx) => {
      const div = document.createElement('div');
      div.className = 'chip-row' + (idx === selectedChipIndex ? ' active' : '');
      div.onclick = () => {
        selectedChipIndex = idx;
        selectedItem = { type: null, index: -1 };
        renderChips();
        renderSelectedChip();
      };
      div.innerHTML = `
        <div style="display:flex;align-items:center;gap:6px;">
          <span class="icon">${chip.icon || 'â¬¡'}</span>
          <div style="display:flex;flex-direction:column;">
            <span>${chip.label || chip.id || 'No-name chip'}</span>
            <small>${chip.id || ''}</small>
          </div>
        </div>
        <div class="pill-badge" style="font-size:10px;">${(chip.visibleRoles || []).join(', ') || 'barcha'}</div>
      `;
      chipsList.appendChild(div);
    });
  }

  function renderSelectedChip() {
    if (selectedChipIndex < 0 || !state.chips[selectedChipIndex]) {
      clearChipForm();
      bannersList.innerHTML = '';
      cardsList.innerHTML = '';
      chipStatus.textContent = 'Chip tanlanmagan';
      return;
    }
    const c = state.chips[selectedChipIndex];
    chipId.value = c.id || '';
    chipLabel.value = c.label || '';
    chipIcon.value = c.icon || '';
    chipRoles.value = (c.visibleRoles || []).join(',');
    chipStatus.textContent = `Chip: ${c.id || 'â€”'} â€” ${c.label || ''}`;

    renderItems('banner');
    renderItems('card');
    clearItemForm();
  }

  function clearChipForm() {
    chipId.value = '';
    chipLabel.value = '';
    chipIcon.value = '';
    chipRoles.value = '';
  }

  function renderItems(type) {
    const chip = state.chips[selectedChipIndex];
    const list = type === 'banner' ? bannersList : cardsList;
    const data = type === 'banner' ? (chip.banners || []) : (chip.cards || []);

    list.innerHTML = '';
    if (!data.length) {
      list.innerHTML = '<div class="muted" style="font-size:11px;padding:4px;">Elementlar yoâ€˜q.</div>';
      return;
    }
    data.forEach((item, idx) => {
      const div = document.createElement('div');
      const active = selectedItem.type === type && selectedItem.index === idx;
      div.className = 'item-row' + (active ? ' active' : '');
      div.onclick = () => {
        selectedItem = { type, index: idx };
        fillItemForm(type, idx);
        renderItems('banner');
        renderItems('card');
      };
      div.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:2px;">
          <span style="font-weight:600;">${item.title || '(sarlavha yoâ€˜q)'}</span>
          <span class="muted" style="font-size:11px;">${(item.visibleRoles || []).join(', ') || 'barcha'} â€¢ ${item.ctaLabel || ''}</span>
        </div>
        <div class="item-actions">
          <span class="pill-badge" style="font-size:10px;">${type}</span>
        </div>
      `;
      list.appendChild(div);
    });
  }

  function clearItemForm() {
    selectedItem = { type: null, index: -1 };
    itemType.value = '';
    itemTitle.value = '';
    itemTagline.value = '';
    itemBadge.value = '';
    itemCtaLabel.value = '';
    itemCtaHref.value = '';
    itemImageUrl.value = '';
    itemRoles.value = '';
    itemDescription.value = '';
    itemStatus.textContent = 'Element tanlanmagan';
  }

  function fillItemForm(type, idx) {
    const chip = state.chips[selectedChipIndex];
    const data = type === 'banner' ? (chip.banners || []) : (chip.cards || []);
    const it = data[idx];
    itemType.value = type;
    itemTitle.value = it.title || '';
    itemTagline.value = it.tagline || '';
    itemBadge.value = it.badge || '';
    itemCtaLabel.value = it.ctaLabel || '';
    itemCtaHref.value = it.ctaHref || '';
    itemImageUrl.value = it.imageUrl || '';
    itemRoles.value = (it.visibleRoles || []).join(',');
    itemDescription.value = it.description || '';
    itemStatus.textContent = `${type.toUpperCase()} #${idx + 1}`;
  }

  // ---------- CHIP ACTIONS ----------
  addChipBtn.onclick = () => {
    const newChip = {
      id: 'chip-' + Date.now(),
      label: 'Yangi chip',
      icon: 'â¬¡',
      visibleRoles: ['guest','user','pro'],
      banners: [],
      cards: []
    };
    state.chips.push(newChip);
    selectedChipIndex = state.chips.length - 1;
    renderChips();
    renderSelectedChip();
  };

  deleteChipBtn.onclick = () => {
    if (selectedChipIndex < 0) return alert('Chip tanlanmagan.');
    const chip = state.chips[selectedChipIndex];
    if (!confirm(`Chip "${chip.label || chip.id}" oâ€˜chirilsinmi?`)) return;
    state.chips.splice(selectedChipIndex, 1);
    selectedChipIndex = state.chips.length ? 0 : -1;
    selectedItem = { type: null, index: -1 };
    renderChips();
    renderSelectedChip();
    clearItemForm();
  };

  chipId.oninput = () => {
    if (selectedChipIndex < 0) return;
    state.chips[selectedChipIndex].id = chipId.value.trim();
    chipStatus.textContent = `Chip: ${chipId.value.trim() || 'â€”'}`;
    renderChips();
  };
  chipLabel.oninput = () => {
    if (selectedChipIndex < 0) return;
    state.chips[selectedChipIndex].label = chipLabel.value;
    renderChips();
  };
  chipIcon.oninput = () => {
    if (selectedChipIndex < 0) return;
    state.chips[selectedChipIndex].icon = chipIcon.value;
    renderChips();
  };
  chipRoles.oninput = () => {
    if (selectedChipIndex < 0) return;
    state.chips[selectedChipIndex].visibleRoles =
      chipRoles.value.split(',').map(x => x.trim()).filter(Boolean);
    renderChips();
  };

  saveAllBtn.onclick = async () => {
    try {
      await saveHomeConfig(state);
      alert('Saqlash muvaffaqiyatli!');
    } catch (e) {
      console.error(e);
      alert('Saqlashda xatolik.');
    }
  };

  // ---------- ITEM (BANNER/CARD) ACTIONS ----------
  addBannerBtn.onclick = () => {
    if (selectedChipIndex < 0) return alert('Avval chip tanlang.');
    const c = state.chips[selectedChipIndex];
    if (!c.banners) c.banners = [];
    c.banners.push({
      id: 'b-' + Date.now(),
      title: 'Yangi banner',
      tagline: '',
      imageUrl: '',
      ctaLabel: 'Koâ€˜rish',
      ctaHref: '#',
      visibleRoles: ['guest','user','pro'],
      description: ''
    });
    renderItems('banner');
  };

  addCardBtn.onclick = () => {
    if (selectedChipIndex < 0) return alert('Avval chip tanlang.');
    const c = state.chips[selectedChipIndex];
    if (!c.cards) c.cards = [];
    c.cards.push({
      id: 'c-' + Date.now(),
      title: 'Yangi card',
      badge: '',
      description: '',
      ctaLabel: 'Boshlash',
      ctaHref: '#',
      visibleRoles: ['guest','user','pro']
    });
    renderItems('card');
  };

  function applyItemForm() {
    if (selectedChipIndex < 0 || !selectedItem.type || selectedItem.index < 0) return;
    const chip = state.chips[selectedChipIndex];
    const list = selectedItem.type === 'banner' ? (chip.banners || []) : (chip.cards || []);
    const it = list[selectedItem.index];
    it.title = itemTitle.value.trim();
    it.tagline = itemTagline.value.trim();
    it.badge = itemBadge.value.trim();
    it.description = itemDescription.value.trim();
    it.ctaLabel = itemCtaLabel.value.trim();
    it.ctaHref = itemCtaHref.value.trim();
    it.imageUrl = itemImageUrl.value.trim();
    it.visibleRoles = itemRoles.value.split(',').map(x => x.trim()).filter(Boolean);
    if (selectedItem.type === 'banner') renderItems('banner'); else renderItems('card');
  }

  [
    itemTitle, itemTagline, itemBadge, itemCtaLabel,
    itemCtaHref, itemImageUrl, itemRoles, itemDescription
  ].forEach(el => {
    el.addEventListener('input', () => applyItemForm());
  });

  deleteItemBtn.onclick = () => {
    if (selectedChipIndex < 0 || !selectedItem.type || selectedItem.index < 0) {
      return alert('Element tanlanmagan.');
    }
    const chip = state.chips[selectedChipIndex];
    const listName = selectedItem.type === 'banner' ? 'banners' : 'cards';
    const list = chip[listName] || [];
    if (!confirm(`${selectedItem.type} elementini oâ€˜chirishni tasdiqlaysizmi?`)) return;
    list.splice(selectedItem.index, 1);
    chip[listName] = list;
    selectedItem = { type: null, index: -1 };
    renderItems('banner');
    renderItems('card');
    clearItemForm();
  };
</script>
</body>
</html>
