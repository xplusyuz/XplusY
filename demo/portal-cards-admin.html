<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
  <title>1-IMI — Bo‘limlar / Card admin</title>

  <link rel="icon" href="logo.png" sizes="192x192">
  <meta name="theme-color" content="#e0f2fe">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>

  <!-- Sizning fayllaringiz -->
  <script src="firebase-config.js"></script>
  <script src="auth-lite.js"></script>

  <style>
    :root{
      --brand:#0ea5e9;
      --bg:#e0f2fe;
      --bg-2:#f1f5f9;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --border:#e5e7eb;
      --radius-shell:22px;
      --radius-card:20px;
      --shadow:0 12px 30px rgba(15,23,42,.14);
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    html,body{min-height:100%;}
    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,#e0f2fe,#f9fafb);
      color:var(--text);
      -webkit-tap-highlight-color:transparent;
    }
    .app{
      max-width:1180px;
      margin:12px auto 24px;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    header{
      background:var(--card);
      border-radius:var(--radius-shell);
      border:1px solid #dbeafe;
      box-shadow:var(--shadow);
      padding:10px 14px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .logo-img{
      width:50px;height:50px;border-radius:50%;
      object-fit:cover;
      box-shadow:0 6px 16px rgba(15,23,42,.3);
    }
    .h-title{font-size:15px;font-weight:700;}
    .h-sub{font-size:11px;color:var(--muted);}
    .h-badge{
      margin-left:auto;
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      border:1px dashed #bfdbfe;
      background:#eff6ff;
      color:#1d4ed8;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .h-badge i{font-size:11px;}

    .layout{
      display:grid;
      grid-template-columns: minmax(0,1.3fr) minmax(0,1.1fr);
      gap:12px;
      align-items:flex-start;
    }
    @media(max-width:960px){
      .layout{
        grid-template-columns:1fr;
      }
    }

    /* LIST PANEL */
    .panel{
      background:var(--card);
      border-radius:var(--radius-shell);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:10px 10px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:calc(100vh - 120px);
    }
    .panel-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:4px;
    }
    .panel-title{
      font-size:14px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .panel-title i{color:var(--brand);}
    .panel-sub{
      font-size:11px;
      color:var(--muted);
    }
    .panel-header-right{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:flex-end;
    }

    .btn{
      border:none;
      border-radius:999px;
      padding:6px 10px;
      font-size:11px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:#eff6ff;
      color:#2563eb;
      border:1px solid #bfdbfe;
    }
    .btn i{font-size:11px;}
    .btn-primary{
      background:linear-gradient(135deg,#0ea5e9,#38bdf8);
      color:#fff;
      border:none;
      box-shadow:0 8px 18px rgba(56,189,248,.6);
    }
    .btn-danger{
      background:#fee2e2;
      color:#b91c1c;
      border:1px solid #fecaca;
    }

    .cards-scroll{
      flex:1;
      overflow:auto;
      padding-right:4px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    /* CARD PREVIEW (xuddi portal dizayni) */
    .section-label{
      font-size:11px;
      font-weight:600;
      color:#0f172a;
      margin:4px 4px 0 4px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .section-label span:last-child{
      font-size:10px;
      color:var(--muted);
      font-weight:500;
    }

    .card-grid{
      display:grid;
      gap:10px;
    }
    @media(min-width:720px){
      .card-grid{grid-template-columns:1fr 1fr;}
    }
    .card{
      background:var(--card);
      border-radius:20px;
      border:1px solid var(--border);
      box-shadow:0 6px 14px rgba(15,23,42,.08);
      overflow:hidden;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      transition:.18s;
    }
    .card:hover{
      transform:translateY(-2px);
      box-shadow:0 10px 22px rgba(15,23,42,.17);
      border-color:#bfdbfe;
    }
    .card.selected{
      box-shadow:0 0 0 2px #0ea5e9, 0 10px 24px rgba(14,165,233,.35);
      border-color:#0ea5e9;
    }
    .card-img-wrap{
      position:relative;
      padding-top:56%;
      background:#e5e7eb;
    }
    .card-img-wrap img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .card-label{
      position:absolute;
      left:10px;
      top:10px;
      padding:4px 8px;
      border-radius:999px;
      font-size:10px;
      background:rgba(15,23,42,.72);
      color:#e5e7eb;
      display:inline-flex;
      align-items:center;
      gap:5px;
    }
    .card-label i{
      font-size:10px;
      color:#38bdf8;
    }
    .card-body{
      padding:10px 11px 11px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .card-title{
      font-size:13px;
      font-weight:600;
    }
    .card-desc{
      font-size:11px;
      color:var(--muted);
    }
    .card-meta-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-top:2px;
    }
    .card-meta-left{
      font-size:10px;
      color:#9ca3af;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .dot{
      width:4px;
      height:4px;
      border-radius:999px;
      background:#0ea5e9;
    }
    .card-tag-mini{
      font-size:10px;
      padding:4px 8px;
      border-radius:999px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      color:#6b7280;
      white-space:nowrap;
    }
    .card-footer{
      margin-top:6px;
      display:flex;
      gap:8px;
    }
    .btn-card{
      border:none;
      border-radius:999px;
      padding:7px 8px;
      font-size:11px;
      font-weight:600;
      cursor:pointer;
      flex:1;
      background:linear-gradient(135deg,#0ea5e9,#38bdf8);
      color:#fff;
      box-shadow:0 8px 20px rgba(56,189,248,.5);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }

    /* EDIT PANEL (form) */
    .form{
      background:var(--card);
      border-radius:var(--radius-shell);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:10px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .form-title{
      font-size:14px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .form-title i{color:var(--brand);}
    .form-sub{
      font-size:11px;
      color:var(--muted);
    }
    .form-grid{
      display:grid;
      gap:8px;
    }
    @media(min-width:720px){
      .form-grid-2{
        grid-template-columns:1.1fr 1fr;
      }
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:3px;
      font-size:11px;
    }
    .field label{
      font-weight:600;
      color:#4b5563;
    }
    .field small{
      color:var(--muted);
      font-size:10px;
    }
    .field input,
    .field select,
    .field textarea{
      padding:7px 8px;
      border-radius:10px;
      border:1px solid #d4d4d8;
      font-size:12px;
      outline:none;
      background:#fff;
      resize:vertical;
      min-height:32px;
    }
    .field textarea{min-height:60px;}
    .field input:focus,
    .field select:focus,
    .field textarea:focus{
      border-color:#0ea5e9;
      box-shadow:0 0 0 1px #0ea5e9;
    }
    .form-footer{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:6px;
      flex-wrap:wrap;
    }
    .hint-badge{
      font-size:10px;
      padding:4px 8px;
      border-radius:999px;
      background:#ecfeff;
      border:1px dashed #67e8f9;
      color:#0e7490;
      display:inline-flex;
      align-items:center;
      gap:5px;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <img src="logo.png" class="logo-img" alt="1-IMI">
    <div>
      <div class="h-title">Namangan shahar 1-IMI — Card admin</div>
      <div class="h-sub">Bo‘limlar uchun cardlarni Firebase’dan boshqarish.</div>
    </div>
    <div class="h-badge">
      <i class="fa-solid fa-cloud"></i>
      Firestore: <strong>portal_cards</strong>
    </div>
  </header>

  <div class="layout">
    <!-- Chap: ro‘yxat + preview -->
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">
            <i class="fa-solid fa-layer-group"></i>
            Cardlar ro‘yxati
          </div>
          <div class="panel-sub">Bo‘lim va tartib raqam bo‘yicha saralanadi.</div>
        </div>
        <div class="panel-header-right">
          <button class="btn" id="btn-refresh">
            <i class="fa-solid fa-rotate"></i> Yangilash
          </button>
          <button class="btn btn-primary" id="btn-new">
            <i class="fa-solid fa-plus"></i> Yangi card
          </button>
        </div>
      </div>

      <div class="cards-scroll" id="cards-list">
        <!-- JS bilan to‘ldiriladi -->
      </div>
    </section>

    <!-- O‘ng: forma -->
    <section class="form">
      <div>
        <div class="form-title">
          <i class="fa-solid fa-pen-to-square"></i>
          Card tahrirlash
        </div>
        <div class="form-sub">
          Chapdan cardni tanlang yoki “Yangi card” bosing. Har qanday rasm URL (jpg, png, svg, emoji-URL) ishlaydi.
        </div>
      </div>

      <div class="form-grid form-grid-2">
        <div class="field">
          <label>Bo‘lim (section)</label>
          <select id="f-section">
            <option value="asosiy">Asosiy bo‘limlar</option>
            <option value="talaba">Talabalar xizmatlari</option>
            <option value="onlayn">Onlayn xizmatlar</option>
          </select>
          <small>Kartani qaysi blokda ko‘rsatish.</small>
        </div>
        <div class="field">
          <label>Tartib (order)</label>
          <input type="number" id="f-order" placeholder="10, 20, 30..." />
          <small>Pastdan yuqoriga saralash uchun raqam.</small>
        </div>
      </div>

      <div class="form-grid">
        <div class="field">
          <label>Kartaning asosiy nomi</label>
          <input type="text" id="f-title" placeholder="Talabalar ma’lumotlari">
        </div>
      </div>

      <div class="form-grid form-grid-2">
        <div class="field">
          <label>Yuqori chap badge matni</label>
          <input type="text" id="f-badgeText" placeholder="Talabalar">
          <small>Masalan: “Talabalar”, “Jadval”, “Hujjatlar”.</small>
        </div>
        <div class="field">
          <label>Yuqori chap badge ikonka (FA class)</label>
          <input type="text" id="f-badgeIcon" placeholder="fa-solid fa-user-graduate">
          <small>Font Awesome class (i ichiga yoziladi).</small>
        </div>
      </div>

      <div class="form-grid">
        <div class="field">
          <label>Qisqacha tavsif</label>
          <textarea id="f-desc" placeholder="Guruhlar, talabalar ro‘yxati va asosiy ma’lumotlar."></textarea>
        </div>
      </div>

      <div class="form-grid form-grid-2">
        <div class="field">
          <label>Meta chap matn (nuqta yonida)</label>
          <input type="text" id="f-metaLeft" placeholder="Ichki tizim (login bo‘lishi mumkin)">
        </div>
        <div class="field">
          <label>Kichik tag (o‘ngda)</label>
          <input type="text" id="f-miniTag" placeholder="Haftalik yangilanish">
        </div>
      </div>

      <div class="form-grid form-grid-2">
        <div class="field">
          <label>Tugma matni</label>
          <input type="text" id="f-btnLabel" placeholder="Ko‘rish">
        </div>
        <div class="field">
          <label>Tugma link (data-link)</label>
          <input type="text" id="f-btnUrl" placeholder="davomat/index.html">
        </div>
      </div>

      <div class="form-grid form-grid-2">
        <div class="field">
          <label>Rasm URL</label>
          <input type="text" id="f-imgUrl" placeholder="img/talabalar.jpg">
          <small>jpg/png/svg yoki emoji-generator URL ham bo‘ladi.</small>
        </div>
        <div class="field">
          <label>Rasm preview</label>
          <div class="hint-badge">
            <i class="fa-solid fa-image"></i>
            Card previewda ko‘rinadi (chap panel).
          </div>
        </div>
      </div>

      <div class="form-footer">
        <button class="btn btn-danger" id="btn-delete">
          <i class="fa-solid fa-trash"></i> O‘chirish
        </button>
        <button class="btn" id="btn-cancel">
          Bekor qilish
        </button>
        <button class="btn btn-primary" id="btn-save">
          <i class="fa-solid fa-floppy-disk"></i> Saqlash
        </button>
      </div>
    </section>
  </div>
</div>

<script>
  // ==== Firebase ====
  const db = firebase.firestore();
  const CARDS_COLL = 'portal_cards';

  // Auth: faqat login bo'lgan foydalanuvchi (xohlasangiz email bilan admin cheklasak bo'ladi)
  let currentUser = null;

  // ==== DOM ====
  const listEl      = document.getElementById('cards-list');
  const btnNew      = document.getElementById('btn-new');
  const btnRefresh  = document.getElementById('btn-refresh');
  const btnSave     = document.getElementById('btn-save');
  const btnCancel   = document.getElementById('btn-cancel');
  const btnDelete   = document.getElementById('btn-delete');

  const fSection    = document.getElementById('f-section');
  const fOrder      = document.getElementById('f-order');
  const fTitle      = document.getElementById('f-title');
  const fBadgeText  = document.getElementById('f-badgeText');
  const fBadgeIcon  = document.getElementById('f-badgeIcon');
  const fDesc       = document.getElementById('f-desc');
  const fMetaLeft   = document.getElementById('f-metaLeft');
  const fMiniTag    = document.getElementById('f-miniTag');
  const fBtnLabel   = document.getElementById('f-btnLabel');
  const fBtnUrl     = document.getElementById('f-btnUrl');
  const fImgUrl     = document.getElementById('f-imgUrl');

  let cards = [];
  let selectedId = null;
  let unsubscribe = null;

  function sectionTitle(sec){
    switch(sec){
      case 'asosiy': return 'Asosiy bo‘limlar';
      case 'talaba': return 'Talabalar xizmatlari';
      case 'onlayn': return 'Onlayn xizmatlar';
      default:       return sec || 'Boshqa';
    }
  }

  // ==== CARDLARNI RENDER QILISH ====
  function renderCards(){
    listEl.innerHTML = '';
    if (!cards.length){
      listEl.innerHTML = '<div style="font-size:12px;color:#6b7280;padding:4px;">Hozircha card yo‘q. “Yangi card” tugmasini bosing.</div>';
      return;
    }

    // section bo'yicha guruhlaymiz
    const groups = {};
    cards.forEach(c=>{
      const sec = c.section || 'asosiy';
      if (!groups[sec]) groups[sec] = [];
      groups[sec].push(c);
    });

    Object.keys(groups).sort().forEach(sec=>{
      const group = groups[sec].sort((a,b)=>(a.order||0)-(b.order||0));

      const secHeader = document.createElement('div');
      secHeader.className = 'section-label';
      secHeader.innerHTML = `
        <span>${sectionTitle(sec)}</span>
        <span>${group.length} ta card</span>
      `;
      listEl.appendChild(secHeader);

      const grid = document.createElement('div');
      grid.className = 'card-grid';

      group.forEach(card=>{
        const div = document.createElement('div');
        div.className = 'card' + (card.id === selectedId ? ' selected' : '');
        div.dataset.id = card.id;

        const imgUrl = card.imgUrl || 'img/placeholder.jpg';
        const badgeText = card.badgeText || '';
        const badgeIcon = card.badgeIcon || 'fa-solid fa-circle-info';
        const title = card.title || '(Nomlanmagan card)';
        const desc  = card.desc  || '';
        const meta  = card.metaLeft || '';
        const mini  = card.miniTag || '';
        const btn   = card.btnLabel || 'Ko‘rish';

        div.innerHTML = `
          <div class="card-img-wrap">
            <img src="${imgUrl}" loading="lazy" alt="">
            ${badgeText ? `
              <div class="card-label">
                <i class="${badgeIcon}"></i>
                ${badgeText}
              </div>` : ''}
          </div>
          <div class="card-body">
            <div class="card-title">${title}</div>
            <div class="card-desc">${desc}</div>
            <div class="card-meta-row">
              <div class="card-meta-left">
                <span class="dot"></span>
                <span>${meta}</span>
              </div>
              <span class="card-tag-mini">${mini}</span>
            </div>
            <div class="card-footer">
              <button class="btn-card" type="button">
                <i class="fa-solid fa-eye"></i>${btn}
              </button>
            </div>
          </div>
        `;
        div.addEventListener('click', ()=> selectCard(card.id));
        grid.appendChild(div);
      });

      listEl.appendChild(grid);
    });
  }

  // ==== CARD TANLASH & FORMA TO‘LDIRISH ====
  function fillForm(card){
    if (!card){
      selectedId = null;
      fSection.value   = 'asosiy';
      fOrder.value     = '';
      fTitle.value     = '';
      fBadgeText.value = '';
      fBadgeIcon.value = '';
      fDesc.value      = '';
      fMetaLeft.value  = '';
      fMiniTag.value   = '';
      fBtnLabel.value  = 'Ko‘rish';
      fBtnUrl.value    = '';
      fImgUrl.value    = '';
      return;
    }
    selectedId       = card.id;
    fSection.value   = card.section || 'asosiy';
    fOrder.value     = card.order ?? '';
    fTitle.value     = card.title || '';
    fBadgeText.value = card.badgeText || '';
    fBadgeIcon.value = card.badgeIcon || '';
    fDesc.value      = card.desc || '';
    fMetaLeft.value  = card.metaLeft || '';
    fMiniTag.value   = card.miniTag || '';
    fBtnLabel.value  = card.btnLabel || 'Ko‘rish';
    fBtnUrl.value    = card.btnUrl || '';
    fImgUrl.value    = card.imgUrl || '';
  }

  function selectCard(id){
    const card = cards.find(c=>c.id===id);
    fillForm(card);
    renderCards(); // selected class yangilash
  }

  // ==== FIRESTORE LISTENER ====
  function startListening(){
    if (unsubscribe) unsubscribe();
    unsubscribe = db.collection(CARDS_COLL)
      .orderBy('section')
      .orderBy('order')
      .onSnapshot(snap=>{
        cards = [];
        snap.forEach(doc=>{
          cards.push({ id:doc.id, ...doc.data() });
        });
        renderCards();
      }, err=>{
        console.error(err);
        alert('Firestoredan cardlarni o‘qishda xatolik: '+err.message);
      });
  }

  // ==== SAQLASH ====
  async function saveCurrent(){
    if (!currentUser){
      alert('Avval tizimga kiring.');
      return;
    }
    const data = {
      section : fSection.value || 'asosiy',
      order   : Number(fOrder.value || 0),
      title   : fTitle.value.trim(),
      badgeText: fBadgeText.value.trim(),
      badgeIcon: fBadgeIcon.value.trim(),
      desc    : fDesc.value.trim(),
      metaLeft: fMetaLeft.value.trim(),
      miniTag : fMiniTag.value.trim(),
      btnLabel: fBtnLabel.value.trim() || 'Ko‘rish',
      btnUrl  : fBtnUrl.value.trim(),
      imgUrl  : fImgUrl.value.trim(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    if (!data.title){
      alert('Kartaning nomini kiriting.');
      return;
    }

    try{
      if (selectedId){
        await db.collection(CARDS_COLL).doc(selectedId).set(data,{merge:true});
      }else{
        const docRef = await db.collection(CARDS_COLL).add({
          ...data,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        selectedId = docRef.id;
      }
      alert('Card saqlandi.');
    }catch(err){
      console.error(err);
      alert('Card saqlashda xatolik: '+err.message);
    }
  }

  // ==== O‘CHIRISH ====
  async function deleteCurrent(){
    if (!selectedId){
      alert('Avval cardni tanlang.');
      return;
    }
    if (!confirm('Bu cardni butunlay o‘chirmoqchimisiz?')) return;
    try{
      await db.collection(CARDS_COLL).doc(selectedId).delete();
      selectedId = null;
      fillForm(null);
      alert('Card o‘chirildi.');
    }catch(err){
      console.error(err);
      alert('Card o‘chirishda xatolik: '+err.message);
    }
  }

  // ==== BUTTON EVENTLAR ====
  if (btnNew){
    btnNew.addEventListener('click', ()=>{
      selectedId = null;
      fillForm({
        section:'asosiy',
        order:(cards[cards.length-1]?.order||0)+10,
        btnLabel:'Ko‘rish'
      });
      renderCards();
    });
  }
  if (btnRefresh){
    btnRefresh.addEventListener('click', ()=>{
      startListening();
    });
  }
  if (btnSave){
    btnSave.addEventListener('click', saveCurrent);
  }
  if (btnCancel){
    btnCancel.addEventListener('click', ()=>{
      const card = cards.find(c=>c.id===selectedId) || null;
      fillForm(card);
    });
  }
  if (btnDelete){
    btnDelete.addEventListener('click', deleteCurrent);
  }

  // ==== SESSION BOSHLANGANDA ====
  (async ()=>{
    try{
      const u = await authLite.requireSession(); // login bo'lmasa redirect
      currentUser = u;
      startListening();
    }catch(e){
      console.warn('Session yo‘q:', e);
    }
  })();
</script>
</body>
</html>
