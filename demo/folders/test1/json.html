<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test JSON Tahrirlagich</title>
    
    <!-- MathJax 3 -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                packages: {'[+]': ['boldsymbol', 'ams']}
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --primary-light: #818cf8;
            --secondary: #10b981;
            --secondary-dark: #059669;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --info: #3b82f6;
            --bg: #f8fafc;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --card-bg: #ffffff;
            --shadow: 0 4px 16px rgba(0,0,0,0.08);
            --radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary);
        }

        .header h1 {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 28px;
            font-weight: 700;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: calc(100vh - 150px);
        }

        /* Sidebar */
        .sidebar {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 25px;
        }

        .sidebar-section h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Main Content */
        .main-content {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .content-section {
            margin-bottom: 25px;
        }

        .content-section h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text);
            font-weight: 500;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            transition: var(--transition);
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color: var(--text);
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
            font-family: monospace;
            line-height: 1.4;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(79, 70, 229, 0.25);
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, var(--secondary-dark) 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.25);
            background: linear-gradient(135deg, var(--secondary-dark) 0%, var(--success) 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.25);
            background: linear-gradient(135deg, #dc2626 0%, var(--danger) 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
            box-shadow: 0 8px 24px rgba(108, 117, 125, 0.25);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        /* Math Editor Button */
        .math-editor-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin: 5px 0;
            transition: var(--transition);
        }

        .math-editor-btn:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.25);
        }

        /* Question List */
        .question-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .question-item {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .question-item:hover {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .question-item.active {
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
            border-left: 4px solid var(--primary);
        }

        .question-number {
            font-weight: 600;
            color: var(--primary);
            min-width: 30px;
        }

        .question-preview {
            flex: 1;
            font-size: 13px;
            color: var(--text-light);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin: 0 10px;
        }

        .question-type {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .question-type.variant {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .question-type.open {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info);
        }

        .question-actions {
            display: flex;
            gap: 5px;
        }

        /* Option List */
        .option-list {
            margin: 10px 0;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin-bottom: 5px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 6px;
        }

        .option-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .option-input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            padding: 20px;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-container {
            background: white;
            border-radius: var(--radius);
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: white;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .modal-body {
            flex: 1;
            overflow: hidden;
            padding: 0;
        }

        #mathEditorFrame {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        .modal-footer {
            padding: 15px 20px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        /* JSON Preview */
        .json-preview-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .json-key {
            color: #9cdcfe;
        }

        .json-string {
            color: #ce9178;
        }

        .json-number {
            color: #b5cea8;
        }

        .json-boolean {
            color: #569cd6;
        }

        .json-null {
            color: #569cd6;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 5px;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-light);
            border-bottom: 2px solid transparent;
            transition: var(--transition);
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Alert */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 2px solid var(--success);
            color: #065f46;
        }

        .alert-error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid var(--danger);
            color: #7f1d1d;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid var(--warning);
            color: #92400e;
        }

        /* Section Management */
        .section-list {
            margin: 10px 0;
        }

        .section-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            margin-bottom: 5px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 6px;
        }

        .section-input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .sidebar {
                max-height: 400px;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .header-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .btn-group {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-edit"></i> Test JSON Tahrirlagich</h1>
            <div class="header-controls">
                <button id="newTestBtn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Yangi Test
                </button>
                <button id="loadTestBtn" class="btn btn-secondary">
                    <i class="fas fa-folder-open"></i> Yuklash
                </button>
                <button id="saveTestBtn" class="btn btn-success">
                    <i class="fas fa-save"></i> Saqlash
                </button>
                <button id="previewTestBtn" class="btn btn-info">
                    <i class="fas fa-eye"></i> Ko'rish
                </button>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-section">
                    <h3><i class="fas fa-cog"></i> Test Sozlamalari</h3>
                    <div class="form-group">
                        <label>Test Kodi</label>
                        <input type="text" id="testCode" class="form-control" placeholder="Masalan: 5001" maxlength="10">
                    </div>
                    <div class="form-group">
                        <label>Test Nomi</label>
                        <input type="text" id="testTitle" class="form-control" placeholder="Test nomini kiriting">
                    </div>
                    <div class="form-group">
                        <label>Test Tavsifi</label>
                        <textarea id="testDescription" class="form-control" placeholder="Test haqida qisqacha ma'lumot"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Test Davomiyligi (daqiqa)</label>
                        <input type="number" id="testDuration" class="form-control" value="45" min="1" max="300">
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3><i class="fas fa-list-ol"></i> Savollar ({<span id="questionCount">0</span>})</h3>
                    <div class="question-list" id="questionList">
                        <!-- Savollar ro'yxati bu yerda ko'rinadi -->
                    </div>
                    <div class="btn-group">
                        <button id="addQuestionBtn" class="btn btn-primary btn-small">
                            <i class="fas fa-plus"></i> Savol Qo'shish
                        </button>
                        <button id="duplicateQuestionBtn" class="btn btn-secondary btn-small">
                            <i class="fas fa-copy"></i> Nusxalash
                        </button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3><i class="fas fa-tags"></i> Bo'limlar</h3>
                    <div class="section-list" id="sectionList">
                        <!-- Bo'limlar ro'yxati -->
                    </div>
                    <button id="addSectionBtn" class="btn btn-primary btn-small">
                        <i class="fas fa-plus"></i> Bo'lim Qo'shish
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" data-tab="question-details">Savol Tafsilotlari</button>
                    <button class="tab" data-tab="json-preview">JSON Ko'rinishi</button>
                    <button class="tab" data-tab="test-preview">Test Ko'rinishi</button>
                </div>

                <!-- Question Details Tab -->
                <div class="tab-content active" id="question-details">
                    <div class="content-section">
                        <h3><i class="fas fa-question-circle"></i> Savol Matni</h3>
                        <div class="form-group">
                            <label>Savol Matni (LaTeX formatida)</label>
                            <textarea id="questionText" class="form-control" placeholder="Masalan: $x^2 - 5x + 6 = 0$ tenglamaning ildizlari yig'indisini toping." rows="3"></textarea>
                            <button class="math-editor-btn" onclick="openMathEditor('questionText')">
                                <i class="fas fa-calculator"></i> Matematik Formula Tahrirlash
                            </button>
                        </div>
                    </div>

                    <div class="content-section">
                        <h3><i class="fas fa-cog"></i> Savol Sozlamalari</h3>
                        <div class="form-group">
                            <label>Savol Turi</label>
                            <select id="questionType" class="form-control">
                                <option value="variant">Variantli (Multiple Choice)</option>
                                <option value="open">Ochiq Javob (Open Answer)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ball</label>
                            <input type="number" id="questionPoints" class="form-control" value="2" min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label>Bo'lim</label>
                            <select id="questionSection" class="form-control">
                                <option value="">Bo'lim tanlanmagan</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="hasImage"> Rasmi bor
                            </label>
                        </div>
                    </div>

                    <!-- Variantlar Section -->
                    <div class="content-section" id="variantsSection">
                        <h3><i class="fas fa-list-ul"></i> Variantlar</h3>
                        <div class="option-list" id="optionList">
                            <!-- Variantlar bu yerda ko'rinadi -->
                        </div>
                        <button id="addOptionBtn" class="btn btn-primary btn-small">
                            <i class="fas fa-plus"></i> Variant Qo'shish
                        </button>
                        
                        <div class="form-group" style="margin-top: 15px;">
                            <label>To'g'ri Javob Varianti</label>
                            <select id="correctIndex" class="form-control">
                                <option value="">Tanlang</option>
                            </select>
                        </div>
                    </div>

                    <!-- Open Answer Section -->
                    <div class="content-section" id="openAnswerSection" style="display: none;">
                        <h3><i class="fas fa-keyboard"></i> Ochiq Javob</h3>
                        <div class="form-group">
                            <label>To'g'ri Javob (LaTeX formatida)</label>
                            <textarea id="correctAnswer" class="form-control" placeholder="Masalan: 5 yoki $3x+6$" rows="3"></textarea>
                            <button class="math-editor-btn" onclick="openMathEditor('correctAnswer')">
                                <i class="fas fa-calculator"></i> Matematik Formula Tahrirlash
                            </button>
                        </div>
                    </div>

                    <div class="content-section">
                        <h3><i class="fas fa-trash-alt"></i> Xavfli Amallar</h3>
                        <div class="btn-group">
                            <button id="deleteQuestionBtn" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Savolni O'chirish
                            </button>
                            <button id="moveQuestionUpBtn" class="btn btn-secondary">
                                <i class="fas fa-arrow-up"></i> Yuqoriga
                            </button>
                            <button id="moveQuestionDownBtn" class="btn btn-secondary">
                                <i class="fas fa-arrow-down"></i> Pastga
                            </button>
                        </div>
                    </div>
                </div>

                <!-- JSON Preview Tab -->
                <div class="tab-content" id="json-preview">
                    <div class="content-section">
                        <h3><i class="fas fa-code"></i> JSON Ko'rinishi</h3>
                        <div class="json-preview-container" id="jsonPreview">
                            {/* JSON ma'lumotlari bu yerda ko'rinadi */}
                        </div>
                        <div class="btn-group" style="margin-top: 15px;">
                            <button id="copyJsonBtn" class="btn btn-success">
                                <i class="fas fa-copy"></i> JSON ni Nusxalash
                            </button>
                            <button id="downloadJsonBtn" class="btn btn-primary">
                                <i class="fas fa-download"></i> JSON fayl yuklash
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Test Preview Tab -->
                <div class="tab-content" id="test-preview">
                    <div class="content-section">
                        <h3><i class="fas fa-eye"></i> Test Ko'rinishi</h3>
                        <div id="testPreview">
                            {/* Testning old ko'rinishi bu yerda */}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Math Editor Modal -->
    <div id="mathModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> Matematik Formula Tahrirlagich</h3>
                <button class="modal-close" onclick="closeMathModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <iframe id="mathEditorFrame" 
                        src="math-editor.html"
                        title="Matematik formula tahrirlagich"></iframe>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeMathModal()">
                    <i class="fas fa-times"></i> Bekor qilish
                </button>
                <button class="btn btn-success" onclick="saveMathFormula()">
                    <i class="fas fa-check"></i> Saqlash
                </button>
            </div>
        </div>
    </div>

    <!-- Load Test Modal -->
    <div id="loadModal" class="modal-overlay">
        <div class="modal-container" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-folder-open"></i> Test Yuklash</h3>
                <button class="modal-close" onclick="closeLoadModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div class="form-group">
                    <label>Test kodini kiriting</label>
                    <input type="text" id="loadTestCode" class="form-control" placeholder="Masalan: 5001">
                </div>
                <p style="margin: 10px 0; color: var(--text-light); font-size: 14px;">
                    Yoki JSON fayl yuklang:
                </p>
                <div class="form-group">
                    <input type="file" id="jsonFileInput" class="form-control" accept=".json">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeLoadModal()">
                    Bekor qilish
                </button>
                <button class="btn btn-primary" onclick="loadTestFromCode()">
                    Yuklash
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== GLOBAL O'ZGARUVCHILAR ====================
        let currentTest = {
            title: "",
            description: "",
            durationMinutes: 45,
            questions: [],
            sections: []
        };

        let currentQuestionIndex = -1;
        let currentTargetTextarea = null;

        // ==================== UTILITY FUNCTIONS ====================
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'exclamation-triangle'}"></i>
                <span>${message}</span>
            `;
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.opacity = '0';
                alertDiv.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertContainer.removeChild(alertDiv);
                    }
                }, 300);
            }, 3000);
        }

        function formatJSON(json) {
            return JSON.stringify(json, null, 2);
        }

        function syntaxHighlight(json) {
            if (!json) return '';
            
            let jsonStr = typeof json === 'string' ? json : JSON.stringify(json, null, 2);
            
            jsonStr = jsonStr
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?)/g, function (match) {
                    let cls = 'json-number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'json-key';
                        } else {
                            cls = 'json-string';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'json-boolean';
                    } else if (/null/.test(match)) {
                        cls = 'json-null';
                    }
                    return '<span class="' + cls + '">' + match + '</span>';
                });
            
            return jsonStr;
        }

        // ==================== TEST MANAGEMENT ====================
        function newTest() {
            currentTest = {
                title: "Yangi Test",
                description: "Bu yangi test tavsifi",
                durationMinutes: 45,
                questions: [],
                sections: [
                    { name: "Algebra", start: 1, end: 1 }
                ]
            };
            
            updateForm();
            addQuestion();
            showAlert("Yangi test yaratildi", "success");
        }

        function loadTest(json) {
            try {
                if (typeof json === 'string') {
                    json = JSON.parse(json);
                }
                
                currentTest = json;
                updateForm();
                
                if (currentTest.questions.length > 0) {
                    selectQuestion(0);
                }
                
                showAlert("Test muvaffaqiyatli yuklandi", "success");
                return true;
            } catch (error) {
                showAlert("JSON faylini o'qishda xato: " + error.message, "error");
                return false;
            }
        }

        function saveTest() {
            updateTestFromForm();
            
            // Test kodini olish
            const testCode = document.getElementById('testCode').value.trim();
            if (!testCode) {
                showAlert("Test kodini kiriting", "error");
                return;
            }
            
            // JSON faylini yaratish
            const jsonStr = formatJSON(currentTest);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // Yuklash uchun link yaratish
            const a = document.createElement('a');
            a.href = url;
            a.download = `${testCode}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert(`Test "${testCode}.json" fayliga saqlandi`, "success");
        }

        function updateTestFromForm() {
            currentTest.title = document.getElementById('testTitle').value;
            currentTest.description = document.getElementById('testDescription').value;
            currentTest.durationMinutes = parseInt(document.getElementById('testDuration').value) || 45;
            
            // Bo'limlarni yangilash
            currentTest.sections = [];
            const sectionItems = document.querySelectorAll('.section-item');
            sectionItems.forEach((item, index) => {
                const name = item.querySelector('.section-input').value;
                if (name.trim()) {
                    currentTest.sections.push({
                        name: name.trim(),
                        start: index + 1,
                        end: index + 1
                    });
                }
            });
            
            updateJSONPreview();
            updateTestPreview();
        }

        // ==================== QUESTION MANAGEMENT ====================
        function addQuestion() {
            const newQuestion = {
                text: "Yangi savol matni",
                type: "variant",
                options: ["Variant 1", "Variant 2", "Variant 3", "Variant 4"],
                correctIndex: 0,
                points: 2,
                section: "",
                hasImage: false
            };
            
            currentTest.questions.push(newQuestion);
            updateQuestionList();
            selectQuestion(currentTest.questions.length - 1);
            showAlert("Yangi savol qo'shildi", "success");
        }

        function duplicateQuestion() {
            if (currentQuestionIndex < 0) return;
            
            const original = currentTest.questions[currentQuestionIndex];
            const duplicate = JSON.parse(JSON.stringify(original));
            
            duplicate.text = original.text + " (nusxa)";
            currentTest.questions.splice(currentQuestionIndex + 1, 0, duplicate);
            
            updateQuestionList();
            selectQuestion(currentQuestionIndex + 1);
            showAlert("Savol nusxalandi", "success");
        }

        function deleteQuestion() {
            if (currentQuestionIndex < 0 || currentTest.questions.length <= 1) {
                showAlert("Kamida bitta savol bo'lishi kerak", "error");
                return;
            }
            
            if (!confirm("Savolni o'chirishni tasdiqlaysizmi?")) return;
            
            currentTest.questions.splice(currentQuestionIndex, 1);
            updateQuestionList();
            
            if (currentTest.questions.length > 0) {
                selectQuestion(Math.max(0, currentQuestionIndex - 1));
            } else {
                currentQuestionIndex = -1;
                clearQuestionForm();
            }
            
            showAlert("Savol o'chirildi", "success");
        }

        function moveQuestionUp() {
            if (currentQuestionIndex <= 0) return;
            
            const temp = currentTest.questions[currentQuestionIndex];
            currentTest.questions[currentQuestionIndex] = currentTest.questions[currentQuestionIndex - 1];
            currentTest.questions[currentQuestionIndex - 1] = temp;
            
            updateQuestionList();
            selectQuestion(currentQuestionIndex - 1);
            showAlert("Savol yuqoriga ko'chirildi", "success");
        }

        function moveQuestionDown() {
            if (currentQuestionIndex >= currentTest.questions.length - 1) return;
            
            const temp = currentTest.questions[currentQuestionIndex];
            currentTest.questions[currentQuestionIndex] = currentTest.questions[currentQuestionIndex + 1];
            currentTest.questions[currentQuestionIndex + 1] = temp;
            
            updateQuestionList();
            selectQuestion(currentQuestionIndex + 1);
            showAlert("Savol pastga ko'chirildi", "success");
        }

        function selectQuestion(index) {
            currentQuestionIndex = index;
            updateQuestionList();
            updateQuestionForm();
        }

        function updateQuestionForm() {
            if (currentQuestionIndex < 0) {
                clearQuestionForm();
                return;
            }
            
            const question = currentTest.questions[currentQuestionIndex];
            
            document.getElementById('questionText').value = question.text || '';
            document.getElementById('questionType').value = question.type || 'variant';
            document.getElementById('questionPoints').value = question.points || 2;
            document.getElementById('questionSection').value = question.section || '';
            document.getElementById('hasImage').checked = question.hasImage || false;
            
            // Variantlar bo'limini yangilash
            updateOptionsSection();
            
            // To'g'ri javobni yangilash
            if (question.type === 'variant') {
                document.getElementById('correctIndex').value = question.correctIndex !== undefined ? question.correctIndex : '';
                document.getElementById('variantsSection').style.display = 'block';
                document.getElementById('openAnswerSection').style.display = 'none';
            } else {
                document.getElementById('correctAnswer').value = question.correctAnswer || '';
                document.getElementById('variantsSection').style.display = 'none';
                document.getElementById('openAnswerSection').style.display = 'block';
            }
            
            // Bo'limlar ro'yxatini yangilash
            updateSectionSelect();
        }

        function clearQuestionForm() {
            document.getElementById('questionText').value = '';
            document.getElementById('questionType').value = 'variant';
            document.getElementById('questionPoints').value = 2;
            document.getElementById('questionSection').value = '';
            document.getElementById('hasImage').checked = false;
            document.getElementById('correctAnswer').value = '';
            document.getElementById('variantsSection').style.display = 'block';
            document.getElementById('openAnswerSection').style.display = 'none';
            document.getElementById('optionList').innerHTML = '';
            document.getElementById('correctIndex').innerHTML = '<option value="">Tanlang</option>';
        }

        function saveQuestion() {
            if (currentQuestionIndex < 0) return;
            
            const question = currentTest.questions[currentQuestionIndex];
            
            question.text = document.getElementById('questionText').value;
            question.type = document.getElementById('questionType').value;
            question.points = parseInt(document.getElementById('questionPoints').value) || 2;
            question.section = document.getElementById('questionSection').value;
            question.hasImage = document.getElementById('hasImage').checked;
            
            if (question.type === 'variant') {
                // Variantlarni saqlash
                const options = [];
                const optionElements = document.querySelectorAll('.option-item');
                optionElements.forEach(item => {
                    const input = item.querySelector('.option-input');
                    if (input && input.value.trim()) {
                        options.push(input.value.trim());
                    }
                });
                question.options = options;
                
                // To'g'ri javob indeksini saqlash
                question.correctIndex = parseInt(document.getElementById('correctIndex').value);
                delete question.correctAnswer;
            } else {
                // Ochiq javobni saqlash
                question.correctAnswer = document.getElementById('correctAnswer').value;
                delete question.options;
                delete question.correctIndex;
            }
            
            updateQuestionList();
            updateJSONPreview();
            showAlert("Savol saqlandi", "success");
        }

        // ==================== OPTIONS MANAGEMENT ====================
        function addOption() {
            const optionList = document.getElementById('optionList');
            const optionCount = optionList.children.length;
            
            const optionItem = document.createElement('div');
            optionItem.className = 'option-item';
            optionItem.innerHTML = `
                <input type="radio" name="correctOption" class="option-checkbox" 
                       onchange="updateCorrectIndex()" ${optionCount === 0 ? 'checked' : ''}>
                <input type="text" class="option-input" placeholder="Variant matni..." 
                       oninput="updateCorrectIndexOptions()">
                <button class="btn btn-danger btn-small" onclick="removeOption(this)">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            
            optionList.appendChild(optionItem);
            updateCorrectIndexOptions();
        }

        function removeOption(button) {
            const optionItem = button.closest('.option-item');
            optionItem.remove();
            updateCorrectIndexOptions();
        }

        function updateCorrectIndex() {
            const checkboxes = document.querySelectorAll('.option-checkbox');
            const correctIndexSelect = document.getElementById('correctIndex');
            
            checkboxes.forEach((checkbox, index) => {
                if (checkbox.checked) {
                    correctIndexSelect.value = index;
                }
            });
        }

        function updateCorrectIndexOptions() {
            const correctIndexSelect = document.getElementById('correctIndex');
            const options = document.querySelectorAll('.option-input');
            
            // Saqlangan to'g'ri javobni olish
            const currentCorrectIndex = currentQuestionIndex >= 0 
                ? currentTest.questions[currentQuestionIndex].correctIndex 
                : 0;
            
            correctIndexSelect.innerHTML = '<option value="">Tanlang</option>';
            
            options.forEach((input, index) => {
                const optionText = input.value.trim() || `Variant ${index + 1}`;
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${index + 1}. ${optionText}`;
                
                if (index === currentCorrectIndex) {
                    option.selected = true;
                    // Radio button ni ham tanlash
                    const radio = input.closest('.option-item').querySelector('.option-checkbox');
                    if (radio) radio.checked = true;
                }
                
                correctIndexSelect.appendChild(option);
            });
        }

        function updateOptionsSection() {
            const optionList = document.getElementById('optionList');
            optionList.innerHTML = '';
            
            if (currentQuestionIndex < 0) return;
            
            const question = currentTest.questions[currentQuestionIndex];
            const options = question.options || ["Variant 1", "Variant 2", "Variant 3", "Variant 4"];
            
            options.forEach((optionText, index) => {
                const optionItem = document.createElement('div');
                optionItem.className = 'option-item';
                optionItem.innerHTML = `
                    <input type="radio" name="correctOption" class="option-checkbox" 
                           onchange="updateCorrectIndex()" ${index === question.correctIndex ? 'checked' : ''}>
                    <input type="text" class="option-input" value="${optionText}" 
                           oninput="updateCorrectIndexOptions()">
                    <button class="btn btn-danger btn-small" onclick="removeOption(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                optionList.appendChild(optionItem);
            });
            
            updateCorrectIndexOptions();
        }

        // ==================== SECTIONS MANAGEMENT ====================
        function addSection() {
            const sectionList = document.getElementById('sectionList');
            const sectionCount = sectionList.children.length + 1;
            
            const sectionItem = document.createElement('div');
            sectionItem.className = 'section-item';
            sectionItem.innerHTML = `
                <input type="text" class="section-input" placeholder="Bo'lim nomi..." value="Yangi Bo'lim ${sectionCount}">
                <button class="btn btn-danger btn-small" onclick="removeSection(this)">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            
            sectionList.appendChild(sectionItem);
            updateSectionSelect();
            updateTestFromForm();
        }

        function removeSection(button) {
            const sectionItem = button.closest('.section-item');
            if (document.querySelectorAll('.section-item').length <= 1) {
                showAlert("Kamida bitta bo'lim bo'lishi kerak", "error");
                return;
            }
            sectionItem.remove();
            updateSectionSelect();
            updateTestFromForm();
        }

        function updateSectionSelect() {
            const sectionSelect = document.getElementById('questionSection');
            sectionSelect.innerHTML = '<option value="">Bo'lim tanlanmagan</option>';
            
            const sectionItems = document.querySelectorAll('.section-item');
            sectionItems.forEach(item => {
                const name = item.querySelector('.section-input').value;
                if (name.trim()) {
                    const option = document.createElement('option');
                    option.value = name.trim();
                    option.textContent = name.trim();
                    sectionSelect.appendChild(option);
                }
            });
        }

        // ==================== UI UPDATES ====================
        function updateForm() {
            document.getElementById('testTitle').value = currentTest.title;
            document.getElementById('testDescription').value = currentTest.description;
            document.getElementById('testDuration').value = currentTest.durationMinutes;
            
            // Bo'limlarni yangilash
            const sectionList = document.getElementById('sectionList');
            sectionList.innerHTML = '';
            
            if (currentTest.sections && currentTest.sections.length > 0) {
                currentTest.sections.forEach(section => {
                    const sectionItem = document.createElement('div');
                    sectionItem.className = 'section-item';
                    sectionItem.innerHTML = `
                        <input type="text" class="section-input" value="${section.name}">
                        <button class="btn btn-danger btn-small" onclick="removeSection(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    sectionList.appendChild(sectionItem);
                });
            } else {
                addSection(); // Minimal bitta bo'lim
            }
            
            updateQuestionList();
            updateSectionSelect();
            updateJSONPreview();
            updateTestPreview();
        }

        function updateQuestionList() {
            const questionList = document.getElementById('questionList');
            const questionCount = document.getElementById('questionCount');
            
            questionList.innerHTML = '';
            questionCount.textContent = currentTest.questions.length;
            
            currentTest.questions.forEach((question, index) => {
                const questionItem = document.createElement('div');
                questionItem.className = `question-item ${index === currentQuestionIndex ? 'active' : ''}`;
                questionItem.onclick = () => selectQuestion(index);
                
                const questionText = question.text 
                    ? question.text.replace(/<[^>]*>/g, '').replace(/\$/g, '').substring(0, 50) + '...'
                    : 'Savol matni yo\'q';
                
                questionItem.innerHTML = `
                    <div class="question-number">${index + 1}</div>
                    <div class="question-preview">${questionText}</div>
                    <div class="question-type ${question.type}">${question.type === 'variant' ? 'V' : 'O'}</div>
                    <div class="question-actions">
                        <button class="btn btn-danger btn-small" onclick="event.stopPropagation(); deleteSpecificQuestion(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                questionList.appendChild(questionItem);
            });
        }

        function deleteSpecificQuestion(index) {
            const tempIndex = currentQuestionIndex;
            currentQuestionIndex = index;
            deleteQuestion();
            if (tempIndex !== index) {
                currentQuestionIndex = tempIndex;
            }
        }

        function updateJSONPreview() {
            const jsonPreview = document.getElementById('jsonPreview');
            jsonPreview.innerHTML = syntaxHighlight(formatJSON(currentTest));
        }

        function updateTestPreview() {
            const testPreview = document.getElementById('testPreview');
            
            let html = `
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h2 style="color: var(--primary); margin-bottom: 10px;">${currentTest.title}</h2>
                    <p style="color: var(--text-light); margin-bottom: 20px;">${currentTest.description}</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: #f0f9ff; padding: 15px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 12px; color: var(--text-light);">Savollar soni</div>
                            <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${currentTest.questions.length}</div>
                        </div>
                        <div style="background: #f0fdf4; padding: 15px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 12px; color: var(--text-light);">Vaqt</div>
                            <div style="font-size: 24px; font-weight: 700; color: var(--success);">${currentTest.durationMinutes} daq</div>
                        </div>
                        <div style="background: #fef3c7; padding: 15px; border-radius: 6px; text-align: center;">
                            <div style="font-size: 12px; color: var(--text-light);">Bo'limlar</div>
                            <div style="font-size: 24px; font-weight: 700; color: var(--warning);">${currentTest.sections?.length || 0}</div>
                        </div>
                    </div>
            `;
            
            // Bo'limlar ro'yxati
            if (currentTest.sections && currentTest.sections.length > 0) {
                html += `<h3 style="color: var(--text); margin: 20px 0 10px 0;">Bo'limlar:</h3>`;
                html += `<ul style="padding-left: 20px; color: var(--text-light);">`;
                currentTest.sections.forEach(section => {
                    html += `<li>${section.name} (${section.start}-${section.end})</li>`;
                });
                html += `</ul>`;
            }
            
            // Savollar ro'yxati
            if (currentTest.questions && currentTest.questions.length > 0) {
                html += `<h3 style="color: var(--text); margin: 20px 0 10px 0;">Savollar:</h3>`;
                html += `<ol style="padding-left: 20px;">`;
                currentTest.questions.forEach((question, index) => {
                    const typeIcon = question.type === 'variant' ? '' : '';
                    const points = question.points || 1;
                    html += `<li style="margin-bottom: 10px;">
                        <strong>${typeIcon} Savol ${index + 1}</strong> (${points} ball)
                        <div style="font-size: 14px; color: var(--text-light); margin: 5px 0;">${question.text.substring(0, 100)}...</div>
                    </li>`;
                });
                html += `</ol>`;
            }
            
            html += `</div>`;
            testPreview.innerHTML = html;
        }

        // ==================== MATH EDITOR ====================
        function openMathEditor(targetId) {
            currentTargetTextarea = targetId;
            
            const modal = document.getElementById('mathModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Hozirgi matnni modalga yuklash
            const currentText = document.getElementById(targetId).value;
            const frame = document.getElementById('mathEditorFrame');
            
            const onLoad = () => {
                if (currentText && currentText.trim() !== '') {
                    frame.contentWindow.postMessage({
                        type: 'loadFormula',
                        latex: currentText
                    }, '*');
                }
                frame.removeEventListener('load', onLoad);
            };
            
            frame.addEventListener('load', onLoad);
            
            // Agar frame allaqachon yuklangan bo'lsa
            if (frame.contentWindow) {
                if (currentText && currentText.trim() !== '') {
                    setTimeout(() => {
                        frame.contentWindow.postMessage({
                            type: 'loadFormula',
                            latex: currentText
                        }, '*');
                    }, 500);
                }
            }
        }

        function closeMathModal() {
            const modal = document.getElementById('mathModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
            currentTargetTextarea = null;
        }

        function saveMathFormula() {
            const frame = document.getElementById('mathEditorFrame');
            if (!frame || !frame.contentWindow) {
                showAlert("Matematik editor bilan aloqa yo'q", "error");
                return;
            }
            
            // Frame dan formulani olish uchun so'rov yuborish
            frame.contentWindow.postMessage({
                type: 'getFormula'
            }, '*');
            
            // Javobni qabul qilish
            const messageHandler = (event) => {
                if (event.data.type === 'mathFormulaResponse') {
                    const latex = event.data.latex;
                    
                    if (currentTargetTextarea) {
                        const textarea = document.getElementById(currentTargetTextarea);
                        textarea.value = latex;
                        
                        // Savolni saqlash
                        if (currentQuestionIndex >= 0) {
                            saveQuestion();
                        }
                    }
                    
                    closeMathModal();
                    showAlert("Formula saqlandi", "success");
                    
                    window.removeEventListener('message', messageHandler);
                }
            };
            
            window.addEventListener('message', messageHandler);
            
            // Timeout qo'shamiz
            setTimeout(() => {
                window.removeEventListener('message', messageHandler);
            }, 3000);
        }

        // ==================== FILE MANAGEMENT ====================
        function loadTestFromCode() {
            const testCode = document.getElementById('loadTestCode').value.trim();
            if (!testCode) {
                showAlert("Test kodini kiriting", "error");
                return;
            }
            
            // JSON faylni yuklash
            fetch(`${testCode}.json`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Fayl topilmadi');
                    }
                    return response.json();
                })
                .then(data => {
                    loadTest(data);
                    closeLoadModal();
                })
                .catch(error => {
                    showAlert(`Fayl yuklashda xato: ${error.message}`, "error");
                });
        }

        function openLoadModal() {
            const modal = document.getElementById('loadModal');
            modal.classList.add('active');
            document.getElementById('loadTestCode').focus();
        }

        function closeLoadModal() {
            const modal = document.getElementById('loadModal');
            modal.classList.remove('active');
        }

        function copyJSON() {
            const jsonStr = formatJSON(currentTest);
            navigator.clipboard.writeText(jsonStr)
                .then(() => {
                    showAlert("JSON nusxalandi", "success");
                })
                .catch(err => {
                    showAlert("Nusxalashda xato: " + err.message, "error");
                });
        }

        function downloadJSON() {
            const jsonStr = formatJSON(currentTest);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const testCode = document.getElementById('testCode').value.trim() || 'test';
            const a = document.createElement('a');
            a.href = url;
            a.download = `${testCode}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert(`JSON fayl yuklandi: ${testCode}.json`, "success");
        }

        // ==================== EVENT LISTENERS ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and tab contents
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Header buttons
            document.getElementById('newTestBtn').addEventListener('click', newTest);
            document.getElementById('loadTestBtn').addEventListener('click', openLoadModal);
            document.getElementById('saveTestBtn').addEventListener('click', saveTest);
            document.getElementById('previewTestBtn').addEventListener('click', () => {
                document.querySelector('[data-tab="test-preview"]').click();
            });
            
            // Question management buttons
            document.getElementById('addQuestionBtn').addEventListener('click', addQuestion);
            document.getElementById('duplicateQuestionBtn').addEventListener('click', duplicateQuestion);
            document.getElementById('deleteQuestionBtn').addEventListener('click', deleteQuestion);
            document.getElementById('moveQuestionUpBtn').addEventListener('click', moveQuestionUp);
            document.getElementById('moveQuestionDownBtn').addEventListener('click', moveQuestionDown);
            
            // Options and sections
            document.getElementById('addOptionBtn').addEventListener('click', addOption);
            document.getElementById('addSectionBtn').addEventListener('click', addSection);
            
            // JSON buttons
            document.getElementById('copyJsonBtn').addEventListener('click', copyJSON);
            document.getElementById('downloadJsonBtn').addEventListener('click', downloadJSON);
            
            // Form auto-save
            document.getElementById('questionType').addEventListener('change', function() {
                if (currentQuestionIndex >= 0) {
                    saveQuestion();
                }
            });
            
            // Real-time form updates
            const autoSaveFields = ['questionText', 'questionPoints', 'correctAnswer'];
            autoSaveFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', function() {
                        if (currentQuestionIndex >= 0) {
                            saveQuestion();
                        }
                    });
                }
            });
            
            // Sections auto-update
            document.getElementById('sectionList').addEventListener('input', function() {
                updateTestFromForm();
            });
            
            // File input
            document.getElementById('jsonFileInput').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    if (loadTest(content)) {
                        closeLoadModal();
                    }
                };
                reader.readAsText(file);
            });
            
            // Initial setup
            newTest();
            
            // Message handler for math editor
            window.addEventListener('message', function(event) {
                if (event.data.type === 'mathFormulaInserted') {
                    const latex = event.data.latex;
                    if (currentTargetTextarea) {
                        const textarea = document.getElementById(currentTargetTextarea);
                        textarea.value = latex;
                        
                        if (currentQuestionIndex >= 0) {
                            saveQuestion();
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>