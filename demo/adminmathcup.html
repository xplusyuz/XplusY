<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MathCup — Admin</title>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root{--bg:#0b1220;--card:#071029;--glass:rgba(255,255,255,0.03);--accent:#22c55e}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#051023,#071429);color:#e6eef8;padding:18px}
    .wrap{max-width:1100px;margin:0 auto}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
    h1{font-size:20px;margin:0}
    .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--accent);color:#022}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit}
    .card{background:var(--card);padding:14px;border-radius:12px;margin-bottom:12px;box-shadow:0 8px 30px rgba(0,0,0,0.5)}
    label{display:block;margin-top:8px;font-size:13px;color:#bcd}
    textarea,input[type=text]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .row{display:flex;gap:10px}
    .col{flex:1}
    .muted{color:#9fb0c8;font-size:13px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03)}
    .small{font-size:12px;color:#9fb0c8}
    .danger{background:#5b2121;color:#ffdede}
    .inline{display:inline-block}
    .actions{display:flex;gap:8px}
    .search{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .flex-between{display:flex;justify-content:space-between;align-items:center}
    .center{text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>MathCup — Admin panel</h1>
      <div>
        <button id="signInBtn" class="btn ghost">Google bilan kirish</button>
        <span id="adminEmail" class="small" style="margin-left:10px"></span>
      </div>
    </header>

    <div id="notAuthorized" class="card center">
      <div class="muted">Iltimos tizimga kiring — faqat ro‘yxatga kiritilgan adminlar savollarni tahrirlashi mumkin.</div>
      <div class="small muted" style="margin-top:8px">Adminlar: <span id="adminList"></span></div>
    </div>

    <div id="adminArea" class="hidden">
      <!-- Questions editor -->
      <div class="card">
        <div class="flex-between">
          <div>
            <strong>Savollarni tahrirlash</strong>
            <div class="small muted">Savollarni LaTeX (MathTeX) formatida yozing, javoblar variantlarsiz yozilsin.</div>
          </div>
          <div class="actions">
            <button id="loadBtn" class="btn ghost">Yuklash</button>
            <button id="saveBtn" class="btn primary">Saqlash</button>
            <button id="exportJsonBtn" class="btn ghost">JSON eksport</button>
          </div>
        </div>

        <div id="questionsForm" style="margin-top:12px">
          <!-- five q blocks -->
          <div id="qBlocks"></div>
        </div>
      </div>

      <!-- Participants viewer -->
      <div class="card">
        <div class="flex-between">
          <div>
            <strong>Ishtirokchilar (tanlangan raund)</strong>
            <div class="small muted">Raundni tanlang yoki default — keyingi Shanba (20:00) uchun ko‘rsatadi.</div>
          </div>
          <div class="actions">
            <input id="roundDate" type="date" class="search">
            <button id="loadPartsBtn" class="btn ghost">Yuklash</button>
            <button id="exportPartsBtn" class="btn ghost">Export CSV</button>
          </div>
        </div>

        <div style="margin-top:12px;max-height:260px;overflow:auto">
          <table id="participantsTable">
            <thead><tr><th>Foydalanuvchi ID</th><th>Ismi</th><th>Qo'shilgan vaqti</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Results viewer -->
      <div class="card">
        <div class="flex-between">
          <div>
            <strong>Natijalar (natijalar hujjati)</strong>
            <div class="small muted">Bu barcha saqlangan natijalar: eksport, tozalash yoki individual yozuvni o'chirish mumkin.</div>
          </div>
          <div class="actions">
            <button id="refreshResults" class="btn ghost">Yangilash</button>
            <button id="exportResultsBtn" class="btn ghost">Export JSON</button>
            <button id="clearResultsBtn" class="btn danger">Natijalarni tozalash</button>
          </div>
        </div>

        <div style="margin-top:12px;max-height:320px;overflow:auto">
          <table id="resultsTable">
            <thead><tr><th>#</th><th>Ismi</th><th>Uid</th><th>Ball</th><th>Vaqt</th><th>Amal</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="small muted center" style="margin-top:10px">MathJax avtomatik ravishda MathTeX render qiladi — saqlagandan keyin sahifani yangilang yoki MathJax.typesetPromise() chaqiring.</div>
    </div>
  </div>

<script>
  // ====== SOZLAMALAR ======
  // ADMIN_EMAILSga admin email(lar)ni qo'shing
  const ADMIN_EMAILS = ["admin@example.com"]; // o'zgartiring

  // firebase-config.js va auth-utils.js fayllari global o'rnatilgan bo'lishi kerak:
  // - firebase-config.js: window.firebase va window.db (firebase.firestore()) ni ta'minlashi kerak
  // - auth-utils.js: authUtils.requireSession(), authUtils.logout(), authUtils.loadSession(), authUtils.onUserChange(callback) kabi funksiyalar mavjud bo'lishi kerak
  if(!window.firebase || !window.db){
    alert('Firebase yoki db topilmadi. Iltimos firebase-config.js faylingizni tekshiring.');
  }

  // DOM
  const signInBtn = document.getElementById('signInBtn');
  const adminEmailSpan = document.getElementById('adminEmail');
  const notAuthorized = document.getElementById('notAuthorized');
  const adminArea = document.getElementById('adminArea');
  const adminListEl = document.getElementById('adminList');

  const qBlocks = document.getElementById('qBlocks');
  const loadBtn = document.getElementById('loadBtn');
  const saveBtn = document.getElementById('saveBtn');
  const exportJsonBtn = document.getElementById('exportJsonBtn');

  const roundDate = document.getElementById('roundDate');
  const loadPartsBtn = document.getElementById('loadPartsBtn');
  const participantsTableBody = document.querySelector('#participantsTable tbody');
  const exportPartsBtn = document.getElementById('exportPartsBtn');

  const refreshResults = document.getElementById('refreshResults');
  const exportResultsBtn = document.getElementById('exportResultsBtn');
  const clearResultsBtn = document.getElementById('clearResultsBtn');
  const resultsTableBody = document.querySelector('#resultsTable tbody');

  // show admin list
  adminListEl.textContent = ADMIN_EMAILS.join(', ');

  // create q blocks
  function createQBlocks(){
    qBlocks.innerHTML = '';
    for(let i=1;i<=5;i++){
      const div = document.createElement('div');
      div.innerHTML = `
        <label>Savol ${i} (LaTeX):</label>
        <textarea id="q${i}" rows="3" placeholder="Masalan: \\\\displaystyle \\\\int_0^1 x^2 dx = ?"></textarea>
        <label>Javob ${i} (variantlarsiz):</label>
        <input id="a${i}" type="text" placeholder="Javobni oddiy matn sifatida yozing">
      `;
      qBlocks.appendChild(div);
    }
  }
  createQBlocks();

  // Auth
  async function init(){
    try{
      const user = await authUtils.loadSession();
      handleUser(user);
    }catch(e){
      handleUser(null);
    }
    authUtils.onUserChange(u=>handleUser(u));
  }
  function handleUser(user){
    if(user && ADMIN_EMAILS.includes(user.data.email)){
      adminEmailSpan.textContent = user.data.email;
      notAuthorized.classList.add('hidden');
      adminArea.classList.remove('hidden');
    } else {
      adminEmailSpan.textContent = user ? user.data.email : '';
      notAuthorized.classList.remove('hidden');
      adminArea.classList.add('hidden');
    }
  }

  signInBtn.addEventListener('click', async ()=>{
    try{
      if(!authUtils.isSignedIn()){
        await authUtils.signInWithGoogle();
      } else {
        if(confirm('Chiqishni xohlaysizmi?')){ await authUtils.logout(); }
      }
    }catch(e){
      console.error(e);
      alert('Auth xatolik: ' + (e.message||e));
    }
  });

  // Load existing questions
  loadBtn.addEventListener('click', async ()=>{
    try{
      const snap = await db.collection('MathCup').doc('questions').get();
      if(!snap.exists){
        alert('Savollar topilmadi (MathCup/questions yo‘q).');
        return;
      }
      const d = snap.data();
      for(let i=1;i<=5;i++){
        document.getElementById('q'+i).value = d['q'+i] || '';
        document.getElementById('a'+i).value = d['a'+i] || '';
      }
      // render MathJax in editor preview (if desired)
      if(window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise();
      alert('Savollar yuklandi.');
    }catch(e){
      console.error(e);
      alert('Yuklash xatosi: ' + (e.message||e));
    }
  });

  // Save questions
  saveBtn.addEventListener('click', async ()=>{
    try{
      const payload = {};
      for(let i=1;i<=5;i++){
        payload['q'+i] = document.getElementById('q'+i).value.trim();
        payload['a'+i] = document.getElementById('a'+i).value.trim();
      }
      await db.collection('MathCup').doc('questions').set(payload);
      alert('Savollar saqlandi (MathCup/questions).');
      // re-render math
      if(window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise();
    }catch(e){
      console.error(e);
      alert('Saqlashda xatolik: ' + (e.message||e));
    }
  });

  // Export questions as JSON
  exportJsonBtn.addEventListener('click', async ()=>{
    const payload = {};
    for(let i=1;i<=5;i++){
      payload['q'+i] = document.getElementById('q'+i).value.trim();
      payload['a'+i] = document.getElementById('a'+i).value.trim();
    }
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'mathcup-questions.json'; a.click();
    URL.revokeObjectURL(url);
  });

  // Participants: pick date default next Saturday
  function formatDateForInput(d){
    return d.toISOString().slice(0,10);
  }
  function getNextSaturday(){
    const now = new Date();
    const day = now.getDay();
    const daysUntilSat = (6 - day + 7) % 7;
    const sat = new Date(now); sat.setDate(now.getDate() + daysUntilSat); sat.setHours(0,0,0,0);
    return sat;
  }
  roundDate.value = formatDateForInput(getNextSaturday());

  loadPartsBtn.addEventListener('click', async ()=>{
    participantsTableBody.innerHTML = '<tr><td colspan="3" class="small muted">Yuklanmoqda...</td></tr>';
    try{
      const d = new Date(roundDate.value);
      const eventId = `MathCup_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      const col = db.collection('MathCup').doc(eventId).collection('participants');
      const snap = await col.get();
      const rows = [];
      snap.forEach(doc=>{
        const data = doc.data();
        rows.push({id:doc.id, name: data.name || '', joinedAt: data.joinedAt ? data.joinedAt.toDate().toLocaleString() : ''});
      });
      participantsTableBody.innerHTML = '';
      if(rows.length === 0) participantsTableBody.innerHTML = '<tr><td colspan="3" class="small muted">Ishtirokchilar topilmadi.</td></tr>';
      else{
        for(const r of rows){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td class="small">${r.id}</td><td class="small">${escapeHtml(r.name)}</td><td class="small">${escapeHtml(r.joinedAt)}</td>`;
          participantsTableBody.appendChild(tr);
        }
      }
    }catch(e){
      console.error(e);
      participantsTableBody.innerHTML = '<tr><td colspan="3" class="small muted">Yuklashda xatolik</td></tr>';
    }
  });

  exportPartsBtn.addEventListener('click', async ()=>{
    try{
      const d = new Date(roundDate.value);
      const eventId = `MathCup_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
      const col = db.collection('MathCup').doc(eventId).collection('participants');
      const snap = await col.get();
      const rows = [];
      snap.forEach(doc=>{ const dt = doc.data(); rows.push({uid: doc.id, name: dt.name || '', joinedAt: dt.joinedAt ? dt.joinedAt.toDate().toISOString() : ''}) });
      const csv = toCSV(rows);
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`participants_${eventId}.csv`; a.click(); URL.revokeObjectURL(url);
    }catch(e){
      console.error(e); alert('Export xatosi: '+(e.message||e));
    }
  });

  // Results: load & render
  async function loadResults(){
    resultsTableBody.innerHTML = '<tr><td colspan="6" class="small muted">Yuklanmoqda...</td></tr>';
    try{
      const snap = await db.collection('MathCup').doc('natijalar').get();
      const data = snap.exists ? (snap.data().entries || []) : [];
      resultsTableBody.innerHTML = '';
      if(data.length === 0){
        resultsTableBody.innerHTML = '<tr><td colspan="6" class="small muted">Natijalar mavjud emas</td></tr>';
        return;
      }
      data.forEach((e, i)=>{
        const tr = document.createElement('tr');
        const ttime = e.timestamp && e.timestamp.toDate ? e.timestamp.toDate().toLocaleString() : (e.timestamp || '');
        tr.innerHTML = `<td class="small">${i+1}</td><td class="small">${escapeHtml(e.name)}</td><td class="small">${escapeHtml(e.uid)}</td><td class="small">${escapeHtml(e.score)}</td><td class="small">${escapeHtml(ttime)}</td><td class="small"><button data-idx="${i}" class="btn ghost">O'chirish</button></td>`;
        resultsTableBody.appendChild(tr);
      });
      // attach delete handlers
      resultsTableBody.querySelectorAll('button[data-idx]').forEach(btn=>{
        btn.addEventListener('click', async (ev)=>{
          const idx = Number(ev.currentTarget.dataset.idx);
          if(!confirm('Ushbu yozuvni o‘chirmoqchimisiz?')) return;
          try{
            await removeResultAtIndex(idx);
            await loadResults();
          }catch(e){ console.error(e); alert('O\'chirishda xato: '+(e.message||e)); }
        });
      });
    }catch(e){
      console.error(e);
      resultsTableBody.innerHTML = '<tr><td colspan="6" class="small muted">Yuklashda xato</td></tr>';
    }
  }

  refreshResults.addEventListener('click', loadResults);

  exportResultsBtn.addEventListener('click', async ()=>{
    try{
      const snap = await db.collection('MathCup').doc('natijalar').get();
      const data = snap.exists ? (snap.data().entries || []) : [];
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='mathcup-results.json'; a.click(); URL.revokeObjectURL(url);
    }catch(e){
      console.error(e); alert('Export xatosi: '+(e.message||e));
    }
  });

  clearResultsBtn.addEventListener('click', async ()=>{
    if(!confirm('Natijalar butunlay o\'chiriladi. Davom etilsinmi?')) return;
    try{
      await db.collection('MathCup').doc('natijalar').set({entries: []});
      await loadResults();
      alert('Natijalar tozalandi.');
    }catch(e){ console.error(e); alert('Tozalash xatosi: '+(e.message||e)); }
  });

  // helper to remove result at index (transactionally)
  async function removeResultAtIndex(idx){
    const ref = db.collection('MathCup').doc('natijalar');
    await db.runTransaction(async tx=>{
      const snap = await tx.get(ref);
      const cur = snap.exists ? (snap.data().entries || []) : [];
      if(idx < 0 || idx >= cur.length) throw new Error('Index out of bounds');
      cur.splice(idx,1);
      tx.set(ref, {entries: cur}, {merge:true});
    });
  }

  // utils
  function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function toCSV(arr){
    if(!arr.length) return '';
    const keys = Object.keys(arr[0]);
    const lines = [keys.join(',')];
    for(const r of arr){
      lines.push(keys.map(k=>`"${String(r[k]||'').replaceAll('"','""')}"`).join(','));
    }
    return lines.join('\n');
  }

  // init
  (async ()=>{
    await init();
    // load existing questions into editor (optional)
    try{ const snap = await db.collection('MathCup').doc('questions').get(); if(snap.exists){ const d=snap.data(); for(let i=1;i<=5;i++){ document.getElementById('q'+i).value = d['q'+i]||''; document.getElementById('a'+i).value = d['a'+i]||''; } } }catch(e){}
    loadResults();
  })();
</script>
</body>
</html>
