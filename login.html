<!doctype html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <title>LeaderMath â€” Kirish</title>
  <meta name="theme-color" content="#007AFF">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root{--brand:#007AFF;--bg:#F2F2F7;--text:#111827;--muted:#6b7280;--card:rgba(255,255,255,.92);--shadow:0 18px 45px rgba(0,0,0,.16);--r:22px}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,#eef2ff,#f5f3ff);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;color:var(--text)}
    .card{width:min(520px,100%);background:var(--card);backdrop-filter:blur(14px);border:1px solid rgba(255,255,255,.6);border-radius:var(--r);box-shadow:var(--shadow);padding:26px}
    .top{display:flex;gap:14px;align-items:center;margin-bottom:18px}
    .logo{width:54px;height:54px;border-radius:16px;background:linear-gradient(135deg,#007AFF,#5856D6);display:flex;align-items:center;justify-content:center;color:white;font-weight:900}
    h1{font-size:20px}
    p{font-size:13px;color:var(--muted);margin-top:4px;line-height:1.4}
    .btnrow{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:18px}
    button{border:none;border-radius:999px;padding:14px 16px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:10px}
    .primary{background:linear-gradient(135deg,#007AFF,#5856D6);color:white;box-shadow:0 10px 25px rgba(0,122,255,.25)}
    .ghost{background:white;border:1px solid rgba(0,0,0,.06)}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);backdrop-filter:blur(10px);padding:18px}
    .modal.open{display:flex}
    .dialog{width:min(520px,100%);background:white;border-radius:22px;box-shadow:0 25px 65px rgba(0,0,0,.25);padding:18px;position:relative}
    .x{position:absolute;top:12px;right:12px;width:42px;height:42px;border-radius:999px;border:none;background:#F2F2F7;cursor:pointer}
    .title{font-size:16px;font-weight:800;margin:6px 0 14px}
    label{display:block;font-size:12px;color:var(--muted);margin-top:10px}
    input{width:100%;padding:12px 14px;border-radius:14px;border:1px solid #e5e7eb;margin-top:6px;font-size:14px;outline:none}
    input:focus{border-color:var(--brand);box-shadow:0 0 0 3px rgba(0,122,255,.12)}
    .err{display:none;margin-top:10px;background:#fee2e2;border:1px solid #fecaca;color:#991b1b;padding:10px 12px;border-radius:14px;font-size:13px}
    .err.show{display:block}
    .creds{display:flex;flex-direction:column;gap:10px;background:#F8FAFC;border:1px solid #e5e7eb;border-radius:18px;padding:12px}
    .row{display:flex;gap:10px;align-items:center}
    code{flex:1;background:white;border:1px solid #e5e7eb;border-radius:14px;padding:10px 12px;font-family:ui-monospace,Menlo,Consolas,monospace}
    .copy{background:#EFF6FF;border:1px solid #DBEAFE}
    @media (max-width:520px){.btnrow{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="card">
    <div class="top">
      <div class="logo">LM</div>
      <div>
        <h1>LeaderMath.uz</h1>
        <p>Bir bosishda ro'yxatdan o'tish (auto ID+Parol) yoki ID+Parol bilan kirish.</p>
      </div>
    </div>

    <div class="btnrow">
      <button class="primary" id="openLogin"><i class="fa-solid fa-right-to-bracket"></i>Kirish</button>
      <button class="ghost" id="openReg"><i class="fa-solid fa-user-plus"></i>Auto ro'yxat</button>
    </div>

    <div id="globalErr" class="err"></div>
  </div>

  <div class="modal" id="mLogin">
    <div class="dialog">
      <button class="x" data-close="mLogin"><i class="fa-solid fa-xmark"></i></button>
      <div class="title">ID + Parol orqali kirish</div>
      <form id="loginForm">
        <label>ID (6 xonali)
          <input id="lid" inputmode="numeric" maxlength="6" autocomplete="off" required>
        </label>
        <label>Parol
          <input id="lpw" type="password" minlength="6" autocomplete="current-password" required>
        </label>
        <div id="loginErr" class="err"></div>
        <button class="primary" type="submit" id="loginBtn"><i class="fa-solid fa-circle-check"></i>Kirish</button>
      </form>
    </div>
  </div>

  <div class="modal" id="mReg">
    <div class="dialog">
      <button class="x" data-close="mReg"><i class="fa-solid fa-xmark"></i></button>
      <div class="title">Auto ro'yxatdan o'tish</div>
      <p style="color:#6b7280;font-size:13px;line-height:1.4">Tizim sizga avtomatik 6 xonali ID va random parol beradi. Ularni saqlab qo'ying.</p>
      <div id="regErr" class="err"></div>
      <button class="primary" id="regBtn"><i class="fa-solid fa-wand-magic-sparkles"></i>Yaratish</button>
    </div>
  </div>

  <div class="modal" id="mCreds">
    <div class="dialog">
      <button class="x" data-close="mCreds"><i class="fa-solid fa-xmark"></i></button>
      <div class="title">Sizning login ma'lumotlaringiz</div>
      <div class="creds">
        <div class="row"><span style="width:70px;color:#6b7280;font-size:12px">ID</span><code id="cid"></code><button class="copy" id="copyId">Nusxa</button></div>
        <div class="row"><span style="width:70px;color:#6b7280;font-size:12px">Parol</span><code id="cpw"></code><button class="copy" id="copyPw">Nusxa</button></div>
      </div>
      <button class="primary" id="go"><i class="fa-solid fa-arrow-right"></i>Portalga o'tish</button>
    </div>
  </div>

  <script src="api-utils.js"></script>
  <script src="auth-utils.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);
    const open = (id) => $(id).classList.add('open');
    const close = (id) => $(id).classList.remove('open');
    const showErr = (id, msg) => { const el=$(id); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),5000); }

    document.addEventListener('click', (e)=>{
      const b = e.target.closest('[data-close]');
      if (b) close(b.dataset.close);
      if (e.target.classList.contains('modal')) close(e.target.id);
    });

    $('openLogin').onclick = ()=> open('mLogin');
    $('openReg').onclick = ()=> open('mReg');

    $('lid').addEventListener('input', (e)=> e.target.value = e.target.value.replace(/\D/g,'').slice(0,6));

    // if session exists -> index
    document.addEventListener('DOMContentLoaded', async ()=>{
      const u = await authUtils.loadSession();
      if (u) window.location.href = 'index.html';
    });

    $('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const id = $('lid').value.trim();
      const pw = $('lpw').value.trim();
      if (id.length !== 6) return showErr('loginErr',"ID 6 xonali bo'lishi kerak");
      $('loginBtn').disabled = true;
      try{
        await authUtils.loginWithIdPassword(id,pw);
        const params = new URLSearchParams(location.search);
        const redirect = params.get('redirect');
        window.location.href = redirect ? decodeURIComponent(redirect) : 'index.html';
      }catch(err){
        showErr('loginErr', err.message || 'Kirishda xatolik');
      }finally{
        $('loginBtn').disabled = false;
      }
    });

    $('regBtn').onclick = async ()=>{
      $('regBtn').disabled = true;
      try{
        const data = await authUtils.registerAuto();
        $('cid').textContent = data.loginId;
        $('cpw').textContent = data.password;
        close('mReg'); open('mCreds');
      }catch(err){
        showErr('regErr', err.message || "Ro'yxatdan o'tishda xatolik");
      }finally{
        $('regBtn').disabled = false;
      }
    };

    $('copyId').onclick = async ()=> { try{ await navigator.clipboard.writeText($('cid').textContent.trim()); }catch(e){} };
    $('copyPw').onclick = async ()=> { try{ await navigator.clipboard.writeText($('cpw').textContent.trim()); }catch(e){} };
    $('go').onclick = ()=> window.location.href = 'index.html';
  </script>
</body>
</html>
