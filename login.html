<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>LeaderMath — Kirish</title>
  <meta name="theme-color" content="#0B1220" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg1:#0B1220;--bg2:#121B2F;--card:rgba(255,255,255,.08);--stroke:rgba(255,255,255,.14);--text:rgba(255,255,255,.92);--muted:rgba(255,255,255,.66);--accent:#2E8B57;--danger:#ff3b30;--shadow:0 20px 70px rgba(0,0,0,.45);--r:22px;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--text);min-height:100vh;background:radial-gradient(900px 500px at 20% 10%, rgba(46,139,87,.35), transparent 60%),radial-gradient(900px 500px at 80% 10%, rgba(88,86,214,.25), transparent 60%),linear-gradient(180deg,var(--bg1),var(--bg2));display:flex;align-items:center;justify-content:center;padding:20px;}
    .wrap{width:min(980px,100%);display:grid;grid-template-columns:1.05fr .95fr;gap:18px;}
    @media(max-width:900px){.wrap{grid-template-columns:1fr;}}
    .hero,.panel{border:1px solid var(--stroke);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border-radius:var(--r);box-shadow:var(--shadow);padding:22px;position:relative;overflow:hidden;}
    .badge{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;border:1px solid rgba(46,139,87,.35);background:rgba(46,139,87,.12);color:#d7ffe8;font-weight:600;font-size:12px;}
    h1{margin:14px 0 8px;font-size:40px;line-height:1.05;}
    .sub{color:var(--muted);font-size:14px;line-height:1.55;max-width:60ch;}
    .tabs{display:flex;gap:10px;margin-top:14px;}
    .tab{flex:1;border:1px solid var(--stroke);background:rgba(255,255,255,.04);border-radius:14px;padding:10px 12px;color:rgba(255,255,255,.8);font-weight:800;cursor:pointer;}
    .tab.active{background:rgba(46,139,87,.18);border-color:rgba(46,139,87,.45);color:#eafff3;}
    .form{margin-top:14px;display:grid;gap:12px;}
    .row{display:grid;gap:8px;}
    label{font-size:12px;color:rgba(255,255,255,.72);}
    input{width:100%;padding:12px;border-radius:14px;border:1px solid var(--stroke);background:rgba(0,0,0,.20);color:var(--text);outline:none;font-size:14px;}
    input:focus{border-color:rgba(46,139,87,.65);box-shadow:0 0 0 4px rgba(46,139,87,.18);}
    .btn{width:100%;border:1px solid rgba(46,139,87,.55);background:linear-gradient(180deg,rgba(46,139,87,.95),rgba(46,139,87,.70));color:white;padding:12px 14px;border-radius:14px;font-weight:900;cursor:pointer;}
    .btn.secondary{border:1px solid var(--stroke);background:rgba(255,255,255,.06);color:rgba(255,255,255,.9);}
    .hint{font-size:12px;color:rgba(255,255,255,.68);line-height:1.45;}
    .err{display:none;border:1px solid rgba(255,59,48,.35);background:rgba(255,59,48,.12);color:#ffd7d4;padding:10px 12px;border-radius:14px;font-size:12px;}
    .err.show{display:block;}
    .creds{margin-top:12px;border:1px dashed rgba(255,255,255,.22);border-radius:14px;padding:12px;background:rgba(0,0,0,.18);display:none;}
    .creds.show{display:block;}
    .kv{display:flex;justify-content:space-between;gap:12px;padding:6px 0;font-size:13px;}
    .kv b{color:rgba(255,255,255,.9)}
    .topline{display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .smallbtn{border:1px solid var(--stroke);background:rgba(255,255,255,.06);color:rgba(255,255,255,.85);padding:8px 10px;border-radius:12px;font-weight:800;cursor:pointer;font-size:12px;}
  </style>
</head>
<body>
  <div class="wrap">
    <section class="hero">
      <span class="badge">⚡ API-only • Firebase rules kerak emas</span>
      <h1>LeaderMath.uz</h1>
      <p class="sub">1 bosishda ro‘yxatdan o‘ting: <b>6 xonali ID</b> + <b>random parol</b>. Profil: ism, familiya, viloyat, tuman, tug‘ilgan sana, points.</p>
      <p class="hint">Hamma ma’lumot faqat <b>users</b> collection’da saqlanadi.</p>
    </section>

    <section class="panel">
      <div class="topline">
        <div style="font-weight:900;font-size:16px;">Kirish / Ro‘yxatdan o‘tish</div>
        <button class="smallbtn" id="btn-clear">Cache tozalash</button>
      </div>

      <div class="tabs">
        <button class="tab active" id="tab-login">Kirish</button>
        <button class="tab" id="tab-register">1 bosishda ID olish</button>
      </div>

      <div class="err" id="err"></div>

      <form class="form" id="loginForm" autocomplete="on">
        <div class="row">
          <label>ID (6 xonali)</label>
          <input id="loginId" inputmode="numeric" placeholder="Masalan: 123456" maxlength="6" />
        </div>
        <div class="row">
          <label>Parol</label>
          <input id="loginPw" type="password" placeholder="Parolni kiriting" />
        </div>
        <button class="btn" type="submit">Kirish</button>
        <p class="hint">Agar login bo‘lsa ham qayta login chiqsa — “Cache tozalash”ni bosing.</p>
      </form>

      <div class="form" id="regBox" style="display:none;">
        <button class="btn" id="btnRegister" type="button">ID + Parol yaratish</button>
        <button class="btn secondary" id="btnGo" type="button" style="display:none;">Portalga kirish</button>

        <div class="creds" id="creds">
          <div class="kv"><span>ID</span><b id="newId">—</b></div>
          <div class="kv"><span>Parol</span><b id="newPw">—</b></div>
          <p class="hint">ID va parolni yo‘qotmang. Keyin profil ichida parolni almashtira olasiz.</p>
        </div>
      </div>
    </section>
  </div>

  <script src="assets/api-client.js"></script>
  <script src="assets/auth-client.js"></script>
  <script>
    const $ = (id)=>document.getElementById(id);
    const errEl = $('err');

    function showErr(msg){
      errEl.textContent = msg;
      errEl.classList.add('show');
      clearTimeout(errEl.__t);
      errEl.__t = setTimeout(()=>errEl.classList.remove('show'), 4500);
    }

    function goAfterAuth(){
      const p = new URLSearchParams(location.search);
      const r = p.get('redirect');
      if (r){
        try{
          const u = new URL(r, location.origin);
          if (u.origin === location.origin) return location.replace(u.href);
        }catch(e){}
      }
      location.replace('index.html');
    }

    $('tab-login').onclick = ()=>{
      $('tab-login').classList.add('active');
      $('tab-register').classList.remove('active');
      $('loginForm').style.display='';
      $('regBox').style.display='none';
    };
    $('tab-register').onclick = ()=>{
      $('tab-register').classList.add('active');
      $('tab-login').classList.remove('active');
      $('loginForm').style.display='none';
      $('regBox').style.display='';
      errEl.classList.remove('show');
    };

    $('loginId').addEventListener('input', (e)=>{
      e.target.value = String(e.target.value||'').replace(/\D/g,'').slice(0,6);
    });

    $('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      errEl.classList.remove('show');

      const id = $('loginId').value.trim();
      const pw = $('loginPw').value.trim();

      if (id.length !== 6) return showErr("ID 6 xonali bo‘lsin.");
      if (!pw) return showErr("Parolni kiriting.");

      try{
        await lmAuth.login(id, pw);
        goAfterAuth();
      }catch(ex){
        showErr(ex?.message || "Kirishda xatolik");
      }
    });

    $('btnRegister').onclick = async ()=>{
      errEl.classList.remove('show');
      try{
        const out = await lmAuth.register();
        $('newId').textContent = out.loginId;
        $('newPw').textContent = out.password;
        $('creds').classList.add('show');
        $('btnGo').style.display='';
      }catch(ex){
        showErr(ex?.message || "Ro‘yxatdan o‘tishda xatolik");
      }
    };
    $('btnGo').onclick = ()=>goAfterAuth();

    $('btn-clear').onclick = ()=>{
      try{ localStorage.removeItem('lm_session'); }catch(e){}
      showErr("Cache tozalandi. Endi qayta kirib ko‘ring.");
    };

    (async ()=>{
      const u = await lmAuth.load();
      if (u) goAfterAuth();
    })();
  </script>
</body>
</html>
