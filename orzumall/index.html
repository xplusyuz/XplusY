<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Shop</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .product-card {
            transition: transform 0.3s;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .cart-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .admin-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Admin Button (only for specific user) -->
        <div id="adminButton" class="admin-btn" style="display: none;">
            <a href="admin.html" class="btn btn-primary">Admin Panel</a>
        </div>

        <!-- Cart Badge -->
        <div class="cart-badge">
            <button class="btn btn-success position-relative" onclick="viewCart()">
                üõí Cart
                <span id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
            </button>
        </div>

        <h1 class="text-center mb-4">üõçÔ∏è Telegram Shop</h1>
        
        <!-- Products Grid -->
        <div class="row" id="productsContainer">
            <!-- Products will be loaded here -->
        </div>

        <!-- Cart Modal -->
        <div class="modal fade" id="cartModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">üõí Your Cart</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="cartItems"></div>
                        <hr>
                        <h5>Total: $<span id="cartTotal">0</span></h5>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="checkout()">Checkout</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const SUPABASE_URL = "https://wxxfjklwgnxuvxhrs.supabase.co";
        const SUPABASE_KEY = "sb_publishable__b8F70lFPo2LaQrDjW7dcA_nP5m3HDn";
        const ADMIN_USER_ID = "2049065724";

        const supabase = window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let telegramUserId = null;
        let cart = [];

        // Initialize Telegram Web App
        if (window.Telegram && Telegram.WebApp) {
            Telegram.WebApp.ready();
            telegramUserId = Telegram.WebApp.initDataUnsafe.user?.id;
            
            // Show admin button for specific user
            if (telegramUserId && telegramUserId.toString() === ADMIN_USER_ID) {
                document.getElementById('adminButton').style.display = 'block';
            }
            
            // Register user
            registerUser();
        } else {
            // For testing without Telegram
            telegramUserId = prompt("Enter Telegram User ID (for testing):");
            if (telegramUserId === ADMIN_USER_ID) {
                document.getElementById('adminButton').style.display = 'block';
            }
            registerUser();
        }

        // Register or get user
        async function registerUser() {
            if (!telegramUserId) return;
            
            const { data, error } = await supabase
                .from('users')
                .upsert({
                    telegram_id: telegramUserId,
                    created_at: new Date().toISOString()
                })
                .select();
            
            if (error) {
                console.error('Error registering user:', error);
            } else {
                console.log('User registered:', data);
                loadProducts();
            }
        }

        // Load products
        async function loadProducts() {
            const { data, error } = await supabase
                .from('products')
                .select('*')
                .eq('available', true)
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error('Error loading products:', error);
                return;
            }
            
            const container = document.getElementById('productsContainer');
            container.innerHTML = '';
            
            data.forEach(product => {
                const productCard = `
                    <div class="col-md-4 mb-4">
                        <div class="card product-card h-100">
                            <img src="${product.image_url || 'https://via.placeholder.com/300x200?text=Product'}" 
                                 class="card-img-top" 
                                 style="height: 200px; object-fit: cover;"
                                 alt="${product.name}">
                            <div class="card-body">
                                <h5 class="card-title">${product.name}</h5>
                                <p class="card-text">${product.description || ''}</p>
                                <p class="card-text"><strong>Price: $${product.price}</strong></p>
                                <button class="btn btn-primary w-100" onclick="addToCart(${product.id}, '${product.name}', ${product.price}, '${product.image_url || ''}')">
                                    Add to Cart
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += productCard;
            });
        }

        // Cart functions
        function addToCart(productId, name, price, image) {
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    id: productId,
                    name: name,
                    price: price,
                    image: image,
                    quantity: 1
                });
            }
            
            updateCartDisplay();
        }

        function updateCartDisplay() {
            const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartCount').textContent = cartCount;
        }

        function viewCart() {
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p>Your cart is empty</p>';
                cartTotal.textContent = '0';
            } else {
                let total = 0;
                cartItems.innerHTML = '';
                
                cart.forEach((item, index) => {
                    total += item.price * item.quantity;
                    cartItems.innerHTML += `
                        <div class="d-flex align-items-center mb-2">
                            <img src="${item.image || 'https://via.placeholder.com/50x50?text=Prod'}" 
                                 class="rounded me-3" 
                                 style="width: 50px; height: 50px; object-fit: cover;">
                            <div class="flex-grow-1">
                                <h6>${item.name}</h6>
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${index}, -1)">-</button>
                                    <span class="mx-2">${item.quantity}</span>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${index}, 1)">+</button>
                                    <span class="ms-3">$${item.price * item.quantity}</span>
                                </div>
                            </div>
                            <button class="btn btn-danger btn-sm" onclick="removeFromCart(${index})">√ó</button>
                        </div>
                    `;
                });
                
                cartTotal.textContent = total.toFixed(2);
            }
            
            new bootstrap.Modal(document.getElementById('cartModal')).show();
        }

        function updateQuantity(index, change) {
            cart[index].quantity += change;
            
            if (cart[index].quantity <= 0) {
                cart.splice(index, 1);
            }
            
            updateCartDisplay();
            viewCart(); // Refresh cart view
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartDisplay();
            viewCart(); // Refresh cart view
        }

        // Checkout function
        async function checkout() {
            if (!telegramUserId) {
                alert('Please login with Telegram');
                return;
            }
            
            if (cart.length === 0) {
                alert('Cart is empty!');
                return;
            }
            
            try {
                // Create order
                const { data: order, error: orderError } = await supabase
                    .from('orders')
                    .insert({
                        telegram_id: telegramUserId,
                        total_amount: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                        status: 'pending',
                        created_at: new Date().toISOString()
                    })
                    .select();
                
                if (orderError) throw orderError;
                
                // Add order items
                const orderItems = cart.map(item => ({
                    order_id: order[0].id,
                    product_id: item.id,
                    quantity: item.quantity,
                    price: item.price
                }));
                
                const { error: itemsError } = await supabase
                    .from('order_items')
                    .insert(orderItems);
                
                if (itemsError) throw itemsError;
                
                // Clear cart
                cart = [];
                updateCartDisplay();
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('cartModal')).hide();
                
                alert('Order placed successfully! Order ID: ' + order[0].id);
                
            } catch (error) {
                console.error('Checkout error:', error);
                alert('Error placing order. Please try again.');
            }
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', () => {
            if (!telegramUserId) {
                telegramUserId = localStorage.getItem('test_user_id');
                if (telegramUserId === ADMIN_USER_ID) {
                    document.getElementById('adminButton').style.display = 'block';
                }
                loadProducts();
            }
        });
    </script>
</body>
</html>