<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin ‚Äî Shop + Orders</title>
  <link rel="icon" href="favicon.ico">
  <meta name="theme-color" content="#2E8B57">
  <style>
    :root{
      --bg:#070A10; --text:#EAF0FF; --muted:#A9B3CC; --line:rgba(255,255,255,.10);
      --brand:#2E8B57; --brand2:#20C997; --shadow:0 18px 50px rgba(0,0,0,.45); --danger:#ff4d4d;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);
      background:radial-gradient(900px 420px at 20% -10%, rgba(46,139,87,.35), transparent 60%),
                 radial-gradient(900px 420px at 90% 0%, rgba(32,201,151,.18), transparent 65%),
                 var(--bg);}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);padding:14px;border-radius:22px;box-shadow:var(--shadow);}
    .top h1{margin:0;font-size:16px}
    .top small{color:var(--muted)}
    .btn{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--text);
      border-radius:14px;padding:10px 12px;cursor:pointer;font-weight:900}
    .btn.primary{border-color:rgba(32,201,151,.28);background:linear-gradient(135deg, rgba(46,139,87,.40), rgba(32,201,151,.18))}
    .btn.danger{border-color:rgba(255,77,77,.30)}
    .grid{margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid var(--line);border-radius:22px;background:rgba(255,255,255,.04);box-shadow:var(--shadow);overflow:hidden}
    .cardHead{padding:14px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .cardHead h2{margin:0;font-size:14px}
    .cardBody{padding:14px}
    .note{color:var(--muted);font-size:12.5px;line-height:1.35}
    .pill{font-size:11px;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:var(--muted);
      background:rgba(0,0,0,.22);display:inline-block;margin-left:6px}
    .list{display:grid;gap:10px;margin-top:10px}
    .item{border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);border-radius:18px;padding:12px;
      display:flex;gap:10px;align-items:center;justify-content:space-between}
    .meta{min-width:0}
    .meta b{display:block;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta span{display:block;color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .tools{display:flex;gap:8px;flex:0 0 auto;align-items:center}
    .mini{width:38px;height:38px;border-radius:14px;display:grid;place-items:center;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);cursor:pointer;user-select:none;font-weight:900}
    .mini.primary{border-color:rgba(32,201,151,.28)}
    .field{display:grid;gap:6px;margin:10px 0}
    label{color:var(--muted);font-size:12px}
    input, textarea, select{width:100%;padding:10px 10px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);color:var(--text);outline:none;font-size:14px}
    textarea{min-height:80px;resize:vertical}
    .blocked{margin-top:14px;border:1px solid rgba(255,77,77,.25);background:rgba(255,77,77,.08);border-radius:22px;padding:14px;display:none}
    .row{display:flex;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Admin Panel <span class="pill">shop_nav / filters / products / orders</span></h1>
        <small id="who">Kirish: ‚Äî</small>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn primary" id="btnGoogle">Google bilan kirish</button>
        <button class="btn" id="btnLogout" style="display:none">Chiqish</button>
      </div>
    </div>

    <div class="blocked" id="blocked">
      <b>Ruxsat yo‚Äòq.</b>
      <div class="note">Bu email admin ro‚Äòyxatida emas.</div>
    </div>

    <div class="grid" id="adminUI" style="display:none">
      <div class="card">
        <div class="cardHead">
          <h2>Katta chiplar</h2>
          <button class="btn primary" id="addBig">+ Katta chip</button>
        </div>
        <div class="cardBody">
          <div class="note">O‚Äòchirmaymiz: <b>active:false</b> bilan yashiramiz.</div>
          <div class="list" id="bigList"></div>

          <hr style="border:0;border-top:1px solid rgba(255,255,255,.10);margin:14px 0">

          <div id="bigEditor" style="display:none">
            <b>Tanlangan katta chip:</b> <span id="bigSelTitle" class="pill"></span>
            <div class="field">
              <label>Title</label>
              <input id="bigTitle" placeholder="Masalan: Elektronika" />
            </div>
            <div class="row">
              <button class="btn primary" id="saveBig">Saqlash</button>
              <button class="btn" id="toggleBig">Yashirish</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHead">
          <h2>Mayda chiplar (filter)</h2>
          <button class="btn primary" id="addFilter">+ Filter</button>
        </div>
        <div class="cardBody">
          <div class="note">Filterlar faqat tanlangan katta chipga biriktiriladi.</div>
          <div class="list" id="filterList"></div>

          <hr style="border:0;border-top:1px solid rgba(255,255,255,.10);margin:14px 0">

          <div id="filterEditor" style="display:none">
            <b>Tanlangan filter:</b> <span id="filterSelTitle" class="pill"></span>
            <div class="field">
              <label>Title</label>
              <input id="filterTitle" placeholder="Masalan: Telefon" />
            </div>
            <div class="row">
              <button class="btn primary" id="saveFilter">Saqlash</button>
              <button class="btn" id="toggleFilter">Yashirish</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="grid-column: 1 / -1;">
        <div class="cardHead">
          <h2>Mahsulotlar</h2>
          <button class="btn primary" id="addProd">+ Mahsulot</button>
        </div>
        <div class="cardBody">
          <div class="note">Mahsulotlar ham <b>active:false</b> bilan yashiriladi. ‚Äúorder‚Äù bo‚Äòyicha sort.</div>
          <div class="list" id="prodList"></div>

          <hr style="border:0;border-top:1px solid rgba(255,255,255,.10);margin:14px 0">

          <div id="prodEditor" style="display:none">
            <b>Tanlangan mahsulot:</b> <span id="prodSelTitle" class="pill"></span>

            <div class="row">
              <div style="flex:1;min-width:240px" class="field">
                <label>Title</label>
                <input id="pTitle" />
              </div>
              <div style="width:180px" class="field">
                <label>Price</label>
                <input id="pPrice" inputmode="numeric" />
              </div>
              <div style="width:140px" class="field">
                <label>Currency</label>
                <input id="pCur" value="UZS" />
              </div>
            </div>

            <div class="row">
              <div style="flex:1;min-width:240px" class="field">
                <label>Image URL</label>
                <input id="pImg" />
              </div>
              <div style="width:240px" class="field">
                <label>Filter</label>
                <select id="pFilter"></select>
              </div>
            </div>

            <div class="field">
              <label>Description</label>
              <textarea id="pDesc"></textarea>
            </div>

            <div class="row">
              <button class="btn primary" id="saveProd">Saqlash</button>
              <button class="btn" id="toggleProd">Yashirish</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="grid-column: 1 / -1;">
        <div class="cardHead">
          <h2>Buyurtmalar (orders)</h2>
          <span class="note">Yangi buyurtmalar shu yerga tushadi</span>
        </div>
        <div class="cardBody">
          <div class="list" id="ordersList"></div>
          <div class="note" style="margin-top:10px">Status: <b>new ‚Üí processing ‚Üí done</b> yoki <b>cancel</b></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, updateDoc, query, where, orderBy, limit, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    // ====== 1) Firebase config ni o'zingiznikiga almashtiring ======
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // ====== 2) Admin email ro'yxati ======
    const ADMIN_EMAILS = ["sohibjonmath@gmail.com"];

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const who = document.getElementById("who");
    const btnGoogle = document.getElementById("btnGoogle");
    const btnLogout = document.getElementById("btnLogout");
    const blocked = document.getElementById("blocked");
    const adminUI = document.getElementById("adminUI");

    const bigList = document.getElementById("bigList");
    const filterList = document.getElementById("filterList");
    const prodList = document.getElementById("prodList");
    const ordersList = document.getElementById("ordersList");

    const addBig = document.getElementById("addBig");
    const addFilter = document.getElementById("addFilter");
    const addProd = document.getElementById("addProd");

    const bigEditor = document.getElementById("bigEditor");
    const bigSelTitle = document.getElementById("bigSelTitle");
    const bigTitle = document.getElementById("bigTitle");
    const saveBig = document.getElementById("saveBig");
    const toggleBig = document.getElementById("toggleBig");

    const filterEditor = document.getElementById("filterEditor");
    const filterSelTitle = document.getElementById("filterSelTitle");
    const filterTitle = document.getElementById("filterTitle");
    const saveFilter = document.getElementById("saveFilter");
    const toggleFilter = document.getElementById("toggleFilter");

    const prodEditor = document.getElementById("prodEditor");
    const prodSelTitle = document.getElementById("prodSelTitle");
    const pTitle = document.getElementById("pTitle");
    const pPrice = document.getElementById("pPrice");
    const pCur = document.getElementById("pCur");
    const pImg = document.getElementById("pImg");
    const pFilter = document.getElementById("pFilter");
    const pDesc = document.getElementById("pDesc");
    const saveProd = document.getElementById("saveProd");
    const toggleProd = document.getElementById("toggleProd");

    let isAdmin = false;
    let bigNav = [];
    let filters = [];
    let prods = [];
    let selectedBigId = "";
    let selectedFilterId = "";
    let selectedProdId = "";

    let unsubBig=null, unsubFilters=null, unsubProds=null, unsubOrders=null;

    const esc = (s)=> String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    const nowOrder = ()=> Math.floor(Date.now()/1000);

    btnGoogle.onclick = async ()=> { await signInWithPopup(auth, provider); };
    btnLogout.onclick = async ()=> { await signOut(auth); };

    onAuthStateChanged(auth, (user)=>{
      const email = user?.email || "";
      who.textContent = user ? ("Kirish: " + email) : "Kirish: ‚Äî";

      isAdmin = !!user && ADMIN_EMAILS.includes(email);
      blocked.style.display = user && !isAdmin ? "block" : "none";
      adminUI.style.display = isAdmin ? "grid" : "none";
      btnLogout.style.display = user ? "inline-block" : "none";

      if(isAdmin) startLive(); else stopLive();
    });

    function stopLive(){
      unsubBig?.(); unsubBig=null;
      unsubFilters?.(); unsubFilters=null;
      unsubProds?.(); unsubProds=null;
      unsubOrders?.(); unsubOrders=null;
      bigNav=[];filters=[];prods=[];
      bigList.innerHTML="";filterList.innerHTML="";prodList.innerHTML="";ordersList.innerHTML="";
      bigEditor.style.display="none";filterEditor.style.display="none";prodEditor.style.display="none";
      selectedBigId="";selectedFilterId="";selectedProdId="";
    }

    function startLive(){
      stopLive();

      unsubBig = onSnapshot(query(collection(db,"shop_nav"), orderBy("order","asc"), limit(200)), (snap)=>{
        bigNav = snap.docs.map(d=>({id:d.id, ...d.data()}));
        renderBigList();
        if(!selectedBigId && bigNav.length) selectBig(bigNav[0].id);
      });

      unsubOrders = onSnapshot(
        query(collection(db,"orders"), orderBy("createdAt","desc"), limit(100)),
        (snap)=>{
          const orders = snap.docs.map(d=>({id:d.id, ...d.data()}));
          renderOrders(orders);
        }
      );
    }

    function renderBigList(){
      bigList.innerHTML="";
      for(const b of bigNav){
        const el = document.createElement("div");
        el.className="item";
        el.innerHTML = `
          <div class="meta">
            <b>${esc(b.title||"‚Äî")}${b.active===false ? ' <span class="pill">OFF</span>' : ""}</b>
            <span>ID: ${esc(b.id)} ¬∑ order: ${esc(b.order)}</span>
          </div>
          <div class="tools"><div class="mini primary" title="Tanlash">‚úé</div></div>
        `;
        el.querySelector(".mini").onclick = ()=> selectBig(b.id);
        bigList.appendChild(el);
      }
    }

    function renderFilterList(){
      filterList.innerHTML="";
      if(!selectedBigId){ filterList.innerHTML=`<div class="note">Avval katta chip tanlang.</div>`; return; }
      for(const f of filters){
        const el = document.createElement("div");
        el.className="item";
        el.innerHTML = `
          <div class="meta">
            <b>${esc(f.title||"‚Äî")}${f.active===false ? ' <span class="pill">OFF</span>' : ""}</b>
            <span>ID: ${esc(f.id)} ¬∑ order: ${esc(f.order)}</span>
          </div>
          <div class="tools"><div class="mini primary" title="Tahrir">‚úé</div></div>
        `;
        el.querySelector(".mini").onclick = ()=> selectFilter(f.id);
        filterList.appendChild(el);
      }
    }

    function renderProdList(){
      prodList.innerHTML="";
      if(!selectedBigId){ prodList.innerHTML=`<div class="note">Avval katta chip tanlang.</div>`; return; }
      for(const p of prods){
        const el = document.createElement("div");
        el.className="item";
        el.innerHTML = `
          <div class="meta">
            <b>${esc(p.title||"‚Äî")}${p.active===false ? ' <span class="pill">OFF</span>' : ""}</b>
            <span>${esc(p.price)} ${esc(p.currency||"UZS")} ¬∑ filterId: ${esc(p.filterId||"all")} ¬∑ order: ${esc(p.order)}</span>
          </div>
          <div class="tools"><div class="mini primary">‚úé</div></div>
        `;
        el.querySelector(".mini").onclick = ()=> selectProd(p.id);
        prodList.appendChild(el);
      }
    }

    function rebuildFilterSelect(selected="all"){
      pFilter.innerHTML="";
      const oAll=document.createElement("option");
      oAll.value="all"; oAll.textContent="Barchasi (all)";
      pFilter.appendChild(oAll);
      for(const f of filters){
        const o=document.createElement("option");
        o.value=f.id; o.textContent=f.title || f.id;
        pFilter.appendChild(o);
      }
      pFilter.value = selected;
    }

    function selectBig(id){
      selectedBigId=id;
      const b=bigNav.find(x=>x.id===id);
      bigSelTitle.textContent=b?.title || id;
      bigTitle.value=b?.title || "";
      bigEditor.style.display="block";
      toggleBig.textContent = (b?.active===false) ? "Yoqish" : "Yashirish";

      unsubFilters?.();
      unsubFilters = onSnapshot(
        query(collection(db,"shop_nav",selectedBigId,"filters"), orderBy("order","asc"), limit(200)),
        (snap)=>{
          filters = snap.docs.map(d=>({id:d.id, ...d.data()}));
          renderFilterList();
          rebuildFilterSelect("all");
        }
      );

      unsubProds?.();
      unsubProds = onSnapshot(
        query(collection(db,"products"), where("bigId","==",selectedBigId), orderBy("order","asc"), limit(500)),
        (snap)=>{
          prods = snap.docs.map(d=>({id:d.id, ...d.data()}));
          renderProdList();
        }
      );

      filterEditor.style.display="none";
      prodEditor.style.display="none";
      selectedFilterId="";
      selectedProdId="";
    }

    function selectFilter(id){
      selectedFilterId=id;
      const f=filters.find(x=>x.id===id);
      filterSelTitle.textContent=f?.title || id;
      filterTitle.value=f?.title || "";
      filterEditor.style.display="block";
      toggleFilter.textContent = (f?.active===false) ? "Yoqish" : "Yashirish";
    }

    function selectProd(id){
      selectedProdId=id;
      const p=prods.find(x=>x.id===id);
      prodSelTitle.textContent=p?.title || id;
      pTitle.value=p?.title || "";
      pPrice.value=p?.price ?? "";
      pCur.value=p?.currency || "UZS";
      pImg.value=p?.img || "";
      pDesc.value=p?.desc || "";
      rebuildFilterSelect(p?.filterId || "all");
      prodEditor.style.display="block";
      toggleProd.textContent = (p?.active===false) ? "Yoqish" : "Yashirish";
    }

    addBig.onclick = async ()=>{
      const title = prompt("Katta chip nomi?");
      if(!title) return;
      const ref = doc(collection(db,"shop_nav"));
      await setDoc(ref, { title, order: nowOrder(), active:true, createdAt: serverTimestamp() });
      selectBig(ref.id);
    };

    addFilter.onclick = async ()=>{
      if(!selectedBigId) return alert("Avval katta chip tanlang.");
      const title = prompt("Filter nomi?");
      if(!title) return;
      const ref = doc(collection(db,"shop_nav",selectedBigId,"filters"));
      await setDoc(ref, { title, order: nowOrder(), active:true, createdAt: serverTimestamp() });
      selectFilter(ref.id);
    };

    addProd.onclick = async ()=>{
      if(!selectedBigId) return alert("Avval katta chip tanlang.");
      const title = prompt("Mahsulot nomi?");
      if(!title) return;
      const ref = doc(collection(db,"products"));
      await setDoc(ref, {
        title, price:0, currency:"UZS", img:"", desc:"",
        bigId:selectedBigId, filterId:"all",
        order: nowOrder(), active:true, createdAt: serverTimestamp()
      });
      selectProd(ref.id);
    };

    saveBig.onclick = async ()=>{
      if(!selectedBigId) return;
      await updateDoc(doc(db,"shop_nav",selectedBigId), { title: bigTitle.value.trim() });
    };
    toggleBig.onclick = async ()=>{
      const b=bigNav.find(x=>x.id===selectedBigId);
      const next = (b?.active===false) ? true : false;
      await updateDoc(doc(db,"shop_nav",selectedBigId), { active: next });
    };

    saveFilter.onclick = async ()=>{
      if(!selectedBigId || !selectedFilterId) return;
      await updateDoc(doc(db,"shop_nav",selectedBigId,"filters",selectedFilterId), { title: filterTitle.value.trim() });
    };
    toggleFilter.onclick = async ()=>{
      const f=filters.find(x=>x.id===selectedFilterId);
      const next = (f?.active===false) ? true : false;
      await updateDoc(doc(db,"shop_nav",selectedBigId,"filters",selectedFilterId), { active: next });
    };

    saveProd.onclick = async ()=>{
      if(!selectedProdId) return;
      const price = Number(String(pPrice.value||"0").replace(/[^\d.]/g,"")) || 0;
      await updateDoc(doc(db,"products",selectedProdId), {
        title: pTitle.value.trim(),
        price,
        currency: (pCur.value.trim() || "UZS"),
        img: pImg.value.trim(),
        desc: pDesc.value.trim(),
        filterId: pFilter.value || "all"
      });
    };
    toggleProd.onclick = async ()=>{
      const p=prods.find(x=>x.id===selectedProdId);
      const next = (p?.active===false) ? true : false;
      await updateDoc(doc(db,"products",selectedProdId), { active: next });
    };

    function renderOrders(orders){
      ordersList.innerHTML="";
      if(!orders.length){
        ordersList.innerHTML = `<div class="note">Buyurtmalar yo‚Äòq.</div>`;
        return;
      }
      for(const o of orders){
        const el=document.createElement("div");
        el.className="item";
        const itemsCount = Array.isArray(o.items) ? o.items.reduce((s,x)=>s+(Number(x.qty)||0),0) : 0;
        const name = o.customer?.name ? ` ¬∑ ${esc(o.customer.name)}` : "";
        const phone = o.customer?.phone ? ` ¬∑ ${esc(o.customer.phone)}` : "";

        el.innerHTML = `
          <div class="meta">
            <b>${esc(o.userId||"‚Äî")}${name} <span class="pill">${esc(o.status||"new")}</span></b>
            <span>${esc(o.orderId||o.id)} ¬∑ ${esc(o.total||0)} ${esc(o.currency||"UZS")} ¬∑ ${itemsCount} ta${phone}</span>
          </div>
          <div class="tools">
            <select class="mini" style="width:auto;padding:0 10px;height:38px">
              <option value="new">new</option>
              <option value="processing">processing</option>
              <option value="done">done</option>
              <option value="cancel">cancel</option>
            </select>
            <div class="mini primary" title="Saqlash">üíæ</div>
          </div>
        `;
        const sel = el.querySelector("select");
        sel.value = o.status || "new";
        el.querySelector(".mini.primary").onclick = async ()=>{
          await updateDoc(doc(db,"orders",o.id), { status: sel.value, updatedAt: serverTimestamp() });
        };
        ordersList.appendChild(el);
      }
    }
  </script>
</body>
</html>
