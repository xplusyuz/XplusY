<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Reyting — Points</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    :root{--primary:#2E8B57;--gray-200:#e5e7eb;--shadow:0 10px 30px rgba(0,0,0,.08)}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Roboto,sans-serif;color:#111;background:#fff}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    h1{font-family:Montserrat,sans-serif;margin:8px 0 14px}
    .card{border:1px solid var(--gray-200);border-radius:14px;box-shadow:var(--shadow);background:#fff}
    .card__body{padding:16px}
    .btn{border:1px solid var(--gray-200);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:#6b7280}
    .err{color:#b91c1c;font-size:13px;margin-top:8px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid var(--gray-200);text-align:left;font-size:14px}
    th{font-weight:700}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin:10px 0}
    .rank-1 td,.rank-2 td,.rank-3 td{background:#fff7ed}
  </style>
</head>
<body>
  <main class="container">
    <h1><i class="fa-solid fa-trophy"></i> Reyting — Points</h1>

    <section class="card">
      <div class="card__body">
        <div class="toolbar">
          <div class="muted">Manba: <code>users</code> kolleksiyasi, <code>orderBy(points desc)</code></div>
          <div style="display:flex;gap:8px">
            <button id="btnRefresh" class="btn"><i class="fa-solid fa-rotate"></i> Yangilash</button>
            <button id="btnMore" class="btn"><i class="fa-solid fa-angles-down"></i> Yana yuklash</button>
          </div>
        </div>

        <div style="overflow:auto">
          <table id="tbl">
            <thead>
              <tr>
                <th>#</th>
                <th>Foydalanuvchi</th>
                <th>Email</th>
                <th>Points</th>
                <th>Yangilangan</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div id="empty" class="muted" style="display:none;margin-top:10px">Ma’lumot topilmadi.</div>
        <div id="error" class="err" style="display:none"></div>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, getDocs, startAfter } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // Firebase config (sizniki)
    const firebaseConfig = {
      apiKey:"AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
      authDomain:"xplusy-760fa.firebaseapp.com",
      projectId:"xplusy-760fa",
      storageBucket:"xplusy-760fa.firebasestorage.app",
      messagingSenderId:"992512966017",
      appId:"1:992512966017:web:5e919dbc9b8d8abcb43c80",
      measurementId:"G-459PLJ7P7L"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const tbody = document.getElementById('tbody');
    const btnRefresh = document.getElementById('btnRefresh');
    const btnMore = document.getElementById('btnMore');
    const empty = document.getElementById('empty');
    const errEl = document.getElementById('error');

    const PAGE_SIZE = 50;
    let lastDoc = null;
    let rankOffset = 0;

    function showError(msg){ errEl.style.display = msg ? 'block' : 'none'; errEl.textContent = msg || ''; }
    function showEmpty(v){ empty.style.display = v ? 'block' : 'none'; }
    function clearTable(){ tbody.innerHTML=''; lastDoc=null; rankOffset=0; }

    function fmtTs(ts){
      try{
        const d = ts?.toDate ? ts.toDate() : (ts?.toMillis ? new Date(ts.toMillis()) : null);
        return d ? d.toLocaleString('uz-UZ') : '—';
      }catch{ return '—'; }
    }

    function appendRow(i, u){
      const tr = document.createElement('tr');
      if (i<=3) tr.classList.add(`rank-${i}`);
      tr.innerHTML = `
        <td>${i}</td>
        <td>${u.displayName || 'Noma’lum'}</td>
        <td>${u.email || '—'}</td>
        <td>${u.points ?? 0}</td>
        <td>${fmtTs(u.updatedAt)}</td>
      `;
      tbody.appendChild(tr);
    }

    async function loadPage(reset=false){
      if (reset) clearTable();
      showError('');
      try {
        let qy = null;
        if (lastDoc){
          qy = query(collection(db,'users'), orderBy('points','desc'), limit(PAGE_SIZE), startAfter(lastDoc));
        } else {
          qy = query(collection(db,'users'), orderBy('points','desc'), limit(PAGE_SIZE));
        }
        const snap = await getDocs(qy);
        if (snap.empty && rankOffset===0){ showEmpty(true); btnMore.disabled=true; return; }

        let i=0;
        snap.forEach((doc)=> {
          i++;
          const d = doc.data();
          appendRow(rankOffset+i, d);
        });

        rankOffset += i;
        lastDoc = snap.docs[snap.docs.length-1] || lastDoc;
        btnMore.disabled = (i < PAGE_SIZE);
        showEmpty(false);
      } catch (e) {
        console.error(e);
        showError('Yuklashda xato: ' + (e?.message || 'noma’lum'));
        if (rankOffset===0) showEmpty(true);
      }
    }

    btnRefresh.addEventListener('click', ()=> loadPage(true));
    btnMore.addEventListener('click', ()=> loadPage(false));
    loadPage(true);
  </script>
</body>
</html>
