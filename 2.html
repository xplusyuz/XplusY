<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Online Test – Pullik kirish (yakuniy)</title>
  <style>
    :root{ 
      --bg:#0b1220; 
      --panel:#0f172a; 
      --muted:#94a3b8; 
      --text:#e5e7eb; 
      --accent:#22c55e; 
      --danger:#ef4444; 
      --warning:#f59e0b;
      --info:#3b82f6;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;line-height:1.6}

    /* App shell */
    .topbar{
      position:sticky;
      top:0;
      background:#0b1220cc;
      backdrop-filter:saturate(1.1) blur(6px);
      border-bottom:1px solid #1f2937;
      z-index:5
    }
    .topbar-inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 16px
    }
    .brand{font-weight:700;letter-spacing:.2px}
    .pill{
      padding:6px 10px;
      border:1px solid #273043;
      border-radius:999px;
      font-size:13px;
      color:var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #timer{
      font-weight:800;
      color: var(--text);
      min-width: 50px;
      text-align: center;
    }
    .time-warning{color: var(--warning)}
    .time-danger{color: var(--danger); animation: pulse 1s infinite}

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .container{
      max-width:1200px;
      margin:0 auto;
      padding:16px;
      height: calc(100vh - 60px);
      overflow: hidden;
    }

    /* PAGE DIM (modal paytida fon dim, modal tiniq) */
    #app.dimmed{opacity:.25;filter:saturate(.9);pointer-events: none;}

    /* Layout 30% / 70% */
    .test-layout{
      display:grid;
      grid-template-columns:30% 70%;
      gap:16px;
      align-items:stretch;
      height: 100%;
    }
    @media (max-width:900px){
      .test-layout{
        grid-template-columns:1fr;
        grid-template-rows: auto 1fr;
      }
    }
    .panel{
      background:var(--panel);
      border:1px solid #1f2937;
      border-radius:16px;
      padding:16px;
      overflow: auto;
    }

    /* Left: index grid (5 per row) */
    .q-grid{
      display:grid;
      grid-template-columns:repeat(5, 1fr);
      gap:8px;
      margin-bottom: 16px;
    }
    .q-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height:38px;
      border-radius:10px;
      border:1px solid #334155;
      background:#0b1220;
      color:#cbd5e1;
      cursor:pointer;
      font-weight:700;
      transition: all 0.2s ease;
    }
    .q-btn:hover{
      filter:brightness(1.1);
      transform: translateY(-2px);
    }
    .q-btn.active{
      outline:2px solid var(--accent);
      transform: scale(1.05);
    }
    .q-btn.answered{
      background:#1a2a18;
      border-color:#234323;
      color:#bde3b8;
    }
    .q-btn.marked{
      background:#2a2539;
      border-color:#5b21b6;
      color:#d8b4fe;
      position: relative;
    }
    .q-btn.marked::after {
      content: "!";
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--info);
      color: white;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Question counter */
    .question-counter {
      display: flex;
      justify-content: space-between;
      margin-bottom: 16px;
      padding: 8px 0;
      border-bottom: 1px solid #1f2937;
    }
    .counter-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }
    .color-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    .answered-dot { background: #1a2a18; }
    .marked-dot { background: #5b21b6; }
    .current-dot { background: var(--accent); }

    /* Right: Question view */
    .q-stem{
      font-size:18px;
      line-height:1.5;
      margin-bottom: 16px;
    }
    .options{
      display:grid;
      gap:10px;
      margin-top:14px;
    }
    .opt{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:12px;
      border:1px solid #273043;
      border-radius:12px;
      background:#0c1524;
      cursor:pointer;
      transition: all 0.2s ease;
    }
    .opt:hover {
      border-color: #3b82f6;
      background: #0f1e3a;
    }
    .opt input{
      margin-top:4px;
      cursor: pointer;
    }

    .controls{
      display:flex;
      gap:8px;
      margin-top:24px;
      flex-wrap:wrap;
    }
    .btn{
      padding:10px 14px;
      border-radius:10px;
      border:1px solid #273043;
      background:#0b1220;
      color:#e5e7eb;
      cursor:pointer;
      transition: all 0.2s ease;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .btn.primary{
      background:var(--accent);
      border-color:#16a34a;
      color:#0a0a0a;
      font-weight:800;
    }
    .btn.danger{
      background:var(--danger);
      border-color:#b91c1c;
    }
    .btn:disabled{
      opacity:.6;
      cursor:not-allowed;
    }

    /* Mark button */
    .mark-btn {
      margin-left: auto;
      background: var(--info);
      border-color: #1d4ed8;
    }

    /* Modal */
    .overlay{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.75);
      backdrop-filter:blur(4px);
      z-index:9999;
      padding: 16px;
    }
    .card{
      background:#0b1220;
      border:1px solid #273043;
      border-radius:18px;
      padding:24px;
      width:min(560px,92vw);
      box-shadow:0 10px 30px rgba(0,0,0,.4);
      max-height: 90vh;
      overflow-y: auto;
    }
    .card h2{
      margin:0 0 10px;
      font-size:20px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .muted{
      color:var(--muted);
      font-size:13px;
    }
    .big{
      font-size:64px;
      font-weight:900;
      text-align:center;
      line-height:1;
    }

    /* Results */
    .results-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin: 16px 0;
    }
    .result-card {
      background: #0c1524;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    .result-value {
      font-size: 24px;
      font-weight: 800;
      margin: 8px 0;
    }
    .result-label {
      font-size: 13px;
      color: var(--muted);
    }
    .correct { color: var(--accent); }
    .incorrect { color: var(--danger); }
    .skipped { color: var(--muted); }

    .detailed-results {
      margin-top: 24px;
    }
    .result-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid #1f2937;
    }
    .result-item:last-child {
      border-bottom: none;
    }
    .result-status {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    .status-correct { background: var(--accent); color: #000; }
    .status-incorrect { background: var(--danger); color: #fff; }
    .status-skipped { background: var(--muted); color: #000; }

    /* Hidden bank */
    #qBank{display:none}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">Online Test</div>
      <div class="pill">Vaqt: <span id="timer">--:--</span></div>
    </div>
  </div>

  <div class="container">
    <div id="app" class="dimmed">
      <div class="test-layout">
        <aside class="panel">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px">
            <div style="font-weight:700">Savollar</div>
            <div class="muted">Har qatorda 5 ta</div>
          </div>
          
          <div class="question-counter">
            <div class="counter-item">
              <span class="color-dot answered-dot"></span>
              <span class="muted">Javob</span>
            </div>
            <div class="counter-item">
              <span class="color-dot marked-dot"></span>
              <span class="muted">Belgi</span>
            </div>
            <div class="counter-item">
              <span class="color-dot current-dot"></span>
              <span class="muted">Joriy</span>
            </div>
          </div>
          
          <div id="qGrid" class="q-grid"></div>
          
          <div class="controls">
            <button id="submitBtn" class="btn danger">Yakunlash</button>
          </div>
        </aside>
        <main class="panel">
          <div id="qView">
            <div class="q-stem" id="qStem">Boshlashga tayyor.</div>
            <div class="options" id="qOpts"></div>
            <div class="controls">
              <button id="prevBtn" class="btn">← Oldingi</button>
              <button id="markBtn" class="btn mark-btn">Belgilash</button>
              <button id="nextBtn" class="btn">Keyingi →</button>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>

  <!-- Overlay container (modal) -->
  <div id="overlay" class="overlay" hidden>
    <div class="card" id="bootCard">
      <h2>Tekshirilmoqda…</h2>
      <div class="muted">Hisob holati yuklanmoqda</div>
    </div>
    <noscript>
      <div class="card"><h2>JavaScript o‘chiq</h2><div class="muted">Iltimos, JS-ni yoqing.</div></div>
    </noscript>
  </div>

  <!-- SAVOLLAR – HTML ICHIDA -->
  <section id="qBank">
    <!-- 1 -->
    <div class="question" data-id="1">
      <div class="stem">$2^2 + 3^2$ qiymatini toping.</div>
      <label class="opt"><input type="radio" name="q1"> 13</label>
      <label class="opt"><input type="radio" name="q1"> 11</label>
      <label class="opt"><input type="radio" name="q1"> 12</label>
      <label class="opt"><input type="radio" name="q1"> 10</label>
      <input type="hidden" class="answer" value="0" />
    </div>
    <!-- 2 -->
    <div class="question" data-id="2">
      <div class="stem">$\sqrt{81}$ qiymatini toping.</div>
      <label class="opt"><input type="radio" name="q2"> 8</label>
      <label class="opt"><input type="radio" name="q2"> 9</label>
      <label class="opt"><input type="radio" name="q2"> 7</label>
      <label class="opt"><input type="radio" name="q2"> 6</label>
      <input type="hidden" class="answer" value="1" />
    </div>
    <!-- 3 -->
    <div class="question" data-id="3">
      <div class="stem">$\dfrac{1}{2}+\dfrac{1}{3}$ ni soddalashtiring.</div>
      <label class="opt"><input type="radio" name="q3"> $\dfrac{5}{6}$</label>
      <label class="opt"><input type="radio" name="q3"> $\dfrac{2}{5}$</label>
      <label class="opt"><input type="radio" name="q3"> $\dfrac{1}{5}$</label>
      <label class="opt"><input type="radio" name="q3"> $\dfrac{3}{5}$</label>
      <input type="hidden" class="answer" value="0" />
    </div>
    <!-- 4 -->
    <div class="question" data-id="4">
      <div class="stem">Agar $x=3$ bo'lsa, $x^2+2x$ ?</div>
      <label class="opt"><input type="radio" name="q4"> 15</label>
      <label class="opt"><input type="radio" name="q4"> 12</label>
      <label class="opt"><input type="radio" name="q4"> 18</label>
      <label class="opt"><input type="radio" name="q4"> 9</label>
      <input type="hidden" class="answer" value="0" />
    </div>
    <!-- 5 -->
    <div class="question" data-id="5">
      <div class="stem">$\log_{10} 100$ ?</div>
      <label class="opt"><input type="radio" name="q5"> 1</label>
      <label class="opt"><input type="radio" name="q5"> 2</label>
      <label class="opt"><input type="radio" name="q5"> 10</label>
      <label class="opt"><input type="radio" name="q5"> 0</label>
      <input type="hidden" class="answer" value="1" />
    </div>
    <!-- 6-10 -->
    <div class="question" data-id="6">
      <div class="stem">Tenglamani yeching: $2x + 5 = 15$</div>
      <label class="opt"><input type="radio" name="q6"> 5</label>
      <label class="opt"><input type="radio" name="q6"> 10</label>
      <label class="opt"><input type="radio" name="q6"> 7.5</label>
      <label class="opt"><input type="radio" name="q6"> 20</label>
      <input type="hidden" class="answer" value="0" />
    </div>
    <div class="question" data-id="7">
      <div class="stem">$3^3$ qiymati nimaga teng?</div>
      <label class="opt"><input type="radio" name="q7"> 9</label>
      <label class="opt"><input type="radio" name="q7"> 6</label>
      <label class="opt"><input type="radio" name="q7"> 27</label>
      <label class="opt"><input type="radio" name="q7"> 12</label>
      <input type="hidden" class="answer" value="2" />
    </div>
    <div class="question" data-id="8">
      <div class="stem">Agar $a = 4$, $b = 7$ bo'lsa, $a \times b$ qiymati qanday?</div>
      <label class="opt"><input type="radio" name="q8"> 11</label>
      <label class="opt"><input type="radio" name="q8"> 28</label>
      <label class="opt"><input type="radio" name="q8"> 3</label>
      <label class="opt"><input type="radio" name="q8"> 47</label>
      <input type="hidden" class="answer" value="1" />
    </div>
    <div class="question" data-id="9">
      <div class="stem">$\dfrac{3}{4}$ kasrni o'nlik ko'rinishida yozing.</div>
      <label class="opt"><input type="radio" name="q9"> 0.25</label>
      <label class="opt"><input type="radio" name="q9"> 0.5</label>
      <label class="opt"><input type="radio" name="q9"> 0.75</label>
      <label class="opt"><input type="radio" name="q9"> 0.34</label>
      <input type="hidden" class="answer" value="2" />
    </div>
    <div class="question" data-id="10">
      <div class="stem">$5!$ (5 faktorial) qiymatini toping.</div>
      <label class="opt"><input type="radio" name="q10"> 25</label>
      <label class="opt"><input type="radio" name="q10"> 120</label>
      <label class="opt"><input type="radio" name="q10"> 15</label>
      <label class="opt"><input type="radio" name="q10"> 60</label>
      <input type="hidden" class="answer" value="1" />
    </div>
    <!-- Qolgan 20 ta savol shu formatda qo'shiladi -->
  </section>

  <!-- MathJax -->
  <script>
    window.MathJax = { 
      tex: { 
        inlineMath: [["$","$"],["\\(","\\)"]], 
        displayMath: [["$$","$$"],["\\[","\\]"]] 
      }, 
      svg: { 
        fontCache: 'global' 
      } 
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>

  <!-- Firebase + Test logika (MODULAR) -->
  <script type="module">
  import { initializeApp, getApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
  import { getFirestore, doc, getDoc, writeBatch, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

  // === Mahsulot ===
  const PRODUCT_ID = 'onlinetest1-access';
  const PRICE_UZS  = 20000; // faqat ko'rsatish uchun

  // === Firebase config (sizniki) ===
  const firebaseConfig = {
    apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
    authDomain: "xplusy-760fa.firebaseapp.com",
    projectId: "xplusy-760fa",
    storageBucket: "xplusy-760fa.firebasestorage.app",
    messagingSenderId: "992512966017",
    appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
    measurementId: "G-459PLJ7P7L"
  };
  let app; try { app = getApp(); } catch { app = initializeApp(firebaseConfig); }
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // === UI refs ===
  const $ = s => document.querySelector(s);
  const overlay = $('#overlay');
  const appRoot = $('#app');
  const timerEl = $('#timer');
  const qGrid   = $('#qGrid');
  const qStem   = $('#qStem');
  const qOpts   = $('#qOpts');
  const prevBtn = $('#prevBtn');
  const nextBtn = $('#nextBtn');
  const submitBtn = $('#submitBtn');
  const markBtn = $('#markBtn');

  const fmtUZS = n => new Intl.NumberFormat('uz-UZ').format(Number(n||0)) + " so'm";

  // === Savollarni HTML dan o'qiymiz ===
  const BANK = Array.from(document.querySelectorAll('#qBank .question')).map((node, idx) => {
    const stem   = node.querySelector('.stem')?.innerHTML || '';
    const opts   = Array.from(node.querySelectorAll('.opt')).map(l => l.innerHTML);
    const answer = Number(node.querySelector('.answer')?.value || 0);
    return { id: idx+1, stem, opts, answer };
  });

  // === State ===
  let current = 0;
  let selected = new Array(BANK.length).fill(null);
  let marked = new Array(BANK.length).fill(false);
  let totalSeconds = BANK.length * 120; // har savolga 2 daqiqa
  let timerInt = null;

  function showOverlay(html){ 
    overlay.innerHTML = html; 
    overlay.hidden = false; 
  }
  function hideOverlay(){ 
    overlay.hidden = true; 
    overlay.innerHTML = ''; 
  }

  function renderIndex(){
    qGrid.innerHTML = '';
    BANK.forEach((q, i) => {
      const b = document.createElement('button');
      b.className = 'q-btn';
      if (i === current) b.classList.add('active');
      if (selected[i] !== null) b.classList.add('answered');
      if (marked[i]) b.classList.add('marked');
      b.textContent = q.id;
      b.addEventListener('click', () => go(i));
      qGrid.appendChild(b);
    });
  }

  async function typeset(){
    if (window.MathJax?.typesetPromise) {
      try { await MathJax.typesetPromise([qStem, qOpts]); } catch(e){}
    }
  }

  async function renderQuestion(){
    const q = BANK[current];
    qStem.innerHTML = `<div class="muted">Savol ${current+1}/${BANK.length}</div><div style="margin-top:6px">${q.stem}</div>`;
    qOpts.innerHTML = '';
    q.opts.forEach((inner, idx) => {
      const wrap = document.createElement('label');
      wrap.className = 'opt';
      wrap.innerHTML = `<input type="radio" name="q_${current}" ${selected[current]===idx?'checked':''}> <div>${inner.replace(/^<input[^>]*>/,'')}</div>`;
      wrap.querySelector('input').addEventListener('change', () => { 
        selected[current]=idx; 
        renderIndex(); 
      });
      qOpts.appendChild(wrap);
    });
    
    markBtn.textContent = marked[current] ? "Belgini olib tashlash" : "Belgilash";
    
    await typeset();
    prevBtn.disabled = current===0;
    nextBtn.disabled = current===BANK.length-1;
  }

  function go(i){ 
    current = i; 
    renderIndex(); 
    renderQuestion(); 
  }
  
  function next(){ 
    if(current < BANK.length-1) go(current+1); 
  }
  
  function prev(){ 
    if(current > 0) go(current-1); 
  }
  
  function toggleMark() {
    marked[current] = !marked[current];
    renderIndex();
    renderQuestion();
  }

  function startTimer(){
    updateTimer();
    timerInt = setInterval(() => {
      totalSeconds--; 
      updateTimer();
      if(totalSeconds <= 0){ 
        clearInterval(timerInt); 
        submit(); 
      }
    }, 1000);
  }
  
  function updateTimer(){
    const m = String(Math.floor(totalSeconds/60)).padStart(2,'0');
    const s = String(totalSeconds%60).padStart(2,'0');
    timerEl.textContent = `${m}:${s}`;
    
    // Vaqt kamayganda rang o'zgarishi
    if (totalSeconds <= 60) {
      timerEl.className = 'time-danger';
    } else if (totalSeconds <= 300) {
      timerEl.className = 'time-warning';
    } else {
      timerEl.className = '';
    }
  }

  function score(){ 
    let c = 0;
    BANK.forEach((q, i) => { 
      if(selected[i] === q.answer) c++; 
    }); 
    return { 
      correct: c, 
      total: BANK.length,
      incorrect: BANK.length - c - unansweredCount(),
      skipped: unansweredCount()
    }; 
  }
  
  function unansweredCount() {
    return selected.filter(val => val === null).length;
  }

  function submit(){
    clearInterval(timerInt);
    prevBtn.disabled = nextBtn.disabled = submitBtn.disabled = markBtn.disabled = true;
    const {correct, total, incorrect, skipped} = score();
    
    // Natijalar ko'rinishi
    let resultsHTML = `
      <div class="card">
        <h2>Test natijalari</h2>
        <div class="results-grid">
          <div class="result-card">
            <div class="result-value correct">${correct}/${total}</div>
            <div class="result-label">To'g'ri javoblar</div>
          </div>
          <div class="result-card">
            <div class="result-value incorrect">${incorrect}</div>
            <div class="result-label">Noto'g'ri javoblar</div>
          </div>
          <div class="result-card">
            <div class="result-value skipped">${skipped}</div>
            <div class="result-label">Javobsiz</div>
          </div>
          <div class="result-card">
            <div class="result-value">${Math.round((correct/total)*100)}%</div>
            <div class="result-label">Umumiy ball</div>
          </div>
        </div>
        
        <div class="detailed-results">
          <h3>Batafsil natijalar:</h3>
    `;
    
    BANK.forEach((q, i) => {
      let statusClass = '';
      let statusText = '';
      
      if (selected[i] === null) {
        statusClass = 'status-skipped';
        statusText = 'Javobsiz';
      } else if (selected[i] === q.answer) {
        statusClass = 'status-correct';
        statusText = 'To‘g‘ri';
      } else {
        statusClass = 'status-incorrect';
        statusText = 'Noto‘g‘ri';
      }
      
      resultsHTML += `
        <div class="result-item">
          <span class="result-status ${statusClass}">${i+1}</span>
          <div>
            <div>Savol ${i+1}: ${statusText}</div>
            <div class="muted">To'g'ri javob: ${String.fromCharCode(65 + q.answer)}</div>
          </div>
        </div>
      `;
    });
    
    resultsHTML += `
        </div>
        <div class="row" style="justify-content: center; margin-top: 20px;">
          <button class="btn primary" onclick="location.href='index.html'">Bosh sahifa</button>
        </div>
      </div>
    `;
    
    showOverlay(resultsHTML);
  }
  
  prevBtn.addEventListener('click', prev);
  nextBtn.addEventListener('click', next);
  markBtn.addEventListener('click', toggleMark);
  submitBtn.addEventListener('click', () => { 
    if(confirm(`Testni yakunlamoqchimisiz?${unansweredCount() > 0 ? ` Sizda hali ${unansweredCount()} ta savolga javob bermagansiz.` : ''}`)) submit(); 
  });

  // === Paywall ===
  function payCardHTML(loggedIn){
    return `<div class="card">
      <h2>Testga kirish</h2>
      <div class="row">Narx: <strong>${fmtUZS(PRICE_UZS)}</strong></div>
      <div class="row muted">To'lov balansdan yechiladi. Xariddan so'ng 3–2–1 va test boshlanadi.</div>
      <div class="row">
        ${loggedIn ? `<button id='buyBtn' class='btn primary'>Sotib olish</button>` : `<a class='btn' href='/kirish.html'>Kirish</a>`}
        <a class='btn' href='/balance.html'>Balans</a>
      </div>
    </div>`;
  }
  
  function countdownHTML(n){ 
    return `<div class='card'><div class='big'>${n}</div><div class='muted' style='text-align:center;margin-top:8px'>Boshlanishiga...</div></div>`; 
  }

  async function hasAccess(uid){
    try{
      const snap = await getDoc(doc(db,'purchases', `${uid}_${PRODUCT_ID}`));
      if(!snap.exists()) return false;
      const d = snap.data();
      return !d.expiresAt || d.expiresAt.toDate() > new Date();
    }catch{ return false; }
  }

  // === Functions-free xarid: Firestore Rules orqali balansdan yechish ===
  async function buyAccess(){
    try{
      const user = auth.currentUser;
      if(!user){ location.href = '/kirish.html'; return; }

      const userRef = doc(db,'users',user.uid);
      const uSnap = await getDoc(userRef);
      if(!uSnap.exists()){ alert('Profil topilmadi'); return; }
      const currentBalance = Number(uSnap.data().balance||0);

      const prodSnap = await getDoc(doc(db,'products', PRODUCT_ID));
      if(!prodSnap.exists()){ alert('Mahsulot topilmadi'); return; }
      const price = Number(prodSnap.data().price||0);
      if(!Number.isFinite(price) || price<=0){ alert("Narx noto'g'ri"); return; }
      if(currentBalance < price){ alert('Balans yetarli emas'); return; }

      const batch = writeBatch(db);
      batch.update(userRef, { balance: currentBalance - price, lastPurchase: { productId: PRODUCT_ID } });
      const purRef = doc(db,'purchases', `${user.uid}_${PRODUCT_ID}`);
      batch.set(purRef, { uid: user.uid, productId: PRODUCT_ID, price, ts: serverTimestamp() }, { merge: true });
      await batch.commit();

      await startAfterPurchase();
    }catch(e){
      alert(e.message || 'Xatolik');
    }
  }

  async function startAfterPurchase(){ 
    await startSequence(); 
  }
  
  async function startSequence(){
    showOverlay(countdownHTML(3)); 
    await new Promise(r=>setTimeout(r,1000));
    showOverlay(countdownHTML(2)); 
    await new Promise(r=>setTimeout(r,1000));
    showOverlay(countdownHTML(1)); 
    await new Promise(r=>setTimeout(r,1000));
    hideOverlay(); 
    appRoot.classList.remove('dimmed'); 
    go(0); 
    startTimer();
  }

  async function tryEnter(user){
    if(!user){
      appRoot.classList.add('dimmed');
      showOverlay(payCardHTML(false));
      return;
    }
    if(await hasAccess(user.uid)){
      await startSequence();
    }else{
      appRoot.classList.add('dimmed');
      showOverlay(payCardHTML(true));
      const buyBtn = document.getElementById('buyBtn');
      buyBtn?.addEventListener('click', buyAccess);
    }
  }

  // --- Boot: modal darhol chiqsin; 2.5s ichida auth javobi bo'lmasa ham paycard ko'rsatiladi
  (function boot(){
    try{ appRoot.classList.add('dimmed'); }catch{}
    showOverlay(`<div class='card'><h2>Tekshirilmoqda…</h2><div class='muted'>Hisob holati yuklanmoqda</div></div>`);
    let resolved = false;
    onAuthStateChanged(auth, (user)=>{ resolved = true; tryEnter(user); });
    setTimeout(()=>{ if(!resolved){ tryEnter(auth.currentUser || null); } }, 2500);
  })();

  // Diagnostika: xatolarni modalda ko'rsatish
  window.addEventListener('error', (e)=>{
    showOverlay(`<div class='card'><h2>Xatolik</h2><div class='muted'>${e.message||'Noma’lum xato'}</div></div>`);
  });
  window.addEventListener('unhandledrejection', (e)=>{
    const msg = (e.reason && (e.reason.message || e.reason.toString())) || 'Noma’lum xato';
    showOverlay(`<div class='card'><h2>Xatolik</h2><div class='muted'>${msg}</div></div>`);
  });
  </script>
</body>
</html>