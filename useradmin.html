<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>LeaderMath ‚Äî Admin (Users)</title>
  <meta name="theme-color" content="#2E8B57"/>
  <link rel="icon" href="./favicon.ico">
  <style>
    :root{
      --brand:#2E8B57;--brand2:#1F6B45;--bg:#f5faf7;--text:#0f1a15;
      --card:#ffffff;--muted:#416457;--frame:#d6e7dd;--ring:#8ad1b1;
      --chip:#eaf6f0;--chipb:#cfe7db;--danger:#c62828;--ok:#126e45;
      --radius:14px
    }
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .appbar{position:sticky;top:0;z-index:50;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;display:flex;gap:12px;align-items:center;padding:12px}
    .logo{width:38px;height:38px;border-radius:12px;background:#fff2;display:grid;place-items:center;font-weight:900}
    .sp{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;border:none;border-radius:12px;padding:9px 12px;font-weight:800;cursor:pointer}
    .btn.ghost{background:#ffffff22;border:1px solid #ffffff3a;color:#fff}
    .btn.pri{background:#fff;color:#145a39}
    .wrap{padding:14px;max-width:1200px;margin:auto}
    .card{background:var(--card);border:1px solid var(--frame);border-radius:var(--radius);box-shadow:0 10px 28px #00000010}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;padding:12px;border-bottom:1px solid var(--frame)}
    .tool-input{display:flex;align-items:center;gap:8px;background:var(--chip);border:1px solid var(--chipb);border-radius:12px;padding:8px 10px}
    .tool-input input{border:none;outline:none;background:transparent;font:inherit;min-width:220px}
    .tool-sel{border:1px solid var(--frame);border-radius:12px;padding:8px 10px;background:#fff}
    .row{display:grid;grid-template-columns:110px 1.3fr 1fr 1fr 0.8fr 0.8fr 0.6fr 0.6fr 0.5fr;gap:10px;align-items:center;background:var(--card);border:1px solid var(--frame);border-radius:12px;padding:10px;margin-top:8px}
    .chip2{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--chipb);border-radius:999px;padding:5px 8px;font-size:12px}
    .mut{color:var(--muted);font-size:12px}
    .right{text-align:right}
    .actions{display:flex;gap:6px;justify-content:flex-end}
    .pill{border-radius:10px;padding:6px 9px;border:1px solid var(--frame);background:#fff;cursor:pointer}
    .pill.ok{background:linear-gradient(135deg,#2E8B57,#1F6B45);color:#fff;border:0}
    .mask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:200}
    .modal{width:min(800px,94%);background:#fff;border-radius:16px;border:1px solid var(--frame);padding:16px;max-height:90vh;overflow:auto}
    .forbid{max-width:680px;margin:40px auto;padding:18px}
    .skeleton{height:46px;border-radius:12px;background:linear-gradient(90deg,#f1f6f3,#e7f1ec,#f1f6f3);background-size:200% 100%;animation:sh 1.4s linear infinite}
    @keyframes sh{to{background-position:-200% 0}}
  </style>
</head>
<body>
  <header class="appbar">
    <div class="logo">L</div>
    <div>
      <div style="font-weight:900">LeaderMath ‚Äî Admin</div>
      <div class="mut small">Foydalanuvchilar boshqaruvi</div>
    </div>
    <div class="sp"></div>
    <a class="btn ghost" href="./index.html">üè† Bosh sahifa</a>
    <button id="btnExport" class="btn pri">üì• Export CSV</button>
    <button id="btnSignOut" class="btn ghost">Chiqish</button>
  </header>

  <main class="wrap">
    <section id="forbidden" class="card forbid" style="display:none">
      <h3>‚õî Kirish taqiqlangan</h3>
      <p class="mut">Ushbu sahifaga faqat <b>sohibjonmath@gmail.com</b> foydalanuvchisi kira oladi.</p>
      <p class="mut">Agar xato deb o‚Äòylasangiz, administratorga murojaat qiling.</p>
      <div style="margin-top:10px"><a class="pill" href="./index.html">Bosh sahifa</a></div>
    </section>

    <section id="adminPanel" class="card" style="display:none">
      <div class="toolbar">
        <div class="tool-input"><span>üîç</span><input id="q" placeholder="Ism, viloyat, tuman, maktab, sinf..."></div>
        <select id="sortSel" class="tool-sel">
          <option value="points_desc">Ball (ko‚Äòp ‚Üí kam)</option>
          <option value="points_asc">Ball (kam ‚Üí ko‚Äòp)</option>
          <option value="name_asc">Ism (A‚ÜíZ)</option>
          <option value="name_desc">Ism (Z‚ÜíA)</option>
        </select>
        <span class="sp"></span>
        <span class="chip2">Jami: <b id="countAll">‚Äî</b></span>
      </div>
      <div id="list"><div class="skeleton"></div></div>
    </section>
  </main>

  <div id="mask" class="mask">
    <div class="modal">
      <h3>Foydalanuvchini tahrirlash</h3>
      <label>Ism Familiya</label><input id="f_name"><br>
      <label>Ball</label><input id="f_points" type="number" step="0.1"><br>
      <label>Rol</label>
      <select id="f_role"><option value="user">user</option><option value="admin">admin</option></select>
      <div style="text-align:right;margin-top:10px">
        <button id="f_save" class="pill ok">Saqlash</button>
        <button id="f_close" class="pill">Yopish</button>
      </div>
      <div id="f_err" class="mut" style="color:#c62828"></div>
    </div>
  </div>

<script type="module">
  // Firebase modullaringiz
  import { auth, db, signOut } from "./lib/firebase.client.js";
  import {
    collection, getDocs, doc, setDoc,
    orderBy, query, limit, startAfter
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // *** MUHIM: ayni mavjud guard API bilan ishlaymiz ***
  import { requireAuth } from "./lib/auth-guard.js";

  // Faqat shu email egasiga ruxsat
  const ADMIN_EMAIL = "sohibjonmath@gmail.com";

  // Elementlar
  const els = {
    adminPanel: document.getElementById("adminPanel"),
    forbidden: document.getElementById("forbidden"),
    btnSignOut: document.getElementById("btnSignOut"),
    btnExport: document.getElementById("btnExport"),
    q: document.getElementById("q"),
    list: document.getElementById("list"),
    countAll: document.getElementById("countAll"),
    // modal
    mask: document.getElementById("mask"),
    f_name: document.getElementById("f_name"),
    f_points: document.getElementById("f_points"),
    f_role: document.getElementById("f_role"),
    f_save: document.getElementById("f_save"),
    f_close: document.getElementById("f_close"),
    f_err: document.getElementById("f_err"),
  };

  function showAdmin(){ els.adminPanel.style.display='block'; els.forbidden.style.display='none'; }
  function showForbidden(){ els.adminPanel.style.display='none'; els.forbidden.style.display='block'; }

  // --- Kirish va admin email tekshiruvi (EXPORT muammosiz) ---
  (async ()=>{
    const me = await requireAuth({ loginPath: "./login.html" }); // majburiy login
    const myEmail = (me.email || "").toLowerCase();
    if (myEmail !== ADMIN_EMAIL) { showForbidden(); return; } // 403
    showAdmin();
    await initAdmin();
  })();

  // Chiqish
  els.btnSignOut.onclick = async ()=>{
    await signOut(auth);
    location.href = './login.html?return=' + encodeURIComponent('./index.html');
  };

  // ======== Firestore yuklash + sahifalash ========
  let cache = [];
  let lastDoc = null;
  const PAGE_SIZE = 200; // xohlasangiz 500/1000

  async function fetchPage(next=false){
    const base = query(
      collection(db, 'users'),
      orderBy('points', 'desc'),
      limit(PAGE_SIZE)
    );
    const qRef = next && lastDoc ? query(base, startAfter(lastDoc)) : base;
    const snap = await getDocs(qRef);
    if (snap.docs.length) lastDoc = snap.docs[snap.docs.length-1];
    return snap.docs.map(d=>({ id: d.id, ...d.data() }));
  }

  async function initAdmin(){
    // birinchi sahifa
    cache = await fetchPage(false);
    els.countAll.textContent = cache.length.toString();
    render();

    // xohlasangiz avtomatik 2-sahifani ham yuklab qo‚Äòyish:
    // const more = await fetchPage(true); cache = [...cache, ...more]; els.countAll.textContent = cache.length; render();
  }

  // ======== Render / qidiruv ========
  function fmt(n){ return (Number(n)||0).toLocaleString('uz-UZ',{maximumFractionDigits:1}); }
  function esc(s){ return String(s??'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  function render(){
    const term = (els.q?.value||'').trim().toLowerCase();
    const arr = term
      ? cache.filter(u => (`${u.name||''} ${u.email||''} ${u.region||''} ${u.district||''} ${u.school||''} ${u.class||''}`).toLowerCase().includes(term))
      : cache;

    if(arr.length===0){
      els.list.innerHTML = '<div class="row"><div class="mut">Hech narsa topilmadi</div></div>';
      return;
    }

    els.list.innerHTML = arr.map(u => `
      <div class="row">
        <div><span class="chip2">#${esc(u.numericId ?? '‚Äî')}</span></div>
        <div>
          <div style="font-weight:800">${esc(u.name || '‚Äî')}</div>
          <div class="mut small">${esc(u.email || '')}</div>
        </div>
        <div><div>${esc(u.region || '‚Äî')}</div><div class="mut small">${esc(u.district || '')}</div></div>
        <div>${esc(u.school || '‚Äî')}</div>
        <div>${esc(u.class || '‚Äî')}</div>
        <div class="right"><b>${fmt(u.points)}</b></div>
        <div><span class="chip2">${esc(u.role || 'user')}</span></div>
        <div class="actions">
          <button class="pill" data-edit="${u.id}">Tahrirlash</button>
        </div>
      </div>
    `).join('');

    // Edit bog‚Äòlash
    els.list.querySelectorAll('[data-edit]').forEach(btn=>{
      btn.onclick = ()=> openEdit(btn.dataset.edit);
    });
  }

  // Qidiruv
  if(els.q) {
    let t=null;
    els.q.addEventListener('input', ()=>{
      clearTimeout(t);
      t=setTimeout(()=>render(), 160);
    });
  }

  // ======== Tahrirlash ========
  let editId = null;

  function openEdit(id){
    const u = cache.find(x=>x.id===id); if(!u) return;
    editId = id;
    els.f_name.value = u.name || '';
    els.f_points.value = Number(u.points || 0);
    els.f_role.value = u.role || 'user';
    els.f_err.textContent = '';
    els.mask.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
  els.f_close.onclick = ()=>{
    els.mask.style.display = 'none';
    document.body.style.overflow = '';
    editId = null;
  };

  els.f_save.onclick = async ()=>{
    if(!editId) return;
    const ref = doc(db, 'users', editId);
    const payload = {
      name: els.f_name.value.trim(),
      points: Number(els.f_points.value || 0),
      role: els.f_role.value
    };
    try{
      await setDoc(ref, payload, { merge: true });
      // optimistik yangilash
      const i = cache.findIndex(x=>x.id===editId);
      if(i>-1) cache[i] = { ...cache[i], ...payload };
      render();
      els.mask.style.display = 'none';
      document.body.style.overflow = '';
      editId = null;
    }catch(e){
      console.error(e);
      els.f_err.textContent = 'Saqlashda xatolik. Ruxsatlar yoki internetni tekshiring.';
    }
  };

  // ======== CSV eksport (ko‚Äòrinayotgan ro‚Äòyxat) ========
  els.btnExport.onclick = ()=>{
    const term = (els.q?.value||'').trim().toLowerCase();
    const arr = term
      ? cache.filter(u => (`${u.name||''} ${u.email||''} ${u.region||''} ${u.district||''} ${u.school||''} ${u.class||''}`).toLowerCase().includes(term))
      : cache;

    const head = ['docId','numericId','name','email','region','district','school','class','phone','points','role','createdAt'];
    const rows = arr.map(u => [
      u.id, u.numericId ?? '', (u.name||'').replaceAll(',',' '), u.email||'',
      u.region||'', u.district||'', u.school||'', u.class||'', u.phone||'',
      Number(u.points||0), u.role||'user', u.createdAt||''
    ]);
    const csv = [head, ...rows]
      .map(r=>r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(','))
      .join('\n');

    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'users_export.csv'; a.click();
    URL.revokeObjectURL(url);
  };
</script>
</body>
</html>
