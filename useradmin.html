<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8">
  <title>XplusY ‚Äì Admin Panel</title>
</head>
<body>
  <h1>Admin panel</h1>
  <div id="loginArea">
    <script async src="https://telegram.org/js/telegram-widget.js?22"
      data-telegram-login="YOUR_BOT_USERNAME"
      data-size="large"
      data-onauth="onTelegramAuth(user)"
      data-request-access="write">
    </script>
  </div>

  <div id="adminArea" style="display:none;">
    <input id="searchInput" placeholder="Qidirish..." />
    <button id="refreshBtn">Yangilash</button>
    <button id="addUserBtn">‚ûï Yangi foydalanuvchi</button>
    <table border="1">
      <thead><tr><th>ID</th><th>Username</th><th>Ism</th><th>Balans</th><th>Amallar</th></tr></thead>
      <tbody id="usersList"></tbody>
    </table>
    <div id="statusBox"></div>
  </div>

<script>
let adminToken = null;

async function onTelegramAuth(user) {
  // Payloadni kodlab yuboramiz (Authorization header uchun)
  adminToken = btoa(JSON.stringify(user));
  document.getElementById('loginArea').style.display = 'none';
  document.getElementById('adminArea').style.display = 'block';
  loadUsers();
}

async function adminFetch(path='', method='GET', body) {
  const opts = {
    method,
    headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + adminToken }
  };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch('/.netlify/functions/admin-users' + path, opts);
  const json = await res.json();
  if (!json.ok) throw new Error(json.error || 'API error');
  return json;
}

async function loadUsers() {
  const { users } = await adminFetch();
  const tbody = document.getElementById('usersList');
  tbody.innerHTML = '';
  users.forEach(u => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${u.telegram_id}</td>
      <td>${u.username || ''}</td>
      <td>${u.first_name || ''}</td>
      <td><input id="bal-${u.telegram_id}" type="number" value="${u.balance}"></td>
      <td>
        <button onclick="updateBalance(${u.telegram_id})">üíæ</button>
        <button onclick="deleteUser(${u.telegram_id})">‚ùå</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

async function updateBalance(tid) {
  const bal = parseInt(document.getElementById('bal-'+tid).value);
  await adminFetch('', 'PUT', { telegram_id: tid, balance: bal });
  loadUsers();
}

async function deleteUser(tid) {
  if (!confirm("O‚Äòchirishni istaysizmi?")) return;
  await adminFetch('', 'DELETE', { telegram_id: tid });
  loadUsers();
}
</script>
</body>
</html>
