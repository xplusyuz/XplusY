<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Maktab Davomati — Statistika va sinf rahbari</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --primary:#2563eb;--primary-dark:#1d4ed8;--primary-light:#3b82f6;
      --secondary:#10b981;--secondary-dark:#059669;
      --accent:#8b5cf6;
      --success:#10b981;--warning:#f59e0b;--danger:#ef4444;
      --gray-50:#f9fafb;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;
      --gray-400:#9ca3af;--gray-500:#6b7280;--gray-600:#4b5563;--gray-700:#374151;
      --gray-800:#1f2937;--gray-900:#111827;
      --white:#ffffff;
      --shadow-sm:0 1px 2px rgba(0,0,0,.05);
      --shadow:0 1px 3px rgba(0,0,0,.1),0 1px 2px rgba(0,0,0,.06);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);
      --radius-sm:.25rem;--radius:.375rem;--radius-md:.5rem;--radius-lg:.75rem;
      --radius-xl:1rem;--radius-2xl:1.5rem;--radius-full:999px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;line-height:1.5;color:var(--gray-800);background:var(--gray-50)}
    body{margin:0}
    .container{max-width:960px;margin:0 auto;padding:0 .75rem 1.5rem}

    header{
      background:linear-gradient(135deg,var(--primary),var(--primary-dark));
      color:var(--white);
      box-shadow:var(--shadow-lg);
      position:sticky;top:0;z-index:100;
    }
    .header-content{
      display:flex;align-items:center;justify-content:space-between;
      padding:.75rem 0;
    }
    .logo{display:flex;align-items:center;gap:.75rem}
    .logo-icon{
      width:40px;height:40px;background:rgba(255,255,255,.2);
      border-radius:var(--radius-lg);display:flex;align-items:center;justify-content:center;
      font-size:1.25rem;font-weight:bold;backdrop-filter:blur(10px);
    }
    .logo-text h1{font-size:1.15rem;font-weight:700;line-height:1.2}
    .logo-text p{font-size:.75rem;opacity:.9}
    .header-actions{display:flex;align-items:center;gap:.5rem}
    .date-chip{
      background:rgba(255,255,255,.15);
      border-radius:var(--radius-full);
      padding:.4rem .9rem;
      font-size:.8rem;font-weight:500;
      backdrop-filter:blur(10px);
      display:inline-flex;align-items:center;gap:.4rem;
    }

    .btn{
      display:inline-flex;align-items:center;gap:.4rem;
      padding:.55rem 1rem;border-radius:var(--radius-lg);
      font-weight:600;font-size:.8rem;cursor:pointer;
      transition:.2s all;border:none;text-decoration:none;
    }
    .btn-primary{background:var(--white);color:var(--primary);box-shadow:var(--shadow)}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:var(--shadow-lg)}
    .btn-ghost{
      background:transparent;color:var(--gray-600);border:1px solid var(--gray-300);
    }
    .btn-ghost:hover{background:var(--gray-100);color:var(--gray-800)}
    .btn-sm{padding:.45rem .9rem;font-size:.75rem}
    .btn[disabled]{opacity:.6;cursor:default;box-shadow:none;transform:none}

    .card{
      background:var(--white);border-radius:var(--radius-xl);
      box-shadow:var(--shadow);overflow:hidden;margin:1rem 0;
    }
    .card-header{
      padding:1rem 1.1rem;border-bottom:1px solid var(--gray-200);
      display:flex;justify-content:space-between;align-items:center;gap:.75rem;
    }
    .card-title{font-size:1rem;font-weight:700;color:var(--gray-800);margin-bottom:.25rem}
    .card-subtitle{font-size:.8rem;color:var(--gray-600)}
    .card-body{padding:1.1rem 1rem 1.25rem}

    .stats-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:.75rem;margin-bottom:1.1rem;
    }
    .stat-card{
      background:var(--white);border-radius:var(--radius-lg);
      padding:1rem;box-shadow:var(--shadow-sm);border-left:4px solid var(--primary);
    }
    .stat-card.success{border-left-color:var(--success)}
    .stat-card.warning{border-left-color:var(--warning)}
    .stat-card.danger{border-left-color:var(--danger)}
    .stat-label{font-size:.8rem;color:var(--gray-600);margin-bottom:.35rem}
    .stat-value{font-size:1.5rem;font-weight:700;margin-bottom:.35rem}
    .stat-detail{font-size:.75rem;color:var(--gray-500)}

    .progress-bar{
      position:relative;height:8px;background:var(--gray-200);
      border-radius:var(--radius-full);overflow:hidden;margin:.5rem 0 0;
    }
    .progress-fill{
      position:absolute;top:0;bottom:0;
      transition:width .25s ease;
    }
    .progress-present{background:var(--success)}
    .progress-excused{background:var(--warning)}
    .progress-unexcused{background:var(--danger)}

    .table-container{overflow-x:auto;border-radius:var(--radius-lg);border:1px solid var(--gray-200)}
    table{width:100%;border-collapse:collapse}
    th{
      background:var(--gray-100);padding:.6rem .8rem;text-align:left;
      font-size:.7rem;font-weight:600;color:var(--gray-600);
      text-transform:uppercase;letter-spacing:.05em;
    }
    td{
      padding:.55rem .8rem;border-top:1px solid var(--gray-200);
      font-size:.8rem;vertical-align:top;
    }
    tr:hover{background:var(--gray-50)}

    .form-group{margin-bottom:.8rem}
    label{display:block;font-size:.8rem;font-weight:500;margin-bottom:.4rem;color:var(--gray-700)}
    input,select{
      width:100%;padding:.65rem .8rem;border:1px solid var(--gray-300);
      border-radius:var(--radius-lg);font-size:.8rem;transition:.2s all;background:var(--white);
    }
    input:focus,select:focus{
      outline:none;border-color:var(--primary);
      box-shadow:0 0 0 2px rgba(37,99,235,.15);
    }

    .alert{
      padding:.65rem .8rem;border-radius:var(--radius-lg);margin-bottom:.7rem;
      display:flex;align-items:flex-start;gap:.6rem;font-size:.8rem;
    }
    .alert-success{background:rgba(16,185,129,.08);border:1px solid rgba(16,185,129,.25);color:var(--success)}
    .alert-error{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.25);color:var(--danger)}
    .alert-warning{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.25);color:var(--warning)}

    .teacher-header{
      display:flex;align-items:center;gap:.75rem;
      margin-bottom:1rem;flex-wrap:wrap;
    }
    .teacher-badge{
      background:var(--primary-light);color:var(--white);
      padding:.45rem .85rem;border-radius:var(--radius-full);
      font-size:.8rem;font-weight:500;
    }

    .legend{display:flex;gap:.85rem;margin:.4rem 0 0;flex-wrap:wrap}
    .legend-item{display:flex;align-items:center;gap:.4rem;font-size:.8rem}
    .legend-color{width:11px;height:11px;border-radius:50%}
    .legend-present{background:var(--success)}
    .legend-excused{background:var(--warning)}
    .legend-unexcused{background:var(--danger)}

    .hidden{display:none}
    .text-sm{font-size:.8rem}
    .text-xs{font-size:.7rem}
    .font-semibold{font-weight:600}
    .mb-4{margin-bottom:1rem}
    .mt-4{margin-top:1rem}
    .ml-auto{margin-left:auto}
    .flex{display:flex}
    .gap-4{gap:1rem}

    @media (max-width:600px){
      .header-content{flex-direction:column;align-items:flex-start;gap:.6rem}
      .header-actions{width:100%;justify-content:space-between}
      .card{margin:.75rem 0}
      .card-body{padding:.9rem .8rem 1rem}
      .card-header{padding:.85rem .9rem}
      .stats-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<header>
  <div class="container">
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon"><i class="fas fa-school"></i></div>
        <div class="logo-text">
          <h1>Maktab Davomati</h1>
          <p>Statistika hammaga ochiq • Sinf rahbari alohida kiradi</p>
        </div>
      </div>
      <div class="header-actions">
        <div class="date-chip">
          <i class="far fa-calendar-alt"></i>
          <span id="today-label">Bugun: ...</span>
        </div>
        <button id="open-login-btn" class="btn btn-primary">
          <i class="fas fa-sign-in-alt"></i>
          Sinf rahbari kirishi
        </button>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <!-- GLOBAL STAT -->
  <section class="card">
    <div class="card-header">
      <div>
        <h2 class="card-title">Maktab bo'yicha umumiy statistika</h2>
        <p class="card-subtitle">
          Bugun, joriy hafta va oy kesimida o'quvchilar soni. Ranglar:
          <span style="color:var(--success)">bor</span>,
          <span style="color:var(--warning)">sababli yo'q</span>,
          <span style="color:var(--danger)">sababsiz yo'q</span>.
        </p>
      </div>
      <div class="flex gap-4">
        <a href="stats.html" class="btn btn-ghost btn-sm">
          <i class="fas fa-chart-bar"></i> PRO statistik panel
        </a>
        <button id="refresh-global-btn" class="btn btn-ghost btn-sm">
          <i class="fas fa-sync-alt"></i> Yangilash
        </button>
      </div>
    </div>
    <div class="card-body">
      <div class="stats-grid">
        <div class="stat-card success">
          <div class="stat-label">Bugun</div>
          <div class="stat-value" id="g-today-value">—</div>
          <div class="stat-detail" id="g-today-detail"></div>
          <div class="progress-bar" id="g-today-bar"></div>
        </div>
        <div class="stat-card warning">
          <div class="stat-label">Joriy hafta</div>
          <div class="stat-value" id="g-week-value">—</div>
          <div class="stat-detail" id="g-week-detail"></div>
          <div class="progress-bar" id="g-week-bar"></div>
        </div>
        <div class="stat-card danger">
          <div class="stat-label">Joriy oy</div>
          <div class="stat-value" id="g-month-value">—</div>
          <div class="stat-detail" id="g-month-detail"></div>
          <div class="progress-bar" id="g-month-bar"></div>
        </div>
      </div>

      <div class="legend">
        <div class="legend-item">
          <div class="legend-color legend-present"></div><span>Bor</span>
        </div>
        <div class="legend-item">
          <div class="legend-color legend-excused"></div><span>Sababli yo'q</span>
        </div>
        <div class="legend-item">
          <div class="legend-color legend-unexcused"></div><span>Sababsiz yo'q / davomat berilmagan</span>
        </div>
      </div>

      <div class="mt-4">
        <h3 class="text-sm font-semibold mb-4">Sinflar kesimida bugungi davomat:</h3>
        <div class="table-container">
          <table>
            <thead>
            <tr>
              <th>Sinf</th>
              <th>% bor</th>
              <th>Statistika</th>
              <th>Sonlar (bor/sababli/sababsiz/jami)</th>
              <th>Kelmaganlar (familiya)</th>
            </tr>
            </thead>
            <tbody id="g-classes-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- TEACHER PANEL -->
  <section class="card">
    <div class="card-header">
      <div>
        <h2 class="card-title">Sinf rahbari uchun bo'lim</h2>
        <p class="card-subtitle">
          Kirish majburiy emas, statistikani hamma ko'ra oladi. Sinf rahbari esa dars boshida davomat kiritadi.
        </p>
      </div>
      <button id="toggle-login-card" class="btn btn-ghost btn-sm">
        Kirish oynasini ko'rsatish
      </button>
    </div>
    <div class="card-body">
      <!-- LOGIN -->
      <div id="login-card" class="hidden" style="max-width:420px;margin:0 auto 1rem;">
        <div id="login-alert" class="alert alert-error hidden">
          <div class="alert-icon"><i class="fas fa-exclamation-triangle"></i></div>
          <div id="login-alert-text">Login/parol mos kelmadi yoki sinf.json noto'g'ri.</div>
        </div>
        <div class="form-group">
          <label for="login-input">Login (sinf.json dagi)</label>
          <input id="login-input" type="text" placeholder="masalan: Login502">
        </div>
        <div class="form-group">
          <label for="password-input">Parol</label>
          <input id="password-input" type="password" placeholder="••••••">
        </div>
        <button id="login-btn" class="btn btn-primary" style="width:100%;justify-content:center;">
          <i class="fas fa-sign-in-alt"></i> Kirish
        </button>
        <p class="text-xs text-sm text-center mt-4">
          Sinflar, login/parollar va o'quvchilar ro'yxati <strong>sinf.json</strong> faylidan olinadi.
        </p>
      </div>

      <!-- TEACHER INNER -->
      <div id="teacher-inner" class="hidden">
        <div class="teacher-header">
          <div class="teacher-badge" id="t-teacher-pill">
            <i class="fas fa-user-tie"></i> Sinf rahbari • ...
          </div>
          <div class="form-group" style="min-width:180px;">
            <label for="date-input">Sana</label>
            <input id="date-input" type="date">
          </div>
          <button id="logout-btn" class="btn btn-ghost btn-sm ml-auto">
            <i class="fas fa-sign-out-alt"></i> Chiqish
          </button>
        </div>

        <div id="day-alerts"></div>

        <div style="display:grid;grid-template-columns:1.1fr .9fr;gap:1rem;">
          <div>
            <h3 class="text-sm font-semibold mb-4" id="class-info-sub">Sinf va o'quvchilar</h3>

            <div id="students-empty" class="alert alert-warning">
              <div class="alert-icon"><i class="fas fa-info-circle"></i></div>
              <div>Bu sinf uchun o'quvchilar ro'yxati topilmadi (sinf.json ni tekshiring).</div>
            </div>

            <div id="students-table-wrap" class="table-container hidden">
              <table>
                <thead>
                <tr><th>#</th><th>F.I.Sh.</th><th>Holat</th></tr>
                </thead>
                <tbody id="students-tbody"></tbody>
              </table>
            </div>

            <button id="save-btn" class="btn btn-primary mt-4" style="width:100%;justify-content:center;">
              <i class="fas fa-save"></i> Davomatni saqlash
            </button>
          </div>

          <div>
            <h3 class="text-sm font-semibold mb-4">Sinf statistikasi</h3>

            <div class="stat-card success mb-4">
              <div class="stat-label">Bugun</div>
              <div class="stat-value" id="t-today-value">—</div>
              <div class="stat-detail" id="t-today-detail"></div>
              <div class="progress-bar" id="t-today-bar"></div>
            </div>

            <div class="stats-grid">
              <div class="stat-card warning">
                <div class="stat-label">Joriy hafta</div>
                <div class="stat-value" id="t-week-value">—</div>
                <div class="stat-detail" id="t-week-detail"></div>
                <div class="progress-bar" id="t-week-bar"></div>
              </div>
              <div class="stat-card danger">
                <div class="stat-label">Joriy oy</div>
                <div class="stat-value" id="t-month-value">—</div>
                <div class="stat-detail" id="t-month-detail"></div>
                <div class="progress-bar" id="t-month-bar"></div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>
</main>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

<script>
  // ==== FIREBASE INIT ====
  const firebaseConfig = {
    apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
    authDomain: "xplusy-760fa.firebaseapp.com",
    projectId: "xplusy-760fa",
    storageBucket: "xplusy-760fa.firebasestorage.app",
    messagingSenderId: "992512966017",
    appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
    measurementId: "G-459PLJ7P7L"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const davomatCol = db.collection("davomat");
  const configDoc = db.collection("davomat_config").doc("calendar");

  // ==== UTIL ====
  function toDateStr(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function formatDateLabel(dateStr){
    const d = new Date(dateStr);
    return d.toLocaleDateString("uz-UZ",{
      weekday:"long",year:"numeric",month:"long",day:"numeric"
    });
  }
  function weekRangeFor(dateStr){
    const d = new Date(dateStr);
    const day = d.getDay();
    const diffToMon = (day===0 ? -6 : 1-day);
    const s = new Date(d); s.setDate(d.getDate()+diffToMon);
    const e = new Date(s); e.setDate(s.getDate()+6);
    return {start:toDateStr(s),end:toDateStr(e)};
  }
  function monthRangeFor(dateStr){
    const d = new Date(dateStr);
    const s = new Date(d.getFullYear(),d.getMonth(),1);
    const e = new Date(d.getFullYear(),d.getMonth()+1,0);
    return {start:toDateStr(s),end:toDateStr(e)};
  }

  // 3 rangli progress bar yasash
  function renderMultiBar(container, present, excused, unexcused){
    if(!container) return;
    const total = present+excused+unexcused;
    container.innerHTML = "";
    if(!total){
      // bo'sh
      return;
    }
    const p = Math.round(present*100/total);
    const e = Math.round(excused*100/total);
    const u = Math.max(0,100-p-e); // so'nggi bo'lagi to'ldirib yuboramiz

    const segP = document.createElement("div");
    segP.className = "progress-fill progress-present";
    segP.style.left = "0"; segP.style.width = p+"%";

    const segE = document.createElement("div");
    segE.className = "progress-fill progress-excused";
    segE.style.left = p+"%"; segE.style.width = e+"%";

    const segU = document.createElement("div");
    segU.className = "progress-fill progress-unexcused";
    segU.style.left = (p+e)+"%"; segU.style.width = u+"%";

    container.appendChild(segP);
    container.appendChild(segE);
    container.appendChild(segU);
  }

  // ==== DOM ====
  const todayLabel = document.getElementById("today-label");
  const gTodayValue = document.getElementById("g-today-value");
  const gTodayDetail = document.getElementById("g-today-detail");
  const gTodayBar = document.getElementById("g-today-bar");
  const gWeekValue = document.getElementById("g-week-value");
  const gWeekDetail = document.getElementById("g-week-detail");
  const gWeekBar = document.getElementById("g-week-bar");
  const gMonthValue = document.getElementById("g-month-value");
  const gMonthDetail = document.getElementById("g-month-detail");
  const gMonthBar = document.getElementById("g-month-bar");
  const gClassesTbody = document.getElementById("g-classes-tbody");
  const refreshGlobalBtn = document.getElementById("refresh-global-btn");

  const openLoginBtn = document.getElementById("open-login-btn");
  const toggleLoginCardBtn = document.getElementById("toggle-login-card");
  const loginCard = document.getElementById("login-card");
  const loginAlert = document.getElementById("login-alert");
  const loginAlertText = document.getElementById("login-alert-text");
  const loginInput = document.getElementById("login-input");
  const passwordInput = document.getElementById("password-input");
  const loginBtn = document.getElementById("login-btn");
  const teacherInner = document.getElementById("teacher-inner");
  const logoutBtn = document.getElementById("logout-btn");
  const tTeacherPill = document.getElementById("t-teacher-pill");
  const dateInput = document.getElementById("date-input");
  const dayAlerts = document.getElementById("day-alerts");
  const classInfoSub = document.getElementById("class-info-sub");
  const studentsEmpty = document.getElementById("students-empty");
  const studentsTableWrap = document.getElementById("students-table-wrap");
  const studentsTbody = document.getElementById("students-tbody");
  const saveBtn = document.getElementById("save-btn");

  const tTodayValue = document.getElementById("t-today-value");
  const tTodayDetail = document.getElementById("t-today-detail");
  const tTodayBar = document.getElementById("t-today-bar");
  const tWeekValue = document.getElementById("t-week-value");
  const tWeekDetail = document.getElementById("t-week-detail");
  const tWeekBar = document.getElementById("t-week-bar");
  const tMonthValue = document.getElementById("t-month-value");
  const tMonthDetail = document.getElementById("t-month-detail");
  const tMonthBar = document.getElementById("t-month-bar");

  let classesJson = [];
  let currentTeacher = null;
  let currentDateStr = null;
  let calendarConfig = {holidays:[],extraSchoolDays:[]};

  // sinf.json
  async function loadClassesJson(){
    try{
      const res = await fetch("sinf.json?v="+Date.now());
      if(!res.ok) throw new Error("sinf.json topilmadi");
      const data = await res.json();
      classesJson = data.classes || [];
    }catch(e){
      console.warn("sinf.json o‘qishda xato:",e);
      classesJson = [];
    }
  }

  // calendar config (ta'til va extra kunlar)
  async function loadCalendarConfig(){
    try{
      const snap = await configDoc.get();
      if(snap.exists){
        const d = snap.data();
        calendarConfig = {
          holidays:d.holidays || [],
          extraSchoolDays:d.extraSchoolDays || []
        };
      }
    }catch(e){
      console.warn("calendar config o‘qishda xato:",e);
    }
  }
  function isHoliday(dateStr){
    for(const h of calendarConfig.holidays){
      if(dateStr>=h.start && dateStr<=h.end) return true;
    }
    return false;
  }
  function isExtraSchoolDay(dateStr){
    return (calendarConfig.extraSchoolDays || []).includes(dateStr);
  }
  function isSchoolDay(dateStr){
    const d = new Date(dateStr);
    const dow = d.getDay(); // 0 yakshanba,6 shanba
    if(isHoliday(dateStr)) return false;
    if(dow===0 || dow===6) return isExtraSchoolDay(dateStr);
    return true;
  }

  function showLoginError(msg){
    loginAlertText.textContent = msg;
    loginAlert.classList.remove("hidden");
  }
  function clearLoginError(){loginAlert.classList.add("hidden")}

  function toggleLoginCard(){
    const hidden = loginCard.classList.contains("hidden");
    if(hidden){
      loginCard.classList.remove("hidden");
      toggleLoginCardBtn.textContent = "Kirish oynasini yashirish";
    }else{
      loginCard.classList.add("hidden");
      toggleLoginCardBtn.textContent = "Kirish oynasini ko'rsatish";
    }
  }

  async function handleLogin(){
    clearLoginError();
    const login = loginInput.value.trim();
    const pw = passwordInput.value;
    if(!login || !pw){
      showLoginError("Login va parolni kiriting.");
      return;
    }
    const cls = classesJson.find(
      c=>c.teacherLogin===login && c.teacherPassword===pw
    );
    if(!cls){
      showLoginError("Login/parol mos kelmadi yoki sinf.json noto‘g‘ri.");
      return;
    }
    currentTeacher = {
      login,
      teacherName:cls.teacherName || cls.teacherLogin || login,
      classObj:cls
    };
    localStorage.setItem("davomat_teacher_login",login);
    localStorage.setItem("davomat_teacher_class",cls.id);

    tTeacherPill.innerHTML =
      '<i class="fas fa-user-tie"></i> '+
      (cls.teacherName || "Sinf rahbari")+" • "+(cls.name || cls.id);

    teacherInner.classList.remove("hidden");
    loginCard.classList.add("hidden");

    const today = toDateStr(new Date());
    currentDateStr = today;
    dateInput.value = today;

    await renderDayState();
    await renderStudents();
    await refreshTeacherStats();
  }

  function restoreTeacherSession(){
    const login = localStorage.getItem("davomat_teacher_login");
    const classId = localStorage.getItem("davomat_teacher_class");
    if(!login || !classId) return;
    const cls = classesJson.find(c=>c.id===classId && c.teacherLogin===login);
    if(!cls) return;
    currentTeacher = {
      login,
      teacherName:cls.teacherName || cls.teacherLogin || login,
      classObj:cls
    };
    tTeacherPill.innerHTML =
      '<i class="fas fa-user-tie"></i> '+
      (cls.teacherName || "Sinf rahbari")+" • "+(cls.name || cls.id);
    teacherInner.classList.remove("hidden");
    loginCard.classList.add("hidden");
  }

  function logoutTeacher(){
    currentTeacher = null;
    teacherInner.classList.add("hidden");
    loginCard.classList.remove("hidden");
    localStorage.removeItem("davomat_teacher_login");
    localStorage.removeItem("davomat_teacher_class");
  }

  // ==== GLOBAL STATS ====
  async function refreshGlobalStats(){
    const today = toDateStr(new Date());
    const wr = weekRangeFor(today);
    const mr = monthRangeFor(today);

    // bugun
    const todaySnap = await davomatCol.where("date","==",today).get();
    let tP=0,tE=0,tU=0,tT=0;
    todaySnap.forEach(doc=>{
      const s = doc.data().stats || {};
      const present = s.presentCount || 0;
      const excused = s.excusedCount || 0;
      const unexcused = (s.unexcusedCount!=null ? s.unexcusedCount : (s.absentCount||0)) - excused;
      const total = s.total || (present+excused+unexcused);
      tP+=present; tE+=excused; tU+=Math.max(unexcused,0); tT+=total;
    });
    if(tT){
      const percent = Math.round(tP*100/tT);
      gTodayValue.textContent = percent+"%";
      gTodayDetail.textContent = `Bor: ${tP}, Sababli: ${tE}, Sababsiz: ${tU}, Jami: ${tT}`;
      renderMultiBar(gTodayBar,tP,tE,tU);
    }else{
      gTodayValue.textContent = "—";
      gTodayDetail.textContent = "Bugun uchun davomat hali kiritilmagan.";
      gTodayBar.innerHTML = "";
    }

    // hafta
    const wSnap = await davomatCol
      .where("date",">=",wr.start)
      .where("date","<=",wr.end)
      .get();
    let wP=0,wE=0,wU=0,wT=0;
    wSnap.forEach(doc=>{
      const s = doc.data().stats || {};
      const P=s.presentCount||0;
      const E=s.excusedCount||0;
      const U=(s.unexcusedCount!=null ? s.unexcusedCount : (s.absentCount||0))-E;
      const T=s.total || (P+E+U);
      wP+=P; wE+=E; wU+=Math.max(U,0); wT+=T;
    });
    if(wT){
      const percent = Math.round(wP*100/wT);
      gWeekValue.textContent = percent+"%";
      gWeekDetail.textContent = `Kundagi yozuvlar: ${wSnap.size}`;
      renderMultiBar(gWeekBar,wP,wE,wU);
    }else{
      gWeekValue.textContent="—";
      gWeekDetail.textContent="Joriy haftada davomat yozilmagan.";
      gWeekBar.innerHTML="";
    }

    // oy
    const mSnap = await davomatCol
      .where("date",">=",mr.start)
      .where("date","<=",mr.end)
      .get();
    let mP=0,mE=0,mU=0,mT=0;
    mSnap.forEach(doc=>{
      const s = doc.data().stats || {};
      const P=s.presentCount||0;
      const E=s.excusedCount||0;
      const U=(s.unexcusedCount!=null ? s.unexcusedCount : (s.absentCount||0))-E;
      const T=s.total || (P+E+U);
      mP+=P; mE+=E; mU+=Math.max(U,0); mT+=T;
    });
    if(mT){
      const percent = Math.round(mP*100/mT);
      gMonthValue.textContent = percent+"%";
      gMonthDetail.textContent = `Kundagi yozuvlar: ${mSnap.size}`;
      gMonthBar.innerHTML = "";
      renderMultiBar(gMonthBar,mP,mE,mU);
    }else{
      gMonthValue.textContent="—";
      gMonthDetail.textContent="Joriy oyda davomat yozilmagan.";
      gMonthBar.innerHTML="";
    }

    // sinflar kesimida bugun
    gClassesTbody.innerHTML = "";
    for(const cls of classesJson){
      const docId = `${today}_${cls.id}`;
      const snap = await davomatCol.doc(docId).get();

      let tdPercentText = "—";
      let detailText = "—";
      let p=0,e=0,u=0,t=0;
      let excusedNames=[],unexcusedNames=[];
      let barPresent=0,barExcused=0,barUnexcused=0;
      let noAttendance = false;

      if(snap.exists){
        const data = snap.data();
        const s = data.stats || {};
        p = s.presentCount || 0;
        e = s.excusedCount || 0;
        u = (s.unexcusedCount!=null ? s.unexcusedCount : (s.absentCount||0)) - e;
        t = s.total || (p+e+u);

        const studs = data.students || [];
        for(const st of studs){
          const stStatus = st.status || "present";
          if(stStatus==="excused") excusedNames.push(st.fullName||"");
          if(stStatus==="unexcused" || stStatus==="absent") unexcusedNames.push(st.fullName||"");
        }

        if(t>0){
          tdPercentText = Math.round(p*100/t)+"%";
          detailText = `${p}/${e}/${Math.max(u,0)}/${t}`;
          barPresent=p; barExcused=e; barUnexcused=Math.max(u,0);
        }else{
          tdPercentText="0%";
          detailText="0/0/0/0";
        }
      }else{
        // Davomat berilmagan
        noAttendance = true;
        tdPercentText = "—";
        detailText = "Davomat berilmagan";
        barPresent=0; barExcused=0; barUnexcused=1; // 100% qizil
      }

      const tr = document.createElement("tr");

      const tdClass = document.createElement("td");
      tdClass.textContent = cls.name || cls.id;
      tr.appendChild(tdClass);

      const tdPercent = document.createElement("td");
      tdPercent.textContent = tdPercentText;
      tr.appendChild(tdPercent);

      const tdBar = document.createElement("td");
      const pb = document.createElement("div");
      pb.className = "progress-bar";
      if(noAttendance){
        const seg = document.createElement("div");
        seg.className = "progress-fill progress-unexcused";
        seg.style.left = "0"; seg.style.width = "100%";
        pb.appendChild(seg);
      }else{
        renderMultiBar(pb,barPresent,barExcused,barUnexcused);
      }
      tdBar.appendChild(pb);
      tr.appendChild(tdBar);

      const tdDetail = document.createElement("td");
      tdDetail.textContent = detailText;
      tr.appendChild(tdDetail);

      const tdNames = document.createElement("td");
      if(noAttendance){
        tdNames.style.color = "var(--danger)";
        tdNames.textContent = "Davomat berilmagan";
      }else if(!excusedNames.length && !unexcusedNames.length){
        tdNames.textContent = "Hamma bor";
      }else{
        const parts=[];
        if(excusedNames.length) parts.push(`Sababli: ${excusedNames.join(", ")}`);
        if(unexcusedNames.length) parts.push(`Sababsiz: ${unexcusedNames.join(", ")}`);
        tdNames.innerHTML = parts.join("<br>");
      }
      tr.appendChild(tdNames);

      gClassesTbody.appendChild(tr);
    }
  }

  // ==== TEACHER DAY STATE ====
  async function renderDayState(){
    dayAlerts.innerHTML = "";
    if(!currentTeacher || !currentDateStr) return;

    const cls = currentTeacher.classObj;
    const docId = `${currentDateStr}_${cls.id}`;
    const snap = await davomatCol.doc(docId).get();
    const hasAttendance = snap.exists;

    const alert = document.createElement("div");
    alert.className = hasAttendance ? "alert alert-success" : "alert alert-error";

    const isSchool = isSchoolDay(currentDateStr);
    let text;
    if(!isSchool){
      text = "Bu sana o‘quv kuni emas (ta'til yoki dam olish kuni). Davomat kiritish shart emas.";
    }else{
      text = hasAttendance
        ? "Bu sana uchun davomat kiritilgan. Kerak bo‘lsa tahrirlashingiz mumkin."
        : "Bu sana uchun davomat hali kiritilmagan. Dars boshida to‘ldiring.";
    }
    alert.innerHTML = `<div class="alert-icon">${hasAttendance?"✅":"⚠️"}</div><div>${text}</div>`;
    dayAlerts.appendChild(alert);
  }

  // ==== TEACHER STUDENTS ====
  async function renderStudents(){
    if(!currentTeacher || !currentDateStr) return;
    const cls = currentTeacher.classObj;
    const students = cls.students || [];

    if(!students.length){
      studentsEmpty.classList.remove("hidden");
      studentsTableWrap.classList.add("hidden");
      classInfoSub.textContent = (cls.name||cls.id)+" — o‘quvchilar ro‘yxati yo‘q (sinf.json).";
      return;
    }

    classInfoSub.textContent = (cls.name||cls.id)+" — o‘quvchilar soni: "+students.length;

    const docId = `${currentDateStr}_${cls.id}`;
    const snap = await davomatCol.doc(docId).get();
    const existingMap = {};
    if(snap.exists){
      (snap.data().students||[]).forEach(st=>{
        existingMap[st.id] = st.status;
      });
    }

    studentsTbody.innerHTML = "";
    students.forEach((st,idx)=>{
      const tr = document.createElement("tr");
      const status = existingMap[st.id] || "present";
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${st.fullName||""}</td>
        <td>
          <select class="status-select" data-student-id="${st.id}">
            <option value="present">Bor</option>
            <option value="excused">Sababli yo'q</option>
            <option value="unexcused">Sababsiz yo'q</option>
          </select>
        </td>`;
      studentsTbody.appendChild(tr);
      const sel = tr.querySelector("select");
      sel.value = (status==="absent" ? "unexcused" : status);
    });

    studentsEmpty.classList.add("hidden");
    studentsTableWrap.classList.remove("hidden");
  }

  // ==== SAVE ATTENDANCE ====
  async function saveAttendance(){
    if(!currentTeacher || !currentDateStr) return;
    if(!isSchoolDay(currentDateStr)){
      alert("Bu sana o‘quv kuni emas (ta'til yoki qo‘shimcha o‘quv kuni sozlamalarini tekshiring).");
      return;
    }
    const cls = currentTeacher.classObj;
    const students = cls.students || [];
    if(!students.length){
      alert("Bu sinf uchun o‘quvchilar ro‘yxati sinf.json da yo‘q.");
      return;
    }

    const rows = studentsTbody.querySelectorAll("tr");
    const resStudents = [];
    let present=0,excused=0,unexcused=0;

    students.forEach((st,idx)=>{
      const row = rows[idx];
      const sel = row.querySelector("select");
      let status = sel.value;
      if(status==="absent") status="unexcused";
      resStudents.push({id:st.id,fullName:st.fullName,status});
      if(status==="present") present++;
      else if(status==="excused") excused++;
      else unexcused++;
    });

    const total = students.length;
    const docId = `${currentDateStr}_${cls.id}`;

    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saqlanmoqda...';

    try{
      await davomatCol.doc(docId).set({
        date:currentDateStr,
        classId:cls.id,
        className:cls.name || cls.id,
        teacherLogin:currentTeacher.login,
        teacherName:currentTeacher.teacherName,
        students:resStudents,
        stats:{
          total,
          presentCount:present,
          excusedCount:excused,
          unexcusedCount:unexcused,
          absentCount:excused+unexcused
        },
        updatedAt:firebase.firestore.FieldValue.serverTimestamp()
      },{merge:true});

      await renderDayState();
      await refreshTeacherStats();
      await refreshGlobalStats();
      alert("Davomat saqlandi.");
    }catch(e){
      console.error(e);
      alert("Saqlashda xatolik.");
    }finally{
      saveBtn.disabled=false;
      saveBtn.innerHTML='<i class="fas fa-save"></i> Davomatni saqlash';
    }
  }

  // ==== TEACHER STATS ====
  async function refreshTeacherStats(){
    if(!currentTeacher || !currentDateStr) return;
    const cls = currentTeacher.classObj;

    // bugun
    const todayDocId = `${currentDateStr}_${cls.id}`;
    const tSnap = await davomatCol.doc(todayDocId).get();
    let p=0,e=0,u=0,t=0;
    if(tSnap.exists){
      const s = tSnap.data().stats || {};
      p=s.presentCount||0;
      e=s.excusedCount||0;
      u=(s.unexcusedCount!=null ? s.unexcusedCount : (s.absentCount||0))-e;
      t=s.total || (p+e+u);
    }
    if(t){
      const percent = Math.round(p*100/t);
      tTodayValue.textContent = percent+"%";
      tTodayDetail.textContent = `Bor: ${p}, Sababli: ${e}, Sababsiz: ${Math.max(u,0)}, Jami: ${t}`;
      renderMultiBar(tTodayBar,p,e,Math.max(u,0));
    }else{
      tTodayValue.textContent="—";
      tTodayDetail.textContent="Bugun uchun davomat kiritilmagan.";
      tTodayBar.innerHTML="";
    }

    // hafta: faqat date bo‘yicha so‘rov, classId ni JS’da filter qilamiz — index talab qilmaydi
    const wr = weekRangeFor(currentDateStr);
    const wSnap = await davomatCol
      .where("date",">=",wr.start)
      .where("date","<=",wr.end)
      .get();
    let wP=0,wE=0,wU=0,wT=0, wDays=0;
    wSnap.forEach(doc=>{
      const d = doc.data();
      if(d.classId !== cls.id) return;
      const s = d.stats || {};
      const P=s.presentCount||0;
      const E=s.excusedCount||0;
      const U=(s.unexcusedCount!=null ? s.unexcusedCount : (s.absentCount||0))-E;
      const T=s.total || (P+E+U);
      wP+=P; wE+=E; wU+=Math.max(U,0); wT+=T; wDays++;
    });
    if(wT){
      const percent = Math.round(wP*100/wT);
      tWeekValue.textContent = percent+"%";
      tWeekDetail.textContent = `Kunlar soni: ${wDays}`;
      renderMultiBar(tWeekBar,wP,wE,wU);
    }else{
      tWeekValue.textContent="—";
      tWeekDetail.textContent="Hafta bo‘yicha davomat yozilmagan.";
      tWeekBar.innerHTML="";
    }

    // oy: xuddi shu usul
    const mr = monthRangeFor(currentDateStr);
    const mSnap = await davomatCol
      .where("date",">=",mr.start)
      .where("date","<=",mr.end)
      .get();
    let mP=0,mE=0,mU=0,mT=0, mDays=0;
    mSnap.forEach(doc=>{
      const d = doc.data();
      if(d.classId !== cls.id) return;
      const s = d.stats || {};
      const P=s.presentCount||0;
      const E=s.excusedCount||0;
      const U=(s.unexcusedCount!=null ? s.unexcusedCount : (s.absentCount||0))-E;
      const T=s.total || (P+E+U);
      mP+=P; mE+=E; mU+=Math.max(U,0); mT+=T; mDays++;
    });
    if(mT){
      const percent = Math.round(mP*100/mT);
      tMonthValue.textContent = percent+"%";
      tMonthDetail.textContent = `Kunlar soni: ${mDays}`;
      renderMultiBar(tMonthBar,mP,mE,mU);
    }else{
      tMonthValue.textContent="—";
      tMonthDetail.textContent="Oy bo‘yicha davomat yozilmagan.";
      tMonthBar.innerHTML="";
    }
  }

  // ==== INIT ====
  document.addEventListener("DOMContentLoaded",async function(){
    const todayStr = toDateStr(new Date());
    try{
      todayLabel.textContent = "Bugun: "+formatDateLabel(todayStr);
    }catch{
      todayLabel.textContent = "Bugun: "+todayStr;
    }

    await Promise.all([
      loadClassesJson(),
      loadCalendarConfig()
    ]);

    await refreshGlobalStats();
    restoreTeacherSession();
    if(currentTeacher){
      currentDateStr = todayStr;
      dateInput.value = todayStr;
      await renderDayState();
      await renderStudents();
      await refreshTeacherStats();
    }

    openLoginBtn.addEventListener("click",()=>{
      loginCard.classList.remove("hidden");
      teacherInner.classList.add("hidden");
      toggleLoginCardBtn.textContent = "Kirish oynasini yashirish";
      window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"});
    });
    toggleLoginCardBtn.addEventListener("click",toggleLoginCard);
    loginBtn.addEventListener("click",handleLogin);
    passwordInput.addEventListener("keydown",e=>{if(e.key==="Enter")handleLogin();});
    logoutBtn.addEventListener("click",logoutTeacher);

    dateInput.addEventListener("change",async()=>{
      if(!dateInput.value) return;
      currentDateStr = dateInput.value;
      await renderDayState();
      await renderStudents();
      await refreshTeacherStats();
    });

    saveBtn.addEventListener("click",saveAttendance);
    refreshGlobalBtn.addEventListener("click",refreshGlobalStats);
  });
</script>
</body>
</html>
