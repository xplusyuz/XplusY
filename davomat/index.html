<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Maktab Davomati â€” Statistika va sinf rahbari</title>

  <style>
    :root{
      --brand:#2E8B57; --brand-dark:#155f3a;
      --accent:#6B8E23;
      --bg:#F3F7F5; --card:#FFFFFF;
      --text:#102218; --muted:#6c7b73;
      --line:#dfe7e2;
      --ok:#26a269; --excused:#e0a800; --bad:#e03131;
      --shadow-soft:0 20px 60px rgba(13,37,23,.16);
      --radius-lg:22px; --radius-md:16px;
      --speed:.25s;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#f0fff6 0,#f5faf7 40%,#eaf2ec 100%);
      color:var(--text);
    }

    /* HEADER */
    header{
      position:sticky;top:0;z-index:10;
      backdrop-filter:blur(18px);
      background:linear-gradient(120deg,rgba(244,248,246,.97),rgba(232,244,236,.97));
      border-bottom:1px solid rgba(221,232,226,.95);
    }
    .row{
      max-width:1180px;margin:0 auto;
      padding:10px 16px;
      display:flex;align-items:center;gap:12px;
    }
    .brand{display:flex;align-items:center;gap:10px;}
    .logo{
      width:36px;height:36px;border-radius:14px;
      background:conic-gradient(from 210deg,#2E8B57,#6B8E23,#2E8B57);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:800;font-size:18px;
      box-shadow:0 14px 34px rgba(26,96,60,.55);
    }
    .brand-title{font-size:18px;font-weight:750;letter-spacing:.04em;}
    .chip{
      font-size:11px;padding:5px 10px;border-radius:999px;
      border:1px solid rgba(46,139,87,.22);
      background:rgba(46,139,87,.06);
      color:var(--brand-dark);
    }
    .btn{
      border:none;border-radius:999px;
      padding:7px 14px;font-size:13px;font-weight:600;
      display:inline-flex;align-items:center;gap:6px;
      cursor:pointer;
      transition:transform .15s,box-shadow .15s,background .15s;
    }
    .btn-primary{
      background:linear-gradient(135deg,#2E8B57,#1F6B45);
      color:#fff;
      box-shadow:0 12px 30px rgba(18,92,55,.55);
    }

    main{max-width:1180px;margin:0 auto;padding:16px;display:grid;gap:14px;}
    .card{
      background:white;
      border-radius:var(--radius-lg);
      border:1px solid var(--line);
      box-shadow:var(--shadow-soft);
      padding:16px;
    }
    .stat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
    @media(max-width:720px){.stat-grid{grid-template-columns:1fr;}}

    .stat-card-mini{
      background:#f5f9f7;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
    }
    .stack-bar{width:100%;height:9px;background:#ecf3ee;border-radius:99px;overflow:hidden;margin-top:4px;}
    .stack-bar-fill{display:flex;height:100%;}
    .seg{height:100%;}
    .seg-present{background:var(--ok);}
    .seg-excused{background:var(--excused);}
    .seg-unexcused{background:var(--bad);}
  </style>
</head>
<body>
<header>
  <div class="row">
    <div class="brand">
      <div class="logo">D</div>
      <div><div class="brand-title">Maktab Davomati</div></div>
    </div>
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
      <span class="chip">Bugun: <span id="today-label"></span></span>
      <button id="open-login-btn" class="btn btn-primary">Sinf rahbari kirishi</button>
    </div>
  </div>
</header>

<main>
  <!-- GLOBAL STATS -->
  <section class="card">
    <h3>Maktab boâ€˜yicha statistika</h3>
    <div class="stat-grid">
      <div class="stat-card-mini">
        <b>Bugun</b>
        <div id="g-today-value"></div>
        <div id="g-today-detail"></div>
        <div class="stack-bar"><div id="g-today-bar" class="stack-bar-fill"></div></div>
      </div>
      <div class="stat-card-mini">
        <b>Joriy hafta</b>
        <div id="g-week-value"></div>
        <div id="g-week-detail"></div>
        <div class="stack-bar"><div id="g-week-bar" class="stack-bar-fill"></div></div>
      </div>
      <div class="stat-card-mini">
        <b>Joriy oy</b>
        <div id="g-month-value"></div>
        <div id="g-month-detail"></div>
        <div class="stack-bar"><div id="g-month-bar" class="stack-bar-fill"></div></div>
      </div>
    </div>

    <h4>Sinflar kesimida bugungi davomat</h4>
    <table border="1" width="100%" cellpadding="6" style="border-collapse:collapse">
      <thead>
        <tr>
          <th>Sinf</th>
          <th>% bor</th>
          <th>Mini-gistogramma</th>
          <th>Sonlar (bor/sababli/sababsiz/jami)</th>
          <th>Kelmaganlar (familiya)</th>
        </tr>
      </thead>
      <tbody id="g-classes-tbody"></tbody>
    </table>
  </section>
</main>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
<script>
  // ðŸ”§ FIREBASE CONFIGNI ALMASHTIR!
  firebase.initializeApp({
    apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  authDomain: "xplusy-760fa.firebaseapp.com",
  projectId: "xplusy-760fa",
  storageBucket: "xplusy-760fa.firebasestorage.app",
  messagingSenderId: "992512966017",
  appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
  measurementId: "G-459PLJ7P7L"
  });

  const db = firebase.firestore();
  const davomatCol = db.collection('davomat');
  const classesJson = []; // sinf.json dan keladi

  // Stack-bar yozish
  function buildBar(container, p, e, u){
    const total = p+e+u; container.innerHTML='';
    if(!total) return;
    const segs = [
      {w:p, cls:'seg-present'},
      {w:e, cls:'seg-excused'},
      {w:u, cls:'seg-unexcused'}
    ];
    segs.forEach(s=>{
      const d=document.createElement('div');
      d.className='seg '+s.cls;
      d.style.width = (s.w*100/total)+'%';
      container.appendChild(d);
    });
  }

  // ðŸ“Œ SINFLAR KESIMIDA KELMAGANLARNI CHIQARGAN QISM:
  async function refreshGlobalStats(){
    const today = new Date().toISOString().slice(0,10);
    const tbody = document.getElementById('g-classes-tbody');
    tbody.innerHTML='';

    // sinf.json ni oâ€˜qib kelamiz:
    if(!classesJson.length){
      const res=await fetch('sinf.json');
      const data=await res.json();
      classesJson.push(...data.classes);
    }

    for(const cls of classesJson){
      const docId=`${today}_${cls.id}`;
      const snap = await davomatCol.doc(docId).get();

      let p=0,e=0,u=0,t=0;
      let excusedNames=[], unexcusedNames=[];

      if(snap.exists){
        const d=snap.data(), s=d.stats||{};
        p=s.presentCount||0;
        e=s.excusedCount||0;
        u=((s.unexcusedCount!=null ? s.unexcusedCount : (s.absentCount||0)) - e) || 0;
        t=s.total||0;

        for(const st of (d.students||[])){
          if(st.status==='excused')    excusedNames.push(st.fullName);
          if(st.status==='unexcused')  unexcusedNames.push(st.fullName);
        }
      }
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${cls.name||cls.id}</td>
        <td>${t>0 ? Math.round(p*100/t)+'%' : 'â€”'}</td>
        <td><div class="stack-bar"><div class="stack-bar-fill" id="bar-${cls.id}"></div></div></td>
        <td>${p}/${e}/${u}/${t}</td>
        <td>${
          (!excusedNames.length && !unexcusedNames.length)
            ? 'Hamma bor'
            : `
              ${excusedNames.length ? `<b>Sababli:</b> ${excusedNames.join(', ')}` : ''}
              ${unexcusedNames.length ? `<br><b>Sababsiz:</b> ${unexcusedNames.join(', ')}` : ''}
              `
        }</td>`;
      tbody.appendChild(tr);
      buildBar(document.getElementById(`bar-${cls.id}`),p,e,u);
    }
  }

  refreshGlobalStats();
</script>
</body>
</html>
