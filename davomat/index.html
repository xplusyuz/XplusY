<!DOCTYPE html>
<html lang="uz" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Maktab Davomati — Statistika va sinf rahbari</title>

  <!-- Ikon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- Style -->
  <style>
    :root{
      --primary:#2563eb; --primary-dark:#1d4ed8;
      --success:#10b981; --warning:#f59e0b; --danger:#ef4444;
      --bg:#f9fafb; --card:#ffffff; --shadow:0 4px 20px rgba(0,0,0,.08);
      --radius:14px;
    }
    *{ box-sizing:border-box; margin:0; padding:0; font-family:system-ui,Arial; }
    body{ background:var(--bg); color:#222; }
    header{
      background:linear-gradient(135deg,var(--primary),var(--primary-dark));
      padding:18px; color:#fff; position:sticky; top:0;
      box-shadow:var(--shadow); z-index:20;
    }
    .head{ max-width:1100px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; }
    .logo{ display:flex; gap:12px; align-items:center; }
    .logo i{ background:rgba(255,255,255,.2); padding:12px; border-radius:var(--radius); font-size:20px; }
    main{ max-width:1100px; margin:20px auto; padding:10px; }

    .card{
      background:var(--card); box-shadow:var(--shadow);
      padding:20px; border-radius:var(--radius); margin-bottom:25px;
    }
    .card h2{ font-size:20px; font-weight:700; margin-bottom:6px; }
    table{ width:100%; border-collapse:collapse; }
    th,td{ padding:10px; text-align:left; border-bottom:1px solid #eee; font-size:14px; }
    .progress{ height:6px; background:#e5e7eb; border-radius:6px; overflow:hidden; margin-top:7px; }
    .btn{ cursor:pointer; padding:10px 16px; border-radius:var(--radius); border:none; font-weight:600; }
    .btn-primary{ background:#fff; color:var(--primary); }
    .hidden{ display:none; }

    /* colors */
    .bor{ background:var(--success); }
    .sababli{ background:var(--warning); }
    .sababsiz{ background:var(--danger); }
    .flex{ display:flex; gap:10px; align-items:center; }
    .alert{ padding:10px 14px; border-radius:var(--radius); font-size:14px; margin-bottom:12px; }
    .alert-error{ background:rgba(239,68,68,.15); color:var(--danger); }
    .alert-success{ background:rgba(16,185,129,.15); color:var(--success); }
  </style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="head">
    <div class="logo">
      <i class="fas fa-school"></i>
      <div>
        <b>Maktab Davomati</b> <br>
        <small>Statistika hammaga ochiq</small>
      </div>
    </div>
    <div class="flex">
      <span id="today" style="padding:10px 14px; background:rgba(255,255,255,.2); border-radius:var(--radius);"></span>
      <button id="openLogin" class="btn btn-primary">
        <i class="fas fa-user-tie"></i> Sinf rahbari
      </button>
    </div>
  </div>
</header>

<main>

  <!-- 1) UMUMIY STATISTIKA -->
  <section class="card">
    <h2>Maktab bo‘yicha umumiy statistika</h2>
    <p style="font-size:14px; margin-bottom:16px;">
      Bugun, joriy hafta va oy kesimida. Ranglar:
      <span style="color:var(--success)">bor</span> —
      <span style="color:var(--warning)">sababli</span> —
      <span style="color:var(--danger)">sababsiz</span>
    </p>

    <!-- Bugungi -->
    <h4>Bugun:</h4>
    <h1 id="g_today_percent">--%</h1>
    <div class="progress"><div id="g_today_fill" class="bor" style="width:0%"></div></div>
    <p id="g_today_detail" style="font-size:14px; margin-bottom:15px;"></p>

    <!-- Hafta/Oy (o‘zingiz chart.html dan davom ettirasiz) -->
    <button onclick="location.href='stats.html'" class="btn btn-primary">
      <i class="fas fa-chart-bar"></i> PRO statistik panel
    </button>

    <div style="margin-top:20px;">
      <h3>Sinflar kesimida bugungi holat:</h3>
      <table>
        <thead>
          <tr><th>Sinf</th><th>% bor</th><th>Kelmaganlar</th></tr>
        </thead>
        <tbody id="classTable"></tbody>
      </table>
    </div>
  </section>

  <!-- 2) Login bo‘lim -->
  <section class="card">
    <h2>Sinf rahbari uchun bo‘lim</h2>
    <button id="toggleLogin" class="btn btn-primary">Kirish oynasini ko‘rsatish</button>

    <div id="loginBox" class="hidden" style="margin-top:20px; max-width:350px;">
      <div id="loginAlert" class="alert alert-error hidden"></div>
      <input id="loginInp" placeholder="7A_rahbar" style="width:100%; padding:10px;">
      <input id="passInp" type="password" placeholder="Parol" style="width:100%; padding:10px; margin-top:10px;">
      <button id="doLogin" class="btn btn-primary" style="margin-top:10px;">Kirish</button>
    </div>

    <!-- Kirgandan keyin: sinf panel -->
    <div id="teacherPanel" class="hidden" style="margin-top:20px;">
      <div id="tBadge" class="alert alert-success"></div>

      <input id="attDate" type="date" style="padding:10px; margin-top:10px;">
      <div id="studies"></div>

      <button id="saveAtt" class="btn btn-primary" style="margin-top:15px;">
        Davomatni saqlash
      </button>
      <button id="logout" class="btn" style="margin-left:10px; border:1px solid #999;">
        <i class="fas fa-sign-out-alt"></i> Chiqish
      </button>
    </div>
  </section>

</main>

<script>
/* ====== FIREBASE INIT ====== */
const firebaseConfig = {
  apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  authDomain: "xplusy-760fa.firebaseapp.com",
  projectId: "xplusy-760fa",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ====== DATE ====== */
document.getElementById("today").textContent =
  new Date().toLocaleDateString("uz-UZ", {weekday:"long", day:"numeric", month:"long", year:"numeric"});

/* ====== LOGIN ====== */
let ACTIVE = null;
document.getElementById("toggleLogin").onclick = () => {
  loginBox.classList.toggle("hidden");
};
document.getElementById("doLogin").onclick = async () => {
  const log = loginInp.value.trim(), pass = passInp.value.trim();
  const snf = await fetch('sinf.json').then(r=>r.json()).catch(()=>null);
  if(!snf || !snf[log] || snf[log].pass!==pass){
    loginAlert.textContent = "Login/parol noto‘g‘ri yoki sinf.json xato!";
    loginAlert.classList.remove("hidden");
    return;
  }
  ACTIVE = snf[log];
  loginBox.classList.add("hidden");
  teacherPanel.classList.remove("hidden");
  tBadge.textContent = `${ACTIVE.teacher} • ${ACTIVE.class}`;
  loadStudents(ACTIVE.students);
};
document.getElementById("logout").onclick = () => {
  ACTIVE = null;
  teacherPanel.classList.add("hidden");
  loginBox.classList.remove("hidden");
};

/* ====== STUDENT LIST ====== */
function loadStudents(list){
  let html = `<table><tr><th>#</th><th>F.I.Sh</th><th>Holat</th></tr>`;
  list.forEach((s,i)=>{
    html+=`
    <tr>
      <td>${i+1}</td>
      <td class="st">${s}</td>
      <td>
        <select class="statusSel">
          <option value="present">Bor</option>
          <option value="excused">Sababli</option>
          <option value="unexcused">Sababsiz</option>
        </select>
      </td>
    </tr>`;
  });
  html+="</table>";
  studies.innerHTML=html;
}

/* ====== SAVE ATTENDANCE ====== */
document.getElementById("saveAtt").onclick = async () => {
  if(!ACTIVE) return;
  const d = attDate.value || new Date().toISOString().slice(0,10);
  let pre=0,exc=0,unexc=0;
  const rows = document.querySelectorAll('.statusSel');
  rows.forEach((sel,idx)=>{
    let st = sel.value;
    if(st==="present") pre++;
    if(st==="excused") exc++;
    if(st==="unexcused") unexc++;
  });
  await db.collection('davomat').add({
    date:d, class:ACTIVE.class,
    stats:{presentCount:pre, excusedCount:exc, unexcusedCount:unexc, total:rows.length}
  });
  alert("Davomat saqlandi!");
};

/* ====== GLOBAL STATS ====== */
(async()=> {
  const today = new Date().toISOString().slice(0,10);
  const snap = await db.collection('davomat').where('date','==',today).get();
  let total=0, p=0, e=0, u=0; const perClass={};
  snap.forEach(d=>{
    const s=d.data().stats;
    total+=s.total; p+=s.presentCount; e+=s.excusedCount; u+=s.unexcusedCount;
    perClass[d.data().class]=`${s.presentCount}/${s.excusedCount}/${s.unexcusedCount}/${s.total}`;
  });
  const pct = total? Math.round((p/total)*100):0;
  g_today_percent.textContent = pct+"%";
  g_today_fill.style.width = pct+"%";
  g_today_detail.textContent = `Bor:${p} – Sababli:${e} – Sababsiz:${u} – Jami:${total}`;

  // class table
  let tr="";
  for(let c in perClass){
    const arr = perClass[c].split('/');
    const percent = Math.round((arr[0]/arr[3])*100);
    tr+=`<tr>
      <td>${c}</td>
      <td>${percent}%</td>
      <td>Sababli:${arr[1]} | Sababsiz:${arr[2]}</td>
    </tr>`;
  }
  document.getElementById("classTable").innerHTML = tr;
})();
</script>
</body>
</html>
