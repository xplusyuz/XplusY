<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Maktab Davomati ‚Äî Statistika va sinf rahbari</title>

  <!--
    sinf.json tuzilmasi misol:
    {
      "classes": [
        {
          "id": "7A",
          "name": "7-A sinf",
          "teacherLogin": "7A_rahbar",
          "teacherPassword": "1234",
          "students": [
            { "id": "st1", "fullName": "Aliyev Ali" },
            { "id": "st2", "fullName": "Karimova Laylo" }
          ]
        }
      ]
    }
  -->

  <style>
    :root{
      --brand:#2E8B57; --brand-dark:#1F6B45;
      --bg:#F5FAF7; --card:#FFFFFF;
      --text:#102218; --muted:#667a6f;
      --line:#dfe7e2; --danger:#e63946; --ok:#2E8B57;
      --shadow:0 18px 40px rgba(12,35,22,.16);
      --radius:18px;
      --speed:.25s;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#f0fff6 0,#f5faf7 40%,#edf4ef 100%);
      color:var(--text);
    }
    header{
      position:sticky;top:0;z-index:10;
      backdrop-filter:blur(18px);
      background:linear-gradient(120deg,rgba(244,248,246,.95),rgba(236,246,240,.95));
      border-bottom:1px solid rgba(223,231,226,.9);
    }
    .row{max-width:1120px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:10px;}
    .brand{display:flex;align-items:center;gap:10px;}
    .logo{
      width:34px;height:34px;border-radius:11px;
      background:conic-gradient(from 210deg,#2E8B57,#6B8E23,#2E8B57);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:800;font-size:18px;
      box-shadow:0 10px 26px rgba(26,96,60,.55);
    }
    .brand-title{font-size:18px;font-weight:750;letter-spacing:.03em;}
    .brand-sub{font-size:11px;color:var(--muted);}
    .chip-small{
      font-size:11px;padding:4px 9px;border-radius:999px;
      border:1px solid rgba(46,139,87,.18);
      background:rgba(46,139,87,.06);color:var(--brand-dark);
      display:inline-flex;align-items:center;gap:4px;
    }
    main{
      max-width:1120px;margin:0 auto;
      padding:14px 16px 18px;
      display:grid;gap:12px;
    }
    .card{
      background:rgba(255,255,255,.94);
      border-radius:var(--radius);
      border:1px solid var(--line);
      padding:14px 14px 12px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(14px);
    }
    .card-header{
      display:flex;justify-content:space-between;align-items:center;
      gap:8px;margin-bottom:8px;
    }
    .card-title{font-weight:650;font-size:15px;}
    .card-sub{font-size:12px;color:var(--muted);}
    .grid-2{display:grid;grid-template-columns:2fr 1.6fr;gap:12px;}
    @media(max-width:900px){
      .grid-2{grid-template-columns:1fr;}
    }

    label{font-size:12px;color:var(--muted);display:block;margin-bottom:3px;}
    input,select{
      width:100%;padding:7px 10px;border-radius:10px;
      border:1px solid var(--line);font-size:13px;
      outline:none;background:#f9fcfa;
      transition:border-color var(--speed),box-shadow var(--speed),background .2s;
    }
    input:focus,select:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 1px rgba(46,139,87,.28);
      background:#fff;
    }
    .btn{
      border:none;border-radius:999px;
      padding:7px 13px;font-size:13px;font-weight:600;
      cursor:pointer;display:inline-flex;align-items:center;gap:6px;
      transition:transform .15s,box-shadow .15s,background .15s;
      white-space:nowrap;
    }
    .btn-primary{
      background:linear-gradient(135deg,#2E8B57,#1F6B45);
      color:#fff;box-shadow:0 10px 26px rgba(18,92,55,.5);
    }
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 14px 32px rgba(18,92,55,.6);}
    .btn-ghost{
      background:transparent;border-radius:999px;
      padding:5px 11px;border:1px solid rgba(16,34,24,.12);
      font-size:11px;color:var(--muted);
    }
    .btn-ghost:hover{background:rgba(0,0,0,.02);}
    .btn[disabled]{opacity:.6;cursor:default;box-shadow:none;transform:none;}

    .pill{
      border-radius:999px;padding:3px 8px;font-size:11px;
      background:#eef7f1;color:var(--brand-dark);border:1px solid #cfe3d6;
      display:inline-flex;align-items:center;gap:4px;
    }
    .small{font-size:11px;color:var(--muted);}
    table{width:100%;border-collapse:collapse;font-size:12px;}
    th,td{padding:5px 7px;border-bottom:1px solid #edf3ee;text-align:left;}
    th{font-weight:600;font-size:11px;color:var(--muted);background:#f3faf5;}
    tbody tr:hover{background:#f7fbf8;}

    .stat-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;margin-top:4px;}
    @media(max-width:600px){.stat-grid{grid-template-columns:1fr;}}
    .stat-card{
      border-radius:14px;border:1px solid var(--line);
      padding:8px 10px;font-size:12px;
      background:linear-gradient(135deg,#f9fcfa,#f2f8f4);
    }
    .stat-label{color:var(--muted);font-size:11px;margin-bottom:2px;}
    .stat-value{font-weight:650;font-size:15px;}

    .alert{
      border-radius:12px;padding:7px 9px;font-size:11px;
      display:flex;align-items:flex-start;gap:8px;margin-bottom:6px;
    }
    .alert-icon{font-size:13px;margin-top:2px;}
    .alert-ok{background:#e8f7ee;border:1px solid #b6e1c6;color:#1f6b45;}
    .alert-danger{background:#FEF1F2;border:1px solid #f9c5cb;color:#a41326;}
    .alert-warn{background:#FFF7E5;border:1px solid #f7df99;color:#9a6407;}

    #teacher-panel{margin-top:4px;}
    #teacher-inner{display:none;margin-top:8px;}

    /* Students table */
    #students-table-wrap{max-height:360px;overflow:auto;}
    .status-select{width:auto;}
  </style>
</head>
<body>
<header>
  <div class="row">
    <div class="brand">
      <div class="logo">D</div>
      <div>
        <div class="brand-title">Maktab Davomati</div>
        <div class="brand-sub">Statistika hammaga ochiq ‚Ä¢ Sinf rahbari alohida kiradi</div>
      </div>
    </div>
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
      <span id="today-chip" class="chip-small">Bugungi sana: <span id="today-label"></span></span>
      <button id="open-login-btn" class="btn btn-primary">Sinf rahbari kirishi</button>
    </div>
  </div>
</header>

<main>
  <!-- 1) Barcha uchun ochiq statistika -->
  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">Maktab bo‚Äòyicha umumiy statistika</div>
        <div class="card-sub">Bugun, joriy hafta va oy kesimida davomat. Davomat Firestore‚Äôdan o‚Äòqiladi.</div>
      </div>
      <button id="refresh-global-btn" class="btn-ghost">Yangilash</button>
    </div>
    <div class="stat-grid">
      <div class="stat-card">
        <div class="stat-label">Bugun</div>
        <div class="stat-value" id="g-today-value">‚Äî</div>
        <div class="small" id="g-today-detail"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Joriy hafta</div>
        <div class="stat-value" id="g-week-value">‚Äî</div>
        <div class="small" id="g-week-detail"></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Joriy oy</div>
        <div class="stat-value" id="g-month-value">‚Äî</div>
        <div class="small" id="g-month-detail"></div>
      </div>
    </div>
    <div style="margin-top:10px;">
      <div class="small" style="margin-bottom:4px;">Sinflar kesimida bugungi davomat:</div>
      <div style="max-height:220px;overflow:auto;border-radius:12px;border:1px solid #edf3ee;">
        <table>
          <thead>
            <tr>
              <th>Sinf</th>
              <th>Bugun (%)</th>
              <th>Davomat (bor/yo‚Äòq/jami)</th>
            </tr>
          </thead>
          <tbody id="g-classes-tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 2) Sinf rahbari login + davomat paneli -->
  <section id="teacher-panel" class="card">
    <div class="card-header">
      <div>
        <div class="card-title">Sinf rahbari uchun bo‚Äòlim</div>
        <div class="card-sub">
          Kirish majburiy emas. Agar sinf rahbarisiz, faqat yuqoridagi statistikani ko‚Äòrsangiz ham bo‚Äòladi.
        </div>
      </div>
      <button id="toggle-login-card" class="btn-ghost">Kirish oynasini ko‚Äòrsatish</button>
    </div>

    <!-- login card -->
    <div id="login-card" style="max-width:360px;margin-bottom:10px;display:none;">
      <div class="alert alert-warn" id="login-alert" style="display:none;">
        <div class="alert-icon">‚ö†Ô∏è</div>
        <div id="login-alert-text">Noto‚Äòg‚Äòri login yoki parol.</div>
      </div>
      <label for="login-input">Login (sinf.json dagi)</label>
      <input id="login-input" placeholder="masalan: 7A_rahbar">
      <label for="password-input" style="margin-top:6px;">Parol</label>
      <input id="password-input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <button id="login-btn" class="btn btn-primary" style="margin-top:8px;">Kirish</button>
      <div class="small" style="margin-top:4px;">
        Sinf va login/parollar <b>sinf.json</b> faylidan olinadi. Admin paneldan o‚Äòzgarmaydi.
      </div>
    </div>

    <!-- kirgandan keyingi panel -->
    <div id="teacher-inner">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px;">
        <div>
          <div class="small">Sinf rahbari:</div>
          <div class="pill" id="t-teacher-pill">‚Äî</div>
        </div>
        <div>
          <label for="date-input">Sana</label>
          <input id="date-input" type="date">
        </div>
        <button id="logout-btn" class="btn-ghost">Chiqish</button>
      </div>

      <div id="day-alerts"></div>

      <div class="grid-2">
        <div>
          <div class="small" id="class-info-sub"></div>
          <div id="students-empty" class="small" style="margin-top:6px;">
            Bu sinf uchun o‚Äòquvchilar ro‚Äòyxati topilmadi. sinf.json faylini tekshiring.
          </div>
          <div id="students-table-wrap" style="display:none;margin-top:6px;">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>F.I.Sh.</th>
                  <th>Holat</th>
                </tr>
              </thead>
              <tbody id="students-tbody"></tbody>
            </table>
          </div>
          <button id="save-btn" class="btn btn-primary" style="margin-top:8px;">Davomatni saqlash</button>
        </div>
        <div>
          <div class="small">Sinf statistkasi (faqat shu sinf):</div>
          <div class="stat-card" style="margin-top:4px;">
            <div class="stat-label">Bugun</div>
            <div class="stat-value" id="t-today-value">‚Äî</div>
            <div class="small" id="t-today-detail"></div>
          </div>
          <div class="stat-grid" style="margin-top:6px;">
            <div class="stat-card">
              <div class="stat-label">Joriy hafta</div>
              <div class="stat-value" id="t-week-value">‚Äî</div>
              <div class="small" id="t-week-detail"></div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Joriy oy</div>
              <div class="stat-value" id="t-month-value">‚Äî</div>
              <div class="small" id="t-month-detail"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

<script>
  // üîß FIREBASE CONFIGNI O'ZGARTIRASAN
  const firebaseConfig = {
    apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  authDomain: "xplusy-760fa.firebaseapp.com",
  projectId: "xplusy-760fa",
  storageBucket: "xplusy-760fa.firebasestorage.app",
  messagingSenderId: "992512966017",
  appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
  measurementId: "G-459PLJ7P7L"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const davomatCol  = db.collection('davomat');
  const settingsDoc = db.collection('davomat_settings').doc('global');

  let settings = { holidays:[], extraSchoolDays:[] };
  let classesJson = [];      // sinf.json dan keladigan sinflar
  let currentTeacher = null; // {classObj, teacherName, login}
  let currentDateStr = null;

  // === Helpers ===
  function toDateStr(d){
    const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function formatDateLabel(dateStr){
    const d=new Date(dateStr);
    const days=['Yakshanba','Dushanba','Seshanba','Chorshanba','Payshanba','Juma','Shanba'];
    return days[d.getDay()] + ', ' + d.toLocaleDateString('uz-UZ');
  }
  function weekRangeFor(dateStr){
    const d=new Date(dateStr);
    const day=d.getDay();
    const diffToMon=(day===0?-6:1-day);
    const start=new Date(d);start.setDate(d.getDate()+diffToMon);
    const end=new Date(start);end.setDate(start.getDate()+6);
    return {start:toDateStr(start),end:toDateStr(end)};
  }
  function monthRangeFor(dateStr){
    const d=new Date(dateStr);
    const s=new Date(d.getFullYear(),d.getMonth(),1);
    const e=new Date(d.getFullYear(),d.getMonth()+1,0);
    return {start:toDateStr(s),end:toDateStr(e)};
  }
  function isWeekend(dateStr){
    const d=new Date(dateStr);const day=d.getDay();
    return day===0 || day===6;
  }
  function isInHoliday(dateStr){
    if(!settings.holidays) return null;
    for(const h of settings.holidays){
      if(dateStr>=h.start && dateStr<=h.end) return h;
    }
    return null;
  }
  function isExtraSchoolDay(dateStr){
    return (settings.extraSchoolDays||[]).includes(dateStr);
  }
  function isSchoolDay(dateStr){
    if(isInHoliday(dateStr)) return false;
    if(isWeekend(dateStr)) return isExtraSchoolDay(dateStr);
    return true;
  }

  // === Elements ===
  const todayLabel = document.getElementById('today-label');

  // Global stats
  const gTodayValue=document.getElementById('g-today-value');
  const gTodayDetail=document.getElementById('g-today-detail');
  const gWeekValue=document.getElementById('g-week-value');
  const gWeekDetail=document.getElementById('g-week-detail');
  const gMonthValue=document.getElementById('g-month-value');
  const gMonthDetail=document.getElementById('g-month-detail');
  const gClassesTbody=document.getElementById('g-classes-tbody');
  const refreshGlobalBtn=document.getElementById('refresh-global-btn');

  // Teacher panel
  const openLoginBtn=document.getElementById('open-login-btn');
  const toggleLoginCardBtn=document.getElementById('toggle-login-card');
  const loginCard=document.getElementById('login-card');
  const loginAlert=document.getElementById('login-alert');
  const loginAlertText=document.getElementById('login-alert-text');
  const loginInput=document.getElementById('login-input');
  const passwordInput=document.getElementById('password-input');
  const loginBtn=document.getElementById('login-btn');
  const teacherInner=document.getElementById('teacher-inner');
  const logoutBtn=document.getElementById('logout-btn');
  const tTeacherPill=document.getElementById('t-teacher-pill');
  const dateInput=document.getElementById('date-input');
  const dayAlerts=document.getElementById('day-alerts');
  const classInfoSub=document.getElementById('class-info-sub');
  const studentsEmpty=document.getElementById('students-empty');
  const studentsTableWrap=document.getElementById('students-table-wrap');
  const studentsTbody=document.getElementById('students-tbody');
  const saveBtn=document.getElementById('save-btn');

  const tTodayValue=document.getElementById('t-today-value');
  const tTodayDetail=document.getElementById('t-today-detail');
  const tWeekValue=document.getElementById('t-week-value');
  const tWeekDetail=document.getElementById('t-week-detail');
  const tMonthValue=document.getElementById('t-month-value');
  const tMonthDetail=document.getElementById('t-month-detail');

  // === Load base data ===
  async function loadSettings(){
    const snap=await settingsDoc.get();
    if(snap.exists){
      settings=snap.data();
      settings.holidays=settings.holidays||[];
      settings.extraSchoolDays=settings.extraSchoolDays||[];
    }else{
      settings={holidays:[],extraSchoolDays:[]};
    }
  }
  async function loadClassesJson(){
    try{
      const res=await fetch('sinf.json?v='+Date.now());
      if(!res.ok) throw new Error('sinf.json topilmadi');
      const data=await res.json();
      classesJson=data.classes||[];
    }catch(e){
      console.warn('sinf.json o‚Äòqishda xato:',e);
      classesJson=[];
    }
  }

  // === Global stats ===
  async function refreshGlobalStats(){
    const today=toDateStr(new Date());
    const wr=weekRangeFor(today);
    const mr=monthRangeFor(today);

    // Bugun
    const todaySnap=await davomatCol.where('date','==',today).get();
    let tPresent=0,tTotal=0;
    todaySnap.forEach(doc=>{
      const s=doc.data().stats||{};
      tPresent+=s.presentCount||0;
      tTotal+=s.total||0;
    });
    if(tTotal){
      const p=Math.round(tPresent*100/tTotal);
      gTodayValue.textContent=p+'%';
      gTodayDetail.textContent=`Bor: ${tPresent} / Jami: ${tTotal}`;
    }else{
      gTodayValue.textContent='‚Äî';
      gTodayDetail.textContent='Bugun uchun davomat hali kiritilmagan.';
    }

    // Hafta
    const wSnap=await davomatCol
      .where('date','>=',wr.start)
      .where('date','<=',wr.end)
      .get();
    let wPresent=0,wTotal=0;
    wSnap.forEach(doc=>{
      const s=doc.data().stats||{};
      wPresent+=s.presentCount||0;
      wTotal+=s.total||0;
    });
    if(wTotal){
      const p=Math.round(wPresent*100/wTotal);
      gWeekValue.textContent=p+'%';
      gWeekDetail.textContent=`Kunlar soni: ${wSnap.size}`;
    }else{
      gWeekValue.textContent='‚Äî';
      gWeekDetail.textContent='Joriy haftada davomat ma‚Äôlumoti yo‚Äòq.';
    }

    // Oy
    const mSnap=await davomatCol
      .where('date','>=',mr.start)
      .where('date','<=',mr.end)
      .get();
    let mPresent=0,mTotal=0;
    mSnap.forEach(doc=>{
      const s=doc.data().stats||{};
      mPresent+=s.presentCount||0;
      mTotal+=s.total||0;
    });
    if(mTotal){
      const p=Math.round(mPresent*100/mTotal);
      gMonthValue.textContent=p+'%';
      gMonthDetail.textContent=`Kunlar soni: ${mSnap.size}`;
    }else{
      gMonthValue.textContent='‚Äî';
      gMonthDetail.textContent='Joriy oyda davomat ma‚Äôlumoti yo‚Äòq.';
    }

    // Sinflar kesimida bugun
    gClassesTbody.innerHTML='';
    for(const cls of classesJson){
      const docId=`${today}_${cls.id}`;
      const snap=await davomatCol.doc(docId).get();
      let percent='‚Äî',detail='‚Äî';
      if(snap.exists){
        const s=snap.data().stats||{};
        const total=s.total||0;
        const present=s.presentCount||0;
        const absent=s.absentCount||0;
        if(total){
          percent=Math.round(present*100/total)+'%';
          detail=`${present}/${absent}/${total}`;
        }else{
          percent='0%';
          detail=`0/${absent}/${total}`;
        }
      }
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${cls.name || cls.id}</td>
        <td>${percent}</td>
        <td>${detail}</td>
      `;
      gClassesTbody.appendChild(tr);
    }
  }

  // === Teacher login / panel ===
  function showLoginError(msg){
    loginAlertText.textContent=msg;
    loginAlert.style.display='flex';
  }
  function clearLoginError(){loginAlert.style.display='none';}

  function toggleLoginCard(){
    loginCard.style.display = loginCard.style.display==='none' ? 'block' : 'none';
    toggleLoginCardBtn.textContent = loginCard.style.display==='none' ? 'Kirish oynasini ko‚Äòrsatish' : 'Kirish oynasini yashirish';
  }

  async function handleLogin(){
    clearLoginError();
    const login=loginInput.value.trim();
    const pw=passwordInput.value;
    if(!login||!pw){
      showLoginError("Login va parolni kiriting.");
      return;
    }
    const cls=classesJson.find(c=>c.teacherLogin===login && c.teacherPassword===pw);
    if(!cls){
      showLoginError("Login/parol mos kelmadi yoki sinf.json noto‚Äòg‚Äòri.");
      return;
    }
    currentTeacher={
      login,
      teacherName: cls.teacherName || cls.teacherLogin || login,
      classObj: cls
    };
    localStorage.setItem('davomat_teacher_login',login);
    localStorage.setItem('davomat_teacher_class',cls.id);

    // UI
    tTeacherPill.textContent = (cls.teacherName || 'Sinf rahbari') + " ‚Ä¢ " + (cls.name || cls.id);
    teacherInner.style.display='block';
    loginCard.style.display='none';

    const today=toDateStr(new Date());
    currentDateStr=today;
    dateInput.value=today;
    await renderDayState();
    await renderStudents();
    await refreshTeacherStats();
  }

  function restoreTeacherSession(){
    const login=localStorage.getItem('davomat_teacher_login');
    const classId=localStorage.getItem('davomat_teacher_class');
    if(!login||!classId) return;
    const cls=classesJson.find(c=>c.id===classId && c.teacherLogin===login);
    if(!cls) return;
    currentTeacher={
      login,
      teacherName: cls.teacherName || cls.teacherLogin || login,
      classObj: cls
    };
    tTeacherPill.textContent = (cls.teacherName || 'Sinf rahbari') + " ‚Ä¢ " + (cls.name || cls.id);
    teacherInner.style.display='block';
    loginCard.style.display='none';
  }

  function logoutTeacher(){
    currentTeacher=null;
    teacherInner.style.display='none';
    localStorage.removeItem('davomat_teacher_login');
    localStorage.removeItem('davomat_teacher_class');
  }

  async function renderStudents(){
    if(!currentTeacher) return;
    const cls=currentTeacher.classObj;
    const students=cls.students||[];
    if(!students.length){
      studentsEmpty.style.display='block';
      studentsTableWrap.style.display='none';
      classInfoSub.textContent= (cls.name||cls.id) + " ‚Äî o‚Äòquvchilar ro‚Äòyxati yo‚Äòq (sinf.json).";
      return;
    }
    classInfoSub.textContent = (cls.name||cls.id) + " ‚Äî o‚Äòquvchilar soni: " + students.length;

    const docId=`${currentDateStr}_${cls.id}`;
    const snap=await davomatCol.doc(docId).get();
    const existingMap={};
    if(snap.exists){
      (snap.data().students||[]).forEach(st=>{
        existingMap[st.id]=st.status;
      });
    }

    studentsTbody.innerHTML='';
    students.forEach((st,idx)=>{
      const tr=document.createElement('tr');
      const status=existingMap[st.id]||'present';
      tr.innerHTML=`
        <td>${idx+1}</td>
        <td>${st.fullName || ''}</td>
        <td>
          <select class="status-select" data-student-id="${st.id}">
            <option value="present">Bor</option>
            <option value="absent">Yo‚Äòq</option>
          </select>
        </td>
      `;
      studentsTbody.appendChild(tr);
      tr.querySelector('select').value=status;
    });

    studentsEmpty.style.display='none';
    studentsTableWrap.style.display='block';
  }

  async function renderDayState(){
    dayAlerts.innerHTML='';
    if(!currentTeacher || !currentDateStr) return;

    const cls=currentTeacher.classObj;
    const holiday=isInHoliday(currentDateStr);
    const weekend=isWeekend(currentDateStr);
    const schoolDay=isSchoolDay(currentDateStr);

    const docId=`${currentDateStr}_${cls.id}`;
    const snap=await davomatCol.doc(docId).get();
    const hasAttendance=snap.exists;

    if(!schoolDay){
      let msg='Bugun dars kuni emas. Davomat kiritish talab qilinmaydi.';
      if(holiday){
        msg=`Bugun ta‚Äôtil: ${holiday.title || ''}. Davomat kiritilmaydi.`;
      }else if(weekend){
        msg='Shanba-yakshanba odatda dam kuni. Agar bu kunni ish kuni qilib qo‚Äòshgan bo‚Äòlsangiz, admin panelda extra kun sifatida belgilangan bo‚Äòladi.';
      }
      const div=document.createElement('div');
      div.className='alert alert-ok';
      div.innerHTML=`<div class="alert-icon">üõå</div><div>${msg}</div>`;
      dayAlerts.appendChild(div);
      saveBtn.disabled=true;
      return;
    }

    const div=document.createElement('div');
    if(hasAttendance){
      div.className='alert alert-ok';
      div.innerHTML=`<div class="alert-icon">‚úÖ</div><div>Bu sana uchun davomat <b>kiritilgan</b>. Zarurat bo‚Äòlsa tahrirlashingiz mumkin.</div>`;
    }else{
      div.className='alert alert-danger';
      div.innerHTML=`<div class="alert-icon">‚ö†Ô∏è</div><div>Bugungi davomat hali <b>to‚Äòldirilmagan</b>. Kunda boshida sinf davomatini kiriting.</div>`;
    }
    dayAlerts.appendChild(div);
    saveBtn.disabled=false;
  }

  async function saveAttendance(){
    if(!currentTeacher||!currentDateStr) return;
    if(!isSchoolDay(currentDateStr)){
      alert("Bu sana dars kuni emas (ta‚Äôtil yoki dam kuni). Admin panelda ish kuni qilib belgilanmagan bo‚Äòlsa davomat kiritilmaydi.");
      return;
    }
    const cls=currentTeacher.classObj;
    const students=cls.students||[];
    if(!students.length){
      alert("Bu sinf uchun o‚Äòquvchilar ro‚Äòyxati sinf.json da yo‚Äòq.");
      return;
    }

    const rows=studentsTbody.querySelectorAll('tr');
    const resStudents=[];
    let presentCount=0,absentCount=0;
    students.forEach((st,idx)=>{
      const row=rows[idx];
      const sel=row.querySelector('select');
      const status=sel.value;
      resStudents.push({id:st.id,fullName:st.fullName,status});
      if(status==='present') presentCount++; else absentCount++;
    });
    const total=students.length;
    const docId=`${currentDateStr}_${cls.id}`;

    saveBtn.disabled=true;
    saveBtn.textContent="Saqlanmoqda...";
    try{
      await davomatCol.doc(docId).set({
        date: currentDateStr,
        classId: cls.id,
        className: cls.name || cls.id,
        teacherLogin: currentTeacher.login,
        teacherName: currentTeacher.teacherName,
        students: resStudents,
        stats:{total,presentCount,absentCount},
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      },{merge:true});
      await renderDayState();
      await refreshTeacherStats();
      await refreshGlobalStats(); // umumiy statistikani ham yangilab qo'yamiz
      alert("Davomat saqlandi.");
    }catch(e){
      console.error(e);
      alert("Saqlashda xatolik.");
    }finally{
      saveBtn.disabled=false;
      saveBtn.textContent="Davomatni saqlash";
    }
  }

  async function refreshTeacherStats(){
    if(!currentTeacher||!currentDateStr) return;
    const cls=currentTeacher.classObj;
    const todayDocId=`${currentDateStr}_${cls.id}`;
    const todaySnap=await davomatCol.doc(todayDocId).get();
    if(todaySnap.exists){
      const s=todaySnap.data().stats||{};
      const total=s.total||0,present=s.presentCount||0,absent=s.absentCount||0;
      const p=total?Math.round(present*100/total):0;
      tTodayValue.textContent=p+'%';
      tTodayDetail.textContent=`Bor: ${present} / Yo‚Äòq: ${absent} / Jami: ${total}`;
    }else{
      tTodayValue.textContent='‚Äî';
      tTodayDetail.textContent='Bugun uchun davomat kiritilmagan.';
    }

    const wr=weekRangeFor(currentDateStr);
    const wSnap=await davomatCol
      .where('classId','==',cls.id)
      .where('date','>=',wr.start)
      .where('date','<=',wr.end)
      .get();
    let wP=0,wT=0;
    wSnap.forEach(doc=>{
      const s=doc.data().stats||{};
      wP+=s.presentCount||0; wT+=s.total||0;
    });
    if(wT){
      const p=Math.round(wP*100/wT);
      tWeekValue.textContent=p+'%';
      tWeekDetail.textContent=`Kunlar soni: ${wSnap.size}`;
    }else{
      tWeekValue.textContent='‚Äî';
      tWeekDetail.textContent='Joriy haftada davomat kiritilmagan.';
    }

    const mr=monthRangeFor(currentDateStr);
    const mSnap=await davomatCol
      .where('classId','==',cls.id)
      .where('date','>=',mr.start)
      .where('date','<=',mr.end)
      .get();
    let mP=0,mT=0;
    mSnap.forEach(doc=>{
      const s=doc.data().stats||{};
      mP+=s.presentCount||0; mT+=s.total||0;
    });
    if(mT){
      const p=Math.round(mP*100/mT);
      tMonthValue.textContent=p+'%';
      tMonthDetail.textContent=`Kunlar soni: ${mSnap.size}`;
    }else{
      tMonthValue.textContent='‚Äî';
      tMonthDetail.textContent='Joriy oyda davomat kiritilmagan.';
    }
  }

  // === Events ===
  refreshGlobalBtn.addEventListener('click', refreshGlobalStats);
  openLoginBtn.addEventListener('click', ()=>{
    toggleLoginCard();
    window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
  });
  toggleLoginCardBtn.addEventListener('click', toggleLoginCard);
  loginBtn.addEventListener('click', handleLogin);
  passwordInput.addEventListener('keydown', e=>{if(e.key==='Enter') handleLogin();});
  logoutBtn.addEventListener('click', logoutTeacher);
  dateInput.addEventListener('change', async ()=>{
    if(!dateInput.value) return;
    currentDateStr=dateInput.value;
    await renderDayState();
    await renderStudents();
    await refreshTeacherStats();
  });
  saveBtn.addEventListener('click', saveAttendance);

  // === Init ===
  (async function init(){
    const today=toDateStr(new Date());
    todayLabel.textContent=formatDateLabel(today);

    await loadSettings();
    await loadClassesJson();
    await refreshGlobalStats();
    restoreTeacherSession();
    if(currentTeacher){
      const todayStr=today;
      currentDateStr=todayStr;
      dateInput.value=todayStr;
      await renderDayState();
      await renderStudents();
      await refreshTeacherStats();
    }
  })();
</script>
</body>
</html>
