<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Maktab Davomati ‚Äî Sinf rahbari</title>

  <style>
    :root{
      --brand:#2E8B57; --brand-dark:#1F6B45;
      --bg:#F5FAF7; --card:#FFFFFF;
      --text:#102218; --muted:#667a6f;
      --line:#dfe7e2; --danger:#e63946; --ok:#2E8B57;
      --shadow:0 18px 40px rgba(12,35,22,.16);
      --radius:18px;
      --speed:.25s;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#f0fff6 0,#f5faf7 40%,#edf4ef 100%);
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .app{
      width:100%;
      max-width:1000px;
      background:rgba(255,255,255,.92);
      border-radius:24px;
      box-shadow:var(--shadow);
      padding:20px 18px 18px;
      backdrop-filter:blur(14px);
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:16px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo{
      width:36px;height:36px;border-radius:12px;
      background:conic-gradient(from 210deg,#2E8B57,#6B8E23,#2E8B57);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:800;font-size:18px;
      box-shadow:0 10px 30px rgba(26,96,60,.55);
    }
    .brand-text{display:flex;flex-direction:column}
    .brand-title{font-weight:750;font-size:18px;letter-spacing:.03em}
    .brand-sub{font-size:12px;color:var(--muted)}
    .chip-small{
      font-size:11px;padding:4px 9px;border-radius:999px;
      border:1px solid rgba(46,139,87,.18);
      background:rgba(46,139,87,.06);color:var(--brand-dark);
      display:inline-flex;align-items:center;gap:4px;
    }

    /* Cards */
    .card{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid var(--line);
      padding:16px 14px;
      margin-bottom:12px;
    }
    .card-header{
      display:flex;justify-content:space-between;align-items:center;
      gap:8px;margin-bottom:10px;
    }
    .card-title{font-weight:600;font-size:15px}
    .card-sub{font-size:12px;color:var(--muted)}

    /* Inputs & buttons */
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:4px;}
    input,select{
      width:100%;padding:8px 10px;border-radius:10px;
      border:1px solid var(--line);font-size:14px;
      outline:none;transition:border-color var(--speed),box-shadow var(--speed),background .2s;
      background:#f9fcfa;
    }
    input:focus,select:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 1px rgba(46,139,87,.3);
      background:#fff;
    }
    .btn{
      border:none;border-radius:999px;
      padding:8px 14px;font-size:14px;font-weight:600;
      cursor:pointer;display:inline-flex;align-items:center;gap:6px;
      transition:transform .15s ease,box-shadow .15s ease,background .15s;
      white-space:nowrap;
    }
    .btn-primary{
      background:linear-gradient(135deg,#2E8B57,#1F6B45);
      color:#fff;
      box-shadow:0 12px 30px rgba(18,92,55,.5);
    }
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 16px 36px rgba(18,92,55,.6);}
    .btn-ghost{
      background:transparent;border-radius:999px;
      padding:6px 12px;border:1px solid rgba(16,34,24,.1);
      font-size:12px;color:var(--muted);
    }
    .btn-ghost:hover{background:rgba(0,0,0,.02);}
    .btn[disabled]{opacity:.6;cursor:default;box-shadow:none;transform:none;}

    /* Badges / alerts */
    .alert{
      border-radius:14px;padding:8px 10px;font-size:12px;
      display:flex;align-items:flex-start;gap:8px;
      margin-bottom:8px;
    }
    .alert-icon{font-size:14px;margin-top:2px}
    .alert-danger{background:#FEF1F2;border:1px solid #f9c5cb;color:#a41326;}
    .alert-ok{background:#e8f7ee;border:1px solid #b6e1c6;color:#1f6b45;}
    .alert-warn{background:#FFF7E5;border:1px solid #f7df99;color:#9a6407;}

    /* Login state layouts */
    #login-view{max-width:360px;margin:0 auto;}
    #app-view{display:none;}

    .login-title{font-weight:650;font-size:18px;margin-bottom:4px;}
    .login-sub{font-size:13px;color:var(--muted);margin-bottom:14px;}
    .login-grid{display:flex;flex-direction:column;gap:10px;margin-top:8px;}

    /* Layout for teacher view */
    .grid{
      display:grid;
      grid-template-columns: minmax(0,2.2fr) minmax(0,1.5fr);
      gap:12px;
    }
    @media(max-width:800px){
      body{align-items:flex-start;}
      .app{max-height:none;}
      .grid{grid-template-columns:1fr;}
    }

    /* Table */
    table{width:100%;border-collapse:collapse;font-size:13px;}
    thead{background:#f3faf5;}
    th,td{padding:6px 8px;border-bottom:1px solid #edf3ee;text-align:left;}
    th{font-weight:600;font-size:12px;color:var(--muted);}
    tbody tr:hover{background:#f7fbf8;}
    .status-chip{
      display:inline-flex;align-items:center;gap:4px;
      border-radius:999px;padding:3px 8px;font-size:11px;
    }
    .status-present{background:#e5f6ec;color:#1f6b45;}
    .status-absent{background:#fde5e7;color:#b0202f;}

    .stats-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;}
    .stat-card{
      flex:1 1 110px;
      border-radius:12px;border:1px solid var(--line);
      padding:8px 10px;font-size:12px;
      background:linear-gradient(135deg,#f9fcfa,#f2f8f4);
    }
    .stat-label{color:var(--muted);font-size:11px;margin-bottom:2px;}
    .stat-value{font-weight:650;font-size:15px;}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo">D</div>
        <div class="brand-text">
          <div class="brand-title">Maktab Davomati</div>
          <div class="brand-sub">Sinf rahbari uchun sodda tizim</div>
        </div>
      </div>
      <div id="user-pill" style="display:none;align-items:center;gap:10px;">
        <div style="text-align:right;">
          <div style="font-size:13px;font-weight:600;" id="user-name"></div>
          <div style="font-size:11px;color:var(--muted);" id="user-class"></div>
        </div>
        <button class="btn-ghost" id="logout-btn">Chiqish</button>
      </div>
      <span id="day-chip" class="chip-small">
        <span id="day-chip-text">Bugungi kun</span>
      </span>
    </header>

    <!-- LOGIN VIEW -->
    <div id="login-view" class="card">
      <div class="login-title">Sinf rahbari kirishi</div>
      <div class="login-sub">Sizga berilgan <b>login</b> va <b>parol</b>ni kiriting.</div>
      <div id="login-alert" class="alert alert-danger" style="display:none;">
        <div class="alert-icon">‚ö†Ô∏è</div>
        <div id="login-alert-text">Noto‚Äòg‚Äòri login yoki parol.</div>
      </div>
      <div class="login-grid">
        <div>
          <label for="login-input">Login</label>
          <input id="login-input" autocomplete="username" placeholder="masalan: 7A_rahbar"/>
        </div>
        <div>
          <label for="password-input">Parol</label>
          <input id="password-input" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>
        <button class="btn btn-primary" id="login-btn">Kirish</button>
      </div>
    </div>

    <!-- APP VIEW -->
    <div id="app-view">
      <!-- Eslatma / holat bloklari -->
      <div id="info-card" class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Bugungi kun holati</div>
            <div class="card-sub" id="today-label"></div>
          </div>
          <div style="display:flex;align-items:center;gap:6px;">
            <label for="date-input" style="margin:0;font-size:11px;">Sana</label>
            <input type="date" id="date-input" style="width:auto;">
          </div>
        </div>
        <div id="day-alerts"></div>
      </div>

      <div class="grid">
        <!-- LEFT: Students + save -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Sinf o‚Äòquvchilari</div>
              <div class="card-sub" id="class-info-sub"></div>
            </div>
            <button class="btn btn-primary" id="save-btn">Davomatni saqlash</button>
          </div>
          <div id="students-empty" style="font-size:13px;color:var(--muted);">
            Bu sinf uchun o‚Äòquvchilar ro‚Äòyxati yuklanmagan. Admin paneldan yuklang.
          </div>
          <div id="students-table-wrap" style="max-height:360px;overflow:auto;display:none;">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>F.I.Sh.</th>
                  <th>Holat</th>
                </tr>
              </thead>
              <tbody id="students-tbody"></tbody>
            </table>
          </div>
        </div>

        <!-- RIGHT: Stats -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Statistika (faqat shu sinf)</div>
              <div class="card-sub">Bugun, joriy hafta va oy bo‚Äòyicha davomat.</div>
            </div>
          </div>
          <div>
            <div class="stat-card">
              <div class="stat-label">Bugungi davomat</div>
              <div class="stat-value" id="stat-today-value">‚Äî</div>
              <div style="font-size:11px;color:var(--muted);" id="stat-today-detail"></div>
            </div>
            <div class="stats-row">
              <div class="stat-card">
                <div class="stat-label">Joriy hafta</div>
                <div class="stat-value" id="stat-week-value">‚Äî</div>
                <div style="font-size:11px;color:var(--muted);" id="stat-week-detail"></div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Joriy oy</div>
                <div class="stat-value" id="stat-month-value">‚Äî</div>
                <div style="font-size:11px;color:var(--muted);" id="stat-month-detail"></div>
              </div>
            </div>
          </div>
        </div>
      </div><!-- /grid -->
    </div><!-- /app-view -->
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    // üîß BU YERGA O'ZINGNING FIREBASE CONFIGINGNI QO'YASAN
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      // ...
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const teachersCol = db.collection('davomat_teachers');
    const classesCol  = db.collection('davomat_classes');
    const settingsDoc = db.collection('davomat_settings').doc('global');
    const davomatCol  = db.collection('davomat');

    let currentTeacher = null;
    let currentClass = null;
    let currentSettings = { holidays: [], extraSchoolDays: [] };
    let currentDateStr = null;

    // === Helpers ===
    function formatDateLabel(dateStr){
      const d = new Date(dateStr);
      const days = ['Yakshanba','Dushanba','Seshanba','Chorshanba','Payshanba','Juma','Shanba'];
      return days[d.getDay()] + ', ' + d.toLocaleDateString('uz-UZ');
    }
    function toDateStr(d){
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,'0');
      const day=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }
    function isWeekend(dateStr){
      const d = new Date(dateStr);
      const day = d.getDay(); // 0=Yak, 6=Shan
      return day === 0 || day === 6;
    }
    function isInHoliday(dateStr){
      const dStr = dateStr;
      if(!currentSettings.holidays) return null;
      for(const h of currentSettings.holidays){
        if(dStr >= h.start && dStr <= h.end){
          return h;
        }
      }
      return null;
    }
    function isExtraSchoolDay(dateStr){
      return (currentSettings.extraSchoolDays || []).includes(dateStr);
    }
    function isSchoolDay(dateStr){
      // 1) Ta'til bo'lsa har doim dars yo'q
      if(isInHoliday(dateStr)) return false;
      // 2) Yakshanba/ Shanba default dam. Agar extraSchoolDays ichida bo'lsa ‚Äî dars bor
      if(isWeekend(dateStr)){
        return isExtraSchoolDay(dateStr);
      }
      // 3) Dushanba‚ÄìJuma ‚Äî dars bor
      return true;
    }

    async function hashPassword(password){
      const enc = new TextEncoder().encode(password);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    function setDayChipText(dateStr){
      const today = toDateStr(new Date());
      const chip = document.getElementById('day-chip-text');
      if(dateStr === today) chip.textContent = "Bugungi kun";
      else chip.textContent = "Tanlangan sana";
    }

    // === UI hooks ===
    const loginView = document.getElementById('login-view');
    const appView   = document.getElementById('app-view');
    const loginBtn  = document.getElementById('login-btn');
    const loginInput = document.getElementById('login-input');
    const passwordInput = document.getElementById('password-input');
    const loginAlert = document.getElementById('login-alert');
    const loginAlertText = document.getElementById('login-alert-text');

    const userPill = document.getElementById('user-pill');
    const userNameEl = document.getElementById('user-name');
    const userClassEl = document.getElementById('user-class');
    const logoutBtn = document.getElementById('logout-btn');

    const dateInput = document.getElementById('date-input');
    const dayAlerts = document.getElementById('day-alerts');
    const todayLabel = document.getElementById('today-label');
    const classInfoSub = document.getElementById('class-info-sub');

    const studentsEmpty = document.getElementById('students-empty');
    const studentsTableWrap = document.getElementById('students-table-wrap');
    const studentsTbody = document.getElementById('students-tbody');
    const saveBtn = document.getElementById('save-btn');

    const statTodayValue = document.getElementById('stat-today-value');
    const statTodayDetail = document.getElementById('stat-today-detail');
    const statWeekValue = document.getElementById('stat-week-value');
    const statWeekDetail = document.getElementById('stat-week-detail');
    const statMonthValue = document.getElementById('stat-month-value');
    const statMonthDetail = document.getElementById('stat-month-detail');

    function showLoginError(msg){
      loginAlertText.textContent = msg;
      loginAlert.style.display = 'flex';
    }
    function clearLoginError(){ loginAlert.style.display = 'none'; }

    async function loadSettings(){
      const snap = await settingsDoc.get();
      if(snap.exists){
        currentSettings = snap.data();
        currentSettings.holidays = currentSettings.holidays || [];
        currentSettings.extraSchoolDays = currentSettings.extraSchoolDays || [];
      }else{
        currentSettings = { holidays:[], extraSchoolDays:[] };
      }
    }

    async function handleLogin(){
      clearLoginError();
      const login = loginInput.value.trim();
      const pw = passwordInput.value;
      if(!login || !pw){
        showLoginError("Login va parolni to‚Äòliq kiriting.");
        return;
      }
      loginBtn.disabled = true;
      loginBtn.textContent = "Tekshirilmoqda...";

      try{
        const snap = await teachersCol.where('login','==',login).limit(1).get();
        if(snap.empty){
          showLoginError("Bunday login topilmadi.");
        }else{
          const doc = snap.docs[0];
          const teacher = { id:doc.id, ...doc.data() };
          const hash = await hashPassword(pw);
          if(hash !== teacher.passwordHash){
            showLoginError("Noto‚Äòg‚Äòri parol.");
          }else{
            currentTeacher = teacher;
            localStorage.setItem('davomat_teacher_id', teacher.id);
            await afterLogin();
          }
        }
      }catch(e){
        console.error(e);
        showLoginError("Serverda xatolik. Keyinroq urinib ko‚Äòring.");
      }finally{
        loginBtn.disabled = false;
        loginBtn.textContent = "Kirish";
      }
    }

    async function restoreSession(){
      const id = localStorage.getItem('davomat_teacher_id');
      if(!id) return;
      try{
        const doc = await teachersCol.doc(id).get();
        if(!doc.exists) return;
        currentTeacher = { id:doc.id, ...doc.data() };
        await afterLogin(true);
      }catch(e){
        console.error(e);
      }
    }

    async function afterLogin(isRestore=false){
      // Yuklama
      await loadSettings();

      // Sinfni olib kelamiz
      if(!currentTeacher.classId){
        alert("Sizga biriktirilgan sinf topilmadi. Admin bilan bog‚Äòlaning.");
        return;
      }
      const clsDoc = await classesCol.doc(currentTeacher.classId).get();
      if(!clsDoc.exists){
        alert("Sizga biriktirilgan sinf ma‚Äôlumotlari topilmadi.");
        return;
      }
      currentClass = { id:clsDoc.id, ...clsDoc.data() };

      // UI ko‚Äòrinishlarini almashtiramiz
      loginView.style.display = 'none';
      appView.style.display = 'block';
      userPill.style.display = 'flex';

      userNameEl.textContent = currentTeacher.fullName || currentTeacher.login;
      userClassEl.textContent = currentClass.name || 'Sinf nomi yo‚Äòq';

      classInfoSub.textContent = `${currentClass.name || ''} ‚Äî o‚Äòquvchilar soni: ${(currentClass.students || []).length || 0}`;

      const todayStr = toDateStr(new Date());
      dateInput.value = todayStr;
      currentDateStr = todayStr;
      setDayChipText(todayStr);
      todayLabel.textContent = formatDateLabel(todayStr);

      await renderDayState();
      await renderStudents();
      await refreshStats();
    }

    function logout(){
      currentTeacher = null;
      currentClass = null;
      localStorage.removeItem('davomat_teacher_id');
      appView.style.display = 'none';
      userPill.style.display = 'none';
      loginView.style.display = 'block';
      loginInput.value = '';
      passwordInput.value = '';
    }

    function renderStudentsTable(students, existingMap){
      studentsTbody.innerHTML = '';
      students.forEach((st, idx)=>{
        const tr = document.createElement('tr');
        const status = existingMap[st.id] || 'present';

        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${st.fullName || ''}</td>
          <td>
            <select data-student-id="${st.id}">
              <option value="present">Bor</option>
              <option value="absent">Yo‚Äòq</option>
            </select>
          </td>
        `;
        studentsTbody.appendChild(tr);
        const sel = tr.querySelector('select');
        sel.value = status;
      });

      studentsEmpty.style.display = 'none';
      studentsTableWrap.style.display = 'block';
    }

    async function renderStudents(){
      if(!currentClass) return;
      const students = currentClass.students || [];
      if(students.length === 0){
        studentsEmpty.style.display = 'block';
        studentsTableWrap.style.display = 'none';
        return;
      }

      // Avval shu sana uchun davomatni o‚Äòqib, mavjud holatlarni qo‚Äòyib chiqamiz
      const docId = `${currentDateStr}_${currentClass.id}`;
      const snap = await davomatCol.doc(docId).get();
      const existingMap = {};
      if(snap.exists){
        const data = snap.data();
        (data.students || []).forEach(st=>{
          existingMap[st.id] = st.status;
        });
      }

      renderStudentsTable(students, existingMap);
    }

    async function renderDayState(){
      dayAlerts.innerHTML = '';
      if(!currentDateStr) return;

      const holiday = isInHoliday(currentDateStr);
      const weekend = isWeekend(currentDateStr);
      const schoolDay = isSchoolDay(currentDateStr);

      // Eslatma: sinf rahbari profilida "sinf to'ldirish" haqida banner
      const docId = `${currentDateStr}_${currentClass.id}`;
      const existing = await davomatCol.doc(docId).get();
      const hasAttendance = existing.exists;

      if(!schoolDay){
        // Dam kuni banner
        let msg = 'Bugun dars bo‚Äòlmaydi. Davomat kiritish talab etilmaydi.';
        if(holiday){
          msg = `Bugun ta‚Äôtil: ${holiday.title || ''}. Davomat kiritilmaydi.`;
        } else if(weekend){
          msg = 'Shanba-yakshanba odatda dam kuni. Agar bu kunni o‚Äòqish kuni qilib qo‚Äòshmoqchi bo‚Äòlsangiz, admin paneldan belgilaysiz.';
        }
        const div = document.createElement('div');
        div.className = 'alert alert-ok';
        div.innerHTML = `<div class="alert-icon">üõå</div><div>${msg}</div>`;
        dayAlerts.appendChild(div);
        saveBtn.disabled = true;
        return;
      }

      // Dars kuni
      const warnDiv = document.createElement('div');
      if(hasAttendance){
        warnDiv.className = 'alert alert-ok';
        warnDiv.innerHTML = `<div class="alert-icon">‚úÖ</div>
          <div>Bu sana uchun davomat <b>kiritilgan</b>. Zarur bo‚Äòlsa o‚Äòzgartirishingiz mumkin.</div>`;
      }else{
        warnDiv.className = 'alert alert-danger';
        warnDiv.innerHTML = `<div class="alert-icon">‚ö†Ô∏è</div>
          <div>Bugungi davomat hali <b>to‚Äòldirilmagan</b>. Kunda boshida sinf davomatini to‚Äòldiring.</div>`;
      }
      dayAlerts.appendChild(warnDiv);
      saveBtn.disabled = false;
    }

    async function saveAttendance(){
      if(!currentClass || !currentTeacher) return;
      if(!isSchoolDay(currentDateStr)){
        alert("Bu sana dars kuni emas. Admin panelda ish kuni deb belgilamasangiz, davomat kiritilmaydi.");
        return;
      }

      const students = currentClass.students || [];
      if(students.length === 0){
        alert("Bu sinf uchun o‚Äòquvchilar ro‚Äòyxati yuklanmagan.");
        return;
      }

      const map = {};
      const rows = studentsTbody.querySelectorAll('tr');
      const resStudents = [];
      let presentCount = 0, absentCount = 0;

      students.forEach((st, idx)=>{
        const row = rows[idx];
        const sel = row.querySelector('select');
        const status = sel.value;
        resStudents.push({
          id: st.id,
          fullName: st.fullName,
          status
        });
        if(status === 'present') presentCount++; else absentCount++;
      });

      const total = students.length;
      const docId = `${currentDateStr}_${currentClass.id}`;

      saveBtn.disabled = true;
      saveBtn.textContent = "Saqlanmoqda...";

      try{
        await davomatCol.doc(docId).set({
          date: currentDateStr,
          classId: currentClass.id,
          className: currentClass.name || '',
          teacherId: currentTeacher.id,
          teacherName: currentTeacher.fullName || '',
          students: resStudents,
          stats: { total, presentCount, absentCount },
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });

        await renderDayState();
        await refreshStats();
        alert("Davomat saqlandi.");
      }catch(e){
        console.error(e);
        alert("Saqlashda xatolik yuz berdi.");
      }finally{
        saveBtn.disabled = false;
        saveBtn.textContent = "Davomatni saqlash";
      }
    }

    function weekRangeFor(dateStr){
      const d = new Date(dateStr);
      const day = d.getDay(); // 0=Yak
      const diffToMon = (day === 0 ? -6 : 1 - day); // Dushanba
      const start = new Date(d);
      start.setDate(d.getDate() + diffToMon);
      const end = new Date(start);
      end.setDate(start.getDate() + 6);
      return { start: toDateStr(start), end: toDateStr(end) };
    }
    function monthRangeFor(dateStr){
      const d = new Date(dateStr);
      const start = new Date(d.getFullYear(), d.getMonth(), 1);
      const end = new Date(d.getFullYear(), d.getMonth()+1, 0);
      return { start: toDateStr(start), end: toDateStr(end) };
    }

    async function refreshStats(){
      if(!currentClass || !currentDateStr) return;

      // Today
      const todayDocId = `${currentDateStr}_${currentClass.id}`;
      const todaySnap = await davomatCol.doc(todayDocId).get();
      if(todaySnap.exists){
        const s = todaySnap.data().stats || {};
        const total = s.total || 0, present = s.presentCount || 0, absent = s.absentCount || 0;
        const percent = total ? Math.round(present*100/total) : 0;
        statTodayValue.textContent = percent + "%";
        statTodayDetail.textContent = `Bor: ${present} / Yo‚Äòq: ${absent} / Jami: ${total}`;
      }else{
        statTodayValue.textContent = "‚Äî";
        statTodayDetail.textContent = "Bugun uchun davomat kiritilmagan.";
      }

      // Week
      const wr = weekRangeFor(currentDateStr);
      const weekSnap = await davomatCol
        .where('classId','==',currentClass.id)
        .where('date','>=',wr.start)
        .where('date','<=',wr.end)
        .get();
      let wPresent=0,wTotal=0;
      weekSnap.forEach(doc=>{
        const s=doc.data().stats||{};
        wPresent += s.presentCount || 0;
        wTotal += s.total || 0;
      });
      if(wTotal){
        const p = Math.round(wPresent*100/wTotal);
        statWeekValue.textContent = p+"%";
        statWeekDetail.textContent = `Jami kunlar: ${weekSnap.size}`;
      }else{
        statWeekValue.textContent = "‚Äî";
        statWeekDetail.textContent = "Joriy haftada davomat kiritilmagan.";
      }

      // Month
      const mr = monthRangeFor(currentDateStr);
      const mSnap = await davomatCol
        .where('classId','==',currentClass.id)
        .where('date','>=',mr.start)
        .where('date','<=',mr.end)
        .get();
      let mPresent=0,mTotal=0;
      mSnap.forEach(doc=>{
        const s=doc.data().stats||{};
        mPresent += s.presentCount || 0;
        mTotal += s.total || 0;
      });
      if(mTotal){
        const p = Math.round(mPresent*100/mTotal);
        statMonthValue.textContent = p+"%";
        statMonthDetail.textContent = `Jami kunlar: ${mSnap.size}`;
      }else{
        statMonthValue.textContent = "‚Äî";
        statMonthDetail.textContent = "Joriy oyda davomat kiritilmagan.";
      }
    }

    // Events
    loginBtn.addEventListener('click', handleLogin);
    passwordInput.addEventListener('keydown', e=>{ if(e.key==='Enter') handleLogin(); });
    logoutBtn.addEventListener('click', logout);

    dateInput.addEventListener('change', async ()=>{
      if(!dateInput.value) return;
      currentDateStr = dateInput.value;
      setDayChipText(currentDateStr);
      todayLabel.textContent = formatDateLabel(currentDateStr);
      await renderDayState();
      await renderStudents();
      await refreshStats();
    });

    saveBtn.addEventListener('click', saveAttendance);

    // Start
    (async function init(){
      await loadSettings();
      await restoreSession();
      if(!currentTeacher){
        // login screen visible
        const todayStr = toDateStr(new Date());
        document.getElementById('today-label').textContent = formatDateLabel(todayStr);
        document.getElementById('day-chip-text').textContent = "Bugungi kun";
      }
    })();
  </script>
</body>
</html>
