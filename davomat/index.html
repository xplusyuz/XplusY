<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Maktab Davomati ‚Äî Statistika va sinf rahbari</title>

  <style>
    :root{
      --brand:#2E8B57; --brand-dark:#155f3a;
      --accent:#6B8E23;
      --bg:#F3F7F5; --card:#FFFFFF;
      --text:#102218; --muted:#6c7b73;
      --line:#dfe7e2;
      --ok:#26a269; --excused:#e0a800; --bad:#e03131;
      --shadow-soft:0 20px 60px rgba(13,37,23,.16);
      --radius-lg:22px; --radius-md:16px;
      --speed:.25s;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#f0fff6 0,#f5faf7 40%,#eaf2ec 100%);
      color:var(--text);
    }

    /* HEADER */
    header{
      position:sticky;top:0;z-index:10;
      backdrop-filter:blur(18px);
      background:linear-gradient(120deg,rgba(244,248,246,.97),rgba(232,244,236,.97));
      border-bottom:1px solid rgba(221,232,226,.95);
    }
    .row{
      max-width:1180px;margin:0 auto;
      padding:10px 16px;
      display:flex;align-items:center;gap:12px;
    }
    .brand{display:flex;align-items:center;gap:10px;}
    .logo{
      width:36px;height:36px;border-radius:14px;
      background:conic-gradient(from 210deg,#2E8B57,#6B8E23,#2E8B57);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:800;font-size:18px;
      box-shadow:0 14px 34px rgba(26,96,60,.55);
    }
    .brand-title{font-size:18px;font-weight:750;letter-spacing:.04em;}
    .brand-sub{font-size:11px;color:var(--muted);}
    .chip{
      font-size:11px;padding:5px 10px;border-radius:999px;
      border:1px solid rgba(46,139,87,.22);
      background:rgba(46,139,87,.06);
      color:var(--brand-dark);
      display:inline-flex;align-items:center;gap:6px;
      white-space:nowrap;
    }
    .btn{
      border:none;border-radius:999px;
      padding:7px 14px;font-size:13px;font-weight:600;
      display:inline-flex;align-items:center;gap:6px;
      cursor:pointer;
      transition:transform .15s,box-shadow .15s,background .15s;
      white-space:nowrap;
    }
    .btn-primary{
      background:linear-gradient(135deg,#2E8B57,#1F6B45);
      color:#fff;
      box-shadow:0 12px 30px rgba(18,92,55,.55);
    }
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 16px 38px rgba(18,92,55,.65);}
    .btn-ghost{
      background:rgba(255,255,255,.6);
      border-radius:999px;
      border:1px solid rgba(16,34,24,.12);
      font-size:12px;color:var(--muted);
      padding:6px 12px;
    }
    .btn-ghost:hover{background:rgba(255,255,255,.9);}
    .btn[disabled]{opacity:.6;cursor:default;box-shadow:none;transform:none;}

    main{
      max-width:1180px;margin:0 auto;
      padding:16px 16px 20px;
      display:grid;gap:14px;
    }

    .card{
      background:radial-gradient(circle at top left,rgba(255,255,255,.9),rgba(255,255,255,.97));
      border-radius:var(--radius-lg);
      border:1px solid rgba(220,232,226,.9);
      box-shadow:var(--shadow-soft);
      padding:16px 16px 14px;
      backdrop-filter:blur(14px);
    }
    .card-header{
      display:flex;justify-content:space-between;align-items:center;
      gap:10px;margin-bottom:10px;
    }
    .card-title{font-weight:650;font-size:15px;}
    .card-sub{font-size:12px;color:var(--muted);}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:3px;}
    input,select{
      width:100%;padding:7px 10px;border-radius:10px;
      border:1px solid var(--line);font-size:13px;
      outline:none;background:#f9fcfa;
      transition:border-color var(--speed),box-shadow var(--speed),background .2s;
    }
    input:focus,select:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 1px rgba(46,139,87,.25);
      background:#fff;
    }

    .grid-2{display:grid;grid-template-columns:2fr 1.5fr;gap:12px;}
    @media(max-width:900px){.grid-2{grid-template-columns:1fr;}}

    table{width:100%;border-collapse:collapse;font-size:12px;}
    th,td{padding:6px 8px;border-bottom:1px solid #edf3ee;text-align:left;}
    th{font-size:11px;font-weight:600;color:var(--muted);background:#f4faf6;}
    tbody tr:hover{background:#f7fbf8;}

    /* ALERTS */
    .alert{
      border-radius:14px;padding:8px 10px;font-size:11px;
      display:flex;align-items:flex-start;gap:8px;margin-bottom:6px;
    }
    .alert-icon{margin-top:1px;font-size:13px;}
    .alert-ok{background:#e7f7ee;border:1px solid #b6e1c6;color:#1f6b45;}
    .alert-warn{background:#fff7e5;border:1px solid #f7df99;color:#9a6407;}
    .alert-bad{background:#fef1f2;border:1px solid #f7c2cb;color:#a41326;}

    .small{font-size:11px;color:var(--muted);}

    /* STAT BARS */
    .stack-bar{
      position:relative;
      width:100%;height:9px;
      border-radius:999px;
      background:#ecf3ee;
      overflow:hidden;
      margin-top:4px;
    }
    .stack-bar-fill{
      position:absolute;top:0;bottom:0;left:0;
      display:flex;
    }
    .seg{
      height:100%;
    }
    .seg-present{background:var(--ok);}
    .seg-excused{background:var(--excused);}
    .seg-unexcused{background:var(--bad);}

    .stat-grid{
      display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;
      margin-top:6px;
    }
    @media(max-width:720px){.stat-grid{grid-template-columns:1fr;}}

    .stat-card-mini{
      border-radius:var(--radius-md);
      border:1px solid var(--line);
      padding:8px 10px;font-size:12px;
      background:linear-gradient(145deg,#fbfdfb,#f1f7f3);
    }
    .stat-label{font-size:11px;color:var(--muted);margin-bottom:2px;}
    .stat-value{font-size:16px;font-weight:700;}

    /* LEGEND */
    .legend-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;}
    .legend-pill{
      border-radius:999px;padding:3px 8px;font-size:11px;
      display:inline-flex;align-items:center;gap:4px;
      background:#f9fbfa;border:1px solid #e1e9e3;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
    }
    .dot-present{background:var(--ok);}
    .dot-excused{background:var(--excused);}
    .dot-unexcused{background:var(--bad);}

    /* TEACHER PART */
    #teacher-inner{display:none;margin-top:6px;}
    #login-card{display:none;margin-top:6px;max-width:360px;}

    #students-table-wrap{max-height:360px;overflow:auto;margin-top:6px;}
    .status-select{width:auto;}

    .pill-teacher{
      border-radius:999px;padding:4px 9px;font-size:11px;
      background:#eef7f2;border:1px solid #cadfd3;
      display:inline-flex;align-items:center;gap:6px;
    }

  </style>
</head>
<body>
<header>
  <div class="row">
    <div class="brand">
      <div class="logo">D</div>
      <div>
        <div class="brand-title">Maktab Davomati</div>
        <div class="brand-sub">Statistika hammaga ochiq ‚Ä¢ Sinf rahbari alohida kiradi</div>
      </div>
    </div>
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
      <span class="chip">Bugungi sana: <span id="today-label"></span></span>
      <button id="open-login-btn" class="btn btn-primary">Sinf rahbari kirishi</button>
    </div>
  </div>
</header>

<main>
  <!-- GLOBAL STATS -->
  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">Maktab bo‚Äòyicha umumiy statistika</div>
        <div class="card-sub">
          Bugun, joriy hafta va oy kesimida o‚Äòquvchilar soni. Ranglar:
          <span style="color:var(--ok)">bor</span>, <span style="color:var(--excused)">sababli yo‚Äòq</span>, <span style="color:var(--bad)">sababsiz yo‚Äòq</span>.
        </div>
      </div>
      <button id="refresh-global-btn" class="btn-ghost">Yangilash</button>
    </div>

    <div class="stat-grid">
      <!-- TODAY -->
      <div class="stat-card-mini">
        <div class="stat-label">Bugun</div>
        <div class="stat-value" id="g-today-value">‚Äî</div>
        <div class="small" id="g-today-detail"></div>
        <div class="stack-bar">
          <div class="stack-bar-fill" id="g-today-bar"></div>
        </div>
      </div>
      <!-- WEEK -->
      <div class="stat-card-mini">
        <div class="stat-label">Joriy hafta</div>
        <div class="stat-value" id="g-week-value">‚Äî</div>
        <div class="small" id="g-week-detail"></div>
        <div class="stack-bar">
          <div class="stack-bar-fill" id="g-week-bar"></div>
        </div>
      </div>
      <!-- MONTH -->
      <div class="stat-card-mini">
        <div class="stat-label">Joriy oy</div>
        <div class="stat-value" id="g-month-value">‚Äî</div>
        <div class="small" id="g-month-detail"></div>
        <div class="stack-bar">
          <div class="stack-bar-fill" id="g-month-bar"></div>
        </div>
      </div>
    </div>

    <div class="legend-row">
      <div class="legend-pill"><span class="dot dot-present"></span> Bor</div>
      <div class="legend-pill"><span class="dot dot-excused"></span> Sababli yo‚Äòq</div>
      <div class="legend-pill"><span class="dot dot-unexcused"></span> Sababsiz yo‚Äòq</div>
    </div>

    <div style="margin-top:10px;">
      <div class="small" style="margin-bottom:4px;">Sinflar kesimida bugungi davomat:</div>
      <div style="max-height:220px;overflow:auto;border-radius:var(--radius-md);border:1px solid #e3ebe5;">
        <table>
          <thead>
            <tr>
              <th>Sinf</th>
              <th>% bor</th>
              <th>Mini-gistogramma</th>
              <th>Sonlar (bor/sababli/sababsiz/jami)</th>
            </tr>
          </thead>
          <tbody id="g-classes-tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- TEACHER PANEL -->
  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">Sinf rahbari uchun bo‚Äòlim</div>
        <div class="card-sub">
          Kirish majburiy emas. Agar sinf rahbarisiz, yuqoridagi statistikani ko‚Äòrib chiqishingizning o‚Äòzi kifoya.
        </div>
      </div>
      <button id="toggle-login-card" class="btn-ghost">Kirish oynasini ko‚Äòrsatish</button>
    </div>

    <!-- LOGIN -->
    <div id="login-card">
      <div id="login-alert" class="alert alert-warn" style="display:none;">
        <div class="alert-icon">‚ö†Ô∏è</div>
        <div id="login-alert-text">Login/parol mos kelmadi yoki sinf.json noto‚Äòg‚Äòri.</div>
      </div>
      <label for="login-input">Login (sinf.json dagi)</label>
      <input id="login-input" placeholder="masalan: 7A_rahbar">
      <label for="password-input" style="margin-top:6px;">Parol</label>
      <input id="password-input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <button id="login-btn" class="btn btn-primary" style="margin-top:8px;">Kirish</button>
      <div class="small" style="margin-top:4px;">
        Sinflar, login/parollar va o‚Äòquvchilar ro‚Äòyxati <b>sinf.json</b> faylidan olinadi.
      </div>
    </div>

    <!-- INNER -->
    <div id="teacher-inner">
      <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:6px;">
        <div class="pill-teacher" id="t-teacher-pill">‚Äî</div>
        <div>
          <label for="date-input">Sana</label>
          <input id="date-input" type="date">
        </div>
        <button id="logout-btn" class="btn-ghost" style="margin-left:auto;">Chiqish</button>
      </div>

      <div class="alert alert-info" style="display:flex;align-items:flex-start;gap:8px;margin-bottom:6px;">
        <div class="alert-icon">‚ÑπÔ∏è</div>
        <div class="small">
          Davomat holatlari:
          <b style="color:var(--ok)">Bor</b>, 
          <b style="color:var(--excused)">Sababli yo‚Äòq</b>,
          <b style="color:var(--bad)">Sababsiz yo‚Äòq</b>.
        </div>
      </div>

      <div id="day-alerts"></div>

      <div class="grid-2">
        <!-- LEFT: table -->
        <div>
          <div class="small" id="class-info-sub"></div>
          <div id="students-empty" class="small" style="margin-top:6px;">
            Bu sinf uchun o‚Äòquvchilar ro‚Äòyxati topilmadi (sinf.json ni tekshiring).
          </div>
          <div id="students-table-wrap" style="display:none;">
            <table>
              <thead>
                <tr>
                  <th>#</th>
                  <th>F.I.Sh.</th>
                  <th>Holat</th>
                </tr>
              </thead>
              <tbody id="students-tbody"></tbody>
            </table>
          </div>
          <button id="save-btn" class="btn btn-primary" style="margin-top:8px;">Davomatni saqlash</button>
        </div>
        <!-- RIGHT: per-class stats -->
        <div>
          <div class="small">Sinf statistkasi (faqat tanlangan sinf uchun):</div>
          <div class="stat-card-mini" style="margin-top:4px;">
            <div class="stat-label">Bugun</div>
            <div class="stat-value" id="t-today-value">‚Äî</div>
            <div class="small" id="t-today-detail"></div>
            <div class="stack-bar">
              <div class="stack-bar-fill" id="t-today-bar"></div>
            </div>
          </div>
          <div class="stat-grid" style="margin-top:6px;">
            <div class="stat-card-mini">
              <div class="stat-label">Joriy hafta</div>
              <div class="stat-value" id="t-week-value">‚Äî</div>
              <div class="small" id="t-week-detail"></div>
              <div class="stack-bar">
                <div class="stack-bar-fill" id="t-week-bar"></div>
              </div>
            </div>
            <div class="stat-card-mini">
              <div class="stat-label">Joriy oy</div>
              <div class="stat-value" id="t-month-value">‚Äî</div>
              <div class="small" id="t-month-detail"></div>
              <div class="stack-bar">
                <div class="stack-bar-fill" id="t-month-bar"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

<script>
  // üîß FIREBASE CONFIGNI O'ZGARTIRASAN
  const firebaseConfig = {
  apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  authDomain: "xplusy-760fa.firebaseapp.com",
  projectId: "xplusy-760fa",
  storageBucket: "xplusy-760fa.firebasestorage.app",
  messagingSenderId: "992512966017",
  appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
  measurementId: "G-459PLJ7P7L"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const davomatCol  = db.collection('davomat');
  const settingsDoc = db.collection('davomat_settings').doc('global');

  let settings = { holidays:[], extraSchoolDays:[] };
  let classesJson = [];
  let currentTeacher = null;   // { login, teacherName, classObj }
  let currentDateStr = null;

  /* ======== HELPERS ======== */
  function toDateStr(d){
    const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function formatDateLabel(dateStr){
    const d=new Date(dateStr);
    const days=['Yakshanba','Dushanba','Seshanba','Chorshanba','Payshanba','Juma','Shanba'];
    return days[d.getDay()] + ', ' + d.toLocaleDateString('uz-UZ');
  }
  function weekRangeFor(dateStr){
    const d=new Date(dateStr);
    const day=d.getDay();
    const diffToMon=(day===0?-6:1-day);
    const s=new Date(d);s.setDate(d.getDate()+diffToMon);
    const e=new Date(s);e.setDate(s.getDate()+6);
    return {start:toDateStr(s),end:toDateStr(e)};
  }
  function monthRangeFor(dateStr){
    const d=new Date(dateStr);
    const s=new Date(d.getFullYear(),d.getMonth(),1);
    const e=new Date(d.getFullYear(),d.getMonth()+1,0);
    return {start:toDateStr(s),end:toDateStr(e)};
  }
  function isWeekend(dateStr){
    const d=new Date(dateStr);const day=d.getDay();
    return day===0 || day===6;
  }
  function isInHoliday(dateStr){
    if(!settings.holidays) return null;
    for(const h of settings.holidays){
      if(dateStr>=h.start && dateStr<=h.end) return h;
    }
    return null;
  }
  function isExtraSchoolDay(dateStr){
    return (settings.extraSchoolDays||[]).includes(dateStr);
  }
  function isSchoolDay(dateStr){
    if(isInHoliday(dateStr)) return false;
    if(isWeekend(dateStr)) return isExtraSchoolDay(dateStr);
    return true;
  }
  function buildBar(container, present, excused, unexcused){
    const total = present+excused+unexcused;
    container.innerHTML='';
    if(!total) return;
    const wrap=document.createElement('div');
    wrap.style.width='100%';
    wrap.style.display='flex';
    const segP=document.createElement('div');
    segP.className='seg seg-present';
    segP.style.width=(present*100/total)+'%';
    const segE=document.createElement('div');
    segE.className='seg seg-excused';
    segE.style.width=(excused*100/total)+'%';
    const segU=document.createElement('div');
    segU.className='seg seg-unexcused';
    segU.style.width=(unexcused*100/total)+'%';
    wrap.appendChild(segP);wrap.appendChild(segE);wrap.appendChild(segU);
    container.appendChild(wrap);
  }

  /* ======== ELEMENTS ======== */
  const todayLabel = document.getElementById('today-label');

  // global
  const gTodayValue=document.getElementById('g-today-value');
  const gTodayDetail=document.getElementById('g-today-detail');
  const gTodayBar=document.getElementById('g-today-bar');
  const gWeekValue=document.getElementById('g-week-value');
  const gWeekDetail=document.getElementById('g-week-detail');
  const gWeekBar=document.getElementById('g-week-bar');
  const gMonthValue=document.getElementById('g-month-value');
  const gMonthDetail=document.getElementById('g-month-detail');
  const gMonthBar=document.getElementById('g-month-bar');
  const gClassesTbody=document.getElementById('g-classes-tbody');
  const refreshGlobalBtn=document.getElementById('refresh-global-btn');

  // teacher controls
  const openLoginBtn=document.getElementById('open-login-btn');
  const toggleLoginCardBtn=document.getElementById('toggle-login-card');
  const loginCard=document.getElementById('login-card');
  const loginAlert=document.getElementById('login-alert');
  const loginAlertText=document.getElementById('login-alert-text');
  const loginInput=document.getElementById('login-input');
  const passwordInput=document.getElementById('password-input');
  const loginBtn=document.getElementById('login-btn');
  const teacherInner=document.getElementById('teacher-inner');
  const logoutBtn=document.getElementById('logout-btn');
  const tTeacherPill=document.getElementById('t-teacher-pill');
  const dateInput=document.getElementById('date-input');
  const dayAlerts=document.getElementById('day-alerts');
  const classInfoSub=document.getElementById('class-info-sub');
  const studentsEmpty=document.getElementById('students-empty');
  const studentsTableWrap=document.getElementById('students-table-wrap');
  const studentsTbody=document.getElementById('students-tbody');
  const saveBtn=document.getElementById('save-btn');

  const tTodayValue=document.getElementById('t-today-value');
  const tTodayDetail=document.getElementById('t-today-detail');
  const tTodayBar=document.getElementById('t-today-bar');
  const tWeekValue=document.getElementById('t-week-value');
  const tWeekDetail=document.getElementById('t-week-detail');
  const tWeekBar=document.getElementById('t-week-bar');
  const tMonthValue=document.getElementById('t-month-value');
  const tMonthDetail=document.getElementById('t-month-detail');
  const tMonthBar=document.getElementById('t-month-bar');

  /* ======== LOAD BASE ======== */
  async function loadSettings(){
    const snap=await settingsDoc.get();
    if(snap.exists){
      settings=snap.data();
      settings.holidays=settings.holidays||[];
      settings.extraSchoolDays=settings.extraSchoolDays||[];
    }else settings={holidays:[],extraSchoolDays:[]};
  }
  async function loadClassesJson(){
    try{
      const res=await fetch('sinf.json?v='+Date.now());
      if(!res.ok) throw new Error('sinf.json topilmadi');
      const data=await res.json();
      classesJson=data.classes||[];
    }catch(e){
      console.warn('sinf.json o‚Äòqishda xato',e);
      classesJson=[];
    }
  }

  /* ======== GLOBAL STATISTICS ======== */
  async function refreshGlobalStats(){
    const today=toDateStr(new Date());
    const wr=weekRangeFor(today);
    const mr=monthRangeFor(today);

    // TODAY
    const todaySnap=await davomatCol.where('date','==',today).get();
    let tP=0,tE=0,tU=0,tT=0;
    todaySnap.forEach(doc=>{
      const s=doc.data().stats||{};
      const present=s.presentCount||0;
      const excused=s.excusedCount||0;
      const unexcused = (s.unexcusedCount!=null ? s.unexcusedCount : (s.absentCount||0)) - excused;
      const total = s.total || (present+excused+unexcused);
      tP+=present; tE+=excused; tU+=Math.max(unexcused,0); tT+=total;
    });
    if(tT){
      const percent=Math.round(tP*100/tT);
      gTodayValue.textContent=percent+"%";
      gTodayDetail.textContent=`Bor: ${tP}, Sababli: ${tE}, Sababsiz: ${tU}, Jami: ${tT}`;
      buildBar(gTodayBar,tP,tE,tU);
    }else{
      gTodayValue.textContent='‚Äî';
      gTodayDetail.textContent='Bugun uchun davomat hali kiritilmagan.';
      gTodayBar.innerHTML='';
    }

    // WEEK
    const wSnap=await davomatCol
      .where('date','>=',wr.start)
      .where('date','<=',wr.end)
      .get();
    let wP=0,wE=0,wU=0,wT=0;
    wSnap.forEach(doc=>{
      const s=doc.data().stats||{};
      const present=s.presentCount||0;
      const excused=s.excusedCount||0;
      const unexcused = (s.unexcusedCount!=null ? s.unexcusedCount : (s.absentCount||0)) - excused;
      const total=s.total || (present+excused+unexcused);
      wP+=present; wE+=excused; wU+=Math.max(unexcused,0); wT+=total;
    });
    if(wT){
      const percent=Math.round(wP*100/wT);
      gWeekValue.textContent=percent+"%";
      gWeekDetail.textContent=`Kundagi jami yozuvlar: ${wSnap.size}`;
      buildBar(gWeekBar,wP,wE,wU);
    }else{
      gWeekValue.textContent='‚Äî';
      gWeekDetail.textContent='Joriy haftada davomat yozilmagan.';
      gWeekBar.innerHTML='';
    }

    // MONTH
    const mSnap=await davomatCol
      .where('date','>=',mr.start)
      .where('date','<=',mr.end)
      .get();
    let mP=0,mE=0,mU=0,mT=0;
    mSnap.forEach(doc=>{
      const s=doc.data().stats||{};
      const present=s.presentCount||0;
      const excused=s.excusedCount||0;
      const unexcused=(s.unexcusedCount!=null ? s.unexcusedCount : (s.absentCount||0)) - excused;
      const total=s.total || (present+excused+unexcused);
      mP+=present;mE+=excused;mU+=Math.max(unexcused,0);mT+=total;
    });
    if(mT){
      const percent=Math.round(mP*100/mT);
      gMonthValue.textContent=percent+"%";
      gMonthDetail.textContent=`Kundagi jami yozuvlar: ${mSnap.size}`;
      buildBar(gMonthBar,mP,mE,mU);
    }else{
      gMonthValue.textContent='‚Äî';
      gMonthDetail.textContent='Joriy oyda davomat yozilmagan.';
      gMonthBar.innerHTML='';
    }

    // Per-class today
    gClassesTbody.innerHTML='';
    for(const cls of classesJson){
      const docId=`${today}_${cls.id}`;
      const snap=await davomatCol.doc(docId).get();
      let percent='‚Äî',detail='‚Äî',p=0,e=0,u=0,t=0;
      if(snap.exists){
        const s=snap.data().stats||{};
        p=s.presentCount||0;
        e=s.excusedCount||0;
        u=(s.unexcusedCount!=null ? s.unexcusedCount : (s.absentCount||0)) - e;
        t=s.total || (p+e+u);
        if(t>0){
          percent=Math.round(p*100/t)+'%';
          detail=`${p}/${e}/${Math.max(u,0)}/${t}`;
        }else{
          percent='0%';detail=`0/0/0/0`;
        }
      }
      const tr=document.createElement('tr');
      const barTd=document.createElement('td');
      const barOuter=document.createElement('div');
      barOuter.className='stack-bar';
      const inner=document.createElement('div');
      inner.className='stack-bar-fill';
      buildBar(inner,p,e,Math.max(u,0));
      barOuter.appendChild(inner);
      barTd.appendChild(barOuter);

      tr.innerHTML=`<td>${cls.name||cls.id}</td><td>${percent}</td>`;
      tr.appendChild(barTd);
      const detailTd=document.createElement('td');
      detailTd.textContent=detail;
      tr.appendChild(detailTd);
      gClassesTbody.appendChild(tr);
    }
  }

  /* ======== LOGIN / TEACHER PANEL ======== */
  function showLoginError(msg){
    loginAlertText.textContent=msg;
    loginAlert.style.display='flex';
  }
  function clearLoginError(){loginAlert.style.display='none';}
  function toggleLoginCard(){
    const visible = loginCard.style.display!=='none';
    loginCard.style.display = visible ? 'none':'block';
    toggleLoginCardBtn.textContent = visible ? 'Kirish oynasini ko‚Äòrsatish' : 'Kirish oynasini yashirish';
  }

  async function handleLogin(){
    clearLoginError();
    const login=loginInput.value.trim();
    const pw=passwordInput.value;
    if(!login||!pw){
      showLoginError("Login va parolni kiriting.");
      return;
    }
    const cls=classesJson.find(c=>c.teacherLogin===login && c.teacherPassword===pw);
    if(!cls){
      showLoginError("Login/parol mos kelmadi yoki sinf.json noto‚Äòg‚Äòri.");
      return;
    }
    currentTeacher = {
      login,
      teacherName: cls.teacherName || cls.teacherLogin || login,
      classObj: cls
    };
    localStorage.setItem('davomat_teacher_login',login);
    localStorage.setItem('davomat_teacher_class',cls.id);

    tTeacherPill.textContent = (cls.teacherName || 'Sinf rahbari') + " ‚Ä¢ " + (cls.name || cls.id);
    teacherInner.style.display='block';
    loginCard.style.display='none';

    const today=toDateStr(new Date());
    currentDateStr=today;
    dateInput.value=today;
    await renderDayState();
    await renderStudents();
    await refreshTeacherStats();
  }

  function restoreTeacherSession(){
    const login=localStorage.getItem('davomat_teacher_login');
    const classId=localStorage.getItem('davomat_teacher_class');
    if(!login||!classId) return;
    const cls=classesJson.find(c=>c.id===classId && c.teacherLogin===login);
    if(!cls) return;
    currentTeacher={
      login,
      teacherName: cls.teacherName || cls.teacherLogin || login,
      classObj: cls
    };
    tTeacherPill.textContent = (cls.teacherName || 'Sinf rahbari') + " ‚Ä¢ " + (cls.name || cls.id);
    teacherInner.style.display='block';
    loginCard.style.display='none';
  }

  function logoutTeacher(){
    currentTeacher=null;
    teacherInner.style.display='none';
    localStorage.removeItem('davomat_teacher_login');
    localStorage.removeItem('davomat_teacher_class');
  }

  async function renderStudents(){
    if(!currentTeacher||!currentDateStr) return;
    const cls=currentTeacher.classObj;
    const students=cls.students||[];
    if(!students.length){
      studentsEmpty.style.display='block';
      studentsTableWrap.style.display='none';
      classInfoSub.textContent=(cls.name||cls.id)+" ‚Äî o‚Äòquvchilar ro‚Äòyxati yo‚Äòq (sinf.json).";
      return;
    }
    classInfoSub.textContent=(cls.name||cls.id)+" ‚Äî o‚Äòquvchilar soni: "+students.length;

    const docId=`${currentDateStr}_${cls.id}`;
    const snap=await davomatCol.doc(docId).get();
    const existingMap={};
    if(snap.exists){
      (snap.data().students||[]).forEach(st=>{ existingMap[st.id]=st.status; });
    }

    studentsTbody.innerHTML='';
    students.forEach((st,idx)=>{
      const tr=document.createElement('tr');
      const status=existingMap[st.id] || 'present';
      tr.innerHTML=`
        <td>${idx+1}</td>
        <td>${st.fullName || ''}</td>
        <td>
          <select class="status-select" data-student-id="${st.id}">
            <option value="present">Bor</option>
            <option value="excused">Sababli yo‚Äòq</option>
            <option value="unexcused">Sababsiz yo‚Äòq</option>
          </select>
        </td>
      `;
      studentsTbody.appendChild(tr);
      const sel=tr.querySelector('select');
      // eski "absent" ni sababsiz deb olamiz
      sel.value = (status==='absent' ? 'unexcused' : status);
    });

    studentsEmpty.style.display='none';
    studentsTableWrap.style.display='block';
  }

  async function renderDayState(){
    dayAlerts.innerHTML='';
    if(!currentTeacher||!currentDateStr) return;
    const cls=currentTeacher.classObj;
    const holiday=isInHoliday(currentDateStr);
    const weekend=isWeekend(currentDateStr);
    const schoolDay=isSchoolDay(currentDateStr);

    const docId=`${currentDateStr}_${cls.id}`;
    const snap=await davomatCol.doc(docId).get();
    const hasAttendance=snap.exists;

    if(!schoolDay){
      let msg='Bugun dars kuni emas. Davomat kiritish talab qilinmaydi.';
      if(holiday) msg = `Bugun ta‚Äôtil: ${holiday.title||''}.`;
      else if(weekend) msg='Shanba-yakshanba odatda dam kuni. Agar bu kunni ish kuni qilsangiz, admin panelda extra kun sifatida qo‚Äòshiladi.';
      const div=document.createElement('div');
      div.className='alert alert-ok';
      div.innerHTML=`<div class="alert-icon">üõå</div><div>${msg}</div>`;
      dayAlerts.appendChild(div);
      saveBtn.disabled=true;
      return;
    }

    const div=document.createElement('div');
    if(hasAttendance){
      div.className='alert alert-ok';
      div.innerHTML=`<div class="alert-icon">‚úÖ</div><div>Bu sana uchun davomat <b>kiritilgan</b>. Kerak bo‚Äòlsa tahrirlashingiz mumkin.</div>`;
    }else{
      div.className='alert alert-bad';
      div.innerHTML=`<div class="alert-icon">‚ö†Ô∏è</div><div>Bugungi davomat hali <b>to‚Äòldirilmagan</b>. Kunda boshida sinf davomatini kiriting.</div>`;
    }
    dayAlerts.appendChild(div);
    saveBtn.disabled=false;
  }

  async function saveAttendance(){
    if(!currentTeacher||!currentDateStr) return;
    if(!isSchoolDay(currentDateStr)){
      alert("Bu sana dars kuni emas (ta‚Äôtil yoki dam kuni). Admin panelda ish kuni deb belgilanmagan.");
      return;
    }
    const cls=currentTeacher.classObj;
    const students=cls.students||[];
    if(!students.length){
      alert("Bu sinf uchun o‚Äòquvchilar ro‚Äòyxati sinf.json da yo‚Äòq.");
      return;
    }

    const rows=studentsTbody.querySelectorAll('tr');
    const resStudents=[];
    let present=0,excused=0,unexcused=0;
    students.forEach((st,idx)=>{
      const row=rows[idx];
      const sel=row.querySelector('select');
      let status=sel.value;
      if(status==='absent') status='unexcused';
      resStudents.push({id:st.id,fullName:st.fullName,status});
      if(status==='present') present++;
      else if(status==='excused') excused++;
      else unexcused++;
    });
    const total=students.length;

    const docId=`${currentDateStr}_${cls.id}`;
    saveBtn.disabled=true;
    saveBtn.textContent="Saqlanmoqda...";
    try{
      await davomatCol.doc(docId).set({
        date: currentDateStr,
        classId: cls.id,
        className: cls.name || cls.id,
        teacherLogin: currentTeacher.login,
        teacherName: currentTeacher.teacherName,
        students: resStudents,
        stats:{
          total,
          presentCount: present,
          excusedCount: excused,
          unexcusedCount: unexcused,
          absentCount: excused + unexcused   // eski kodlar uchun
        },
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      },{merge:true});
      await renderDayState();
      await refreshTeacherStats();
      await refreshGlobalStats();
      alert("Davomat saqlandi.");
    }catch(e){
      console.error(e);
      alert("Saqlashda xatolik.");
    }finally{
      saveBtn.disabled=false;
      saveBtn.textContent="Davomatni saqlash";
    }
  }

  async function refreshTeacherStats(){
    if(!currentTeacher||!currentDateStr) return;
    const cls=currentTeacher.classObj;

    // TODAY
    const todayDocId=`${currentDateStr}_${cls.id}`;
    const tSnap=await davomatCol.doc(todayDocId).get();
    let p=0,e=0,u=0,t=0;
    if(tSnap.exists){
      const s=tSnap.data().stats||{};
      p=s.presentCount||0;
      e=s.excusedCount||0;
      u=(s.unexcusedCount!=null ? s.unexcusedCount : (s.absentCount||0)) - e;
      t=s.total || (p+e+u);
    }
    if(t){
      const percent=Math.round(p*100/t);
      tTodayValue.textContent=percent+"%";
      tTodayDetail.textContent=`Bor: ${p}, Sababli: ${e}, Sababsiz: ${Math.max(u,0)}, Jami: ${t}`;
      buildBar(tTodayBar,p,e,Math.max(u,0));
    }else{
      tTodayValue.textContent='‚Äî';
      tTodayDetail.textContent='Bugun uchun davomat kiritilmagan.';
      tTodayBar.innerHTML='';
    }

    // WEEK
    const wr=weekRangeFor(currentDateStr);
    const wSnap=await davomatCol
      .where('classId','==',cls.id)
      .where('date','>=',wr.start)
      .where('date','<=',wr.end)
      .get();
    let wP=0,wE=0,wU=0,wT=0;
    wSnap.forEach(doc=>{
      const s=doc.data().stats||{};
      const P=s.presentCount||0;
      const E=s.excusedCount||0;
      const U=(s.unexcusedCount!=null ? s.unexcusedCount : (s.absentCount||0)) - E;
      const T=s.total || (P+E+U);
      wP+=P;wE+=E;wU+=Math.max(U,0);wT+=T;
    });
    if(wT){
      const percent=Math.round(wP*100/wT);
      tWeekValue.textContent=percent+"%";
      tWeekDetail.textContent=`Kunlar soni: ${wSnap.size}`;
      buildBar(tWeekBar,wP,wE,wU);
    }else{
      tWeekValue.textContent='‚Äî';
      tWeekDetail.textContent='Hafta bo‚Äòyicha davomat yozilmagan.';
      tWeekBar.innerHTML='';
    }

    // MONTH
    const mr=monthRangeFor(currentDateStr);
    const mSnap=await davomatCol
      .where('classId','==',cls.id)
      .where('date','>=',mr.start)
      .where('date','<=',mr.end)
      .get();
    let mP=0,mE=0,mU=0,mT=0;
    mSnap.forEach(doc=>{
      const s=doc.data().stats||{};
      const P=s.presentCount||0;
      const E=s.excusedCount||0;
      const U=(s.unexcusedCount!=null ? s.unexcusedCount : (s.absentCount||0)) - E;
      const T=s.total || (P+E+U);
      mP+=P;mE+=E;mU+=Math.max(U,0);mT+=T;
    });
    if(mT){
      const percent=Math.round(mP*100/mT);
      tMonthValue.textContent=percent+"%";
      tMonthDetail.textContent=`Kunlar soni: ${mSnap.size}`;
      buildBar(tMonthBar,mP,mE,mU);
    }else{
      tMonthValue.textContent='‚Äî';
      tMonthDetail.textContent='Oy bo‚Äòyicha davomat yozilmagan.';
      tMonthBar.innerHTML='';
    }
  }

  /* ======== EVENTS ======== */
  refreshGlobalBtn.addEventListener('click',refreshGlobalStats);
  openLoginBtn.addEventListener('click',()=>{
    loginCard.style.display='block';
    toggleLoginCardBtn.textContent='Kirish oynasini yashirish';
    window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
  });
  toggleLoginCardBtn.addEventListener('click',toggleLoginCard);
  loginBtn.addEventListener('click',handleLogin);
  passwordInput.addEventListener('keydown',e=>{if(e.key==='Enter')handleLogin();});
  logoutBtn.addEventListener('click',logoutTeacher);
  dateInput.addEventListener('change',async ()=>{
    if(!dateInput.value) return;
    currentDateStr=dateInput.value;
    await renderDayState();
    await renderStudents();
    await refreshTeacherStats();
  });
  saveBtn.addEventListener('click',saveAttendance);

  /* ======== INIT ======== */
  (async function init(){
    const today=toDateStr(new Date());
    todayLabel.textContent=formatDateLabel(today);

    await loadSettings();
    await loadClassesJson();
    await refreshGlobalStats();
    restoreTeacherSession();
    if(currentTeacher){
      currentDateStr=today;
      dateInput.value=today;
      await renderDayState();
      await renderStudents();
      await refreshTeacherStats();
    }
  })();
</script>
</body>
</html>