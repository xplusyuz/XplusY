<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Maktab Davomati ‚Äî PRO Statistika</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --brand:#2E8B57; --brand-dark:#155f3a;
      --accent:#6B8E23;
      --bg:#F3F7F5; --card:#FFFFFF;
      --text:#102218; --muted:#6c7b73;
      --line:#dfe7e2;
      --ok:#26a269; --excused:#e0a800; --bad:#e03131;
      --shadow-soft:0 20px 60px rgba(13,37,23,.16);
      --radius-lg:22px; --radius-md:14px;
      --speed:.25s;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#f0fff6 0,#f5faf7 40%,#eaf2ec 100%);
      color:var(--text);
    }
    header{
      position:sticky;top:0;z-index:10;
      backdrop-filter:blur(18px);
      background:linear-gradient(120deg,rgba(244,248,246,.97),rgba(232,244,236,.97));
      border-bottom:1px solid rgba(221,232,226,.95);
    }
    .row{
      max-width:1180px;margin:0 auto;
      padding:10px 16px;
      display:flex;align-items:center;gap:10px;
    }
    .brand{display:flex;align-items:center;gap:10px;}
    .logo{
      width:34px;height:34px;border-radius:13px;
      background:conic-gradient(from 210deg,#2E8B57,#6B8E23,#2E8B57);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:800;font-size:18px;
      box-shadow:0 14px 34px rgba(26,96,60,.55);
    }
    .brand-title{font-size:18px;font-weight:750;letter-spacing:.03em;}
    .brand-sub{font-size:11px;color:var(--muted);}
    .chip{
      font-size:11px;padding:5px 10px;border-radius:999px;
      border:1px solid rgba(46,139,87,.22);
      background:rgba(46,139,87,.06);
      color:var(--brand-dark);
      white-space:nowrap;
    }
    a.link{font-size:12px;color:var(--brand-dark);text-decoration:none;}
    a.link:hover{text-decoration:underline;}

    main{max-width:1180px;margin:0 auto;padding:16px;display:grid;gap:14px;}
    .card{
      background:radial-gradient(circle at top left,#ffffff,#fdfefc);
      border-radius:var(--radius-lg);
      border:1px solid var(--line);
      box-shadow:var(--shadow-soft);
      padding:14px 16px 16px;
      backdrop-filter:blur(16px);
    }
    .card-header{
      display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:8px;
    }
    .card-title{font-weight:650;font-size:15px;}
    .card-sub{font-size:12px;color:var(--muted);}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:3px;}
    select,input{
      padding:6px 10px;border-radius:10px;
      border:1px solid var(--line);
      font-size:13px;background:#f9fcfa;
      outline:none;
      transition:border-color var(--speed),box-shadow var(--speed),background .2s;
    }
    select:focus,input:focus{
      border-color:var(--brand);
      box-shadow:0 0 0 1px rgba(46,139,87,.25);
      background:#fff;
    }
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end;margin-top:6px;}
    .btn{
      border:none;border-radius:999px;
      padding:7px 14px;font-size:13px;font-weight:600;
      display:inline-flex;align-items:center;gap:6px;
      cursor:pointer;
      transition:transform .15s,box-shadow .15s,background .15s;
      white-space:nowrap;
    }
    .btn-primary{
      background:linear-gradient(135deg,#2E8B57,#1F6B45);
      color:#fff;
      box-shadow:0 10px 26px rgba(18,92,55,.5);
    }
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 14px 32px rgba(18,92,55,.6);}
    .small{font-size:11px;color:var(--muted);}
    .legend-row{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;}
    .legend-pill{
      border-radius:999px;padding:3px 8px;font-size:11px;
      display:inline-flex;align-items:center;gap:4px;
      background:#f9fbfa;border:1px solid #e1e9e3;
    }
    .dot{width:10px;height:10px;border-radius:999px;}
    .dot-present{background:var(--ok);}
    .dot-excused{background:var(--excused);}
    .dot-unexcused{background:var(--bad);}

    table{width:100%;border-collapse:collapse;font-size:12px;margin-top:8px;}
    th,td{padding:6px 8px;border-bottom:1px solid #edf3ee;text-align:left;}
    th{font-size:11px;font-weight:600;color:var(--muted);background:#f4faf6;}
    tbody tr:hover{background:#f7fbf8;}

    @media(max-width:720px){
      main{padding:10px;}
    }
  </style>
</head>
<body>
<header>
  <div class="row">
    <div class="brand">
      <div class="logo">D</div>
      <div>
        <div class="brand-title">Maktab Davomati ‚Äî PRO Statistika</div>
        <div class="brand-sub">Kunlik, haftalik, oylik stacked gistogramma ‚Ä¢ maktab va sinflar kesimida</div>
      </div>
    </div>
    <div style="margin-left:auto;display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
      <span class="chip">Bugun: <span id="today-label"></span></span>
      <a href="index.html" class="link">‚Üê Davomat sahifasiga qaytish</a>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">Diagramma sozlamalari</div>
        <div class="card-sub">
          Chapda stacked gistogramma, pastda esa jadval ko‚Äòrinishida raqamlar ko‚Äòrsatiladi.
        </div>
      </div>
    </div>
    <div class="controls">
      <div>
        <label for="scope-select">Kesim</label>
        <select id="scope-select">
          <option value="school">Maktab bo‚Äòyicha</option>
          <option value="class">Tanlangan sinf</option>
        </select>
      </div>
      <div id="class-select-wrap" style="display:none;">
        <label for="class-select">Sinf</label>
        <select id="class-select">
          <option value="">Sinf tanlang</option>
        </select>
      </div>
      <div>
        <label for="mode-select">Davr</label>
        <select id="mode-select">
          <option value="week">Joriy hafta (kunlar bo‚Äòyicha)</option>
          <option value="month">Joriy oy (1‚Äì31 kun)</option>
        </select>
      </div>
      <div>
        <label for="base-date-input">Asosiy sana</label>
        <input type="date" id="base-date-input">
        <div class="small">Hafta / oy shu sanaga qarab olinadi</div>
      </div>
      <button id="apply-btn" class="btn btn-primary">Diagrammani yangilash</button>
    </div>

    <div class="legend-row">
      <div class="legend-pill"><span class="dot dot-present"></span> Bor</div>
      <div class="legend-pill"><span class="dot dot-excused"></span> Sababli yo‚Äòq</div>
      <div class="legend-pill"><span class="dot dot-unexcused"></span> Sababsiz yo‚Äòq</div>
    </div>

    <div style="margin-top:10px;">
      <canvas id="attChart" height="120"></canvas>
    </div>

    <div style="margin-top:8px;">
      <div class="small" id="table-caption"></div>
      <table>
        <thead>
          <tr>
            <th>Kun</th>
            <th>Bor</th>
            <th>Sababli</th>
            <th>Sababsiz</th>
            <th>Jami</th>
            <th>% bor</th>
          </tr>
        </thead>
        <tbody id="stats-tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

<script>
  // üîß FIREBASE CONFIGNI INDEX.HTML DAGI BILAN BIR XIL QIL
  const firebaseConfig = {
  apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  authDomain: "xplusy-760fa.firebaseapp.com",
  projectId: "xplusy-760fa",
  storageBucket: "xplusy-760fa.firebasestorage.app",
  messagingSenderId: "992512966017",
  appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
  measurementId: "G-459PLJ7P7L"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const davomatCol = db.collection('davomat');

  let classesJson = [];

  // ======= HELPERS =======
  function toDateStr(d){
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), day=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function weekRange(dateStr){
    const d=new Date(dateStr);
    const day=d.getDay(); // 0-yakshanba
    const diffToMon=(day===0?-6:1-day);
    const start=new Date(d);start.setDate(d.getDate()+diffToMon);
    const end=new Date(start);end.setDate(start.getDate()+6);
    return {start:toDateStr(start), end:toDateStr(end)};
  }
  function monthRange(dateStr){
    const d=new Date(dateStr);
    const s=new Date(d.getFullYear(), d.getMonth(), 1);
    const e=new Date(d.getFullYear(), d.getMonth()+1, 0);
    return {start:toDateStr(s), end:toDateStr(e)};
  }
  function formatDayLabel(dateStr){
    const d=new Date(dateStr);
    const days=['Yak','Du','Se','Cho','Pa','Ju','Sha'];
    return days[d.getDay()]+" "+d.getDate();
  }

  // ======= UI ELEMENTS =======
  const todayLabel = document.getElementById('today-label');
  const scopeSelect = document.getElementById('scope-select');
  const classSelectWrap = document.getElementById('class-select-wrap');
  const classSelect = document.getElementById('class-select');
  const modeSelect = document.getElementById('mode-select');
  const baseDateInput = document.getElementById('base-date-input');
  const applyBtn = document.getElementById('apply-btn');
  const tableCaption = document.getElementById('table-caption');
  const statsTbody = document.getElementById('stats-tbody');

  let chart;

  scopeSelect.addEventListener('change', ()=>{
    classSelectWrap.style.display = scopeSelect.value==='class' ? 'block' : 'none';
  });

  async function loadClasses(){
    try{
      const res = await fetch('sinf.json?v='+Date.now());
      const data = await res.json();
      classesJson = data.classes || [];
      classSelect.innerHTML = '<option value="">Sinf tanlang</option>';
      classesJson.forEach(c=>{
        const opt=document.createElement('option');
        opt.value=c.id;
        opt.textContent=c.name || c.id;
        classSelect.appendChild(opt);
      });
    }catch(e){
      console.warn('sinf.json o‚Äòqishda xato',e);
    }
  }

  function buildChart(labels, presentArr, excusedArr, unexcusedArr, title){
    const ctx = document.getElementById('attChart').getContext('2d');
    if(chart) chart.destroy();
    chart = new Chart(ctx,{
      type:'bar',
      data:{
        labels,
        datasets:[
          {
            label:'Bor',
            data:presentArr,
            backgroundColor:'#26a269'
          },
          {
            label:'Sababli yo‚Äòq',
            data:excusedArr,
            backgroundColor:'#e0a800'
          },
          {
            label:'Sababsiz yo‚Äòq',
            data:unexcusedArr,
            backgroundColor:'#e03131'
          }
        ]
      },
      options:{
        responsive:true,
        plugins:{
          legend:{position:'top'},
          title:{display:true,text:title}
        },
        scales:{
          x:{stacked:true},
          y:{stacked:true, beginAtZero:true}
        }
      }
    });
  }

  async function buildStats(){
    const baseDate = baseDateInput.value || toDateStr(new Date());
    const mode = modeSelect.value; // week | month
    const scope = scopeSelect.value; // school | class
    const classId = classSelect.value;

    let range;
    if(mode === 'week') range = weekRange(baseDate);
    else range = monthRange(baseDate);

    // Faqat date bo‚Äòyicha filter qilamiz, classId ni JSda filtrlaymiz
    const snap = await davomatCol
      .where('date','>=', range.start)
      .where('date','<=', range.end)
      .get();

    // date -> stats aggr
    const daysMap = {}; // {date:{p,e,u,t}}
    snap.forEach(doc=>{
      const d = doc.data();
      if(scope==='class' && d.classId !== classId) return; // faqat shu sinf
      const s = d.stats || {};
      const present = s.presentCount || 0;
      const excused = s.excusedCount || 0;
      const unexcused = (s.unexcusedCount!=null ? s.unexcusedCount : (s.absentCount||0)) - excused;
      const total = s.total || (present+excused+Math.max(unexcused,0));
      const key = d.date;
      if(!daysMap[key]) daysMap[key]={p:0,e:0,u:0,t:0};
      daysMap[key].p += present;
      daysMap[key].e += excused;
      daysMap[key].u += Math.max(unexcused,0);
      daysMap[key].t += total;
    });

    const labels = [];
    const pArr=[]; const eArr=[]; const uArr=[];
    statsTbody.innerHTML='';

    const startDate = new Date(range.start);
    const endDate   = new Date(range.end);

    for(let d=new Date(startDate); d<=endDate; d.setDate(d.getDate()+1)){
      const dateStr = toDateStr(d);
      const label = (mode==='week') ? formatDayLabel(dateStr) : d.getDate().toString();
      labels.push(label);

      const s = daysMap[dateStr] || {p:0,e:0,u:0,t:0};
      pArr.push(s.p); eArr.push(s.e); uArr.push(s.u);

      const percent = s.t ? Math.round(s.p*100/s.t) : 0;
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${dateStr}</td>
        <td>${s.p}</td>
        <td>${s.e}</td>
        <td>${s.u}</td>
        <td>${s.t}</td>
        <td>${s.t ? percent+'%' : '‚Äî'}</td>
      `;
      statsTbody.appendChild(tr);
    }

    const scopeText = scope==='school' ? 'butun maktab bo‚Äòyicha' :
      (classesJson.find(c=>c.id===classId)?.name || classId || 'sinf tanlanmagan');
    const modeText = mode==='week' ? 'joriy hafta' : 'joriy oy';
    tableCaption.textContent = `${scopeText} ‚Äî ${modeText} statistikasi (${range.start} ‚Üí ${range.end})`;

    buildChart(labels,pArr,eArr,uArr,tableCaption.textContent);
  }

  // ===== INIT =====
  (async function init(){
    const today = toDateStr(new Date());
    todayLabel.textContent = today;
    baseDateInput.value = today;
    await loadClasses();
    await buildStats();
  })();

  applyBtn.addEventListener('click',buildStats);
</script>
</body>
</html>
