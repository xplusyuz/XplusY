<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Maktab Davomat ‚Äî Admin panel</title>

  <style>
    :root{
      --brand:#2E8B57; --brand-dark:#1F6B45;
      --bg:#F4F8F6; --card:#FFFFFF;
      --text:#102218; --muted:#667a6f;
      --line:#dfe7e2; --danger:#e63946;
      --shadow:0 18px 40px rgba(12,35,22,.12);
      --radius:18px;
      --speed:.25s;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#f0fff6 0,#f5faf7 40%,#edf4ef 100%);
      color:var(--text);
    }
    header{
      position:sticky;top:0;z-index:10;
      backdrop-filter:blur(18px);
      background:linear-gradient(120deg,rgba(244,248,246,.92),rgba(236,246,240,.92));
      border-bottom:1px solid rgba(223,231,226,.9);
    }
    .row{max-width:1120px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:10px;}
    .brand{display:flex;align-items:center;gap:10px;}
    .logo{
      width:32px;height:32px;border-radius:11px;
      background:conic-gradient(from 210deg,#2E8B57,#6B8E23,#2E8B57);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:800;font-size:16px;
      box-shadow:0 10px 26px rgba(26,96,60,.55);
    }
    .brand-title{font-size:17px;font-weight:700;}
    .brand-sub{font-size:11px;color:var(--muted);}
    main{max-width:1120px;margin:0 auto;padding:16px;display:grid;gap:12px;}
    .card{
      background:var(--card);border-radius:var(--radius);
      box-shadow:var(--shadow);border:1px solid var(--line);
      padding:14px 14px 12px;
    }
    .card-header{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:8px;}
    .card-title{font-weight:650;font-size:15px;}
    .card-sub{font-size:12px;color:var(--muted);}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:3px;}
    input,select{
      width:100%;padding:7px 10px;border-radius:10px;border:1px solid var(--line);
      font-size:13px;background:#f9fcfa;outline:none;
      transition:border-color var(--speed),box-shadow var(--speed),background .2s;
    }
    input:focus,select:focus{
      border-color:var(--brand);box-shadow:0 0 0 1px rgba(46,139,87,.28);background:#fff;
    }
    .btn{
      border:none;border-radius:999px;padding:7px 13px;font-size:13px;font-weight:600;
      cursor:pointer;display:inline-flex;align-items:center;gap:6px;
      transition:transform .15s,box-shadow .15s,background .15s;
      white-space:nowrap;
    }
    .btn-primary{
      background:linear-gradient(135deg,#2E8B57,#1F6B45);color:#fff;
      box-shadow:0 10px 26px rgba(18,92,55,.5);
    }
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 14px 32px rgba(18,92,55,.6);}
    .btn-ghost{
      background:transparent;border-radius:999px;
      padding:5px 11px;border:1px solid rgba(16,34,24,.12);
      font-size:11px;color:var(--muted);
    }
    .btn-ghost:hover{background:rgba(0,0,0,.02);}
    .btn[disabled]{opacity:.6;cursor:default;box-shadow:none;transform:none;}

    .grid-2{display:grid;grid-template-columns:2fr 1.6fr;gap:12px;}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;}
    @media(max-width:900px){
      .grid-2{grid-template-columns:1fr;}
      .grid-3{grid-template-columns:1fr;}
    }
    table{width:100%;border-collapse:collapse;font-size:12px;}
    th,td{padding:5px 7px;border-bottom:1px solid #edf3ee;text-align:left;}
    th{font-weight:600;font-size:11px;color:var(--muted);background:#f3faf5;}
    tbody tr:hover{background:#f7fbf8;}
    .pill{
      border-radius:999px;padding:2px 7px;font-size:11px;
      background:#eef7f1;color:var(--brand-dark);border:1px solid #cfe3d6;
      display:inline-flex;align-items:center;gap:4px;
    }
    .pill-danger{background:#fbe5e7;color:#b0202f;border-color:#f1b3b9;}
    .small{font-size:11px;color:var(--muted);}
    .field-row{display:flex;flex-wrap:wrap;gap:10px;}
    .field{flex:1 1 140px;}
    .alert{
      border-radius:12px;padding:7px 9px;font-size:11px;
      display:flex;align-items:flex-start;gap:8px;margin-bottom:8px;
    }
    .alert-info{background:#e8f4ff;border:1px solid #c3dafe;color:#224c8c;}
    .alert-warn{background:#fff7e5;border:1px solid #f7df99;color:#9a6407;}
    .alert-ok{background:#e8f7ee;border:1px solid #b6e1c6;color:#1f6b45;}
    .alert-icon{font-size:13px;margin-top:2px;}
    .tag-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;}
    .tag{
      border-radius:999px;padding:3px 8px;font-size:11px;
      border:1px solid var(--line);background:#f8fbf9;
      display:inline-flex;align-items:center;gap:6px;
    }
    .tag button{
      border:none;background:transparent;font-size:11px;cursor:pointer;color:#b0202f;
    }
  </style>
</head>
<body>
<header>
  <div class="row">
    <div class="brand">
      <div class="logo">D</div>
      <div>
        <div class="brand-title">Davomat Admin</div>
        <div class="brand-sub">Sinf, sinf rahbari va ta‚Äôtil sozlamalari</div>
      </div>
    </div>
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
      <span class="small">Faqat direktor / zammestel uchun.</span>
    </div>
  </div>
</header>

<main>
  <!-- ADMIN KIRISH (oddiy passcode) -->
  <div id="login-card" class="card">
    <div class="card-header">
      <div>
        <div class="card-title">Admin kirishi</div>
        <div class="card-sub">Tizim sozlamalarini o‚Äòzgartirish uchun maxfiy kod kiriting.</div>
      </div>
    </div>
    <div class="alert alert-warn">
      <div class="alert-icon">‚ö†Ô∏è</div>
      <div>
        <b>Eslatma:</b> bu sahifani faqat ishonchli odamlar ishlatsin. Kodni brauzer skrinshotida oshkor qilmang.
      </div>
    </div>
    <div style="max-width:320px;">
      <label for="admin-code-input">Admin kod</label>
      <input id="admin-code-input" type="password" placeholder="faqat siz biladigan kod">
      <button class="btn btn-primary" id="admin-code-btn" style="margin-top:10px;">Kirish</button>
      <div class="small" style="margin-top:6px;">
        Kod JavaScript ichida o‚Äòrnatilgan. Kerak bo‚Äòlsa loyihani o‚Äòzingizda ochib o‚Äòzgartirib qo‚Äòying.
      </div>
    </div>
  </div>

  <div id="content" style="display:none;display:grid;gap:12px;">
    <!-- SINFLAR + RAHBARLAR -->
    <section class="grid-2">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Sinf qo‚Äòshish / tahrirlash</div>
            <div class="card-sub">Sinf nomi va paralelini belgilang. O‚Äòquvchilar ro‚Äòyxatini keyin Excel orqali yuklaysiz.</div>
          </div>
        </div>
        <div class="field-row" style="margin-bottom:8px;">
          <div class="field">
            <label for="class-name-input">Sinf nomi (masalan: 7A)</label>
            <input id="class-name-input" placeholder="7A">
          </div>
          <div class="field">
            <label for="class-note-input">Izoh (ixtiyoriy)</label>
            <input id="class-note-input" placeholder="masalan: 7-sinf A paralel, ertalabki smena">
          </div>
        </div>
        <button class="btn btn-primary" id="class-save-btn">Sinfni saqlash</button>
        <div class="small" style="margin-top:6px;">Sinf saqlangach pastdagi ro‚Äòyxatda ko‚Äòrinadi.</div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Mavjud sinflar</div>
            <div class="card-sub">Sinf rahbari login-parolini ham shu yerdan biriktirasiz.</div>
          </div>
          <button class="btn-ghost" id="refresh-classes-btn">Yangilash</button>
        </div>
        <div style="max-height:260px;overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>Sinf</th>
                <th>Izoh</th>
                <th>Rahbar</th>
                <th>Login</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="classes-tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SINF RAHBARI LOGIN/PAROL + XLS YUKLASH -->
    <section class="grid-2">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Sinf rahbari login/paroli</div>
            <div class="card-sub">Login-parol faqat sinf rahbariga beriladi. Parol Firestore‚Äôda <b>hash</b> ko‚Äòrinishida saqlanadi.</div>
          </div>
        </div>
        <div class="alert alert-info">
          <div class="alert-icon">‚ÑπÔ∏è</div>
          <div>
            Avval sinfni yaratib oling, keyin shu sinfni bu bo‚Äòlimdan tanlab rahbar bog‚Äòlang.
          </div>
        </div>
        <div class="field-row" style="margin-bottom:8px;">
          <div class="field">
            <label for="teacher-class-select">Sinf</label>
            <select id="teacher-class-select"></select>
          </div>
          <div class="field">
            <label for="teacher-name-input">Sinf rahbari F.I.Sh.</label>
            <input id="teacher-name-input" placeholder="Ism Familiya">
          </div>
        </div>
        <div class="field-row" style="margin-bottom:8px;">
          <div class="field">
            <label for="teacher-login-input">Login</label>
            <input id="teacher-login-input" placeholder="7A_rahbar">
          </div>
          <div class="field">
            <label for="teacher-password-input">Yangi parol</label>
            <input id="teacher-password-input" type="password" placeholder="Kamida 6 belgi">
          </div>
        </div>
        <button class="btn btn-primary" id="teacher-save-btn">Sinf rahbarini saqlash / yangilash</button>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Sinf o‚Äòquvchilari ro‚Äòyxatini yuklash</div>
            <div class="card-sub">Faqat <b>Excel (.xls yoki .xlsx)</b> fayldan yuklash. 1-ustunda o‚Äòquvchi F.I.Sh. bo‚Äòlsin.</div>
          </div>
        </div>
        <div class="alert alert-warn">
          <div class="alert-icon">‚ö†Ô∏è</div>
          <div>
            Yangi fayl yuklasangiz, avvalgi ro‚Äòyxat <b>to‚Äòliq almashtiriladi</b>.
          </div>
        </div>
        <div class="field-row">
          <div class="field">
            <label for="xls-class-select">Sinf</label>
            <select id="xls-class-select"></select>
          </div>
          <div class="field">
            <label for="xls-input">Excel fayl (faqat 1-ustun F.I.Sh.)</label>
            <input id="xls-input" type="file" accept=".xls,.xlsx">
          </div>
        </div>
        <button class="btn btn-primary" id="xls-upload-btn" style="margin-top:8px;">Ro‚Äòyxatni yuklash</button>
        <div class="small" style="margin-top:6px;">
          1-qatorda sarlavha bo‚Äòlsa ham bo‚Äòladi ‚Äî u tashlab yuboriladi. Qolgan har bir qatordagi 1-ustun F.I.Sh. sifatida olinadi.
        </div>
      </div>
    </section>

    <!-- TA'TIL VA ISH KUNLARI + STATISTIKA -->
    <section class="grid-2">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Ta‚Äôtil va qo‚Äòshimcha ish kunlari</div>
            <div class="card-sub">Asosiy qoidalar: dushanba‚Äìjuma dars, shanba-yakshanba dam. Bu yerda istisnolarni belgilaysiz.</div>
          </div>
        </div>
        <div class="grid-3">
          <div>
            <label>Ta‚Äôtil boshlanish sanasi</label>
            <input type="date" id="hol-start-input">
            <label style="margin-top:6px;">Ta‚Äôtil tugash sanasi</label>
            <input type="date" id="hol-end-input">
          </div>
          <div>
            <label>Ta‚Äôtil nomi</label>
            <input id="hol-title-input" placeholder="Qishki ta‚Äôtil">
            <button class="btn btn-primary" id="hol-add-btn" style="margin-top:10px;">Ta‚Äôtil qo‚Äòshish</button>
          </div>
          <div>
            <label>Qo‚Äòshimcha ish kuni (shanba/syak.)</label>
            <input type="date" id="extra-day-input">
            <button class="btn btn-primary" id="extra-add-btn" style="margin-top:10px;">Ish kuni qo‚Äòshish</button>
          </div>
        </div>
        <div style="margin-top:8px;">
          <div class="small"><b>Ta‚Äôtil oraliqlari:</b></div>
          <div id="holidays-list" class="tag-list"></div>
        </div>
        <div style="margin-top:6px;">
          <div class="small"><b>Qo‚Äòshimcha ish kunlari (odatiy dam bo‚Äòlsa ham):</b></div>
          <div id="extras-list" class="tag-list"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Umumiy statistika</div>
            <div class="card-sub">Bugungi kun, joriy hafta va oy bo‚Äòyicha maktab kesimida.</div>
          </div>
          <button class="btn-ghost" id="refresh-stats-btn">Yangilash</button>
        </div>
        <div class="alert alert-info">
          <div class="alert-icon">üìä</div>
          <div id="stats-date-label">Bugungi sana bo‚Äòyicha statistikani ko‚Äòrsatadi.</div>
        </div>
        <div id="stats-cards" class="grid-3">
          <div>
            <div class="small">Bugun</div>
            <div class="pill" id="stats-today-pill">‚Äî</div>
          </div>
          <div>
            <div class="small">Joriy hafta</div>
            <div class="pill" id="stats-week-pill">‚Äî</div>
          </div>
          <div>
            <div class="small">Joriy oy</div>
            <div class="pill" id="stats-month-pill">‚Äî</div>
          </div>
        </div>
        <div style="margin-top:8px;max-height:160px;overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>Sinf</th>
                <th>Bugun</th>
                <th>Hafta</th>
                <th>Oy</th>
              </tr>
            </thead>
            <tbody id="stats-classes-tbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- Firebase + XLSX -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
  // üîß FIREBASE CONFIG (index.html bilan bir xil bo‚Äòlsin)
  const firebaseConfig = {
  apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  authDomain: "xplusy-760fa.firebaseapp.com",
  projectId: "xplusy-760fa",
  storageBucket: "xplusy-760fa.firebasestorage.app",
  messagingSenderId: "992512966017",
  appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
  measurementId: "G-459PLJ7P7L"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const teachersCol = db.collection('davomat_teachers');
  const classesCol  = db.collection('davomat_classes');
  const settingsDoc = db.collection('davomat_settings').doc('global');
  const davomatCol  = db.collection('davomat');

  // Admin kod (o'zing o'zgartirasan)
  const ADMIN_CODE = "director-2025";

  // Elements
  const loginCard = document.getElementById('login-card');
  const content   = document.getElementById('content');
  const adminCodeInput = document.getElementById('admin-code-input');
  const adminCodeBtn   = document.getElementById('admin-code-btn');

  const classNameInput = document.getElementById('class-name-input');
  const classNoteInput = document.getElementById('class-note-input');
  const classSaveBtn   = document.getElementById('class-save-btn');
  const classesTbody   = document.getElementById('classes-tbody');
  const refreshClassesBtn = document.getElementById('refresh-classes-btn');

  const teacherClassSelect = document.getElementById('teacher-class-select');
  const teacherNameInput   = document.getElementById('teacher-name-input');
  const teacherLoginInput  = document.getElementById('teacher-login-input');
  const teacherPasswordInput = document.getElementById('teacher-password-input');
  const teacherSaveBtn     = document.getElementById('teacher-save-btn');

  const xlsClassSelect = document.getElementById('xls-class-select');
  const xlsInput       = document.getElementById('xls-input');
  const xlsUploadBtn   = document.getElementById('xls-upload-btn');

  const holStartInput  = document.getElementById('hol-start-input');
  const holEndInput    = document.getElementById('hol-end-input');
  const holTitleInput  = document.getElementById('hol-title-input');
  const holAddBtn      = document.getElementById('hol-add-btn');
  const extraDayInput  = document.getElementById('extra-day-input');
  const extraAddBtn    = document.getElementById('extra-add-btn');
  const holidaysList   = document.getElementById('holidays-list');
  const extrasList     = document.getElementById('extras-list');

  const statsDateLabel = document.getElementById('stats-date-label');
  const statsTodayPill = document.getElementById('stats-today-pill');
  const statsWeekPill  = document.getElementById('stats-week-pill');
  const statsMonthPill = document.getElementById('stats-month-pill');
  const statsClassesTbody = document.getElementById('stats-classes-tbody');
  const refreshStatsBtn = document.getElementById('refresh-stats-btn');

  let settings = { holidays:[], extraSchoolDays:[] };
  let classesCache = [];

  function toDateStr(d){
    const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),day=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function weekRangeFor(dateStr){
    const d = new Date(dateStr);
    const day = d.getDay(); //0=Yak
    const diffToMon = (day === 0 ? -6 : 1-day);
    const start = new Date(d); start.setDate(d.getDate()+diffToMon);
    const end = new Date(start); end.setDate(start.getDate()+6);
    return { start: toDateStr(start), end: toDateStr(end) };
  }
  function monthRangeFor(dateStr){
    const d=new Date(dateStr);
    const s=new Date(d.getFullYear(),d.getMonth(),1);
    const e=new Date(d.getFullYear(),d.getMonth()+1,0);
    return { start:toDateStr(s), end:toDateStr(e) };
  }

  async function hashPassword(password){
    const enc = new TextEncoder().encode(password);
    const buf = await crypto.subtle.digest('SHA-256', enc);
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  // Admin login
  function tryAdminLogin(){
    const code = adminCodeInput.value;
    if(code === ADMIN_CODE){
      loginCard.style.display='none';
      content.style.display='grid';
      loadAll();
    }else{
      alert("Noto‚Äòg‚Äòri admin kod.");
    }
  }
  adminCodeBtn.addEventListener('click', tryAdminLogin);
  adminCodeInput.addEventListener('keydown', e=>{ if(e.key==='Enter') tryAdminLogin(); });

  // Classes
  async function loadClasses(){
    const snap = await classesCol.orderBy('name').get();
    classesCache = snap.docs.map(d=>({id:d.id,...d.data()}));

    classesTbody.innerHTML='';
    classesCache.forEach(cls=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${cls.name || ''}</td>
        <td>${cls.note || ''}</td>
        <td>${cls.teacherName || '-'}</td>
        <td>${cls.teacherLogin || '-'}</td>
        <td><button class="btn-ghost" data-id="${cls.id}">Tanlash</button></td>
      `;
      classesTbody.appendChild(tr);
    });

    // Dropdownlar
    const opts = classesCache.map(cls=>`<option value="${cls.id}">${cls.name || cls.id}</option>`).join('');
    teacherClassSelect.innerHTML = `<option value="">Sinf tanlang</option>` + opts;
    xlsClassSelect.innerHTML = `<option value="">Sinf tanlang</option>` + opts;

    // "Tanlash" tugmalari: sinf ma'lumotini chapdagi forma va teacher forma ga tashlaymiz
    classesTbody.querySelectorAll('button[data-id]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-id');
        const cls = classesCache.find(c=>c.id===id);
        if(!cls) return;
        classNameInput.value = cls.name || '';
        classNoteInput.value = cls.note || '';
        teacherClassSelect.value = id;
        teacherNameInput.value = cls.teacherName || '';
        teacherLoginInput.value = cls.teacherLogin || '';
      });
    });
  }

  classSaveBtn.addEventListener('click', async ()=>{
    const name = classNameInput.value.trim();
    const note = classNoteInput.value.trim();
    if(!name){ alert("Sinf nomini kiriting."); return; }

    // Agar shu nomli sinf allaqachon bo'lsa, uni yangilaymiz
    let existing = classesCache.find(c=>c.name===name);
    try{
      classSaveBtn.disabled=true;
      classSaveBtn.textContent="Saqlanmoqda...";

      if(existing){
        await classesCol.doc(existing.id).set({ name, note }, {merge:true});
      }else{
        await classesCol.add({ name, note, students:[] });
      }
      await loadClasses();
      alert("Sinf saqlandi.");
    }catch(e){
      console.error(e);
      alert("Sinfni saqlashda xatolik.");
    }finally{
      classSaveBtn.disabled=false;
      classSaveBtn.textContent="Sinfni saqlash";
    }
  });
  refreshClassesBtn.addEventListener('click', loadClasses);

  // Teacher
  teacherSaveBtn.addEventListener('click', async ()=>{
    const classId = teacherClassSelect.value;
    if(!classId){ alert("Sinfni tanlang."); return; }
    const fullName = teacherNameInput.value.trim();
    const login = teacherLoginInput.value.trim();
    const pw = teacherPasswordInput.value;

    if(!fullName || !login){ alert("F.I.Sh. va loginni kiriting."); return; }

    teacherSaveBtn.disabled=true;
    teacherSaveBtn.textContent="Saqlanmoqda...";

    try{
      // Mavjud teacher bor-yo'qligini topamiz
      let teacherDoc = null;
      const snap = await teachersCol.where('classId','==',classId).limit(1).get();
      if(!snap.empty){
        teacherDoc = { id:snap.docs[0].id, ...snap.docs[0].data() };
      }

      const dataToSet = {
        fullName,
        login,
        classId
      };
      if(pw){
        if(pw.length < 4){
          alert("Parol juda qisqa. Kamida 4 belgi bo‚Äòlsin.");
          teacherSaveBtn.disabled=false;
          teacherSaveBtn.textContent="Sinf rahbarini saqlash / yangilash";
          return;
        }
        dataToSet.passwordHash = await hashPassword(pw);
      }

      let teacherId;
      if(teacherDoc){
        await teachersCol.doc(teacherDoc.id).set(dataToSet,{merge:true});
        teacherId = teacherDoc.id;
      }else{
        const ref = await teachersCol.add(dataToSet);
        teacherId = ref.id;
      }

      // Sinf hujjatida teacherName va teacherLogin ni saqlab qo'yamiz
      await classesCol.doc(classId).set({
        teacherId,
        teacherName: fullName,
        teacherLogin: login
      },{merge:true});

      await loadClasses();
      alert("Sinf rahbari ma‚Äôlumotlari saqlandi.");
      teacherPasswordInput.value='';
    }catch(e){
      console.error(e);
      alert("Sinf rahbarini saqlashda xatolik.");
    }finally{
      teacherSaveBtn.disabled=false;
      teacherSaveBtn.textContent="Sinf rahbarini saqlash / yangilash";
    }
  });

  // XLS yuklash
  async function parseExcel(file){
    return new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onload = (e)=>{
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data,{type:'array'});
        const sheetName = wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(ws,{header:1});
        resolve(json);
      };
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  xlsUploadBtn.addEventListener('click', async ()=>{
    const classId = xlsClassSelect.value;
    if(!classId){ alert("Sinfni tanlang."); return; }
    const file = xlsInput.files[0];
    if(!file){ alert("Excel faylni tanlang."); return; }

    xlsUploadBtn.disabled=true;
    xlsUploadBtn.textContent="Yuklanmoqda...";

    try{
      const rows = await parseExcel(file);
      if(rows.length === 0){
        alert("Fayl bo‚Äòsh.");
        return;
      }
      // 1-ustun bo‚Äòyicha F.I.Sh. olamiz, birinchi qatordagi sarlavhani tashlab yuboramiz
      const students = [];
      rows.forEach((row,idx)=>{
        const val = (row[0] || '').toString().trim();
        if(!val) return;
        if(idx===0 && /fam/i.test(val)) return; // "Familiya" sarlavha bo'lsa tashlaymiz
        students.push({
          id: 'st_'+(idx+1)+'_'+Date.now(),
          fullName: val
        });
      });
      if(!students.length){
        alert("Hech qanday o‚Äòquvchi topilmadi. 1-ustunga F.I.Sh. larni yozing.");
        return;
      }
      await classesCol.doc(classId).set({ students },{merge:true});
      await loadClasses();
      alert("O‚Äòquvchilar ro‚Äòyxati yuklandi. Sinf rahbarlari endi davomatni to‚Äòldirishi mumkin.");
      xlsInput.value='';
    }catch(e){
      console.error(e);
      alert("Faylni o‚Äòqishda xatolik.");
    }finally{
      xlsUploadBtn.disabled=false;
      xlsUploadBtn.textContent="Ro‚Äòyxatni yuklash";
    }
  });

  // Settings (holidays, extra days)
  async function loadSettings(){
    const snap = await settingsDoc.get();
    if(snap.exists){
      settings = snap.data();
      settings.holidays = settings.holidays || [];
      settings.extraSchoolDays = settings.extraSchoolDays || [];
    }else{
      settings = { holidays:[], extraSchoolDays:[] };
    }
    renderSettingsUI();
  }

  function renderSettingsUI(){
    holidaysList.innerHTML='';
    settings.holidays.forEach((h,idx)=>{
      const div = document.createElement('div');
      div.className='tag';
      div.innerHTML = `
        <span>${h.start} ‚Üí ${h.end}</span>
        <span style="color:#666;">${h.title || ''}</span>
        <button data-idx="${idx}">√ó</button>
      `;
      holidaysList.appendChild(div);
    });
    holidaysList.querySelectorAll('button[data-idx]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const i = parseInt(btn.getAttribute('data-idx'));
        settings.holidays.splice(i,1);
        await settingsDoc.set(settings,{merge:true});
        renderSettingsUI();
      });
    });

    extrasList.innerHTML='';
    settings.extraSchoolDays.forEach((d,idx)=>{
      const div = document.createElement('div');
      div.className='tag';
      div.innerHTML = `${d} <button data-idx="${idx}">√ó</button>`;
      extrasList.appendChild(div);
    });
    extrasList.querySelectorAll('button[data-idx]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const i = parseInt(btn.getAttribute('data-idx'));
        settings.extraSchoolDays.splice(i,1);
        await settingsDoc.set(settings,{merge:true});
        renderSettingsUI();
      });
    });
  }

  holAddBtn.addEventListener('click', async ()=>{
    const s = holStartInput.value;
    const e = holEndInput.value;
    const title = holTitleInput.value.trim() || 'Ta‚Äôtil';
    if(!s || !e){ alert("Boshlanish va tugash sanasini kiriting."); return; }
    settings.holidays.push({ start:s, end:e, title });
    await settingsDoc.set(settings,{merge:true});
    holStartInput.value=''; holEndInput.value=''; holTitleInput.value='';
    renderSettingsUI();
  });

  extraAddBtn.addEventListener('click', async ()=>{
    const d = extraDayInput.value;
    if(!d){ alert("Sanani tanlang."); return; }
    if(!settings.extraSchoolDays.includes(d)){
      settings.extraSchoolDays.push(d);
      await settingsDoc.set(settings,{merge:true});
      renderSettingsUI();
      extraDayInput.value='';
    }
  });

  // Stats
  async function loadStats(){
    const today = toDateStr(new Date());
    statsDateLabel.textContent = "Hisob-kitob bazaviy sana: " + today;
    const wr = weekRangeFor(today);
    const mr = monthRangeFor(today);

    // Bugungi barcha davomat
    const todaySnap = await davomatCol.where('date','==',today).get();
    let tPresent=0,tTotal=0;
    todaySnap.forEach(doc=>{
      const s=doc.data().stats||{};
      tPresent+=s.presentCount||0;
      tTotal+=s.total||0;
    });
    statsTodayPill.textContent = tTotal ? `${Math.round(tPresent*100/tTotal)}% (Bor: ${tPresent}/${tTotal})` : "Ma‚Äôlumot yo‚Äòq";

    const weekSnap = await davomatCol
      .where('date','>=',wr.start)
      .where('date','<=',wr.end)
      .get();
    let wPresent=0,wTotal=0;
    weekSnap.forEach(doc=>{
      const s=doc.data().stats||{};
      wPresent+=s.presentCount||0;
      wTotal+=s.total||0;
    });
    statsWeekPill.textContent = wTotal ? `${Math.round(wPresent*100/wTotal)}%` : "Ma‚Äôlumot yo‚Äòq";

    const monthSnap = await davomatCol
      .where('date','>=',mr.start)
      .where('date','<=',mr.end)
      .get();
    let mPresent=0,mTotal=0;
    monthSnap.forEach(doc=>{
      const s=doc.data().stats||{};
      mPresent+=s.presentCount||0;
      mTotal+=s.total||0;
    });
    statsMonthPill.textContent = mTotal ? `${Math.round(mPresent*100/mTotal)}%` : "Ma‚Äôlumot yo‚Äòq";

    // Sinflar kesimida
    statsClassesTbody.innerHTML='';
    for(const cls of classesCache){
      // Today
      const tDocId = `${today}_${cls.id}`;
      const tDoc = await davomatCol.doc(tDocId).get();
      let tStr='‚Äî';
      if(tDoc.exists){
        const s=tDoc.data().stats||{};
        if(s.total){
          tStr=Math.round((s.presentCount||0)*100/s.total)+'%';
        }else tStr='0%';
      }

      // Week
      const wClsSnap = await davomatCol
        .where('classId','==',cls.id)
        .where('date','>=',wr.start)
        .where('date','<=',wr.end)
        .get();
      let wP=0,wT=0;
      wClsSnap.forEach(doc=>{
        const s=doc.data().stats||{};
        wP+=s.presentCount||0; wT+=s.total||0;
      });
      const wStr = wT ? Math.round(wP*100/wT)+'%' : '‚Äî';

      // Month
      const mClsSnap = await davomatCol
        .where('classId','==',cls.id)
        .where('date','>=',mr.start)
        .where('date','<=',mr.end)
        .get();
      let mP=0,mT=0;
      mClsSnap.forEach(doc=>{
        const s=doc.data().stats||{};
        mP+=s.presentCount||0; mT+=s.total||0;
      });
      const mStr = mT ? Math.round(mP*100/mT)+'%' : '‚Äî';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${cls.name || ''}</td>
        <td>${tStr}</td>
        <td>${wStr}</td>
        <td>${mStr}</td>
      `;
      statsClassesTbody.appendChild(tr);
    }
  }
  refreshStatsBtn.addEventListener('click', loadStats);

  async function loadAll(){
    await loadClasses();
    await loadSettings();
    await loadStats();
  }
</script>
</body>
</html>
