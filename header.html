<!-- HEADER FRAGMENT (patched) -->
<style>
  :root {
    --primary: #19b36b;
    --primary-dark: #118654;
    --accent: #A0EBC5;
    --text: #0b1f17;
    --granite-bg: #f2f8f5;
  }
  header.xpy-header { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--granite-bg); border-bottom: 1px solid rgba(0,0,0,.06); }
  .xpy-container { max-width: 1100px; margin: 0 auto; padding: .8rem 1rem; display:flex; align-items:center; gap:1rem; justify-content:space-between; }
  .xpy-brand { display:flex; align-items:center; gap:.6rem; text-decoration:none; color:var(--text); font-weight:700; letter-spacing:.2px; }
  .xpy-logo { width: 42px; height: 42px; border-radius: 12px; background: radial-gradient(ellipse at 30% 30%, #fff 0%, #dff5ea 45%, #b6ebd2 100%); border: 1px solid rgba(0,0,0,.06); box-shadow: 0 8px 24px rgba(25,179,107,.25), inset 0 0 12px rgba(25,179,107,.35); display:grid; place-items:center; font-size:26px; color:var(--primary-dark); }
  .xpy-nav a { color: var(--text); text-decoration:none; padding:.6rem .8rem; border-radius:12px; }
  .xpy-nav a:hover { background: #fff; box-shadow: 0 6px 16px rgba(0,0,0,.06);}
  .xpy-auth { display:flex; align-items:center; gap:.6rem; }
  .xpy-btn { border:1px solid rgba(0,0,0,.08); padding:.55rem .85rem; border-radius:12px; background:#fff; cursor:pointer; }
  .xpy-btn.primary { background: var(--primary); color:#fff; border:none; }
  .xpy-profile-pill { font-size:.9rem; padding:.45rem .7rem; border-radius:999px; background:#fff; border:1px solid rgba(0,0,0,.08); color:var(--text); max-width: 52vw; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  @media (max-width: 720px) { .xpy-nav { display:none; } }
</style>

<header class="xpy-header" data-xpy="header">
  <div class="xpy-container">
    <a class="xpy-brand" href="/" id="xpyBrand">
      <div class="xpy-logo">π</div>
      <div>
        <div id="xpyLogoText">π XplusY</div>
        <small style="opacity:.7" id="xpyLogoSub">MathCenter</small>
      </div>
    </a>
    <nav class="xpy-nav" id="xpyMenu"></nav>
    <div class="xpy-auth">
      <span class="xpy-profile-pill" id="xpyProfilePill" title="Profil"></span>
      <button class="xpy-btn" id="xpyLoginBtn">Google bilan kirish</button>
      <button class="xpy-btn" id="xpyLogoutBtn" style="display:none">Chiqish</button>
      <a class="xpy-btn primary" id="xpyAdminBtn" href="headerfooteradmin.html" style="display:none">Admin</a>
    </div>
  </div>
</header>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // === Sizdagi config (o'zgartirmang) ===
  const firebaseConfig = {
    apiKey: "AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
    authDomain: "xplusy-760fa.firebaseapp.com",
    projectId: "xplusy-760fa",
    storageBucket: "xplusy-760fa.firebasestorage.app",
    messagingSenderId: "992512966017",
    appId: "1:992512966017:web:5e919dbc9b8d8abcb43c80",
    measurementId: "G-459PLJ7P7L"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const els = {
    menu:  document.getElementById("xpyMenu"),
    pill:  document.getElementById("xpyProfilePill"),
    login: document.getElementById("xpyLoginBtn"),
    logout:document.getElementById("xpyLogoutBtn"),
    admin: document.getElementById("xpyAdminBtn"),
    logoText: document.getElementById("xpyLogoText"),
    logoSub:  document.getElementById("xpyLogoSub"),
    brand:    document.getElementById("xpyBrand"),
  };

  // --- CONFIG yuklash (Firestore -> JSON -> default) ---
  let configCache = null;
  async function loadConfig() {
    try {
      const snap = await getDoc(doc(db, "meta", "header_footer"));
      if (snap.exists()) return snap.data();
    } catch (e) { console.warn("[xpy] header_footer Firestore xato", e); }
    try {
      const r = await fetch("headerfooteradmin.json", {cache:"no-store"});
      if (r.ok) return await r.json();
    } catch (e) { console.warn("[xpy] local headerfooteradmin.json xato", e); }
    return {
      theme: {primary:"#19b36b", primaryDark:"#118654", accent:"#A0EBC5", text:"#0b1f17", graniteBg:"#f2f8f5"},
      brand: {logoText:"π XplusY", logoSubtitle:"MathCenter", logoHref:"/"},
      menu: [
        {title:"Bosh sahifa", href:"index.html"},
        {title:"Testlar", href:"tests.html"},
        {title:"Kurslar", href:"courses.html"},
        {title:"Simulyator", href:"simulators.html"},
        {title:"Natijalar", href:"results.html"},
        {title:"Profil", href:"profile.html"}
      ],
      profileHeader:{show:true, format:"Salom, {name}! ID: {id} • Balans: {balans} • Ball: {ball}"},
      admins:{emails:["admin@xplusy.uz"]}
    };
  }

  function renderMenu(menu=[]) {
    els.menu.innerHTML = "";
    menu.forEach(m => {
      const a = document.createElement("a");
      a.href = m.href; a.textContent = m.title;
      els.menu.appendChild(a);
    });
  }
  function applyBrand(cfg) {
    els.logoText.textContent = cfg.brand?.logoText || "π XplusY";
    els.logoSub.textContent  = cfg.brand?.logoSubtitle || "MathCenter";
    if (cfg.brand?.logoHref) els.brand.href = cfg.brand.logoHref;
    const t = cfg.theme || {};
    const r = document.documentElement;
    if (t.primary)    r.style.setProperty("--primary", t.primary);
    if (t.primaryDark)r.style.setProperty("--primary-dark", t.primaryDark);
    if (t.accent)     r.style.setProperty("--accent", t.accent);
    if (t.text)       r.style.setProperty("--text", t.text);
    if (t.graniteBg)  r.style.setProperty("--granite-bg", t.graniteBg);
  }
  function isAdmin(user, cfg){ 
    const emails = (cfg?.admins?.emails||[]).map(x=>x.toLowerCase());
    return !!user?.email && emails.includes(user.email.toLowerCase());
  }

  // --- YANGI: nomalash yordamchilari ---
  function fallbackName(user, profile) {
    if (profile?.name && String(profile.name).trim()) return profile.name;
    if (user?.displayName && user.displayName.trim()) return user.displayName;
    if (user?.email) return user.email.split("@")[0];
    return "Foydalanuvchi";
  }
  function fmtNumber(x) {
    const n = Number(x);
    if (!isFinite(n)) return String(x ?? "0");
    return new Intl.NumberFormat("uz-UZ").format(n);
  }
  async function normalizeProfile(user, profile) {
    const patch = {};
    if (!profile || typeof profile !== "object") profile = {};
    if (!profile.name || !String(profile.name).trim()) patch.name = fallbackName(user, profile);
    if (!profile.id   || String(profile.id).trim()==="") patch.id = Math.floor(1000 + Math.random()*9000);
    if (profile.balans === undefined || profile.balans === null || profile.balans==="") patch.balans = 0;
    if (profile.ball   === undefined || profile.ball   === null || profile.ball==="")   patch.ball = 0;

    if (Object.keys(patch).length) {
      try { await setDoc(doc(db,"users",user.uid), patch, {merge:true}); }
      catch(e){ console.warn("[xpy] normalize merge failed (rules?)", e); }
      profile = {...patch, ...profile};
    }
    return profile;
  }

  // --- users doc ---
  async function getOrCreateProfile(user) {
    try {
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        try {
          await setDoc(ref, {
            name: user.displayName || "Foydalanuvchi",
            id: Math.floor(1000 + Math.random()*9000),
            balans: 0,
            ball: 0,
            email: user.email || null,
            createdAt: Date.now()
          });
        } catch(e){ console.warn("[xpy] setDoc(users) xato (rules?)", e); }
      }
      const snap2 = await getDoc(ref);
      if (snap2.exists()) return snap2.data();
      throw new Error("users doc not readable");
    } catch(e){
      console.warn("[xpy] users fallback", e);
      return { name: fallbackName(user,{}), id:"—", balans:"—", ball:"—" };
    }
  }

  function setSignedOutUI(){
    els.pill.textContent = "";
    els.login.style.display  = "inline-block";
    els.logout.style.display = "none";
    els.admin.style.display  = "none";
  }
  function setSignedInUI(profile, cfg, user){
    const fmt = (cfg?.profileHeader?.format) || "Salom, {name}! ID: {id} • Balans: {balans} • Ball: {ball}";
    const txt = fmt
      .replace("{name}",   profile.name ?? "")
      .replace("{id}",     String(profile.id ?? ""))
      .replace("{balans}", String(profile.balans ?? ""))
      .replace("{ball}",   String(profile.ball ?? ""));
    els.pill.textContent = txt;
    els.login.style.display  = "none";
    els.logout.style.display = "inline-block";
    els.admin.style.display  = isAdmin(user, cfg) ? "inline-block" : "none";
  }

  els.login.addEventListener("click", async () => {
    try { await signInWithPopup(auth, new GoogleAuthProvider()); }
    catch(e){ console.error("[xpy] signIn xato", e); }
  });
  els.logout.addEventListener("click", async () => {
    try { await signOut(auth); } catch(e){ console.error("[xpy] signOut xato", e); }
  });

  onAuthStateChanged(auth, async (user) => {
    if (!configCache) configCache = await loadConfig();
    applyBrand(configCache); renderMenu(configCache.menu);

    if (user){
      let profile = await getOrCreateProfile(user);
      profile = await normalizeProfile(user, profile);     // <— Yangi qadam
      // chiroyli raqamlar
      profile.balans = fmtNumber(profile.balans);
      profile.ball   = fmtNumber(profile.ball);
      setSignedInUI(profile, configCache, user);
    } else {
      setSignedOutUI();
    }
  });
</script>

