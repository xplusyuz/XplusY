<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>XplusY Header</title>
  <style>
    :root{
      --primary:#19b36b; --primary-dark:#118654; --accent:#A0EBC5; --text:#0b1f17; --granite-bg:#f2f8f5;
      --radius:14px; --gap:10px; --tap:44px;
    }
    body{margin:0}
    /* Sticky, blur, shadow */
    header.xpy-header{position:sticky;top:0;z-index:70;background:var(--granite-bg);
      border-bottom:1px solid rgba(0,0,0,.06);backdrop-filter:saturate(1.2) blur(6px)}
    .xpy-header.scrolled{ box-shadow:0 6px 20px rgba(0,0,0,.08) }

    .xpy-container{display:flex;align-items:center;justify-content:space-between;
      max-width:1100px;margin:0 auto;padding:.6rem clamp(12px,4vw,20px);gap:var(--gap);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

    /* Brand */
    .xpy-brand{display:flex;align-items:center;gap:.6rem;text-decoration:none;color:var(--text)}
    .xpy-logo{width:40px;height:40px;border-radius:12px;background:radial-gradient(ellipse at 30% 30%,#fff 0%,#dff5ea 45%,#b6ebd2 100%);
      display:grid;place-items:center;font-size:24px;color:var(--primary-dark);border:1px solid rgba(0,0,0,.06)}
    .xpy-brand-txt{display:flex;flex-direction:column;line-height:1.05}

    /* Nav */
    .xpy-nav{display:flex;gap:4px;flex:1;justify-content:center}
    .xpy-nav a{padding:.5rem .75rem;border-radius:var(--radius);color:var(--text);text-decoration:none}
    .xpy-nav a:hover{background:#fff;box-shadow:0 6px 16px rgba(0,0,0,.06)}

    /* Actions */
    .xpy-actions{display:flex;align-items:center;gap:6px}
    .xpy-btn{border:1px solid rgba(0,0,0,.08);background:#fff;cursor:pointer;border-radius:var(--radius);
      min-height:var(--tap);padding:.5rem .85rem;font:inherit}
    .xpy-btn.primary{background:var(--primary);color:#fff;border:none}
    .xpy-pill{max-width:42vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border:1px solid rgba(0,0,0,.08);
      background:#fff;border-radius:999px;padding:.4rem .7rem}

    /* Avatar + status + badge */
    .xpy-notif-wrap{position:relative}
    .xpy-avatar{position:relative;width:36px;height:36px;border-radius:50%;display:grid;place-items:center;font-weight:700;overflow:hidden;
      background:#e9fff3;color:var(--primary-dark);border:1px solid rgba(0,0,0,.06);box-shadow:0 4px 10px rgba(0,0,0,.06);cursor:pointer}
    .xpy-avatar img{width:100%;height:100%;object-fit:cover;display:none}
    .xpy-status{position:absolute;right:-2px;bottom:-2px;width:10px;height:10px;border-radius:50%;background:#c2c2c2;border:2px solid #fff}
    .xpy-status.online{background:#22c55e}
    .xpy-badge{position:absolute;top:-3px;right:-3px;min-width:16px;height:16px;border-radius:999px;background:#ef4444;color:#fff;
      font-size:11px;font-weight:600;display:none;align-items:center;justify-content:center;padding:0 3px;border:2px solid #fff}

    /* Notifications dropdown */
    .xpy-notif-panel{position:absolute;right:0;top:calc(100% + 8px);width:min(92vw,420px);max-height:60vh;overflow:auto;background:#fff;
      border:1px solid rgba(0,0,0,.08);border-radius:14px;box-shadow:0 16px 40px rgba(0,0,0,.14);display:none;z-index:80}
    .xpy-notif-panel.open{display:block}
    .xpy-notif-head{position:sticky;top:0;background:#fff;z-index:1;display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;border-bottom:1px solid #eee}
    .xpy-notif-actions button{border:1px solid rgba(0,0,0,.08);background:#fff;border-radius:10px;padding:6px 8px;cursor:pointer}
    .xpy-notif-list{padding:6px}
    .xpy-notif-item{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:10px;border-radius:12px;
      border:1px solid rgba(0,0,0,.06);background:#fff;margin:6px 0}
    .xpy-notif-item.unread{background:#f7fffb;border-color:#cfeede}
    .xpy-notif-item h4{margin:0;font-size:14px}
    .xpy-notif-item p{margin:2px 0 0;font-size:13px;opacity:.85}
    .xpy-notif-time{font-size:12px;opacity:.7;white-space:nowrap}
    .xpy-notif-empty,.xpy-notif-loader{padding:12px;text-align:center;color:#666}

    /* Mobile burger + bottom-sheet */
    .xpy-burger{display:none;width:var(--tap);height:var(--tap);border:1px solid rgba(0,0,0,.08);border-radius:var(--radius);background:#fff}
    .xpy-dim{position:fixed;inset:0;background:rgba(0,0,0,.28);opacity:0;visibility:hidden;transition:.25s;z-index:75}
    .xpy-dim.show{opacity:1;visibility:visible}
    .xpy-sheet{position:fixed;inset:auto 0 0 0;width:100%;background:#fff;border-radius:16px 16px 0 0;transform:translateY(102%);
      transition:.3s ease;z-index:90;box-shadow:0 -24px 48px rgba(0,0,0,.16)}
    .xpy-sheet.open{transform:translateY(0)}

    @media (max-width:1024px){.xpy-nav{display:none}.xpy-pill{display:none}.xpy-burger{display:block}}
    @media (prefers-reduced-motion:reduce){.xpy-sheet,.xpy-dim{transition:none}}
  </style>
</head>
<body>
<header class="xpy-header" id="xpyHeader">
  <div class="xpy-container">
    <a class="xpy-brand" id="xpyBrand" href="/">
      <div class="xpy-logo" aria-hidden="true">π</div>
      <div class="xpy-brand-txt"><strong id="xpyLogoText">π XplusY</strong><small id="xpyLogoSub">MathCenter</small></div>
    </a>

    <!-- Desktop nav -->
    <nav class="xpy-nav" id="xpyMenu" aria-label="Asosiy navigatsiya"></nav>

    <!-- Actions -->
    <div class="xpy-actions">
      <!-- Avatar + badge + dropdown wrap -->
      <div class="xpy-notif-wrap" id="xpyNotifWrap">
        <div class="xpy-avatar" id="xpyAvatar" title="Profil & bildirishnomalar">
          <img id="xpyAvatarImg" alt="Profil" referrerpolicy="no-referrer" />
          <span id="xpyAvatarTxt">?</span>
          <span class="xpy-status" id="xpyStatus"></span>
          <span class="xpy-badge" id="xpyBadge">0</span>
        </div>

        <!-- Notifications dropdown -->
        <div class="xpy-notif-panel" id="xpyNotifPanel" role="dialog" aria-label="Bildirishnomalar">
          <div class="xpy-notif-head">
            <strong>Bildirishnomalar</strong>
            <div class="xpy-notif-actions">
              <button id="xpyMarkAllBtn">Hammasi o‘qilgan</button>
            </div>
          </div>
          <div class="xpy-notif-list" id="xpyNotifList"></div>
          <div class="xpy-notif-loader" id="xpyNotifLoader" style="display:none">Yuklanmoqda…</div>
        </div>
      </div>

      <span class="xpy-pill" id="xpyProfilePill"></span>
      <button class="xpy-btn" id="xpyLoginBtn">Kirish</button>
      <button class="xpy-btn" id="xpyLogoutBtn" style="display:none">Chiqish</button>
      <a class="xpy-btn primary" id="xpyAdminBtn" style="display:none" href="headerfooteradmin.html">Admin</a>
      <button class="xpy-burger" id="xpyBurger" aria-label="Menyu">☰</button>
    </div>
  </div>

  <!-- Bottom-sheet (mobile) -->
  <div class="xpy-dim" id="xpyDim"></div>
  <aside class="xpy-sheet" id="xpySheet" role="dialog" aria-modal="true" aria-label="Menyu">
    <div style="padding:14px 16px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center">
      <strong>XplusY</strong><button class="xpy-btn" id="xpyCloseSheet" aria-label="Yopish">✕</button>
    </div>
    <div style="padding:14px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <div class="xpy-avatar" id="xpyAvatarM">
          <img id="xpyAvatarImgM" alt="Profil" referrerpolicy="no-referrer"/>
          <span id="xpyAvatarTxtM">?</span>
          <span class="xpy-badge" id="xpyBadgeM">0</span>
        </div>
        <div id="xpyMobileProfile">—</div>
      </div>
      <nav id="xpySheetNav" aria-label="Mobil menyu"></nav>
      <div style="margin-top:12px;display:flex;gap:6px">
        <button class="xpy-btn" id="xpyLoginBtnM">Kirish</button>
        <button class="xpy-btn" id="xpyLogoutBtnM" style="display:none">Chiqish</button>
        <a class="xpy-btn primary" id="xpyAdminBtnM" style="display:none" href="headerfooteradmin.html">Admin</a>
      </div>
    </div>
  </aside>
</header>

<script type="module">
/* ================= Firebase ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc, writeBatch,
  collection, query, where, orderBy, limit, startAfter, getDocs, onSnapshot, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* === Project config (sizniki) === */
const firebaseConfig = {
  apiKey:"AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  authDomain:"xplusy-760fa.firebaseapp.com",
  projectId:"xplusy-760fa"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* ================= DOM refs ================= */
const el = (id)=>document.getElementById(id);
const H = el("xpyHeader");
const brand = { text: el("xpyLogoText"), sub: el("xpyLogoSub"), a: el("xpyBrand") };
const nav = { desk: el("xpyMenu"), sheet: el("xpySheetNav") };
const btn = {
  login: el("xpyLoginBtn"), logout: el("xpyLogoutBtn"), admin: el("xpyAdminBtn"),
  loginM: el("xpyLoginBtnM"), logoutM: el("xpyLogoutBtnM"), adminM: el("xpyAdminBtnM"),
  burger: el("xpyBurger"), close: el("xpyCloseSheet")
};
const sheet = { dim: el("xpyDim"), panel: el("xpySheet") };
const pill = { desk: el("xpyProfilePill"), mob: el("xpyMobileProfile") };
const avatar = {
  wrap: el("xpyNotifWrap"), btn: el("xpyAvatar"),
  img: el("xpyAvatarImg"), imgM: el("xpyAvatarImgM"),
  txt: el("xpyAvatarTxt"), txtM: el("xpyAvatarTxtM"),
  status: el("xpyStatus"), badge: el("xpyBadge"), badgeM: el("xpyBadgeM")
};
const drop = { panel: el("xpyNotifPanel"), list: el("xpyNotifList"), loader: el("xpyNotifLoader"), all: el("xpyMarkAllBtn") };

/* ================= UI helpers ================= */
function shadowOnScroll(){ if (window.scrollY > 4) H.classList.add("scrolled"); else H.classList.remove("scrolled"); }
window.addEventListener("scroll", ()=>{ window.requestAnimationFrame(shadowOnScroll); });

/* Bottom-sheet */
function openSheet(){ sheet.panel.classList.add("open"); sheet.dim.classList.add("show"); btn.burger.setAttribute("aria-expanded","true"); btn.close.focus(); }
function closeSheet(){ sheet.panel.classList.remove("open"); sheet.dim.classList.remove("show"); btn.burger.setAttribute("aria-expanded","false"); }
btn.burger.addEventListener("click", openSheet);
btn.close.addEventListener("click", closeSheet);
sheet.dim.addEventListener("click", closeSheet);
document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeSheet(); });

/* Menu mirror to sheet */
function mirrorMenu(){
  nav.sheet.innerHTML = "";
  nav.desk.querySelectorAll("a").forEach(a=>{
    const c = a.cloneNode(true); c.removeAttribute("style"); c.addEventListener("click", closeSheet);
    nav.sheet.appendChild(c);
  });
}

/* Avatar render */
function setAvatar(user, online){
  const display = user?.displayName || user?.email || "Foydalanuvchi";
  const letter  = display.trim()[0]?.toUpperCase() || "?";
  const photo   = user?.photoURL || null;
  if (photo){
    [avatar.img, avatar.imgM].forEach(i=>{ if(i){ i.src = photo; i.style.display="block"; }});
    [avatar.txt, avatar.txtM].forEach(t=>{ if(t) t.style.display="none"; });
  } else {
    [avatar.txt, avatar.txtM].forEach(t=>{ if(t){ t.textContent=letter; t.style.display="block"; }});
    [avatar.img, avatar.imgM].forEach(i=>{ if(i) i.style.display="none"; });
  }
  if (avatar.status) avatar.status.classList.toggle("online", !!online);
}

/* Badge */
function setBadge(n){ [avatar.badge, avatar.badgeM].forEach(b=>{ if(!b) return; if(n>0){ b.style.display="flex"; b.textContent=(n>99?"99+":n); } else b.style.display="none"; }); }

/* ================= Config load (brand/menu) ================= */
async function loadConfig(){
  // Firestore meta/header_footer -> local json -> defaults
  try {
    const s = await getDoc(doc(db,"meta","header_footer"));
    if (s.exists()) return s.data();
  } catch {}
  try {
    const r = await fetch("headerfooteradmin.json",{cache:"no-store"}); if (r.ok) return await r.json();
  } catch {}
  return {
    theme:{primary:"#19b36b",primaryDark:"#118654",accent:"#A0EBC5",text:"#0b1f17",graniteBg:"#f2f8f5"},
    brand:{logoText:"π XplusY",logoSubtitle:"MathCenter",logoHref:"/"},
    menu:[
      {title:"Bosh sahifa",href:"index.html"},
      {title:"Testlar",href:"tests.html"},
      {title:"Kurslar",href:"courses.html"},
      {title:"Simulyator",href:"simulators.html"},
      {title:"Natijalar",href:"results.html"},
      {title:"Profil",href:"profile.html"}
    ],
    profileHeader:{show:true,format:"Salom, {name}! ID: {id} • Balans: {balans} • Ball: {ball}"},
    admins:{emails:["admin@xplusy.uz"]}
  };
}
function applyBrand(cfg){
  brand.text.textContent = cfg.brand?.logoText || "π XplusY";
  brand.sub.textContent  = cfg.brand?.logoSubtitle || "MathCenter";
  if (cfg.brand?.logoHref) brand.a.href = cfg.brand.logoHref;
  const t = cfg.theme||{};
  const r = document.documentElement;
  if (t.primary)    r.style.setProperty("--primary", t.primary);
  if (t.primaryDark)r.style.setProperty("--primary-dark", t.primaryDark);
  if (t.accent)     r.style.setProperty("--accent", t.accent);
  if (t.text)       r.style.setProperty("--text", t.text);
  if (t.graniteBg)  r.style.setProperty("--granite-bg", t.graniteBg);
}
function renderMenu(items=[]){
  nav.desk.innerHTML=""; items.forEach(m=>{ const a=document.createElement("a"); a.href=m.href; a.textContent=m.title; nav.desk.appendChild(a); });
  mirrorMenu();
}
function isAdmin(user,cfg){ const emails=(cfg?.admins?.emails||[]).map(x=>x.toLowerCase()); return !!user?.email && emails.includes(user.email.toLowerCase()); }

/* ================= Profile helpers ================= */
function fmtUZ(x){ const n=Number(x); if (!isFinite(n)) return String(x??"0"); return new Intl.NumberFormat("uz-UZ").format(n); }
function fallbackName(user, profile){ if(profile?.name && String(profile.name).trim()) return profile.name; if(user?.displayName) return user.displayName; if(user?.email) return user.email.split("@")[0]; return "Foydalanuvchi"; }
async function getOrCreateProfile(user){
  try{
    const ref = doc(db,"users",user.uid);
    let s = await getDoc(ref);
    if (!s.exists()){
      try{
        await setDoc(ref,{ name: user.displayName||fallbackName(user,{}), id: Math.floor(1000+Math.random()*9000), balans:0, ball:0, email:user.email||null, createdAt: serverTimestamp() });
      }catch(e){}
      s = await getDoc(ref);
    }
    if (s.exists()) return s.data();
    throw new Error("users doc not readable");
  }catch(e){
    return { name: fallbackName(user,{}), id:"—", balans:"—", ball:"—" };
  }
}
async function normalizeProfile(user, profile){
  const patch={};
  if (!profile || typeof profile!=="object") profile = {};
  if (!profile.name || !String(profile.name).trim()) patch.name=fallbackName(user,profile);
  if (!profile.id   || String(profile.id).trim()==="") patch.id=Math.floor(1000+Math.random()*9000);
  if (profile.balans===undefined||profile.balans===null||profile.balans==="") patch.balans=0;
  if (profile.ball  ===undefined||profile.ball  ===null||profile.ball  ==="") patch.ball=0;
  if (Object.keys(patch).length){
    try{ await setDoc(doc(db,"users",user.uid), patch, {merge:true}); }catch(e){}
    profile = {...patch, ...profile};
  }
  return profile;
}
function setSignedOutUI(){
  pill.desk.textContent=""; pill.mob.textContent="";
  btn.login.style.display="inline-block"; btn.logout.style.display="none";
  btn.loginM.style.display="inline-block"; btn.logoutM.style.display="none";
  btn.admin.style.display="none"; btn.adminM.style.display="none";
  setAvatar(null,false); setBadge(0);
}
function setSignedInUI(profile, cfg, user){
  const fmt = (cfg?.profileHeader?.format) || "Salom, {name}! ID: {id} • Balans: {balans} • Ball: {ball}";
  const text = fmt
    .replace("{name}",   profile.name ?? "")
    .replace("{id}",     String(profile.id ?? ""))
    .replace("{balans}", String(profile.balans ?? ""))
    .replace("{ball}",   String(profile.ball ?? ""));
  pill.desk.textContent = text;
  pill.mob.textContent  = text;
  btn.login.style.display="none"; btn.logout.style.display="inline-block";
  btn.loginM.style.display="none"; btn.logoutM.style.display="inline-block";
  const showAdmin = isAdmin(user, cfg);
  btn.admin.style.display = showAdmin?"inline-block":"none";
  btn.adminM.style.display= showAdmin?"inline-block":"none";
}

/* ================= Notifications ================= */
let notifUnsub = null;
function listenNotifications(user){
  const qUnread = query(collection(db,"notifications",user.uid,"items"), where("read","==",false));
  return onSnapshot(qUnread, snap => setBadge(snap.size));
}

/* Dropdown state */
let pageCursor = null;
const PAGE_SIZE = 20;
function fmtTime(ts){ try{ const d = ts?.toDate ? ts.toDate() : new Date(ts||Date.now()); return d.toLocaleString("uz-UZ"); }catch{return ""; } }
async function loadPage(user, reset=false){
  if (!user) return;
  drop.loader.style.display="block";
  let qRef = query(collection(db,"notifications",user.uid,"items"), orderBy("createdAt","desc"), limit(PAGE_SIZE));
  if (!reset && pageCursor) qRef = query(qRef, startAfter(pageCursor));
  const snap = await getDocs(qRef);
  if (reset) drop.list.innerHTML="";
  snap.forEach(docSnap=>{
    const d = docSnap.data();
    const div = document.createElement("div");
    div.className = "xpy-notif-item " + (d.read ? "" : "unread");
    div.dataset.id = docSnap.id;
    div.innerHTML = `
      <div style="width:8px;height:8px;border-radius:50%;background:${d.read?"#ddd":"#19b36b"};margin-left:4px"></div>
      <div><h4>${(d.title||"").replace(/</g,"&lt;")}</h4>${d.body?`<p>${String(d.body).replace(/</g,"&lt;")}</p>`:""}</div>
      <div class="xpy-notif-time">${fmtTime(d.createdAt)}</div>`;
    drop.list.appendChild(div);
  });
  pageCursor = snap.docs[snap.docs.length-1] || pageCursor;
  if (!drop.list.children.length) drop.list.innerHTML = `<div class="xpy-notif-empty">Hozircha bildirishnoma yo‘q</div>`;
  drop.loader.style.display="none";
}
function openDropdown(user){
  if (!user) return;
  drop.panel.classList.add("open");
  pageCursor = null;
  loadPage(user, true);
}
function closeDropdown(){ drop.panel.classList.remove("open"); }

avatar.btn.addEventListener("click", ()=>{
  if (drop.panel.classList.contains("open")) closeDropdown(); else openDropdown(auth.currentUser);
});
document.addEventListener("click",(e)=>{ if (!drop.panel.classList.contains("open")) return; if (!avatar.wrap.contains(e.target)) closeDropdown(); });
drop.panel.addEventListener("scroll", ()=>{
  if (drop.panel.scrollTop + drop.panel.clientHeight >= drop.panel.scrollHeight - 60){
    loadPage(auth.currentUser, false);
  }
});
drop.list.addEventListener("click", async (e)=>{
  const item = e.target.closest(".xpy-notif-item"); if (!item || !auth.currentUser) return;
  try{
    await updateDoc(doc(db,"notifications",auth.currentUser.uid,"items",item.dataset.id), { read:true });
    item.classList.remove("unread");
  }catch(err){ console.warn("mark read failed", err); }
});
drop.all.addEventListener("click", async ()=>{
  if (!auth.currentUser) return;
  try{
    const qUnread = query(collection(db,"notifications",auth.currentUser.uid,"items"), where("read","==",false));
    const snap = await getDocs(qUnread);
    const batch = writeBatch(db);
    snap.forEach(ds=> batch.update(ds.ref,{read:true}));
    await batch.commit();
    setBadge(0);
    // UI refresh
    drop.list.querySelectorAll(".xpy-notif-item.unread").forEach(x=>x.classList.remove("unread"));
  }catch(err){ console.warn("mark all failed", err); }
});

/* ================= Auth flow ================= */
let cfg = null; let unsubRT = null;
btn.login.addEventListener("click", ()=>signInWithPopup(auth, new GoogleAuthProvider()));
btn.loginM.addEventListener("click", ()=>signInWithPopup(auth, new GoogleAuthProvider()));
[btn.logout, btn.logoutM].forEach(b=> b.addEventListener("click", ()=>signOut(auth)));

onAuthStateChanged(auth, async (user)=>{
  if (!cfg){ cfg = await loadConfig(); applyBrand(cfg); renderMenu(cfg.menu||[]); }
  if (user){
    setAvatar(user, true);
    let profile = await getOrCreateProfile(user);
    profile = await normalizeProfile(user, profile);
    // chiroyli raqamlar
    profile.balans = fmtUZ(profile.balans);
    profile.ball   = fmtUZ(profile.ball);
    setSignedInUI(profile, cfg, user);
    if (unsubRT) unsubRT(); unsubRT = listenNotifications(user);
  } else {
    setSignedOutUI();
    if (unsubRT) unsubRT(); unsubRT = null;
  }
});

/* Init */
shadowOnScroll();
</script>
</body>
</html>
