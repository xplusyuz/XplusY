<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MathCenter Header — Firebase (Prod)</title>

  <!-- Favicon: 3D/granit logo (inline SVG) -->
  <link rel="icon" type="image/svg+xml"
    href='data:image/svg+xml;utf8,
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
      <defs>
        <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="%232E8B57"/>
          <stop offset="1" stop-color="%231F6B45"/>
        </linearGradient>
        <filter id="s" x="-50%" y="-50%" width="200%" height="200%">
          <feDropShadow dx="0" dy="10" stdDeviation="12" flood-color="%23000000" flood-opacity="0.35"/>
        </filter>
      </defs>
      <rect width="512" height="512" rx="96" fill="url(%23g1)"/>
      <g filter="url(%23s)">
        <text x="256" y="332" text-anchor="middle" font-size="300" font-family="Georgia,serif" fill="white">π</text>
      </g>
    </svg>'>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    :root{
      --primary:#2E8B57;--primary-dark:#1F6B45;--primary-light:#E8F5E9;
      --accent:#FFC107;--text:#222;--muted:#6b7280;
      --gray-50:#fafafa;--gray-100:#f3f4f6;--gray-200:#e5e7eb;--gray-300:#d1d5db;
      --shadow:0 10px 30px rgba(0,0,0,.08);--tr:all .25s cubic-bezier(.25,.8,.25,1);--radius:14px
    }
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#fff}

    .mc-header{box-shadow:var(--shadow);border-radius:var(--radius);overflow:hidden;border:1px solid var(--gray-200);background:#fff}
    .container{max-width:1280px;margin:0 auto;padding:0 16px}
    .row{display:flex;align-items:center;justify-content:space-between}

    /* Top bar */
    .mc-top{background:#123a31;color:#fff}
    .mc-top .row{padding:8px 0}
    .mc-top__left{display:flex;gap:14px;align-items:center;white-space:nowrap}
    .mc-top__left .mini{display:flex;align-items:center;gap:8px;font-size:13px;opacity:.95}
    .mc-top__right{display:flex;gap:12px}
    .mc-top__right a{color:#fff;transition:var(--tr)} .mc-top__right a:hover{color:var(--accent)}

    /* Main */
    .mc-main .row{padding:12px 0;gap:12px}
    .logo{display:flex;align-items:center;gap:14px;text-decoration:none;color:inherit}
    .logo__pi{
      width:64px;height:64px;border-radius:16px;
      background:
        radial-gradient(120% 140% at 20% 10%, rgba(255,255,255,.35), transparent 50%),
        repeating-linear-gradient(45deg, rgba(255,255,255,.08) 0 6px, rgba(0,0,0,.06) 6px 12px),
        linear-gradient(135deg,var(--primary),var(--primary-dark));
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:800;font-size:34px;
      box-shadow:inset 0 6px 18px rgba(255,255,255,.25), inset 0 -10px 18px rgba(0,0,0,.18), 0 10px 24px rgba(46,139,87,.35);
    }
    .logo__txt{display:flex;flex-direction:column}
    .logo__name{font-family:Montserrat,sans-serif;font-size:28px;font-weight:700;color:var(--primary)}
    .logo__sub{font-size:12px;color:var(--muted);letter-spacing:.6px}

    /* Desktop NAV */
    .nav ul{list-style:none;display:flex;gap:6px;margin:0;padding:0}
    .nav a{display:flex;gap:8px;align-items:center;padding:10px 14px;border-radius:12px;font-weight:600;color:var(--text);text-decoration:none;transition:var(--tr)}
    .nav a:hover{background:var(--primary-light);color:#0b3d2c}
    .nav .active>a{background:var(--primary);color:#fff}

    /* Auth/Profile */
    .auth{display:flex;align-items:center;gap:12px}
    .btn{border:0;border-radius:12px;padding:10px 16px;font-weight:700;display:flex;align-items:center;gap:10px;cursor:pointer;transition:var(--tr)}
    .btn--primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;box-shadow:0 6px 16px rgba(46,139,87,.35)}
    .btn:hover{transform:translateY(-2px)}

    .userBtn{display:none;align-items:center;gap:12px;background:linear-gradient(90deg,#fff,var(--gray-100));border:1px solid var(--gray-200);padding:8px 12px;border-radius:12px;cursor:pointer;transition:var(--tr);position:relative}
    .userBtn:hover{box-shadow:var(--shadow)}
    .avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
    .user__meta{display:flex;flex-direction:column}
    .user__name{font-weight:700;font-size:14px;white-space:nowrap;max-width:170px;overflow:hidden;text-overflow:ellipsis}
    .user__stats{display:flex;gap:12px;font-size:12px;color:var(--muted);flex-wrap:wrap}
    .user__stats i{color:var(--primary)}

    /* Dropdown */
    .dropdown{position:absolute;right:0;top:calc(100% + 8px);background:#fff;border:1px solid var(--gray-200);border-radius:12px;box-shadow:var(--shadow);min-width:260px;display:none;z-index:60}
    .dropdown.open{display:block;animation:fadeIn .15s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
    .dd-head{padding:12px 14px;border-bottom:1px solid var(--gray-200)}
    .dd-row{display:flex;align-items:center;gap:10px}
    .dd-name{font-weight:700}
    .dd-stats{display:flex;gap:10px;color:var(--muted);font-size:12px;margin-top:6px;flex-wrap:wrap}
    .dd-link{display:flex;align-items:center;gap:10px;padding:12px 14px;text-decoration:none;color:var(--text);transition:var(--tr)}
    .dd-link:hover{background:var(--gray-100)}
    .dd-sep{height:1px;background:var(--gray-200);margin:4px 0}
    .dd-danger{color:#b91c1c}

    /* Mobile controls (global defaults) */
    .mobileBtn{display:none;background:none;border:0;font-size:22px;padding:8px;border-radius:12px}
    .navOverlay{display:none}                 /* desktopda ko‘rinmaydi */
    .navOverlay.open{display:block}
    .mnav ul{list-style:none;margin:0;padding:10px}
    .mnav a{display:flex;gap:10px;align-items:center;background:var(--gray-50);margin:6px 0;padding:12px 14px;border-radius:12px;font-weight:600;color:var(--text);text-decoration:none}
    .mnav a:hover{background:var(--primary-light);color:#0b3d2c}

    /* Modal (profil) */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(4px);z-index:80;align-items:center;justify-content:center}
    .card{width:92%;max-width:680px;background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 20px 44px rgba(0,0,0,.22)}
    .card__head{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:18px 22px;display:flex;align-items:center;justify-content:space-between}
    .card__title{font-family:Montserrat,sans-serif;font-weight:700}
    .close{width:36px;height:36px;border-radius:50%;border:0;background:rgba(255,255,255,.25);color:#fff;font-size:18px;cursor:pointer}
    .card__body{padding:18px 22px;max-height:72vh;overflow:auto}
    .row2{display:flex;gap:16px}
    .group{flex:1;margin-bottom:14px}
    label{display:block;font-weight:700;font-size:14px;margin-bottom:6px}
    input,select{width:100%;padding:10px 12px;border:1px solid var(--gray-200);border-radius:12px;background:#fff;transition:var(--tr);font-size:14px}
    input:focus,select:focus{outline:none;box-shadow:0 0 0 3px rgba(46,139,87,.15);border-color:var(--primary)}
    .submit{width:100%}

    /* Mobile breakpoints */
    @media (max-width:900px){ .logo__txt{display:none} }
    @media (max-width:768px){
      .mc-top .row{padding:6px 0}
      .mc-top__left{gap:8px}
      .mc-top__left .mini{font-size:12px;gap:6px}
      .mc-top__right{gap:10px}
      .nav{display:none} /* desktop nav yashirin */
      /* Off-canvas panel */
      .navOverlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);z-index:70}
      .navPanel{position:absolute;left:0;top:0;height:100%;width:320px;background:#fff;box-shadow:0 0 28px rgba(0,0,0,.18);display:flex;flex-direction:column}
      .navPanel__head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--gray-200)}
      .closeNav{background:#fff;border:1px solid var(--gray-200);width:36px;height:36px;border-radius:10px;font-size:16px;cursor:pointer}
      .mobileBtn{display:block}
    }
  </style>
</head>
<body>
  <header class="mc-header" id="mcHeader">
    <!-- TOP BAR -->
    <div class="mc-top">
      <div class="container">
        <div class="row">
          <div class="mc-top__left">
            <span class="mini"><i class="fa-solid fa-phone"></i> +998 71 123 45 67</span>
            <span class="mini">•</span>
            <span class="mini"><i class="fa-solid fa-envelope"></i> info@mathcenter.uz</span>
          </div>
          <div class="mc-top__right">
            <a href="#" aria-label="Telegram"><i class="fab fa-telegram"></i></a>
            <a href="#" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
            <a href="#" aria-label="Facebook"><i class="fab fa-facebook"></i></a>
            <a href="#" aria-label="YouTube"><i class="fab fa-youtube"></i></a>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN -->
    <div class="mc-main">
      <div class="container">
        <div class="row">
          <a class="logo" href="/">
            <div class="logo__pi">π</div>
            <div class="logo__txt"><div class="logo__name">MathCenter</div><div class="logo__sub">MATEMATIKA MARKAZI</div></div>
          </a>

          <button id="mobileBtn" class="mobileBtn" aria-label="Menyu"><i class="fa-solid fa-bars"></i></button>

          <nav class="nav" aria-label="Asosiy menyu">
            <ul id="deskNav">
              <li class="active"><a href="/"><i class="fa-solid fa-house"></i> Bosh sahifa</a></li>
              <li><a href="/courses.html"><i class="fa-solid fa-book-open"></i> Kurslar</a></li>
              <li><a href="/tests.html"><i class="fa-solid fa-clipboard-list"></i> Testlar</a></li>
              <li><a href="/simulators.html"><i class="fa-solid fa-laptop-code"></i> Simulyatorlar</a></li>
              <li><a href="/results.html"><i class="fa-solid fa-chart-line"></i> Natijalar</a></li>
            </ul>
          </nav>

          <div class="auth">
            <button id="loginBtn" class="btn btn--primary"><i class="fab fa-google"></i> Google orqali kirish</button>

            <button id="userBtn" class="userBtn" aria-expanded="false" aria-haspopup="true">
              <img id="avatarImg" class="avatar" alt="avatar" src="" onerror="this.style.display='none'"/>
              <div id="avatarFallback" class="avatar" style="display:none;">U</div>
              <div class="user__meta">
                <div id="userName" class="user__name">Foydalanuvchi</div>
                <div class="user__stats">
                  <span title="Balans"><i class="fa-solid fa-coins"></i> <b id="statBalance">0</b></span>
                  <span title="Ball"><i class="fa-solid fa-star"></i> <b id="statPoints">0</b></span>
                  <span title="ID"><i class="fa-solid fa-id-card"></i> <b id="statId">—</b></span>
                </div>
              </div>
              <i class="fa-solid fa-chevron-down" aria-hidden="true"></i>

              <div id="userDropdown" class="dropdown" role="menu" aria-label="Profil menyusi">
                <div class="dd-head">
                  <div class="dd-row">
                    <div id="ddAvatar" class="avatar" style="width:36px;height:36px;">U</div>
                    <div>
                      <div id="ddName" class="dd-name">Foydalanuvchi</div>
                      <div class="dd-stats">
                        <span><i class="fa-solid fa-coins"></i> <b id="ddBalance">0</b></span>
                        <span><i class="fa-solid fa-star"></i> <b id="ddPoints">0</b></span>
                        <span><i class="fa-solid fa-id-card"></i> <b id="ddId">—</b></span>
                      </div>
                    </div>
                  </div>
                </div>
                <a class="dd-link" href="#" id="openProfile"><i class="fa-regular fa-user"></i> Profilni tahrirlash</a>
                <div class="dd-sep"></div>
                <a class="dd-link dd-danger" href="#" id="logoutLink"><i class="fa-solid fa-right-from-bracket"></i> Chiqish</a>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobil off-canvas menyu -->
    <div id="navOverlay" class="navOverlay" aria-hidden="true">
      <div class="navPanel" role="dialog" aria-modal="true" aria-label="Menyu">
        <div class="navPanel__head">
          <strong>Menyu</strong>
          <button id="closeNav" class="closeNav" aria-label="Yopish"><i class="fa-solid fa-xmark"></i></button>
        </div>
        <nav class="mnav">
          <ul>
            <li><a href="/"><i class="fa-solid fa-house"></i> Bosh sahifa</a></li>
            <li><a href="/courses.html"><i class="fa-solid fa-book-open"></i> Kurslar</a></li>
            <li><a href="/tests.html"><i class="fa-solid fa-clipboard-list"></i> Testlar</a></li>
            <li><a href="/simulators.html"><i class="fa-solid fa-laptop-code"></i> Simulyatorlar</a></li>
            <li><a href="/results.html"><i class="fa-solid fa-chart-line"></i> Natijalar</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <!-- Profil modal -->
  <div id="profileModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="profileTitle" style="display:none">
    <div class="card">
      <div class="card__head">
        <div id="profileTitle" class="card__title">Profil ma'lumotlari</div>
        <button id="closeProfile" class="close" aria-label="Yopish">&times;</button>
      </div>
      <div class="card__body">
        <form id="profileForm">
          <div class="row2">
            <div class="group"><label for="firstName">Ism</label><input id="firstName" required/></div>
            <div class="group"><label for="lastName">Familiya</label><input id="lastName" required/></div>
          </div>
          <div class="group"><label for="middleName">Sharif</label><input id="middleName"/></div>
          <div class="group"><label for="birthDate">Tug'ilgan sana</label><input id="birthDate" type="date"/></div>
          <div class="row2">
            <div class="group">
              <label for="region">Viloyat</label>
              <select id="region">
                <option value="">Tanlang</option>
                <option value="toshkent">Toshkent</option><option value="andijon">Andijon</option>
                <option value="buxoro">Buxoro</option><option value="fargona">Farg'ona</option>
                <option value="jizzax">Jizzax</option><option value="namangan">Namangan</option>
                <option value="navoiy">Navoiy</option><option value="qashqadaryo">Qashqadaryo</option>
                <option value="samarqand">Samarqand</option><option value="sirdaryo">Sirdaryo</option>
                <option value="surxondaryo">Surxondaryo</option><option value="xorazm">Xorazm</option>
                <option value="qoraqalpogiston">Qoraqalpog'iston</option>
              </select>
            </div>
            <div class="group">
              <label for="district">Tuman</label>
              <select id="district"><option value="">Tanlang</option></select>
            </div>
          </div>
          <div class="group"><label for="school">Maktab nomi</label><input id="school"/></div>
          <div class="group">
            <label for="role">Rolingiz</label>
            <select id="role">
              <option value="">Tanlang</option>
              <option value="teacher">O'qituvchi</option><option value="student">O'quvchi</option>
              <option value="user">Foydalanuvchi</option><option value="university_student">Talaba</option>
              <option value="applicant">Abiturient</option>
            </select>
          </div>
          <button class="btn btn--primary submit" type="submit">Saqlash</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Firebase v10 modular + guards -->
  <script type="module">
    // Bir martalik init guard (dinamik include bo'lsa ham dublikat bo'lmasin)
    if (!window.__MC_HEADER_INIT) {
      window.__MC_HEADER_INIT = true;

      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import {
        getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut,
        setPersistence, browserLocalPersistence
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
      import {
        getFirestore, doc, getDoc, setDoc, onSnapshot, runTransaction, serverTimestamp
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey:"AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
        authDomain:"xplusy-760fa.firebaseapp.com",
        projectId:"xplusy-760fa",
        storageBucket:"xplusy-760fa.firebasestorage.app",
        messagingSenderId:"992512966017",
        appId:"1:992512966017:web:5e919dbc9b8d8abcb43c80",
        measurementId:"G-459PLJ7P7L"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      await setPersistence(auth, browserLocalPersistence);

      // DOM refs
      const loginBtn = document.getElementById('loginBtn');
      const userBtn  = document.getElementById('userBtn');
      const dropdown = document.getElementById('userDropdown');
      const avatarImg = document.getElementById('avatarImg');
      const avatarFallback = document.getElementById('avatarFallback');
      const userName = document.getElementById('userName');
      const statBalance = document.getElementById('statBalance');
      const statPoints  = document.getElementById('statPoints');
      const statId      = document.getElementById('statId');
      const ddName = document.getElementById('ddName');
      const ddBalance = document.getElementById('ddBalance');
      const ddPoints  = document.getElementById('ddPoints');
      const ddId      = document.getElementById('ddId');
      const ddAvatar  = document.getElementById('ddAvatar');

      const openProfileLink = document.getElementById('openProfile');
      const logoutLink = document.getElementById('logoutLink');

      const navOverlay = document.getElementById('navOverlay');
      const mobileBtn  = document.getElementById('mobileBtn');
      const closeNav   = document.getElementById('closeNav');

      const profileModal = document.getElementById('profileModal');
      const closeProfile  = document.getElementById('closeProfile');

      const regionSel = document.getElementById('region');
      const districtSel = document.getElementById('district');

      // Mobile menu
      mobileBtn.addEventListener('click',()=>{ navOverlay.classList.add('open'); navOverlay.setAttribute('aria-hidden','false'); });
      closeNav.addEventListener('click',()=>{ navOverlay.classList.remove('open'); navOverlay.setAttribute('aria-hidden','true'); });
      navOverlay.addEventListener('click',e=>{ if(e.target===navOverlay){ closeNav.click(); } });

      // Dropdown
      function toggleDropdown(force){
        const open = typeof force==='boolean'?force:!dropdown.classList.contains('open');
        dropdown.classList.toggle('open', open);
        userBtn.setAttribute('aria-expanded', open? 'true':'false');
      }
      userBtn.addEventListener('click', (e)=>{
        if(e.target.closest('.dropdown')) return;
        toggleDropdown();
      });
      document.addEventListener('click',(e)=>{ if(!userBtn.contains(e.target)) toggleDropdown(false); });

      // Region → district
      const districtsByRegion = {
        toshkent:["Bektemir tumani","Chilonzor tumani","Yashnobod tumani","Mirobod tumani","Mirzo Ulug'bek tumani","Sergeli tumani","Shayxontohur tumani","Olmazor tumani","Uchtepa tumani","Yakkasaroy tumani","Yunusobod tumani"],
        andijon:["Andijon shahri","Andijon tumani","Asaka tumani","Baliqchi tumani","Bo'z tumani","Buloqboshi tumani","Jalaquduq tumani","Izboskan tumani","Xo'jaobod tumani","Qo'rg'ontepa tumani","Marhamat tumani","Oltinko'l tumani","Paxtaobod tumani","Shahrixon tumani","Ulug'nor tumani"],
        buxoro:["Buxoro shahri","Buxoro tumani","Vobkent tumani","G'ijduvon tumani","Jondor tumani","Kogon tumani","Qorako'l tumani","Qorovulbozor tumani","Olot tumani","Peshku tumani","Romitan tumani","Shofirkon tumani","Qorao'zak tumani"],
        fargona:["Farg'ona shahri","Farg'ona tumani","Beshariq tumani","Bog'dod tumani","Buvayda tumani","Dang'ara tumani","Yozyovon tumani","Quva tumani","Quvasoy shahri","Qo'qon shahri","Rishton tumani","So'x tumani","Toshloq tumani","Uchko'prik tumani","O'zbekiston tumani","Furqat tumani"],
        jizzax:["Jizzax shahri","Jizzax tumani","Arnasoy tumani","Baxmal tumani","G'allaorol tumani","Do'stlik tumani","Zarbdor tumani","Zafarobod tumani","Zomin tumani","Mirzacho'l tumani","Paxtakor tumani","Forish tumani","Sharof Rashidov tumani","Yangiobod tumani"],
        namangan:["Namangan shahri","Namangan tumani","Kosonsoy tumani","Mingbuloq tumani","Norin tumani","Pop tumani","To'raqo'rg'on tumani","Uchqo'rg'on tumani","Uychi tumani","Chortoq tumani","Chust tumani","Yangiqo'rg'on tumani"],
        navoiy:["Navoiy shahri","Navoiy tumani","Zarafshon shahri","Karmana tumani","Qiziltepa tumani","Xatirchi tumani","Navbahor tumani","Nurota tumani","Tomdi tumani","Uchquduq tumani"],
        qashqadaryo:["Qarshi shahri","Qarshi tumani","Dehqonobod tumani","Kasbi tumani","Kitob tumani","Koson tumani","Mirishkor tumani","Muborak tumani","Nishon tumani","Chiroqchi tumani","Shahrisabz shahri","Yakkabog' tumani"],
        samarqand:["Samarqand shahri","Samarqand tumani","Bulung'ur tumani","Jomboy tumani","Ishtixon tumani","Kattaqo'rg'on shahri","Qo'shrabot tumani","Narpay tumani","Nurobod tumani","Oqdaryo tumani","Paxtachi tumani","Payariq tumani","Pastdarg'om tumani","Toyloq tumani","Urgut tumani"],
        sirdaryo:["Guliston shahri","Guliston tumani","Boyovut tumani","Mirzaobod tumani","Oqoltin tumani","Sayxunobod tumani","Sardoba tumani","Sirdaryo tumani","Xovos tumani","Shirin shahri","Yangiyer shahri"],
        surxondaryo:["Termiz shahri","Termiz tumani","Angor tumani","Boysun tumani","Denov tumani","Jarqo'rg'on tumani","Qiziriq tumani","Qumqo'rg'on tumani","Muzrabot tumani","Oltinsoy tumani","Sariosiyo tumani","Sherobod tumani","Sho'rchi tumani","Bandixon tumani"],
        xorazm:["Urganch shahri","Urganch tumani","Bog'ot tumani","Gurlan tumani","Qo'shko'pir tumani","Shovot tumani","Xiva tumani","Xonqa tumani","Hazorasp tumani","Yangiarik tumani","Yangibozor tumani"],
        qoraqalpogiston:["Nukus shahri","Nukus tumani","Amudaryo tumani","Beruniy tumani","Chimboy tumani","Ellikqala tumani","Kegayli tumani","Mo'ynoq tumani","Qonliko'l tumani","Qo'ng'irot tumani","Qorao'zak tumani","Shumanay tumani","Taxtako'pir tumani","To'rtko'l tumani","Xo'jayli tumani"]
      };
      regionSel?.addEventListener('change',()=>{
        const r = regionSel.value; districtSel.innerHTML = '<option value="">Tanlang</option>';
        if(r && districtsByRegion[r]) districtsByRegion[r].forEach(d=>{const o=document.createElement('option');o.value=d;o.textContent=d;districtSel.appendChild(o);});
      });

      // Modal helpers
      const openModal = ()=> profileModal.style.display='flex';
      const closeModal = ()=> profileModal.style.display='none';
      openProfileLink?.addEventListener('click',e=>{e.preventDefault(); openModal(); toggleDropdown(false);});
      closeProfile?.addEventListener('click',closeModal);
      window.addEventListener('click',e=>{ if(e.target===profileModal) closeModal(); });

      // Auth guards
      const provider = new GoogleAuthProvider();
      let __SIGNIN_BUSY = false;
      loginBtn.addEventListener('click', async ()=>{
        if (__SIGNIN_BUSY) return;
        __SIGNIN_BUSY = true;
        try { await signInWithPopup(auth, provider); }
        catch (e) { console.error(e); alert("Kirishda xatolik: "+(e?.message||"noma'lum")); }
        finally { __SIGNIN_BUSY = false; }
      });
      logoutLink.addEventListener('click', async (e)=>{ e.preventDefault(); await signOut(auth); });

      let unsubUser = null;
      onAuthStateChanged(auth, async (user)=>{
        if(!user){
          loginBtn.style.display='inline-flex';
          userBtn.style.display='none';
          unsubUser && unsubUser(); unsubUser=null;
          toggleDropdown(false);
          return;
        }
        loginBtn.style.display='none';
        userBtn.style.display='flex';

        const uref = doc(db,'users', user.uid);
        const snap = await getDoc(uref);
        if(!snap.exists()){
          await setDoc(uref,{
            displayName:user.displayName||"", email:user.email||"", photoURL:user.photoURL||"",
            phoneNumber:user.phoneNumber||"", createdAt:serverTimestamp(), updatedAt:serverTimestamp(),
            balance:0, points:0, role:'user'
          },{merge:true});
        }
        await runTransaction(db, async (tx)=>{
          const metaRef = doc(db,'meta','counters');
          const metaSnap = await tx.get(metaRef);
          const uSnap = await tx.get(uref);
          let nextId = metaSnap.exists()? (metaSnap.data()?.nextUserId ?? 1001) : 1001;
          if(!uSnap.data()?.numericId){
            if(metaSnap.exists()) tx.update(metaRef,{ nextUserId: nextId+1 });
            else tx.set(metaRef,{ nextUserId: nextId+1 },{ merge:true });
            tx.update(uref,{ numericId: nextId, updatedAt: serverTimestamp() });
          }
        });

        unsubUser && unsubUser();
        unsubUser = onSnapshot(uref, ds=>{
          const d = ds.data()||{};
          const full = [d.firstName,d.lastName].filter(Boolean).join(' ') || d.displayName || "Foydalanuvchi";
          userName.textContent = full; ddName.textContent = full;

          const p = d.photoURL || user.photoURL;
          if(p){ avatarImg.src=p; avatarImg.style.display='block'; avatarFallback.style.display='none';
                ddAvatar.textContent=''; ddAvatar.style.backgroundImage=`url(${p})`; ddAvatar.style.backgroundSize='cover'; ddAvatar.style.color='transparent'; }
          else { avatarImg.style.display='none'; avatarFallback.style.display='flex'; avatarFallback.textContent=(full?.[0]||'U').toUpperCase();
                 ddAvatar.textContent=(full?.[0]||'U').toUpperCase(); ddAvatar.style.backgroundImage=''; ddAvatar.style.color='#fff'; }

          const bal = d.balance ?? 0, pts = d.points ?? 0, nid = d.numericId ?? '—';
          statBalance.textContent = bal; statPoints.textContent = pts; statId.textContent = nid;
          ddBalance.textContent = bal; ddPoints.textContent = pts; ddId.textContent = nid;
        });
      });

      // Profile save
      document.getElementById('profileForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const user = auth.currentUser; if(!user) return alert("Avval tizimga kiring.");
        const data = {
          firstName: document.getElementById('firstName').value.trim(),
          lastName:  document.getElementById('lastName').value.trim(),
          middleName:document.getElementById('middleName').value.trim(),
          birthDate: document.getElementById('birthDate').value||null,
          region: regionSel.value||null, district: districtSel.value||null,
          school: document.getElementById('school').value.trim()||null,
          role: document.getElementById('role').value||'user',
          updatedAt: serverTimestamp()
        };
        await setDoc(doc(db,'users', user.uid), data, {merge:true});
        closeModal();
      });

      // Active menu (desktop & mobile)
      const path = location.pathname.replace(/\/index\.html?$/,'/');
      document.querySelectorAll('.nav a, .mnav a').forEach(a=>{
        const clean = (a.getAttribute('href')||'').replace(/\/index\.html?$/,'/');
        a.parentElement?.classList.toggle('active', clean===path);
      });
    }
  </script>
</body>
</html>
