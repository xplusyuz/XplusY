<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>XplusY Header</title>
  <style>
    :root{
      --primary:#19b36b; --primary-dark:#118654; --accent:#A0EBC5; --text:#0b1f17; --granite-bg:#f2f8f5;
      --radius:14px; --gap:10px; --tap:44px;
    }
    body{margin:0}
    header.xpy-header{position:sticky;top:0;z-index:50;background:var(--granite-bg);
      border-bottom:1px solid rgba(0,0,0,.06);backdrop-filter:saturate(1.2) blur(6px);}
    .xpy-container{display:flex;align-items:center;justify-content:space-between;
      max-width:1100px;margin:0 auto;padding:.6rem clamp(12px,4vw,20px);gap:var(--gap);
      font-family:Inter,system-ui;}
    .xpy-brand{display:flex;align-items:center;gap:.6rem;text-decoration:none;color:var(--text);}
    .xpy-logo{width:40px;height:40px;border-radius:12px;background:#fff;display:grid;place-items:center;
      font-size:24px;color:var(--primary-dark);}
    .xpy-brand-txt{display:flex;flex-direction:column;line-height:1.05}
    .xpy-nav{display:flex;gap:4px;flex:1;justify-content:center;}
    .xpy-nav a{padding:.5rem .75rem;border-radius:var(--radius);color:var(--text);text-decoration:none;}
    .xpy-nav a:hover{background:#fff;box-shadow:0 6px 16px rgba(0,0,0,.06);}
    .xpy-actions{display:flex;align-items:center;gap:6px;}
    .xpy-btn{border:1px solid rgba(0,0,0,.08);background:#fff;cursor:pointer;border-radius:var(--radius);
      min-height:var(--tap);padding:.5rem .85rem;font:inherit;}
    .xpy-btn.primary{background:var(--primary);color:#fff;border:none;}
    .xpy-pill{max-width:42vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border:1px solid rgba(0,0,0,.08);
      background:#fff;border-radius:999px;padding:.4rem .7rem;}
    /* Avatar */
    .xpy-avatar{position:relative;width:36px;height:36px;border-radius:50%;display:grid;place-items:center;font-weight:700;
      overflow:hidden;background:#e9fff3;color:var(--primary-dark);border:1px solid rgba(0,0,0,.06);box-shadow:0 4px 10px rgba(0,0,0,.06);}
    .xpy-avatar img{width:100%;height:100%;object-fit:cover;display:none;}
    .xpy-status{position:absolute;right:-2px;bottom:-2px;width:10px;height:10px;border-radius:50%;background:#c2c2c2;border:2px solid #fff;}
    .xpy-status.online{background:#22c55e;}
    .xpy-badge{position:absolute;top:-3px;right:-3px;min-width:16px;height:16px;border-radius:999px;background:#ef4444;color:#fff;
      font-size:11px;font-weight:600;display:none;align-items:center;justify-content:center;padding:0 3px;border:2px solid #fff;}
    /* Mobile */
    .xpy-burger{display:none;width:var(--tap);height:var(--tap);border:1px solid rgba(0,0,0,.08);border-radius:var(--radius);background:#fff;}
    .xpy-sheet{position:fixed;inset:auto 0 0 0;width:100%;background:#fff;border-radius:16px 16px 0 0;transform:translateY(102%);transition:.3s ease;z-index:60;box-shadow:0 -24px 48px rgba(0,0,0,.16);}
    .xpy-sheet.open{transform:translateY(0);}
    .xpy-dim{position:fixed;inset:0;background:rgba(0,0,0,.28);opacity:0;visibility:hidden;transition:.25s;z-index:55;}
    .xpy-dim.show{opacity:1;visibility:visible;}
    @media(max-width:1024px){.xpy-nav{display:none}.xpy-pill{display:none}.xpy-burger{display:block}}
  </style>
</head>
<body>
<header class="xpy-header">
  <div class="xpy-container">
    <a class="xpy-brand" id="xpyBrand">
      <div class="xpy-logo">π</div>
      <div class="xpy-brand-txt"><strong id="xpyLogoText">π XplusY</strong><small id="xpyLogoSub">MathCenter</small></div>
    </a>
    <nav class="xpy-nav" id="xpyMenu"></nav>
    <div class="xpy-actions">
      <div class="xpy-avatar" id="xpyAvatar">
        <img id="xpyAvatarImg" alt="Profil" referrerpolicy="no-referrer"/>
        <span id="xpyAvatarTxt">?</span>
        <span class="xpy-status" id="xpyStatus"></span>
        <span class="xpy-badge" id="xpyBadge">0</span>
      </div>
      <span class="xpy-pill" id="xpyProfilePill"></span>
      <button class="xpy-btn" id="xpyLoginBtn">Kirish</button>
      <button class="xpy-btn" id="xpyLogoutBtn" style="display:none">Chiqish</button>
      <a class="xpy-btn primary" id="xpyAdminBtn" style="display:none" href="headerfooteradmin.html">Admin</a>
      <button class="xpy-burger" id="xpyBurger">☰</button>
    </div>
  </div>
  <div class="xpy-dim" id="xpyDim"></div>
  <aside class="xpy-sheet" id="xpySheet">
    <div style="padding:14px 16px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center">
      <strong>XplusY</strong><button class="xpy-btn" id="xpyCloseSheet">✕</button>
    </div>
    <div style="padding:14px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <div class="xpy-avatar" id="xpyAvatarM">
          <img id="xpyAvatarImgM" alt="Profil" referrerpolicy="no-referrer"/>
          <span id="xpyAvatarTxtM">?</span>
          <span class="xpy-badge" id="xpyBadgeM">0</span>
        </div>
        <div id="xpyMobileProfile">—</div>
      </div>
      <nav id="xpySheetNav"></nav>
      <div style="margin-top:12px;display:flex;gap:6px">
        <button class="xpy-btn" id="xpyLoginBtnM">Kirish</button>
        <button class="xpy-btn" id="xpyLogoutBtnM" style="display:none">Chiqish</button>
        <a class="xpy-btn primary" id="xpyAdminBtnM" style="display:none" href="headerfooteradmin.html">Admin</a>
      </div>
    </div>
  </aside>
</header>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// Firebase config
const app = initializeApp({
  apiKey:"AIzaSyDYwHJou_9GqHZcf8XxtTByC51Z8un8rrM",
  authDomain:"xplusy-760fa.firebaseapp.com",
  projectId:"xplusy-760fa"
});
const auth = getAuth(app);
const db   = getFirestore(app);

// Elements
const els = {
  pill: document.getElementById("xpyProfilePill"),
  login: document.getElementById("xpyLoginBtn"),
  logout: document.getElementById("xpyLogoutBtn"),
  admin: document.getElementById("xpyAdminBtn"),
  pillM: document.getElementById("xpyMobileProfile"),
  loginM: document.getElementById("xpyLoginBtnM"),
  logoutM: document.getElementById("xpyLogoutBtnM"),
  adminM: document.getElementById("xpyAdminBtnM"),
  badge: document.getElementById("xpyBadge"),
  badgeM: document.getElementById("xpyBadgeM"),
  avatarImg: document.getElementById("xpyAvatarImg"),
  avatarImgM: document.getElementById("xpyAvatarImgM"),
  avatarTxt: document.getElementById("xpyAvatarTxt"),
  avatarTxtM: document.getElementById("xpyAvatarTxtM"),
  status: document.getElementById("xpyStatus")
};

// Badge helper
window.__xpySetBadge = (count)=>{
  [els.badge, els.badgeM].forEach(b=>{
    if(!b) return;
    if(count>0){ b.style.display="flex"; b.textContent=(count>99?"99+":count);}
    else b.style.display="none";
  });
};

// Avatar helper
function setAvatar(user, online=true){
  const photo=user?.photoURL;
  const display=(user?.displayName)||user?.email||"?";
  const letter=display[0].toUpperCase();
  if(photo){
    [els.avatarImg, els.avatarImgM].forEach(img=>{
      if(img){ img.src=photo; img.style.display="block";}
    });
    [els.avatarTxt, els.avatarTxtM].forEach(t=>{ if(t) t.style.display="none";});
  }else{
    [els.avatarTxt, els.avatarTxtM].forEach(t=>{ if(t){t.textContent=letter;t.style.display="block";}});
    [els.avatarImg, els.avatarImgM].forEach(img=>{ if(img) img.style.display="none";});
  }
  if(els.status) els.status.classList.toggle("online", online);
}

// Notifications listener
function listenNotifications(user){
  const q=query(collection(db,"notifications",user.uid,"items"), where("read","==",false));
  return onSnapshot(q,snap=>{
    window.__xpySetBadge(snap.size);
  });
}

// Auth
let unsubNotif=null;
onAuthStateChanged(auth, async(user)=>{
  if(user){
    setAvatar(user,true);
    els.pill.textContent=`Salom, ${user.displayName||user.email}`;
    els.pillM.textContent=`Salom, ${user.displayName||user.email}`;
    els.login.style.display="none"; els.logout.style.display="inline-block";
    els.loginM.style.display="none"; els.logoutM.style.display="inline-block";
    if(unsubNotif) unsubNotif(); unsubNotif=listenNotifications(user);
  }else{
    setAvatar(null,false);
    els.pill.textContent=""; els.pillM.textContent="";
    els.login.style.display="inline-block"; els.logout.style.display="none";
    els.loginM.style.display="inline-block"; els.logoutM.style.display="none";
    if(unsubNotif) unsubNotif(); unsubNotif=null;
    window.__xpySetBadge(0);
  }
});

els.login.addEventListener("click",()=>signInWithPopup(auth,new GoogleAuthProvider()));
els.loginM.addEventListener("click",()=>signInWithPopup(auth,new GoogleAuthProvider()));
[els.logout, els.logoutM].forEach(b=>b.addEventListener("click",()=>signOut(auth)));
</script>
</body>
</html>
